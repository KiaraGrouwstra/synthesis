<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, NondecreasingIndentation, TupleSections, RecordWildCards #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-cse #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- -fno-cse is needed for GLOBAL_VAR's to behave properly</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">--  (c) The University of Glasgow 2002-2006</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- | The dynamic linker for GHCi.</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- This module deals with the top-level issues of dynamic linking,</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- calling the object-code linker and the byte-code linker where</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- necessary.</span><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Linker</span><span> </span><span class="hs-special">(</span><span> </span><a href="Linker.html#getHValue"><span class="hs-identifier hs-var">getHValue</span></a><span class="hs-special">,</span><span> </span><a href="Linker.html#showLinkerState"><span class="hs-identifier hs-var">showLinkerState</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>                </span><a href="Linker.html#linkExpr"><span class="hs-identifier hs-var">linkExpr</span></a><span class="hs-special">,</span><span> </span><a href="Linker.html#linkDecls"><span class="hs-identifier hs-var">linkDecls</span></a><span class="hs-special">,</span><span> </span><a href="Linker.html#unload"><span class="hs-identifier hs-var">unload</span></a><span class="hs-special">,</span><span> </span><a href="Linker.html#withExtendedLinkEnv"><span class="hs-identifier hs-var">withExtendedLinkEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>                </span><a href="Linker.html#extendLinkEnv"><span class="hs-identifier hs-var">extendLinkEnv</span></a><span class="hs-special">,</span><span> </span><a href="Linker.html#deleteFromLinkEnv"><span class="hs-identifier hs-var">deleteFromLinkEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>                </span><a href="Linker.html#extendLoadedPkgs"><span class="hs-identifier hs-var">extendLoadedPkgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>                </span><a href="Linker.html#linkPackages"><span class="hs-identifier hs-var">linkPackages</span></a><span class="hs-special">,</span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span class="hs-special">,</span><a href="Linker.html#linkModule"><span class="hs-identifier hs-var">linkModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>                </span><a href="Linker.html#linkCmdLineLibs"><span class="hs-identifier hs-var">linkCmdLineLibs</span></a><span>
</span><a name="line-20"></a><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.html"><span class="hs-identifier">GHCi</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="ByteCodeLink.html"><span class="hs-identifier">ByteCodeLink</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="ByteCodeAsm.html"><span class="hs-identifier">ByteCodeAsm</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ByteCodeTypes</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DriverPhases</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqDSet</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.html"><span class="hs-identifier">SysTools</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FileCleanup</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">-- Standard libraries</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isSpace</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent.MVar</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Unsafe</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupEnv</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Win32.Info</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getSystemDirectory</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- needed for 2nd stage</span><span>
</span><a name="line-76"></a><span class="hs-cpp">#if STAGE &gt;= 2
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-80"></a><span class="hs-comment">{- **********************************************************************

                        The Linker's state

  ********************************************************************* -}</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">{-
The persistent linker state *must* match the actual state of the
C dynamic linker at all times, so we keep it in a private global variable.

The global IORef used for PersistentLinkerState actually contains another MVar,
which in turn contains a Maybe PersistentLinkerState. The MVar serves to ensure
mutual exclusion between multiple loaded copies of the GHC library. The Maybe
may be Nothing to indicate that the linker has not yet been initialised.

The PersistentLinkerState maps Names to actual closures (for
interpreted code only), for use during linking.
-}</span><span>
</span><a name="line-98"></a><span class="hs-cpp">#if STAGE &lt; 2
</span><span class="hs-identifier">GLOBAL_VAR_M</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">v_PersistentLinkerState</span><span>
</span><a name="line-100"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newMVar</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-101"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">PersistentLinkerState</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">SHARED_GLOBAL_VAR_M</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">v_PersistentLinkerState</span><span>
</span><a name="line-104"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getOrSetLibHSghcPersistentLinkerState</span><span>
</span><a name="line-105"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;getOrSetLibHSghcPersistentLinkerState&quot;</span><span>
</span><a name="line-106"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newMVar</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-107"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">PersistentLinkerState</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-110"></a><span class="hs-identifier">uninitialised</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682423502"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-111"></a><a name="uninitialised"><a href="Linker.html#uninitialised"><span class="hs-identifier">uninitialised</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Dynamic linker not initialised&quot;</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">modifyPLS_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><a name="modifyPLS_"><a href="Linker.html#modifyPLS_"><span class="hs-identifier">modifyPLS_</span></a></a><span> </span><a name="local-6989586621682423503"><a href="#local-6989586621682423503"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Linker.html#v_PersistentLinkerState"><span class="hs-identifier hs-var">v_PersistentLinkerState</span></a><span>
</span><a name="line-115"></a><span>  </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682423503"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Linker.html#uninitialised"><span class="hs-identifier hs-var">uninitialised</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">modifyPLS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423501"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682423501"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-118"></a><a name="modifyPLS"><a href="Linker.html#modifyPLS"><span class="hs-identifier">modifyPLS</span></a></a><span> </span><a name="local-6989586621682423504"><a href="#local-6989586621682423504"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Linker.html#v_PersistentLinkerState"><span class="hs-identifier hs-var">v_PersistentLinkerState</span></a><span>
</span><a name="line-119"></a><span>  </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423505"><span class="hs-identifier hs-var">fmapFst</span></a><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682423504"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Linker.html#uninitialised"><span class="hs-identifier hs-var">uninitialised</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682423505"><a href="#local-6989586621682423505"><span class="hs-identifier">fmapFst</span></a></a><span> </span><a name="local-6989586621682423506"><a href="#local-6989586621682423506"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682423507"><a href="#local-6989586621682423507"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423508"><a href="#local-6989586621682423508"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423506"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682423507"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423508"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">readPLS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-123"></a><a name="readPLS"><a href="Linker.html#readPLS"><span class="hs-identifier">readPLS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Linker.html#v_PersistentLinkerState"><span class="hs-identifier hs-var">v_PersistentLinkerState</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Linker.html#uninitialised"><span class="hs-identifier hs-var">uninitialised</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-identifier">modifyMbPLS_</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><a name="modifyMbPLS_"><a href="Linker.html#modifyMbPLS_"><span class="hs-identifier">modifyMbPLS_</span></a></a><span> </span><a name="local-6989586621682423509"><a href="#local-6989586621682423509"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Linker.html#v_PersistentLinkerState"><span class="hs-identifier hs-var">v_PersistentLinkerState</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621682423509"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">data</span><span> </span><a name="PersistentLinkerState"><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier">PersistentLinkerState</span></a></a><span>
</span><a name="line-131"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="PersistentLinkerState"><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier">PersistentLinkerState</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>        </span><span class="hs-comment">-- Current global mapping from Names to their true values</span><span>
</span><a name="line-134"></a><span>        </span><a name="closure_env"><a href="Linker.html#closure_env"><span class="hs-identifier">closure_env</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeLink.html#ClosureEnv"><span class="hs-identifier hs-type">ClosureEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span>        </span><span class="hs-comment">-- The current global mapping from RdrNames of DataCons to</span><span>
</span><a name="line-137"></a><span>        </span><span class="hs-comment">-- info table addresses.</span><span>
</span><a name="line-138"></a><span>        </span><span class="hs-comment">-- When a new Unlinked is linked into the running image, or an existing</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-comment">-- module in the image is replaced, the itbl_env must be updated</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-comment">-- appropriately.</span><span>
</span><a name="line-141"></a><span>        </span><a name="itbl_env"><a href="Linker.html#itbl_env"><span class="hs-identifier">itbl_env</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">ItblEnv</span><span class="hs-special">,</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>        </span><span class="hs-comment">-- The currently loaded interpreted modules (home package)</span><span>
</span><a name="line-144"></a><span>        </span><a name="bcos_loaded"><a href="Linker.html#bcos_loaded"><span class="hs-identifier">bcos_loaded</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span>        </span><span class="hs-comment">-- And the currently-loaded compiled modules (home package)</span><span>
</span><a name="line-147"></a><span>        </span><a name="objs_loaded"><a href="Linker.html#objs_loaded"><span class="hs-identifier">objs_loaded</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>        </span><span class="hs-comment">-- The currently-loaded packages; always object code</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-comment">-- Held, as usual, in dependency order; though I am not sure if</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-comment">-- that is really important</span><span>
</span><a name="line-152"></a><span>        </span><a name="pkgs_loaded"><a href="Linker.html#pkgs_loaded"><span class="hs-identifier">pkgs_loaded</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="Linker.html#LinkerUnitId"><span class="hs-identifier hs-type">LinkerUnitId</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>        </span><span class="hs-comment">-- we need to remember the name of previous temporary DLL/.so</span><span>
</span><a name="line-155"></a><span>        </span><span class="hs-comment">-- libraries so we can link them (see #10322)</span><span>
</span><a name="line-156"></a><span>        </span><a name="temp_sos"><a href="Linker.html#temp_sos"><span class="hs-identifier">temp_sos</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">emptyPLS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-160"></a><a name="emptyPLS"><a href="Linker.html#emptyPLS"><span class="hs-identifier">emptyPLS</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-var">PersistentLinkerState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-161"></a><span>                        </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-162"></a><span>                        </span><span class="hs-identifier">itbl_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-163"></a><span>                        </span><span class="hs-identifier">pkgs_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423510"><span class="hs-identifier hs-var">init_pkgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-164"></a><span>                        </span><span class="hs-identifier">bcos_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-165"></a><span>                        </span><span class="hs-identifier">objs_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-166"></a><span>                        </span><span class="hs-identifier">temp_sos</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span>  </span><span class="hs-comment">-- Packages that don't need loading, because the compiler</span><span>
</span><a name="line-169"></a><span>  </span><span class="hs-comment">-- shares them with the interpreted program.</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span>  </span><span class="hs-comment">-- The linker's symbol table is populated with RTS symbols using an</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-comment">-- explicit list.  See rts/Linker.c for details.</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682423510"><a href="#local-6989586621682423510"><span class="hs-identifier">init_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">rtsUnitId</span><span class="hs-special">]</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-identifier">extendLoadedPkgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><a name="extendLoadedPkgs"><a href="Linker.html#extendLoadedPkgs"><span class="hs-identifier">extendLoadedPkgs</span></a></a><span> </span><a name="local-6989586621682423511"><a href="#local-6989586621682423511"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-178"></a><span>  </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423512"><a href="#local-6989586621682423512"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-179"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423512"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">pkgs_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423511"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">pkgs_loaded</span><span> </span><a href="#local-6989586621682423512"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">extendLinkEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><a name="extendLinkEnv"><a href="Linker.html#extendLinkEnv"><span class="hs-identifier">extendLinkEnv</span></a></a><span> </span><a name="local-6989586621682423513"><a href="#local-6989586621682423513"><span class="hs-identifier">new_bindings</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-183"></a><span>  </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423514"><a href="#local-6989586621682423514"><span class="hs-identifier">pls</span></a></a><span class="hs-glyph">@</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-var">PersistentLinkerState</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423521"><a href="#local-6989586621682423521"><span class="hs-identifier">new_ce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeLink.html#extendClosureEnv"><span class="hs-identifier hs-var">extendClosureEnv</span></a><span> </span><a href="#local-6989586621682423515"><span class="hs-identifier hs-var">closure_env</span></a><span> </span><a href="#local-6989586621682423513"><span class="hs-identifier hs-var">new_bindings</span></a><span>
</span><a name="line-185"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621682423514"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423521"><span class="hs-identifier hs-var">new_ce</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-comment">-- strictness is important for not retaining old copies of the pls</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">deleteFromLinkEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><a name="deleteFromLinkEnv"><a href="Linker.html#deleteFromLinkEnv"><span class="hs-identifier">deleteFromLinkEnv</span></a></a><span> </span><a name="local-6989586621682423522"><a href="#local-6989586621682423522"><span class="hs-identifier">to_remove</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-190"></a><span>  </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423523"><a href="#local-6989586621682423523"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423524"><a href="#local-6989586621682423524"><span class="hs-identifier">ce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><a href="#local-6989586621682423523"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423525"><a href="#local-6989586621682423525"><span class="hs-identifier">new_ce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delListFromNameEnv</span><span> </span><a href="#local-6989586621682423524"><span class="hs-identifier hs-var">ce</span></a><span> </span><a href="#local-6989586621682423522"><span class="hs-identifier hs-var">to_remove</span></a><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423523"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423525"><span class="hs-identifier hs-var">new_ce</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-comment">-- | Get the 'HValue' associated with the given name.</span><span>
</span><a name="line-196"></a><span class="hs-comment">--</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- May cause loading the module that contains the name.</span><span>
</span><a name="line-198"></a><span class="hs-comment">--</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- Throws a 'ProgramError' if loading fails or the name cannot be found.</span><span>
</span><a name="line-200"></a><span class="hs-identifier">getHValue</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-201"></a><a name="getHValue"><a href="Linker.html#getHValue"><span class="hs-identifier">getHValue</span></a></a><span> </span><a name="local-6989586621682423526"><a href="#local-6989586621682423526"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423527"><a href="#local-6989586621682423527"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>  </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423526"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-203"></a><span>  </span><a name="local-6989586621682423531"><a href="#local-6989586621682423531"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#modifyPLS"><span class="hs-identifier hs-var">modifyPLS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423528"><a href="#local-6989586621682423528"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-204"></a><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621682423527"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-205"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682423529"><a href="#local-6989586621682423529"><span class="hs-identifier">pls'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423530"><a href="#local-6989586621682423530"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkDependencies"><span class="hs-identifier hs-var">linkDependencies</span></a><span> </span><a href="#local-6989586621682423526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423528"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-206"></a><span>                              </span><span class="hs-special">[</span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621682423527"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>             </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">failed</span><span> </span><a href="#local-6989586621682423530"><span class="hs-identifier hs-var">ok</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423529"><span class="hs-identifier hs-var">pls'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423529"><span class="hs-identifier hs-var">pls'</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>            </span><span class="hs-keyword">else</span><span>
</span><a name="line-210"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423528"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423528"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">closure_env</span><span> </span><a href="#local-6989586621682423531"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423527"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682423532"><a href="#local-6989586621682423532"><span class="hs-identifier">aa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423532"><span class="hs-identifier hs-var">aa</span></a><span>
</span><a name="line-213"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-214"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423533"><a href="#local-6989586621682423533"><span class="hs-identifier">sym_to_find</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeLink.html#nameToCLabel"><span class="hs-identifier hs-var">nameToCLabel</span></a><span> </span><a href="#local-6989586621682423527"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-string">&quot;closure&quot;</span><span>
</span><a name="line-216"></a><span>              </span><a name="local-6989586621682423534"><a href="#local-6989586621682423534"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#lookupClosure"><span class="hs-identifier hs-var">lookupClosure</span></a><span> </span><a href="#local-6989586621682423526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unpackFS</span><span> </span><a href="#local-6989586621682423533"><span class="hs-identifier hs-var">sym_to_find</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423534"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-218"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423535"><a href="#local-6989586621682423535"><span class="hs-identifier">hvref</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621682423526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423535"><span class="hs-identifier hs-var">hvref</span></a><span>
</span><a name="line-219"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeLink.html#linkFail"><span class="hs-identifier hs-var">linkFail</span></a><span> </span><span class="hs-string">&quot;ByteCodeLink.lookupCE&quot;</span><span>
</span><a name="line-220"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unpackFS</span><span> </span><a href="#local-6989586621682423533"><span class="hs-identifier hs-var">sym_to_find</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">linkDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-223"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>
</span><a name="line-224"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><a name="linkDependencies"><a href="Linker.html#linkDependencies"><span class="hs-identifier">linkDependencies</span></a></a><span> </span><a name="local-6989586621682423536"><a href="#local-6989586621682423536"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423537"><a href="#local-6989586621682423537"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423538"><a href="#local-6989586621682423538"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621682423539"><a href="#local-6989586621682423539"><span class="hs-identifier">needed_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-226"></a><span class="hs-comment">--   initDynLinker (hsc_dflags hsc_env)</span><span>
</span><a name="line-227"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423540"><a href="#local-6989586621682423540"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621682423536"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-228"></a><span>       </span><a name="local-6989586621682423541"><a href="#local-6989586621682423541"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423536"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-229"></a><span>   </span><span class="hs-comment">-- The interpreter and dynamic linker can only handle object code built</span><span>
</span><a name="line-230"></a><span>   </span><span class="hs-comment">-- the &quot;normal&quot; way, i.e. no non-std ways like profiling or ticky-ticky.</span><span>
</span><a name="line-231"></a><span>   </span><span class="hs-comment">-- So here we check the build tag: if we're building a non-standard way</span><span>
</span><a name="line-232"></a><span>   </span><span class="hs-comment">-- then we need to find &amp; link object files built the &quot;normal&quot; way.</span><span>
</span><a name="line-233"></a><span>   </span><a name="local-6989586621682423542"><a href="#local-6989586621682423542"><span class="hs-identifier">maybe_normal_osuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#checkNonStdWay"><span class="hs-identifier hs-var">checkNonStdWay</span></a><span> </span><a href="#local-6989586621682423541"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423538"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span>   </span><span class="hs-comment">-- Find what packages and linkables are required</span><span>
</span><a name="line-236"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682423543"><a href="#local-6989586621682423543"><span class="hs-identifier">lnks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423544"><a href="#local-6989586621682423544"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getLinkDeps"><span class="hs-identifier hs-var">getLinkDeps</span></a><span> </span><a href="#local-6989586621682423536"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423540"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621682423537"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-237"></a><span>                               </span><a href="#local-6989586621682423542"><span class="hs-identifier hs-var">maybe_normal_osuf</span></a><span> </span><a href="#local-6989586621682423538"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621682423539"><span class="hs-identifier hs-var">needed_mods</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span>   </span><span class="hs-comment">-- Link the packages and modules required</span><span>
</span><a name="line-240"></a><span>   </span><a name="local-6989586621682423545"><a href="#local-6989586621682423545"><span class="hs-identifier">pls1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkPackages%27"><span class="hs-identifier hs-var">linkPackages'</span></a><span> </span><a href="#local-6989586621682423536"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423544"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><a href="#local-6989586621682423537"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-241"></a><span>   </span><a href="Linker.html#linkModules"><span class="hs-identifier hs-var">linkModules</span></a><span> </span><a href="#local-6989586621682423536"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423545"><span class="hs-identifier hs-var">pls1</span></a><span> </span><a href="#local-6989586621682423543"><span class="hs-identifier hs-var">lnks</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-comment">-- | Temporarily extend the linker state.</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">withExtendedLinkEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExceptionMonad</span><span> </span><a href="#local-6989586621682423499"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-247"></a><span>                       </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621682423500"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423499"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621682423500"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-248"></a><a name="withExtendedLinkEnv"><a href="Linker.html#withExtendedLinkEnv"><span class="hs-identifier">withExtendedLinkEnv</span></a></a><span> </span><a name="local-6989586621682423546"><a href="#local-6989586621682423546"><span class="hs-identifier">new_env</span></a></a><span> </span><a name="local-6989586621682423547"><a href="#local-6989586621682423547"><span class="hs-identifier">action</span></a></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gbracket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Linker.html#extendLinkEnv"><span class="hs-identifier hs-var">extendLinkEnv</span></a><span> </span><a href="#local-6989586621682423546"><span class="hs-identifier hs-var">new_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423548"><span class="hs-identifier hs-var">reset_old_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423547"><span class="hs-identifier hs-var">action</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-comment">-- Remember that the linker state might be side-effected</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-comment">-- during the execution of the IO action, and we don't want to</span><span>
</span><a name="line-255"></a><span>        </span><span class="hs-comment">-- lose those changes (we might have linked a new module or</span><span>
</span><a name="line-256"></a><span>        </span><span class="hs-comment">-- package), so the reset action only removes the names we</span><span>
</span><a name="line-257"></a><span>        </span><span class="hs-comment">-- added earlier.</span><span>
</span><a name="line-258"></a><span>          </span><a name="local-6989586621682423548"><a href="#local-6989586621682423548"><span class="hs-identifier">reset_old_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-259"></a><span>            </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423549"><a href="#local-6989586621682423549"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-260"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423550"><a href="#local-6989586621682423550"><span class="hs-identifier">cur</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><a href="#local-6989586621682423549"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-261"></a><span>                    </span><a name="local-6989586621682423551"><a href="#local-6989586621682423551"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delListFromNameEnv</span><span> </span><a href="#local-6989586621682423550"><span class="hs-identifier hs-var">cur</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682423546"><span class="hs-identifier hs-var">new_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423549"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423551"><span class="hs-identifier hs-var">new</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-comment">-- | Display the persistent linker state.</span><span>
</span><a name="line-266"></a><span class="hs-identifier">showLinkerState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><a name="showLinkerState"><a href="Linker.html#showLinkerState"><span class="hs-identifier">showLinkerState</span></a></a><span> </span><a name="local-6989586621682423552"><a href="#local-6989586621682423552"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-268"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423553"><a href="#local-6989586621682423553"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#readPLS"><span class="hs-identifier hs-var">readPLS</span></a><span>
</span><a name="line-269"></a><span>       </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621682423552"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">SevDump</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-270"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultDumpStyle</span><span> </span><a href="#local-6989586621682423552"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;----- Linker state -----&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>                        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Pkgs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgs_loaded</span><span> </span><a href="#local-6989586621682423553"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>                        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Objs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">objs_loaded</span><span> </span><a href="#local-6989586621682423553"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-274"></a><span>                        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;BCOs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bcos_loaded</span><span> </span><a href="#local-6989586621682423553"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">{- **********************************************************************

                        Initialisation

  ********************************************************************* -}</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-comment">-- | Initialise the dynamic linker.  This entails</span><span>
</span><a name="line-284"></a><span class="hs-comment">--</span><span>
</span><a name="line-285"></a><span class="hs-comment">--  a) Calling the C initialisation procedure,</span><span>
</span><a name="line-286"></a><span class="hs-comment">--</span><span>
</span><a name="line-287"></a><span class="hs-comment">--  b) Loading any packages specified on the command line,</span><span>
</span><a name="line-288"></a><span class="hs-comment">--</span><span>
</span><a name="line-289"></a><span class="hs-comment">--  c) Loading any packages specified on the command line, now held in the</span><span>
</span><a name="line-290"></a><span class="hs-comment">--     @-l@ options in @v_Opt_l@,</span><span>
</span><a name="line-291"></a><span class="hs-comment">--</span><span>
</span><a name="line-292"></a><span class="hs-comment">--  d) Loading any @.o\/.dll@ files specified on the command line, now held</span><span>
</span><a name="line-293"></a><span class="hs-comment">--     in @ldInputs@,</span><span>
</span><a name="line-294"></a><span class="hs-comment">--</span><span>
</span><a name="line-295"></a><span class="hs-comment">--  e) Loading any MacOS frameworks.</span><span>
</span><a name="line-296"></a><span class="hs-comment">--</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- NOTE: This function is idempotent; if called more than once, it does</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- nothing.  This is useful in Template Haskell, where we call it before</span><span>
</span><a name="line-299"></a><span class="hs-comment">-- trying to link.</span><span>
</span><a name="line-300"></a><span class="hs-comment">--</span><span>
</span><a name="line-301"></a><span class="hs-identifier">initDynLinker</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-302"></a><a name="initDynLinker"><a href="Linker.html#initDynLinker"><span class="hs-identifier">initDynLinker</span></a></a><span> </span><a name="local-6989586621682423554"><a href="#local-6989586621682423554"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-303"></a><span>  </span><a href="Linker.html#modifyMbPLS_"><span class="hs-identifier hs-var">modifyMbPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423555"><a href="#local-6989586621682423555"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-304"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423555"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-305"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423555"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-306"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Linker.html#reallyInitDynLinker"><span class="hs-identifier hs-var">reallyInitDynLinker</span></a><span> </span><a href="#local-6989586621682423554"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">reallyInitDynLinker</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-309"></a><a name="reallyInitDynLinker"><a href="Linker.html#reallyInitDynLinker"><span class="hs-identifier">reallyInitDynLinker</span></a></a><span> </span><a name="local-6989586621682423556"><a href="#local-6989586621682423556"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-comment">-- Initialise the linker state</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423557"><a href="#local-6989586621682423557"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423556"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-312"></a><span>      </span><a name="local-6989586621682423558"><a href="#local-6989586621682423558"><span class="hs-identifier">pls0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#emptyPLS"><span class="hs-identifier hs-var">emptyPLS</span></a><span> </span><a href="#local-6989586621682423557"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span>  </span><span class="hs-comment">-- (a) initialise the C dynamic linker</span><span>
</span><a name="line-315"></a><span>  </span><a href="GHCi.html#initObjLinker"><span class="hs-identifier hs-var">initObjLinker</span></a><span> </span><a href="#local-6989586621682423556"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>  </span><span class="hs-comment">-- (b) Load packages from the command-line (Note [preload packages])</span><span>
</span><a name="line-318"></a><span>  </span><a name="local-6989586621682423559"><a href="#local-6989586621682423559"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkPackages%27"><span class="hs-identifier hs-var">linkPackages'</span></a><span> </span><a href="#local-6989586621682423556"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">preloadPackages</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621682423557"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423558"><span class="hs-identifier hs-var">pls0</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>  </span><span class="hs-comment">-- steps (c), (d) and (e)</span><span>
</span><a name="line-321"></a><span>  </span><a href="Linker.html#linkCmdLineLibs%27"><span class="hs-identifier hs-var">linkCmdLineLibs'</span></a><span> </span><a href="#local-6989586621682423556"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423559"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-identifier">linkCmdLineLibs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><a name="linkCmdLineLibs"><a href="Linker.html#linkCmdLineLibs"><span class="hs-identifier">linkCmdLineLibs</span></a></a><span> </span><a name="local-6989586621682423560"><a href="#local-6989586621682423560"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-326"></a><span>  </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423560"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-327"></a><span>  </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423561"><a href="#local-6989586621682423561"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-328"></a><span>    </span><a href="Linker.html#linkCmdLineLibs%27"><span class="hs-identifier hs-var">linkCmdLineLibs'</span></a><span> </span><a href="#local-6989586621682423560"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423561"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span class="hs-identifier">linkCmdLineLibs'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-331"></a><a name="linkCmdLineLibs%27"><a href="Linker.html#linkCmdLineLibs%27"><span class="hs-identifier">linkCmdLineLibs'</span></a></a><span> </span><a name="local-6989586621682423562"><a href="#local-6989586621682423562"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423563"><a href="#local-6989586621682423563"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-keyword">do</span><span>
</span><a name="line-333"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423564"><a href="#local-6989586621682423564"><span class="hs-identifier">dflags</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DynFlags</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682423565"><a href="#local-6989586621682423565"><span class="hs-identifier">cmdline_ld_inputs</span></a></a><span>
</span><a name="line-334"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">libraryPaths</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682423566"><a href="#local-6989586621682423566"><span class="hs-identifier">lib_paths_base</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423562"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span>      </span><span class="hs-comment">-- (c) Link libraries from the command-line</span><span>
</span><a name="line-338"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423567"><a href="#local-6989586621682423567"><span class="hs-identifier">minus_ls_1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423568"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><span class="hs-char">'l'</span><span class="hs-glyph">:</span><a name="local-6989586621682423568"><a href="#local-6989586621682423568"><span class="hs-identifier">lib</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423565"><span class="hs-identifier hs-var">cmdline_ld_inputs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>      </span><span class="hs-comment">-- On Windows we want to add libpthread by default just as GCC would.</span><span>
</span><a name="line-341"></a><span>      </span><span class="hs-comment">-- However because we don't know the actual name of pthread's dll we</span><span>
</span><a name="line-342"></a><span>      </span><span class="hs-comment">-- need to defer this to the locateLib call so we can't initialize it</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-comment">-- inside of the rts. Instead we do it here to be able to find the</span><span>
</span><a name="line-344"></a><span>      </span><span class="hs-comment">-- import library for pthreads. See Trac #13210.</span><span>
</span><a name="line-345"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423569"><a href="#local-6989586621682423569"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-346"></a><span>          </span><a name="local-6989586621682423570"><a href="#local-6989586621682423570"><span class="hs-identifier">os</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621682423569"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-347"></a><span>          </span><a name="local-6989586621682423571"><a href="#local-6989586621682423571"><span class="hs-identifier">minus_ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423570"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-348"></a><span>                       </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;pthread&quot;</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682423567"><span class="hs-identifier hs-var">minus_ls_1</span></a><span>
</span><a name="line-349"></a><span>                       </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423567"><span class="hs-identifier hs-var">minus_ls_1</span></a><span>
</span><a name="line-350"></a><span>      </span><span class="hs-comment">-- See Note [Fork/Exec Windows]</span><span>
</span><a name="line-351"></a><span>      </span><a name="local-6989586621682423572"><a href="#local-6989586621682423572"><span class="hs-identifier">gcc_paths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getGCCPaths"><span class="hs-identifier hs-var">getGCCPaths</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423570"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>      </span><a name="local-6989586621682423573"><a href="#local-6989586621682423573"><span class="hs-identifier">lib_paths_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#addEnvPaths"><span class="hs-identifier hs-var">addEnvPaths</span></a><span> </span><span class="hs-string">&quot;LIBRARY_PATH&quot;</span><span> </span><a href="#local-6989586621682423566"><span class="hs-identifier hs-var">lib_paths_base</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>      </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Search directories (user):&quot;</span><span>
</span><a name="line-356"></a><span>      </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unlines</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;  &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423573"><span class="hs-identifier hs-var">lib_paths_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>      </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Search directories (gcc):&quot;</span><span>
</span><a name="line-358"></a><span>      </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unlines</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;  &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423572"><span class="hs-identifier hs-var">gcc_paths</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>      </span><a name="local-6989586621682423574"><a href="#local-6989586621682423574"><span class="hs-identifier">libspecs</span></a></a><span>
</span><a name="line-361"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Linker.html#locateLib"><span class="hs-identifier hs-var">locateLib</span></a><span> </span><a href="#local-6989586621682423562"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682423573"><span class="hs-identifier hs-var">lib_paths_env</span></a><span> </span><a href="#local-6989586621682423572"><span class="hs-identifier hs-var">gcc_paths</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423571"><span class="hs-identifier hs-var">minus_ls</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>      </span><span class="hs-comment">-- (d) Link .o files from the command-line</span><span>
</span><a name="line-364"></a><span>      </span><a name="local-6989586621682423576"><a href="#local-6989586621682423576"><span class="hs-identifier">classified_ld_inputs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Linker.html#classifyLdInput"><span class="hs-identifier hs-var">classifyLdInput</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>                                </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423575"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682423575"><a href="#local-6989586621682423575"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423565"><span class="hs-identifier hs-var">cmdline_ld_inputs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>      </span><span class="hs-comment">-- (e) Link any MacOS frameworks</span><span>
</span><a name="line-368"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423577"><a href="#local-6989586621682423577"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-369"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423578"><a href="#local-6989586621682423578"><span class="hs-identifier">framework_paths</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423579"><a href="#local-6989586621682423579"><span class="hs-identifier">frameworks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-370"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><a href="#local-6989586621682423577"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-371"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">frameworkPaths</span><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cmdlineFrameworks</span><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span>      </span><span class="hs-comment">-- Finally do (c),(d),(e)</span><span>
</span><a name="line-375"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423580"><a href="#local-6989586621682423580"><span class="hs-identifier">cmdline_lib_specs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621682423576"><span class="hs-identifier hs-var">classified_ld_inputs</span></a><span>
</span><a name="line-376"></a><span>                           </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423574"><span class="hs-identifier hs-var">libspecs</span></a><span>
</span><a name="line-377"></a><span>                           </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Linker.html#Framework"><span class="hs-identifier hs-var">Framework</span></a><span> </span><a href="#local-6989586621682423579"><span class="hs-identifier hs-var">frameworks</span></a><span>
</span><a name="line-378"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682423580"><span class="hs-identifier hs-var">cmdline_lib_specs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423563"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-379"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>      </span><span class="hs-comment">-- Add directories to library search paths, this only has an effect</span><span>
</span><a name="line-382"></a><span>      </span><span class="hs-comment">-- on Windows. On Unix OSes this function is a NOP.</span><span>
</span><a name="line-383"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423581"><a href="#local-6989586621682423581"><span class="hs-identifier">all_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423582"><a href="#local-6989586621682423582"><span class="hs-identifier">paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sPgm_c</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">settings</span><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>                                </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682423578"><span class="hs-identifier hs-var">framework_paths</span></a><span>
</span><a name="line-385"></a><span>                               </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423566"><span class="hs-identifier hs-var">lib_paths_base</span></a><span>
</span><a name="line-386"></a><span>                               </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621682423583"><span class="hs-identifier hs-var">dll</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span> </span><a name="local-6989586621682423583"><a href="#local-6989586621682423583"><span class="hs-identifier">dll</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423574"><span class="hs-identifier hs-var">libspecs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-387"></a><span>                      </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">normalise</span><span> </span><a href="#local-6989586621682423582"><span class="hs-identifier hs-var">paths</span></a><span>
</span><a name="line-388"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423584"><a href="#local-6989586621682423584"><span class="hs-identifier">lib_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423566"><span class="hs-identifier hs-var">lib_paths_base</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423572"><span class="hs-identifier hs-var">gcc_paths</span></a><span>
</span><a name="line-389"></a><span>      </span><a name="local-6989586621682423585"><a href="#local-6989586621682423585"><span class="hs-identifier">all_paths_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#addEnvPaths"><span class="hs-identifier hs-var">addEnvPaths</span></a><span> </span><span class="hs-string">&quot;LD_LIBRARY_PATH&quot;</span><span> </span><a href="#local-6989586621682423581"><span class="hs-identifier hs-var">all_paths</span></a><span>
</span><a name="line-390"></a><span>      </span><a name="local-6989586621682423586"><a href="#local-6989586621682423586"><span class="hs-identifier">pathCache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#addLibrarySearchPath"><span class="hs-identifier hs-var">addLibrarySearchPath</span></a><span> </span><a href="#local-6989586621682423562"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423585"><span class="hs-identifier hs-var">all_paths_env</span></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>      </span><a name="local-6989586621682423587"><a href="#local-6989586621682423587"><span class="hs-identifier">pls1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><a href="Linker.html#preloadLib"><span class="hs-identifier hs-var">preloadLib</span></a><span> </span><a href="#local-6989586621682423562"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423584"><span class="hs-identifier hs-var">lib_paths</span></a><span> </span><a href="#local-6989586621682423578"><span class="hs-identifier hs-var">framework_paths</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423563"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-393"></a><span>                    </span><a href="#local-6989586621682423580"><span class="hs-identifier hs-var">cmdline_lib_specs</span></a><span>
</span><a name="line-394"></a><span>      </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;final link ... &quot;</span><span>
</span><a name="line-395"></a><span>      </span><a name="local-6989586621682423588"><a href="#local-6989586621682423588"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#resolveObjs"><span class="hs-identifier hs-var">resolveObjs</span></a><span> </span><a href="#local-6989586621682423562"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span>      </span><span class="hs-comment">-- DLLs are loaded, reset the search paths</span><span>
</span><a name="line-398"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#removeLibrarySearchPath"><span class="hs-identifier hs-var">removeLibrarySearchPath</span></a><span> </span><a href="#local-6989586621682423562"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682423586"><span class="hs-identifier hs-var">pathCache</span></a><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">succeeded</span><span> </span><a href="#local-6989586621682423588"><span class="hs-identifier hs-var">ok</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423564"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;done&quot;</span><span>
</span><a name="line-401"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;linking extra libraries/objects failed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423587"><span class="hs-identifier hs-var">pls1</span></a><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-comment">{- Note [preload packages]

Why do we need to preload packages from the command line?  This is an
explanation copied from #2437:

I tried to implement the suggestion from #3560, thinking it would be
easy, but there are two reasons we link in packages eagerly when they
are mentioned on the command line:

  * So that you can link in extra object files or libraries that
    depend on the packages. e.g. ghc -package foo -lbar where bar is a
    C library that depends on something in foo. So we could link in
    foo eagerly if and only if there are extra C libs or objects to
    link in, but....

  * Haskell code can depend on a C function exported by a package, and
    the normal dependency tracking that TH uses can't know about these
    dependencies. The test ghcilink004 relies on this, for example.

I conclude that we need two -package flags: one that says &quot;this is a
package I want to make available&quot;, and one that says &quot;this is a
package I want to link in eagerly&quot;. Would that be too complicated for
users?
-}</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">classifyLdInput</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Linker.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><a name="classifyLdInput"><a href="Linker.html#classifyLdInput"><span class="hs-identifier">classifyLdInput</span></a></a><span> </span><a name="local-6989586621682423589"><a href="#local-6989586621682423589"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682423590"><a href="#local-6989586621682423590"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isObjectFilename</span><span> </span><a href="#local-6989586621682423591"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682423590"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Linker.html#Object"><span class="hs-identifier hs-var">Object</span></a><span> </span><a href="#local-6989586621682423590"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDynLibFilename</span><span> </span><a href="#local-6989586621682423591"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682423590"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span> </span><a href="#local-6989586621682423590"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621682423589"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">SevInfo</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-436"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><a href="#local-6989586621682423589"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Warning: ignoring unrecognised input `&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423590"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;'&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-439"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682423591"><a href="#local-6989586621682423591"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423589"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span class="hs-identifier">preloadLib</span><span>
</span><a name="line-442"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-443"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-444"></a><a name="preloadLib"><a href="Linker.html#preloadLib"><span class="hs-identifier">preloadLib</span></a></a><span> </span><a name="local-6989586621682423592"><a href="#local-6989586621682423592"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423593"><a href="#local-6989586621682423593"><span class="hs-identifier">lib_paths</span></a></a><span> </span><a name="local-6989586621682423594"><a href="#local-6989586621682423594"><span class="hs-identifier">framework_paths</span></a></a><span> </span><a name="local-6989586621682423595"><a href="#local-6989586621682423595"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423596"><a href="#local-6989586621682423596"><span class="hs-identifier">lib_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-445"></a><span>  </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Loading object &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="Linker.html#showLS"><span class="hs-identifier hs-var">showLS</span></a><span> </span><a href="#local-6989586621682423596"><span class="hs-identifier hs-var">lib_spec</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; ... &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-446"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423596"><span class="hs-identifier hs-var">lib_spec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-447"></a><span>    </span><a href="Linker.html#Object"><span class="hs-identifier hs-var">Object</span></a><span> </span><a name="local-6989586621682423613"><a href="#local-6989586621682423613"><span class="hs-identifier">static_ish</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-448"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682423614"><a href="#local-6989586621682423614"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423615"><a href="#local-6989586621682423615"><span class="hs-identifier">pls1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423600"><span class="hs-identifier hs-var">preload_static</span></a><span> </span><a href="#local-6989586621682423593"><span class="hs-identifier hs-var">lib_paths</span></a><span> </span><a href="#local-6989586621682423613"><span class="hs-identifier hs-var">static_ish</span></a><span>
</span><a name="line-449"></a><span>      </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682423614"><span class="hs-identifier hs-var">b</span></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;done&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;not found&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423615"><span class="hs-identifier hs-var">pls1</span></a><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>    </span><a href="Linker.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><a name="local-6989586621682423616"><a href="#local-6989586621682423616"><span class="hs-identifier">static_ish</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-453"></a><span>      </span><a name="local-6989586621682423617"><a href="#local-6989586621682423617"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423601"><span class="hs-identifier hs-var">preload_static_archive</span></a><span> </span><a href="#local-6989586621682423593"><span class="hs-identifier hs-var">lib_paths</span></a><span> </span><a href="#local-6989586621682423616"><span class="hs-identifier hs-var">static_ish</span></a><span>
</span><a name="line-454"></a><span>      </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682423617"><span class="hs-identifier hs-var">b</span></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;done&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;not found&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span>    </span><a href="Linker.html#DLL"><span class="hs-identifier hs-var">DLL</span></a><span> </span><a name="local-6989586621682423618"><a href="#local-6989586621682423618"><span class="hs-identifier">dll_unadorned</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-458"></a><span>      </span><a name="local-6989586621682423619"><a href="#local-6989586621682423619"><span class="hs-identifier">maybe_errstr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSOName</span><span> </span><a href="#local-6989586621682423598"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682423618"><span class="hs-identifier hs-var">dll_unadorned</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423619"><span class="hs-identifier hs-var">maybe_errstr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-460"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;done&quot;</span><span>
</span><a name="line-461"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423620"><a href="#local-6989586621682423620"><span class="hs-identifier">mm</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621682423598"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-462"></a><span>           </span><a href="#local-6989586621682423599"><span class="hs-identifier hs-var">preloadFailed</span></a><span> </span><a href="#local-6989586621682423620"><span class="hs-identifier hs-var">mm</span></a><span> </span><a href="#local-6989586621682423593"><span class="hs-identifier hs-var">lib_paths</span></a><span> </span><a href="#local-6989586621682423596"><span class="hs-identifier hs-var">lib_spec</span></a><span>
</span><a name="line-463"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423621"><a href="#local-6989586621682423621"><span class="hs-identifier">mm</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-464"></a><span>           </span><span class="hs-comment">-- As a backup, on Darwin, try to also load a .so file</span><span>
</span><a name="line-465"></a><span>           </span><span class="hs-comment">-- since (apparently) some things install that way - see</span><span>
</span><a name="line-466"></a><span>           </span><span class="hs-comment">-- ticket #8770.</span><span>
</span><a name="line-467"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423622"><a href="#local-6989586621682423622"><span class="hs-identifier">libfile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423618"><span class="hs-identifier hs-var">dll_unadorned</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;so&quot;</span><span>
</span><a name="line-468"></a><span>           </span><a name="local-6989586621682423623"><a href="#local-6989586621682423623"><span class="hs-identifier">err2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423622"><span class="hs-identifier hs-var">libfile</span></a><span>
</span><a name="line-469"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423623"><span class="hs-identifier hs-var">err2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-470"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;done&quot;</span><span>
</span><a name="line-471"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423599"><span class="hs-identifier hs-var">preloadFailed</span></a><span> </span><a href="#local-6989586621682423621"><span class="hs-identifier hs-var">mm</span></a><span> </span><a href="#local-6989586621682423593"><span class="hs-identifier hs-var">lib_paths</span></a><span> </span><a href="#local-6989586621682423596"><span class="hs-identifier hs-var">lib_spec</span></a><span>
</span><a name="line-472"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>    </span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span> </span><a name="local-6989586621682423624"><a href="#local-6989586621682423624"><span class="hs-identifier">dll_path</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-475"></a><span>      </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423625"><a href="#local-6989586621682423625"><span class="hs-identifier">maybe_errstr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423624"><span class="hs-identifier hs-var">dll_path</span></a><span>
</span><a name="line-476"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423625"><span class="hs-identifier hs-var">maybe_errstr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-477"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;done&quot;</span><span>
</span><a name="line-478"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423626"><a href="#local-6989586621682423626"><span class="hs-identifier">mm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423599"><span class="hs-identifier hs-var">preloadFailed</span></a><span> </span><a href="#local-6989586621682423626"><span class="hs-identifier hs-var">mm</span></a><span> </span><a href="#local-6989586621682423593"><span class="hs-identifier hs-var">lib_paths</span></a><span> </span><a href="#local-6989586621682423596"><span class="hs-identifier hs-var">lib_spec</span></a><span>
</span><a name="line-479"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span>    </span><a href="Linker.html#Framework"><span class="hs-identifier hs-var">Framework</span></a><span> </span><a name="local-6989586621682423627"><a href="#local-6989586621682423627"><span class="hs-identifier">framework</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-482"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423628"><a href="#local-6989586621682423628"><span class="hs-identifier">maybe_errstr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#loadFramework"><span class="hs-identifier hs-var">loadFramework</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423594"><span class="hs-identifier hs-var">framework_paths</span></a><span> </span><a href="#local-6989586621682423627"><span class="hs-identifier hs-var">framework</span></a><span>
</span><a name="line-484"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423628"><span class="hs-identifier hs-var">maybe_errstr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-485"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;done&quot;</span><span>
</span><a name="line-486"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423629"><a href="#local-6989586621682423629"><span class="hs-identifier">mm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423599"><span class="hs-identifier hs-var">preloadFailed</span></a><span> </span><a href="#local-6989586621682423629"><span class="hs-identifier hs-var">mm</span></a><span> </span><a href="#local-6989586621682423594"><span class="hs-identifier hs-var">framework_paths</span></a><span> </span><a href="#local-6989586621682423596"><span class="hs-identifier hs-var">lib_spec</span></a><span>
</span><a name="line-487"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-488"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;preloadLib Framework&quot;</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-491"></a><span>    </span><a name="local-6989586621682423597"><a href="#local-6989586621682423597"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>    </span><a name="local-6989586621682423598"><a href="#local-6989586621682423598"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span>    </span><span class="hs-identifier">preloadFailed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>    </span><a name="local-6989586621682423599"><a href="#local-6989586621682423599"><span class="hs-identifier">preloadFailed</span></a></a><span> </span><a name="local-6989586621682423602"><a href="#local-6989586621682423602"><span class="hs-identifier">sys_errmsg</span></a></a><span> </span><a name="local-6989586621682423603"><a href="#local-6989586621682423603"><span class="hs-identifier">paths</span></a></a><span> </span><a name="local-6989586621682423604"><a href="#local-6989586621682423604"><span class="hs-identifier">spec</span></a></a><span>
</span><a name="line-497"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;failed.\n&quot;</span><span>
</span><a name="line-498"></a><span>            </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-499"></a><span>              </span><span class="hs-identifier hs-var">CmdLineError</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-500"></a><span>                    </span><span class="hs-string">&quot;user specified .o/.so/.DLL could not be loaded (&quot;</span><span>
</span><a name="line-501"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423602"><span class="hs-identifier hs-var">sys_errmsg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)\nWhilst trying to load:  &quot;</span><span>
</span><a name="line-502"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><a href="Linker.html#showLS"><span class="hs-identifier hs-var">showLS</span></a><span> </span><a href="#local-6989586621682423604"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\nAdditional directories searched:&quot;</span><span>
</span><a name="line-503"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682423603"><span class="hs-identifier hs-var">paths</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot; (none)&quot;</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-504"></a><span>                        </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;   &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423603"><span class="hs-identifier hs-var">paths</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span>    </span><span class="hs-comment">-- Not interested in the paths in the static case.</span><span>
</span><a name="line-507"></a><span>    </span><a name="local-6989586621682423600"><a href="#local-6989586621682423600"><span class="hs-identifier">preload_static</span></a></a><span> </span><a name="local-6989586621682423605"><a href="#local-6989586621682423605"><span class="hs-identifier">_paths</span></a></a><span> </span><a name="local-6989586621682423606"><a href="#local-6989586621682423606"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-508"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423607"><a href="#local-6989586621682423607"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621682423606"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-509"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682423607"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dynamicGhc</span><span>
</span><a name="line-511"></a><span>                             </span><span class="hs-keyword">then</span><span>  </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423608"><a href="#local-6989586621682423608"><span class="hs-identifier">pls1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#dynLoadObjs"><span class="hs-identifier hs-var">dynLoadObjs</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423606"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span>
</span><a name="line-512"></a><span>                                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423608"><span class="hs-identifier hs-var">pls1</span></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>                             </span><span class="hs-keyword">else</span><span>  </span><span class="hs-keyword">do</span><span> </span><a href="GHCi.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423606"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-514"></a><span>                                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423595"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span>    </span><a name="local-6989586621682423601"><a href="#local-6989586621682423601"><span class="hs-identifier">preload_static_archive</span></a></a><span> </span><a name="local-6989586621682423609"><a href="#local-6989586621682423609"><span class="hs-identifier">_paths</span></a></a><span> </span><a name="local-6989586621682423610"><a href="#local-6989586621682423610"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-517"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423612"><a href="#local-6989586621682423612"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621682423610"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-518"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682423612"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-519"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dynamicGhc</span><span>
</span><a name="line-520"></a><span>                                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-521"></a><span>                                      </span><span class="hs-identifier hs-var">CmdLineError</span><span> </span><a href="#local-6989586621682423611"><span class="hs-identifier hs-var">dynamic_msg</span></a><span>
</span><a name="line-522"></a><span>                                 </span><span class="hs-keyword">else</span><span> </span><a href="GHCi.html#loadArchive"><span class="hs-identifier hs-var">loadArchive</span></a><span> </span><a href="#local-6989586621682423592"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423610"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-523"></a><span>                             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-524"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-525"></a><span>        </span><a name="local-6989586621682423611"><a href="#local-6989586621682423611"><span class="hs-identifier">dynamic_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unlines</span><span>
</span><a name="line-526"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;User-specified static library could not be loaded (&quot;</span><span>
</span><a name="line-527"></a><span>            </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423610"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-528"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Loading static libraries is not supported in this configuration.&quot;</span><span>
</span><a name="line-529"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Try using a dynamic library instead.&quot;</span><span>
</span><a name="line-530"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-comment">{- **********************************************************************

                        Link a byte-code expression

  ********************************************************************* -}</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-comment">-- | Link a single expression, /including/ first linking packages and</span><span>
</span><a name="line-540"></a><span class="hs-comment">-- modules that this expression depends on.</span><span>
</span><a name="line-541"></a><span class="hs-comment">--</span><span>
</span><a name="line-542"></a><span class="hs-comment">-- Raises an IO exception ('ProgramError') if it can't find a compiled</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- version of the dependents to link.</span><span>
</span><a name="line-544"></a><span class="hs-comment">--</span><span>
</span><a name="line-545"></a><span class="hs-identifier">linkExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UnlinkedBCO</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-546"></a><a name="linkExpr"><a href="Linker.html#linkExpr"><span class="hs-identifier">linkExpr</span></a></a><span> </span><a name="local-6989586621682423630"><a href="#local-6989586621682423630"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423631"><a href="#local-6989586621682423631"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621682423632"><a href="#local-6989586621682423632"><span class="hs-identifier">root_ul_bco</span></a></a><span>
</span><a name="line-547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-548"></a><span>     </span><span class="hs-comment">-- Initialise the linker (if it's not been done already)</span><span>
</span><a name="line-549"></a><span>   </span><span class="hs-special">;</span><span> </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423630"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span>     </span><span class="hs-comment">-- Take lock for the actual work.</span><span>
</span><a name="line-552"></a><span>   </span><span class="hs-special">;</span><span> </span><a href="Linker.html#modifyPLS"><span class="hs-identifier hs-var">modifyPLS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423636"><a href="#local-6989586621682423636"><span class="hs-identifier">pls0</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>     </span><span class="hs-comment">-- Link the packages and modules required</span><span>
</span><a name="line-555"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423637"><a href="#local-6989586621682423637"><span class="hs-identifier">pls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423638"><a href="#local-6989586621682423638"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkDependencies"><span class="hs-identifier hs-var">linkDependencies</span></a><span> </span><a href="#local-6989586621682423630"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423636"><span class="hs-identifier hs-var">pls0</span></a><span> </span><a href="#local-6989586621682423631"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621682423634"><span class="hs-identifier hs-var">needed_mods</span></a><span>
</span><a name="line-556"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">failed</span><span> </span><a href="#local-6989586621682423638"><span class="hs-identifier hs-var">ok</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-557"></a><span>        </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span>     </span><span class="hs-comment">-- Link the expression itself</span><span>
</span><a name="line-561"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423639"><a href="#local-6989586621682423639"><span class="hs-identifier">ie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">itbl_env</span><span> </span><a href="#local-6989586621682423637"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-562"></a><span>         </span><a name="local-6989586621682423640"><a href="#local-6989586621682423640"><span class="hs-identifier">ce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><a href="#local-6989586621682423637"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>     </span><span class="hs-comment">-- Link the necessary packages and linkables</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423641"><a href="#local-6989586621682423641"><span class="hs-identifier">nobreakarray</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;no break array&quot;</span><span>
</span><a name="line-567"></a><span>         </span><a name="local-6989586621682423642"><a href="#local-6989586621682423642"><span class="hs-identifier">bco_ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">unlinkedBCOName</span><span> </span><a href="#local-6989586621682423632"><span class="hs-identifier hs-var">root_ul_bco</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-568"></a><span>   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682423643"><a href="#local-6989586621682423643"><span class="hs-identifier">resolved</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeLink.html#linkBCO"><span class="hs-identifier hs-var">linkBCO</span></a><span> </span><a href="#local-6989586621682423630"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423639"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682423640"><span class="hs-identifier hs-var">ce</span></a><span> </span><a href="#local-6989586621682423642"><span class="hs-identifier hs-var">bco_ix</span></a><span> </span><a href="#local-6989586621682423641"><span class="hs-identifier hs-var">nobreakarray</span></a><span> </span><a href="#local-6989586621682423632"><span class="hs-identifier hs-var">root_ul_bco</span></a><span>
</span><a name="line-569"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682423644"><a href="#local-6989586621682423644"><span class="hs-identifier">root_hvref</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#createBCOs"><span class="hs-identifier hs-var">createBCOs</span></a><span> </span><a href="#local-6989586621682423630"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423643"><span class="hs-identifier hs-var">resolved</span></a><span class="hs-special">]</span><span>
</span><a name="line-570"></a><span>   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682423645"><a href="#local-6989586621682423645"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621682423630"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423644"><span class="hs-identifier hs-var">root_hvref</span></a><span>
</span><a name="line-571"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423637"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423645"><span class="hs-identifier hs-var">fhv</span></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>   </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-573"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-574"></a><span>     </span><a name="local-6989586621682423633"><a href="#local-6989586621682423633"><span class="hs-identifier">free_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uniqDSetToList</span><span> </span><span class="hs-special">(</span><a href="ByteCodeAsm.html#bcoFreeNames"><span class="hs-identifier hs-var">bcoFreeNames</span></a><span> </span><a href="#local-6989586621682423632"><span class="hs-identifier hs-var">root_ul_bco</span></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>     </span><span class="hs-identifier">needed_mods</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>
</span><a name="line-577"></a><span>     </span><a name="local-6989586621682423634"><a href="#local-6989586621682423634"><span class="hs-identifier">needed_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621682423635"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682423635"><a href="#local-6989586621682423635"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423633"><span class="hs-identifier hs-var">free_names</span></a><span class="hs-special">,</span><span>
</span><a name="line-578"></a><span>                     </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621682423635"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Names from other modules</span><span>
</span><a name="line-579"></a><span>                     </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621682423635"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Exclude wired-in names</span><span>
</span><a name="line-580"></a><span>                   </span><span class="hs-special">]</span><span>                        </span><span class="hs-comment">-- (see note below)</span><span>
</span><a name="line-581"></a><span>        </span><span class="hs-comment">-- Exclude wired-in names because we may not have read</span><span>
</span><a name="line-582"></a><span>        </span><span class="hs-comment">-- their interface files, so getLinkDeps will fail</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-comment">-- All wired-in names are in the base package, which we link</span><span>
</span><a name="line-584"></a><span>        </span><span class="hs-comment">-- by default, so we can safely ignore them here.</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-identifier">dieWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682423498"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-587"></a><a name="dieWith"><a href="Linker.html#dieWith"><span class="hs-identifier">dieWith</span></a></a><span> </span><a name="local-6989586621682423646"><a href="#local-6989586621682423646"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682423647"><a href="#local-6989586621682423647"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621682423648"><a href="#local-6989586621682423648"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621682423646"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLocMessage</span><span> </span><span class="hs-identifier hs-var">SevFatal</span><span> </span><a href="#local-6989586621682423647"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621682423648"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span class="hs-identifier">checkNonStdWay</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><a name="checkNonStdWay"><a href="Linker.html#checkNonStdWay"><span class="hs-identifier">checkNonStdWay</span></a></a><span> </span><a name="local-6989586621682423649"><a href="#local-6989586621682423649"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682423650"><a href="#local-6989586621682423650"><span class="hs-identifier">srcspan</span></a></a><span>
</span><a name="line-592"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621682423649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-593"></a><span>    </span><span class="hs-comment">-- with -fexternal-interpreter we load the .o files, whatever way</span><span>
</span><a name="line-594"></a><span>    </span><span class="hs-comment">-- they were built.  If they were built for a non-std way, then</span><span>
</span><a name="line-595"></a><span>    </span><span class="hs-comment">-- we will use the appropriate variant of the iserv binary to load them.</span><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">interpWays</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682423651"><span class="hs-identifier hs-var">haskellWays</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-598"></a><span>    </span><span class="hs-comment">-- Only if we are compiling with the same ways as GHC is built</span><span>
</span><a name="line-599"></a><span>    </span><span class="hs-comment">-- with, can we dynamically load those object files. (see #3604)</span><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621682423649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Linker.html#normalObjectSuffix"><span class="hs-identifier hs-var">normalObjectSuffix</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682423651"><span class="hs-identifier hs-var">haskellWays</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#failNonStd"><span class="hs-identifier hs-var">failNonStd</span></a><span> </span><a href="#local-6989586621682423649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423650"><span class="hs-identifier hs-var">srcspan</span></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423652"><span class="hs-identifier hs-var">interpTag</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;o&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-606"></a><span>    </span><a name="local-6989586621682423651"><a href="#local-6989586621682423651"><span class="hs-identifier">haskellWays</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">wayRTSOnly</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621682423649"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>    </span><a name="local-6989586621682423652"><a href="#local-6989586621682423652"><span class="hs-identifier">interpTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">mkBuildTag</span><span> </span><span class="hs-identifier hs-var">interpWays</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-608"></a><span>                  </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-609"></a><span>                  </span><a name="local-6989586621682423653"><a href="#local-6989586621682423653"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423653"><span class="hs-identifier hs-var">tag</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_&quot;</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-identifier">normalObjectSuffix</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-612"></a><a name="normalObjectSuffix"><a href="Linker.html#normalObjectSuffix"><span class="hs-identifier">normalObjectSuffix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">phaseInputExt</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span class="hs-identifier">failNonStd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-615"></a><a name="failNonStd"><a href="Linker.html#failNonStd"><span class="hs-identifier">failNonStd</span></a></a><span> </span><a name="local-6989586621682423654"><a href="#local-6989586621682423654"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682423655"><a href="#local-6989586621682423655"><span class="hs-identifier">srcspan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#dieWith"><span class="hs-identifier hs-var">dieWith</span></a><span> </span><a href="#local-6989586621682423654"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423655"><span class="hs-identifier hs-var">srcspan</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-616"></a><span>  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot load&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682423656"><span class="hs-identifier hs-var">compWay</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-617"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;objects when GHC is built&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682423657"><span class="hs-identifier hs-var">ghciWay</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-618"></a><span>  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;To fix this, either:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-619"></a><span>  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  (1) Use -fexternal-interpreter, or&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-620"></a><span>  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  (2) Build the program twice: once&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-621"></a><span>                       </span><a href="#local-6989586621682423657"><span class="hs-identifier hs-var">ghciWay</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, and then&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-622"></a><span>  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;      with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682423656"><span class="hs-identifier hs-var">compWay</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-623"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;using -osuf to set a different object file suffix.&quot;</span><span>
</span><a name="line-624"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682423656"><a href="#local-6989586621682423656"><span class="hs-identifier">compWay</span></a></a><span>
</span><a name="line-625"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621682423654"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-dynamic&quot;</span><span>
</span><a name="line-626"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayProf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621682423654"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-prof&quot;</span><span>
</span><a name="line-627"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;normal&quot;</span><span>
</span><a name="line-628"></a><span>          </span><a name="local-6989586621682423657"><a href="#local-6989586621682423657"><span class="hs-identifier">ghciWay</span></a></a><span>
</span><a name="line-629"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dynamicGhc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with -dynamic&quot;</span><span>
</span><a name="line-630"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">rtsIsProfiled</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with -prof&quot;</span><span>
</span><a name="line-631"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;the normal way&quot;</span><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span class="hs-identifier">getLinkDeps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-634"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-635"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>                   </span><span class="hs-comment">-- replace object suffices?</span><span>
</span><a name="line-636"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>                          </span><span class="hs-comment">-- for error messages</span><span>
</span><a name="line-637"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>                         </span><span class="hs-comment">-- If you need these</span><span>
</span><a name="line-638"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- ... then link these first</span><span>
</span><a name="line-639"></a><span class="hs-comment">-- Fails with an IO exception if it can't find enough files</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><a name="getLinkDeps"><a href="Linker.html#getLinkDeps"><span class="hs-identifier">getLinkDeps</span></a></a><span> </span><a name="local-6989586621682423658"><a href="#local-6989586621682423658"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423659"><a href="#local-6989586621682423659"><span class="hs-identifier">hpt</span></a></a><span> </span><a name="local-6989586621682423660"><a href="#local-6989586621682423660"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423661"><a href="#local-6989586621682423661"><span class="hs-identifier">replace_osuf</span></a></a><span> </span><a name="local-6989586621682423662"><a href="#local-6989586621682423662"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621682423663"><a href="#local-6989586621682423663"><span class="hs-identifier">mods</span></a></a><span>
</span><a name="line-642"></a><span class="hs-comment">-- Find all the packages and linkables that a set of modules depends on</span><span>
</span><a name="line-643"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-644"></a><span>        </span><span class="hs-comment">-- 1.  Find the dependent home-pkg-modules/packages from each iface</span><span>
</span><a name="line-645"></a><span>        </span><span class="hs-comment">-- (omitting modules from the interactive package, which is already linked)</span><span>
</span><a name="line-646"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423721"><a href="#local-6989586621682423721"><span class="hs-identifier">mods_s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423722"><a href="#local-6989586621682423722"><span class="hs-identifier">pkgs_s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423666"><span class="hs-identifier hs-var">follow_deps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-identifier hs-var">isInteractiveModule</span><span> </span><a href="#local-6989586621682423663"><span class="hs-identifier hs-var">mods</span></a><span class="hs-special">)</span><span>
</span><a name="line-647"></a><span>                                        </span><span class="hs-identifier hs-var">emptyUniqDSet</span><span> </span><span class="hs-identifier hs-var">emptyUniqDSet</span><span class="hs-special">;</span><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-650"></a><span>        </span><span class="hs-comment">-- 2.  Exclude ones already linked</span><span>
</span><a name="line-651"></a><span>        </span><span class="hs-comment">--      Main reason: avoid findModule calls in get_linkable</span><span>
</span><a name="line-652"></a><span>            </span><a name="local-6989586621682423723"><a href="#local-6989586621682423723"><span class="hs-identifier">mods_needed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423721"><span class="hs-identifier hs-var">mods_s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682423725"><span class="hs-identifier hs-var">linked_mods</span></a><span>     </span><span class="hs-special">;</span><span>
</span><a name="line-653"></a><span>            </span><a name="local-6989586621682423724"><a href="#local-6989586621682423724"><span class="hs-identifier">pkgs_needed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423722"><span class="hs-identifier hs-var">pkgs_s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusList</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">pkgs_loaded</span><span> </span><a href="#local-6989586621682423660"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span>            </span><a name="local-6989586621682423725"><a href="#local-6989586621682423725"><span class="hs-identifier">linked_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">linkableModule</span><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">objs_loaded</span><span> </span><a href="#local-6989586621682423660"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">bcos_loaded</span><span> </span><a href="#local-6989586621682423660"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span>        </span><span class="hs-comment">-- 3.  For each dependent module, find its linkable</span><span>
</span><a name="line-659"></a><span>        </span><span class="hs-comment">--     This will either be in the HPT or (in the case of one-shot</span><span>
</span><a name="line-660"></a><span>        </span><span class="hs-comment">--     compilation) we may need to use maybe_getFileLinkable</span><span>
</span><a name="line-661"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682423726"><a href="#local-6989586621682423726"><span class="hs-identifier">osuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621682423664"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-662"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682423727"><a href="#local-6989586621682423727"><span class="hs-identifier">lnks_needed</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423670"><span class="hs-identifier hs-var">get_linkable</span></a><span> </span><a href="#local-6989586621682423726"><span class="hs-identifier hs-var">osuf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423723"><span class="hs-identifier hs-var">mods_needed</span></a><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423727"><span class="hs-identifier hs-var">lnks_needed</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423724"><span class="hs-identifier hs-var">pkgs_needed</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-665"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-666"></a><span>    </span><a name="local-6989586621682423664"><a href="#local-6989586621682423664"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423658"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-667"></a><span>    </span><a name="local-6989586621682423665"><a href="#local-6989586621682423665"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682423664"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>        </span><span class="hs-comment">-- The ModIface contains the transitive closure of the module dependencies</span><span>
</span><a name="line-670"></a><span>        </span><span class="hs-comment">-- within the current package, *except* for boot modules: if we encounter</span><span>
</span><a name="line-671"></a><span>        </span><span class="hs-comment">-- a boot module, we have to find its real interface and discover the</span><span>
</span><a name="line-672"></a><span>        </span><span class="hs-comment">-- dependencies of that.  Hence we need to traverse the dependency</span><span>
</span><a name="line-673"></a><span>        </span><span class="hs-comment">-- tree recursively.  See bug #936, testcase ghci/prog007.</span><span>
</span><a name="line-674"></a><span>    </span><span class="hs-identifier">follow_deps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- modules to follow</span><span>
</span><a name="line-675"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqDSet</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>         </span><span class="hs-comment">-- accum. module dependencies</span><span>
</span><a name="line-676"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqDSet</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span>          </span><span class="hs-comment">-- accum. package dependencies</span><span>
</span><a name="line-677"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- result</span><span>
</span><a name="line-678"></a><span>    </span><a name="local-6989586621682423666"><a href="#local-6989586621682423666"><span class="hs-identifier">follow_deps</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><a name="local-6989586621682423673"><a href="#local-6989586621682423673"><span class="hs-identifier">acc_mods</span></a></a><span> </span><a name="local-6989586621682423674"><a href="#local-6989586621682423674"><span class="hs-identifier">acc_pkgs</span></a></a><span>
</span><a name="line-679"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uniqDSetToList</span><span> </span><a href="#local-6989586621682423673"><span class="hs-identifier hs-var">acc_mods</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">uniqDSetToList</span><span> </span><a href="#local-6989586621682423674"><span class="hs-identifier hs-var">acc_pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-680"></a><span>    </span><span class="hs-identifier">follow_deps</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423675"><a href="#local-6989586621682423675"><span class="hs-identifier">mod</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682423676"><a href="#local-6989586621682423676"><span class="hs-identifier">mods</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682423677"><a href="#local-6989586621682423677"><span class="hs-identifier">acc_mods</span></a></a><span> </span><a name="local-6989586621682423678"><a href="#local-6989586621682423678"><span class="hs-identifier">acc_pkgs</span></a></a><span>
</span><a name="line-681"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-682"></a><span>          </span><a name="local-6989586621682423680"><a href="#local-6989586621682423680"><span class="hs-identifier">mb_iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initIfaceCheck"><span class="hs-identifier hs-var">initIfaceCheck</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;getLinkDeps&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423658"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-683"></a><span>                        </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><a href="#local-6989586621682423679"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621682423675"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportByUser</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>          </span><a name="local-6989586621682423683"><a href="#local-6989586621682423683"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423680"><span class="hs-identifier hs-var">mb_iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-685"></a><span>                    </span><span class="hs-identifier hs-var">Maybes.Failed</span><span> </span><a name="local-6989586621682423681"><a href="#local-6989586621682423681"><span class="hs-identifier">err</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621682423664"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423681"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>                    </span><span class="hs-identifier hs-var">Maybes.Succeeded</span><span> </span><a name="local-6989586621682423682"><a href="#local-6989586621682423682"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423682"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621682423683"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423667"><span class="hs-identifier hs-var">link_boot_mod_error</span></a><span> </span><a href="#local-6989586621682423675"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>          </span><span class="hs-keyword">let</span><span>
</span><a name="line-691"></a><span>            </span><a name="local-6989586621682423684"><a href="#local-6989586621682423684"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621682423675"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-692"></a><span>            </span><a name="local-6989586621682423685"><a href="#local-6989586621682423685"><span class="hs-identifier">deps</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682423683"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>            </span><a name="local-6989586621682423686"><a href="#local-6989586621682423686"><span class="hs-identifier">pkg_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><a href="#local-6989586621682423685"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-695"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682423687"><a href="#local-6989586621682423687"><span class="hs-identifier">boot_deps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423688"><a href="#local-6989586621682423688"><span class="hs-identifier">mod_deps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionWith</span><span> </span><a href="#local-6989586621682423692"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_mods</span><span> </span><a href="#local-6989586621682423685"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>                    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682423692"><a href="#local-6989586621682423692"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682423693"><a href="#local-6989586621682423693"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621682423693"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-697"></a><span>                          </span><span class="hs-identifier">is_boot</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423694"><a href="#local-6989586621682423694"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621682423694"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>            </span><a name="local-6989586621682423689"><a href="#local-6989586621682423689"><span class="hs-identifier">boot_deps'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqDSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682423677"><span class="hs-identifier hs-var">acc_mods</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423687"><span class="hs-identifier hs-var">boot_deps</span></a><span>
</span><a name="line-700"></a><span>            </span><a name="local-6989586621682423690"><a href="#local-6989586621682423690"><span class="hs-identifier">acc_mods'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addListToUniqDSet</span><span> </span><a href="#local-6989586621682423677"><span class="hs-identifier hs-var">acc_mods</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682423675"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682423688"><span class="hs-identifier hs-var">mod_deps</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>            </span><a name="local-6989586621682423691"><a href="#local-6989586621682423691"><span class="hs-identifier">acc_pkgs'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addListToUniqDSet</span><span> </span><a href="#local-6989586621682423678"><span class="hs-identifier hs-var">acc_pkgs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682423686"><span class="hs-identifier hs-var">pkg_deps</span></a><span>
</span><a name="line-702"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-703"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682423684"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682423665"><span class="hs-identifier hs-var">this_pkg</span></a><span>
</span><a name="line-704"></a><span>             </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682423666"><span class="hs-identifier hs-var">follow_deps</span></a><span> </span><a href="#local-6989586621682423676"><span class="hs-identifier hs-var">mods</span></a><span> </span><a href="#local-6989586621682423677"><span class="hs-identifier hs-var">acc_mods</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addOneToUniqDSet</span><span> </span><a href="#local-6989586621682423691"><span class="hs-identifier hs-var">acc_pkgs'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><a href="#local-6989586621682423684"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>             </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682423666"><span class="hs-identifier hs-var">follow_deps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModule</span><span> </span><a href="#local-6989586621682423665"><span class="hs-identifier hs-var">this_pkg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423689"><span class="hs-identifier hs-var">boot_deps'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423676"><span class="hs-identifier hs-var">mods</span></a><span class="hs-special">)</span><span>
</span><a name="line-706"></a><span>                              </span><a href="#local-6989586621682423690"><span class="hs-identifier hs-var">acc_mods'</span></a><span> </span><a href="#local-6989586621682423691"><span class="hs-identifier hs-var">acc_pkgs'</span></a><span>
</span><a name="line-707"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-708"></a><span>            </span><a name="local-6989586621682423679"><a href="#local-6989586621682423679"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;need to link module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682423675"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-709"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;due to use of Template Haskell&quot;</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>    </span><a name="local-6989586621682423667"><a href="#local-6989586621682423667"><span class="hs-identifier">link_boot_mod_error</span></a></a><span> </span><a name="local-6989586621682423695"><a href="#local-6989586621682423695"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-713"></a><span>        </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621682423664"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-714"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682423695"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-715"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cannot be linked; it is only available as a boot module&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span>    </span><span class="hs-identifier">no_obj</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682423671"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621682423671"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682423672"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-718"></a><span>    </span><a name="local-6989586621682423668"><a href="#local-6989586621682423668"><span class="hs-identifier">no_obj</span></a></a><span> </span><a name="local-6989586621682423696"><a href="#local-6989586621682423696"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#dieWith"><span class="hs-identifier hs-var">dieWith</span></a><span> </span><a href="#local-6989586621682423664"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423662"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-719"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cannot find object file for module &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-720"></a><span>                        </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682423696"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-721"></a><span>                     </span><a href="#local-6989586621682423669"><span class="hs-identifier hs-var">while_linking_expr</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>    </span><a name="local-6989586621682423669"><a href="#local-6989586621682423669"><span class="hs-identifier">while_linking_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;while linking an interpreted expression&quot;</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>        </span><span class="hs-comment">-- This one is a build-system bug</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span>    </span><a name="local-6989586621682423670"><a href="#local-6989586621682423670"><span class="hs-identifier">get_linkable</span></a></a><span> </span><a name="local-6989586621682423697"><a href="#local-6989586621682423697"><span class="hs-identifier">osuf</span></a></a><span> </span><a name="local-6989586621682423698"><a href="#local-6989586621682423698"><span class="hs-identifier">mod_name</span></a></a><span>      </span><span class="hs-comment">-- A home-package module</span><span>
</span><a name="line-728"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423717"><a href="#local-6989586621682423717"><span class="hs-identifier">mod_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621682423659"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621682423698"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-729"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423700"><span class="hs-identifier hs-var">adjust_linkable</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Maybes.expectJust</span><span> </span><span class="hs-string">&quot;getLinkDeps&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621682423717"><span class="hs-identifier hs-var">mod_info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-731"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>    </span><span class="hs-comment">-- It's not in the HPT because we are in one shot mode,</span><span>
</span><a name="line-732"></a><span>                </span><span class="hs-comment">-- so use the Finder to get a ModLocation...</span><span>
</span><a name="line-733"></a><span>             </span><a name="local-6989586621682423718"><a href="#local-6989586621682423718"><span class="hs-identifier">mb_stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Finder.html#findHomeModule"><span class="hs-identifier hs-var">findHomeModule</span></a><span> </span><a href="#local-6989586621682423658"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423698"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-734"></a><span>             </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423718"><span class="hs-identifier hs-var">mb_stuff</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-735"></a><span>                  </span><span class="hs-identifier hs-var">Found</span><span> </span><a name="local-6989586621682423719"><a href="#local-6989586621682423719"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682423720"><a href="#local-6989586621682423720"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423699"><span class="hs-identifier hs-var">found</span></a><span> </span><a href="#local-6989586621682423719"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682423720"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-736"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423668"><span class="hs-identifier hs-var">no_obj</span></a><span> </span><a href="#local-6989586621682423698"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-737"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-738"></a><span>            </span><a name="local-6989586621682423699"><a href="#local-6989586621682423699"><span class="hs-identifier">found</span></a></a><span> </span><a name="local-6989586621682423702"><a href="#local-6989586621682423702"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682423703"><a href="#local-6989586621682423703"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-739"></a><span>                </span><span class="hs-comment">-- ...and then find the linkable for it</span><span>
</span><a name="line-740"></a><span>               </span><a name="local-6989586621682423704"><a href="#local-6989586621682423704"><span class="hs-identifier">mb_lnk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Finder.html#findObjectLinkableMaybe"><span class="hs-identifier hs-var">findObjectLinkableMaybe</span></a><span> </span><a href="#local-6989586621682423703"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621682423702"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-741"></a><span>               </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423704"><span class="hs-identifier hs-var">mb_lnk</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-742"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423668"><span class="hs-identifier hs-var">no_obj</span></a><span> </span><a href="#local-6989586621682423703"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-743"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423705"><a href="#local-6989586621682423705"><span class="hs-identifier">lnk</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423700"><span class="hs-identifier hs-var">adjust_linkable</span></a><span> </span><a href="#local-6989586621682423705"><span class="hs-identifier hs-var">lnk</span></a><span>
</span><a name="line-744"></a><span>              </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>            </span><a name="local-6989586621682423700"><a href="#local-6989586621682423700"><span class="hs-identifier">adjust_linkable</span></a></a><span> </span><a name="local-6989586621682423706"><a href="#local-6989586621682423706"><span class="hs-identifier">lnk</span></a></a><span>
</span><a name="line-747"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423707"><a href="#local-6989586621682423707"><span class="hs-identifier">new_osuf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423661"><span class="hs-identifier hs-var">replace_osuf</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-748"></a><span>                        </span><a name="local-6989586621682423708"><a href="#local-6989586621682423708"><span class="hs-identifier">new_uls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423701"><span class="hs-identifier hs-var">adjust_ul</span></a><span> </span><a href="#local-6989586621682423707"><span class="hs-identifier hs-var">new_osuf</span></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621682423706"><span class="hs-identifier hs-var">lnk</span></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423706"><span class="hs-identifier hs-var">lnk</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span class="hs-glyph">=</span><a href="#local-6989586621682423708"><span class="hs-identifier hs-var">new_uls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-751"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-752"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423706"><span class="hs-identifier hs-var">lnk</span></a><span>
</span><a name="line-753"></a><span>
</span><a name="line-754"></a><span>            </span><a name="local-6989586621682423701"><a href="#local-6989586621682423701"><span class="hs-identifier">adjust_ul</span></a></a><span> </span><a name="local-6989586621682423709"><a href="#local-6989586621682423709"><span class="hs-identifier">new_osuf</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DotO</span><span> </span><a name="local-6989586621682423710"><a href="#local-6989586621682423710"><span class="hs-identifier">file</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-755"></a><span>                </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">osuf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isSuffixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">file</span><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423711"><a href="#local-6989586621682423711"><span class="hs-identifier">file_base</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stripExtension</span><span> </span><a href="#local-6989586621682423697"><span class="hs-identifier hs-var">osuf</span></a><span> </span><a href="#local-6989586621682423710"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>                    </span><a name="local-6989586621682423712"><a href="#local-6989586621682423712"><span class="hs-identifier">new_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423711"><span class="hs-identifier hs-var">file_base</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621682423709"><span class="hs-identifier hs-var">new_osuf</span></a><span>
</span><a name="line-758"></a><span>                </span><a name="local-6989586621682423713"><a href="#local-6989586621682423713"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621682423712"><span class="hs-identifier hs-var">new_file</span></a><span>
</span><a name="line-759"></a><span>                </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682423713"><span class="hs-identifier hs-var">ok</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><a href="Linker.html#dieWith"><span class="hs-identifier hs-var">dieWith</span></a><span> </span><a href="#local-6989586621682423664"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423662"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-761"></a><span>                          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cannot find object file &quot;</span><span>
</span><a name="line-762"></a><span>                                </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682423712"><span class="hs-identifier hs-var">new_file</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621682423669"><span class="hs-identifier hs-var">while_linking_expr</span></a><span>
</span><a name="line-763"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DotO</span><span> </span><a href="#local-6989586621682423712"><span class="hs-identifier hs-var">new_file</span></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>            </span><span class="hs-identifier">adjust_ul</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DotA</span><span> </span><a name="local-6989586621682423714"><a href="#local-6989586621682423714"><span class="hs-identifier">fp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;adjust_ul DotA &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621682423714"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>            </span><span class="hs-identifier">adjust_ul</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DotDLL</span><span> </span><a name="local-6989586621682423715"><a href="#local-6989586621682423715"><span class="hs-identifier">fp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;adjust_ul DotDLL &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621682423715"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>            </span><span class="hs-identifier">adjust_ul</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682423716"><a href="#local-6989586621682423716"><span class="hs-identifier">l</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">BCOs</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423716"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-767"></a><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span class="hs-comment">{- **********************************************************************

              Loading a Decls statement

  ********************************************************************* -}</span><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span class="hs-identifier">linkDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompiledByteCode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-777"></a><a name="linkDecls"><a href="Linker.html#linkDecls"><span class="hs-identifier">linkDecls</span></a></a><span> </span><a name="local-6989586621682423728"><a href="#local-6989586621682423728"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423729"><a href="#local-6989586621682423729"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621682423730"><a href="#local-6989586621682423730"><span class="hs-identifier">cbc</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">CompiledByteCode</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-778"></a><span>    </span><span class="hs-comment">-- Initialise the linker (if it's not been done already)</span><span>
</span><a name="line-779"></a><span>    </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423728"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span>    </span><span class="hs-comment">-- Take lock for the actual work.</span><span>
</span><a name="line-782"></a><span>    </span><a href="Linker.html#modifyPLS"><span class="hs-identifier hs-var">modifyPLS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423739"><a href="#local-6989586621682423739"><span class="hs-identifier">pls0</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span>    </span><span class="hs-comment">-- Link the packages and modules required</span><span>
</span><a name="line-785"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682423740"><a href="#local-6989586621682423740"><span class="hs-identifier">pls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423741"><a href="#local-6989586621682423741"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkDependencies"><span class="hs-identifier hs-var">linkDependencies</span></a><span> </span><a href="#local-6989586621682423728"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423739"><span class="hs-identifier hs-var">pls0</span></a><span> </span><a href="#local-6989586621682423729"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621682423737"><span class="hs-identifier hs-var">needed_mods</span></a><span>
</span><a name="line-786"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">failed</span><span> </span><a href="#local-6989586621682423741"><span class="hs-identifier hs-var">ok</span></a><span>
</span><a name="line-787"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-789"></a><span>
</span><a name="line-790"></a><span>    </span><span class="hs-comment">-- Link the expression itself</span><span>
</span><a name="line-791"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423742"><a href="#local-6989586621682423742"><span class="hs-identifier">ie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">itbl_env</span><span> </span><a href="#local-6989586621682423740"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423732"><span class="hs-identifier hs-var">bc_itbls</span></a><span>
</span><a name="line-792"></a><span>        </span><a name="local-6989586621682423743"><a href="#local-6989586621682423743"><span class="hs-identifier">ce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><a href="#local-6989586621682423740"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>    </span><span class="hs-comment">-- Link the necessary packages and linkables</span><span>
</span><a name="line-795"></a><span>    </span><a name="local-6989586621682423744"><a href="#local-6989586621682423744"><span class="hs-identifier">new_bindings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkSomeBCOs"><span class="hs-identifier hs-var">linkSomeBCOs</span></a><span> </span><a href="#local-6989586621682423728"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423742"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682423743"><span class="hs-identifier hs-var">ce</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423730"><span class="hs-identifier hs-var">cbc</span></a><span class="hs-special">]</span><span>
</span><a name="line-796"></a><span>    </span><a name="local-6989586621682423745"><a href="#local-6989586621682423745"><span class="hs-identifier">nms_fhvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#makeForeignNamedHValueRefs"><span class="hs-identifier hs-var">makeForeignNamedHValueRefs</span></a><span> </span><a href="#local-6989586621682423728"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423744"><span class="hs-identifier hs-var">new_bindings</span></a><span>
</span><a name="line-797"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423746"><a href="#local-6989586621682423746"><span class="hs-identifier">pls2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423740"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeLink.html#extendClosureEnv"><span class="hs-identifier hs-var">extendClosureEnv</span></a><span> </span><a href="#local-6989586621682423743"><span class="hs-identifier hs-var">ce</span></a><span> </span><a href="#local-6989586621682423745"><span class="hs-identifier hs-var">nms_fhvs</span></a><span>
</span><a name="line-798"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">itbl_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423742"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-799"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423746"><span class="hs-identifier hs-var">pls2</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-800"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-801"></a><span>    </span><a name="local-6989586621682423736"><a href="#local-6989586621682423736"><span class="hs-identifier">free_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uniqDSetToList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-802"></a><span>      </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unionUniqDSets</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeAsm.html#bcoFreeNames"><span class="hs-identifier hs-var">bcoFreeNames</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyUniqDSet</span><span> </span><a href="#local-6989586621682423731"><span class="hs-identifier hs-var">bc_bcos</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>    </span><span class="hs-identifier">needed_mods</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>
</span><a name="line-805"></a><span>    </span><a name="local-6989586621682423737"><a href="#local-6989586621682423737"><span class="hs-identifier">needed_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621682423738"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682423738"><a href="#local-6989586621682423738"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423736"><span class="hs-identifier hs-var">free_names</span></a><span class="hs-special">,</span><span>
</span><a name="line-806"></a><span>                    </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621682423738"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- Names from other modules</span><span>
</span><a name="line-807"></a><span>                    </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621682423738"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Exclude wired-in names</span><span>
</span><a name="line-808"></a><span>                  </span><span class="hs-special">]</span><span>                         </span><span class="hs-comment">-- (see note below)</span><span>
</span><a name="line-809"></a><span>    </span><span class="hs-comment">-- Exclude wired-in names because we may not have read</span><span>
</span><a name="line-810"></a><span>    </span><span class="hs-comment">-- their interface files, so getLinkDeps will fail</span><span>
</span><a name="line-811"></a><span>    </span><span class="hs-comment">-- All wired-in names are in the base package, which we link</span><span>
</span><a name="line-812"></a><span>    </span><span class="hs-comment">-- by default, so we can safely ignore them here.</span><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span class="hs-comment">{- **********************************************************************

              Loading a single module

  ********************************************************************* -}</span><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-identifier">linkModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-821"></a><a name="linkModule"><a href="Linker.html#linkModule"><span class="hs-identifier">linkModule</span></a></a><span> </span><a name="local-6989586621682423747"><a href="#local-6989586621682423747"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423748"><a href="#local-6989586621682423748"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-822"></a><span>  </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423747"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-823"></a><span>  </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423749"><a href="#local-6989586621682423749"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-824"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682423750"><a href="#local-6989586621682423750"><span class="hs-identifier">pls'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423751"><a href="#local-6989586621682423751"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkDependencies"><span class="hs-identifier hs-var">linkDependencies</span></a><span> </span><a href="#local-6989586621682423747"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423749"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423748"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">]</span><span>
</span><a name="line-825"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">failed</span><span> </span><a href="#local-6989586621682423751"><span class="hs-identifier hs-var">ok</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;could not link module&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423750"><span class="hs-identifier hs-var">pls'</span></a><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span class="hs-comment">{- **********************************************************************

                Link some linkables
        The linkables may consist of a mixture of
        byte-code modules and object modules

  ********************************************************************* -}</span><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span class="hs-identifier">linkModules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>
</span><a name="line-837"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">)</span><span>
</span><a name="line-838"></a><a name="linkModules"><a href="Linker.html#linkModules"><span class="hs-identifier">linkModules</span></a></a><span> </span><a name="local-6989586621682423752"><a href="#local-6989586621682423752"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423753"><a href="#local-6989586621682423753"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423754"><a href="#local-6989586621682423754"><span class="hs-identifier">linkables</span></a></a><span>
</span><a name="line-839"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mask_</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- don't want to be interrupted by ^C in here</span><span>
</span><a name="line-840"></a><span>
</span><a name="line-841"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423755"><a href="#local-6989586621682423755"><span class="hs-identifier">objs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423756"><a href="#local-6989586621682423756"><span class="hs-identifier">bcos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-identifier hs-var">isObjectLinkable</span><span>
</span><a name="line-842"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="Linker.html#partitionLinkable"><span class="hs-identifier hs-var">partitionLinkable</span></a><span> </span><a href="#local-6989586621682423754"><span class="hs-identifier hs-var">linkables</span></a><span class="hs-special">)</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span>                </span><span class="hs-comment">-- Load objects first; they can't depend on BCOs</span><span>
</span><a name="line-845"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682423757"><a href="#local-6989586621682423757"><span class="hs-identifier">pls1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423758"><a href="#local-6989586621682423758"><span class="hs-identifier">ok_flag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#dynLinkObjs"><span class="hs-identifier hs-var">dynLinkObjs</span></a><span> </span><a href="#local-6989586621682423752"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423753"><span class="hs-identifier hs-var">pls</span></a><span> </span><a href="#local-6989586621682423755"><span class="hs-identifier hs-var">objs</span></a><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">failed</span><span> </span><a href="#local-6989586621682423758"><span class="hs-identifier hs-var">ok_flag</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-848"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423757"><span class="hs-identifier hs-var">pls1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Failed</span><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-850"></a><span>                </span><a name="local-6989586621682423759"><a href="#local-6989586621682423759"><span class="hs-identifier">pls2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#dynLinkBCOs"><span class="hs-identifier hs-var">dynLinkBCOs</span></a><span> </span><a href="#local-6989586621682423752"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423757"><span class="hs-identifier hs-var">pls1</span></a><span> </span><a href="#local-6989586621682423756"><span class="hs-identifier hs-var">bcos</span></a><span>
</span><a name="line-851"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423759"><span class="hs-identifier hs-var">pls2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span class="hs-comment">-- HACK to support f-x-dynamic in the interpreter; no other purpose</span><span>
</span><a name="line-855"></a><span class="hs-identifier">partitionLinkable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>
</span><a name="line-856"></a><a name="partitionLinkable"><a href="Linker.html#partitionLinkable"><span class="hs-identifier">partitionLinkable</span></a></a><span> </span><a name="local-6989586621682423760"><a href="#local-6989586621682423760"><span class="hs-identifier">li</span></a></a><span>
</span><a name="line-857"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423761"><a href="#local-6989586621682423761"><span class="hs-identifier">li_uls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621682423760"><span class="hs-identifier hs-var">li</span></a><span>
</span><a name="line-858"></a><span>         </span><a name="local-6989586621682423762"><a href="#local-6989586621682423762"><span class="hs-identifier">li_uls_obj</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isObject</span><span> </span><a href="#local-6989586621682423761"><span class="hs-identifier hs-var">li_uls</span></a><span>
</span><a name="line-859"></a><span>         </span><a name="local-6989586621682423763"><a href="#local-6989586621682423763"><span class="hs-identifier">li_uls_bco</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isInterpretable</span><span> </span><a href="#local-6989586621682423761"><span class="hs-identifier hs-var">li_uls</span></a><span>
</span><a name="line-860"></a><span>     </span><span class="hs-keyword">in</span><span>
</span><a name="line-861"></a><span>         </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423762"><span class="hs-identifier hs-var">li_uls_obj</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423763"><span class="hs-identifier hs-var">li_uls_bco</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-862"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423760"><span class="hs-identifier hs-var">li</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">linkableUnlinked</span><span class="hs-glyph">=</span><a href="#local-6989586621682423762"><span class="hs-identifier hs-var">li_uls_obj</span></a><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-863"></a><span>                           </span><a href="#local-6989586621682423760"><span class="hs-identifier hs-var">li</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">linkableUnlinked</span><span class="hs-glyph">=</span><a href="#local-6989586621682423763"><span class="hs-identifier hs-var">li_uls_bco</span></a><span class="hs-special">}</span><span class="hs-special">]</span><span>
</span><a name="line-864"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423760"><span class="hs-identifier hs-var">li</span></a><span class="hs-special">]</span><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span class="hs-identifier">findModuleLinkable_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span>
</span><a name="line-867"></a><a name="findModuleLinkable_maybe"><a href="Linker.html#findModuleLinkable_maybe"><span class="hs-identifier">findModuleLinkable_maybe</span></a></a><span> </span><a name="local-6989586621682423764"><a href="#local-6989586621682423764"><span class="hs-identifier">lis</span></a></a><span> </span><a name="local-6989586621682423765"><a href="#local-6989586621682423765"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-868"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">LM</span><span> </span><a href="#local-6989586621682423766"><span class="hs-identifier hs-var">time</span></a><span> </span><a href="#local-6989586621682423767"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621682423768"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">LM</span><span> </span><a name="local-6989586621682423766"><a href="#local-6989586621682423766"><span class="hs-identifier">time</span></a></a><span> </span><a name="local-6989586621682423767"><a href="#local-6989586621682423767"><span class="hs-identifier">nm</span></a></a><span> </span><a name="local-6989586621682423768"><a href="#local-6989586621682423768"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423764"><span class="hs-identifier hs-var">lis</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423767"><span class="hs-identifier hs-var">nm</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682423765"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-869"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-870"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621682423769"><a href="#local-6989586621682423769"><span class="hs-identifier">li</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682423769"><span class="hs-identifier hs-var">li</span></a><span>
</span><a name="line-871"></a><span>        </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;findModuleLinkable&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682423765"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span class="hs-identifier">linkableInSet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-874"></a><a name="linkableInSet"><a href="Linker.html#linkableInSet"><span class="hs-identifier">linkableInSet</span></a></a><span> </span><a name="local-6989586621682423770"><a href="#local-6989586621682423770"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682423771"><a href="#local-6989586621682423771"><span class="hs-identifier">objs_loaded</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-875"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Linker.html#findModuleLinkable_maybe"><span class="hs-identifier hs-var">findModuleLinkable_maybe</span></a><span> </span><a href="#local-6989586621682423771"><span class="hs-identifier hs-var">objs_loaded</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">linkableModule</span><span> </span><a href="#local-6989586621682423770"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-876"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-877"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423772"><a href="#local-6989586621682423772"><span class="hs-identifier">m</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621682423770"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621682423772"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span class="hs-comment">{- **********************************************************************

                The object-code linker

  ********************************************************************* -}</span><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><span class="hs-identifier">dynLinkObjs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>
</span><a name="line-887"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">)</span><span>
</span><a name="line-888"></a><a name="dynLinkObjs"><a href="Linker.html#dynLinkObjs"><span class="hs-identifier">dynLinkObjs</span></a></a><span> </span><a name="local-6989586621682423773"><a href="#local-6989586621682423773"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423774"><a href="#local-6989586621682423774"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423775"><a href="#local-6989586621682423775"><span class="hs-identifier">objs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-889"></a><span>        </span><span class="hs-comment">-- Load the object files and link them</span><span>
</span><a name="line-890"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423776"><a href="#local-6989586621682423776"><span class="hs-identifier">objs_loaded'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423777"><a href="#local-6989586621682423777"><span class="hs-identifier">new_objs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#rmDupLinkables"><span class="hs-identifier hs-var">rmDupLinkables</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">objs_loaded</span><span> </span><a href="#local-6989586621682423774"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423775"><span class="hs-identifier hs-var">objs</span></a><span>
</span><a name="line-891"></a><span>            </span><a name="local-6989586621682423778"><a href="#local-6989586621682423778"><span class="hs-identifier">pls1</span></a></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423774"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">objs_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423776"><span class="hs-identifier hs-var">objs_loaded'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-892"></a><span>            </span><a name="local-6989586621682423779"><a href="#local-6989586621682423779"><span class="hs-identifier">unlinkeds</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621682423777"><span class="hs-identifier hs-var">new_objs</span></a><span>
</span><a name="line-893"></a><span>            </span><a name="local-6989586621682423780"><a href="#local-6989586621682423780"><span class="hs-identifier">wanted_objs</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nameOfObject</span><span> </span><a href="#local-6989586621682423779"><span class="hs-identifier hs-var">unlinkeds</span></a><span>
</span><a name="line-894"></a><span>
</span><a name="line-895"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">interpreterDynamic</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423773"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-896"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682423781"><a href="#local-6989586621682423781"><span class="hs-identifier">pls2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#dynLoadObjs"><span class="hs-identifier hs-var">dynLoadObjs</span></a><span> </span><a href="#local-6989586621682423773"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423778"><span class="hs-identifier hs-var">pls1</span></a><span> </span><a href="#local-6989586621682423780"><span class="hs-identifier hs-var">wanted_objs</span></a><span>
</span><a name="line-897"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423781"><span class="hs-identifier hs-var">pls2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span> </span><a href="#local-6989586621682423773"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423780"><span class="hs-identifier hs-var">wanted_objs</span></a><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span>                    </span><span class="hs-comment">-- Link them all together</span><span>
</span><a name="line-901"></a><span>                    </span><a name="local-6989586621682423782"><a href="#local-6989586621682423782"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#resolveObjs"><span class="hs-identifier hs-var">resolveObjs</span></a><span> </span><a href="#local-6989586621682423773"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-902"></a><span>
</span><a name="line-903"></a><span>                    </span><span class="hs-comment">-- If resolving failed, unload all our</span><span>
</span><a name="line-904"></a><span>                    </span><span class="hs-comment">-- object modules and carry on</span><span>
</span><a name="line-905"></a><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">succeeded</span><span> </span><a href="#local-6989586621682423782"><span class="hs-identifier hs-var">ok</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-906"></a><span>                            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423778"><span class="hs-identifier hs-var">pls1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span class="hs-special">)</span><span>
</span><a name="line-907"></a><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-908"></a><span>                            </span><a name="local-6989586621682423783"><a href="#local-6989586621682423783"><span class="hs-identifier">pls2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#unload_wkr"><span class="hs-identifier hs-var">unload_wkr</span></a><span> </span><a href="#local-6989586621682423773"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682423778"><span class="hs-identifier hs-var">pls1</span></a><span>
</span><a name="line-909"></a><span>                            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423783"><span class="hs-identifier hs-var">pls2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Failed</span><span class="hs-special">)</span><span>
</span><a name="line-910"></a><span>
</span><a name="line-911"></a><span>
</span><a name="line-912"></a><span class="hs-identifier">dynLoadObjs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-913"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-914"></a><a name="dynLoadObjs"><a href="Linker.html#dynLoadObjs"><span class="hs-identifier">dynLoadObjs</span></a></a><span> </span><span class="hs-identifier">_</span><span>       </span><a name="local-6989586621682423784"><a href="#local-6989586621682423784"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423784"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-915"></a><span class="hs-identifier">dynLoadObjs</span><span> </span><a name="local-6989586621682423785"><a href="#local-6989586621682423785"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423786"><a href="#local-6989586621682423786"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423787"><a href="#local-6989586621682423787"><span class="hs-identifier">objs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-916"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423788"><a href="#local-6989586621682423788"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423785"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-917"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423789"><a href="#local-6989586621682423789"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423788"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-918"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423790"><a href="#local-6989586621682423790"><span class="hs-identifier">minus_ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423791"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><span class="hs-char">'l'</span><span class="hs-glyph">:</span><a name="local-6989586621682423791"><a href="#local-6989586621682423791"><span class="hs-identifier">lib</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621682423788"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-919"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423792"><a href="#local-6989586621682423792"><span class="hs-identifier">minus_big_ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423793"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><span class="hs-char">'L'</span><span class="hs-glyph">:</span><a name="local-6989586621682423793"><a href="#local-6989586621682423793"><span class="hs-identifier">lib</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621682423788"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-920"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682423794"><a href="#local-6989586621682423794"><span class="hs-identifier">soFile</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423795"><a href="#local-6989586621682423795"><span class="hs-identifier">libPath</span></a></a><span> </span><span class="hs-special">,</span><span> </span><a name="local-6989586621682423796"><a href="#local-6989586621682423796"><span class="hs-identifier">libName</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-921"></a><span>      </span><span class="hs-identifier hs-var">newTempLibName</span><span> </span><a href="#local-6989586621682423788"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">soExt</span><span> </span><a href="#local-6989586621682423789"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-923"></a><span>        </span><a name="local-6989586621682423797"><a href="#local-6989586621682423797"><span class="hs-identifier">dflags2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423788"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-924"></a><span>                      </span><span class="hs-comment">-- We don't want the original ldInputs in</span><span>
</span><a name="line-925"></a><span>                      </span><span class="hs-comment">-- (they're already linked in), but we do want</span><span>
</span><a name="line-926"></a><span>                      </span><span class="hs-comment">-- to link against previous dynLoadObjs</span><span>
</span><a name="line-927"></a><span>                      </span><span class="hs-comment">-- libraries if there were any, so that the linker</span><span>
</span><a name="line-928"></a><span>                      </span><span class="hs-comment">-- can resolve dependencies when it loads this</span><span>
</span><a name="line-929"></a><span>                      </span><span class="hs-comment">-- library.</span><span>
</span><a name="line-930"></a><span>                      </span><span class="hs-identifier">ldInputs</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-931"></a><span>                           </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682423798"><a href="#local-6989586621682423798"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-l&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423798"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-932"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">temp_sos</span><span> </span><a href="#local-6989586621682423786"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>                        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682423799"><a href="#local-6989586621682423799"><span class="hs-identifier">lp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423799"><span class="hs-identifier hs-var">lp</span></a><span class="hs-special">)</span><span>
</span><a name="line-934"></a><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span>
</span><a name="line-935"></a><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-rpath&quot;</span><span>
</span><a name="line-936"></a><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span>
</span><a name="line-937"></a><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621682423799"><span class="hs-identifier hs-var">lp</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-938"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">temp_sos</span><span> </span><a href="#local-6989586621682423786"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>                        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span>
</span><a name="line-940"></a><span>                             </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682423800"><a href="#local-6989586621682423800"><span class="hs-identifier">lp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-941"></a><span>                                 </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423800"><span class="hs-identifier hs-var">lp</span></a><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span>
</span><a name="line-943"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-rpath&quot;</span><span>
</span><a name="line-944"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span>
</span><a name="line-945"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621682423800"><span class="hs-identifier hs-var">lp</span></a><span>
</span><a name="line-946"></a><span>                                 </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-947"></a><span>                             </span><a href="#local-6989586621682423792"><span class="hs-identifier hs-var">minus_big_ls</span></a><span>
</span><a name="line-948"></a><span>                        </span><span class="hs-comment">-- See Note [-Xlinker -rpath vs -Wl,-rpath]</span><span>
</span><a name="line-949"></a><span>                        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682423801"><a href="#local-6989586621682423801"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-l&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423801"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423790"><span class="hs-identifier hs-var">minus_ls</span></a><span class="hs-special">,</span><span>
</span><a name="line-950"></a><span>                      </span><span class="hs-comment">-- Add -l options and -L options from dflags.</span><span>
</span><a name="line-951"></a><span>                      </span><span class="hs-comment">--</span><span>
</span><a name="line-952"></a><span>                      </span><span class="hs-comment">-- When running TH for a non-dynamic way, we still</span><span>
</span><a name="line-953"></a><span>                      </span><span class="hs-comment">-- need to make -l flags to link against the dynamic</span><span>
</span><a name="line-954"></a><span>                      </span><span class="hs-comment">-- libraries, so we need to add WayDyn to ways.</span><span>
</span><a name="line-955"></a><span>                      </span><span class="hs-comment">--</span><span>
</span><a name="line-956"></a><span>                      </span><span class="hs-comment">-- Even if we're e.g. profiling, we still want</span><span>
</span><a name="line-957"></a><span>                      </span><span class="hs-comment">-- the vanilla dynamic libraries, so we set the</span><span>
</span><a name="line-958"></a><span>                      </span><span class="hs-comment">-- ways / build tag to be just WayDyn.</span><span>
</span><a name="line-959"></a><span>                      </span><span class="hs-identifier">ways</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">WayDyn</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-960"></a><span>                      </span><span class="hs-identifier">buildTag</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBuildTag</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">WayDyn</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-961"></a><span>                      </span><span class="hs-identifier">outputFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682423794"><span class="hs-identifier hs-var">soFile</span></a><span>
</span><a name="line-962"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-963"></a><span>    </span><span class="hs-comment">-- link all &quot;loaded packages&quot; so symbols in those can be resolved</span><span>
</span><a name="line-964"></a><span>    </span><span class="hs-comment">-- Note: We are loading packages with local scope, so to see the</span><span>
</span><a name="line-965"></a><span>    </span><span class="hs-comment">-- symbols in this link we must link all loaded packages again.</span><span>
</span><a name="line-966"></a><span>    </span><a href="SysTools.html#linkDynLib"><span class="hs-identifier hs-var">linkDynLib</span></a><span> </span><a href="#local-6989586621682423797"><span class="hs-identifier hs-var">dflags2</span></a><span> </span><a href="#local-6989586621682423787"><span class="hs-identifier hs-var">objs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgs_loaded</span><span> </span><a href="#local-6989586621682423786"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span>    </span><span class="hs-comment">-- if we got this far, extend the lifetime of the library file</span><span>
</span><a name="line-969"></a><span>    </span><span class="hs-identifier hs-var">changeTempFilesLifetime</span><span> </span><a href="#local-6989586621682423788"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423794"><span class="hs-identifier hs-var">soFile</span></a><span class="hs-special">]</span><span>
</span><a name="line-970"></a><span>    </span><a name="local-6989586621682423802"><a href="#local-6989586621682423802"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621682423785"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423794"><span class="hs-identifier hs-var">soFile</span></a><span>
</span><a name="line-971"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423802"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-972"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423786"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">temp_sos</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423795"><span class="hs-identifier hs-var">libPath</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423796"><span class="hs-identifier hs-var">libName</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">temp_sos</span><span> </span><a href="#local-6989586621682423786"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-973"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423803"><a href="#local-6989586621682423803"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Loading temp shared object failed: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423803"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span class="hs-identifier">rmDupLinkables</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Already loaded</span><span>
</span><a name="line-976"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- New linkables</span><span>
</span><a name="line-977"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- New loaded set (including new ones)</span><span>
</span><a name="line-978"></a><span>                   </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- New linkables (excluding dups)</span><span>
</span><a name="line-979"></a><a name="rmDupLinkables"><a href="Linker.html#rmDupLinkables"><span class="hs-identifier">rmDupLinkables</span></a></a><span> </span><a name="local-6989586621682423804"><a href="#local-6989586621682423804"><span class="hs-identifier">already</span></a></a><span> </span><a name="local-6989586621682423805"><a href="#local-6989586621682423805"><span class="hs-identifier">ls</span></a></a><span>
</span><a name="line-980"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423806"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682423804"><span class="hs-identifier hs-var">already</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682423805"><span class="hs-identifier hs-var">ls</span></a><span>
</span><a name="line-981"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-982"></a><span>    </span><a name="local-6989586621682423806"><a href="#local-6989586621682423806"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682423807"><a href="#local-6989586621682423807"><span class="hs-identifier">already</span></a></a><span> </span><a name="local-6989586621682423808"><a href="#local-6989586621682423808"><span class="hs-identifier">extras</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423807"><span class="hs-identifier hs-var">already</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423808"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682423809"><a href="#local-6989586621682423809"><span class="hs-identifier">already</span></a></a><span> </span><a name="local-6989586621682423810"><a href="#local-6989586621682423810"><span class="hs-identifier">extras</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682423811"><a href="#local-6989586621682423811"><span class="hs-identifier">l</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682423812"><a href="#local-6989586621682423812"><span class="hs-identifier">ls</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Linker.html#linkableInSet"><span class="hs-identifier hs-var">linkableInSet</span></a><span> </span><a href="#local-6989586621682423811"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682423809"><span class="hs-identifier hs-var">already</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423806"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682423809"><span class="hs-identifier hs-var">already</span></a><span>     </span><a href="#local-6989586621682423810"><span class="hs-identifier hs-var">extras</span></a><span>     </span><a href="#local-6989586621682423812"><span class="hs-identifier hs-var">ls</span></a><span>
</span><a name="line-985"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423806"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423811"><span class="hs-identifier hs-var">l</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682423809"><span class="hs-identifier hs-var">already</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423811"><span class="hs-identifier hs-var">l</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682423810"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423812"><span class="hs-identifier hs-var">ls</span></a><span>
</span><a name="line-986"></a><span>
</span><a name="line-987"></a><span class="hs-comment">{- **********************************************************************

                The byte-code linker

  ********************************************************************* -}</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span>
</span><a name="line-994"></a><span class="hs-identifier">dynLinkBCOs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>
</span><a name="line-995"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-996"></a><a name="dynLinkBCOs"><a href="Linker.html#dynLinkBCOs"><span class="hs-identifier">dynLinkBCOs</span></a></a><span> </span><a name="local-6989586621682423813"><a href="#local-6989586621682423813"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423814"><a href="#local-6989586621682423814"><span class="hs-identifier">pls</span></a></a><span> </span><a name="local-6989586621682423815"><a href="#local-6989586621682423815"><span class="hs-identifier">bcos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-997"></a><span>
</span><a name="line-998"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423816"><a href="#local-6989586621682423816"><span class="hs-identifier">bcos_loaded'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423817"><a href="#local-6989586621682423817"><span class="hs-identifier">new_bcos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#rmDupLinkables"><span class="hs-identifier hs-var">rmDupLinkables</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">bcos_loaded</span><span> </span><a href="#local-6989586621682423814"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423815"><span class="hs-identifier hs-var">bcos</span></a><span>
</span><a name="line-999"></a><span>            </span><a name="local-6989586621682423818"><a href="#local-6989586621682423818"><span class="hs-identifier">pls1</span></a></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423814"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bcos_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423816"><span class="hs-identifier hs-var">bcos_loaded'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1000"></a><span>            </span><span class="hs-identifier">unlinkeds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Unlinked</span><span class="hs-special">]</span><span>
</span><a name="line-1001"></a><span>            </span><a name="local-6989586621682423819"><a href="#local-6989586621682423819"><span class="hs-identifier">unlinkeds</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621682423817"><span class="hs-identifier hs-var">new_bcos</span></a><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>            </span><span class="hs-identifier">cbcs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CompiledByteCode</span><span class="hs-special">]</span><span>
</span><a name="line-1004"></a><span>            </span><a name="local-6989586621682423820"><a href="#local-6989586621682423820"><span class="hs-identifier">cbcs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">byteCodeOfObject</span><span> </span><a href="#local-6989586621682423819"><span class="hs-identifier hs-var">unlinkeds</span></a><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><span>            </span><a name="local-6989586621682423821"><a href="#local-6989586621682423821"><span class="hs-identifier">ies</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">bc_itbls</span><span> </span><a href="#local-6989586621682423820"><span class="hs-identifier hs-var">cbcs</span></a><span>
</span><a name="line-1008"></a><span>            </span><a name="local-6989586621682423822"><a href="#local-6989586621682423822"><span class="hs-identifier">gce</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><a href="#local-6989586621682423814"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-1009"></a><span>            </span><a name="local-6989586621682423823"><a href="#local-6989586621682423823"><span class="hs-identifier">final_ie</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">plusNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">itbl_env</span><span> </span><a href="#local-6989586621682423814"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423821"><span class="hs-identifier hs-var">ies</span></a><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span>        </span><a name="local-6989586621682423824"><a href="#local-6989586621682423824"><span class="hs-identifier">names_and_refs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkSomeBCOs"><span class="hs-identifier hs-var">linkSomeBCOs</span></a><span> </span><a href="#local-6989586621682423813"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423823"><span class="hs-identifier hs-var">final_ie</span></a><span> </span><a href="#local-6989586621682423822"><span class="hs-identifier hs-var">gce</span></a><span> </span><a href="#local-6989586621682423820"><span class="hs-identifier hs-var">cbcs</span></a><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span>        </span><span class="hs-comment">-- We only want to add the external ones to the ClosureEnv</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423825"><a href="#local-6989586621682423825"><span class="hs-identifier">to_add</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423826"><a href="#local-6989586621682423826"><span class="hs-identifier">to_drop</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423824"><span class="hs-identifier hs-var">names_and_refs</span></a><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span>        </span><span class="hs-comment">-- Immediately release any HValueRefs we're not going to add</span><span>
</span><a name="line-1017"></a><span>        </span><a href="GHCi.html#freeHValueRefs"><span class="hs-identifier hs-var">freeHValueRefs</span></a><span> </span><a href="#local-6989586621682423813"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621682423826"><span class="hs-identifier hs-var">to_drop</span></a><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>        </span><span class="hs-comment">-- Wrap finalizers on the ones we want to keep</span><span>
</span><a name="line-1019"></a><span>        </span><a name="local-6989586621682423827"><a href="#local-6989586621682423827"><span class="hs-identifier">new_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#makeForeignNamedHValueRefs"><span class="hs-identifier hs-var">makeForeignNamedHValueRefs</span></a><span> </span><a href="#local-6989586621682423813"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423825"><span class="hs-identifier hs-var">to_add</span></a><span>
</span><a name="line-1020"></a><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423818"><span class="hs-identifier hs-var">pls1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeLink.html#extendClosureEnv"><span class="hs-identifier hs-var">extendClosureEnv</span></a><span> </span><a href="#local-6989586621682423822"><span class="hs-identifier hs-var">gce</span></a><span> </span><a href="#local-6989586621682423827"><span class="hs-identifier hs-var">new_binds</span></a><span class="hs-special">,</span><span>
</span><a name="line-1022"></a><span>                      </span><span class="hs-identifier">itbl_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423823"><span class="hs-identifier hs-var">final_ie</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1023"></a><span>
</span><a name="line-1024"></a><span class="hs-comment">-- Link a bunch of BCOs and return references to their values</span><span>
</span><a name="line-1025"></a><span class="hs-identifier">linkSomeBCOs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1026"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ItblEnv</span><span>
</span><a name="line-1027"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeLink.html#ClosureEnv"><span class="hs-identifier hs-type">ClosureEnv</span></a><span>
</span><a name="line-1028"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CompiledByteCode</span><span class="hs-special">]</span><span>
</span><a name="line-1029"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1030"></a><span>                        </span><span class="hs-comment">-- The returned HValueRefs are associated 1-1 with</span><span>
</span><a name="line-1031"></a><span>                        </span><span class="hs-comment">-- the incoming unlinked BCOs.  Each gives the</span><span>
</span><a name="line-1032"></a><span>                        </span><span class="hs-comment">-- value of the corresponding unlinked BCO</span><span>
</span><a name="line-1033"></a><span>
</span><a name="line-1034"></a><a name="linkSomeBCOs"><a href="Linker.html#linkSomeBCOs"><span class="hs-identifier">linkSomeBCOs</span></a></a><span> </span><a name="local-6989586621682423828"><a href="#local-6989586621682423828"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423829"><a href="#local-6989586621682423829"><span class="hs-identifier">ie</span></a></a><span> </span><a name="local-6989586621682423830"><a href="#local-6989586621682423830"><span class="hs-identifier">ce</span></a></a><span> </span><a name="local-6989586621682423831"><a href="#local-6989586621682423831"><span class="hs-identifier">mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682423832"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621682423833"><span class="hs-identifier hs-var">do_link</span></a><span> </span><a href="#local-6989586621682423831"><span class="hs-identifier hs-var">mods</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1035"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1036"></a><span>  </span><a name="local-6989586621682423832"><a href="#local-6989586621682423832"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-identifier hs-var">CompiledByteCode</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621682423839"><a href="#local-6989586621682423839"><span class="hs-identifier">inner</span></a></a><span> </span><a name="local-6989586621682423840"><a href="#local-6989586621682423840"><span class="hs-identifier">accum</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1037"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423838"><span class="hs-identifier hs-var">bc_breaks</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1038"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423839"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linkSomeBCOs: no break array&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423834"><span class="hs-identifier hs-var">bc_bcos</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682423840"><span class="hs-identifier hs-var">accum</span></a><span class="hs-special">)</span><span>
</span><a name="line-1039"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423841"><a href="#local-6989586621682423841"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">modBreaks_flags</span><span> </span><a href="#local-6989586621682423841"><span class="hs-identifier hs-var">mb</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423842"><a href="#local-6989586621682423842"><span class="hs-identifier">breakarray</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1040"></a><span>                   </span><a href="#local-6989586621682423839"><span class="hs-identifier hs-var">inner</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682423842"><span class="hs-identifier hs-var">breakarray</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423834"><span class="hs-identifier hs-var">bc_bcos</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682423840"><span class="hs-identifier hs-var">accum</span></a><span class="hs-special">)</span><span>
</span><a name="line-1041"></a><span>
</span><a name="line-1042"></a><span>  </span><a name="local-6989586621682423833"><a href="#local-6989586621682423833"><span class="hs-identifier">do_link</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1043"></a><span>  </span><span class="hs-identifier">do_link</span><span> </span><a name="local-6989586621682423843"><a href="#local-6989586621682423843"><span class="hs-identifier">mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1044"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423844"><a href="#local-6989586621682423844"><span class="hs-identifier">flat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423847"><span class="hs-identifier hs-var">breakarray</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423849"><span class="hs-identifier hs-var">bco</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423847"><a href="#local-6989586621682423847"><span class="hs-identifier">breakarray</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423848"><a href="#local-6989586621682423848"><span class="hs-identifier">bcos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423843"><span class="hs-identifier hs-var">mods</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423849"><a href="#local-6989586621682423849"><span class="hs-identifier">bco</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423848"><span class="hs-identifier hs-var">bcos</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1045"></a><span>        </span><a name="local-6989586621682423845"><a href="#local-6989586621682423845"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unlinkedBCOName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423844"><span class="hs-identifier hs-var">flat</span></a><span>
</span><a name="line-1046"></a><span>        </span><a name="local-6989586621682423846"><a href="#local-6989586621682423846"><span class="hs-identifier">bco_ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621682423845"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1047"></a><span>    </span><a name="local-6989586621682423852"><a href="#local-6989586621682423852"><span class="hs-identifier">resolved</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><span> </span><a href="ByteCodeLink.html#linkBCO"><span class="hs-identifier hs-var">linkBCO</span></a><span> </span><a href="#local-6989586621682423828"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423829"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682423830"><span class="hs-identifier hs-var">ce</span></a><span> </span><a href="#local-6989586621682423846"><span class="hs-identifier hs-var">bco_ix</span></a><span> </span><a href="#local-6989586621682423850"><span class="hs-identifier hs-var">breakarray</span></a><span> </span><a href="#local-6989586621682423851"><span class="hs-identifier hs-var">bco</span></a><span>
</span><a name="line-1048"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423850"><a href="#local-6989586621682423850"><span class="hs-identifier">breakarray</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423851"><a href="#local-6989586621682423851"><span class="hs-identifier">bco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423844"><span class="hs-identifier hs-var">flat</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1049"></a><span>    </span><a name="local-6989586621682423853"><a href="#local-6989586621682423853"><span class="hs-identifier">hvrefs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#createBCOs"><span class="hs-identifier hs-var">createBCOs</span></a><span> </span><a href="#local-6989586621682423828"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423852"><span class="hs-identifier hs-var">resolved</span></a><span>
</span><a name="line-1050"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621682423845"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621682423853"><span class="hs-identifier hs-var">hvrefs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>
</span><a name="line-1052"></a><span class="hs-comment">-- | Useful to apply to the result of 'linkSomeBCOs'</span><span>
</span><a name="line-1053"></a><span class="hs-identifier">makeForeignNamedHValueRefs</span><span>
</span><a name="line-1054"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1055"></a><a name="makeForeignNamedHValueRefs"><a href="Linker.html#makeForeignNamedHValueRefs"><span class="hs-identifier">makeForeignNamedHValueRefs</span></a></a><span> </span><a name="local-6989586621682423854"><a href="#local-6989586621682423854"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423855"><a href="#local-6989586621682423855"><span class="hs-identifier">bindings</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1056"></a><span>  </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682423856"><a href="#local-6989586621682423856"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423857"><a href="#local-6989586621682423857"><span class="hs-identifier">hvref</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423856"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621682423854"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423857"><span class="hs-identifier hs-var">hvref</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423855"><span class="hs-identifier hs-var">bindings</span></a><span>
</span><a name="line-1057"></a><span>
</span><a name="line-1058"></a><span class="hs-comment">{- **********************************************************************

                Unload some object modules

  ********************************************************************* -}</span><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1065"></a><span class="hs-comment">-- | Unloading old objects ready for a new compilation sweep.</span><span>
</span><a name="line-1066"></a><span class="hs-comment">--</span><span>
</span><a name="line-1067"></a><span class="hs-comment">-- The compilation manager provides us with a list of linkables that it</span><span>
</span><a name="line-1068"></a><span class="hs-comment">-- considers \&quot;stable\&quot;, i.e. won't be recompiled this time around.  For</span><span>
</span><a name="line-1069"></a><span class="hs-comment">-- each of the modules current linked in memory,</span><span>
</span><a name="line-1070"></a><span class="hs-comment">--</span><span>
</span><a name="line-1071"></a><span class="hs-comment">--   * if the linkable is stable (and it's the same one -- the user may have</span><span>
</span><a name="line-1072"></a><span class="hs-comment">--     recompiled the module on the side), we keep it,</span><span>
</span><a name="line-1073"></a><span class="hs-comment">--</span><span>
</span><a name="line-1074"></a><span class="hs-comment">--   * otherwise, we unload it.</span><span>
</span><a name="line-1075"></a><span class="hs-comment">--</span><span>
</span><a name="line-1076"></a><span class="hs-comment">--   * we also implicitly unload all temporary bindings at this point.</span><span>
</span><a name="line-1077"></a><span class="hs-comment">--</span><span>
</span><a name="line-1078"></a><span class="hs-identifier">unload</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1079"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ The linkables to *keep*.</span><span>
</span><a name="line-1080"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1081"></a><a name="unload"><a href="Linker.html#unload"><span class="hs-identifier">unload</span></a></a><span> </span><a name="local-6989586621682423858"><a href="#local-6989586621682423858"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423859"><a href="#local-6989586621682423859"><span class="hs-identifier">linkables</span></a></a><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mask_</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- mask, so we're safe from Ctrl-C in here</span><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span>        </span><span class="hs-comment">-- Initialise the linker (if it's not been done already)</span><span>
</span><a name="line-1085"></a><span>        </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423858"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1086"></a><span>
</span><a name="line-1087"></a><span>        </span><a name="local-6989586621682423862"><a href="#local-6989586621682423862"><span class="hs-identifier">new_pls</span></a></a><span>
</span><a name="line-1088"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#modifyPLS"><span class="hs-identifier hs-var">modifyPLS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423860"><a href="#local-6989586621682423860"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1089"></a><span>                 </span><a name="local-6989586621682423861"><a href="#local-6989586621682423861"><span class="hs-identifier">pls1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#unload_wkr"><span class="hs-identifier hs-var">unload_wkr</span></a><span> </span><a href="#local-6989586621682423858"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423859"><span class="hs-identifier hs-var">linkables</span></a><span> </span><a href="#local-6989586621682423860"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-1090"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423861"><span class="hs-identifier hs-var">pls1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423861"><span class="hs-identifier hs-var">pls1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1091"></a><span>
</span><a name="line-1092"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423863"><a href="#local-6989586621682423863"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423858"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1093"></a><span>        </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621682423863"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1094"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;unload: retaining objs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">objs_loaded</span><span> </span><a href="#local-6989586621682423862"><span class="hs-identifier hs-var">new_pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1095"></a><span>        </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621682423863"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1096"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;unload: retaining bcos&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bcos_loaded</span><span> </span><a href="#local-6989586621682423862"><span class="hs-identifier hs-var">new_pls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1098"></a><span>
</span><a name="line-1099"></a><span class="hs-identifier">unload_wkr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1100"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- stable linkables</span><span>
</span><a name="line-1101"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-1102"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-1103"></a><span class="hs-comment">-- Does the core unload business</span><span>
</span><a name="line-1104"></a><span class="hs-comment">-- (the wrapper blocks exceptions and deals with the PLS get and put)</span><span>
</span><a name="line-1105"></a><span>
</span><a name="line-1106"></a><a name="unload_wkr"><a href="Linker.html#unload_wkr"><span class="hs-identifier">unload_wkr</span></a></a><span> </span><a name="local-6989586621682423864"><a href="#local-6989586621682423864"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423865"><a href="#local-6989586621682423865"><span class="hs-identifier">keep_linkables</span></a></a><span> </span><a name="local-6989586621682423866"><a href="#local-6989586621682423866"><span class="hs-identifier">pls</span></a></a><span class="hs-glyph">@</span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-var">PersistentLinkerState</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1107"></a><span>  </span><span class="hs-comment">-- NB. careful strictness here to avoid keeping the old PLS when</span><span>
</span><a name="line-1108"></a><span>  </span><span class="hs-comment">-- we're unloading some code.  -fghci-leak-check with the tests in</span><span>
</span><a name="line-1109"></a><span>  </span><span class="hs-comment">-- testsuite/ghci can detect space leaks here.</span><span>
</span><a name="line-1110"></a><span>
</span><a name="line-1111"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682423876"><a href="#local-6989586621682423876"><span class="hs-identifier">objs_to_keep</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423877"><a href="#local-6989586621682423877"><span class="hs-identifier">bcos_to_keep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-identifier hs-var">isObjectLinkable</span><span> </span><a href="#local-6989586621682423865"><span class="hs-identifier hs-var">keep_linkables</span></a><span>
</span><a name="line-1112"></a><span>
</span><a name="line-1113"></a><span>      </span><a name="local-6989586621682423878"><a href="#local-6989586621682423878"><span class="hs-identifier">discard</span></a></a><span> </span><a name="local-6989586621682423883"><a href="#local-6989586621682423883"><span class="hs-identifier">keep</span></a></a><span> </span><a name="local-6989586621682423884"><a href="#local-6989586621682423884"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Linker.html#linkableInSet"><span class="hs-identifier hs-var">linkableInSet</span></a><span> </span><a href="#local-6989586621682423884"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682423883"><span class="hs-identifier hs-var">keep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><span>
</span><a name="line-1115"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682423879"><a href="#local-6989586621682423879"><span class="hs-identifier">objs_to_unload</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423880"><a href="#local-6989586621682423880"><span class="hs-identifier">remaining_objs_loaded</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1116"></a><span>         </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423878"><span class="hs-identifier hs-var">discard</span></a><span> </span><a href="#local-6989586621682423876"><span class="hs-identifier hs-var">objs_to_keep</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423870"><span class="hs-identifier hs-var">objs_loaded</span></a><span>
</span><a name="line-1117"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682423881"><a href="#local-6989586621682423881"><span class="hs-identifier">bcos_to_unload</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682423882"><a href="#local-6989586621682423882"><span class="hs-identifier">remaining_bcos_loaded</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1118"></a><span>         </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423878"><span class="hs-identifier hs-var">discard</span></a><span> </span><a href="#local-6989586621682423877"><span class="hs-identifier hs-var">bcos_to_keep</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423869"><span class="hs-identifier hs-var">bcos_loaded</span></a><span>
</span><a name="line-1119"></a><span>
</span><a name="line-1120"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682423873"><span class="hs-identifier hs-var">unloadObjs</span></a><span> </span><a href="#local-6989586621682423879"><span class="hs-identifier hs-var">objs_to_unload</span></a><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682423873"><span class="hs-identifier hs-var">unloadObjs</span></a><span> </span><a href="#local-6989586621682423881"><span class="hs-identifier hs-var">bcos_to_unload</span></a><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span>  </span><span class="hs-comment">-- If we unloaded any object files at all, we need to purge the cache</span><span>
</span><a name="line-1124"></a><span>  </span><span class="hs-comment">-- of lookupSymbol results.</span><span>
</span><a name="line-1125"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423879"><span class="hs-identifier hs-var">objs_to_unload</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1126"></a><span>                   </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">linkableObjs</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423881"><span class="hs-identifier hs-var">bcos_to_unload</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1127"></a><span>    </span><a href="GHCi.html#purgeLookupSymbolCache"><span class="hs-identifier hs-var">purgeLookupSymbolCache</span></a><span> </span><a href="#local-6989586621682423864"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1128"></a><span>
</span><a name="line-1129"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621682423885"><a href="#local-6989586621682423885"><span class="hs-identifier">bcos_retained</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">linkableModule</span><span> </span><a href="#local-6989586621682423882"><span class="hs-identifier hs-var">remaining_bcos_loaded</span></a><span>
</span><a name="line-1130"></a><span>
</span><a name="line-1131"></a><span>      </span><span class="hs-comment">-- Note that we want to remove all *local*</span><span>
</span><a name="line-1132"></a><span>      </span><span class="hs-comment">-- (i.e. non-isExternal) names too (these are the</span><span>
</span><a name="line-1133"></a><span>      </span><span class="hs-comment">-- temporary bindings from the command line).</span><span>
</span><a name="line-1134"></a><span>      </span><a name="local-6989586621682423886"><a href="#local-6989586621682423886"><span class="hs-identifier">keep_name</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682423890"><a href="#local-6989586621682423890"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621682423890"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1135"></a><span>                        </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621682423890"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemModuleSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682423885"><span class="hs-identifier hs-var">bcos_retained</span></a><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span>      </span><a name="local-6989586621682423887"><a href="#local-6989586621682423887"><span class="hs-identifier">itbl_env'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterNameEnv</span><span> </span><a href="#local-6989586621682423886"><span class="hs-identifier hs-var">keep_name</span></a><span> </span><a href="#local-6989586621682423868"><span class="hs-identifier hs-var">itbl_env</span></a><span>
</span><a name="line-1138"></a><span>      </span><a name="local-6989586621682423888"><a href="#local-6989586621682423888"><span class="hs-identifier">closure_env'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterNameEnv</span><span> </span><a href="#local-6989586621682423886"><span class="hs-identifier hs-var">keep_name</span></a><span> </span><a href="#local-6989586621682423867"><span class="hs-identifier hs-var">closure_env</span></a><span>
</span><a name="line-1139"></a><span>
</span><a name="line-1140"></a><span>      </span><span class="hs-glyph">!</span><a name="local-6989586621682423889"><a href="#local-6989586621682423889"><span class="hs-identifier">new_pls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423866"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">itbl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423887"><span class="hs-identifier hs-var">itbl_env'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1141"></a><span>                       </span><span class="hs-identifier">closure_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423888"><span class="hs-identifier hs-var">closure_env'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1142"></a><span>                       </span><span class="hs-identifier">bcos_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423882"><span class="hs-identifier hs-var">remaining_bcos_loaded</span></a><span class="hs-special">,</span><span>
</span><a name="line-1143"></a><span>                       </span><span class="hs-identifier">objs_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423880"><span class="hs-identifier hs-var">remaining_objs_loaded</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1144"></a><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423889"><span class="hs-identifier hs-var">new_pls</span></a><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1147"></a><span>    </span><span class="hs-identifier">unloadObjs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>    </span><a name="local-6989586621682423873"><a href="#local-6989586621682423873"><span class="hs-identifier">unloadObjs</span></a></a><span> </span><a name="local-6989586621682423874"><a href="#local-6989586621682423874"><span class="hs-identifier">lnk</span></a></a><span>
</span><a name="line-1149"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dynamicGhc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1150"></a><span>        </span><span class="hs-comment">-- We don't do any cleanup when linking objects with the</span><span>
</span><a name="line-1151"></a><span>        </span><span class="hs-comment">-- dynamic linker.  Doing so introduces extra complexity for</span><span>
</span><a name="line-1152"></a><span>        </span><span class="hs-comment">-- not much benefit.</span><span>
</span><a name="line-1153"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1154"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#unloadObj"><span class="hs-identifier hs-var">unloadObj</span></a><span> </span><a href="#local-6989586621682423864"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682423875"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">DotO</span><span> </span><a name="local-6989586621682423875"><a href="#local-6989586621682423875"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621682423874"><span class="hs-identifier hs-var">lnk</span></a><span class="hs-special">]</span><span>
</span><a name="line-1155"></a><span>                </span><span class="hs-comment">-- The components of a BCO linkable may contain</span><span>
</span><a name="line-1156"></a><span>                </span><span class="hs-comment">-- dot-o files.  Which is very confusing.</span><span>
</span><a name="line-1157"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-1158"></a><span>                </span><span class="hs-comment">-- But the BCO parts can be unlinked just by</span><span>
</span><a name="line-1159"></a><span>                </span><span class="hs-comment">-- letting go of them (plus of course depopulating</span><span>
</span><a name="line-1160"></a><span>                </span><span class="hs-comment">-- the symbol table which is done in the main body)</span><span>
</span><a name="line-1161"></a><span>
</span><a name="line-1162"></a><span class="hs-comment">{- **********************************************************************

                Loading packages

  ********************************************************************* -}</span><span>
</span><a name="line-1167"></a><span>
</span><a name="line-1168"></a><span class="hs-keyword">data</span><span> </span><a name="LibrarySpec"><a href="Linker.html#LibrarySpec"><span class="hs-identifier">LibrarySpec</span></a></a><span>
</span><a name="line-1169"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="Object"><a href="Linker.html#Object"><span class="hs-identifier">Object</span></a></a><span> </span><span class="hs-identifier hs-type">FilePath</span><span>    </span><span class="hs-comment">-- Full path name of a .o file, including trailing .o</span><span>
</span><a name="line-1170"></a><span>                        </span><span class="hs-comment">-- For dynamic objects only, try to find the object</span><span>
</span><a name="line-1171"></a><span>                        </span><span class="hs-comment">-- file in all the directories specified in</span><span>
</span><a name="line-1172"></a><span>                        </span><span class="hs-comment">-- v_Library_paths before giving up.</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Archive"><a href="Linker.html#Archive"><span class="hs-identifier">Archive</span></a></a><span> </span><span class="hs-identifier hs-type">FilePath</span><span>   </span><span class="hs-comment">-- Full path name of a .a file, including trailing .a</span><span>
</span><a name="line-1175"></a><span>
</span><a name="line-1176"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="DLL"><a href="Linker.html#DLL"><span class="hs-identifier">DLL</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>         </span><span class="hs-comment">-- &quot;Unadorned&quot; name of a .DLL/.so</span><span>
</span><a name="line-1177"></a><span>                        </span><span class="hs-comment">--  e.g.    On unix     &quot;qt&quot;  denotes &quot;libqt.so&quot;</span><span>
</span><a name="line-1178"></a><span>                        </span><span class="hs-comment">--          On Windows  &quot;burble&quot;  denotes &quot;burble.DLL&quot; or &quot;libburble.dll&quot;</span><span>
</span><a name="line-1179"></a><span>                        </span><span class="hs-comment">--  loadDLL is platform-specific and adds the lib/.so/.DLL</span><span>
</span><a name="line-1180"></a><span>                        </span><span class="hs-comment">--  suffixes platform-dependently</span><span>
</span><a name="line-1181"></a><span>
</span><a name="line-1182"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="DLLPath"><a href="Linker.html#DLLPath"><span class="hs-identifier">DLLPath</span></a></a><span> </span><span class="hs-identifier hs-type">FilePath</span><span>   </span><span class="hs-comment">-- Absolute or relative pathname to a dynamic library</span><span>
</span><a name="line-1183"></a><span>                        </span><span class="hs-comment">-- (ends with .dll or .so).</span><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Framework"><a href="Linker.html#Framework"><span class="hs-identifier">Framework</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>   </span><span class="hs-comment">-- Only used for darwin, but does no harm</span><span>
</span><a name="line-1186"></a><span>
</span><a name="line-1187"></a><span class="hs-comment">-- If this package is already part of the GHCi binary, we'll already</span><span>
</span><a name="line-1188"></a><span class="hs-comment">-- have the right DLLs for this package loaded, so don't try to</span><span>
</span><a name="line-1189"></a><span class="hs-comment">-- load them again.</span><span>
</span><a name="line-1190"></a><span class="hs-comment">--</span><span>
</span><a name="line-1191"></a><span class="hs-comment">-- But on Win32 we must load them 'again'; doing so is a harmless no-op</span><span>
</span><a name="line-1192"></a><span class="hs-comment">-- as far as the loader is concerned, but it does initialise the list</span><span>
</span><a name="line-1193"></a><span class="hs-comment">-- of DLL handles that rts/Linker.c maintains, and that in turn is</span><span>
</span><a name="line-1194"></a><span class="hs-comment">-- used by lookupSymbol.  So we must call addDLL for each library</span><span>
</span><a name="line-1195"></a><span class="hs-comment">-- just to get the DLL handle into the list.</span><span>
</span><a name="line-1196"></a><span class="hs-identifier">partOfGHCi</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PackageName</span><span class="hs-special">]</span><span>
</span><a name="line-1197"></a><a name="partOfGHCi"><a href="Linker.html#partOfGHCi"><span class="hs-identifier">partOfGHCi</span></a></a><span>
</span><a name="line-1198"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWindowsHost</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isDarwinHost</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1199"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PackageName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span class="hs-special">)</span><span>
</span><a name="line-1200"></a><span>                   </span><span class="hs-special">[</span><span class="hs-string">&quot;base&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;template-haskell&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;editline&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span class="hs-identifier">showLS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Linker.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1203"></a><a name="showLS"><a href="Linker.html#showLS"><span class="hs-identifier">showLS</span></a></a><span> </span><span class="hs-special">(</span><a href="Linker.html#Object"><span class="hs-identifier hs-var">Object</span></a><span> </span><a name="local-6989586621682423891"><a href="#local-6989586621682423891"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;(static) &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423891"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-1204"></a><span class="hs-identifier">showLS</span><span> </span><span class="hs-special">(</span><a href="Linker.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><a name="local-6989586621682423892"><a href="#local-6989586621682423892"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;(static archive) &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423892"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-1205"></a><span class="hs-identifier">showLS</span><span> </span><span class="hs-special">(</span><a href="Linker.html#DLL"><span class="hs-identifier hs-var">DLL</span></a><span> </span><a name="local-6989586621682423893"><a href="#local-6989586621682423893"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;(dynamic) &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423893"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-1206"></a><span class="hs-identifier">showLS</span><span> </span><span class="hs-special">(</span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span> </span><a name="local-6989586621682423894"><a href="#local-6989586621682423894"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;(dynamic) &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423894"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-1207"></a><span class="hs-identifier">showLS</span><span> </span><span class="hs-special">(</span><a href="Linker.html#Framework"><span class="hs-identifier hs-var">Framework</span></a><span> </span><a name="local-6989586621682423895"><a href="#local-6989586621682423895"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;(framework) &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423895"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-comment">-- TODO: Make this type more precise</span><span>
</span><a name="line-1210"></a><span class="hs-keyword">type</span><span> </span><a name="LinkerUnitId"><a href="Linker.html#LinkerUnitId"><span class="hs-identifier">LinkerUnitId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span>
</span><a name="line-1211"></a><span>
</span><a name="line-1212"></a><span class="hs-comment">-- | Link exactly the specified packages, and their dependents (unless of</span><span>
</span><a name="line-1213"></a><span class="hs-comment">-- course they are already linked).  The dependents are linked</span><span>
</span><a name="line-1214"></a><span class="hs-comment">-- automatically, and it doesn't matter what order you specify the input</span><span>
</span><a name="line-1215"></a><span class="hs-comment">-- packages.</span><span>
</span><a name="line-1216"></a><span class="hs-comment">--</span><span>
</span><a name="line-1217"></a><span class="hs-identifier">linkPackages</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Linker.html#LinkerUnitId"><span class="hs-identifier hs-type">LinkerUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1218"></a><span class="hs-comment">-- NOTE: in fact, since each module tracks all the packages it depends on,</span><span>
</span><a name="line-1219"></a><span class="hs-comment">--       we don't really need to use the package-config dependencies.</span><span>
</span><a name="line-1220"></a><span class="hs-comment">--</span><span>
</span><a name="line-1221"></a><span class="hs-comment">-- However we do need the package-config stuff (to find aux libs etc),</span><span>
</span><a name="line-1222"></a><span class="hs-comment">-- and following them lets us load libraries in the right order, which</span><span>
</span><a name="line-1223"></a><span class="hs-comment">-- perhaps makes the error message a bit more localised if we get a link</span><span>
</span><a name="line-1224"></a><span class="hs-comment">-- failure.  So the dependency walking code is still here.</span><span>
</span><a name="line-1225"></a><span>
</span><a name="line-1226"></a><a name="linkPackages"><a href="Linker.html#linkPackages"><span class="hs-identifier">linkPackages</span></a></a><span> </span><a name="local-6989586621682423896"><a href="#local-6989586621682423896"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423897"><a href="#local-6989586621682423897"><span class="hs-identifier">new_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1227"></a><span>  </span><span class="hs-comment">-- It's probably not safe to try to load packages concurrently, so we take</span><span>
</span><a name="line-1228"></a><span>  </span><span class="hs-comment">-- a lock.</span><span>
</span><a name="line-1229"></a><span>  </span><a href="Linker.html#initDynLinker"><span class="hs-identifier hs-var">initDynLinker</span></a><span> </span><a href="#local-6989586621682423896"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1230"></a><span>  </span><a href="Linker.html#modifyPLS_"><span class="hs-identifier hs-var">modifyPLS_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682423898"><a href="#local-6989586621682423898"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1231"></a><span>    </span><a href="Linker.html#linkPackages%27"><span class="hs-identifier hs-var">linkPackages'</span></a><span> </span><a href="#local-6989586621682423896"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423897"><span class="hs-identifier hs-var">new_pkgs</span></a><span> </span><a href="#local-6989586621682423898"><span class="hs-identifier hs-var">pls</span></a><span>
</span><a name="line-1232"></a><span>
</span><a name="line-1233"></a><span class="hs-identifier">linkPackages'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Linker.html#LinkerUnitId"><span class="hs-identifier hs-type">LinkerUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-1234"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#PersistentLinkerState"><span class="hs-identifier hs-type">PersistentLinkerState</span></a><span>
</span><a name="line-1235"></a><a name="linkPackages%27"><a href="Linker.html#linkPackages%27"><span class="hs-identifier">linkPackages'</span></a></a><span> </span><a name="local-6989586621682423899"><a href="#local-6989586621682423899"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423900"><a href="#local-6989586621682423900"><span class="hs-identifier">new_pks</span></a></a><span> </span><a name="local-6989586621682423901"><a href="#local-6989586621682423901"><span class="hs-identifier">pls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1236"></a><span>    </span><a name="local-6989586621682423911"><a href="#local-6989586621682423911"><span class="hs-identifier">pkgs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423903"><span class="hs-identifier hs-var">link</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgs_loaded</span><span> </span><a href="#local-6989586621682423901"><span class="hs-identifier hs-var">pls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423900"><span class="hs-identifier hs-var">new_pks</span></a><span>
</span><a name="line-1237"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621682423901"><span class="hs-identifier hs-var">pls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pkgs_loaded</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423911"><span class="hs-identifier hs-var">pkgs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1238"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1239"></a><span>     </span><a name="local-6989586621682423902"><a href="#local-6989586621682423902"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423899"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span>     </span><span class="hs-identifier">link</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Linker.html#LinkerUnitId"><span class="hs-identifier hs-type">LinkerUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Linker.html#LinkerUnitId"><span class="hs-identifier hs-type">LinkerUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="Linker.html#LinkerUnitId"><span class="hs-identifier hs-type">LinkerUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1242"></a><span>     </span><a name="local-6989586621682423903"><a href="#local-6989586621682423903"><span class="hs-identifier">link</span></a></a><span> </span><a name="local-6989586621682423905"><a href="#local-6989586621682423905"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621682423906"><a href="#local-6989586621682423906"><span class="hs-identifier">new_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1243"></a><span>         </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621682423904"><span class="hs-identifier hs-var">link_one</span></a><span> </span><a href="#local-6989586621682423905"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><a href="#local-6989586621682423906"><span class="hs-identifier hs-var">new_pkgs</span></a><span>
</span><a name="line-1244"></a><span>
</span><a name="line-1245"></a><span>     </span><a name="local-6989586621682423904"><a href="#local-6989586621682423904"><span class="hs-identifier">link_one</span></a></a><span> </span><a name="local-6989586621682423907"><a href="#local-6989586621682423907"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621682423908"><a href="#local-6989586621682423908"><span class="hs-identifier">new_pkg</span></a></a><span>
</span><a name="line-1246"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682423908"><span class="hs-identifier hs-var">new_pkg</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682423907"><span class="hs-identifier hs-var">pkgs</span></a><span>   </span><span class="hs-comment">-- Already linked</span><span>
</span><a name="line-1247"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682423907"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1248"></a><span>
</span><a name="line-1249"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423909"><a href="#local-6989586621682423909"><span class="hs-identifier">pkg_cfg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupInstalledPackage</span><span> </span><a href="#local-6989586621682423902"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682423908"><span class="hs-identifier hs-var">new_pkg</span></a><span>
</span><a name="line-1250"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Link dependents first</span><span>
</span><a name="line-1251"></a><span>               </span><a name="local-6989586621682423910"><a href="#local-6989586621682423910"><span class="hs-identifier">pkgs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423903"><span class="hs-identifier hs-var">link</span></a><span> </span><a href="#local-6989586621682423907"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">depends</span><span> </span><a href="#local-6989586621682423909"><span class="hs-identifier hs-var">pkg_cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>                </span><span class="hs-comment">-- Now link the package itself</span><span>
</span><a name="line-1253"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="Linker.html#linkPackage"><span class="hs-identifier hs-var">linkPackage</span></a><span> </span><a href="#local-6989586621682423899"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423909"><span class="hs-identifier hs-var">pkg_cfg</span></a><span>
</span><a name="line-1254"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423908"><span class="hs-identifier hs-var">new_pkg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682423910"><span class="hs-identifier hs-var">pkgs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1255"></a><span>
</span><a name="line-1256"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1257"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CmdLineError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;unknown package: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unpackFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">installedUnitIdFS</span><span> </span><a href="#local-6989586621682423908"><span class="hs-identifier hs-var">new_pkg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span>
</span><a name="line-1260"></a><span class="hs-identifier">linkPackage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PackageConfig</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1261"></a><a name="linkPackage"><a href="Linker.html#linkPackage"><span class="hs-identifier">linkPackage</span></a></a><span> </span><a name="local-6989586621682423912"><a href="#local-6989586621682423912"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423913"><a href="#local-6989586621682423913"><span class="hs-identifier">pkg</span></a></a><span>
</span><a name="line-1262"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1263"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423914"><a href="#local-6989586621682423914"><span class="hs-identifier">dflags</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1264"></a><span>            </span><a name="local-6989586621682423915"><a href="#local-6989586621682423915"><span class="hs-identifier">platform</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423914"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1265"></a><span>            </span><a name="local-6989586621682423916"><a href="#local-6989586621682423916"><span class="hs-identifier">is_dyn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">interpreterDynamic</span><span> </span><a href="#local-6989586621682423914"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1266"></a><span>            </span><a name="local-6989586621682423917"><a href="#local-6989586621682423917"><span class="hs-identifier">dirs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682423916"><span class="hs-identifier hs-var">is_dyn</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Packages.libraryDynDirs</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1267"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Packages.libraryDirs</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1268"></a><span>
</span><a name="line-1269"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423918"><a href="#local-6989586621682423918"><span class="hs-identifier">hs_libs</span></a></a><span>   </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">Packages.hsLibraries</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1270"></a><span>            </span><span class="hs-comment">-- The FFI GHCi import lib isn't needed as</span><span>
</span><a name="line-1271"></a><span>            </span><span class="hs-comment">-- compiler/ghci/Linker.hs + rts/Linker.c link the</span><span>
</span><a name="line-1272"></a><span>            </span><span class="hs-comment">-- interpreted references to FFI to the compiled FFI.</span><span>
</span><a name="line-1273"></a><span>            </span><span class="hs-comment">-- We therefore filter it out so that we don't get</span><span>
</span><a name="line-1274"></a><span>            </span><span class="hs-comment">-- duplicate symbol errors.</span><span>
</span><a name="line-1275"></a><span>            </span><a name="local-6989586621682423919"><a href="#local-6989586621682423919"><span class="hs-identifier">hs_libs'</span></a></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;HSffi&quot;</span><span> </span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423918"><span class="hs-identifier hs-var">hs_libs</span></a><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-comment">-- Because of slight differences between the GHC dynamic linker and</span><span>
</span><a name="line-1278"></a><span>        </span><span class="hs-comment">-- the native system linker some packages have to link with a</span><span>
</span><a name="line-1279"></a><span>        </span><span class="hs-comment">-- different list of libraries when using GHCi. Examples include: libs</span><span>
</span><a name="line-1280"></a><span>        </span><span class="hs-comment">-- that are actually gnu ld scripts, and the possibility that the .a</span><span>
</span><a name="line-1281"></a><span>        </span><span class="hs-comment">-- libs do not exactly match the .so/.dll equivalents. So if the</span><span>
</span><a name="line-1282"></a><span>        </span><span class="hs-comment">-- package file provides an &quot;extra-ghci-libraries&quot; field then we use</span><span>
</span><a name="line-1283"></a><span>        </span><span class="hs-comment">-- that instead of the &quot;extra-libraries&quot; field.</span><span>
</span><a name="line-1284"></a><span>            </span><a name="local-6989586621682423920"><a href="#local-6989586621682423920"><span class="hs-identifier">extra_libs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1285"></a><span>                      </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Packages.extraGHCiLibraries</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1286"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">Packages.extraLibraries</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1287"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">Packages.extraGHCiLibraries</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1288"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423921"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><span class="hs-char">'l'</span><span class="hs-glyph">:</span><a name="local-6989586621682423921"><a href="#local-6989586621682423921"><span class="hs-identifier">lib</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">Packages.ldOptions</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1289"></a><span>        </span><span class="hs-comment">-- See Note [Fork/Exec Windows]</span><span>
</span><a name="line-1290"></a><span>        </span><a name="local-6989586621682423922"><a href="#local-6989586621682423922"><span class="hs-identifier">gcc_paths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getGCCPaths"><span class="hs-identifier hs-var">getGCCPaths</span></a><span> </span><a href="#local-6989586621682423914"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621682423915"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-1291"></a><span>        </span><a name="local-6989586621682423923"><a href="#local-6989586621682423923"><span class="hs-identifier">dirs_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#addEnvPaths"><span class="hs-identifier hs-var">addEnvPaths</span></a><span> </span><span class="hs-string">&quot;LIBRARY_PATH&quot;</span><span> </span><a href="#local-6989586621682423917"><span class="hs-identifier hs-var">dirs</span></a><span>
</span><a name="line-1292"></a><span>
</span><a name="line-1293"></a><span>        </span><a name="local-6989586621682423924"><a href="#local-6989586621682423924"><span class="hs-identifier">hs_classifieds</span></a></a><span>
</span><a name="line-1294"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Linker.html#locateLib"><span class="hs-identifier hs-var">locateLib</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a href="#local-6989586621682423923"><span class="hs-identifier hs-var">dirs_env</span></a><span> </span><a href="#local-6989586621682423922"><span class="hs-identifier hs-var">gcc_paths</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423919"><span class="hs-identifier hs-var">hs_libs'</span></a><span>
</span><a name="line-1295"></a><span>        </span><a name="local-6989586621682423925"><a href="#local-6989586621682423925"><span class="hs-identifier">extra_classifieds</span></a></a><span>
</span><a name="line-1296"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Linker.html#locateLib"><span class="hs-identifier hs-var">locateLib</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682423923"><span class="hs-identifier hs-var">dirs_env</span></a><span> </span><a href="#local-6989586621682423922"><span class="hs-identifier hs-var">gcc_paths</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423920"><span class="hs-identifier hs-var">extra_libs</span></a><span>
</span><a name="line-1297"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423926"><a href="#local-6989586621682423926"><span class="hs-identifier">classifieds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423924"><span class="hs-identifier hs-var">hs_classifieds</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423925"><span class="hs-identifier hs-var">extra_classifieds</span></a><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span>        </span><span class="hs-comment">-- Complication: all the .so's must be loaded before any of the .o's.</span><span>
</span><a name="line-1300"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423927"><a href="#local-6989586621682423927"><span class="hs-identifier">known_dlls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423931"><span class="hs-identifier hs-var">dll</span></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span> </span><a name="local-6989586621682423931"><a href="#local-6989586621682423931"><span class="hs-identifier">dll</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423926"><span class="hs-identifier hs-var">classifieds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1301"></a><span>            </span><a name="local-6989586621682423928"><a href="#local-6989586621682423928"><span class="hs-identifier">dlls</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423932"><span class="hs-identifier hs-var">dll</span></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Linker.html#DLL"><span class="hs-identifier hs-var">DLL</span></a><span> </span><a name="local-6989586621682423932"><a href="#local-6989586621682423932"><span class="hs-identifier">dll</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423926"><span class="hs-identifier hs-var">classifieds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1302"></a><span>            </span><a name="local-6989586621682423929"><a href="#local-6989586621682423929"><span class="hs-identifier">objs</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423933"><span class="hs-identifier hs-var">obj</span></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Linker.html#Object"><span class="hs-identifier hs-var">Object</span></a><span> </span><a name="local-6989586621682423933"><a href="#local-6989586621682423933"><span class="hs-identifier">obj</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423926"><span class="hs-identifier hs-var">classifieds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1303"></a><span>            </span><a name="local-6989586621682423930"><a href="#local-6989586621682423930"><span class="hs-identifier">archs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423934"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Linker.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><a name="local-6989586621682423934"><a href="#local-6989586621682423934"><span class="hs-identifier">arch</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682423926"><span class="hs-identifier hs-var">classifieds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1304"></a><span>
</span><a name="line-1305"></a><span>        </span><span class="hs-comment">-- Add directories to library search paths</span><span>
</span><a name="line-1306"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423935"><a href="#local-6989586621682423935"><span class="hs-identifier">dll_paths</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621682423927"><span class="hs-identifier hs-var">known_dlls</span></a><span>
</span><a name="line-1307"></a><span>            </span><a name="local-6989586621682423936"><a href="#local-6989586621682423936"><span class="hs-identifier">all_paths</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">normalise</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423935"><span class="hs-identifier hs-var">dll_paths</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423917"><span class="hs-identifier hs-var">dirs</span></a><span>
</span><a name="line-1308"></a><span>        </span><a name="local-6989586621682423937"><a href="#local-6989586621682423937"><span class="hs-identifier">all_paths_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#addEnvPaths"><span class="hs-identifier hs-var">addEnvPaths</span></a><span> </span><span class="hs-string">&quot;LD_LIBRARY_PATH&quot;</span><span> </span><a href="#local-6989586621682423936"><span class="hs-identifier hs-var">all_paths</span></a><span>
</span><a name="line-1309"></a><span>        </span><a name="local-6989586621682423938"><a href="#local-6989586621682423938"><span class="hs-identifier">pathCache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#addLibrarySearchPath"><span class="hs-identifier hs-var">addLibrarySearchPath</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423937"><span class="hs-identifier hs-var">all_paths_env</span></a><span>
</span><a name="line-1310"></a><span>
</span><a name="line-1311"></a><span>        </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423914"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1312"></a><span>            </span><span class="hs-special">(</span><span class="hs-string">&quot;Loading package &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">sourcePackageIdString</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; ... &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1313"></a><span>
</span><a name="line-1314"></a><span>        </span><span class="hs-comment">-- See comments with partOfGHCi</span><span>
</span><a name="line-1315"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">packageName</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="Linker.html#partOfGHCi"><span class="hs-identifier hs-var">partOfGHCi</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1316"></a><span>            </span><a href="Linker.html#loadFrameworks"><span class="hs-identifier hs-var">loadFrameworks</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423915"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1317"></a><span>            </span><span class="hs-comment">-- See Note [Crash early load_dyn and locateLib]</span><span>
</span><a name="line-1318"></a><span>            </span><span class="hs-comment">-- Crash early if can't load any of `known_dlls`</span><span>
</span><a name="line-1319"></a><span>            </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Linker.html#load_dyn"><span class="hs-identifier hs-var">load_dyn</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423927"><span class="hs-identifier hs-var">known_dlls</span></a><span>
</span><a name="line-1320"></a><span>            </span><span class="hs-comment">-- For remaining `dlls` crash early only when there is surely</span><span>
</span><a name="line-1321"></a><span>            </span><span class="hs-comment">-- no package's DLL around ... (not is_dyn)</span><span>
</span><a name="line-1322"></a><span>            </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Linker.html#load_dyn"><span class="hs-identifier hs-var">load_dyn</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682423916"><span class="hs-identifier hs-var">is_dyn</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkSOName</span><span> </span><a href="#local-6989586621682423915"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423928"><span class="hs-identifier hs-var">dlls</span></a><span>
</span><a name="line-1323"></a><span>
</span><a name="line-1324"></a><span>        </span><span class="hs-comment">-- After loading all the DLLs, we can load the static objects.</span><span>
</span><a name="line-1325"></a><span>        </span><span class="hs-comment">-- Ordering isn't important here, because we do one final link</span><span>
</span><a name="line-1326"></a><span>        </span><span class="hs-comment">-- step to resolve everything.</span><span>
</span><a name="line-1327"></a><span>        </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423929"><span class="hs-identifier hs-var">objs</span></a><span>
</span><a name="line-1328"></a><span>        </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#loadArchive"><span class="hs-identifier hs-var">loadArchive</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682423930"><span class="hs-identifier hs-var">archs</span></a><span>
</span><a name="line-1329"></a><span>
</span><a name="line-1330"></a><span>        </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682423914"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;linking ... &quot;</span><span>
</span><a name="line-1331"></a><span>        </span><a name="local-6989586621682423939"><a href="#local-6989586621682423939"><span class="hs-identifier">ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#resolveObjs"><span class="hs-identifier hs-var">resolveObjs</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span>        </span><span class="hs-comment">-- DLLs are loaded, reset the search paths</span><span>
</span><a name="line-1334"></a><span>        </span><span class="hs-comment">-- Import libraries will be loaded via loadArchive so only</span><span>
</span><a name="line-1335"></a><span>        </span><span class="hs-comment">-- reset the DLL search path after all archives are loaded</span><span>
</span><a name="line-1336"></a><span>        </span><span class="hs-comment">-- as well.</span><span>
</span><a name="line-1337"></a><span>        </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#removeLibrarySearchPath"><span class="hs-identifier hs-var">removeLibrarySearchPath</span></a><span> </span><a href="#local-6989586621682423912"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682423938"><span class="hs-identifier hs-var">pathCache</span></a><span>
</span><a name="line-1338"></a><span>
</span><a name="line-1339"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">succeeded</span><span> </span><a href="#local-6989586621682423939"><span class="hs-identifier hs-var">ok</span></a><span>
</span><a name="line-1340"></a><span>           </span><span class="hs-keyword">then</span><span> </span><a href="Linker.html#maybePutStrLn"><span class="hs-identifier hs-var">maybePutStrLn</span></a><span> </span><a href="#local-6989586621682423914"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;done.&quot;</span><span>
</span><a name="line-1341"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423940"><a href="#local-6989586621682423940"><span class="hs-identifier">errmsg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;unable to load package `&quot;</span><span>
</span><a name="line-1342"></a><span>                             </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">sourcePackageIdString</span><span> </span><a href="#local-6989586621682423913"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;'&quot;</span><span>
</span><a name="line-1343"></a><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstallationError</span><span> </span><a href="#local-6989586621682423940"><span class="hs-identifier hs-var">errmsg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span class="hs-comment">{-
Note [Crash early load_dyn and locateLib]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a package is &quot;normal&quot; (exposes it's code from more than zero Haskell
modules, unlike e.g. that in ghcilink004) and is built &quot;dyn&quot; way, then
it has it's code compiled and linked into the DLL, which GHCi linker picks
when loading the package's code (see the big comment in the beginning of
`locateLib`).

When loading DLLs, GHCi linker simply calls the system's `dlopen` or
`LoadLibrary` APIs. This is quite different from the case when GHCi linker
loads an object file or static library. When loading an object file or static
library GHCi linker parses them and resolves all symbols &quot;manually&quot;.
These object file or static library may reference some external symbols
defined in some external DLLs. And GHCi should know which these
external DLLs are.

But when GHCi loads a DLL, it's the *system* linker who manages all
the necessary dependencies, and it is able to load this DLL not having
any extra info. Thus we don't *have to* crash in this case even if we
are unable to load any supposed dependencies explicitly.

Suppose during GHCi session a client of the package wants to
`foreign import` a symbol which isn't exposed by the package DLL, but
is exposed by such an external (dependency) DLL.
If the DLL isn't *explicitly* loaded because `load_dyn` failed to do
this, then the client code eventually crashes because the GHCi linker
isn't able to locate this symbol (GHCi linker maintains a list of
explicitly loaded DLLs it looks into when trying to find a symbol).

This is why we still should try to load all the dependency DLLs
even though we know that the system linker loads them implicitly when
loading the package DLL.

Why we still keep the `crash_early` opportunity then not allowing such
a permissive behaviour for any DLLs? Well, we, perhaps, improve a user
experience in some cases slightly.

But if it happens there exist other corner cases where our current
usage of `crash_early` flag is overly restrictive, we may lift the
restriction very easily.
-}</span><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span class="hs-comment">-- we have already searched the filesystem; the strings passed to load_dyn</span><span>
</span><a name="line-1389"></a><span class="hs-comment">-- can be passed directly to loadDLL.  They are either fully-qualified</span><span>
</span><a name="line-1390"></a><span class="hs-comment">-- (&quot;/usr/lib/libfoo.so&quot;), or unqualified (&quot;libfoo.so&quot;).  In the latter case,</span><span>
</span><a name="line-1391"></a><span class="hs-comment">-- loadDLL is going to search the system paths to find the library.</span><span>
</span><a name="line-1392"></a><span class="hs-identifier">load_dyn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1393"></a><a name="load_dyn"><a href="Linker.html#load_dyn"><span class="hs-identifier">load_dyn</span></a></a><span> </span><a name="local-6989586621682423941"><a href="#local-6989586621682423941"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423942"><a href="#local-6989586621682423942"><span class="hs-identifier">crash_early</span></a></a><span> </span><a name="local-6989586621682423943"><a href="#local-6989586621682423943"><span class="hs-identifier">dll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1394"></a><span>  </span><a name="local-6989586621682423946"><a href="#local-6989586621682423946"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621682423941"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423943"><span class="hs-identifier hs-var">dll</span></a><span>
</span><a name="line-1395"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423946"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1396"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1397"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423947"><a href="#local-6989586621682423947"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1398"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682423942"><span class="hs-identifier hs-var">crash_early</span></a><span>
</span><a name="line-1399"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">cmdLineErrorIO</span><span> </span><a href="#local-6989586621682423947"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1400"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423948"><a href="#local-6989586621682423948"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423941"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1401"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissedExtraSharedLib</span><span> </span><a href="#local-6989586621682423948"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1402"></a><span>            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621682423948"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1403"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissedExtraSharedLib</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">SevWarning</span><span>
</span><a name="line-1404"></a><span>                  </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><a href="#local-6989586621682423948"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">(</span><a href="#local-6989586621682423944"><span class="hs-identifier hs-var">note</span></a><span> </span><a href="#local-6989586621682423947"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-1405"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1406"></a><span>    </span><a name="local-6989586621682423944"><a href="#local-6989586621682423944"><span class="hs-identifier">note</span></a></a><span> </span><a name="local-6989586621682423945"><a href="#local-6989586621682423945"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">text</span><span>
</span><a name="line-1407"></a><span>      </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423945"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1408"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;It's OK if you don't want to use symbols from it directly.&quot;</span><span>
</span><a name="line-1409"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;(the package DLL is loaded by the system linker&quot;</span><span>
</span><a name="line-1410"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; which manages dependencies by itself).&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1411"></a><span>
</span><a name="line-1412"></a><span class="hs-identifier">loadFrameworks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Platform</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PackageConfig</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1413"></a><a name="loadFrameworks"><a href="Linker.html#loadFrameworks"><span class="hs-identifier">loadFrameworks</span></a></a><span> </span><a name="local-6989586621682423949"><a href="#local-6989586621682423949"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423950"><a href="#local-6989586621682423950"><span class="hs-identifier">platform</span></a></a><span> </span><a name="local-6989586621682423951"><a href="#local-6989586621682423951"><span class="hs-identifier">pkg</span></a></a><span>
</span><a name="line-1414"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><a href="#local-6989586621682423950"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682423954"><span class="hs-identifier hs-var">load</span></a><span> </span><a href="#local-6989586621682423953"><span class="hs-identifier hs-var">frameworks</span></a><span>
</span><a name="line-1415"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1416"></a><span>    </span><a name="local-6989586621682423952"><a href="#local-6989586621682423952"><span class="hs-identifier">fw_dirs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Packages.frameworkDirs</span><span> </span><a href="#local-6989586621682423951"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1417"></a><span>    </span><a name="local-6989586621682423953"><a href="#local-6989586621682423953"><span class="hs-identifier">frameworks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Packages.frameworks</span><span> </span><a href="#local-6989586621682423951"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1418"></a><span>
</span><a name="line-1419"></a><span>    </span><a name="local-6989586621682423954"><a href="#local-6989586621682423954"><span class="hs-identifier">load</span></a></a><span> </span><a name="local-6989586621682423955"><a href="#local-6989586621682423955"><span class="hs-identifier">fw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><a name="local-6989586621682423956"><a href="#local-6989586621682423956"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#loadFramework"><span class="hs-identifier hs-var">loadFramework</span></a><span> </span><a href="#local-6989586621682423949"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423952"><span class="hs-identifier hs-var">fw_dirs</span></a><span> </span><a href="#local-6989586621682423955"><span class="hs-identifier hs-var">fw</span></a><span>
</span><a name="line-1420"></a><span>                  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423956"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1421"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1422"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682423957"><a href="#local-6989586621682423957"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cmdLineErrorIO</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;can't load framework: &quot;</span><span>
</span><a name="line-1423"></a><span>                                                </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423955"><span class="hs-identifier hs-var">fw</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423957"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>
</span><a name="line-1425"></a><span class="hs-comment">-- Try to find an object file for a given library in the given paths.</span><span>
</span><a name="line-1426"></a><span class="hs-comment">-- If it isn't present, we assume that addDLL in the RTS can find it,</span><span>
</span><a name="line-1427"></a><span class="hs-comment">-- which generally means that it should be a dynamic library in the</span><span>
</span><a name="line-1428"></a><span class="hs-comment">-- standard system search path.</span><span>
</span><a name="line-1429"></a><span class="hs-comment">-- For GHCi we tend to prefer dynamic libraries over static ones as</span><span>
</span><a name="line-1430"></a><span class="hs-comment">-- they are easier to load and manage, have less overhead.</span><span>
</span><a name="line-1431"></a><span class="hs-identifier">locateLib</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1432"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Linker.html#LibrarySpec"><span class="hs-identifier hs-type">LibrarySpec</span></a><span>
</span><a name="line-1433"></a><a name="locateLib"><a href="Linker.html#locateLib"><span class="hs-identifier">locateLib</span></a></a><span> </span><a name="local-6989586621682423958"><a href="#local-6989586621682423958"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682423959"><a href="#local-6989586621682423959"><span class="hs-identifier">is_hs</span></a></a><span> </span><a name="local-6989586621682423960"><a href="#local-6989586621682423960"><span class="hs-identifier">lib_dirs</span></a></a><span> </span><a name="local-6989586621682423961"><a href="#local-6989586621682423961"><span class="hs-identifier">gcc_dirs</span></a></a><span> </span><a name="local-6989586621682423962"><a href="#local-6989586621682423962"><span class="hs-identifier">lib</span></a></a><span>
</span><a name="line-1434"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682423959"><span class="hs-identifier hs-var">is_hs</span></a><span>
</span><a name="line-1435"></a><span>    </span><span class="hs-comment">-- For non-Haskell libraries (e.g. gmp, iconv):</span><span>
</span><a name="line-1436"></a><span>    </span><span class="hs-comment">--   first look in library-dirs for a dynamic library (on User paths only)</span><span>
</span><a name="line-1437"></a><span>    </span><span class="hs-comment">--   (libfoo.so)</span><span>
</span><a name="line-1438"></a><span>    </span><span class="hs-comment">--   then  try looking for import libraries on Windows (on User paths only)</span><span>
</span><a name="line-1439"></a><span>    </span><span class="hs-comment">--   (.dll.a, .lib)</span><span>
</span><a name="line-1440"></a><span>    </span><span class="hs-comment">--   first look in library-dirs for a dynamic library (on GCC paths only)</span><span>
</span><a name="line-1441"></a><span>    </span><span class="hs-comment">--   (libfoo.so)</span><span>
</span><a name="line-1442"></a><span>    </span><span class="hs-comment">--   then  check for system dynamic libraries (e.g. kernel32.dll on windows)</span><span>
</span><a name="line-1443"></a><span>    </span><span class="hs-comment">--   then  try looking for import libraries on Windows (on GCC paths only)</span><span>
</span><a name="line-1444"></a><span>    </span><span class="hs-comment">--   (.dll.a, .lib)</span><span>
</span><a name="line-1445"></a><span>    </span><span class="hs-comment">--   then  look in library-dirs for a static library (libfoo.a)</span><span>
</span><a name="line-1446"></a><span>    </span><span class="hs-comment">--   then look in library-dirs and inplace GCC for a dynamic library (libfoo.so)</span><span>
</span><a name="line-1447"></a><span>    </span><span class="hs-comment">--   then  try looking for import libraries on Windows (.dll.a, .lib)</span><span>
</span><a name="line-1448"></a><span>    </span><span class="hs-comment">--   then  look in library-dirs and inplace GCC for a static library (libfoo.a)</span><span>
</span><a name="line-1449"></a><span>    </span><span class="hs-comment">--   then  try &quot;gcc --print-file-name&quot; to search gcc's search path</span><span>
</span><a name="line-1450"></a><span>    </span><span class="hs-comment">--       for a dynamic library (#5289)</span><span>
</span><a name="line-1451"></a><span>    </span><span class="hs-comment">--   otherwise, assume loadDLL can find it</span><span>
</span><a name="line-1452"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1453"></a><span>    </span><span class="hs-comment">--   The logic is a bit complicated, but the rationale behind it is that</span><span>
</span><a name="line-1454"></a><span>    </span><span class="hs-comment">--   loading a shared library for us is O(1) while loading an archive is</span><span>
</span><a name="line-1455"></a><span>    </span><span class="hs-comment">--   O(n). Loading an import library is also O(n) so in general we prefer</span><span>
</span><a name="line-1456"></a><span>    </span><span class="hs-comment">--   shared libraries because they are simpler and faster.</span><span>
</span><a name="line-1457"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1458"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423983"><span class="hs-identifier hs-var">findDll</span></a><span>   </span><a href="#local-6989586621682423966"><span class="hs-identifier hs-var">user</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1459"></a><span>    </span><a href="#local-6989586621682423986"><span class="hs-identifier hs-var">tryImpLib</span></a><span> </span><a href="#local-6989586621682423966"><span class="hs-identifier hs-var">user</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1460"></a><span>    </span><a href="#local-6989586621682423983"><span class="hs-identifier hs-var">findDll</span></a><span>   </span><a href="#local-6989586621682423965"><span class="hs-identifier hs-var">gcc</span></a><span>  </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1461"></a><span>    </span><a href="#local-6989586621682423984"><span class="hs-identifier hs-var">findSysDll</span></a><span>     </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1462"></a><span>    </span><a href="#local-6989586621682423986"><span class="hs-identifier hs-var">tryImpLib</span></a><span> </span><a href="#local-6989586621682423965"><span class="hs-identifier hs-var">gcc</span></a><span>  </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1463"></a><span>    </span><a href="#local-6989586621682423981"><span class="hs-identifier hs-var">findArchive</span></a><span>    </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1464"></a><span>    </span><a href="#local-6989586621682423985"><span class="hs-identifier hs-var">tryGcc</span></a><span>         </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1465"></a><span>    </span><a href="#local-6989586621682423987"><span class="hs-identifier hs-var">assumeDll</span></a><span>
</span><a name="line-1466"></a><span>
</span><a name="line-1467"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682423972"><span class="hs-identifier hs-var">loading_dynamic_hs_libs</span></a><span> </span><span class="hs-comment">-- search for .so libraries first.</span><span>
</span><a name="line-1468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423982"><span class="hs-identifier hs-var">findHSDll</span></a><span>     </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1469"></a><span>    </span><a href="#local-6989586621682423980"><span class="hs-identifier hs-var">findDynObject</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1470"></a><span>    </span><a href="#local-6989586621682423987"><span class="hs-identifier hs-var">assumeDll</span></a><span>
</span><a name="line-1471"></a><span>
</span><a name="line-1472"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1473"></a><span>    </span><span class="hs-comment">-- use HSfoo.{o,p_o} if it exists, otherwise fallback to libHSfoo{,_p}.a</span><span>
</span><a name="line-1474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423979"><span class="hs-identifier hs-var">findObject</span></a><span>  </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1475"></a><span>    </span><a href="#local-6989586621682423981"><span class="hs-identifier hs-var">findArchive</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682423988"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span>
</span><a name="line-1476"></a><span>    </span><a href="#local-6989586621682423987"><span class="hs-identifier hs-var">assumeDll</span></a><span>
</span><a name="line-1477"></a><span>
</span><a name="line-1478"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1479"></a><span>     </span><a name="local-6989586621682423963"><a href="#local-6989586621682423963"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682423958"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1480"></a><span>     </span><a name="local-6989586621682423964"><a href="#local-6989586621682423964"><span class="hs-identifier">dirs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423960"><span class="hs-identifier hs-var">lib_dirs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423961"><span class="hs-identifier hs-var">gcc_dirs</span></a><span>
</span><a name="line-1481"></a><span>     </span><a name="local-6989586621682423965"><a href="#local-6989586621682423965"><span class="hs-identifier">gcc</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1482"></a><span>     </span><a name="local-6989586621682423966"><a href="#local-6989586621682423966"><span class="hs-identifier">user</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1483"></a><span>
</span><a name="line-1484"></a><span>     </span><a name="local-6989586621682423967"><a href="#local-6989586621682423967"><span class="hs-identifier">obj_file</span></a></a><span>
</span><a name="line-1485"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682423959"><span class="hs-identifier hs-var">is_hs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682423971"><span class="hs-identifier hs-var">loading_profiled_hs_libs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;p_o&quot;</span><span>
</span><a name="line-1486"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;o&quot;</span><span>
</span><a name="line-1487"></a><span>     </span><a name="local-6989586621682423968"><a href="#local-6989586621682423968"><span class="hs-identifier">dyn_obj_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;dyn_o&quot;</span><span>
</span><a name="line-1488"></a><span>     </span><a name="local-6989586621682423969"><a href="#local-6989586621682423969"><span class="hs-identifier">arch_files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423970"><span class="hs-identifier hs-var">lib_tag</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;a&quot;</span><span>
</span><a name="line-1489"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;a&quot;</span><span> </span><span class="hs-comment">-- native code has no lib_tag</span><span>
</span><a name="line-1490"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span>
</span><a name="line-1491"></a><span>                  </span><span class="hs-special">]</span><span>
</span><a name="line-1492"></a><span>     </span><a name="local-6989586621682423970"><a href="#local-6989586621682423970"><span class="hs-identifier">lib_tag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682423959"><span class="hs-identifier hs-var">is_hs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682423971"><span class="hs-identifier hs-var">loading_profiled_hs_libs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;_p&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1493"></a><span>
</span><a name="line-1494"></a><span>     </span><a name="local-6989586621682423971"><a href="#local-6989586621682423971"><span class="hs-identifier">loading_profiled_hs_libs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">interpreterProfiled</span><span> </span><a href="#local-6989586621682423963"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1495"></a><span>     </span><a name="local-6989586621682423972"><a href="#local-6989586621682423972"><span class="hs-identifier">loading_dynamic_hs_libs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">interpreterDynamic</span><span> </span><a href="#local-6989586621682423963"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span>     </span><a name="local-6989586621682423973"><a href="#local-6989586621682423973"><span class="hs-identifier">import_libs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span>
</span><a name="line-1498"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;dll.a&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;dll.a&quot;</span><span>
</span><a name="line-1499"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-1500"></a><span>
</span><a name="line-1501"></a><span>     </span><a name="local-6989586621682423974"><a href="#local-6989586621682423974"><span class="hs-identifier">hs_dyn_lib_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><span class="hs-identifier hs-var">programName</span><span> </span><a href="#local-6989586621682423963"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">projectVersion</span><span> </span><a href="#local-6989586621682423963"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1502"></a><span>     </span><a name="local-6989586621682423975"><a href="#local-6989586621682423975"><span class="hs-identifier">hs_dyn_lib_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsSOName</span><span> </span><a href="#local-6989586621682423990"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682423974"><span class="hs-identifier hs-var">hs_dyn_lib_name</span></a><span>
</span><a name="line-1503"></a><span>
</span><a name="line-1504"></a><span>     </span><a name="local-6989586621682423976"><a href="#local-6989586621682423976"><span class="hs-identifier">so_name</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSOName</span><span> </span><a href="#local-6989586621682423990"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span>
</span><a name="line-1505"></a><span>     </span><a name="local-6989586621682423977"><a href="#local-6989586621682423977"><span class="hs-identifier">lib_so_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423976"><span class="hs-identifier hs-var">so_name</span></a><span>
</span><a name="line-1506"></a><span>     </span><a name="local-6989586621682423978"><a href="#local-6989586621682423978"><span class="hs-identifier">dyn_lib_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682423991"><span class="hs-identifier hs-var">arch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682423992"><span class="hs-identifier hs-var">os</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1507"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArchX86_64</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">OSSolaris2</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;64&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621682423976"><span class="hs-identifier hs-var">so_name</span></a><span>
</span><a name="line-1508"></a><span>                             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682423976"><span class="hs-identifier hs-var">so_name</span></a><span>
</span><a name="line-1509"></a><span>
</span><a name="line-1510"></a><span>     </span><a name="local-6989586621682423979"><a href="#local-6989586621682423979"><span class="hs-identifier">findObject</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#Object"><span class="hs-identifier hs-var">Object</span></a><span class="hs-special">)</span><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682423964"><span class="hs-identifier hs-var">dirs</span></a><span> </span><a href="#local-6989586621682423967"><span class="hs-identifier hs-var">obj_file</span></a><span>
</span><a name="line-1511"></a><span>     </span><a name="local-6989586621682423980"><a href="#local-6989586621682423980"><span class="hs-identifier">findDynObject</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#Object"><span class="hs-identifier hs-var">Object</span></a><span class="hs-special">)</span><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682423964"><span class="hs-identifier hs-var">dirs</span></a><span> </span><a href="#local-6989586621682423968"><span class="hs-identifier hs-var">dyn_obj_file</span></a><span>
</span><a name="line-1512"></a><span>     </span><a name="local-6989586621682423981"><a href="#local-6989586621682423981"><span class="hs-identifier">findArchive</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423993"><a href="#local-6989586621682423993"><span class="hs-identifier">local</span></a></a><span> </span><a name="local-6989586621682423994"><a href="#local-6989586621682423994"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682423964"><span class="hs-identifier hs-var">dirs</span></a><span> </span><a href="#local-6989586621682423994"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1513"></a><span>                     </span><span class="hs-keyword">in</span><span>  </span><a href="#local-6989586621682423989"><span class="hs-identifier hs-var">apply</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682423993"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="#local-6989586621682423969"><span class="hs-identifier hs-var">arch_files</span></a><span class="hs-special">)</span><span>
</span><a name="line-1514"></a><span>     </span><a name="local-6989586621682423982"><a href="#local-6989586621682423982"><span class="hs-identifier">findHSDll</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682423964"><span class="hs-identifier hs-var">dirs</span></a><span> </span><a href="#local-6989586621682423975"><span class="hs-identifier hs-var">hs_dyn_lib_file</span></a><span>
</span><a name="line-1515"></a><span>     </span><a name="local-6989586621682423983"><a href="#local-6989586621682423983"><span class="hs-identifier">findDll</span></a></a><span>    </span><a name="local-6989586621682423995"><a href="#local-6989586621682423995"><span class="hs-identifier">re</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423996"><a href="#local-6989586621682423996"><span class="hs-identifier">dirs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682423995"><span class="hs-identifier hs-var">re</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682423966"><span class="hs-identifier hs-var">user</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682423960"><span class="hs-identifier hs-var">lib_dirs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682423961"><span class="hs-identifier hs-var">gcc_dirs</span></a><span>
</span><a name="line-1516"></a><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682423996"><span class="hs-identifier hs-var">dirs'</span></a><span> </span><a href="#local-6989586621682423978"><span class="hs-identifier hs-var">dyn_lib_file</span></a><span>
</span><a name="line-1517"></a><span>     </span><a name="local-6989586621682423984"><a href="#local-6989586621682423984"><span class="hs-identifier">findSysDll</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Linker.html#DLL"><span class="hs-identifier hs-var">DLL</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">takeFileName</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1518"></a><span>                        </span><a href="GHCi.html#findSystemLibrary"><span class="hs-identifier hs-var">findSystemLibrary</span></a><span> </span><a href="#local-6989586621682423958"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682423976"><span class="hs-identifier hs-var">so_name</span></a><span>
</span><a name="line-1519"></a><span>     </span><a name="local-6989586621682423985"><a href="#local-6989586621682423985"><span class="hs-identifier">tryGcc</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682423997"><a href="#local-6989586621682423997"><span class="hs-identifier">search</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#searchForLibUsingGcc"><span class="hs-identifier hs-var">searchForLibUsingGcc</span></a><span> </span><a href="#local-6989586621682423963"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1520"></a><span>                         </span><a name="local-6989586621682423998"><a href="#local-6989586621682423998"><span class="hs-identifier">dllpath</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#DLLPath"><span class="hs-identifier hs-var">DLLPath</span></a><span class="hs-special">)</span><span>
</span><a name="line-1521"></a><span>                         </span><a name="local-6989586621682423999"><a href="#local-6989586621682423999"><span class="hs-identifier">short</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423998"><span class="hs-identifier hs-var">dllpath</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423997"><span class="hs-identifier hs-var">search</span></a><span> </span><a href="#local-6989586621682423976"><span class="hs-identifier hs-var">so_name</span></a><span> </span><a href="#local-6989586621682423960"><span class="hs-identifier hs-var">lib_dirs</span></a><span>
</span><a name="line-1522"></a><span>                         </span><a name="local-6989586621682424000"><a href="#local-6989586621682424000"><span class="hs-identifier">full</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423998"><span class="hs-identifier hs-var">dllpath</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423997"><span class="hs-identifier hs-var">search</span></a><span> </span><a href="#local-6989586621682423977"><span class="hs-identifier hs-var">lib_so_name</span></a><span> </span><a href="#local-6989586621682423960"><span class="hs-identifier hs-var">lib_dirs</span></a><span>
</span><a name="line-1523"></a><span>                         </span><a name="local-6989586621682424001"><a href="#local-6989586621682424001"><span class="hs-identifier">gcc</span></a></a><span> </span><a name="local-6989586621682424003"><a href="#local-6989586621682424003"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423997"><span class="hs-identifier hs-var">search</span></a><span> </span><a href="#local-6989586621682424003"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621682423960"><span class="hs-identifier hs-var">lib_dirs</span></a><span>
</span><a name="line-1524"></a><span>                         </span><a name="local-6989586621682424002"><a href="#local-6989586621682424002"><span class="hs-identifier">files</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682423973"><span class="hs-identifier hs-var">import_libs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682423969"><span class="hs-identifier hs-var">arch_files</span></a><span>
</span><a name="line-1525"></a><span>                     </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621682423989"><span class="hs-identifier hs-var">apply</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682423999"><span class="hs-identifier hs-var">short</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682424000"><span class="hs-identifier hs-var">full</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682424001"><span class="hs-identifier hs-var">gcc</span></a><span> </span><a href="#local-6989586621682424002"><span class="hs-identifier hs-var">files</span></a><span>
</span><a name="line-1526"></a><span>     </span><a name="local-6989586621682423986"><a href="#local-6989586621682423986"><span class="hs-identifier">tryImpLib</span></a></a><span> </span><a name="local-6989586621682424004"><a href="#local-6989586621682424004"><span class="hs-identifier">re</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682423992"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1527"></a><span>                       </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1528"></a><span>                        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682424005"><a href="#local-6989586621682424005"><span class="hs-identifier">dirs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682424004"><span class="hs-identifier hs-var">re</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682423966"><span class="hs-identifier hs-var">user</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682423960"><span class="hs-identifier hs-var">lib_dirs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682423961"><span class="hs-identifier hs-var">gcc_dirs</span></a><span>
</span><a name="line-1529"></a><span>                            </span><a name="local-6989586621682424006"><a href="#local-6989586621682424006"><span class="hs-identifier">implib</span></a></a><span> </span><a name="local-6989586621682424007"><a href="#local-6989586621682424007"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Linker.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1530"></a><span>                                            </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682424005"><span class="hs-identifier hs-var">dirs'</span></a><span> </span><a href="#local-6989586621682424007"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1531"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621682423989"><span class="hs-identifier hs-var">apply</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682424006"><span class="hs-identifier hs-var">implib</span></a><span> </span><a href="#local-6989586621682423973"><span class="hs-identifier hs-var">import_libs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1532"></a><span>                       </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1533"></a><span>
</span><a name="line-1534"></a><span>     </span><a name="local-6989586621682423987"><a href="#local-6989586621682423987"><span class="hs-identifier">assumeDll</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Linker.html#DLL"><span class="hs-identifier hs-var">DLL</span></a><span> </span><a href="#local-6989586621682423962"><span class="hs-identifier hs-var">lib</span></a><span class="hs-special">)</span><span>
</span><a name="line-1535"></a><span>     </span><span class="hs-keyword">infixr</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">orElse</span><span class="hs-special">`</span><span>
</span><a name="line-1536"></a><span>     </span><a name="local-6989586621682424008"><a href="#local-6989586621682424008"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">`</span><a name="local-6989586621682423988"><a href="#local-6989586621682423988"><span class="hs-identifier">orElse</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621682424009"><a href="#local-6989586621682424009"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682424008"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621682424009"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-1537"></a><span>
</span><a name="line-1538"></a><span>     </span><a name="local-6989586621682423989"><a href="#local-6989586621682423989"><span class="hs-identifier">apply</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1539"></a><span>     </span><span class="hs-identifier">apply</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682424010"><a href="#local-6989586621682424010"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682424011"><a href="#local-6989586621682424011"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682424012"><a href="#local-6989586621682424012"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682424010"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1540"></a><span>                       </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621682424012"><span class="hs-identifier hs-var">x'</span></a><span>
</span><a name="line-1541"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682424012"><span class="hs-identifier hs-var">x'</span></a><span>
</span><a name="line-1542"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682423989"><span class="hs-identifier hs-var">apply</span></a><span> </span><a href="#local-6989586621682424011"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1543"></a><span>
</span><a name="line-1544"></a><span>     </span><a name="local-6989586621682423990"><a href="#local-6989586621682423990"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621682423963"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1545"></a><span>     </span><a name="local-6989586621682423991"><a href="#local-6989586621682423991"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621682423990"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-1546"></a><span>     </span><a name="local-6989586621682423992"><a href="#local-6989586621682423992"><span class="hs-identifier">os</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621682423990"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-1547"></a><span>
</span><a name="line-1548"></a><span class="hs-identifier">searchForLibUsingGcc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-1549"></a><a name="searchForLibUsingGcc"><a href="Linker.html#searchForLibUsingGcc"><span class="hs-identifier">searchForLibUsingGcc</span></a></a><span> </span><a name="local-6989586621682424013"><a href="#local-6989586621682424013"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682424014"><a href="#local-6989586621682424014"><span class="hs-identifier">so</span></a></a><span> </span><a name="local-6989586621682424015"><a href="#local-6989586621682424015"><span class="hs-identifier">dirs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1550"></a><span>   </span><span class="hs-comment">-- GCC does not seem to extend the library search path (using -L) when using</span><span>
</span><a name="line-1551"></a><span>   </span><span class="hs-comment">-- --print-file-name. So instead pass it a new base location.</span><span>
</span><a name="line-1552"></a><span>   </span><a name="local-6989586621682424016"><a href="#local-6989586621682424016"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Tasks.html#askLd"><span class="hs-identifier hs-var">askLd</span></a><span> </span><a href="#local-6989586621682424013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;-B&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682424015"><span class="hs-identifier hs-var">dirs</span></a><span>
</span><a name="line-1553"></a><span>                          </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;--print-file-name&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621682424014"><span class="hs-identifier hs-var">so</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1554"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682424017"><a href="#local-6989586621682424017"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lines</span><span> </span><a href="#local-6989586621682424016"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1555"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1556"></a><span>                </span><a name="local-6989586621682424018"><a href="#local-6989586621682424018"><span class="hs-identifier">l</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682424018"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1557"></a><span>   </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682424017"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682424014"><span class="hs-identifier hs-var">so</span></a><span class="hs-special">)</span><span>
</span><a name="line-1558"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1559"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682424019"><a href="#local-6989586621682424019"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621682424017"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-comment">-- file could be a folder (see #16063)</span><span>
</span><a name="line-1560"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682424019"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682424017"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1561"></a><span>
</span><a name="line-1562"></a><span class="hs-comment">-- | Retrieve the list of search directory GCC and the System use to find</span><span>
</span><a name="line-1563"></a><span class="hs-comment">--   libraries and components. See Note [Fork/Exec Windows].</span><span>
</span><a name="line-1564"></a><span class="hs-identifier">getGCCPaths</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1565"></a><a name="getGCCPaths"><a href="Linker.html#getGCCPaths"><span class="hs-identifier">getGCCPaths</span></a></a><span> </span><a name="local-6989586621682424020"><a href="#local-6989586621682424020"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682424021"><a href="#local-6989586621682424021"><span class="hs-identifier">os</span></a></a><span>
</span><a name="line-1566"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682424021"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1567"></a><span>      </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1568"></a><span>        </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682424022"><a href="#local-6989586621682424022"><span class="hs-identifier">gcc_dirs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getGccSearchDirectory"><span class="hs-identifier hs-var">getGccSearchDirectory</span></a><span> </span><a href="#local-6989586621682424020"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;libraries&quot;</span><span>
</span><a name="line-1569"></a><span>           </span><a name="local-6989586621682424023"><a href="#local-6989586621682424023"><span class="hs-identifier">sys_dirs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getSystemDirectories"><span class="hs-identifier hs-var">getSystemDirectories</span></a><span>
</span><a name="line-1570"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682424022"><span class="hs-identifier hs-var">gcc_dirs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682424023"><span class="hs-identifier hs-var">sys_dirs</span></a><span>
</span><a name="line-1571"></a><span>      </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span class="hs-comment">-- | Cache for the GCC search directories as this can't easily change</span><span>
</span><a name="line-1574"></a><span class="hs-comment">--   during an invocation of GHC. (Maybe with some env. variable but we'll)</span><span>
</span><a name="line-1575"></a><span class="hs-comment">--   deal with that highly unlikely scenario then.</span><span>
</span><a name="line-1576"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">gccSearchDirCache</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1577"></a><span class="hs-identifier">gccSearchDirCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1578"></a><a name="gccSearchDirCache"><a href="Linker.html#gccSearchDirCache"><span class="hs-identifier">gccSearchDirCache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span class="hs-comment">-- Note [Fork/Exec Windows]</span><span>
</span><a name="line-1581"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1582"></a><span class="hs-comment">-- fork/exec is expensive on Windows, for each time we ask GCC for a library we</span><span>
</span><a name="line-1583"></a><span class="hs-comment">-- have to eat the cost of af least 3 of these: gcc -&gt; real_gcc -&gt; cc1.</span><span>
</span><a name="line-1584"></a><span class="hs-comment">-- So instead get a list of location that GCC would search and use findDirs</span><span>
</span><a name="line-1585"></a><span class="hs-comment">-- which hopefully is written in an optimized mannor to take advantage of</span><span>
</span><a name="line-1586"></a><span class="hs-comment">-- caching. At the very least we remove the overhead of the fork/exec and waits</span><span>
</span><a name="line-1587"></a><span class="hs-comment">-- which dominate a large percentage of startup time on Windows.</span><span>
</span><a name="line-1588"></a><span class="hs-identifier">getGccSearchDirectory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1589"></a><a name="getGccSearchDirectory"><a href="Linker.html#getGccSearchDirectory"><span class="hs-identifier">getGccSearchDirectory</span></a></a><span> </span><a name="local-6989586621682424024"><a href="#local-6989586621682424024"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682424025"><a href="#local-6989586621682424025"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1590"></a><span>    </span><a name="local-6989586621682424037"><a href="#local-6989586621682424037"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="Linker.html#gccSearchDirCache"><span class="hs-identifier hs-var">gccSearchDirCache</span></a><span>
</span><a name="line-1591"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621682424025"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621682424037"><span class="hs-identifier hs-var">cache</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1592"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682424038"><a href="#local-6989586621682424038"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682424038"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1593"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1594"></a><span>        </span><a name="local-6989586621682424039"><a href="#local-6989586621682424039"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Tasks.html#askLd"><span class="hs-identifier hs-var">askLd</span></a><span> </span><a href="#local-6989586621682424024"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;--print-search-dirs&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1595"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682424040"><a href="#local-6989586621682424040"><span class="hs-identifier">line</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-identifier hs-var">isSpace</span><span> </span><a href="#local-6989586621682424039"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1596"></a><span>            </span><a name="local-6989586621682424041"><a href="#local-6989586621682424041"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682424025"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: =&quot;</span><span>
</span><a name="line-1597"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682424040"><span class="hs-identifier hs-var">line</span></a><span>
</span><a name="line-1598"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1599"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682424042"><a href="#local-6989586621682424042"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682424026"><span class="hs-identifier hs-var">split</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682424027"><span class="hs-identifier hs-var">find</span></a><span> </span><a href="#local-6989586621682424041"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621682424040"><span class="hs-identifier hs-var">line</span></a><span>
</span><a name="line-1600"></a><span>                  </span><a name="local-6989586621682424043"><a href="#local-6989586621682424043"><span class="hs-identifier">dirs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621682424042"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-1601"></a><span>                  </span><span class="hs-identifier hs-var">modifyIORef'</span><span> </span><a href="Linker.html#gccSearchDirCache"><span class="hs-identifier hs-var">gccSearchDirCache</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682424025"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682424043"><span class="hs-identifier hs-var">dirs</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-1602"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682424042"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-1603"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1604"></a><span>            </span><a name="local-6989586621682424026"><a href="#local-6989586621682424026"><span class="hs-identifier">split</span></a></a><span> </span><a name="local-6989586621682424028"><a href="#local-6989586621682424028"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-char">';'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682424028"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1605"></a><span>                        </span><span class="hs-special">(</span><a name="local-6989586621682424029"><a href="#local-6989586621682424029"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682424029"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">]</span><span>
</span><a name="line-1606"></a><span>                        </span><span class="hs-special">(</span><a name="local-6989586621682424030"><a href="#local-6989586621682424030"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621682424031"><a href="#local-6989586621682424031"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682424030"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682424026"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621682424031"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1607"></a><span>
</span><a name="line-1608"></a><span>            </span><span class="hs-identifier">find</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1609"></a><span>            </span><a name="local-6989586621682424027"><a href="#local-6989586621682424027"><span class="hs-identifier">find</span></a></a><span> </span><a name="local-6989586621682424032"><a href="#local-6989586621682424032"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682424033"><a href="#local-6989586621682424033"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682424034"><a href="#local-6989586621682424034"><span class="hs-identifier">lst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lines</span><span> </span><a href="#local-6989586621682424033"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1610"></a><span>                           </span><a name="local-6989586621682424035"><a href="#local-6989586621682424035"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682424032"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682424034"><span class="hs-identifier hs-var">lst</span></a><span>
</span><a name="line-1611"></a><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682424035"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-1612"></a><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1613"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-char">'='</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682424035"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1614"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1615"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621682424036"><a href="#local-6989586621682424036"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682424036"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1616"></a><span>
</span><a name="line-1617"></a><span class="hs-comment">-- | Get a list of system search directories, this to alleviate pressure on</span><span>
</span><a name="line-1618"></a><span class="hs-comment">-- the findSysDll function.</span><span>
</span><a name="line-1619"></a><span class="hs-identifier">getSystemDirectories</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1620"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">getSystemDirectories</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">getSystemDirectory</span><span>
</span><a name="line-1622"></a><span class="hs-cpp">#else
</span><a name="getSystemDirectories"><a href="Linker.html#getSystemDirectories"><span class="hs-identifier">getSystemDirectories</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1624"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-1626"></a><span class="hs-comment">-- | Merge the given list of paths with those in the environment variable</span><span>
</span><a name="line-1627"></a><span class="hs-comment">--   given. If the variable does not exist then just return the identity.</span><span>
</span><a name="line-1628"></a><span class="hs-identifier">addEnvPaths</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1629"></a><a name="addEnvPaths"><a href="Linker.html#addEnvPaths"><span class="hs-identifier">addEnvPaths</span></a></a><span> </span><a name="local-6989586621682424044"><a href="#local-6989586621682424044"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682424045"><a href="#local-6989586621682424045"><span class="hs-identifier">list</span></a></a><span>
</span><a name="line-1630"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- According to POSIX (chapter 8.3) a zero-length prefix means current</span><span>
</span><a name="line-1631"></a><span>       </span><span class="hs-comment">-- working directory. Replace empty strings in the env variable with</span><span>
</span><a name="line-1632"></a><span>       </span><span class="hs-comment">-- `working_dir` (see also #14695).</span><span>
</span><a name="line-1633"></a><span>       </span><a name="local-6989586621682424053"><a href="#local-6989586621682424053"><span class="hs-identifier">working_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-1634"></a><span>       </span><a name="local-6989586621682424054"><a href="#local-6989586621682424054"><span class="hs-identifier">values</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupEnv</span><span> </span><a href="#local-6989586621682424044"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1635"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682424054"><span class="hs-identifier hs-var">values</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1636"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682424045"><span class="hs-identifier hs-var">list</span></a><span>
</span><a name="line-1637"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682424055"><a href="#local-6989586621682424055"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682424045"><span class="hs-identifier hs-var">list</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682424046"><span class="hs-identifier hs-var">splitEnv</span></a><span> </span><a href="#local-6989586621682424053"><span class="hs-identifier hs-var">working_dir</span></a><span> </span><a href="#local-6989586621682424055"><span class="hs-identifier hs-var">arr</span></a><span>
</span><a name="line-1638"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1639"></a><span>      </span><span class="hs-identifier">splitEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1640"></a><span>      </span><a name="local-6989586621682424046"><a href="#local-6989586621682424046"><span class="hs-identifier">splitEnv</span></a></a><span> </span><a name="local-6989586621682424048"><a href="#local-6989586621682424048"><span class="hs-identifier">working_dir</span></a></a><span> </span><a name="local-6989586621682424049"><a href="#local-6989586621682424049"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1641"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682424047"><span class="hs-identifier hs-var">envListSep</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682424049"><span class="hs-identifier hs-var">value</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1642"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621682424050"><a href="#local-6989586621682424050"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1643"></a><span>            </span><span class="hs-special">[</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682424050"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682424048"><span class="hs-identifier hs-var">working_dir</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682424050"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-1644"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621682424051"><a href="#local-6989586621682424051"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621682424052"><a href="#local-6989586621682424052"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1645"></a><span>            </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682424051"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682424048"><span class="hs-identifier hs-var">working_dir</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682424051"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682424046"><span class="hs-identifier hs-var">splitEnv</span></a><span> </span><a href="#local-6989586621682424048"><span class="hs-identifier hs-var">working_dir</span></a><span> </span><a href="#local-6989586621682424052"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1646"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>      </span><span class="hs-identifier">envListSep</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">';'</span><span>
</span><a name="line-1648"></a><span class="hs-cpp">#else
</span><span>      </span><a name="local-6989586621682424047"><a href="#local-6989586621682424047"><span class="hs-identifier">envListSep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">':'</span><span>
</span><a name="line-1650"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-1652"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-1653"></a><span class="hs-comment">-- Loading a dynamic library (dlopen()-ish on Unix, LoadLibrary-ish on Win32)</span><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span class="hs-comment">-- Darwin / MacOS X only: load a framework</span><span>
</span><a name="line-1656"></a><span class="hs-comment">-- a framework is a dynamic library packaged inside a directory of the same</span><span>
</span><a name="line-1657"></a><span class="hs-comment">-- name. They are searched for in different paths than normal libraries.</span><span>
</span><a name="line-1658"></a><span class="hs-identifier">loadFramework</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-1659"></a><a name="loadFramework"><a href="Linker.html#loadFramework"><span class="hs-identifier">loadFramework</span></a></a><span> </span><a name="local-6989586621682424056"><a href="#local-6989586621682424056"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682424057"><a href="#local-6989586621682424057"><span class="hs-identifier">extraPaths</span></a></a><span> </span><a name="local-6989586621682424058"><a href="#local-6989586621682424058"><span class="hs-identifier">rootname</span></a></a><span>
</span><a name="line-1660"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682424061"><a href="#local-6989586621682424061"><span class="hs-identifier">either_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryIO</span><span> </span><span class="hs-identifier hs-var">getHomeDirectory</span><span>
</span><a name="line-1661"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682424062"><a href="#local-6989586621682424062"><span class="hs-identifier">homeFrameworkPath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682424061"><span class="hs-identifier hs-var">either_dir</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1662"></a><span>                                  </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1663"></a><span>                                  </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682424064"><a href="#local-6989586621682424064"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682424064"><span class="hs-identifier hs-var">dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;Library/Frameworks&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1664"></a><span>              </span><a name="local-6989586621682424063"><a href="#local-6989586621682424063"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682424057"><span class="hs-identifier hs-var">extraPaths</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682424062"><span class="hs-identifier hs-var">homeFrameworkPath</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682424060"><span class="hs-identifier hs-var">defaultFrameworkPaths</span></a><span>
</span><a name="line-1665"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682424065"><a href="#local-6989586621682424065"><span class="hs-identifier">mb_fwk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">findFile</span><span> </span><a href="#local-6989586621682424063"><span class="hs-identifier hs-var">ps</span></a><span> </span><a href="#local-6989586621682424059"><span class="hs-identifier hs-var">fwk_file</span></a><span>
</span><a name="line-1666"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682424065"><span class="hs-identifier hs-var">mb_fwk</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1667"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682424066"><a href="#local-6989586621682424066"><span class="hs-identifier">fwk_path</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span> </span><a href="#local-6989586621682424056"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682424066"><span class="hs-identifier hs-var">fwk_path</span></a><span>
</span><a name="line-1668"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;not found&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1669"></a><span>                </span><span class="hs-comment">-- Tried all our known library paths, but dlopen()</span><span>
</span><a name="line-1670"></a><span>                </span><span class="hs-comment">-- has no built-in paths for frameworks: give up</span><span>
</span><a name="line-1671"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1672"></a><span>     </span><a name="local-6989586621682424059"><a href="#local-6989586621682424059"><span class="hs-identifier">fwk_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682424058"><span class="hs-identifier hs-var">rootname</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;framework&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621682424058"><span class="hs-identifier hs-var">rootname</span></a><span>
</span><a name="line-1673"></a><span>        </span><span class="hs-comment">-- sorry for the hardcoded paths, I hope they won't change anytime soon:</span><span>
</span><a name="line-1674"></a><span>     </span><a name="local-6989586621682424060"><a href="#local-6989586621682424060"><span class="hs-identifier">defaultFrameworkPaths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;/Library/Frameworks&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;/System/Library/Frameworks&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1675"></a><span>
</span><a name="line-1676"></a><span class="hs-comment">{- **********************************************************************

                Helper functions

  ********************************************************************* -}</span><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span class="hs-identifier">maybePutStr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1683"></a><a name="maybePutStr"><a href="Linker.html#maybePutStr"><span class="hs-identifier">maybePutStr</span></a></a><span> </span><a name="local-6989586621682424067"><a href="#local-6989586621682424067"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682424068"><a href="#local-6989586621682424068"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-1684"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">verbosity</span><span> </span><a href="#local-6989586621682424067"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1685"></a><span>          </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621682424067"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1686"></a><span>              </span><span class="hs-identifier hs-var">NoReason</span><span>
</span><a name="line-1687"></a><span>              </span><span class="hs-identifier hs-var">SevInteractive</span><span>
</span><a name="line-1688"></a><span>              </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-1689"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><a href="#local-6989586621682424067"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1690"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682424068"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>
</span><a name="line-1692"></a><span class="hs-identifier">maybePutStrLn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1693"></a><a name="maybePutStrLn"><a href="Linker.html#maybePutStrLn"><span class="hs-identifier">maybePutStrLn</span></a></a><span> </span><a name="local-6989586621682424069"><a href="#local-6989586621682424069"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682424070"><a href="#local-6989586621682424070"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Linker.html#maybePutStr"><span class="hs-identifier hs-var">maybePutStr</span></a><span> </span><a href="#local-6989586621682424069"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682424070"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1694"></a></pre></body></html>