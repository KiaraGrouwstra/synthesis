<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[RnExpr]{Renaming of expressions}

Basically dependency analysis.

Handles @Match@, @GRHSs@, @HsExpr@, and @Qualifier@ datatypes.  In
general, all of these functions return a renamed thing, and a set of
free variables.
-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RnExpr</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-20"></a><span>        </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span class="hs-special">,</span><span> </span><a href="RnExpr.html#rnExpr"><span class="hs-identifier hs-var">rnExpr</span></a><span class="hs-special">,</span><span> </span><a href="RnExpr.html#rnStmts"><span class="hs-identifier hs-var">rnStmts</span></a><span>
</span><a name="line-21"></a><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="RnBinds.html"><span class="hs-identifier">RnBinds</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="RnBinds.html#rnLocalBindsAndThen"><span class="hs-identifier hs-var">rnLocalBindsAndThen</span></a><span class="hs-special">,</span><span> </span><a href="RnBinds.html#rnLocalValBindsLHS"><span class="hs-identifier hs-var">rnLocalValBindsLHS</span></a><span class="hs-special">,</span><span> </span><a href="RnBinds.html#rnLocalValBindsRHS"><span class="hs-identifier hs-var">rnLocalValBindsRHS</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>                   </span><a href="RnBinds.html#rnMatchGroup"><span class="hs-identifier hs-var">rnMatchGroup</span></a><span class="hs-special">,</span><span> </span><a href="RnBinds.html#rnGRHS"><span class="hs-identifier hs-var">rnGRHS</span></a><span class="hs-special">,</span><span> </span><a href="RnBinds.html#makeMiniFixityEnv"><span class="hs-identifier hs-var">makeMiniFixityEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#isBrackStage"><span class="hs-identifier hs-var">isBrackStage</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getModule</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="RnFixity.html"><span class="hs-identifier">RnFixity</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#bindLocalNamesFV"><span class="hs-identifier hs-var">bindLocalNamesFV</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#checkDupNames"><span class="hs-identifier hs-var">checkDupNames</span></a><span>
</span><a name="line-36"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#bindLocalNames"><span class="hs-identifier hs-var">bindLocalNames</span></a><span>
</span><a name="line-37"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#mapMaybeFvRn"><span class="hs-identifier hs-var">mapMaybeFvRn</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span>
</span><a name="line-38"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#warnUnusedLocalBinds"><span class="hs-identifier hs-var">warnUnusedLocalBinds</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#typeAppErr"><span class="hs-identifier hs-var">typeAppErr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="RnUnbound.html"><span class="hs-identifier">RnUnbound</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="RnUnbound.html#reportUnboundName"><span class="hs-identifier hs-var">reportUnboundName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="RnSplice.html"><span class="hs-identifier">RnSplice</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="RnSplice.html#rnBracket"><span class="hs-identifier hs-var">rnBracket</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#rnSpliceExpr"><span class="hs-identifier hs-var">rnSpliceExpr</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#checkThLocalName"><span class="hs-identifier hs-var">checkThLocalName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="RnTypes.html"><span class="hs-identifier">RnTypes</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="RnPat.html"><span class="hs-identifier">RnPat</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">removeDups</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">nilDataConName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.List.NonEmpty</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkVarOccUnique</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsubsection{Expressions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-identifier">rnExprs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><a name="rnExprs"><a href="RnExpr.html#rnExprs"><span class="hs-identifier">rnExprs</span></a></a><span> </span><a name="local-6989586621682360247"><a href="#local-6989586621682360247"><span class="hs-identifier">ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360248"><span class="hs-identifier hs-var">rnExprs'</span></a><span> </span><a href="#local-6989586621682360247"><span class="hs-identifier hs-var">ls</span></a><span> </span><span class="hs-identifier hs-var">emptyUniqSet</span><span>
</span><a name="line-78"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-79"></a><span>  </span><a name="local-6989586621682360248"><a href="#local-6989586621682360248"><span class="hs-identifier">rnExprs'</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682360249"><a href="#local-6989586621682360249"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360249"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-identifier">rnExprs'</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360250"><a href="#local-6989586621682360250"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682360251"><a href="#local-6989586621682360251"><span class="hs-identifier">exprs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682360252"><a href="#local-6989586621682360252"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-81"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360253"><a href="#local-6989586621682360253"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360254"><a href="#local-6989586621682360254"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360250"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-82"></a><span>        </span><span class="hs-comment">-- Now we do a &quot;seq&quot; on the free vars because typically it's small</span><span>
</span><a name="line-83"></a><span>        </span><span class="hs-comment">-- or empty, especially in very long lists of constants</span><span>
</span><a name="line-84"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621682360255"><a href="#local-6989586621682360255"><span class="hs-identifier">acc'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360252"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360254"><span class="hs-identifier hs-var">fvExpr</span></a><span>
</span><a name="line-85"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360256"><a href="#local-6989586621682360256"><span class="hs-identifier">exprs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360257"><a href="#local-6989586621682360257"><span class="hs-identifier">fvExprs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360255"><span class="hs-identifier hs-var">acc'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360248"><span class="hs-identifier hs-var">rnExprs'</span></a><span> </span><a href="#local-6989586621682360251"><span class="hs-identifier hs-var">exprs</span></a><span> </span><a href="#local-6989586621682360255"><span class="hs-identifier hs-var">acc'</span></a><span>
</span><a name="line-86"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360253"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682360256"><span class="hs-identifier hs-var">exprs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360257"><span class="hs-identifier hs-var">fvExprs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">-- Variables. We look up the variable and return the resulting name.</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-identifier">rnLExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><a name="rnLExpr"><a href="RnExpr.html#rnLExpr"><span class="hs-identifier">rnLExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="RnExpr.html#rnExpr"><span class="hs-identifier hs-var">rnExpr</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">finishHsVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- Separated from rnExpr because it's also used</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- when renaming infix expressions</span><span>
</span><a name="line-98"></a><a name="finishHsVar"><a href="RnExpr.html#finishHsVar"><span class="hs-identifier">finishHsVar</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360258"><a href="#local-6989586621682360258"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360259"><a href="#local-6989586621682360259"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360260"><a href="#local-6989586621682360260"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-100"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682360260"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682360259"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-101"></a><span>        </span><a href="RnSplice.html#checkThLocalName"><span class="hs-identifier hs-var">checkThLocalName</span></a><span> </span><a href="#local-6989586621682360259"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-102"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360258"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360259"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621682360259"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">rnUnboundVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><a name="rnUnboundVar"><a href="RnExpr.html#rnUnboundVar"><span class="hs-identifier">rnUnboundVar</span></a></a><span> </span><a name="local-6989586621682360261"><a href="#local-6989586621682360261"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-106"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isUnqual</span><span> </span><a href="#local-6989586621682360261"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- Treat this as a &quot;hole&quot;</span><span>
</span><a name="line-108"></a><span>             </span><span class="hs-comment">-- Do not fail right now; instead, return HsUnboundVar</span><span>
</span><a name="line-109"></a><span>             </span><span class="hs-comment">-- and let the type checker report the error</span><span>
</span><a name="line-110"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360262"><a href="#local-6989586621682360262"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621682360261"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-111"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360263"><a href="#local-6989586621682360263"><span class="hs-identifier">uv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">startsWithUnderscore</span><span> </span><a href="#local-6989586621682360262"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-112"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TrueExprHole</span><span> </span><a href="#local-6989586621682360262"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">OutOfScope</span><span> </span><a href="#local-6989586621682360262"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-114"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsUnboundVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360263"><span class="hs-identifier hs-var">uv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Fail immediately (qualified name)</span><span>
</span><a name="line-117"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360264"><a href="#local-6989586621682360264"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUnbound.html#reportUnboundName"><span class="hs-identifier hs-var">reportUnboundName</span></a><span> </span><a href="#local-6989586621682360261"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-118"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682360264"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><a name="rnExpr"><a href="RnExpr.html#rnExpr"><span class="hs-identifier">rnExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360265"><a href="#local-6989586621682360265"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360266"><a href="#local-6989586621682360266"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360267"><a href="#local-6989586621682360267"><span class="hs-identifier">opt_DuplicateRecordFields</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DuplicateRecordFields</span><span>
</span><a name="line-122"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360268"><a href="#local-6989586621682360268"><span class="hs-identifier">mb_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupOccRn_overloaded"><span class="hs-identifier hs-var">lookupOccRn_overloaded</span></a><span> </span><a href="#local-6989586621682360267"><span class="hs-identifier hs-var">opt_DuplicateRecordFields</span></a><span> </span><a href="#local-6989586621682360266"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-123"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360268"><span class="hs-identifier hs-var">mb_name</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-124"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#rnUnboundVar"><span class="hs-identifier hs-var">rnUnboundVar</span></a><span> </span><a href="#local-6989586621682360266"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-125"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682360269"><a href="#local-6989586621682360269"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682360269"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">nilDataConName</span><span> </span><span class="hs-comment">-- Treat [] as an ExplicitList, so that</span><span>
</span><a name="line-127"></a><span>                                       </span><span class="hs-comment">-- OverloadedLists works correctly</span><span>
</span><a name="line-128"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#rnExpr"><span class="hs-identifier hs-var">rnExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-131"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#finishHsVar"><span class="hs-identifier hs-var">finishHsVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360265"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360269"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-132"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682360270"><a href="#local-6989586621682360270"><span class="hs-identifier">s</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-133"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a href="#local-6989586621682360270"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360265"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360266"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621682360270"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-134"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682360271"><a href="#local-6989586621682360271"><span class="hs-identifier">fs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-135"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ambiguous</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360265"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360266"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFVs</span><span> </span><a href="#local-6989586621682360271"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-137"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;runExpr/HsVar&quot;</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPVar</span><span> </span><a name="local-6989586621682360272"><a href="#local-6989586621682360272"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360273"><a href="#local-6989586621682360273"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPVar</span><span> </span><a href="#local-6989586621682360272"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360273"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span> </span><a name="local-6989586621682360274"><a href="#local-6989586621682360274"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360275"><a href="#local-6989586621682360275"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360276"><a href="#local-6989586621682360276"><span class="hs-identifier">rebindable_on</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.RebindableSyntax</span><span>
</span><a name="line-144"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682360276"><span class="hs-identifier hs-var">rebindable_on</span></a><span>
</span><a name="line-145"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360277"><a href="#local-6989586621682360277"><span class="hs-identifier">fromLabel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarUnqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;fromLabel&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span> </span><a href="#local-6989586621682360274"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682360277"><span class="hs-identifier hs-var">fromLabel</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360275"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621682360277"><span class="hs-identifier hs-var">fromLabel</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-147"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span> </span><a href="#local-6989586621682360274"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682360275"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><a name="local-6989586621682360278"><a href="#local-6989586621682360278"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360279"><a href="#local-6989586621682360279"><span class="hs-identifier">lit</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsString</span><span> </span><a name="local-6989586621682360280"><a href="#local-6989586621682360280"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621682360281"><a href="#local-6989586621682360281"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360282"><a href="#local-6989586621682360282"><span class="hs-identifier">opt_OverloadedStrings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span><span>
</span><a name="line-151"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682360282"><span class="hs-identifier hs-var">opt_OverloadedStrings</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-152"></a><span>            </span><a href="RnExpr.html#rnExpr"><span class="hs-identifier hs-var">rnExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><a href="#local-6989586621682360278"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsIsString</span><span> </span><a href="#local-6989586621682360280"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621682360281"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-154"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="RnPat.html#rnLit"><span class="hs-identifier hs-var">rnLit</span></a><span> </span><a href="#local-6989586621682360279"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-155"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><a href="#local-6989586621682360278"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">convertLit</span><span> </span><a href="#local-6989586621682360279"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><a name="local-6989586621682360283"><a href="#local-6989586621682360283"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360284"><a href="#local-6989586621682360284"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnPat.html#rnLit"><span class="hs-identifier hs-var">rnLit</span></a><span> </span><a href="#local-6989586621682360284"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-159"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><a href="#local-6989586621682360283"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">(</span><span class="hs-identifier hs-var">convertLit</span><span> </span><a href="#local-6989586621682360284"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><a name="local-6989586621682360285"><a href="#local-6989586621682360285"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360286"><a href="#local-6989586621682360286"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360287"><a href="#local-6989586621682360287"><span class="hs-identifier">lit'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360288"><a href="#local-6989586621682360288"><span class="hs-identifier">mb_neg</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360289"><a href="#local-6989586621682360289"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnPat.html#rnOverLit"><span class="hs-identifier hs-var">rnOverLit</span></a><span> </span><a href="#local-6989586621682360286"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-comment">-- See Note [Negative zero]</span><span>
</span><a name="line-163"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360288"><span class="hs-identifier hs-var">mb_neg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-164"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><a href="#local-6989586621682360285"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360287"><span class="hs-identifier hs-var">lit'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360289"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682360290"><a href="#local-6989586621682360290"><span class="hs-identifier">neg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><a href="#local-6989586621682360285"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682360290"><span class="hs-identifier hs-var">neg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><a href="#local-6989586621682360285"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360287"><span class="hs-identifier hs-var">lit'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360289"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><a name="local-6989586621682360291"><a href="#local-6989586621682360291"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360292"><a href="#local-6989586621682360292"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682360293"><a href="#local-6989586621682360293"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360294"><a href="#local-6989586621682360294"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360295"><a href="#local-6989586621682360295"><span class="hs-identifier">fvFun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360292"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-170"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360296"><a href="#local-6989586621682360296"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360297"><a href="#local-6989586621682360297"><span class="hs-identifier">fvArg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360293"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-171"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><a href="#local-6989586621682360291"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360294"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682360296"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360295"><span class="hs-identifier hs-var">fvFun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360297"><span class="hs-identifier hs-var">fvArg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><a name="local-6989586621682360298"><a href="#local-6989586621682360298"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360299"><a href="#local-6989586621682360299"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682360300"><a href="#local-6989586621682360300"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360301"><a href="#local-6989586621682360301"><span class="hs-identifier">type_app</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.TypeApplications</span><span>
</span><a name="line-175"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621682360301"><span class="hs-identifier hs-var">type_app</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnUtils.html#typeAppErr"><span class="hs-identifier hs-var">typeAppErr</span></a><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hswc_body</span><span> </span><a href="#local-6989586621682360300"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-176"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360302"><a href="#local-6989586621682360302"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360303"><a href="#local-6989586621682360303"><span class="hs-identifier">fvFun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360299"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-177"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360304"><a href="#local-6989586621682360304"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360305"><a href="#local-6989586621682360305"><span class="hs-identifier">fvArg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsWcType"><span class="hs-identifier hs-var">rnHsWcType</span></a><span> </span><a href="RnUtils.html#HsTypeCtx"><span class="hs-identifier hs-var">HsTypeCtx</span></a><span> </span><a href="#local-6989586621682360300"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-178"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><a href="#local-6989586621682360298"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360302"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682360304"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360303"><span class="hs-identifier hs-var">fvFun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360305"><span class="hs-identifier hs-var">fvArg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360306"><a href="#local-6989586621682360306"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621682360307"><a href="#local-6989586621682360307"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621682360308"><a href="#local-6989586621682360308"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360309"><a href="#local-6989586621682360309"><span class="hs-identifier">e1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360310"><a href="#local-6989586621682360310"><span class="hs-identifier">fv_e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360306"><span class="hs-identifier hs-var">e1</span></a><span>
</span><a name="line-182"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360311"><a href="#local-6989586621682360311"><span class="hs-identifier">e2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360312"><a href="#local-6989586621682360312"><span class="hs-identifier">fv_e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360308"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-183"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360313"><a href="#local-6989586621682360313"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360314"><a href="#local-6989586621682360314"><span class="hs-identifier">fv_op</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360307"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-comment">-- Deal with fixity</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-comment">-- When renaming code synthesised from &quot;deriving&quot; declarations</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-comment">-- we used to avoid fixity stuff, but we can't easily tell any</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-comment">-- more, so I've removed the test.  Adding HsPars in TcGenDeriv</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-comment">-- should prevent bad things happening.</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360317"><a href="#local-6989586621682360317"><span class="hs-identifier">fixity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360313"><span class="hs-identifier hs-var">op'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-191"></a><span>              </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360315"><a href="#local-6989586621682360315"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier hs-var">lookupFixityRn</span></a><span> </span><a href="#local-6989586621682360315"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-192"></a><span>              </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360316"><a href="#local-6989586621682360316"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnFixity.html#lookupFieldFixityRn"><span class="hs-identifier hs-var">lookupFieldFixityRn</span></a><span> </span><a href="#local-6989586621682360316"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-193"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-identifier hs-var">minPrecedence</span><span> </span><span class="hs-identifier hs-var">InfixL</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>                   </span><span class="hs-comment">-- c.f. lookupFixity for unbound</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360318"><a href="#local-6989586621682360318"><span class="hs-identifier">final_e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#mkOpAppRn"><span class="hs-identifier hs-var">mkOpAppRn</span></a><span> </span><a href="#local-6989586621682360309"><span class="hs-identifier hs-var">e1'</span></a><span> </span><a href="#local-6989586621682360313"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621682360317"><span class="hs-identifier hs-var">fixity</span></a><span> </span><a href="#local-6989586621682360311"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-197"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360318"><span class="hs-identifier hs-var">final_e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360310"><span class="hs-identifier hs-var">fv_e1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360314"><span class="hs-identifier hs-var">fv_op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360312"><span class="hs-identifier hs-var">fv_e2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360319"><a href="#local-6989586621682360319"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360320"><a href="#local-6989586621682360320"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360321"><a href="#local-6989586621682360321"><span class="hs-identifier">fv_e</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360319"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-201"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360322"><a href="#local-6989586621682360322"><span class="hs-identifier">neg_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360323"><a href="#local-6989586621682360323"><span class="hs-identifier">fv_neg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">negateName</span><span>
</span><a name="line-202"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360324"><a href="#local-6989586621682360324"><span class="hs-identifier">final_e</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#mkNegAppRn"><span class="hs-identifier hs-var">mkNegAppRn</span></a><span> </span><a href="#local-6989586621682360320"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621682360322"><span class="hs-identifier hs-var">neg_name</span></a><span>
</span><a name="line-203"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360324"><span class="hs-identifier hs-var">final_e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360321"><span class="hs-identifier hs-var">fv_e</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360323"><span class="hs-identifier hs-var">fv_neg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- Template Haskell extensions</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- Don't ifdef-GHCI them because we want to fail gracefully</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- (not with an rnExpr crash) in a stage-1 compiler.</span><span>
</span><a name="line-209"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360325"><a href="#local-6989586621682360325"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBracket</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360326"><a href="#local-6989586621682360326"><span class="hs-identifier">br_body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#rnBracket"><span class="hs-identifier hs-var">rnBracket</span></a><span> </span><a href="#local-6989586621682360325"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621682360326"><span class="hs-identifier hs-var">br_body</span></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360327"><a href="#local-6989586621682360327"><span class="hs-identifier">splice</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#rnSpliceExpr"><span class="hs-identifier hs-var">rnSpliceExpr</span></a><span> </span><a href="#local-6989586621682360327"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">---------------------------------------------</span><span>
</span><a name="line-214"></a><span class="hs-comment">--      Sections</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- See Note [Parsing sections] in Parser.y</span><span>
</span><a name="line-216"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a name="local-6989586621682360328"><a href="#local-6989586621682360328"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360329"><a href="#local-6989586621682360329"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682360330"><a href="#local-6989586621682360330"><span class="hs-identifier">section</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360331"><a href="#local-6989586621682360331"><span class="hs-identifier">section'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360332"><a href="#local-6989586621682360332"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnSection"><span class="hs-identifier hs-var">rnSection</span></a><span> </span><a href="#local-6989586621682360330"><span class="hs-identifier hs-var">section</span></a><span>
</span><a name="line-218"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a href="#local-6989586621682360328"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360329"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682360331"><span class="hs-identifier hs-var">section'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360332"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a name="local-6989586621682360333"><a href="#local-6989586621682360333"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360334"><a href="#local-6989586621682360334"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682360335"><a href="#local-6989586621682360335"><span class="hs-identifier">section</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360336"><a href="#local-6989586621682360336"><span class="hs-identifier">section'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360337"><a href="#local-6989586621682360337"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnSection"><span class="hs-identifier hs-var">rnSection</span></a><span> </span><a href="#local-6989586621682360335"><span class="hs-identifier hs-var">section</span></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a href="#local-6989586621682360333"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360334"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682360336"><span class="hs-identifier hs-var">section'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360337"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a name="local-6989586621682360338"><a href="#local-6989586621682360338"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360339"><a href="#local-6989586621682360339"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360340"><a href="#local-6989586621682360340"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360341"><a href="#local-6989586621682360341"><span class="hs-identifier">fvs_e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360339"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-226"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a href="#local-6989586621682360338"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360340"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360341"><span class="hs-identifier hs-var">fvs_e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360342"><a href="#local-6989586621682360342"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#sectionErr"><span class="hs-identifier hs-var">sectionErr</span></a><span> </span><a href="#local-6989586621682360342"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rnSection"><span class="hs-identifier hs-var">rnSection</span></a><span> </span><a href="#local-6989586621682360342"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-230"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360343"><a href="#local-6989586621682360343"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#sectionErr"><span class="hs-identifier hs-var">sectionErr</span></a><span> </span><a href="#local-6989586621682360343"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rnSection"><span class="hs-identifier hs-var">rnSection</span></a><span> </span><a href="#local-6989586621682360343"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-comment">---------------------------------------------</span><span>
</span><a name="line-234"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCoreAnn</span><span> </span><a name="local-6989586621682360344"><a href="#local-6989586621682360344"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360345"><a href="#local-6989586621682360345"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621682360346"><a href="#local-6989586621682360346"><span class="hs-identifier">ann</span></a></a><span> </span><a name="local-6989586621682360347"><a href="#local-6989586621682360347"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360348"><a href="#local-6989586621682360348"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360349"><a href="#local-6989586621682360349"><span class="hs-identifier">fvs_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360347"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-236"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCoreAnn</span><span> </span><a href="#local-6989586621682360344"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360345"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621682360346"><span class="hs-identifier hs-var">ann</span></a><span> </span><a href="#local-6989586621682360348"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360349"><span class="hs-identifier hs-var">fvs_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSCC</span><span> </span><a name="local-6989586621682360350"><a href="#local-6989586621682360350"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360351"><a href="#local-6989586621682360351"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621682360352"><a href="#local-6989586621682360352"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621682360353"><a href="#local-6989586621682360353"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360354"><a href="#local-6989586621682360354"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360355"><a href="#local-6989586621682360355"><span class="hs-identifier">fvs_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360353"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-240"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSCC</span><span> </span><a href="#local-6989586621682360350"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360351"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621682360352"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621682360354"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360355"><span class="hs-identifier hs-var">fvs_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-241"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTickPragma</span><span> </span><a name="local-6989586621682360356"><a href="#local-6989586621682360356"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360357"><a href="#local-6989586621682360357"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621682360358"><a href="#local-6989586621682360358"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621682360359"><a href="#local-6989586621682360359"><span class="hs-identifier">srcInfo</span></a></a><span> </span><a name="local-6989586621682360360"><a href="#local-6989586621682360360"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360361"><a href="#local-6989586621682360361"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360362"><a href="#local-6989586621682360362"><span class="hs-identifier">fvs_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360360"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-243"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTickPragma</span><span> </span><a href="#local-6989586621682360356"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360357"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621682360358"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621682360359"><span class="hs-identifier hs-var">srcInfo</span></a><span> </span><a href="#local-6989586621682360361"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360362"><span class="hs-identifier hs-var">fvs_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLam</span><span> </span><a name="local-6989586621682360363"><a href="#local-6989586621682360363"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360364"><a href="#local-6989586621682360364"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360365"><a href="#local-6989586621682360365"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360366"><a href="#local-6989586621682360366"><span class="hs-identifier">fvMatch</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMatchGroup"><span class="hs-identifier hs-var">rnMatchGroup</span></a><span> </span><span class="hs-identifier hs-var">LambdaExpr</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360364"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-247"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLam</span><span> </span><a href="#local-6989586621682360363"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360365"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360366"><span class="hs-identifier hs-var">fvMatch</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLamCase</span><span> </span><a name="local-6989586621682360367"><a href="#local-6989586621682360367"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360368"><a href="#local-6989586621682360368"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360369"><a href="#local-6989586621682360369"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360370"><a href="#local-6989586621682360370"><span class="hs-identifier">fvs_ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMatchGroup"><span class="hs-identifier hs-var">rnMatchGroup</span></a><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360368"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-251"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLamCase</span><span> </span><a href="#local-6989586621682360367"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360369"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360370"><span class="hs-identifier hs-var">fvs_ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCase</span><span> </span><a name="local-6989586621682360371"><a href="#local-6989586621682360371"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360372"><a href="#local-6989586621682360372"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621682360373"><a href="#local-6989586621682360373"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360374"><a href="#local-6989586621682360374"><span class="hs-identifier">new_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360375"><a href="#local-6989586621682360375"><span class="hs-identifier">e_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360372"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-255"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360376"><a href="#local-6989586621682360376"><span class="hs-identifier">new_matches</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360377"><a href="#local-6989586621682360377"><span class="hs-identifier">ms_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMatchGroup"><span class="hs-identifier hs-var">rnMatchGroup</span></a><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360373"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-256"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCase</span><span> </span><a href="#local-6989586621682360371"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360374"><span class="hs-identifier hs-var">new_expr</span></a><span> </span><a href="#local-6989586621682360376"><span class="hs-identifier hs-var">new_matches</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360375"><span class="hs-identifier hs-var">e_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360377"><span class="hs-identifier hs-var">ms_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLet</span><span> </span><a name="local-6989586621682360378"><a href="#local-6989586621682360378"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360379"><a href="#local-6989586621682360379"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360380"><a href="#local-6989586621682360380"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682360381"><a href="#local-6989586621682360381"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnBinds.html#rnLocalBindsAndThen"><span class="hs-identifier hs-var">rnLocalBindsAndThen</span></a><span> </span><a href="#local-6989586621682360380"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682360382"><a href="#local-6989586621682360382"><span class="hs-identifier">binds'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-260"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360383"><a href="#local-6989586621682360383"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360384"><a href="#local-6989586621682360384"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360381"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-261"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLet</span><span> </span><a href="#local-6989586621682360378"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360379"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360382"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360383"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360384"><span class="hs-identifier hs-var">fvExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a name="local-6989586621682360385"><a href="#local-6989586621682360385"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360386"><a href="#local-6989586621682360386"><span class="hs-identifier">do_or_lc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360387"><a href="#local-6989586621682360387"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360388"><a href="#local-6989586621682360388"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360389"><a href="#local-6989586621682360389"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360390"><a href="#local-6989586621682360390"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-265"></a><span>           </span><a href="RnExpr.html#rnStmtsWithPostProcessing"><span class="hs-identifier hs-var">rnStmtsWithPostProcessing</span></a><span> </span><a href="#local-6989586621682360386"><span class="hs-identifier hs-var">do_or_lc</span></a><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span>
</span><a name="line-266"></a><span>             </span><a href="RnExpr.html#postProcessStmtsForApplicativeDo"><span class="hs-identifier hs-var">postProcessStmtsForApplicativeDo</span></a><span> </span><a href="#local-6989586621682360388"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-267"></a><span>             </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621682360385"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360386"><span class="hs-identifier hs-var">do_or_lc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360387"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360389"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360390"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a name="local-6989586621682360391"><a href="#local-6989586621682360391"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621682360392"><a href="#local-6989586621682360392"><span class="hs-identifier">exps</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360393"><a href="#local-6989586621682360393"><span class="hs-identifier">opt_OverloadedLists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedLists</span><span>
</span><a name="line-272"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360394"><a href="#local-6989586621682360394"><span class="hs-identifier">exps'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360395"><a href="#local-6989586621682360395"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnExprs"><span class="hs-identifier hs-var">rnExprs</span></a><span> </span><a href="#local-6989586621682360392"><span class="hs-identifier hs-var">exps</span></a><span>
</span><a name="line-273"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682360393"><span class="hs-identifier hs-var">opt_OverloadedLists</span></a><span>
</span><a name="line-274"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-275"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360396"><a href="#local-6989586621682360396"><span class="hs-identifier">from_list_n_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360397"><a href="#local-6989586621682360397"><span class="hs-identifier">fvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">fromListNName</span><span>
</span><a name="line-276"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a href="#local-6989586621682360391"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682360396"><span class="hs-identifier hs-var">from_list_n_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360394"><span class="hs-identifier hs-var">exps'</span></a><span>
</span><a name="line-277"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360395"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360397"><span class="hs-identifier hs-var">fvs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-278"></a><span>           </span><span class="hs-keyword">else</span><span>
</span><a name="line-279"></a><span>            </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a href="#local-6989586621682360391"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682360394"><span class="hs-identifier hs-var">exps'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360395"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><a name="local-6989586621682360398"><a href="#local-6989586621682360398"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360399"><a href="#local-6989586621682360399"><span class="hs-identifier">tup_args</span></a></a><span> </span><a name="local-6989586621682360400"><a href="#local-6989586621682360400"><span class="hs-identifier">boxity</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnExpr.html#checkTupleSection"><span class="hs-identifier hs-var">checkTupleSection</span></a><span> </span><a href="#local-6989586621682360399"><span class="hs-identifier hs-var">tup_args</span></a><span>
</span><a name="line-283"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#checkTupSize"><span class="hs-identifier hs-var">checkTupSize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682360399"><span class="hs-identifier hs-var">tup_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360408"><a href="#local-6989586621682360408"><span class="hs-identifier">tup_args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360409"><a href="#local-6989586621682360409"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><a href="#local-6989586621682360401"><span class="hs-identifier hs-var">rnTupArg</span></a><span> </span><a href="#local-6989586621682360399"><span class="hs-identifier hs-var">tup_args</span></a><span>
</span><a name="line-285"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><a href="#local-6989586621682360398"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360408"><span class="hs-identifier hs-var">tup_args'</span></a><span> </span><a href="#local-6989586621682360400"><span class="hs-identifier hs-var">boxity</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360409"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-286"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-287"></a><span>    </span><a name="local-6989586621682360401"><a href="#local-6989586621682360401"><span class="hs-identifier">rnTupArg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360402"><a href="#local-6989586621682360402"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><a name="local-6989586621682360403"><a href="#local-6989586621682360403"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360404"><a href="#local-6989586621682360404"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360405"><a href="#local-6989586621682360405"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360406"><a href="#local-6989586621682360406"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360404"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-288"></a><span>                                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360402"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><a href="#local-6989586621682360403"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360405"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360406"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-identifier">rnTupArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360407"><a href="#local-6989586621682360407"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360407"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>    </span><span class="hs-identifier">rnTupArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTupArg</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnExpr.XTupArg&quot;</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><a name="local-6989586621682360410"><a href="#local-6989586621682360410"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360411"><a href="#local-6989586621682360411"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621682360412"><a href="#local-6989586621682360412"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621682360413"><a href="#local-6989586621682360413"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360414"><a href="#local-6989586621682360414"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360415"><a href="#local-6989586621682360415"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360413"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-295"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><a href="#local-6989586621682360410"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360411"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621682360412"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682360414"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360415"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360416"><a href="#local-6989586621682360416"><span class="hs-identifier">con_id</span></a></a><span>
</span><a name="line-298"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360417"><a href="#local-6989586621682360417"><span class="hs-identifier">rec_binds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rec_dotdot</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360418"><a href="#local-6989586621682360418"><span class="hs-identifier">dd</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360427"><a href="#local-6989586621682360427"><span class="hs-identifier">con_lname</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360428"><a href="#local-6989586621682360428"><span class="hs-identifier">con_name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedOccRn"><span class="hs-identifier hs-var">lookupLocatedOccRn</span></a><span> </span><a href="#local-6989586621682360416"><span class="hs-identifier hs-var">con_id</span></a><span>
</span><a name="line-300"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360429"><a href="#local-6989586621682360429"><span class="hs-identifier">flds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360430"><a href="#local-6989586621682360430"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnPat.html#rnHsRecFields"><span class="hs-identifier hs-var">rnHsRecFields</span></a><span> </span><span class="hs-special">(</span><a href="RnPat.html#HsRecFieldCon"><span class="hs-identifier hs-var">HsRecFieldCon</span></a><span> </span><a href="#local-6989586621682360428"><span class="hs-identifier hs-var">con_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360419"><span class="hs-identifier hs-var">mk_hs_var</span></a><span> </span><a href="#local-6989586621682360417"><span class="hs-identifier hs-var">rec_binds</span></a><span>
</span><a name="line-301"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360431"><a href="#local-6989586621682360431"><span class="hs-identifier">flds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360432"><a href="#local-6989586621682360432"><span class="hs-identifier">fvss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><a href="#local-6989586621682360420"><span class="hs-identifier hs-var">rn_field</span></a><span> </span><a href="#local-6989586621682360429"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-302"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360433"><a href="#local-6989586621682360433"><span class="hs-identifier">rec_binds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rec_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360431"><span class="hs-identifier hs-var">flds'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rec_dotdot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360418"><span class="hs-identifier hs-var">dd</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-303"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-304"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360427"><span class="hs-identifier hs-var">con_lname</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360433"><span class="hs-identifier hs-var">rec_binds'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-305"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360430"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360432"><span class="hs-identifier hs-var">fvss</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360428"><span class="hs-identifier hs-var">con_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-307"></a><span>    </span><a name="local-6989586621682360419"><a href="#local-6989586621682360419"><span class="hs-identifier">mk_hs_var</span></a></a><span> </span><a name="local-6989586621682360421"><a href="#local-6989586621682360421"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360422"><a href="#local-6989586621682360422"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360421"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360422"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>    </span><a name="local-6989586621682360420"><a href="#local-6989586621682360420"><span class="hs-identifier">rn_field</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360423"><a href="#local-6989586621682360423"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360424"><a href="#local-6989586621682360424"><span class="hs-identifier">fld</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360425"><a href="#local-6989586621682360425"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360426"><a href="#local-6989586621682360426"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsRecFieldArg</span><span> </span><a href="#local-6989586621682360424"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360423"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360424"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360425"><span class="hs-identifier hs-var">arg'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360426"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordUpd</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360434"><a href="#local-6989586621682360434"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360435"><a href="#local-6989586621682360435"><span class="hs-identifier">rbinds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360436"><a href="#local-6989586621682360436"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360437"><a href="#local-6989586621682360437"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360434"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-313"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360438"><a href="#local-6989586621682360438"><span class="hs-identifier">rbinds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360439"><a href="#local-6989586621682360439"><span class="hs-identifier">fvRbinds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnPat.html#rnHsRecUpdFields"><span class="hs-identifier hs-var">rnHsRecUpdFields</span></a><span> </span><a href="#local-6989586621682360435"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-314"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordUpd</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360436"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-315"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360438"><span class="hs-identifier hs-var">rbinds'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-316"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360437"><span class="hs-identifier hs-var">fvExpr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360439"><span class="hs-identifier hs-var">fvRbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360440"><a href="#local-6989586621682360440"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621682360441"><a href="#local-6989586621682360441"><span class="hs-identifier">pty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360442"><a href="#local-6989586621682360442"><span class="hs-identifier">pty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360443"><a href="#local-6989586621682360443"><span class="hs-identifier">fvTy</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsSigWcType"><span class="hs-identifier hs-var">rnHsSigWcType</span></a><span> </span><a href="RnTypes.html#BindUnlessForall"><span class="hs-identifier hs-var">BindUnlessForall</span></a><span> </span><a href="RnUtils.html#ExprWithTySigCtx"><span class="hs-identifier hs-var">ExprWithTySigCtx</span></a><span> </span><a href="#local-6989586621682360441"><span class="hs-identifier hs-var">pty</span></a><span>
</span><a name="line-320"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360444"><a href="#local-6989586621682360444"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360445"><a href="#local-6989586621682360445"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#bindSigTyVarsFV"><span class="hs-identifier hs-var">bindSigTyVarsFV</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsWcScopedTvs</span><span> </span><a href="#local-6989586621682360442"><span class="hs-identifier hs-var">pty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-321"></a><span>                             </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360440"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-322"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360444"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621682360442"><span class="hs-identifier hs-var">pty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360445"><span class="hs-identifier hs-var">fvExpr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360443"><span class="hs-identifier hs-var">fvTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><a name="local-6989586621682360446"><a href="#local-6989586621682360446"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360447"><a href="#local-6989586621682360447"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621682360448"><a href="#local-6989586621682360448"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-6989586621682360449"><a href="#local-6989586621682360449"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360450"><a href="#local-6989586621682360450"><span class="hs-identifier">p'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360451"><a href="#local-6989586621682360451"><span class="hs-identifier">fvP</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360447"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-326"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360452"><a href="#local-6989586621682360452"><span class="hs-identifier">b1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360453"><a href="#local-6989586621682360453"><span class="hs-identifier">fvB1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360448"><span class="hs-identifier hs-var">b1</span></a><span>
</span><a name="line-327"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360454"><a href="#local-6989586621682360454"><span class="hs-identifier">b2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360455"><a href="#local-6989586621682360455"><span class="hs-identifier">fvB2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360449"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-328"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360456"><a href="#local-6989586621682360456"><span class="hs-identifier">mb_ite</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360457"><a href="#local-6989586621682360457"><span class="hs-identifier">fvITE</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupIfThenElse"><span class="hs-identifier hs-var">lookupIfThenElse</span></a><span>
</span><a name="line-329"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><a href="#local-6989586621682360446"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360456"><span class="hs-identifier hs-var">mb_ite</span></a><span> </span><a href="#local-6989586621682360450"><span class="hs-identifier hs-var">p'</span></a><span> </span><a href="#local-6989586621682360452"><span class="hs-identifier hs-var">b1'</span></a><span> </span><a href="#local-6989586621682360454"><span class="hs-identifier hs-var">b2'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682360457"><span class="hs-identifier hs-var">fvITE</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360451"><span class="hs-identifier hs-var">fvP</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360453"><span class="hs-identifier hs-var">fvB1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360455"><span class="hs-identifier hs-var">fvB2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsMultiIf</span><span> </span><a name="local-6989586621682360458"><a href="#local-6989586621682360458"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360459"><a href="#local-6989586621682360459"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360460"><a href="#local-6989586621682360460"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360461"><a href="#local-6989586621682360461"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span> </span><span class="hs-special">(</span><a href="RnBinds.html#rnGRHS"><span class="hs-identifier hs-var">rnGRHS</span></a><span> </span><span class="hs-identifier hs-var">IfAlt</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360459"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-333"></a><span>       </span><span class="hs-comment">-- ; return (HsMultiIf ty alts', fvs) }</span><span>
</span><a name="line-334"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsMultiIf</span><span> </span><a href="#local-6989586621682360458"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360460"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360461"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a name="local-6989586621682360462"><a href="#local-6989586621682360462"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360463"><a href="#local-6989586621682360463"><span class="hs-identifier">seq</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360464"><a href="#local-6989586621682360464"><span class="hs-identifier">opt_OverloadedLists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedLists</span><span>
</span><a name="line-338"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360465"><a href="#local-6989586621682360465"><span class="hs-identifier">new_seq</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360466"><a href="#local-6989586621682360466"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnArithSeq"><span class="hs-identifier hs-var">rnArithSeq</span></a><span> </span><a href="#local-6989586621682360463"><span class="hs-identifier hs-var">seq</span></a><span>
</span><a name="line-339"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682360464"><span class="hs-identifier hs-var">opt_OverloadedLists</span></a><span>
</span><a name="line-340"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-341"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360467"><a href="#local-6989586621682360467"><span class="hs-identifier">from_list_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360468"><a href="#local-6989586621682360468"><span class="hs-identifier">fvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">fromListName</span><span>
</span><a name="line-342"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a href="#local-6989586621682360462"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682360467"><span class="hs-identifier hs-var">from_list_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360465"><span class="hs-identifier hs-var">new_seq</span></a><span>
</span><a name="line-343"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360466"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360468"><span class="hs-identifier hs-var">fvs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-344"></a><span>           </span><span class="hs-keyword">else</span><span>
</span><a name="line-345"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a href="#local-6989586621682360462"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682360465"><span class="hs-identifier hs-var">new_seq</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360466"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-comment">{-
These three are pattern syntax appearing in expressions.
Since all the symbols are reservedops we can simply reject them.
We return a (bogus) EWildPat in each case.
-}</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EWildPat</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#hsHoleExpr"><span class="hs-identifier hs-var">hsHoleExpr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- &quot;_&quot; is just a hole</span><span>
</span><a name="line-354"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360469"><a href="#local-6989586621682360469"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">EAsPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360470"><a href="#local-6989586621682360470"><span class="hs-identifier">opt_TypeApplications</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.TypeApplications</span><span>
</span><a name="line-356"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360471"><a href="#local-6989586621682360471"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682360470"><span class="hs-identifier hs-var">opt_TypeApplications</span></a><span>
</span><a name="line-357"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Type application syntax requires a space before '@'&quot;</span><span>
</span><a name="line-358"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-359"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Did you mean to enable TypeApplications?&quot;</span><span>
</span><a name="line-360"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#patSynErr"><span class="hs-identifier hs-var">patSynErr</span></a><span> </span><a href="#local-6989586621682360469"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682360471"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-362"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360472"><a href="#local-6989586621682360472"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">EViewPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#patSynErr"><span class="hs-identifier hs-var">patSynErr</span></a><span> </span><a href="#local-6989586621682360472"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-363"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360473"><a href="#local-6989586621682360473"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ELazyPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#patSynErr"><span class="hs-identifier hs-var">patSynErr</span></a><span> </span><a href="#local-6989586621682360473"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Static values
*                                                                      *
************************************************************************

For the static form we check that it is not used in splices.
We also collect the free variables of the term which come from
this module. See Note [Grand plan for static forms] in StaticPtrTable.
-}</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360474"><a href="#local-6989586621682360474"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStatic</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360475"><a href="#local-6989586621682360475"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-378"></a><span>    </span><span class="hs-comment">-- Normally, you wouldn't be able to construct a static expression without</span><span>
</span><a name="line-379"></a><span>    </span><span class="hs-comment">-- first enabling -XStaticPointers in the first place, since that extension</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-comment">-- is what makes the parser treat `static` as a keyword. But this is not a</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-comment">-- sufficient safeguard, as one can construct static expressions by another</span><span>
</span><a name="line-382"></a><span>    </span><span class="hs-comment">-- mechanism: Template Haskell (see #14204). To ensure that GHC is</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-comment">-- absolutely prepared to cope with static forms, we check for</span><span>
</span><a name="line-384"></a><span>    </span><span class="hs-comment">-- -XStaticPointers here as well.</span><span>
</span><a name="line-385"></a><span>    </span><a href="TcRnMonad.html#unlessXOptM"><span class="hs-identifier hs-var">unlessXOptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.StaticPointers</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-386"></a><span>      </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal static expression:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360474"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>                  </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use StaticPointers to enable this extension&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682360476"><a href="#local-6989586621682360476"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360477"><a href="#local-6989586621682360477"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360475"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-389"></a><span>    </span><a name="local-6989586621682360478"><a href="#local-6989586621682360478"><span class="hs-identifier">stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-390"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360478"><span class="hs-identifier hs-var">stage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-391"></a><span>      </span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sep</span><span>
</span><a name="line-392"></a><span>             </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;static forms cannot be used in splices:&quot;</span><span>
</span><a name="line-393"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360474"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-394"></a><span>             </span><span class="hs-special">]</span><span>
</span><a name="line-395"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>    </span><a name="local-6989586621682360479"><a href="#local-6989586621682360479"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360480"><a href="#local-6989586621682360480"><span class="hs-identifier">fvExpr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682360479"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360477"><span class="hs-identifier hs-var">fvExpr</span></a><span>
</span><a name="line-398"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStatic</span><span> </span><a href="#local-6989586621682360480"><span class="hs-identifier hs-var">fvExpr'</span></a><span> </span><a href="#local-6989586621682360476"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360477"><span class="hs-identifier hs-var">fvExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Arrow notation
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">rnExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsProc</span><span> </span><a name="local-6989586621682360481"><a href="#local-6989586621682360481"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360482"><a href="#local-6989586621682360482"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682360483"><a href="#local-6989586621682360483"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#newArrowScope"><span class="hs-identifier hs-var">newArrowScope</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-410"></a><span>    </span><a href="RnPat.html#rnPat"><span class="hs-identifier hs-var">rnPat</span></a><span> </span><span class="hs-identifier hs-var">ProcExpr</span><span> </span><a href="#local-6989586621682360482"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360484"><a href="#local-6989586621682360484"><span class="hs-identifier">pat'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360485"><a href="#local-6989586621682360485"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360486"><a href="#local-6989586621682360486"><span class="hs-identifier">fvBody</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnCmdTop"><span class="hs-identifier hs-var">rnCmdTop</span></a><span> </span><a href="#local-6989586621682360483"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-412"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsProc</span><span> </span><a href="#local-6989586621682360481"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360484"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621682360485"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360486"><span class="hs-identifier hs-var">fvBody</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-comment">-- Ideally, these would be done in parsing, but to keep parsing simple, we do it here.</span><span>
</span><a name="line-415"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360487"><a href="#local-6989586621682360487"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArrApp</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#arrowFail"><span class="hs-identifier hs-var">arrowFail</span></a><span> </span><a href="#local-6989586621682360487"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-416"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360488"><a href="#local-6989586621682360488"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArrForm</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#arrowFail"><span class="hs-identifier hs-var">arrowFail</span></a><span> </span><a href="#local-6989586621682360488"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-identifier">rnExpr</span><span> </span><a name="local-6989586621682360489"><a href="#local-6989586621682360489"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnExpr: unexpected expression&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360489"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>        </span><span class="hs-comment">-- HsWrap</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-identifier">hsHoleExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682360246"><span class="hs-identifier hs-type">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-422"></a><a name="hsHoleExpr"><a href="RnExpr.html#hsHoleExpr"><span class="hs-identifier">hsHoleExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsUnboundVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TrueExprHole</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOcc</span><span> </span><span class="hs-string">&quot;_&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-identifier">arrowFail</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-425"></a><a name="arrowFail"><a href="RnExpr.html#arrowFail"><span class="hs-identifier">arrowFail</span></a></a><span> </span><a name="local-6989586621682360490"><a href="#local-6989586621682360490"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-426"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Arrow command found where an expression was expected:&quot;</span><span>
</span><a name="line-427"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360490"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>         </span><span class="hs-comment">-- Return a place-holder hole, so that we can carry on</span><span>
</span><a name="line-429"></a><span>         </span><span class="hs-comment">-- to report other errors</span><span>
</span><a name="line-430"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#hsHoleExpr"><span class="hs-identifier hs-var">hsHoleExpr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- See Note [Parsing sections] in Parser.y</span><span>
</span><a name="line-434"></a><span class="hs-identifier">rnSection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><a name="rnSection"><a href="RnExpr.html#rnSection"><span class="hs-identifier">rnSection</span></a></a><span> </span><a name="local-6989586621682360491"><a href="#local-6989586621682360491"><span class="hs-identifier">section</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><a name="local-6989586621682360492"><a href="#local-6989586621682360492"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360493"><a href="#local-6989586621682360493"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621682360494"><a href="#local-6989586621682360494"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360495"><a href="#local-6989586621682360495"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360496"><a href="#local-6989586621682360496"><span class="hs-identifier">fvs_op</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360493"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-437"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360497"><a href="#local-6989586621682360497"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360498"><a href="#local-6989586621682360498"><span class="hs-identifier">fvs_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360494"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-438"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#checkSectionPrec"><span class="hs-identifier hs-var">checkSectionPrec</span></a><span> </span><span class="hs-identifier hs-var">InfixR</span><span> </span><a href="#local-6989586621682360491"><span class="hs-identifier hs-var">section</span></a><span> </span><a href="#local-6989586621682360495"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621682360497"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-439"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><a href="#local-6989586621682360492"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360495"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621682360497"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360496"><span class="hs-identifier hs-var">fvs_op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360498"><span class="hs-identifier hs-var">fvs_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span class="hs-identifier">rnSection</span><span> </span><a name="local-6989586621682360499"><a href="#local-6989586621682360499"><span class="hs-identifier">section</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><a name="local-6989586621682360500"><a href="#local-6989586621682360500"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360501"><a href="#local-6989586621682360501"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621682360502"><a href="#local-6989586621682360502"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360503"><a href="#local-6989586621682360503"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360504"><a href="#local-6989586621682360504"><span class="hs-identifier">fvs_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360501"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-443"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360505"><a href="#local-6989586621682360505"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360506"><a href="#local-6989586621682360506"><span class="hs-identifier">fvs_op</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360502"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-444"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#checkSectionPrec"><span class="hs-identifier hs-var">checkSectionPrec</span></a><span> </span><span class="hs-identifier hs-var">InfixL</span><span> </span><a href="#local-6989586621682360499"><span class="hs-identifier hs-var">section</span></a><span> </span><a href="#local-6989586621682360505"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621682360503"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-445"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><a href="#local-6989586621682360500"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360503"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621682360505"><span class="hs-identifier hs-var">op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360506"><span class="hs-identifier hs-var">fvs_op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360504"><span class="hs-identifier hs-var">fvs_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-identifier">rnSection</span><span> </span><a name="local-6989586621682360507"><a href="#local-6989586621682360507"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnSection&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360507"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Arrow commands
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-identifier">rnCmdArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsCmdTop</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsCmdTop</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><a name="rnCmdArgs"><a href="RnExpr.html#rnCmdArgs"><span class="hs-identifier">rnCmdArgs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span class="hs-identifier">rnCmdArgs</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360508"><a href="#local-6989586621682360508"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682360509"><a href="#local-6989586621682360509"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360510"><a href="#local-6989586621682360510"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360511"><a href="#local-6989586621682360511"><span class="hs-identifier">fvArg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnCmdTop"><span class="hs-identifier hs-var">rnCmdTop</span></a><span> </span><a href="#local-6989586621682360508"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-461"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360512"><a href="#local-6989586621682360512"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360513"><a href="#local-6989586621682360513"><span class="hs-identifier">fvArgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnCmdArgs"><span class="hs-identifier hs-var">rnCmdArgs</span></a><span> </span><a href="#local-6989586621682360509"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-462"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360510"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682360512"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360511"><span class="hs-identifier hs-var">fvArg</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360513"><span class="hs-identifier hs-var">fvArgs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span class="hs-identifier">rnCmdTop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsCmdTop</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmdTop</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-465"></a><a name="rnCmdTop"><a href="RnExpr.html#rnCmdTop"><span class="hs-identifier">rnCmdTop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="#local-6989586621682360514"><span class="hs-identifier hs-var">rnCmdTop'</span></a><span>
</span><a name="line-466"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-467"></a><span>  </span><a name="local-6989586621682360514"><a href="#local-6989586621682360514"><span class="hs-identifier">rnCmdTop'</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdTop</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360515"><a href="#local-6989586621682360515"><span class="hs-identifier">cmd</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360516"><a href="#local-6989586621682360516"><span class="hs-identifier">cmd'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360517"><a href="#local-6989586621682360517"><span class="hs-identifier">fvCmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360515"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-469"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360518"><a href="#local-6989586621682360518"><span class="hs-identifier">cmd_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">arrAName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">composeAName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">firstAName</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-470"></a><span>                          </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#methodNamesCmd"><span class="hs-identifier hs-var">methodNamesCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682360516"><span class="hs-identifier hs-var">cmd'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>        </span><span class="hs-comment">-- Generate the rebindable syntax for the monad</span><span>
</span><a name="line-472"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360519"><a href="#local-6989586621682360519"><span class="hs-identifier">cmd_names'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360520"><a href="#local-6989586621682360520"><span class="hs-identifier">cmd_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxNames"><span class="hs-identifier hs-var">lookupSyntaxNames</span></a><span> </span><a href="#local-6989586621682360518"><span class="hs-identifier hs-var">cmd_names</span></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdTop</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360518"><span class="hs-identifier hs-var">cmd_names</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360519"><span class="hs-identifier hs-var">cmd_names'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360516"><span class="hs-identifier hs-var">cmd'</span></a><span class="hs-special">,</span><span>
</span><a name="line-475"></a><span>                  </span><a href="#local-6989586621682360517"><span class="hs-identifier hs-var">fvCmd</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360520"><span class="hs-identifier hs-var">cmd_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-476"></a><span>  </span><span class="hs-identifier">rnCmdTop'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XCmdTop</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnCmdTop&quot;</span><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span class="hs-identifier">rnLCmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-479"></a><a name="rnLCmd"><a href="RnExpr.html#rnLCmd"><span class="hs-identifier">rnLCmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="RnExpr.html#rnCmd"><span class="hs-identifier hs-var">rnCmd</span></a><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsCmd</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><a name="rnCmd"><a href="RnExpr.html#rnCmd"><span class="hs-identifier">rnCmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrApp</span><span> </span><a name="local-6989586621682360521"><a href="#local-6989586621682360521"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360522"><a href="#local-6989586621682360522"><span class="hs-identifier">arrow</span></a></a><span> </span><a name="local-6989586621682360523"><a href="#local-6989586621682360523"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682360524"><a href="#local-6989586621682360524"><span class="hs-identifier">ho</span></a></a><span> </span><a name="local-6989586621682360525"><a href="#local-6989586621682360525"><span class="hs-identifier">rtl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360528"><a href="#local-6989586621682360528"><span class="hs-identifier">arrow'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360529"><a href="#local-6989586621682360529"><span class="hs-identifier">fvArrow</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360526"><span class="hs-identifier hs-var">select_arrow_scope</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360522"><span class="hs-identifier hs-var">arrow</span></a><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360530"><a href="#local-6989586621682360530"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360531"><a href="#local-6989586621682360531"><span class="hs-identifier">fvArg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360523"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-486"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrApp</span><span> </span><a href="#local-6989586621682360521"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360528"><span class="hs-identifier hs-var">arrow'</span></a><span> </span><a href="#local-6989586621682360530"><span class="hs-identifier hs-var">arg'</span></a><span> </span><a href="#local-6989586621682360524"><span class="hs-identifier hs-var">ho</span></a><span> </span><a href="#local-6989586621682360525"><span class="hs-identifier hs-var">rtl</span></a><span class="hs-special">,</span><span>
</span><a name="line-487"></a><span>                 </span><a href="#local-6989586621682360529"><span class="hs-identifier hs-var">fvArrow</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360531"><span class="hs-identifier hs-var">fvArg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-489"></a><span>    </span><a name="local-6989586621682360526"><a href="#local-6989586621682360526"><span class="hs-identifier">select_arrow_scope</span></a></a><span> </span><a name="local-6989586621682360527"><a href="#local-6989586621682360527"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360524"><span class="hs-identifier hs-var">ho</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-490"></a><span>        </span><span class="hs-identifier hs-var">HsHigherOrderApp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682360527"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-491"></a><span>        </span><span class="hs-identifier hs-var">HsFirstOrderApp</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#escapeArrowScope"><span class="hs-identifier hs-var">escapeArrowScope</span></a><span> </span><a href="#local-6989586621682360527"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-492"></a><span>        </span><span class="hs-comment">-- See Note [Escaping the arrow scope] in TcRnTypes</span><span>
</span><a name="line-493"></a><span>        </span><span class="hs-comment">-- Before renaming 'arrow', use the environment of the enclosing</span><span>
</span><a name="line-494"></a><span>        </span><span class="hs-comment">-- proc for the (-&lt;) case.</span><span>
</span><a name="line-495"></a><span>        </span><span class="hs-comment">-- Local bindings, inside the enclosing proc, are not in scope</span><span>
</span><a name="line-496"></a><span>        </span><span class="hs-comment">-- inside 'arrow'.  In the higher-order case (-&lt;&lt;), they are.</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-comment">-- infix form</span><span>
</span><a name="line-499"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrForm</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360532"><a href="#local-6989586621682360532"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682360533"><a href="#local-6989586621682360533"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360534"><a href="#local-6989586621682360534"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360535"><a href="#local-6989586621682360535"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360536"><a href="#local-6989586621682360536"><span class="hs-identifier">fv_op</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#escapeArrowScope"><span class="hs-identifier hs-var">escapeArrowScope</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360532"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360537"><a href="#local-6989586621682360537"><span class="hs-identifier">op_name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360535"><span class="hs-identifier hs-var">op'</span></a><span>
</span><a name="line-502"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360538"><a href="#local-6989586621682360538"><span class="hs-identifier">arg1'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360539"><a href="#local-6989586621682360539"><span class="hs-identifier">fv_arg1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnCmdTop"><span class="hs-identifier hs-var">rnCmdTop</span></a><span> </span><a href="#local-6989586621682360533"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-503"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360540"><a href="#local-6989586621682360540"><span class="hs-identifier">arg2'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360541"><a href="#local-6989586621682360541"><span class="hs-identifier">fv_arg2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnCmdTop"><span class="hs-identifier hs-var">rnCmdTop</span></a><span> </span><a href="#local-6989586621682360534"><span class="hs-identifier hs-var">arg2</span></a><span>
</span><a name="line-504"></a><span>        </span><span class="hs-comment">-- Deal with fixity</span><span>
</span><a name="line-505"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360542"><a href="#local-6989586621682360542"><span class="hs-identifier">fixity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier hs-var">lookupFixityRn</span></a><span> </span><a href="#local-6989586621682360537"><span class="hs-identifier hs-var">op_name</span></a><span>
</span><a name="line-506"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360543"><a href="#local-6989586621682360543"><span class="hs-identifier">final_e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#mkOpFormRn"><span class="hs-identifier hs-var">mkOpFormRn</span></a><span> </span><a href="#local-6989586621682360538"><span class="hs-identifier hs-var">arg1'</span></a><span> </span><a href="#local-6989586621682360535"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621682360542"><span class="hs-identifier hs-var">fixity</span></a><span> </span><a href="#local-6989586621682360540"><span class="hs-identifier hs-var">arg2'</span></a><span>
</span><a name="line-507"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360543"><span class="hs-identifier hs-var">final_e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360539"><span class="hs-identifier hs-var">fv_arg1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360536"><span class="hs-identifier hs-var">fv_op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360541"><span class="hs-identifier hs-var">fv_arg2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-508"></a><span>
</span><a name="line-509"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrForm</span><span> </span><a name="local-6989586621682360544"><a href="#local-6989586621682360544"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360545"><a href="#local-6989586621682360545"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621682360546"><a href="#local-6989586621682360546"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682360547"><a href="#local-6989586621682360547"><span class="hs-identifier">fixity</span></a></a><span> </span><a name="local-6989586621682360548"><a href="#local-6989586621682360548"><span class="hs-identifier">cmds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360549"><a href="#local-6989586621682360549"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360550"><a href="#local-6989586621682360550"><span class="hs-identifier">fvOp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#escapeArrowScope"><span class="hs-identifier hs-var">escapeArrowScope</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360545"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360551"><a href="#local-6989586621682360551"><span class="hs-identifier">cmds'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360552"><a href="#local-6989586621682360552"><span class="hs-identifier">fvCmds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnCmdArgs"><span class="hs-identifier hs-var">rnCmdArgs</span></a><span> </span><a href="#local-6989586621682360548"><span class="hs-identifier hs-var">cmds</span></a><span>
</span><a name="line-512"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrForm</span><span> </span><a href="#local-6989586621682360544"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360549"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621682360546"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682360547"><span class="hs-identifier hs-var">fixity</span></a><span> </span><a href="#local-6989586621682360551"><span class="hs-identifier hs-var">cmds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360550"><span class="hs-identifier hs-var">fvOp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360552"><span class="hs-identifier hs-var">fvCmds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdApp</span><span> </span><a name="local-6989586621682360553"><a href="#local-6989586621682360553"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360554"><a href="#local-6989586621682360554"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682360555"><a href="#local-6989586621682360555"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360556"><a href="#local-6989586621682360556"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360557"><a href="#local-6989586621682360557"><span class="hs-identifier">fvFun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span>  </span><a href="#local-6989586621682360554"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-516"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360558"><a href="#local-6989586621682360558"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360559"><a href="#local-6989586621682360559"><span class="hs-identifier">fvArg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360555"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-517"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdApp</span><span> </span><a href="#local-6989586621682360553"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360556"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682360558"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360557"><span class="hs-identifier hs-var">fvFun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360559"><span class="hs-identifier hs-var">fvArg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdLam</span><span> </span><a name="local-6989586621682360560"><a href="#local-6989586621682360560"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360561"><a href="#local-6989586621682360561"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360562"><a href="#local-6989586621682360562"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360563"><a href="#local-6989586621682360563"><span class="hs-identifier">fvMatch</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMatchGroup"><span class="hs-identifier hs-var">rnMatchGroup</span></a><span> </span><span class="hs-identifier hs-var">LambdaExpr</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360561"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-521"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdLam</span><span> </span><a href="#local-6989586621682360560"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360562"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360563"><span class="hs-identifier hs-var">fvMatch</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdPar</span><span> </span><a name="local-6989586621682360564"><a href="#local-6989586621682360564"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360565"><a href="#local-6989586621682360565"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360566"><a href="#local-6989586621682360566"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360567"><a href="#local-6989586621682360567"><span class="hs-identifier">fvs_e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360565"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-525"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdPar</span><span> </span><a href="#local-6989586621682360564"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360566"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360567"><span class="hs-identifier hs-var">fvs_e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdCase</span><span> </span><a name="local-6989586621682360568"><a href="#local-6989586621682360568"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360569"><a href="#local-6989586621682360569"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621682360570"><a href="#local-6989586621682360570"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360571"><a href="#local-6989586621682360571"><span class="hs-identifier">new_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360572"><a href="#local-6989586621682360572"><span class="hs-identifier">e_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360569"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-529"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360573"><a href="#local-6989586621682360573"><span class="hs-identifier">new_matches</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360574"><a href="#local-6989586621682360574"><span class="hs-identifier">ms_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMatchGroup"><span class="hs-identifier hs-var">rnMatchGroup</span></a><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360570"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-530"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdCase</span><span> </span><a href="#local-6989586621682360568"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360571"><span class="hs-identifier hs-var">new_expr</span></a><span> </span><a href="#local-6989586621682360573"><span class="hs-identifier hs-var">new_matches</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360572"><span class="hs-identifier hs-var">e_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360574"><span class="hs-identifier hs-var">ms_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdIf</span><span> </span><a name="local-6989586621682360575"><a href="#local-6989586621682360575"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360576"><a href="#local-6989586621682360576"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621682360577"><a href="#local-6989586621682360577"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-6989586621682360578"><a href="#local-6989586621682360578"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360579"><a href="#local-6989586621682360579"><span class="hs-identifier">p'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360580"><a href="#local-6989586621682360580"><span class="hs-identifier">fvP</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360576"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-534"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360581"><a href="#local-6989586621682360581"><span class="hs-identifier">b1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360582"><a href="#local-6989586621682360582"><span class="hs-identifier">fvB1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360577"><span class="hs-identifier hs-var">b1</span></a><span>
</span><a name="line-535"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360583"><a href="#local-6989586621682360583"><span class="hs-identifier">b2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360584"><a href="#local-6989586621682360584"><span class="hs-identifier">fvB2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360578"><span class="hs-identifier hs-var">b2</span></a><span>
</span><a name="line-536"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360585"><a href="#local-6989586621682360585"><span class="hs-identifier">mb_ite</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360586"><a href="#local-6989586621682360586"><span class="hs-identifier">fvITE</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupIfThenElse"><span class="hs-identifier hs-var">lookupIfThenElse</span></a><span>
</span><a name="line-537"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdIf</span><span> </span><a href="#local-6989586621682360575"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360585"><span class="hs-identifier hs-var">mb_ite</span></a><span> </span><a href="#local-6989586621682360579"><span class="hs-identifier hs-var">p'</span></a><span> </span><a href="#local-6989586621682360581"><span class="hs-identifier hs-var">b1'</span></a><span> </span><a href="#local-6989586621682360583"><span class="hs-identifier hs-var">b2'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682360586"><span class="hs-identifier hs-var">fvITE</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360580"><span class="hs-identifier hs-var">fvP</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360582"><span class="hs-identifier hs-var">fvB1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360584"><span class="hs-identifier hs-var">fvB2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdLet</span><span> </span><a name="local-6989586621682360587"><a href="#local-6989586621682360587"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360588"><a href="#local-6989586621682360588"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360589"><a href="#local-6989586621682360589"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682360590"><a href="#local-6989586621682360590"><span class="hs-identifier">cmd</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnBinds.html#rnLocalBindsAndThen"><span class="hs-identifier hs-var">rnLocalBindsAndThen</span></a><span> </span><a href="#local-6989586621682360589"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360591"><a href="#local-6989586621682360591"><span class="hs-identifier">binds'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-541"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360592"><a href="#local-6989586621682360592"><span class="hs-identifier">cmd'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360593"><a href="#local-6989586621682360593"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360590"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-542"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdLet</span><span> </span><a href="#local-6989586621682360587"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360588"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360591"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360592"><span class="hs-identifier hs-var">cmd'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360593"><span class="hs-identifier hs-var">fvExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-identifier">rnCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdDo</span><span> </span><a name="local-6989586621682360594"><a href="#local-6989586621682360594"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360595"><a href="#local-6989586621682360595"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360596"><a href="#local-6989586621682360596"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360597"><a href="#local-6989586621682360597"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360598"><a href="#local-6989586621682360598"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-546"></a><span>            </span><a href="RnExpr.html#rnStmts"><span class="hs-identifier hs-var">rnStmts</span></a><span> </span><span class="hs-identifier hs-var">ArrowExpr</span><span> </span><a href="RnExpr.html#rnLCmd"><span class="hs-identifier hs-var">rnLCmd</span></a><span> </span><a href="#local-6989586621682360596"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsCmdDo</span><span> </span><a href="#local-6989586621682360594"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360595"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360597"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360598"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span class="hs-identifier">rnCmd</span><span> </span><a name="local-6989586621682360599"><a href="#local-6989586621682360599"><span class="hs-identifier">cmd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdWrap</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnCmd&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360599"><span class="hs-identifier hs-var">cmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span class="hs-identifier">rnCmd</span><span> </span><a name="local-6989586621682360600"><a href="#local-6989586621682360600"><span class="hs-identifier">cmd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">XCmd</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnCmd&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360600"><span class="hs-identifier hs-var">cmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-553"></a><span class="hs-keyword">type</span><span> </span><a name="CmdNeeds"><a href="RnExpr.html#CmdNeeds"><span class="hs-identifier">CmdNeeds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>        </span><span class="hs-comment">-- Only inhabitants are</span><span>
</span><a name="line-554"></a><span>                                </span><span class="hs-comment">--      appAName, choiceAName, loopAName</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span class="hs-comment">-- find what methods the Cmd needs (loop, choice, apply)</span><span>
</span><a name="line-557"></a><span class="hs-identifier">methodNamesLCmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#CmdNeeds"><span class="hs-identifier hs-type">CmdNeeds</span></a><span>
</span><a name="line-558"></a><a name="methodNamesLCmd"><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier">methodNamesLCmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesCmd"><span class="hs-identifier hs-var">methodNamesCmd</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#CmdNeeds"><span class="hs-identifier hs-type">CmdNeeds</span></a><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><a name="methodNamesCmd"><a href="RnExpr.html#methodNamesCmd"><span class="hs-identifier">methodNamesCmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360601"><a href="#local-6989586621682360601"><span class="hs-identifier">_arrow</span></a></a><span> </span><a name="local-6989586621682360602"><a href="#local-6989586621682360602"><span class="hs-identifier">_arg</span></a></a><span> </span><span class="hs-identifier hs-var">HsFirstOrderApp</span><span> </span><a name="local-6989586621682360603"><a href="#local-6989586621682360603"><span class="hs-identifier">_rtl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-564"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360604"><a href="#local-6989586621682360604"><span class="hs-identifier">_arrow</span></a></a><span> </span><a name="local-6989586621682360605"><a href="#local-6989586621682360605"><span class="hs-identifier">_arg</span></a></a><span> </span><span class="hs-identifier hs-var">HsHigherOrderApp</span><span> </span><a name="local-6989586621682360606"><a href="#local-6989586621682360606"><span class="hs-identifier">_rtl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><span class="hs-identifier hs-var">appAName</span><span>
</span><a name="line-566"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdArrForm</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-567"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdWrap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360607"><a href="#local-6989586621682360607"><span class="hs-identifier">cmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesCmd"><span class="hs-identifier hs-var">methodNamesCmd</span></a><span> </span><a href="#local-6989586621682360607"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360608"><a href="#local-6989586621682360608"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360608"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdIf</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360609"><a href="#local-6989586621682360609"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621682360610"><a href="#local-6989586621682360610"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360609"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360610"><span class="hs-identifier hs-var">c2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">choiceAName</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdLet</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360611"><a href="#local-6989586621682360611"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360611"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-575"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdDo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360612"><a href="#local-6989586621682360612"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesStmts"><span class="hs-identifier hs-var">methodNamesStmts</span></a><span> </span><a href="#local-6989586621682360612"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-576"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360613"><a href="#local-6989586621682360613"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360613"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-577"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdLam</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360614"><a href="#local-6989586621682360614"><span class="hs-identifier">match</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesMatch"><span class="hs-identifier hs-var">methodNamesMatch</span></a><span> </span><a href="#local-6989586621682360614"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCmdCase</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360615"><a href="#local-6989586621682360615"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesMatch"><span class="hs-identifier hs-var">methodNamesMatch</span></a><span> </span><a href="#local-6989586621682360615"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">choiceAName</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span class="hs-identifier">methodNamesCmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XCmd</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;methodNamesCmd&quot;</span><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span class="hs-comment">--methodNamesCmd _ = emptyFVs</span><span>
</span><a name="line-585"></a><span>   </span><span class="hs-comment">-- Other forms can't occur in commands, but it's not convenient</span><span>
</span><a name="line-586"></a><span>   </span><span class="hs-comment">-- to error here so we just do what's convenient.</span><span>
</span><a name="line-587"></a><span>   </span><span class="hs-comment">-- The type checker will complain later</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-590"></a><span class="hs-identifier">methodNamesMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>
</span><a name="line-591"></a><a name="methodNamesMatch"><a href="RnExpr.html#methodNamesMatch"><span class="hs-identifier">methodNamesMatch</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360616"><a href="#local-6989586621682360616"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682360617"><span class="hs-identifier hs-var">do_one</span></a><span> </span><a href="#local-6989586621682360616"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-593"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-594"></a><span>    </span><a name="local-6989586621682360617"><a href="#local-6989586621682360617"><span class="hs-identifier">do_one</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Match</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">m_grhss</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360618"><a href="#local-6989586621682360618"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesGRHSs"><span class="hs-identifier hs-var">methodNamesGRHSs</span></a><span> </span><a href="#local-6989586621682360618"><span class="hs-identifier hs-var">grhss</span></a><span>
</span><a name="line-595"></a><span>    </span><span class="hs-identifier">do_one</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatch</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;methodNamesMatch.XMatch&quot;</span><span>
</span><a name="line-596"></a><span class="hs-identifier">methodNamesMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatchGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;methodNamesMatch&quot;</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-comment">-------------------------------------------------</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- gaw 2004</span><span>
</span><a name="line-600"></a><span class="hs-identifier">methodNamesGRHSs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>
</span><a name="line-601"></a><a name="methodNamesGRHSs"><a href="RnExpr.html#methodNamesGRHSs"><span class="hs-identifier">methodNamesGRHSs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHSs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360619"><a href="#local-6989586621682360619"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="RnExpr.html#methodNamesGRHS"><span class="hs-identifier hs-var">methodNamesGRHS</span></a><span> </span><a href="#local-6989586621682360619"><span class="hs-identifier hs-var">grhss</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span class="hs-identifier">methodNamesGRHSs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XGRHSs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;methodNamesGRHSs&quot;</span><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span class="hs-comment">-------------------------------------------------</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-identifier">methodNamesGRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GRHS</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#CmdNeeds"><span class="hs-identifier hs-type">CmdNeeds</span></a><span>
</span><a name="line-607"></a><a name="methodNamesGRHS"><a href="RnExpr.html#methodNamesGRHS"><span class="hs-identifier">methodNamesGRHS</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHS</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360620"><a href="#local-6989586621682360620"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360620"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-608"></a><span class="hs-identifier">methodNamesGRHS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XGRHS</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;methodNamesGRHS&quot;</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-611"></a><span class="hs-identifier">methodNamesStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>
</span><a name="line-612"></a><a name="methodNamesStmts"><a href="RnExpr.html#methodNamesStmts"><span class="hs-identifier">methodNamesStmts</span></a></a><span> </span><a name="local-6989586621682360621"><a href="#local-6989586621682360621"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="RnExpr.html#methodNamesLStmt"><span class="hs-identifier hs-var">methodNamesLStmt</span></a><span> </span><a href="#local-6989586621682360621"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-615"></a><span class="hs-identifier">methodNamesLStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>
</span><a name="line-616"></a><a name="methodNamesLStmt"><a href="RnExpr.html#methodNamesLStmt"><span class="hs-identifier">methodNamesLStmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesStmt"><span class="hs-identifier hs-var">methodNamesStmt</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsCmd</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>
</span><a name="line-619"></a><a name="methodNamesStmt"><a href="RnExpr.html#methodNamesStmt"><span class="hs-identifier">methodNamesStmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360622"><a href="#local-6989586621682360622"><span class="hs-identifier">cmd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360622"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-620"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360623"><a href="#local-6989586621682360623"><span class="hs-identifier">cmd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360623"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-621"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360624"><a href="#local-6989586621682360624"><span class="hs-identifier">cmd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#methodNamesLCmd"><span class="hs-identifier hs-var">methodNamesLCmd</span></a><span> </span><a href="#local-6989586621682360624"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-622"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360625"><a href="#local-6989586621682360625"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-623"></a><span>  </span><a href="RnExpr.html#methodNamesStmts"><span class="hs-identifier hs-var">methodNamesStmts</span></a><span> </span><a href="#local-6989586621682360625"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">loopAName</span><span>
</span><a name="line-624"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-625"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-626"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-627"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-identifier hs-var">ApplicativeStmt</span><span class="hs-special">{</span><span class="hs-special">}</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-628"></a><span>   </span><span class="hs-comment">-- ParStmt and TransStmt can't occur in commands, but it's not</span><span>
</span><a name="line-629"></a><span>   </span><span class="hs-comment">-- convenient to error here so we just do what's convenient</span><span>
</span><a name="line-630"></a><span class="hs-identifier">methodNamesStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;methodNamesStmt&quot;</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Arithmetic sequences
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-639"></a><span>
</span><a name="line-640"></a><span class="hs-identifier">rnArithSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ArithSeqInfo</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ArithSeqInfo</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-641"></a><a name="rnArithSeq"><a href="RnExpr.html#rnArithSeq"><span class="hs-identifier">rnArithSeq</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">From</span><span> </span><a name="local-6989586621682360626"><a href="#local-6989586621682360626"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360627"><a href="#local-6989586621682360627"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360628"><a href="#local-6989586621682360628"><span class="hs-identifier">fvExpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360626"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-643"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">From</span><span> </span><a href="#local-6989586621682360627"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360628"><span class="hs-identifier hs-var">fvExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-identifier">rnArithSeq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThen</span><span> </span><a name="local-6989586621682360629"><a href="#local-6989586621682360629"><span class="hs-identifier">expr1</span></a></a><span> </span><a name="local-6989586621682360630"><a href="#local-6989586621682360630"><span class="hs-identifier">expr2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360631"><a href="#local-6989586621682360631"><span class="hs-identifier">expr1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360632"><a href="#local-6989586621682360632"><span class="hs-identifier">fvExpr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360629"><span class="hs-identifier hs-var">expr1</span></a><span>
</span><a name="line-647"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360633"><a href="#local-6989586621682360633"><span class="hs-identifier">expr2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360634"><a href="#local-6989586621682360634"><span class="hs-identifier">fvExpr2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360630"><span class="hs-identifier hs-var">expr2</span></a><span>
</span><a name="line-648"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThen</span><span> </span><a href="#local-6989586621682360631"><span class="hs-identifier hs-var">expr1'</span></a><span> </span><a href="#local-6989586621682360633"><span class="hs-identifier hs-var">expr2'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360632"><span class="hs-identifier hs-var">fvExpr1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360634"><span class="hs-identifier hs-var">fvExpr2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-identifier">rnArithSeq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromTo</span><span> </span><a name="local-6989586621682360635"><a href="#local-6989586621682360635"><span class="hs-identifier">expr1</span></a></a><span> </span><a name="local-6989586621682360636"><a href="#local-6989586621682360636"><span class="hs-identifier">expr2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360637"><a href="#local-6989586621682360637"><span class="hs-identifier">expr1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360638"><a href="#local-6989586621682360638"><span class="hs-identifier">fvExpr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360635"><span class="hs-identifier hs-var">expr1</span></a><span>
</span><a name="line-652"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360639"><a href="#local-6989586621682360639"><span class="hs-identifier">expr2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360640"><a href="#local-6989586621682360640"><span class="hs-identifier">fvExpr2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360636"><span class="hs-identifier hs-var">expr2</span></a><span>
</span><a name="line-653"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromTo</span><span> </span><a href="#local-6989586621682360637"><span class="hs-identifier hs-var">expr1'</span></a><span> </span><a href="#local-6989586621682360639"><span class="hs-identifier hs-var">expr2'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360638"><span class="hs-identifier hs-var">fvExpr1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360640"><span class="hs-identifier hs-var">fvExpr2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span class="hs-identifier">rnArithSeq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThenTo</span><span> </span><a name="local-6989586621682360641"><a href="#local-6989586621682360641"><span class="hs-identifier">expr1</span></a></a><span> </span><a name="local-6989586621682360642"><a href="#local-6989586621682360642"><span class="hs-identifier">expr2</span></a></a><span> </span><a name="local-6989586621682360643"><a href="#local-6989586621682360643"><span class="hs-identifier">expr3</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360644"><a href="#local-6989586621682360644"><span class="hs-identifier">expr1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360645"><a href="#local-6989586621682360645"><span class="hs-identifier">fvExpr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360641"><span class="hs-identifier hs-var">expr1</span></a><span>
</span><a name="line-657"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360646"><a href="#local-6989586621682360646"><span class="hs-identifier">expr2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360647"><a href="#local-6989586621682360647"><span class="hs-identifier">fvExpr2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360642"><span class="hs-identifier hs-var">expr2</span></a><span>
</span><a name="line-658"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360648"><a href="#local-6989586621682360648"><span class="hs-identifier">expr3'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360649"><a href="#local-6989586621682360649"><span class="hs-identifier">fvExpr3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360643"><span class="hs-identifier hs-var">expr3</span></a><span>
</span><a name="line-659"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThenTo</span><span> </span><a href="#local-6989586621682360644"><span class="hs-identifier hs-var">expr1'</span></a><span> </span><a href="#local-6989586621682360646"><span class="hs-identifier hs-var">expr2'</span></a><span> </span><a href="#local-6989586621682360648"><span class="hs-identifier hs-var">expr3'</span></a><span class="hs-special">,</span><span>
</span><a name="line-660"></a><span>                </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682360645"><span class="hs-identifier hs-var">fvExpr1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360647"><span class="hs-identifier hs-var">fvExpr2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360649"><span class="hs-identifier hs-var">fvExpr3</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsubsection{@Stmt@s: in @do@ expressions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span class="hs-comment">{-
Note [Deterministic ApplicativeDo and RecursiveDo desugaring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Both ApplicativeDo and RecursiveDo need to create tuples not
present in the source text.

For ApplicativeDo we create:

  (a,b,c) &lt;- (\c b a -&gt; (a,b,c)) &lt;$&gt;

For RecursiveDo we create:

  mfix (\ ~(a,b,c) -&gt; do ...; return (a',b',c'))

The order of the components in those tuples needs to be stable
across recompilations, otherwise they can get optimized differently
and we end up with incompatible binaries.
To get a stable order we use nameSetElemsStable.
See Note [Deterministic UniqFM] to learn more about nondeterminism.
-}</span><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span class="hs-comment">-- | Rename some Stmts</span><span>
</span><a name="line-692"></a><span class="hs-identifier">rnStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360244"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-693"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-694"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360244"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360244"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-695"></a><span>           </span><span class="hs-comment">-- ^ How to rename the body of each statement (e.g. rnLExpr)</span><span>
</span><a name="line-696"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360244"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-697"></a><span>           </span><span class="hs-comment">-- ^ Statements</span><span>
</span><a name="line-698"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360245"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>           </span><span class="hs-comment">-- ^ if these statements scope over something, this renames it</span><span>
</span><a name="line-700"></a><span>           </span><span class="hs-comment">-- and returns the result.</span><span>
</span><a name="line-701"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360244"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360245"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-702"></a><a name="rnStmts"><a href="RnExpr.html#rnStmts"><span class="hs-identifier">rnStmts</span></a></a><span> </span><a name="local-6989586621682360650"><a href="#local-6989586621682360650"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360651"><a href="#local-6989586621682360651"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#rnStmtsWithPostProcessing"><span class="hs-identifier hs-var">rnStmtsWithPostProcessing</span></a><span> </span><a href="#local-6989586621682360650"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360651"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="RnExpr.html#noPostProcessStmts"><span class="hs-identifier hs-var">noPostProcessStmts</span></a><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-comment">-- | like 'rnStmts' but applies a post-processing step to the renamed Stmts</span><span>
</span><a name="line-705"></a><span class="hs-identifier">rnStmtsWithPostProcessing</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-708"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-709"></a><span>           </span><span class="hs-comment">-- ^ How to rename the body of each statement (e.g. rnLExpr)</span><span>
</span><a name="line-710"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-711"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-712"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>           </span><span class="hs-comment">-- ^ postprocess the statements</span><span>
</span><a name="line-714"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-715"></a><span>           </span><span class="hs-comment">-- ^ Statements</span><span>
</span><a name="line-716"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360243"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-717"></a><span>           </span><span class="hs-comment">-- ^ if these statements scope over something, this renames it</span><span>
</span><a name="line-718"></a><span>           </span><span class="hs-comment">-- and returns the result.</span><span>
</span><a name="line-719"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360242"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360243"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-720"></a><a name="rnStmtsWithPostProcessing"><a href="RnExpr.html#rnStmtsWithPostProcessing"><span class="hs-identifier">rnStmtsWithPostProcessing</span></a></a><span> </span><a name="local-6989586621682360652"><a href="#local-6989586621682360652"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360653"><a href="#local-6989586621682360653"><span class="hs-identifier">rnBody</span></a></a><span> </span><a name="local-6989586621682360654"><a href="#local-6989586621682360654"><span class="hs-identifier">ppStmts</span></a></a><span> </span><a name="local-6989586621682360655"><a href="#local-6989586621682360655"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621682360656"><a href="#local-6989586621682360656"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-721"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360657"><a href="#local-6989586621682360657"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360658"><a href="#local-6989586621682360658"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360659"><a href="#local-6989586621682360659"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-722"></a><span>          </span><a href="RnExpr.html#rnStmtsWithFreeVars"><span class="hs-identifier hs-var">rnStmtsWithFreeVars</span></a><span> </span><a href="#local-6989586621682360652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360653"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360655"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621682360656"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-723"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360660"><a href="#local-6989586621682360660"><span class="hs-identifier">pp_stmts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360661"><a href="#local-6989586621682360661"><span class="hs-identifier">fvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360654"><span class="hs-identifier hs-var">ppStmts</span></a><span> </span><a href="#local-6989586621682360652"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360657"><span class="hs-identifier hs-var">stmts'</span></a><span>
</span><a name="line-724"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682360660"><span class="hs-identifier hs-var">pp_stmts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360658"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360659"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360661"><span class="hs-identifier hs-var">fvs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span class="hs-comment">-- | maybe rearrange statements according to the ApplicativeDo transformation</span><span>
</span><a name="line-728"></a><span class="hs-identifier">postProcessStmtsForApplicativeDo</span><span>
</span><a name="line-729"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-730"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><a name="postProcessStmtsForApplicativeDo"><a href="RnExpr.html#postProcessStmtsForApplicativeDo"><span class="hs-identifier">postProcessStmtsForApplicativeDo</span></a></a><span> </span><a name="local-6989586621682360662"><a href="#local-6989586621682360662"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360663"><a href="#local-6989586621682360663"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-734"></a><span>       </span><span class="hs-comment">-- rearrange the statements using ApplicativeStmt if</span><span>
</span><a name="line-735"></a><span>       </span><span class="hs-comment">-- -XApplicativeDo is on.  Also strip out the FreeVars attached</span><span>
</span><a name="line-736"></a><span>       </span><span class="hs-comment">-- to each Stmt body.</span><span>
</span><a name="line-737"></a><span>         </span><a name="local-6989586621682360664"><a href="#local-6989586621682360664"><span class="hs-identifier">ado_is_on</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.ApplicativeDo</span><span>
</span><a name="line-738"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360665"><a href="#local-6989586621682360665"><span class="hs-identifier">is_do_expr</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">DoExpr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360662"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-739"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-740"></a><span>       </span><span class="hs-comment">-- don't apply the transformation inside TH brackets, because</span><span>
</span><a name="line-741"></a><span>       </span><span class="hs-comment">-- DsMeta does not handle ApplicativeDo.</span><span>
</span><a name="line-742"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360666"><a href="#local-6989586621682360666"><span class="hs-identifier">in_th_bracket</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#isBrackStage"><span class="hs-identifier hs-var">isBrackStage</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-743"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682360664"><span class="hs-identifier hs-var">ado_is_on</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682360665"><span class="hs-identifier hs-var">is_do_expr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682360666"><span class="hs-identifier hs-var">in_th_bracket</span></a><span>
</span><a name="line-744"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;ppsfa&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360663"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rearrangeForApplicativeDo"><span class="hs-identifier hs-var">rearrangeForApplicativeDo</span></a><span> </span><a href="#local-6989586621682360662"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360663"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-746"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="RnExpr.html#noPostProcessStmts"><span class="hs-identifier hs-var">noPostProcessStmts</span></a><span> </span><a href="#local-6989586621682360662"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360663"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-747"></a><span>
</span><a name="line-748"></a><span class="hs-comment">-- | strip the FreeVars annotations from statements</span><span>
</span><a name="line-749"></a><span class="hs-identifier">noPostProcessStmts</span><span>
</span><a name="line-750"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-751"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360241"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-752"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360241"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-753"></a><a name="noPostProcessStmts"><a href="RnExpr.html#noPostProcessStmts"><span class="hs-identifier">noPostProcessStmts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360667"><a href="#local-6989586621682360667"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682360667"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span class="hs-identifier">rnStmtsWithFreeVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360239"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-758"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360239"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360239"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360239"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-760"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360240"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-761"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360239"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360240"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-763"></a><span class="hs-comment">-- Each Stmt body is annotated with its FreeVars, so that</span><span>
</span><a name="line-764"></a><span class="hs-comment">-- we can rearrange statements for ApplicativeDo.</span><span>
</span><a name="line-765"></a><span class="hs-comment">--</span><span>
</span><a name="line-766"></a><span class="hs-comment">-- Variables bound by the Stmts, and mentioned in thing_inside,</span><span>
</span><a name="line-767"></a><span class="hs-comment">-- do not appear in the result FreeVars</span><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><a name="rnStmtsWithFreeVars"><a href="RnExpr.html#rnStmtsWithFreeVars"><span class="hs-identifier">rnStmtsWithFreeVars</span></a></a><span> </span><a name="local-6989586621682360668"><a href="#local-6989586621682360668"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682360669"><a href="#local-6989586621682360669"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnExpr.html#checkEmptyStmts"><span class="hs-identifier hs-var">checkEmptyStmts</span></a><span> </span><a href="#local-6989586621682360668"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-771"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360670"><a href="#local-6989586621682360670"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360671"><a href="#local-6989586621682360671"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360669"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-772"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360670"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360671"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-identifier">rnStmtsWithFreeVars</span><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><a name="local-6989586621682360672"><a href="#local-6989586621682360672"><span class="hs-identifier">rnBody</span></a></a><span> </span><a name="local-6989586621682360673"><a href="#local-6989586621682360673"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621682360674"><a href="#local-6989586621682360674"><span class="hs-identifier">thing_inside</span></a></a><span>    </span><span class="hs-comment">-- Deal with mdo</span><span>
</span><a name="line-775"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Behave like do { rec { ...all but last... }; last }</span><span>
</span><a name="line-776"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360678"><a href="#local-6989586621682360678"><span class="hs-identifier">stmts1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360679"><a href="#local-6989586621682360679"><span class="hs-identifier">stmts2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360680"><a href="#local-6989586621682360680"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360681"><a href="#local-6989586621682360681"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-777"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnStmt"><span class="hs-identifier hs-var">rnStmt</span></a><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><a href="#local-6989586621682360672"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkRecStmt</span><span> </span><a href="#local-6989586621682360675"><span class="hs-identifier hs-var">all_but_last</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-778"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360677"><a href="#local-6989586621682360677"><span class="hs-identifier">last_stmt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#checkLastStmt"><span class="hs-identifier hs-var">checkLastStmt</span></a><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><a href="#local-6989586621682360676"><span class="hs-identifier hs-var">last_stmt</span></a><span>
</span><a name="line-779"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rnStmt"><span class="hs-identifier hs-var">rnStmt</span></a><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><a href="#local-6989586621682360672"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360677"><span class="hs-identifier hs-var">last_stmt'</span></a><span> </span><a href="#local-6989586621682360674"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-780"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682360678"><span class="hs-identifier hs-var">stmts1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682360679"><span class="hs-identifier hs-var">stmts2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360680"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360681"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-782"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360675"><a href="#local-6989586621682360675"><span class="hs-identifier">all_but_last</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360676"><a href="#local-6989586621682360676"><span class="hs-identifier">last_stmt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snocView</span><span> </span><a href="#local-6989586621682360673"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span class="hs-identifier">rnStmtsWithFreeVars</span><span> </span><a name="local-6989586621682360682"><a href="#local-6989586621682360682"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360683"><a href="#local-6989586621682360683"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682360684"><a href="#local-6989586621682360684"><span class="hs-identifier">lstmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360685"><a href="#local-6989586621682360685"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682360686"><a href="#local-6989586621682360686"><span class="hs-identifier">lstmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682360687"><a href="#local-6989586621682360687"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-785"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682360686"><span class="hs-identifier hs-var">lstmts</span></a><span>
</span><a name="line-786"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682360685"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-787"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360688"><a href="#local-6989586621682360688"><span class="hs-identifier">lstmt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#checkLastStmt"><span class="hs-identifier hs-var">checkLastStmt</span></a><span> </span><a href="#local-6989586621682360682"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360684"><span class="hs-identifier hs-var">lstmt</span></a><span>
</span><a name="line-788"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rnStmt"><span class="hs-identifier hs-var">rnStmt</span></a><span> </span><a href="#local-6989586621682360682"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360683"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360688"><span class="hs-identifier hs-var">lstmt'</span></a><span> </span><a href="#local-6989586621682360687"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-789"></a><span>
</span><a name="line-790"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-791"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360691"><a href="#local-6989586621682360691"><span class="hs-identifier">stmts1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360692"><a href="#local-6989586621682360692"><span class="hs-identifier">stmts2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360693"><a href="#local-6989586621682360693"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360694"><a href="#local-6989586621682360694"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682360685"><span class="hs-identifier hs-var">loc</span></a><span>                         </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-793"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnExpr.html#checkStmt"><span class="hs-identifier hs-var">checkStmt</span></a><span> </span><a href="#local-6989586621682360682"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360684"><span class="hs-identifier hs-var">lstmt</span></a><span>
</span><a name="line-794"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rnStmt"><span class="hs-identifier hs-var">rnStmt</span></a><span> </span><a href="#local-6989586621682360682"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360683"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360684"><span class="hs-identifier hs-var">lstmt</span></a><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360689"><a href="#local-6989586621682360689"><span class="hs-identifier">bndrs1</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-795"></a><span>                    </span><a href="RnExpr.html#rnStmtsWithFreeVars"><span class="hs-identifier hs-var">rnStmtsWithFreeVars</span></a><span> </span><a href="#local-6989586621682360682"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360683"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360686"><span class="hs-identifier hs-var">lstmts</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360690"><a href="#local-6989586621682360690"><span class="hs-identifier">bndrs2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-796"></a><span>                    </span><a href="#local-6989586621682360687"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360689"><span class="hs-identifier hs-var">bndrs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682360690"><span class="hs-identifier hs-var">bndrs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-797"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682360691"><span class="hs-identifier hs-var">stmts1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682360692"><span class="hs-identifier hs-var">stmts2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360693"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360694"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-800"></a><span>
</span><a name="line-801"></a><span class="hs-comment">{-
Note [Failing pattern matches in Stmts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Many things desugar to HsStmts including monadic things like `do` and `mdo`
statements, pattern guards, and list comprehensions (see 'HsStmtContext' for an
exhaustive list). How we deal with pattern match failure is context-dependent.

 * In the case of list comprehensions and pattern guards we don't need any 'fail'
   function; the desugarer ignores the fail function field of 'BindStmt' entirely.
 * In the case of monadic contexts (e.g. monad comprehensions, do, and mdo
   expressions) we want pattern match failure to be desugared to the appropriate
   'fail' function (either that of Monad or MonadFail, depending on whether
   -XMonadFailDesugaring is enabled.)

At one point we failed to make this distinction, leading to #11216.
-}</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">rnStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360237"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-821"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360237"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360237"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>          </span><span class="hs-comment">-- ^ How to rename the body of the statement</span><span>
</span><a name="line-823"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360237"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-824"></a><span>          </span><span class="hs-comment">-- ^ The statement</span><span>
</span><a name="line-825"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360238"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>          </span><span class="hs-comment">-- ^ Rename the stuff that this statement scopes over</span><span>
</span><a name="line-827"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360237"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360238"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span class="hs-comment">-- Variables bound by the Stmt, and mentioned in thing_inside,</span><span>
</span><a name="line-830"></a><span class="hs-comment">-- do not appear in the result FreeVars</span><span>
</span><a name="line-831"></a><span>
</span><a name="line-832"></a><a name="rnStmt"><a href="RnExpr.html#rnStmt"><span class="hs-identifier">rnStmt</span></a></a><span> </span><a name="local-6989586621682360695"><a href="#local-6989586621682360695"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360696"><a href="#local-6989586621682360696"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360697"><a href="#local-6989586621682360697"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360698"><a href="#local-6989586621682360698"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621682360699"><a href="#local-6989586621682360699"><span class="hs-identifier">noret</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360700"><a href="#local-6989586621682360700"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-833"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360701"><a href="#local-6989586621682360701"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360702"><a href="#local-6989586621682360702"><span class="hs-identifier">fv_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360696"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360698"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-834"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360703"><a href="#local-6989586621682360703"><span class="hs-identifier">ret_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360704"><a href="#local-6989586621682360704"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isMonadCompContext</span><span> </span><a href="#local-6989586621682360695"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-835"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360695"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-836"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>                            </span><span class="hs-comment">-- The 'return' in a LastStmt is used only</span><span>
</span><a name="line-838"></a><span>                            </span><span class="hs-comment">-- for MonadComp; and we don't want to report</span><span>
</span><a name="line-839"></a><span>                            </span><span class="hs-comment">-- &quot;non in scope: return&quot; in other cases</span><span>
</span><a name="line-840"></a><span>                            </span><span class="hs-comment">-- Trac #15607</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360705"><a href="#local-6989586621682360705"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682360706"><a href="#local-6989586621682360706"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360700"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360697"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360701"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682360699"><span class="hs-identifier hs-var">noret</span></a><span> </span><a href="#local-6989586621682360703"><span class="hs-identifier hs-var">ret_op</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360702"><span class="hs-identifier hs-var">fv_expr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-844"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360705"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360702"><span class="hs-identifier hs-var">fv_expr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360704"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360706"><span class="hs-identifier hs-var">fvs3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-845"></a><span>
</span><a name="line-846"></a><span class="hs-identifier">rnStmt</span><span> </span><a name="local-6989586621682360707"><a href="#local-6989586621682360707"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360708"><a href="#local-6989586621682360708"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360709"><a href="#local-6989586621682360709"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360710"><a href="#local-6989586621682360710"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360711"><a href="#local-6989586621682360711"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-847"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360712"><a href="#local-6989586621682360712"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360713"><a href="#local-6989586621682360713"><span class="hs-identifier">fv_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360708"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360710"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-848"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360714"><a href="#local-6989586621682360714"><span class="hs-identifier">then_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360715"><a href="#local-6989586621682360715"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360707"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">thenMName</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360716"><a href="#local-6989586621682360716"><span class="hs-identifier">guard_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360717"><a href="#local-6989586621682360717"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isComprehensionContext</span><span> </span><a href="#local-6989586621682360707"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-851"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360707"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">guardMName</span><span>
</span><a name="line-852"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>                              </span><span class="hs-comment">-- Only list/monad comprehensions use 'guard'</span><span>
</span><a name="line-854"></a><span>                              </span><span class="hs-comment">-- Also for sub-stmts of same eg [ e | x&lt;-xs, gd | blah ]</span><span>
</span><a name="line-855"></a><span>                              </span><span class="hs-comment">-- Here &quot;gd&quot; is a guard</span><span>
</span><a name="line-856"></a><span>
</span><a name="line-857"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360718"><a href="#local-6989586621682360718"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360719"><a href="#local-6989586621682360719"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360711"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-858"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360709"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360712"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682360714"><span class="hs-identifier hs-var">then_op</span></a><span> </span><a href="#local-6989586621682360716"><span class="hs-identifier hs-var">guard_op</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360713"><span class="hs-identifier hs-var">fv_expr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-859"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360718"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360713"><span class="hs-identifier hs-var">fv_expr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360715"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360717"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360719"><span class="hs-identifier hs-var">fvs3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span class="hs-identifier">rnStmt</span><span> </span><a name="local-6989586621682360720"><a href="#local-6989586621682360720"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360721"><a href="#local-6989586621682360721"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360722"><a href="#local-6989586621682360722"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360723"><a href="#local-6989586621682360723"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682360724"><a href="#local-6989586621682360724"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360725"><a href="#local-6989586621682360725"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-862"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360726"><a href="#local-6989586621682360726"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360727"><a href="#local-6989586621682360727"><span class="hs-identifier">fv_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360721"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360724"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-863"></a><span>                </span><span class="hs-comment">-- The binders do not scope over the expression</span><span>
</span><a name="line-864"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360728"><a href="#local-6989586621682360728"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360729"><a href="#local-6989586621682360729"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360720"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">bindMName</span><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360730"><a href="#local-6989586621682360730"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360731"><a href="#local-6989586621682360731"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#monadFailOp"><span class="hs-identifier hs-var">monadFailOp</span></a><span> </span><a href="#local-6989586621682360723"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621682360720"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnPat.html#rnPat"><span class="hs-identifier hs-var">rnPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621682360720"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360723"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360732"><a href="#local-6989586621682360732"><span class="hs-identifier">pat'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-869"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360733"><a href="#local-6989586621682360733"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360734"><a href="#local-6989586621682360734"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360725"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621682360732"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360722"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360732"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621682360726"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682360728"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><a href="#local-6989586621682360730"><span class="hs-identifier hs-var">fail_op</span></a><span class="hs-special">)</span><span>
</span><a name="line-871"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360727"><span class="hs-identifier hs-var">fv_expr</span></a><span> </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-872"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360733"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-873"></a><span>                  </span><a href="#local-6989586621682360727"><span class="hs-identifier hs-var">fv_expr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360729"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360731"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360734"><span class="hs-identifier hs-var">fvs3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-874"></a><span>       </span><span class="hs-comment">-- fv_expr shouldn't really be filtered by the rnPatsAndThen</span><span>
</span><a name="line-875"></a><span>        </span><span class="hs-comment">-- but it does not matter because the names are unique</span><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span class="hs-identifier">rnStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360735"><a href="#local-6989586621682360735"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360736"><a href="#local-6989586621682360736"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682360737"><a href="#local-6989586621682360737"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360738"><a href="#local-6989586621682360738"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-878"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="RnBinds.html#rnLocalBindsAndThen"><span class="hs-identifier hs-var">rnLocalBindsAndThen</span></a><span> </span><a href="#local-6989586621682360737"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682360739"><a href="#local-6989586621682360739"><span class="hs-identifier">binds'</span></a></a><span> </span><a name="local-6989586621682360740"><a href="#local-6989586621682360740"><span class="hs-identifier">bind_fvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360741"><a href="#local-6989586621682360741"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360742"><a href="#local-6989586621682360742"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360738"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectLocalBinders</span><span> </span><a href="#local-6989586621682360739"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360735"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360736"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682360739"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360740"><span class="hs-identifier hs-var">bind_fvs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360741"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-881"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360742"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span class="hs-identifier">rnStmt</span><span> </span><a name="local-6989586621682360743"><a href="#local-6989586621682360743"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360744"><a href="#local-6989586621682360744"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360745"><a href="#local-6989586621682360745"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360746"><a href="#local-6989586621682360746"><span class="hs-identifier">rec_stmts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360747"><a href="#local-6989586621682360747"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-884"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360748"><a href="#local-6989586621682360748"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360749"><a href="#local-6989586621682360749"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360743"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-885"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360750"><a href="#local-6989586621682360750"><span class="hs-identifier">mfix_op</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682360751"><a href="#local-6989586621682360751"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360743"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">mfixName</span><span>
</span><a name="line-886"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360752"><a href="#local-6989586621682360752"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682360753"><a href="#local-6989586621682360753"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360743"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">bindMName</span><span>
</span><a name="line-887"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360754"><a href="#local-6989586621682360754"><span class="hs-identifier">empty_rec_stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyRecStmtName</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_ret_fn</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360748"><span class="hs-identifier hs-var">return_op</span></a><span>
</span><a name="line-888"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_mfix_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360750"><span class="hs-identifier hs-var">mfix_op</span></a><span>
</span><a name="line-889"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_bind_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360752"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-890"></a><span>
</span><a name="line-891"></a><span>        </span><span class="hs-comment">-- Step1: Bring all the binders of the mdo into scope</span><span>
</span><a name="line-892"></a><span>        </span><span class="hs-comment">-- (Remember that this also removes the binders from the</span><span>
</span><a name="line-893"></a><span>        </span><span class="hs-comment">-- finally-returned free-vars.)</span><span>
</span><a name="line-894"></a><span>        </span><span class="hs-comment">-- And rename each individual stmt, making a</span><span>
</span><a name="line-895"></a><span>        </span><span class="hs-comment">-- singleton segment.  At this stage the FwdRefs field</span><span>
</span><a name="line-896"></a><span>        </span><span class="hs-comment">-- isn't finished: it's empty for all except a BindStmt</span><span>
</span><a name="line-897"></a><span>        </span><span class="hs-comment">-- for which it's the fwd refs within the bind itself</span><span>
</span><a name="line-898"></a><span>        </span><span class="hs-comment">-- (This set may not be empty, because we're in a recursive</span><span>
</span><a name="line-899"></a><span>        </span><span class="hs-comment">-- context.)</span><span>
</span><a name="line-900"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnExpr.html#rnRecStmtsAndThen"><span class="hs-identifier hs-var">rnRecStmtsAndThen</span></a><span> </span><a href="#local-6989586621682360744"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360746"><span class="hs-identifier hs-var">rec_stmts</span></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360755"><a href="#local-6989586621682360755"><span class="hs-identifier">segs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-901"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360756"><a href="#local-6989586621682360756"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-902"></a><span>                        </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unionNameSet</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682360757"><a href="#local-6989586621682360757"><span class="hs-identifier">ds</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682360757"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>                              </span><span class="hs-identifier hs-var">emptyNameSet</span><span>
</span><a name="line-904"></a><span>                              </span><a href="#local-6989586621682360755"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-905"></a><span>          </span><span class="hs-comment">-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span><span>
</span><a name="line-906"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360758"><a href="#local-6989586621682360758"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360759"><a href="#local-6989586621682360759"><span class="hs-identifier">fvs_later</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360747"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682360756"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-907"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360760"><a href="#local-6989586621682360760"><span class="hs-identifier">rec_stmts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360761"><a href="#local-6989586621682360761"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#segmentRecStmts"><span class="hs-identifier hs-var">segmentRecStmts</span></a><span> </span><a href="#local-6989586621682360745"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682360743"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360754"><span class="hs-identifier hs-var">empty_rec_stmt</span></a><span> </span><a href="#local-6989586621682360755"><span class="hs-identifier hs-var">segs</span></a><span> </span><a href="#local-6989586621682360759"><span class="hs-identifier hs-var">fvs_later</span></a><span>
</span><a name="line-908"></a><span>        </span><span class="hs-comment">-- We aren't going to try to group RecStmts with</span><span>
</span><a name="line-909"></a><span>        </span><span class="hs-comment">-- ApplicativeDo, so attaching empty FVs is fine.</span><span>
</span><a name="line-910"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621682360760"><span class="hs-identifier hs-var">rec_stmts'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360758"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360761"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360749"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360751"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360753"><span class="hs-identifier hs-var">fvs3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-identifier">rnStmt</span><span> </span><a name="local-6989586621682360762"><a href="#local-6989586621682360762"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360763"><a href="#local-6989586621682360763"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360764"><a href="#local-6989586621682360764"><span class="hs-identifier">segs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360765"><a href="#local-6989586621682360765"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360766"><a href="#local-6989586621682360766"><span class="hs-identifier">mzip_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360767"><a href="#local-6989586621682360767"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtNamePoly"><span class="hs-identifier hs-var">lookupStmtNamePoly</span></a><span> </span><a href="#local-6989586621682360762"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">mzipName</span><span>
</span><a name="line-915"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360768"><a href="#local-6989586621682360768"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360769"><a href="#local-6989586621682360769"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360762"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">bindMName</span><span>
</span><a name="line-916"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360770"><a href="#local-6989586621682360770"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360771"><a href="#local-6989586621682360771"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360762"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-917"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360772"><a href="#local-6989586621682360772"><span class="hs-identifier">segs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360773"><a href="#local-6989586621682360773"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360774"><a href="#local-6989586621682360774"><span class="hs-identifier">fvs4</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnParallelStmts"><span class="hs-identifier hs-var">rnParallelStmts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtCtxt</span><span> </span><a href="#local-6989586621682360762"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360770"><span class="hs-identifier hs-var">return_op</span></a><span> </span><a href="#local-6989586621682360764"><span class="hs-identifier hs-var">segs</span></a><span> </span><a href="#local-6989586621682360765"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-918"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360763"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360772"><span class="hs-identifier hs-var">segs'</span></a><span> </span><a href="#local-6989586621682360766"><span class="hs-identifier hs-var">mzip_op</span></a><span> </span><a href="#local-6989586621682360768"><span class="hs-identifier hs-var">bind_op</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360774"><span class="hs-identifier hs-var">fvs4</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360773"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360767"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360769"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360771"><span class="hs-identifier hs-var">fvs3</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360774"><span class="hs-identifier hs-var">fvs4</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-identifier">rnStmt</span><span> </span><a name="local-6989586621682360775"><a href="#local-6989586621682360775"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360776"><a href="#local-6989586621682360776"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360777"><a href="#local-6989586621682360777"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360778"><a href="#local-6989586621682360778"><span class="hs-identifier">by</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360779"><a href="#local-6989586621682360779"><span class="hs-identifier">form</span></a></a><span>
</span><a name="line-922"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360780"><a href="#local-6989586621682360780"><span class="hs-identifier">using</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682360781"><a href="#local-6989586621682360781"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-923"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Rename the 'using' expression in the context before the transform is begun</span><span>
</span><a name="line-924"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621682360782"><a href="#local-6989586621682360782"><span class="hs-identifier">using'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360783"><a href="#local-6989586621682360783"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360780"><span class="hs-identifier hs-var">using</span></a><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span>         </span><span class="hs-comment">-- Rename the stmts and the 'by' expression</span><span>
</span><a name="line-927"></a><span>         </span><span class="hs-comment">-- Keep track of the variables mentioned in the 'by' expression</span><span>
</span><a name="line-928"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360791"><a href="#local-6989586621682360791"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360792"><a href="#local-6989586621682360792"><span class="hs-identifier">by'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360793"><a href="#local-6989586621682360793"><span class="hs-identifier">used_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360794"><a href="#local-6989586621682360794"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360795"><a href="#local-6989586621682360795"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnStmts"><span class="hs-identifier hs-var">rnStmts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmtCtxt</span><span> </span><a href="#local-6989586621682360775"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360777"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360784"><a href="#local-6989586621682360784"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-930"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360785"><a href="#local-6989586621682360785"><span class="hs-identifier">by'</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682360786"><a href="#local-6989586621682360786"><span class="hs-identifier">fvs_by</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#mapMaybeFvRn"><span class="hs-identifier hs-var">mapMaybeFvRn</span></a><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360778"><span class="hs-identifier hs-var">by</span></a><span>
</span><a name="line-931"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360787"><a href="#local-6989586621682360787"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360788"><a href="#local-6989586621682360788"><span class="hs-identifier">fvs_thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360781"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682360784"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-932"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360789"><a href="#local-6989586621682360789"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360786"><span class="hs-identifier hs-var">fvs_by</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360788"><span class="hs-identifier hs-var">fvs_thing</span></a><span>
</span><a name="line-933"></a><span>                         </span><a name="local-6989586621682360790"><a href="#local-6989586621682360790"><span class="hs-identifier">used_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360789"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360784"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-934"></a><span>                         </span><span class="hs-comment">-- The paper (Fig 5) has a bug here; we must treat any free variable</span><span>
</span><a name="line-935"></a><span>                         </span><span class="hs-comment">-- of the &quot;thing inside&quot;, **or of the by-expression**, as used</span><span>
</span><a name="line-936"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682360785"><span class="hs-identifier hs-var">by'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360790"><span class="hs-identifier hs-var">used_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360787"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360789"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-937"></a><span>
</span><a name="line-938"></a><span>       </span><span class="hs-comment">-- Lookup `return`, `(&gt;&gt;=)` and `liftM` for monad comprehensions</span><span>
</span><a name="line-939"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360796"><a href="#local-6989586621682360796"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360797"><a href="#local-6989586621682360797"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360775"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-940"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360798"><a href="#local-6989586621682360798"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682360799"><a href="#local-6989586621682360799"><span class="hs-identifier">fvs4</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682360775"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">bindMName</span><span>
</span><a name="line-941"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360800"><a href="#local-6989586621682360800"><span class="hs-identifier">fmap_op</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682360801"><a href="#local-6989586621682360801"><span class="hs-identifier">fvs5</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360779"><span class="hs-identifier hs-var">form</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-942"></a><span>                                </span><span class="hs-identifier hs-var">ThenForm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-943"></a><span>                                </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#lookupStmtNamePoly"><span class="hs-identifier hs-var">lookupStmtNamePoly</span></a><span> </span><a href="#local-6989586621682360775"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">fmapName</span><span>
</span><a name="line-944"></a><span>
</span><a name="line-945"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360802"><a href="#local-6989586621682360802"><span class="hs-identifier">all_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360783"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360795"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360797"><span class="hs-identifier hs-var">fvs3</span></a><span>
</span><a name="line-946"></a><span>                             </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360799"><span class="hs-identifier hs-var">fvs4</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360801"><span class="hs-identifier hs-var">fvs5</span></a><span>
</span><a name="line-947"></a><span>             </span><a name="local-6989586621682360803"><a href="#local-6989586621682360803"><span class="hs-identifier">bndr_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360793"><span class="hs-identifier hs-var">used_bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360793"><span class="hs-identifier hs-var">used_bndrs</span></a><span>
</span><a name="line-948"></a><span>             </span><span class="hs-comment">-- See Note [TransStmt binder map] in HsExpr</span><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnStmt: implicitly rebound these used binders:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360803"><span class="hs-identifier hs-var">bndr_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-951"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360776"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-952"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360791"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360803"><span class="hs-identifier hs-var">bndr_map</span></a><span>
</span><a name="line-953"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360792"><span class="hs-identifier hs-var">by'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360782"><span class="hs-identifier hs-var">using'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360779"><span class="hs-identifier hs-var">form</span></a><span>
</span><a name="line-954"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360796"><span class="hs-identifier hs-var">return_op</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bind</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360798"><span class="hs-identifier hs-var">bind_op</span></a><span>
</span><a name="line-955"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_fmap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360800"><span class="hs-identifier hs-var">fmap_op</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360795"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360794"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360802"><span class="hs-identifier hs-var">all_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-956"></a><span>
</span><a name="line-957"></a><span class="hs-identifier">rnStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">ApplicativeStmt</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-958"></a><span>  </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnStmt: ApplicativeStmt&quot;</span><span>
</span><a name="line-959"></a><span>
</span><a name="line-960"></a><span class="hs-identifier">rnStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">XStmtLR</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-961"></a><span>  </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnStmt: XStmtLR&quot;</span><span>
</span><a name="line-962"></a><span>
</span><a name="line-963"></a><span class="hs-identifier">rnParallelStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621682360236"><a href="#local-6989586621682360236"><span class="hs-identifier">thing</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-964"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-965"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ParStmtBlock</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-966"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360236"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-967"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ParStmtBlock</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360236"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-968"></a><span class="hs-comment">-- Note [Renaming parallel Stmts]</span><span>
</span><a name="line-969"></a><a name="rnParallelStmts"><a href="RnExpr.html#rnParallelStmts"><span class="hs-identifier">rnParallelStmts</span></a></a><span> </span><a name="local-6989586621682360804"><a href="#local-6989586621682360804"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360805"><a href="#local-6989586621682360805"><span class="hs-identifier">return_op</span></a></a><span> </span><a name="local-6989586621682360806"><a href="#local-6989586621682360806"><span class="hs-identifier">segs</span></a></a><span> </span><a name="local-6989586621682360807"><a href="#local-6989586621682360807"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-970"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360835"><a href="#local-6989586621682360835"><span class="hs-identifier">orig_lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span>
</span><a name="line-971"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682360808"><span class="hs-identifier hs-var">rn_segs</span></a><span> </span><a href="#local-6989586621682360835"><span class="hs-identifier hs-var">orig_lcl_env</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682360806"><span class="hs-identifier hs-var">segs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-972"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-973"></a><span>    </span><span class="hs-identifier">rn_segs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LocalRdrEnv</span><span>
</span><a name="line-974"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ParStmtBlock</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-975"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ParStmtBlock</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360236"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>    </span><a name="local-6989586621682360808"><a href="#local-6989586621682360808"><span class="hs-identifier">rn_segs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360811"><a href="#local-6989586621682360811"><span class="hs-identifier">bndrs_so_far</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-977"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360812"><a href="#local-6989586621682360812"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360813"><a href="#local-6989586621682360813"><span class="hs-identifier">dups</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">removeDups</span><span> </span><a href="#local-6989586621682360809"><span class="hs-identifier hs-var">cmpByOcc</span></a><span> </span><a href="#local-6989586621682360811"><span class="hs-identifier hs-var">bndrs_so_far</span></a><span>
</span><a name="line-978"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682360810"><span class="hs-identifier hs-var">dupErr</span></a><span> </span><a href="#local-6989586621682360813"><span class="hs-identifier hs-var">dups</span></a><span>
</span><a name="line-979"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360814"><a href="#local-6989586621682360814"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360815"><a href="#local-6989586621682360815"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#bindLocalNames"><span class="hs-identifier hs-var">bindLocalNames</span></a><span> </span><a href="#local-6989586621682360812"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360807"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682360812"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-980"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360814"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360815"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span>    </span><span class="hs-identifier">rn_segs</span><span> </span><a name="local-6989586621682360816"><a href="#local-6989586621682360816"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682360817"><a href="#local-6989586621682360817"><span class="hs-identifier">bndrs_so_far</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><a name="local-6989586621682360818"><a href="#local-6989586621682360818"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360819"><a href="#local-6989586621682360819"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682360820"><a href="#local-6989586621682360820"><span class="hs-identifier">segs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360826"><a href="#local-6989586621682360826"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360827"><a href="#local-6989586621682360827"><span class="hs-identifier">used_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360828"><a href="#local-6989586621682360828"><span class="hs-identifier">segs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360829"><a href="#local-6989586621682360829"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360830"><a href="#local-6989586621682360830"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnStmts"><span class="hs-identifier hs-var">rnStmts</span></a><span> </span><a href="#local-6989586621682360804"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682360819"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360821"><a href="#local-6989586621682360821"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-985"></a><span>                       </span><a href="TcRnMonad.html#setLocalRdrEnv"><span class="hs-identifier hs-var">setLocalRdrEnv</span></a><span> </span><a href="#local-6989586621682360816"><span class="hs-identifier hs-var">env</span></a><span>       </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-986"></a><span>                       </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360822"><a href="#local-6989586621682360822"><span class="hs-identifier">segs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360823"><a href="#local-6989586621682360823"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360824"><a href="#local-6989586621682360824"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360808"><span class="hs-identifier hs-var">rn_segs</span></a><span> </span><a href="#local-6989586621682360816"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360821"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682360817"><span class="hs-identifier hs-var">bndrs_so_far</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360820"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-987"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360825"><a href="#local-6989586621682360825"><span class="hs-identifier">used_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360824"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360821"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-988"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682360825"><span class="hs-identifier hs-var">used_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360822"><span class="hs-identifier hs-var">segs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360823"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360824"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-989"></a><span>
</span><a name="line-990"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360831"><a href="#local-6989586621682360831"><span class="hs-identifier">seg'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><a href="#local-6989586621682360818"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360826"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><a href="#local-6989586621682360827"><span class="hs-identifier hs-var">used_bndrs</span></a><span> </span><a href="#local-6989586621682360805"><span class="hs-identifier hs-var">return_op</span></a><span>
</span><a name="line-991"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682360831"><span class="hs-identifier hs-var">seg'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682360828"><span class="hs-identifier hs-var">segs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360829"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360830"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-992"></a><span>    </span><span class="hs-identifier">rn_segs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XParStmtBlock</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnParallelStmts&quot;</span><span>
</span><a name="line-993"></a><span>
</span><a name="line-994"></a><span>    </span><a name="local-6989586621682360809"><a href="#local-6989586621682360809"><span class="hs-identifier">cmpByOcc</span></a></a><span> </span><a name="local-6989586621682360832"><a href="#local-6989586621682360832"><span class="hs-identifier">n1</span></a></a><span> </span><a name="local-6989586621682360833"><a href="#local-6989586621682360833"><span class="hs-identifier">n2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682360832"><span class="hs-identifier hs-var">n1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682360833"><span class="hs-identifier hs-var">n2</span></a><span>
</span><a name="line-995"></a><span>    </span><a name="local-6989586621682360810"><a href="#local-6989586621682360810"><span class="hs-identifier">dupErr</span></a></a><span> </span><a name="local-6989586621682360834"><a href="#local-6989586621682360834"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Duplicate binding in parallel list comprehension for:&quot;</span><span>
</span><a name="line-996"></a><span>                    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NE.head</span><span> </span><a href="#local-6989586621682360834"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>
</span><a name="line-998"></a><span class="hs-identifier">lookupStmtName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span class="hs-comment">-- Like lookupSyntaxName, but respects contexts</span><span>
</span><a name="line-1000"></a><a name="lookupStmtName"><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier">lookupStmtName</span></a></a><span> </span><a name="local-6989586621682360836"><a href="#local-6989586621682360836"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360837"><a href="#local-6989586621682360837"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1001"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="RnExpr.html#rebindableContext"><span class="hs-identifier hs-var">rebindableContext</span></a><span> </span><a href="#local-6989586621682360836"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1002"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><a href="#local-6989586621682360837"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1003"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1004"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><a href="#local-6989586621682360837"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span class="hs-identifier">lookupStmtNamePoly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><a name="lookupStmtNamePoly"><a href="RnExpr.html#lookupStmtNamePoly"><span class="hs-identifier">lookupStmtNamePoly</span></a></a><span> </span><a name="local-6989586621682360838"><a href="#local-6989586621682360838"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360839"><a href="#local-6989586621682360839"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="RnExpr.html#rebindableContext"><span class="hs-identifier hs-var">rebindableContext</span></a><span> </span><a href="#local-6989586621682360838"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1009"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360841"><a href="#local-6989586621682360841"><span class="hs-identifier">rebindable_on</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.RebindableSyntax</span><span>
</span><a name="line-1010"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682360841"><span class="hs-identifier hs-var">rebindable_on</span></a><span>
</span><a name="line-1011"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360842"><a href="#local-6989586621682360842"><span class="hs-identifier">fm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameRdrName</span><span> </span><a href="#local-6989586621682360839"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682360842"><span class="hs-identifier hs-var">fm</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621682360842"><span class="hs-identifier hs-var">fm</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1013"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682360840"><span class="hs-identifier hs-var">not_rebindable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1015"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360840"><span class="hs-identifier hs-var">not_rebindable</span></a><span>
</span><a name="line-1016"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1017"></a><span>    </span><a name="local-6989586621682360840"><a href="#local-6989586621682360840"><span class="hs-identifier">not_rebindable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682360839"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-comment">-- | Is this a context where we respect RebindableSyntax?</span><span>
</span><a name="line-1020"></a><span class="hs-comment">-- but ListComp are never rebindable</span><span>
</span><a name="line-1021"></a><span class="hs-comment">-- Neither is ArrowExpr, which has its own desugarer in DsArrows</span><span>
</span><a name="line-1022"></a><span class="hs-identifier">rebindableContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1023"></a><a name="rebindableContext"><a href="RnExpr.html#rebindableContext"><span class="hs-identifier">rebindableContext</span></a></a><span> </span><a name="local-6989586621682360843"><a href="#local-6989586621682360843"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360843"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1024"></a><span>  </span><span class="hs-identifier hs-var">ListComp</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1025"></a><span>  </span><span class="hs-identifier hs-var">ArrowExpr</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1026"></a><span>  </span><span class="hs-identifier hs-var">PatGuard</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span>  </span><span class="hs-identifier hs-var">DoExpr</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1029"></a><span>  </span><span class="hs-identifier hs-var">MDoExpr</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1030"></a><span>  </span><span class="hs-identifier hs-var">MonadComp</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1031"></a><span>  </span><span class="hs-identifier hs-var">GhciStmtCtxt</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- I suppose?</span><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span>  </span><span class="hs-identifier hs-var">ParStmtCtxt</span><span>   </span><a name="local-6989586621682360844"><a href="#local-6989586621682360844"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#rebindableContext"><span class="hs-identifier hs-var">rebindableContext</span></a><span> </span><a href="#local-6989586621682360844"><span class="hs-identifier hs-var">c</span></a><span>     </span><span class="hs-comment">-- Look inside to</span><span>
</span><a name="line-1034"></a><span>  </span><span class="hs-identifier hs-var">TransStmtCtxt</span><span> </span><a name="local-6989586621682360845"><a href="#local-6989586621682360845"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#rebindableContext"><span class="hs-identifier hs-var">rebindableContext</span></a><span> </span><a href="#local-6989586621682360845"><span class="hs-identifier hs-var">c</span></a><span>     </span><span class="hs-comment">-- the parent context</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-comment">{-
Note [Renaming parallel Stmts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Renaming parallel statements is painful.  Given, say
     [ a+c | a &lt;- as, bs &lt;- bss
           | c &lt;- bs, a &lt;- ds ]
Note that
  (a) In order to report &quot;Defined but not used&quot; about 'bs', we must
      rename each group of Stmts with a thing_inside whose FreeVars
      include at least {a,c}

  (b) We want to report that 'a' is illegally bound in both branches

  (c) The 'bs' in the second group must obviously not be captured by
      the binding in the first group

To satisfy (a) we nest the segements.
To satisfy (b) we check for duplicates just before thing_inside.
To satisfy (c) we reset the LocalRdrEnv each time.

************************************************************************
*                                                                      *
\subsubsection{mdo expressions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1062"></a><span>
</span><a name="line-1063"></a><span class="hs-keyword">type</span><span> </span><a name="FwdRefs"><a href="RnExpr.html#FwdRefs"><span class="hs-identifier">FwdRefs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1064"></a><span class="hs-keyword">type</span><span> </span><a name="Segment"><a href="RnExpr.html#Segment"><span class="hs-identifier">Segment</span></a></a><span> </span><a name="local-6989586621682360206"><a href="#local-6989586621682360206"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Defs</span><span class="hs-special">,</span><span>
</span><a name="line-1065"></a><span>                      </span><span class="hs-identifier hs-type">Uses</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- May include defs</span><span>
</span><a name="line-1066"></a><span>                      </span><a href="RnExpr.html#FwdRefs"><span class="hs-identifier hs-type">FwdRefs</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- A subset of uses that are</span><span>
</span><a name="line-1067"></a><span>                                </span><span class="hs-comment">--   (a) used before they are bound in this segment, or</span><span>
</span><a name="line-1068"></a><span>                                </span><span class="hs-comment">--   (b) used here, and bound in subsequent segments</span><span>
</span><a name="line-1069"></a><span>                      </span><a href="#local-6989586621682360206"><span class="hs-identifier hs-type">stmts</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Either Stmt or [Stmt]</span><span>
</span><a name="line-1070"></a><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span class="hs-comment">-- wrapper that does both the left- and right-hand sides</span><span>
</span><a name="line-1073"></a><span class="hs-identifier">rnRecStmtsAndThen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360234"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-1074"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360234"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1075"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360234"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360234"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1077"></a><span>                         </span><span class="hs-comment">-- assumes that the FreeVars returned includes</span><span>
</span><a name="line-1078"></a><span>                         </span><span class="hs-comment">-- the FreeVars of the Segments</span><span>
</span><a name="line-1079"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360234"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1080"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360235"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1081"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360235"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1082"></a><a name="rnRecStmtsAndThen"><a href="RnExpr.html#rnRecStmtsAndThen"><span class="hs-identifier">rnRecStmtsAndThen</span></a></a><span> </span><a name="local-6989586621682360846"><a href="#local-6989586621682360846"><span class="hs-identifier">rnBody</span></a></a><span> </span><a name="local-6989586621682360847"><a href="#local-6989586621682360847"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621682360848"><a href="#local-6989586621682360848"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1083"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- (A) Make the mini fixity env for all of the stmts</span><span>
</span><a name="line-1084"></a><span>          </span><a name="local-6989586621682360849"><a href="#local-6989586621682360849"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#makeMiniFixityEnv"><span class="hs-identifier hs-var">makeMiniFixityEnv</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#collectRecStmtsFixities"><span class="hs-identifier hs-var">collectRecStmtsFixities</span></a><span> </span><a href="#local-6989586621682360847"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1085"></a><span>
</span><a name="line-1086"></a><span>          </span><span class="hs-comment">-- (B) Do the LHSes</span><span>
</span><a name="line-1087"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682360850"><a href="#local-6989586621682360850"><span class="hs-identifier">new_lhs_and_fv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rn_rec_stmts_lhs"><span class="hs-identifier hs-var">rn_rec_stmts_lhs</span></a><span> </span><a href="#local-6989586621682360849"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682360847"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span>          </span><span class="hs-comment">--    ...bring them and their fixities into scope</span><span>
</span><a name="line-1090"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360851"><a href="#local-6989586621682360851"><span class="hs-identifier">bound_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectLStmtsBinders</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682360850"><span class="hs-identifier hs-var">new_lhs_and_fv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1091"></a><span>              </span><span class="hs-comment">-- Fake uses of variables introduced implicitly (warning suppression, see #4404)</span><span>
</span><a name="line-1092"></a><span>              </span><a name="local-6989586621682360852"><a href="#local-6989586621682360852"><span class="hs-identifier">implicit_uses</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lStmtsImplicits</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682360850"><span class="hs-identifier hs-var">new_lhs_and_fv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1093"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#bindLocalNamesFV"><span class="hs-identifier hs-var">bindLocalNamesFV</span></a><span> </span><a href="#local-6989586621682360851"><span class="hs-identifier hs-var">bound_names</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1094"></a><span>          </span><a href="RnFixity.html#addLocalFixities"><span class="hs-identifier hs-var">addLocalFixities</span></a><span> </span><a href="#local-6989586621682360849"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682360851"><span class="hs-identifier hs-var">bound_names</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span>          </span><span class="hs-comment">-- (C) do the right-hand-sides and thing-inside</span><span>
</span><a name="line-1097"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360853"><a href="#local-6989586621682360853"><span class="hs-identifier">segs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rn_rec_stmts"><span class="hs-identifier hs-var">rn_rec_stmts</span></a><span> </span><a href="#local-6989586621682360846"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360851"><span class="hs-identifier hs-var">bound_names</span></a><span> </span><a href="#local-6989586621682360850"><span class="hs-identifier hs-var">new_lhs_and_fv</span></a><span>
</span><a name="line-1098"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360854"><a href="#local-6989586621682360854"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360855"><a href="#local-6989586621682360855"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360848"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621682360853"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1099"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#warnUnusedLocalBinds"><span class="hs-identifier hs-var">warnUnusedLocalBinds</span></a><span> </span><a href="#local-6989586621682360851"><span class="hs-identifier hs-var">bound_names</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360855"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360852"><span class="hs-identifier hs-var">implicit_uses</span></a><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360854"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360855"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span class="hs-comment">-- get all the fixity decls in any Let stmt</span><span>
</span><a name="line-1103"></a><span class="hs-identifier">collectRecStmtsFixities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmtLR</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><a href="#local-6989586621682360233"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LFixitySig</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-1104"></a><a name="collectRecStmtsFixities"><a href="RnExpr.html#collectRecStmtsFixities"><span class="hs-identifier">collectRecStmtsFixities</span></a></a><span> </span><a name="local-6989586621682360856"><a href="#local-6989586621682360856"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1105"></a><span>    </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360857"><a href="#local-6989586621682360857"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682360858"><a href="#local-6989586621682360858"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360857"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1106"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360859"><a href="#local-6989586621682360859"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1107"></a><span>              </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360860"><a href="#local-6989586621682360860"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682360861"><a href="#local-6989586621682360861"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682360860"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1108"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360862"><a href="#local-6989586621682360862"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FixSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360863"><a href="#local-6989586621682360863"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360862"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682360863"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682360861"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1109"></a><span>                                         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682360861"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360858"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621682360859"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-1110"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682360858"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682360856"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span class="hs-comment">-- left-hand sides</span><span>
</span><a name="line-1113"></a><span>
</span><a name="line-1114"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682360232"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span>
</span><a name="line-1115"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><a href="#local-6989586621682360232"><span class="hs-identifier hs-type">body</span></a><span>
</span><a name="line-1116"></a><span>                   </span><span class="hs-comment">-- rename LHS, and return its FVs</span><span>
</span><a name="line-1117"></a><span>                   </span><span class="hs-comment">-- Warning: we will only need the FreeVars below in the case of a BindStmt,</span><span>
</span><a name="line-1118"></a><span>                   </span><span class="hs-comment">-- so we don't bother to compute it accurately in the other cases</span><span>
</span><a name="line-1119"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><a href="#local-6989586621682360232"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1120"></a><span>
</span><a name="line-1121"></a><a name="rn_rec_stmt_lhs"><a href="RnExpr.html#rn_rec_stmt_lhs"><span class="hs-identifier">rn_rec_stmt_lhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360864"><a href="#local-6989586621682360864"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360865"><a href="#local-6989586621682360865"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621682360866"><a href="#local-6989586621682360866"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621682360867"><a href="#local-6989586621682360867"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360864"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360865"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682360866"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621682360867"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1123"></a><span>
</span><a name="line-1124"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360868"><a href="#local-6989586621682360868"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360869"><a href="#local-6989586621682360869"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621682360870"><a href="#local-6989586621682360870"><span class="hs-identifier">noret</span></a></a><span> </span><a name="local-6989586621682360871"><a href="#local-6989586621682360871"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1125"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360868"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360869"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682360870"><span class="hs-identifier hs-var">noret</span></a><span> </span><a href="#local-6989586621682360871"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><a name="local-6989586621682360872"><a href="#local-6989586621682360872"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360873"><a href="#local-6989586621682360873"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360874"><a href="#local-6989586621682360874"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682360875"><a href="#local-6989586621682360875"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621682360876"><a href="#local-6989586621682360876"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621682360877"><a href="#local-6989586621682360877"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1129"></a><span>      </span><span class="hs-comment">-- should the ctxt be MDo instead?</span><span>
</span><a name="line-1130"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682360878"><a href="#local-6989586621682360878"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360879"><a href="#local-6989586621682360879"><span class="hs-identifier">fv_pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnPat.html#rnBindPat"><span class="hs-identifier hs-var">rnBindPat</span></a><span> </span><span class="hs-special">(</span><a href="RnPat.html#localRecNameMaker"><span class="hs-identifier hs-var">localRecNameMaker</span></a><span> </span><a href="#local-6989586621682360872"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360874"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-1131"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360873"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360878"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621682360875"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682360876"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621682360877"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360879"><span class="hs-identifier hs-var">fv_pat</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1132"></a><span>
</span><a name="line-1133"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360880"><a href="#local-6989586621682360880"><span class="hs-identifier">binds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#badIpBinds"><span class="hs-identifier hs-var">badIpBinds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;an mdo expression&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360880"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>
</span><a name="line-1136"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><a name="local-6989586621682360881"><a href="#local-6989586621682360881"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360882"><a href="#local-6989586621682360882"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360883"><a href="#local-6989586621682360883"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><a name="local-6989586621682360884"><a href="#local-6989586621682360884"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360885"><a href="#local-6989586621682360885"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1137"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360886"><a href="#local-6989586621682360886"><span class="hs-identifier">_bound_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360887"><a href="#local-6989586621682360887"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnLocalValBindsLHS"><span class="hs-identifier hs-var">rnLocalValBindsLHS</span></a><span> </span><a href="#local-6989586621682360881"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682360885"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1138"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360882"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360883"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><a href="#local-6989586621682360884"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360887"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1139"></a><span>                 </span><span class="hs-comment">-- Warning: this is bogus; see function invariant</span><span>
</span><a name="line-1140"></a><span>                 </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-1141"></a><span>                 </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span class="hs-comment">-- XXX Do we need to do something with the return and mfix names?</span><span>
</span><a name="line-1144"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><a name="local-6989586621682360888"><a href="#local-6989586621682360888"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682360889"><a href="#local-6989586621682360889"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Flatten Rec inside Rec</span><span>
</span><a name="line-1145"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#rn_rec_stmts_lhs"><span class="hs-identifier hs-var">rn_rec_stmts_lhs</span></a><span> </span><a href="#local-6989586621682360888"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682360889"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1146"></a><span>
</span><a name="line-1147"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360890"><a href="#local-6989586621682360890"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Syntactically illegal in mdo</span><span>
</span><a name="line-1148"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360890"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>
</span><a name="line-1150"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360891"><a href="#local-6989586621682360891"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Syntactically illegal in mdo</span><span>
</span><a name="line-1151"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360891"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360892"><a href="#local-6989586621682360892"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Shouldn't appear yet</span><span>
</span><a name="line-1154"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360892"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>
</span><a name="line-1156"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EmptyLocalBinds</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1157"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt LetStmt EmptyLocalBinds&quot;</span><span>
</span><a name="line-1158"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsLocalBindsLR</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt LetStmt XHsLocalBindsLR&quot;</span><span>
</span><a name="line-1160"></a><span class="hs-identifier">rn_rec_stmt_lhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1161"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt XStmtLR&quot;</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span class="hs-identifier">rn_rec_stmts_lhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682360231"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span>
</span><a name="line-1164"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><a href="#local-6989586621682360231"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span>
</span><a name="line-1165"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><a href="#local-6989586621682360231"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1166"></a><a name="rn_rec_stmts_lhs"><a href="RnExpr.html#rn_rec_stmts_lhs"><span class="hs-identifier">rn_rec_stmts_lhs</span></a></a><span> </span><a name="local-6989586621682360893"><a href="#local-6989586621682360893"><span class="hs-identifier">fix_env</span></a></a><span> </span><a name="local-6989586621682360894"><a href="#local-6989586621682360894"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-1167"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360895"><a href="#local-6989586621682360895"><span class="hs-identifier">ls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rn_rec_stmt_lhs"><span class="hs-identifier hs-var">rn_rec_stmt_lhs</span></a><span> </span><a href="#local-6989586621682360893"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360894"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1168"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360896"><a href="#local-6989586621682360896"><span class="hs-identifier">boundNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectLStmtsBinders</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682360895"><span class="hs-identifier hs-var">ls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1169"></a><span>            </span><span class="hs-comment">-- First do error checking: we need to check for dups here because we</span><span>
</span><a name="line-1170"></a><span>            </span><span class="hs-comment">-- don't bind all of the variables from the Stmt at once</span><span>
</span><a name="line-1171"></a><span>            </span><span class="hs-comment">-- with bindLocatedLocals.</span><span>
</span><a name="line-1172"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#checkDupNames"><span class="hs-identifier hs-var">checkDupNames</span></a><span> </span><a href="#local-6989586621682360896"><span class="hs-identifier hs-var">boundNames</span></a><span>
</span><a name="line-1173"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682360895"><span class="hs-identifier hs-var">ls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1174"></a><span>
</span><a name="line-1175"></a><span>
</span><a name="line-1176"></a><span class="hs-comment">-- right-hand-sides</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360230"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-1179"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360230"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360230"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1180"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1181"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360230"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1182"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360230"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1183"></a><span>        </span><span class="hs-comment">-- Rename a Stmt that is inside a RecStmt (or mdo)</span><span>
</span><a name="line-1184"></a><span>        </span><span class="hs-comment">-- Assumes all binders are already in scope</span><span>
</span><a name="line-1185"></a><span>        </span><span class="hs-comment">-- Turns each stmt into a singleton Stmt</span><span>
</span><a name="line-1186"></a><a name="rn_rec_stmt"><a href="RnExpr.html#rn_rec_stmt"><span class="hs-identifier">rn_rec_stmt</span></a></a><span> </span><a name="local-6989586621682360897"><a href="#local-6989586621682360897"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360898"><a href="#local-6989586621682360898"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360899"><a href="#local-6989586621682360899"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621682360900"><a href="#local-6989586621682360900"><span class="hs-identifier">noret</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1187"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360901"><a href="#local-6989586621682360901"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360902"><a href="#local-6989586621682360902"><span class="hs-identifier">fv_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360897"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360899"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1188"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360903"><a href="#local-6989586621682360903"><span class="hs-identifier">ret_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360904"><a href="#local-6989586621682360904"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-1189"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360902"><span class="hs-identifier hs-var">fv_expr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360904"><span class="hs-identifier hs-var">fvs1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">,</span><span>
</span><a name="line-1190"></a><span>                   </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360898"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360901"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682360900"><span class="hs-identifier hs-var">noret</span></a><span> </span><a href="#local-6989586621682360903"><span class="hs-identifier hs-var">ret_op</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><a name="local-6989586621682360905"><a href="#local-6989586621682360905"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360906"><a href="#local-6989586621682360906"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360907"><a href="#local-6989586621682360907"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1193"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360908"><a href="#local-6989586621682360908"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360909"><a href="#local-6989586621682360909"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360905"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360907"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1194"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360910"><a href="#local-6989586621682360910"><span class="hs-identifier">then_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360911"><a href="#local-6989586621682360911"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">thenMName</span><span>
</span><a name="line-1195"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360909"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360911"><span class="hs-identifier hs-var">fvs1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">,</span><span>
</span><a name="line-1196"></a><span>                 </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360906"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360908"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682360910"><span class="hs-identifier hs-var">then_op</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1197"></a><span>
</span><a name="line-1198"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><a name="local-6989586621682360912"><a href="#local-6989586621682360912"><span class="hs-identifier">rnBody</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360913"><a href="#local-6989586621682360913"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360914"><a href="#local-6989586621682360914"><span class="hs-identifier">pat'</span></a></a><span> </span><a name="local-6989586621682360915"><a href="#local-6989586621682360915"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360916"><a href="#local-6989586621682360916"><span class="hs-identifier">fv_pat</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1199"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360917"><a href="#local-6989586621682360917"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360918"><a href="#local-6989586621682360918"><span class="hs-identifier">fv_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360912"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360915"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1200"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360919"><a href="#local-6989586621682360919"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360920"><a href="#local-6989586621682360920"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">bindMName</span><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360921"><a href="#local-6989586621682360921"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360922"><a href="#local-6989586621682360922"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#getMonadFailOp"><span class="hs-identifier hs-var">getMonadFailOp</span></a><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360923"><a href="#local-6989586621682360923"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621682360914"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1205"></a><span>             </span><a name="local-6989586621682360924"><a href="#local-6989586621682360924"><span class="hs-identifier">fvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360918"><span class="hs-identifier hs-var">fv_expr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360916"><span class="hs-identifier hs-var">fv_pat</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360920"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360922"><span class="hs-identifier hs-var">fvs2</span></a><span>
</span><a name="line-1206"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682360923"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360924"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360923"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360924"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1207"></a><span>                  </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360913"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682360914"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621682360917"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682360919"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><a href="#local-6989586621682360921"><span class="hs-identifier hs-var">fail_op</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360925"><a href="#local-6989586621682360925"><span class="hs-identifier">binds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1210"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#badIpBinds"><span class="hs-identifier hs-var">badIpBinds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;an mdo expression&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360925"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1211"></a><span>
</span><a name="line-1212"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360926"><a href="#local-6989586621682360926"><span class="hs-identifier">all_bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360927"><a href="#local-6989586621682360927"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682360928"><a href="#local-6989586621682360928"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><a name="local-6989586621682360929"><a href="#local-6989586621682360929"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360930"><a href="#local-6989586621682360930"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1213"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360931"><a href="#local-6989586621682360931"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360932"><a href="#local-6989586621682360932"><span class="hs-identifier">du_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnLocalValBindsRHS"><span class="hs-identifier hs-var">rnLocalValBindsRHS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682360926"><span class="hs-identifier hs-var">all_bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360930"><span class="hs-identifier hs-var">binds'</span></a><span>
</span><a name="line-1214"></a><span>           </span><span class="hs-comment">-- fixities and unused are handled above in rnRecStmtsAndThen</span><span>
</span><a name="line-1215"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682360933"><a href="#local-6989586621682360933"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">allUses</span><span> </span><a href="#local-6989586621682360932"><span class="hs-identifier hs-var">du_binds</span></a><span>
</span><a name="line-1216"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">duDefs</span><span> </span><a href="#local-6989586621682360932"><span class="hs-identifier hs-var">du_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360933"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">,</span><span>
</span><a name="line-1217"></a><span>                 </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360927"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360928"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><a href="#local-6989586621682360929"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682360931"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1218"></a><span>
</span><a name="line-1219"></a><span class="hs-comment">-- no RecStmt case because they get flattened above when doing the LHSes</span><span>
</span><a name="line-1220"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360934"><a href="#local-6989586621682360934"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1221"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: RecStmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360934"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360935"><a href="#local-6989586621682360935"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Syntactically illegal in mdo</span><span>
</span><a name="line-1224"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: ParStmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360935"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1225"></a><span>
</span><a name="line-1226"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360936"><a href="#local-6989586621682360936"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Syntactically illegal in mdo</span><span>
</span><a name="line-1227"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: TransStmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360936"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsLocalBindsLR</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1230"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: LetStmt XHsLocalBindsLR&quot;</span><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EmptyLocalBinds</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1233"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: LetStmt EmptyLocalBinds&quot;</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360937"><a href="#local-6989586621682360937"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1236"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: ApplicativeStmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360937"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1237"></a><span>
</span><a name="line-1238"></a><span class="hs-identifier">rn_rec_stmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682360938"><a href="#local-6989586621682360938"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1239"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rn_rec_stmt: XStmtLR&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360938"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span class="hs-identifier">rn_rec_stmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360229"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-1242"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360229"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360229"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1243"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1244"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmtLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360229"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1245"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360229"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1246"></a><a name="rn_rec_stmts"><a href="RnExpr.html#rn_rec_stmts"><span class="hs-identifier">rn_rec_stmts</span></a></a><span> </span><a name="local-6989586621682360939"><a href="#local-6989586621682360939"><span class="hs-identifier">rnBody</span></a></a><span> </span><a name="local-6989586621682360940"><a href="#local-6989586621682360940"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621682360941"><a href="#local-6989586621682360941"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-1247"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682360942"><a href="#local-6989586621682360942"><span class="hs-identifier">segs_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rn_rec_stmt"><span class="hs-identifier hs-var">rn_rec_stmt</span></a><span> </span><a href="#local-6989586621682360939"><span class="hs-identifier hs-var">rnBody</span></a><span> </span><a href="#local-6989586621682360940"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360941"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1248"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682360942"><span class="hs-identifier hs-var">segs_s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1249"></a><span>
</span><a name="line-1250"></a><span class="hs-comment">---------------------------------------------</span><span>
</span><a name="line-1251"></a><span class="hs-identifier">segmentRecStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1252"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Stmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360228"><span class="hs-identifier hs-type">body</span></a><span>
</span><a name="line-1253"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360228"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>
</span><a name="line-1254"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360228"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1255"></a><span>
</span><a name="line-1256"></a><a name="segmentRecStmts"><a href="RnExpr.html#segmentRecStmts"><span class="hs-identifier">segmentRecStmts</span></a></a><span> </span><a name="local-6989586621682360943"><a href="#local-6989586621682360943"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682360944"><a href="#local-6989586621682360944"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682360945"><a href="#local-6989586621682360945"><span class="hs-identifier">empty_rec_stmt</span></a></a><span> </span><a name="local-6989586621682360946"><a href="#local-6989586621682360946"><span class="hs-identifier">segs</span></a></a><span> </span><a name="local-6989586621682360947"><a href="#local-6989586621682360947"><span class="hs-identifier">fvs_later</span></a></a><span>
</span><a name="line-1257"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682360946"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1258"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360947"><span class="hs-identifier hs-var">fvs_later</span></a><span class="hs-special">)</span><span>
</span><a name="line-1259"></a><span>
</span><a name="line-1260"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682360944"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#segsToStmts"><span class="hs-identifier hs-var">segsToStmts</span></a><span> </span><a href="#local-6989586621682360945"><span class="hs-identifier hs-var">empty_rec_stmt</span></a><span> </span><a href="#local-6989586621682360954"><span class="hs-identifier hs-var">grouped_segs</span></a><span> </span><a href="#local-6989586621682360947"><span class="hs-identifier hs-var">fvs_later</span></a><span>
</span><a name="line-1262"></a><span>               </span><span class="hs-comment">-- Step 4: Turn the segments into Stmts</span><span>
</span><a name="line-1263"></a><span>                </span><span class="hs-comment">--         Use RecStmt when and only when there are fwd refs</span><span>
</span><a name="line-1264"></a><span>                </span><span class="hs-comment">--         Also gather up the uses from the end towards the</span><span>
</span><a name="line-1265"></a><span>                </span><span class="hs-comment">--         start, so we can tell the RecStmt which things are</span><span>
</span><a name="line-1266"></a><span>                </span><span class="hs-comment">--         used 'after' the RecStmt</span><span>
</span><a name="line-1267"></a><span>
</span><a name="line-1268"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1269"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682360943"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1270"></a><span>       </span><a href="#local-6989586621682360945"><span class="hs-identifier hs-var">empty_rec_stmt</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360950"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1271"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_later_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span>
</span><a name="line-1272"></a><span>                                           </span><span class="hs-special">(</span><a href="#local-6989586621682360951"><span class="hs-identifier hs-var">defs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360947"><span class="hs-identifier hs-var">fvs_later</span></a><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_ids</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span>
</span><a name="line-1274"></a><span>                                           </span><span class="hs-special">(</span><a href="#local-6989586621682360951"><span class="hs-identifier hs-var">defs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360952"><span class="hs-identifier hs-var">uses</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">]</span><span>
</span><a name="line-1275"></a><span>          </span><span class="hs-comment">-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span><span>
</span><a name="line-1276"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360952"><span class="hs-identifier hs-var">uses</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360947"><span class="hs-identifier hs-var">fvs_later</span></a><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span>
</span><a name="line-1278"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1279"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682360948"><a href="#local-6989586621682360948"><span class="hs-identifier">defs_s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360949"><a href="#local-6989586621682360949"><span class="hs-identifier">uses_s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682360950"><a href="#local-6989586621682360950"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip4</span><span> </span><a href="#local-6989586621682360946"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1280"></a><span>    </span><a name="local-6989586621682360951"><a href="#local-6989586621682360951"><span class="hs-identifier">defs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360948"><span class="hs-identifier hs-var">defs_s</span></a><span>
</span><a name="line-1281"></a><span>    </span><a name="local-6989586621682360952"><a href="#local-6989586621682360952"><span class="hs-identifier">uses</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360949"><span class="hs-identifier hs-var">uses_s</span></a><span>
</span><a name="line-1282"></a><span>
</span><a name="line-1283"></a><span>                </span><span class="hs-comment">-- Step 2: Fill in the fwd refs.</span><span>
</span><a name="line-1284"></a><span>                </span><span class="hs-comment">--         The segments are all singletons, but their fwd-ref</span><span>
</span><a name="line-1285"></a><span>                </span><span class="hs-comment">--         field mentions all the things used by the segment</span><span>
</span><a name="line-1286"></a><span>                </span><span class="hs-comment">--         that are bound after their use</span><span>
</span><a name="line-1287"></a><span>    </span><a name="local-6989586621682360953"><a href="#local-6989586621682360953"><span class="hs-identifier">segs_w_fwd_refs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#addFwdRefs"><span class="hs-identifier hs-var">addFwdRefs</span></a><span> </span><a href="#local-6989586621682360946"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1288"></a><span>
</span><a name="line-1289"></a><span>                </span><span class="hs-comment">-- Step 3: Group together the segments to make bigger segments</span><span>
</span><a name="line-1290"></a><span>                </span><span class="hs-comment">--         Invariant: in the result, no segment uses a variable</span><span>
</span><a name="line-1291"></a><span>                </span><span class="hs-comment">--                    bound in a later segment</span><span>
</span><a name="line-1292"></a><span>    </span><a name="local-6989586621682360954"><a href="#local-6989586621682360954"><span class="hs-identifier">grouped_segs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#glomSegments"><span class="hs-identifier hs-var">glomSegments</span></a><span> </span><a href="#local-6989586621682360944"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360953"><span class="hs-identifier hs-var">segs_w_fwd_refs</span></a><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span class="hs-comment">----------------------------</span><span>
</span><a name="line-1295"></a><span class="hs-identifier">addFwdRefs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><a href="#local-6989586621682360227"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><a href="#local-6989586621682360227"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1296"></a><span class="hs-comment">-- So far the segments only have forward refs *within* the Stmt</span><span>
</span><a name="line-1297"></a><span class="hs-comment">--      (which happens for bind:  x &lt;- ...x...)</span><span>
</span><a name="line-1298"></a><span class="hs-comment">-- This function adds the cross-seg fwd ref info</span><span>
</span><a name="line-1299"></a><span>
</span><a name="line-1300"></a><a name="addFwdRefs"><a href="RnExpr.html#addFwdRefs"><span class="hs-identifier">addFwdRefs</span></a></a><span> </span><a name="local-6989586621682360955"><a href="#local-6989586621682360955"><span class="hs-identifier">segs</span></a></a><span>
</span><a name="line-1301"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682360956"><span class="hs-identifier hs-var">mk_seg</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682360955"><span class="hs-identifier hs-var">segs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1303"></a><span>    </span><a name="local-6989586621682360956"><a href="#local-6989586621682360956"><span class="hs-identifier">mk_seg</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682360957"><a href="#local-6989586621682360957"><span class="hs-identifier">defs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360958"><a href="#local-6989586621682360958"><span class="hs-identifier">uses</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360959"><a href="#local-6989586621682360959"><span class="hs-identifier">fwds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360960"><a href="#local-6989586621682360960"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682360961"><a href="#local-6989586621682360961"><span class="hs-identifier">segs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360962"><a href="#local-6989586621682360962"><span class="hs-identifier">later_defs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1304"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360963"><span class="hs-identifier hs-var">new_seg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682360961"><span class="hs-identifier hs-var">segs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360964"><span class="hs-identifier hs-var">all_defs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1305"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1306"></a><span>          </span><a name="local-6989586621682360963"><a href="#local-6989586621682360963"><span class="hs-identifier">new_seg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360957"><span class="hs-identifier hs-var">defs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360958"><span class="hs-identifier hs-var">uses</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360965"><span class="hs-identifier hs-var">new_fwds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360960"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1307"></a><span>          </span><a name="local-6989586621682360964"><a href="#local-6989586621682360964"><span class="hs-identifier">all_defs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360962"><span class="hs-identifier hs-var">later_defs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360957"><span class="hs-identifier hs-var">defs</span></a><span>
</span><a name="line-1308"></a><span>          </span><a name="local-6989586621682360965"><a href="#local-6989586621682360965"><span class="hs-identifier">new_fwds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360959"><span class="hs-identifier hs-var">fwds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360958"><span class="hs-identifier hs-var">uses</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360962"><span class="hs-identifier hs-var">later_defs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1309"></a><span>                </span><span class="hs-comment">-- Add the downstream fwd refs here</span><span>
</span><a name="line-1310"></a><span>
</span><a name="line-1311"></a><span class="hs-comment">{-
Note [Segmenting mdo]
~~~~~~~~~~~~~~~~~~~~~
NB. June 7 2012: We only glom segments that appear in an explicit mdo;
and leave those found in &quot;do rec&quot;'s intact.  See
http://ghc.haskell.org/trac/ghc/ticket/4148 for the discussion
leading to this design choice.  Hence the test in segmentRecStmts.

Note [Glomming segments]
~~~~~~~~~~~~~~~~~~~~~~~~
Glomming the singleton segments of an mdo into minimal recursive groups.

At first I thought this was just strongly connected components, but
there's an important constraint: the order of the stmts must not change.

Consider
     mdo { x &lt;- ...y...
           p &lt;- z
           y &lt;- ...x...
           q &lt;- x
           z &lt;- y
           r &lt;- x }

Here, the first stmt mention 'y', which is bound in the third.
But that means that the innocent second stmt (p &lt;- z) gets caught
up in the recursion.  And that in turn means that the binding for
'z' has to be included... and so on.

Start at the tail { r &lt;- x }
Now add the next one { z &lt;- y ; r &lt;- x }
Now add one more     { q &lt;- x ; z &lt;- y ; r &lt;- x }
Now one more... but this time we have to group a bunch into rec
     { rec { y &lt;- ...x... ; q &lt;- x ; z &lt;- y } ; r &lt;- x }
Now one more, which we can add on without a rec
     { p &lt;- z ;
       rec { y &lt;- ...x... ; q &lt;- x ; z &lt;- y } ;
       r &lt;- x }
Finally we add the last one; since it mentions y we have to
glom it together with the first two groups
     { rec { x &lt;- ...y...; p &lt;- z ; y &lt;- ...x... ;
             q &lt;- x ; z &lt;- y } ;
       r &lt;- x }
-}</span><span>
</span><a name="line-1354"></a><span>
</span><a name="line-1355"></a><span class="hs-identifier">glomSegments</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1356"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360226"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1357"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360226"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1358"></a><span>                                  </span><span class="hs-comment">-- Each segment has a non-empty list of Stmts</span><span>
</span><a name="line-1359"></a><span class="hs-comment">-- See Note [Glomming segments]</span><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><a name="glomSegments"><a href="RnExpr.html#glomSegments"><span class="hs-identifier">glomSegments</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1362"></a><span class="hs-identifier">glomSegments</span><span> </span><a name="local-6989586621682360966"><a href="#local-6989586621682360966"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360967"><a href="#local-6989586621682360967"><span class="hs-identifier">defs</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360968"><a href="#local-6989586621682360968"><span class="hs-identifier">uses</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360969"><a href="#local-6989586621682360969"><span class="hs-identifier">fwds</span></a></a><span class="hs-special">,</span><a name="local-6989586621682360970"><a href="#local-6989586621682360970"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682360971"><a href="#local-6989586621682360971"><span class="hs-identifier">segs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1363"></a><span>        </span><span class="hs-comment">-- Actually stmts will always be a singleton</span><span>
</span><a name="line-1364"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360979"><span class="hs-identifier hs-var">seg_defs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360980"><span class="hs-identifier hs-var">seg_uses</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360981"><span class="hs-identifier hs-var">seg_fwds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360982"><span class="hs-identifier hs-var">seg_stmts</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682360974"><span class="hs-identifier hs-var">others</span></a><span>
</span><a name="line-1365"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1366"></a><span>    </span><a name="local-6989586621682360972"><a href="#local-6989586621682360972"><span class="hs-identifier">segs'</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#glomSegments"><span class="hs-identifier hs-var">glomSegments</span></a><span> </span><a href="#local-6989586621682360966"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682360971"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1367"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682360973"><a href="#local-6989586621682360973"><span class="hs-identifier">extras</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360974"><a href="#local-6989586621682360974"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360983"><span class="hs-identifier hs-var">grab</span></a><span> </span><a href="#local-6989586621682360968"><span class="hs-identifier hs-var">uses</span></a><span> </span><a href="#local-6989586621682360972"><span class="hs-identifier hs-var">segs'</span></a><span>
</span><a name="line-1368"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682360975"><a href="#local-6989586621682360975"><span class="hs-identifier">ds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360976"><a href="#local-6989586621682360976"><span class="hs-identifier">us</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360977"><a href="#local-6989586621682360977"><span class="hs-identifier">fs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360978"><a href="#local-6989586621682360978"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip4</span><span> </span><a href="#local-6989586621682360973"><span class="hs-identifier hs-var">extras</span></a><span>
</span><a name="line-1369"></a><span>
</span><a name="line-1370"></a><span>    </span><a name="local-6989586621682360979"><a href="#local-6989586621682360979"><span class="hs-identifier">seg_defs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360975"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360967"><span class="hs-identifier hs-var">defs</span></a><span>
</span><a name="line-1371"></a><span>    </span><a name="local-6989586621682360980"><a href="#local-6989586621682360980"><span class="hs-identifier">seg_uses</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360976"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360968"><span class="hs-identifier hs-var">uses</span></a><span>
</span><a name="line-1372"></a><span>    </span><a name="local-6989586621682360981"><a href="#local-6989586621682360981"><span class="hs-identifier">seg_fwds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><a href="#local-6989586621682360977"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360969"><span class="hs-identifier hs-var">fwds</span></a><span>
</span><a name="line-1373"></a><span>    </span><a name="local-6989586621682360982"><a href="#local-6989586621682360982"><span class="hs-identifier">seg_stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360970"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682360978"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1374"></a><span>
</span><a name="line-1375"></a><span>    </span><span class="hs-identifier">grab</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>             </span><span class="hs-comment">-- The client</span><span>
</span><a name="line-1376"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><a href="#local-6989586621682360984"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1377"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><a href="#local-6989586621682360984"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- Needed by the 'client'</span><span>
</span><a name="line-1378"></a><span>             </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><a href="#local-6989586621682360984"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Not needed by the client</span><span>
</span><a name="line-1379"></a><span>        </span><span class="hs-comment">-- The result is simply a split of the input</span><span>
</span><a name="line-1380"></a><span>    </span><a name="local-6989586621682360983"><a href="#local-6989586621682360983"><span class="hs-identifier">grab</span></a></a><span> </span><a name="local-6989586621682360985"><a href="#local-6989586621682360985"><span class="hs-identifier">uses</span></a></a><span> </span><a name="local-6989586621682360986"><a href="#local-6989586621682360986"><span class="hs-identifier">dus</span></a></a><span>
</span><a name="line-1381"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682360988"><span class="hs-identifier hs-var">yeses</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682360987"><span class="hs-identifier hs-var">noes</span></a><span class="hs-special">)</span><span>
</span><a name="line-1382"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1383"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621682360987"><a href="#local-6989586621682360987"><span class="hs-identifier">noes</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360988"><a href="#local-6989586621682360988"><span class="hs-identifier">yeses</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><a href="#local-6989586621682360989"><span class="hs-identifier hs-var">not_needed</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682360986"><span class="hs-identifier hs-var">dus</span></a><span class="hs-special">)</span><span>
</span><a name="line-1384"></a><span>          </span><a name="local-6989586621682360989"><a href="#local-6989586621682360989"><span class="hs-identifier">not_needed</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682360990"><a href="#local-6989586621682360990"><span class="hs-identifier">defs</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intersectsNameSet</span><span> </span><a href="#local-6989586621682360990"><span class="hs-identifier hs-var">defs</span></a><span> </span><a href="#local-6989586621682360985"><span class="hs-identifier hs-var">uses</span></a><span class="hs-special">)</span><span>
</span><a name="line-1385"></a><span>
</span><a name="line-1386"></a><span class="hs-comment">----------------------------------------------------</span><span>
</span><a name="line-1387"></a><span class="hs-identifier">segsToStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Stmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360225"><span class="hs-identifier hs-type">body</span></a><span>
</span><a name="line-1388"></a><span>                                  </span><span class="hs-comment">-- A RecStmt with the SyntaxOps filled in</span><span>
</span><a name="line-1389"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnExpr.html#Segment"><span class="hs-identifier hs-type">Segment</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360225"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1390"></a><span>                                  </span><span class="hs-comment">-- Each Segment has a non-empty list of Stmts</span><span>
</span><a name="line-1391"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>           </span><span class="hs-comment">-- Free vars used 'later'</span><span>
</span><a name="line-1392"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682360225"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><a name="segsToStmts"><a href="RnExpr.html#segsToStmts"><span class="hs-identifier">segsToStmts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682360991"><a href="#local-6989586621682360991"><span class="hs-identifier">fvs_later</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682360991"><span class="hs-identifier hs-var">fvs_later</span></a><span class="hs-special">)</span><span>
</span><a name="line-1395"></a><span class="hs-identifier">segsToStmts</span><span> </span><a name="local-6989586621682360992"><a href="#local-6989586621682360992"><span class="hs-identifier">empty_rec_stmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682360993"><a href="#local-6989586621682360993"><span class="hs-identifier">defs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360994"><a href="#local-6989586621682360994"><span class="hs-identifier">uses</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360995"><a href="#local-6989586621682360995"><span class="hs-identifier">fwds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682360996"><a href="#local-6989586621682360996"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682360997"><a href="#local-6989586621682360997"><span class="hs-identifier">segs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682360998"><a href="#local-6989586621682360998"><span class="hs-identifier">fvs_later</span></a></a><span>
</span><a name="line-1396"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">ss</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1397"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621682361001"><span class="hs-identifier hs-var">new_stmt</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682360999"><span class="hs-identifier hs-var">later_stmts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361000"><span class="hs-identifier hs-var">later_uses</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682360994"><span class="hs-identifier hs-var">uses</span></a><span class="hs-special">)</span><span>
</span><a name="line-1398"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1399"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682360999"><a href="#local-6989586621682360999"><span class="hs-identifier">later_stmts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361000"><a href="#local-6989586621682361000"><span class="hs-identifier">later_uses</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#segsToStmts"><span class="hs-identifier hs-var">segsToStmts</span></a><span> </span><a href="#local-6989586621682360992"><span class="hs-identifier hs-var">empty_rec_stmt</span></a><span> </span><a href="#local-6989586621682360997"><span class="hs-identifier hs-var">segs</span></a><span> </span><a href="#local-6989586621682360998"><span class="hs-identifier hs-var">fvs_later</span></a><span>
</span><a name="line-1400"></a><span>    </span><a name="local-6989586621682361001"><a href="#local-6989586621682361001"><span class="hs-identifier">new_stmt</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361003"><span class="hs-identifier hs-var">non_rec</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682360996"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1401"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682360996"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361002"><span class="hs-identifier hs-var">rec_stmt</span></a><span>
</span><a name="line-1402"></a><span>    </span><a name="local-6989586621682361002"><a href="#local-6989586621682361002"><span class="hs-identifier">rec_stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360992"><span class="hs-identifier hs-var">empty_rec_stmt</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360996"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1403"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_later_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><a href="#local-6989586621682361004"><span class="hs-identifier hs-var">used_later</span></a><span>
</span><a name="line-1404"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_ids</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><a href="#local-6989586621682360995"><span class="hs-identifier hs-var">fwds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1405"></a><span>          </span><span class="hs-comment">-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span><span>
</span><a name="line-1406"></a><span>    </span><a name="local-6989586621682361003"><a href="#local-6989586621682361003"><span class="hs-identifier">non_rec</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isSingleton</span><span> </span><a href="#local-6989586621682360996"><span class="hs-identifier hs-var">ss</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isEmptyNameSet</span><span> </span><a href="#local-6989586621682360995"><span class="hs-identifier hs-var">fwds</span></a><span>
</span><a name="line-1407"></a><span>    </span><a name="local-6989586621682361004"><a href="#local-6989586621682361004"><span class="hs-identifier">used_later</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682360993"><span class="hs-identifier hs-var">defs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361000"><span class="hs-identifier hs-var">later_uses</span></a><span>
</span><a name="line-1408"></a><span>                                </span><span class="hs-comment">-- The ones needed after the RecStmt</span><span>
</span><a name="line-1409"></a><span>
</span><a name="line-1410"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
ApplicativeDo
*                                                                      *
************************************************************************

Note [ApplicativeDo]

= Example =

For a sequence of statements

 do
     x &lt;- A
     y &lt;- B x
     z &lt;- C
     return (f x y z)

We want to transform this to

  (\(x,y) z -&gt; f x y z) &lt;$&gt; (do x &lt;- A; y &lt;- B x; return (x,y)) &lt;*&gt; C

It would be easy to notice that &quot;y &lt;- B x&quot; and &quot;z &lt;- C&quot; are
independent and do something like this:

 do
     x &lt;- A
     (y,z) &lt;- (,) &lt;$&gt; B x &lt;*&gt; C
     return (f x y z)

But this isn't enough! A and C were also independent, and this
transformation loses the ability to do A and C in parallel.

The algorithm works by first splitting the sequence of statements into
independent &quot;segments&quot;, and a separate &quot;tail&quot; (the final statement). In
our example above, the segements would be

     [ x &lt;- A
     , y &lt;- B x ]

     [ z &lt;- C ]

and the tail is:

     return (f x y z)

Then we take these segments and make an Applicative expression from them:

     (\(x,y) z -&gt; return (f x y z))
       &lt;$&gt; do { x &lt;- A; y &lt;- B x; return (x,y) }
       &lt;*&gt; C

Finally, we recursively apply the transformation to each segment, to
discover any nested parallelism.

= Syntax &amp; spec =

  expr ::= ... | do {stmt_1; ..; stmt_n} expr | ...

  stmt ::= pat &lt;- expr
         | (arg_1 | ... | arg_n)  -- applicative composition, n&gt;=1
         | ...                    -- other kinds of statement (e.g. let)

  arg ::= pat &lt;- expr
        | {stmt_1; ..; stmt_n} {var_1..var_n}

(note that in the actual implementation,the expr in a do statement is
represented by a LastStmt as the final stmt, this is just a
representational issue and may change later.)

== Transformation to introduce applicative stmts ==

ado {} tail = tail
ado {pat &lt;- expr} {return expr'} = (mkArg(pat &lt;- expr)); return expr'
ado {one} tail = one : tail
ado stmts tail
  | n == 1 = ado before (ado after tail)
    where (before,after) = split(stmts_1)
  | n &gt; 1  = (mkArg(stmts_1) | ... | mkArg(stmts_n)); tail
  where
    {stmts_1 .. stmts_n} = segments(stmts)

segments(stmts) =
  -- divide stmts into segments with no interdependencies

mkArg({pat &lt;- expr}) = (pat &lt;- expr)
mkArg({stmt_1; ...; stmt_n}) =
  {stmt_1; ...; stmt_n} {vars(stmt_1) u .. u vars(stmt_n)}

split({stmt_1; ..; stmt_n) =
  ({stmt_1; ..; stmt_i}, {stmt_i+1; ..; stmt_n})
  -- 1 &lt;= i &lt;= n
  -- i is a good place to insert a bind

== Desugaring for do ==

dsDo {} expr = expr

dsDo {pat &lt;- rhs; stmts} expr =
   rhs &gt;&gt;= \pat -&gt; dsDo stmts expr

dsDo {(arg_1 | ... | arg_n)} (return expr) =
  (\argpat (arg_1) .. argpat(arg_n) -&gt; expr)
     &lt;$&gt; argexpr(arg_1)
     &lt;*&gt; ...
     &lt;*&gt; argexpr(arg_n)

dsDo {(arg_1 | ... | arg_n); stmts} expr =
  join (\argpat (arg_1) .. argpat(arg_n) -&gt; dsDo stmts expr)
     &lt;$&gt; argexpr(arg_1)
     &lt;*&gt; ...
     &lt;*&gt; argexpr(arg_n)

-}</span><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-comment">-- | The 'Name's of @return@ and @pure@. These may not be 'returnName' and</span><span>
</span><a name="line-1527"></a><span class="hs-comment">-- 'pureName' due to @RebindableSyntax@.</span><span>
</span><a name="line-1528"></a><span class="hs-keyword">data</span><span> </span><a name="MonadNames"><a href="RnExpr.html#MonadNames"><span class="hs-identifier">MonadNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MonadNames"><a href="RnExpr.html#MonadNames"><span class="hs-identifier">MonadNames</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="return_name"><a href="RnExpr.html#return_name"><span class="hs-identifier">return_name</span></a></a><span class="hs-special">,</span><span> </span><a name="pure_name"><a href="RnExpr.html#pure_name"><span class="hs-identifier">pure_name</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1529"></a><span>
</span><a name="line-1530"></a><span class="hs-comment">-- | rearrange a list of statements using ApplicativeDoStmt.  See</span><span>
</span><a name="line-1531"></a><span class="hs-comment">-- Note [ApplicativeDo].</span><span>
</span><a name="line-1532"></a><span class="hs-identifier">rearrangeForApplicativeDo</span><span>
</span><a name="line-1533"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1534"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1535"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1536"></a><span>
</span><a name="line-1537"></a><a name="rearrangeForApplicativeDo"><a href="RnExpr.html#rearrangeForApplicativeDo"><span class="hs-identifier">rearrangeForApplicativeDo</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span>
</span><a name="line-1538"></a><span class="hs-identifier">rearrangeForApplicativeDo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-6989586621682361005"><a href="#local-6989586621682361005"><span class="hs-identifier">one</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682361005"><span class="hs-identifier hs-var">one</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span>
</span><a name="line-1539"></a><span class="hs-identifier">rearrangeForApplicativeDo</span><span> </span><a name="local-6989586621682361006"><a href="#local-6989586621682361006"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361007"><a href="#local-6989586621682361007"><span class="hs-identifier">stmts0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1540"></a><span>  </span><a name="local-6989586621682361017"><a href="#local-6989586621682361017"><span class="hs-identifier">optimal_ado</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_OptimalApplicativeDo</span><span>
</span><a name="line-1541"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361018"><a href="#local-6989586621682361018"><span class="hs-identifier">stmt_tree</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361017"><span class="hs-identifier hs-var">optimal_ado</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#mkStmtTreeOptimal"><span class="hs-identifier hs-var">mkStmtTreeOptimal</span></a><span> </span><a href="#local-6989586621682361008"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1542"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#mkStmtTreeHeuristic"><span class="hs-identifier hs-var">mkStmtTreeHeuristic</span></a><span> </span><a href="#local-6989586621682361008"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1543"></a><span>  </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rearrangeForADo&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682361018"><span class="hs-identifier hs-var">stmt_tree</span></a><span class="hs-special">)</span><span>
</span><a name="line-1544"></a><span>  </span><a name="local-6989586621682361019"><a href="#local-6989586621682361019"><span class="hs-identifier">return_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName%27"><span class="hs-identifier hs-var">lookupSyntaxName'</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-1545"></a><span>  </span><a name="local-6989586621682361020"><a href="#local-6989586621682361020"><span class="hs-identifier">pure_name</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName%27"><span class="hs-identifier hs-var">lookupSyntaxName'</span></a><span> </span><span class="hs-identifier hs-var">pureAName</span><span>
</span><a name="line-1546"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361021"><a href="#local-6989586621682361021"><span class="hs-identifier">monad_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#MonadNames"><span class="hs-identifier hs-var">MonadNames</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">return_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361019"><span class="hs-identifier hs-var">return_name</span></a><span>
</span><a name="line-1547"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pure_name</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361020"><span class="hs-identifier hs-var">pure_name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1548"></a><span>  </span><a href="RnExpr.html#stmtTreeToStmts"><span class="hs-identifier hs-var">stmtTreeToStmts</span></a><span> </span><a href="#local-6989586621682361021"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361006"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361018"><span class="hs-identifier hs-var">stmt_tree</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682361009"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682361010"><span class="hs-identifier hs-var">last_fvs</span></a><span>
</span><a name="line-1549"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1550"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682361008"><a href="#local-6989586621682361008"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621682361009"><a href="#local-6989586621682361009"><span class="hs-identifier">last</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361010"><a href="#local-6989586621682361010"><span class="hs-identifier">last_fvs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361011"><span class="hs-identifier hs-var">findLast</span></a><span> </span><a href="#local-6989586621682361007"><span class="hs-identifier hs-var">stmts0</span></a><span>
</span><a name="line-1551"></a><span>    </span><a name="local-6989586621682361011"><a href="#local-6989586621682361011"><span class="hs-identifier">findLast</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;findLast&quot;</span><span>
</span><a name="line-1552"></a><span>    </span><span class="hs-identifier">findLast</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682361012"><a href="#local-6989586621682361012"><span class="hs-identifier">last</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><a href="#local-6989586621682361012"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">)</span><span>
</span><a name="line-1553"></a><span>    </span><span class="hs-identifier">findLast</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361013"><a href="#local-6989586621682361013"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682361014"><a href="#local-6989586621682361014"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361013"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682361015"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><a href="#local-6989586621682361016"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361015"><a href="#local-6989586621682361015"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361016"><a href="#local-6989586621682361016"><span class="hs-identifier">last</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361011"><span class="hs-identifier hs-var">findLast</span></a><span> </span><a href="#local-6989586621682361014"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1554"></a><span>
</span><a name="line-1555"></a><span class="hs-comment">-- | A tree of statements using a mixture of applicative and bind constructs.</span><span>
</span><a name="line-1556"></a><span class="hs-keyword">data</span><span> </span><a name="StmtTree"><a href="RnExpr.html#StmtTree"><span class="hs-identifier">StmtTree</span></a></a><span> </span><a name="local-6989586621682360205"><a href="#local-6989586621682360205"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-1557"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="StmtTreeOne"><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier">StmtTreeOne</span></a></a><span> </span><a href="#local-6989586621682360205"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1558"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="StmtTreeBind"><a href="RnExpr.html#StmtTreeBind"><span class="hs-identifier">StmtTreeBind</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTree"><span class="hs-identifier hs-type">StmtTree</span></a><span> </span><a href="#local-6989586621682360205"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTree"><span class="hs-identifier hs-type">StmtTree</span></a><span> </span><a href="#local-6989586621682360205"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1559"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="StmtTreeApplicative"><a href="RnExpr.html#StmtTreeApplicative"><span class="hs-identifier">StmtTreeApplicative</span></a></a><span> </span><span class="hs-special">[</span><a href="RnExpr.html#StmtTree"><span class="hs-identifier hs-type">StmtTree</span></a><span> </span><a href="#local-6989586621682360205"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1560"></a><span>
</span><a name="line-1561"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682360207"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTree"><span class="hs-identifier hs-type">StmtTree</span></a><span> </span><a href="#local-6989586621682360207"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1562"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><a name="local-6989586621682360208"><a href="#local-6989586621682360208"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StmtTreeOne&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360208"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1563"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeBind"><span class="hs-identifier hs-var">StmtTreeBind</span></a><span> </span><a name="local-6989586621682360209"><a href="#local-6989586621682360209"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682360210"><a href="#local-6989586621682360210"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StmtTreeBind&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1564"></a><span>                                            </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360209"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360210"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeApplicative"><span class="hs-identifier hs-var">StmtTreeApplicative</span></a><span> </span><a name="local-6989586621682360211"><a href="#local-6989586621682360211"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StmtTreeApplicative&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1566"></a><span>                                            </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682360211"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1567"></a><span>
</span><a name="line-1568"></a><span class="hs-identifier">flattenStmtTree</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnExpr.html#StmtTree"><span class="hs-identifier hs-type">StmtTree</span></a><span> </span><a href="#local-6989586621682360224"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682360224"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1569"></a><a name="flattenStmtTree"><a href="RnExpr.html#flattenStmtTree"><span class="hs-identifier">flattenStmtTree</span></a></a><span> </span><a name="local-6989586621682361022"><a href="#local-6989586621682361022"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361023"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682361022"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1570"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1571"></a><span>  </span><a name="local-6989586621682361023"><a href="#local-6989586621682361023"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><a name="local-6989586621682361024"><a href="#local-6989586621682361024"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361024"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1572"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeBind"><span class="hs-identifier hs-var">StmtTreeBind</span></a><span> </span><a name="local-6989586621682361026"><a href="#local-6989586621682361026"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682361027"><a href="#local-6989586621682361027"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361023"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682361026"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361023"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682361027"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1573"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeApplicative"><span class="hs-identifier hs-var">StmtTreeApplicative</span></a><span> </span><a name="local-6989586621682361029"><a href="#local-6989586621682361029"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682361023"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621682361029"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-1574"></a><span>
</span><a name="line-1575"></a><span class="hs-keyword">type</span><span> </span><a name="ExprStmtTree"><a href="RnExpr.html#ExprStmtTree"><span class="hs-identifier">ExprStmtTree</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#StmtTree"><span class="hs-identifier hs-type">StmtTree</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span class="hs-keyword">type</span><span> </span><a name="Cost"><a href="RnExpr.html#Cost"><span class="hs-identifier">Cost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1577"></a><span>
</span><a name="line-1578"></a><span class="hs-comment">-- | Turn a sequence of statements into an ExprStmtTree using a</span><span>
</span><a name="line-1579"></a><span class="hs-comment">-- heuristic algorithm.  /O(n^2)/</span><span>
</span><a name="line-1580"></a><span class="hs-identifier">mkStmtTreeHeuristic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#ExprStmtTree"><span class="hs-identifier hs-type">ExprStmtTree</span></a><span>
</span><a name="line-1581"></a><a name="mkStmtTreeHeuristic"><a href="RnExpr.html#mkStmtTreeHeuristic"><span class="hs-identifier">mkStmtTreeHeuristic</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682361031"><a href="#local-6989586621682361031"><span class="hs-identifier">one</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><a href="#local-6989586621682361031"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-1582"></a><span class="hs-identifier">mkStmtTreeHeuristic</span><span> </span><a name="local-6989586621682361032"><a href="#local-6989586621682361032"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1583"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="RnExpr.html#segments"><span class="hs-identifier hs-var">segments</span></a><span> </span><a href="#local-6989586621682361032"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1584"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621682361038"><a href="#local-6989586621682361038"><span class="hs-identifier">one</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361033"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621682361038"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-1585"></a><span>    </span><a name="local-6989586621682361039"><a href="#local-6989586621682361039"><span class="hs-identifier">segs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#StmtTreeApplicative"><span class="hs-identifier hs-var">StmtTreeApplicative</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682361033"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621682361039"><span class="hs-identifier hs-var">segs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1586"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1587"></a><span>  </span><a name="local-6989586621682361033"><a href="#local-6989586621682361033"><span class="hs-identifier">split</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682361034"><a href="#local-6989586621682361034"><span class="hs-identifier">one</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><a href="#local-6989586621682361034"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-identifier">split</span><span> </span><a name="local-6989586621682361035"><a href="#local-6989586621682361035"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1589"></a><span>    </span><a href="RnExpr.html#StmtTreeBind"><span class="hs-identifier hs-var">StmtTreeBind</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#mkStmtTreeHeuristic"><span class="hs-identifier hs-var">mkStmtTreeHeuristic</span></a><span> </span><a href="#local-6989586621682361036"><span class="hs-identifier hs-var">before</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#mkStmtTreeHeuristic"><span class="hs-identifier hs-var">mkStmtTreeHeuristic</span></a><span> </span><a href="#local-6989586621682361037"><span class="hs-identifier hs-var">after</span></a><span class="hs-special">)</span><span>
</span><a name="line-1590"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361036"><a href="#local-6989586621682361036"><span class="hs-identifier">before</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361037"><a href="#local-6989586621682361037"><span class="hs-identifier">after</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#splitSegment"><span class="hs-identifier hs-var">splitSegment</span></a><span> </span><a href="#local-6989586621682361035"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1591"></a><span>
</span><a name="line-1592"></a><span class="hs-comment">-- | Turn a sequence of statements into an ExprStmtTree optimally,</span><span>
</span><a name="line-1593"></a><span class="hs-comment">-- using dynamic programming.  /O(n^3)/</span><span>
</span><a name="line-1594"></a><span class="hs-identifier">mkStmtTreeOptimal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#ExprStmtTree"><span class="hs-identifier hs-type">ExprStmtTree</span></a><span>
</span><a name="line-1595"></a><a name="mkStmtTreeOptimal"><a href="RnExpr.html#mkStmtTreeOptimal"><span class="hs-identifier">mkStmtTreeOptimal</span></a></a><span> </span><a name="local-6989586621682361040"><a href="#local-6989586621682361040"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1596"></a><span>  </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">stmts</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the empty case is handled by the caller;</span><span>
</span><a name="line-1597"></a><span>                           </span><span class="hs-comment">-- we don't support empty StmtTrees.</span><span>
</span><a name="line-1598"></a><span>  </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361043"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><a href="#local-6989586621682361041"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1600"></a><span>    </span><a name="local-6989586621682361041"><a href="#local-6989586621682361041"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682361040"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1601"></a><span>    </span><a name="local-6989586621682361042"><a href="#local-6989586621682361042"><span class="hs-identifier">stmt_arr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><a href="#local-6989586621682361041"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361040"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1602"></a><span>
</span><a name="line-1603"></a><span>    </span><span class="hs-comment">-- lazy cache of optimal trees for subsequences of the input</span><span>
</span><a name="line-1604"></a><span>    </span><span class="hs-identifier">arr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#ExprStmtTree"><span class="hs-identifier hs-type">ExprStmtTree</span></a><span class="hs-special">,</span><span> </span><a href="RnExpr.html#Cost"><span class="hs-identifier hs-type">Cost</span></a><span class="hs-special">)</span><span>
</span><a name="line-1605"></a><span>    </span><a name="local-6989586621682361043"><a href="#local-6989586621682361043"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">array</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><a href="#local-6989586621682361041"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><a href="#local-6989586621682361041"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1606"></a><span>             </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682361046"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">,</span><a href="#local-6989586621682361047"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361044"><span class="hs-identifier hs-var">tree</span></a><span> </span><a href="#local-6989586621682361046"><span class="hs-identifier hs-var">lo</span></a><span> </span><a href="#local-6989586621682361047"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span>
</span><a name="line-1607"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682361046"><a href="#local-6989586621682361046"><span class="hs-identifier">lo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><a href="#local-6989586621682361041"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span>
</span><a name="line-1608"></a><span>             </span><span class="hs-special">,</span><span> </span><a name="local-6989586621682361047"><a href="#local-6989586621682361047"><span class="hs-identifier">hi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682361046"><span class="hs-identifier hs-var">lo</span></a><span class="hs-glyph">..</span><a href="#local-6989586621682361041"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1609"></a><span>
</span><a name="line-1610"></a><span>    </span><span class="hs-comment">-- compute the optimal tree for the sequence [lo..hi]</span><span>
</span><a name="line-1611"></a><span>    </span><a name="local-6989586621682361044"><a href="#local-6989586621682361044"><span class="hs-identifier">tree</span></a></a><span> </span><a name="local-6989586621682361048"><a href="#local-6989586621682361048"><span class="hs-identifier">lo</span></a></a><span> </span><a name="local-6989586621682361049"><a href="#local-6989586621682361049"><span class="hs-identifier">hi</span></a></a><span>
</span><a name="line-1612"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361049"><span class="hs-identifier hs-var">hi</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682361048"><span class="hs-identifier hs-var">lo</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361048"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1613"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1614"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="RnExpr.html#segments"><span class="hs-identifier hs-var">segments</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361050"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682361050"><a href="#local-6989586621682361050"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682361048"><span class="hs-identifier hs-var">lo</span></a><span class="hs-glyph">..</span><a href="#local-6989586621682361049"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1615"></a><span>           </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkStmtTree&quot;</span><span>
</span><a name="line-1616"></a><span>           </span><span class="hs-special">[</span><a name="local-6989586621682361051"><a href="#local-6989586621682361051"><span class="hs-identifier">_one</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361045"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621682361048"><span class="hs-identifier hs-var">lo</span></a><span> </span><a href="#local-6989586621682361049"><span class="hs-identifier hs-var">hi</span></a><span>
</span><a name="line-1617"></a><span>           </span><a name="local-6989586621682361052"><a href="#local-6989586621682361052"><span class="hs-identifier">segs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeApplicative"><span class="hs-identifier hs-var">StmtTreeApplicative</span></a><span> </span><a href="#local-6989586621682361054"><span class="hs-identifier hs-var">trees</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maximum</span><span> </span><a href="#local-6989586621682361055"><span class="hs-identifier hs-var">costs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1618"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-1619"></a><span>               </span><a name="local-6989586621682361053"><a href="#local-6989586621682361053"><span class="hs-identifier">bounds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scanl</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682361056"><a href="#local-6989586621682361056"><span class="hs-identifier">hi</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682361057"><a href="#local-6989586621682361057"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361056"><span class="hs-identifier hs-var">hi</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361056"><span class="hs-identifier hs-var">hi</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682361057"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><a href="#local-6989586621682361048"><span class="hs-identifier hs-var">lo</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361052"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1620"></a><span>               </span><span class="hs-special">(</span><a name="local-6989586621682361054"><a href="#local-6989586621682361054"><span class="hs-identifier">trees</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361055"><a href="#local-6989586621682361055"><span class="hs-identifier">costs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="#local-6989586621682361045"><span class="hs-identifier hs-var">split</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621682361053"><span class="hs-identifier hs-var">bounds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1621"></a><span>
</span><a name="line-1622"></a><span>    </span><span class="hs-comment">-- find the best place to split the segment [lo..hi]</span><span>
</span><a name="line-1623"></a><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#ExprStmtTree"><span class="hs-identifier hs-type">ExprStmtTree</span></a><span class="hs-special">,</span><span> </span><a href="RnExpr.html#Cost"><span class="hs-identifier hs-type">Cost</span></a><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>    </span><a name="local-6989586621682361045"><a href="#local-6989586621682361045"><span class="hs-identifier">split</span></a></a><span> </span><a name="local-6989586621682361058"><a href="#local-6989586621682361058"><span class="hs-identifier">lo</span></a></a><span> </span><a name="local-6989586621682361059"><a href="#local-6989586621682361059"><span class="hs-identifier">hi</span></a></a><span>
</span><a name="line-1625"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1626"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeBind"><span class="hs-identifier hs-var">StmtTreeBind</span></a><span> </span><a href="#local-6989586621682361060"><span class="hs-identifier hs-var">before</span></a><span> </span><a href="#local-6989586621682361062"><span class="hs-identifier hs-var">after</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361061"><span class="hs-identifier hs-var">c1</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621682361063"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1627"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1628"></a><span>         </span><span class="hs-comment">-- As per the paper, for a sequence s1...sn, we want to find</span><span>
</span><a name="line-1629"></a><span>         </span><span class="hs-comment">-- the split with the minimum cost, where the cost is the</span><span>
</span><a name="line-1630"></a><span>         </span><span class="hs-comment">-- sum of the cost of the left and right subsequences.</span><span>
</span><a name="line-1631"></a><span>         </span><span class="hs-comment">--</span><span>
</span><a name="line-1632"></a><span>         </span><span class="hs-comment">-- As an optimisation (also in the paper) if the cost of</span><span>
</span><a name="line-1633"></a><span>         </span><span class="hs-comment">-- s1..s(n-1) is different from the cost of s2..sn, we know</span><span>
</span><a name="line-1634"></a><span>         </span><span class="hs-comment">-- that the optimal solution is the lower of the two.  Only</span><span>
</span><a name="line-1635"></a><span>         </span><span class="hs-comment">-- in the case that these two have the same cost do we need</span><span>
</span><a name="line-1636"></a><span>         </span><span class="hs-comment">-- to do the exhaustive search.</span><span>
</span><a name="line-1637"></a><span>         </span><span class="hs-comment">--</span><span>
</span><a name="line-1638"></a><span>         </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682361060"><a href="#local-6989586621682361060"><span class="hs-identifier">before</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361061"><a href="#local-6989586621682361061"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621682361062"><a href="#local-6989586621682361062"><span class="hs-identifier">after</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361063"><a href="#local-6989586621682361063"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1639"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1640"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1641"></a><span>              </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1642"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361065"><span class="hs-identifier hs-var">left_cost</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621682361067"><span class="hs-identifier hs-var">right_cost</span></a><span>
</span><a name="line-1643"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682361064"><span class="hs-identifier hs-var">left</span></a><span class="hs-special">,</span><a href="#local-6989586621682361065"><span class="hs-identifier hs-var">left_cost</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1644"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361065"><span class="hs-identifier hs-var">left_cost</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621682361067"><span class="hs-identifier hs-var">right_cost</span></a><span>
</span><a name="line-1645"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361042"><span class="hs-identifier hs-var">stmt_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361066"><span class="hs-identifier hs-var">right</span></a><span class="hs-special">,</span><a href="#local-6989586621682361067"><span class="hs-identifier hs-var">right_cost</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1646"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">minimumBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><a href="#local-6989586621682361068"><span class="hs-identifier hs-var">cost</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361069"><span class="hs-identifier hs-var">alternatives</span></a><span>
</span><a name="line-1647"></a><span>           </span><span class="hs-keyword">where</span><span>
</span><a name="line-1648"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682361064"><a href="#local-6989586621682361064"><span class="hs-identifier">left</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361065"><a href="#local-6989586621682361065"><span class="hs-identifier">left_cost</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361043"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">,</span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1649"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682361066"><a href="#local-6989586621682361066"><span class="hs-identifier">right</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361067"><a href="#local-6989586621682361067"><span class="hs-identifier">right_cost</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361043"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span>
</span><a name="line-1650"></a><span>             </span><a name="local-6989586621682361068"><a href="#local-6989586621682361068"><span class="hs-identifier">cost</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682361070"><a href="#local-6989586621682361070"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682361071"><a href="#local-6989586621682361071"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361070"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682361071"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1651"></a><span>             </span><a name="local-6989586621682361069"><a href="#local-6989586621682361069"><span class="hs-identifier">alternatives</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361043"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span class="hs-special">,</span><a href="#local-6989586621682361072"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361043"><span class="hs-identifier hs-var">arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361072"><span class="hs-identifier hs-var">k</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1652"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682361072"><a href="#local-6989586621682361072"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682361058"><span class="hs-identifier hs-var">lo</span></a><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621682361059"><span class="hs-identifier hs-var">hi</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1653"></a><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span class="hs-comment">-- | Turn the ExprStmtTree back into a sequence of statements, using</span><span>
</span><a name="line-1656"></a><span class="hs-comment">-- ApplicativeStmt where necessary.</span><span>
</span><a name="line-1657"></a><span class="hs-identifier">stmtTreeToStmts</span><span>
</span><a name="line-1658"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="RnExpr.html#MonadNames"><span class="hs-identifier hs-type">MonadNames</span></a><span>
</span><a name="line-1659"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1660"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#ExprStmtTree"><span class="hs-identifier hs-type">ExprStmtTree</span></a><span>
</span><a name="line-1661"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- ^ the &quot;tail&quot;</span><span>
</span><a name="line-1662"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span>                     </span><span class="hs-comment">-- ^ free variables of the tail</span><span>
</span><a name="line-1663"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- ( output statements,</span><span>
</span><a name="line-1664"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span> </span><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- , things we needed</span><span>
</span><a name="line-1665"></a><span>
</span><a name="line-1666"></a><span class="hs-comment">-- If we have a single bind, and we can do it without a join, transform</span><span>
</span><a name="line-1667"></a><span class="hs-comment">-- to an ApplicativeStmt.  This corresponds to the rule</span><span>
</span><a name="line-1668"></a><span class="hs-comment">--   dsBlock [pat &lt;- rhs] (return expr) = expr &lt;$&gt; rhs</span><span>
</span><a name="line-1669"></a><span class="hs-comment">-- In the spec, but we do it here rather than in the desugarer,</span><span>
</span><a name="line-1670"></a><span class="hs-comment">-- because we need the typechecker to typecheck the &lt;$&gt; form rather than</span><span>
</span><a name="line-1671"></a><span class="hs-comment">-- the bind form, which would give rise to a Monad constraint.</span><span>
</span><a name="line-1672"></a><a name="stmtTreeToStmts"><a href="RnExpr.html#stmtTreeToStmts"><span class="hs-identifier">stmtTreeToStmts</span></a></a><span> </span><a name="local-6989586621682361073"><a href="#local-6989586621682361073"><span class="hs-identifier">monad_names</span></a></a><span> </span><a name="local-6989586621682361074"><a href="#local-6989586621682361074"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361075"><a href="#local-6989586621682361075"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682361076"><a href="#local-6989586621682361076"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1673"></a><span>                </span><a name="local-6989586621682361077"><a href="#local-6989586621682361077"><span class="hs-identifier">tail</span></a></a><span> </span><a name="local-6989586621682361078"><a href="#local-6989586621682361078"><span class="hs-identifier">_tail_fvs</span></a></a><span>
</span><a name="line-1674"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361075"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><a name="local-6989586621682361079"><a href="#local-6989586621682361079"><span class="hs-identifier">tail'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#needJoin"><span class="hs-identifier hs-var">needJoin</span></a><span> </span><a href="#local-6989586621682361073"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361077"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-1675"></a><span>  </span><span class="hs-comment">-- See Note [ApplicativeDo and strict patterns]</span><span>
</span><a name="line-1676"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#mkApplicativeStmt"><span class="hs-identifier hs-var">mkApplicativeStmt</span></a><span> </span><a href="#local-6989586621682361074"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682361075"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621682361076"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682361079"><span class="hs-identifier hs-var">tail'</span></a><span>
</span><a name="line-1677"></a><span class="hs-identifier">stmtTreeToStmts</span><span> </span><a name="local-6989586621682361080"><a href="#local-6989586621682361080"><span class="hs-identifier">monad_names</span></a></a><span> </span><a name="local-6989586621682361081"><a href="#local-6989586621682361081"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361082"><a href="#local-6989586621682361082"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1678"></a><span>                </span><a name="local-6989586621682361083"><a href="#local-6989586621682361083"><span class="hs-identifier">tail</span></a></a><span> </span><a name="local-6989586621682361084"><a href="#local-6989586621682361084"><span class="hs-identifier">_tail_fvs</span></a></a><span>
</span><a name="line-1679"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><a name="local-6989586621682361085"><a href="#local-6989586621682361085"><span class="hs-identifier">tail'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#needJoin"><span class="hs-identifier hs-var">needJoin</span></a><span> </span><a href="#local-6989586621682361080"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361083"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-1680"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#mkApplicativeStmt"><span class="hs-identifier hs-var">mkApplicativeStmt</span></a><span> </span><a href="#local-6989586621682361081"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1681"></a><span>      </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-identifier hs-var">nlWildPatName</span><span> </span><a href="#local-6989586621682361082"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682361085"><span class="hs-identifier hs-var">tail'</span></a><span>
</span><a name="line-1682"></a><span>
</span><a name="line-1683"></a><span class="hs-identifier">stmtTreeToStmts</span><span> </span><a name="local-6989586621682361086"><a href="#local-6989586621682361086"><span class="hs-identifier">_monad_names</span></a></a><span> </span><a name="local-6989586621682361087"><a href="#local-6989586621682361087"><span class="hs-identifier">_ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682361088"><a href="#local-6989586621682361088"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682361089"><a href="#local-6989586621682361089"><span class="hs-identifier">tail</span></a></a><span> </span><a name="local-6989586621682361090"><a href="#local-6989586621682361090"><span class="hs-identifier">_tail_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1684"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361088"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361089"><span class="hs-identifier hs-var">tail</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span>
</span><a name="line-1685"></a><span>
</span><a name="line-1686"></a><span class="hs-identifier">stmtTreeToStmts</span><span> </span><a name="local-6989586621682361091"><a href="#local-6989586621682361091"><span class="hs-identifier">monad_names</span></a></a><span> </span><a name="local-6989586621682361092"><a href="#local-6989586621682361092"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeBind"><span class="hs-identifier hs-var">StmtTreeBind</span></a><span> </span><a name="local-6989586621682361093"><a href="#local-6989586621682361093"><span class="hs-identifier">before</span></a></a><span> </span><a name="local-6989586621682361094"><a href="#local-6989586621682361094"><span class="hs-identifier">after</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682361095"><a href="#local-6989586621682361095"><span class="hs-identifier">tail</span></a></a><span> </span><a name="local-6989586621682361096"><a href="#local-6989586621682361096"><span class="hs-identifier">tail_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1687"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621682361097"><a href="#local-6989586621682361097"><span class="hs-identifier">stmts1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361098"><a href="#local-6989586621682361098"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#stmtTreeToStmts"><span class="hs-identifier hs-var">stmtTreeToStmts</span></a><span> </span><a href="#local-6989586621682361091"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361092"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361094"><span class="hs-identifier hs-var">after</span></a><span> </span><a href="#local-6989586621682361095"><span class="hs-identifier hs-var">tail</span></a><span> </span><a href="#local-6989586621682361096"><span class="hs-identifier hs-var">tail_fvs</span></a><span>
</span><a name="line-1688"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361099"><a href="#local-6989586621682361099"><span class="hs-identifier">tail1_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionNameSets</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361096"><span class="hs-identifier hs-var">tail_fvs</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#flattenStmtTree"><span class="hs-identifier hs-var">flattenStmtTree</span></a><span> </span><a href="#local-6989586621682361094"><span class="hs-identifier hs-var">after</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1689"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621682361100"><a href="#local-6989586621682361100"><span class="hs-identifier">stmts2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361101"><a href="#local-6989586621682361101"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#stmtTreeToStmts"><span class="hs-identifier hs-var">stmtTreeToStmts</span></a><span> </span><a href="#local-6989586621682361091"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361092"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361093"><span class="hs-identifier hs-var">before</span></a><span> </span><a href="#local-6989586621682361097"><span class="hs-identifier hs-var">stmts1</span></a><span> </span><a href="#local-6989586621682361099"><span class="hs-identifier hs-var">tail1_fvs</span></a><span>
</span><a name="line-1690"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361100"><span class="hs-identifier hs-var">stmts2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361098"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361101"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>
</span><a name="line-1692"></a><span class="hs-identifier">stmtTreeToStmts</span><span> </span><a name="local-6989586621682361102"><a href="#local-6989586621682361102"><span class="hs-identifier">monad_names</span></a></a><span> </span><a name="local-6989586621682361103"><a href="#local-6989586621682361103"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeApplicative"><span class="hs-identifier hs-var">StmtTreeApplicative</span></a><span> </span><a name="local-6989586621682361104"><a href="#local-6989586621682361104"><span class="hs-identifier">trees</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682361105"><a href="#local-6989586621682361105"><span class="hs-identifier">tail</span></a></a><span> </span><a name="local-6989586621682361106"><a href="#local-6989586621682361106"><span class="hs-identifier">tail_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1693"></a><span>   </span><a name="local-6989586621682361129"><a href="#local-6989586621682361129"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361107"><span class="hs-identifier hs-var">stmtTreeArg</span></a><span> </span><a href="#local-6989586621682361103"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361106"><span class="hs-identifier hs-var">tail_fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361104"><span class="hs-identifier hs-var">trees</span></a><span>
</span><a name="line-1694"></a><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361130"><a href="#local-6989586621682361130"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361131"><a href="#local-6989586621682361131"><span class="hs-identifier">fvss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621682361129"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1695"></a><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361132"><a href="#local-6989586621682361132"><span class="hs-identifier">need_join</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361133"><a href="#local-6989586621682361133"><span class="hs-identifier">tail'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#needJoin"><span class="hs-identifier hs-var">needJoin</span></a><span> </span><a href="#local-6989586621682361102"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361105"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-1696"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682361134"><a href="#local-6989586621682361134"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361135"><a href="#local-6989586621682361135"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#mkApplicativeStmt"><span class="hs-identifier hs-var">mkApplicativeStmt</span></a><span> </span><a href="#local-6989586621682361103"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361130"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><a href="#local-6989586621682361132"><span class="hs-identifier hs-var">need_join</span></a><span> </span><a href="#local-6989586621682361133"><span class="hs-identifier hs-var">tail'</span></a><span>
</span><a name="line-1697"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361134"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unionNameSets</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361135"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682361131"><span class="hs-identifier hs-var">fvss</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1698"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1699"></a><span>   </span><a name="local-6989586621682361107"><a href="#local-6989586621682361107"><span class="hs-identifier">stmtTreeArg</span></a></a><span> </span><a name="local-6989586621682361108"><a href="#local-6989586621682361108"><span class="hs-identifier">_ctxt</span></a></a><span> </span><a name="local-6989586621682361109"><a href="#local-6989586621682361109"><span class="hs-identifier">_tail_fvs</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361110"><a href="#local-6989586621682361110"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682361111"><a href="#local-6989586621682361111"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1700"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682361110"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621682361111"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1701"></a><span>   </span><span class="hs-identifier">stmtTreeArg</span><span> </span><a name="local-6989586621682361112"><a href="#local-6989586621682361112"><span class="hs-identifier">_ctxt</span></a></a><span> </span><a name="local-6989586621682361113"><a href="#local-6989586621682361113"><span class="hs-identifier">_tail_fvs</span></a></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#StmtTreeOne"><span class="hs-identifier hs-var">StmtTreeOne</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361114"><a href="#local-6989586621682361114"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1702"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-identifier hs-var">nlWildPatName</span><span> </span><a href="#local-6989586621682361114"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1703"></a><span>   </span><span class="hs-identifier">stmtTreeArg</span><span> </span><a name="local-6989586621682361115"><a href="#local-6989586621682361115"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361116"><a href="#local-6989586621682361116"><span class="hs-identifier">tail_fvs</span></a></a><span> </span><a name="local-6989586621682361117"><a href="#local-6989586621682361117"><span class="hs-identifier">tree</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1704"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361118"><a href="#local-6989586621682361118"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#flattenStmtTree"><span class="hs-identifier hs-var">flattenStmtTree</span></a><span> </span><a href="#local-6989586621682361117"><span class="hs-identifier hs-var">tree</span></a><span>
</span><a name="line-1705"></a><span>         </span><a name="local-6989586621682361119"><a href="#local-6989586621682361119"><span class="hs-identifier">pvarset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectStmtBinders</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unLoc</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361118"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1706"></a><span>                     </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361116"><span class="hs-identifier hs-var">tail_fvs</span></a><span>
</span><a name="line-1707"></a><span>         </span><a name="local-6989586621682361120"><a href="#local-6989586621682361120"><span class="hs-identifier">pvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><a href="#local-6989586621682361119"><span class="hs-identifier hs-var">pvarset</span></a><span>
</span><a name="line-1708"></a><span>           </span><span class="hs-comment">-- See Note [Deterministic ApplicativeDo and RecursiveDo desugaring]</span><span>
</span><a name="line-1709"></a><span>         </span><a name="local-6989586621682361121"><a href="#local-6989586621682361121"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigLHsVarPatTup</span><span> </span><a href="#local-6989586621682361120"><span class="hs-identifier hs-var">pvars</span></a><span>
</span><a name="line-1710"></a><span>         </span><a name="local-6989586621682361122"><a href="#local-6989586621682361122"><span class="hs-identifier">tup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigLHsVarTup</span><span> </span><a href="#local-6989586621682361120"><span class="hs-identifier hs-var">pvars</span></a><span>
</span><a name="line-1711"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621682361123"><a href="#local-6989586621682361123"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361124"><a href="#local-6989586621682361124"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#stmtTreeToStmts"><span class="hs-identifier hs-var">stmtTreeToStmts</span></a><span> </span><a href="#local-6989586621682361102"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361115"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361117"><span class="hs-identifier hs-var">tree</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682361119"><span class="hs-identifier hs-var">pvarset</span></a><span>
</span><a name="line-1712"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621682361127"><a href="#local-6989586621682361127"><span class="hs-identifier">mb_ret</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361128"><a href="#local-6989586621682361128"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1713"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">ApplicativeStmt</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621682361123"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1714"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682361122"><span class="hs-identifier hs-var">tup</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span>
</span><a name="line-1715"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1716"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682361125"><a href="#local-6989586621682361125"><span class="hs-identifier">ret</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361126"><a href="#local-6989586621682361126"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtNamePoly"><span class="hs-identifier hs-var">lookupStmtNamePoly</span></a><span> </span><a href="#local-6989586621682361115"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-1717"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682361125"><span class="hs-identifier hs-var">ret</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361122"><span class="hs-identifier hs-var">tup</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361126"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1718"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">ApplicativeArgMany</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682361123"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><a href="#local-6989586621682361127"><span class="hs-identifier hs-var">mb_ret</span></a><span> </span><a href="#local-6989586621682361121"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-1719"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361128"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361124"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1720"></a><span>
</span><a name="line-1721"></a><span>
</span><a name="line-1722"></a><span class="hs-comment">-- | Divide a sequence of statements into segments, where no segment</span><span>
</span><a name="line-1723"></a><span class="hs-comment">-- depends on any variables defined by a statement in another segment.</span><span>
</span><a name="line-1724"></a><span class="hs-identifier">segments</span><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1726"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1727"></a><a name="segments"><a href="RnExpr.html#segments"><span class="hs-identifier">segments</span></a></a><span> </span><a name="local-6989586621682361136"><a href="#local-6989586621682361136"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682361138"><span class="hs-identifier hs-var">merge</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682361139"><span class="hs-identifier hs-var">walk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682361136"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1728"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1729"></a><span>    </span><a name="local-6989586621682361137"><a href="#local-6989586621682361137"><span class="hs-identifier">allvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectStmtBinders</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unLoc</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361136"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1730"></a><span>
</span><a name="line-1731"></a><span>    </span><span class="hs-comment">-- We would rather not have a segment that just has LetStmts in</span><span>
</span><a name="line-1732"></a><span>    </span><span class="hs-comment">-- it, so combine those with an adjacent segment where possible.</span><span>
</span><a name="line-1733"></a><span>    </span><a name="local-6989586621682361138"><a href="#local-6989586621682361138"><span class="hs-identifier">merge</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1734"></a><span>    </span><span class="hs-identifier">merge</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361143"><a href="#local-6989586621682361143"><span class="hs-identifier">seg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682361144"><a href="#local-6989586621682361144"><span class="hs-identifier">segs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1735"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361145"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1736"></a><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682361143"><span class="hs-identifier hs-var">seg</span></a><span class="hs-special">,</span><a href="#local-6989586621682361146"><span class="hs-identifier hs-var">all_lets</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1737"></a><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682361147"><a href="#local-6989586621682361147"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361148"><a href="#local-6989586621682361148"><span class="hs-identifier">s_lets</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621682361149"><a href="#local-6989586621682361149"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361146"><span class="hs-identifier hs-var">all_lets</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682361148"><span class="hs-identifier hs-var">s_lets</span></a><span>
</span><a name="line-1738"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361143"><span class="hs-identifier hs-var">seg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682361147"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361146"><span class="hs-identifier hs-var">all_lets</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682361148"><span class="hs-identifier hs-var">s_lets</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361149"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1739"></a><span>          </span><a name="local-6989586621682361150"><a href="#local-6989586621682361150"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361143"><span class="hs-identifier hs-var">seg</span></a><span class="hs-special">,</span><a href="#local-6989586621682361146"><span class="hs-identifier hs-var">all_lets</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361145"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1740"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1741"></a><span>        </span><a name="local-6989586621682361145"><a href="#local-6989586621682361145"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361138"><span class="hs-identifier hs-var">merge</span></a><span> </span><a href="#local-6989586621682361144"><span class="hs-identifier hs-var">segs</span></a><span>
</span><a name="line-1742"></a><span>        </span><a name="local-6989586621682361146"><a href="#local-6989586621682361146"><span class="hs-identifier">all_lets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#isLetStmt"><span class="hs-identifier hs-var">isLetStmt</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361143"><span class="hs-identifier hs-var">seg</span></a><span>
</span><a name="line-1743"></a><span>
</span><a name="line-1744"></a><span>    </span><span class="hs-comment">-- walk splits the statement sequence into segments, traversing</span><span>
</span><a name="line-1745"></a><span>    </span><span class="hs-comment">-- the sequence from the back to the front, and keeping track of</span><span>
</span><a name="line-1746"></a><span>    </span><span class="hs-comment">-- the set of free variables of the current segment.  Whenever</span><span>
</span><a name="line-1747"></a><span>    </span><span class="hs-comment">-- this set of free variables is empty, we have a complete segment.</span><span>
</span><a name="line-1748"></a><span>    </span><span class="hs-identifier">walk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1749"></a><span>    </span><a name="local-6989586621682361139"><a href="#local-6989586621682361139"><span class="hs-identifier">walk</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1750"></a><span>    </span><span class="hs-identifier">walk</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682361151"><a href="#local-6989586621682361151"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361152"><a href="#local-6989586621682361152"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682361153"><a href="#local-6989586621682361153"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682361151"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">,</span><a href="#local-6989586621682361152"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361154"><span class="hs-identifier hs-var">seg</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361139"><span class="hs-identifier hs-var">walk</span></a><span> </span><a href="#local-6989586621682361155"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1751"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361154"><a href="#local-6989586621682361154"><span class="hs-identifier">seg</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361155"><a href="#local-6989586621682361155"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361140"><span class="hs-identifier hs-var">chunter</span></a><span> </span><a href="#local-6989586621682361156"><span class="hs-identifier hs-var">fvs'</span></a><span> </span><a href="#local-6989586621682361153"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1752"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682361156"><a href="#local-6989586621682361156"><span class="hs-identifier">fvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361141"><span class="hs-identifier hs-var">stmtRefs</span></a><span> </span><a href="#local-6989586621682361151"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621682361152"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1753"></a><span>
</span><a name="line-1754"></a><span>    </span><a name="local-6989586621682361140"><a href="#local-6989586621682361140"><span class="hs-identifier">chunter</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1755"></a><span>    </span><span class="hs-identifier">chunter</span><span> </span><a name="local-6989586621682361157"><a href="#local-6989586621682361157"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682361158"><a href="#local-6989586621682361158"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361159"><a href="#local-6989586621682361159"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682361160"><a href="#local-6989586621682361160"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1756"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyNameSet</span><span> </span><a href="#local-6989586621682361157"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1757"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682361142"><span class="hs-identifier hs-var">isStrictPatternBind</span></a><span> </span><a href="#local-6989586621682361158"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-1758"></a><span>           </span><span class="hs-comment">-- See Note [ApplicativeDo and strict patterns]</span><span>
</span><a name="line-1759"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682361158"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">,</span><a href="#local-6989586621682361159"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361161"><span class="hs-identifier hs-var">chunk</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361162"><span class="hs-identifier hs-var">rest'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1760"></a><span>       </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361161"><a href="#local-6989586621682361161"><span class="hs-identifier">chunk</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361162"><a href="#local-6989586621682361162"><span class="hs-identifier">rest'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361140"><span class="hs-identifier hs-var">chunter</span></a><span> </span><a href="#local-6989586621682361165"><span class="hs-identifier hs-var">vars'</span></a><span> </span><a href="#local-6989586621682361160"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1761"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682361163"><a href="#local-6989586621682361163"><span class="hs-identifier">pvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361164"><a href="#local-6989586621682361164"><span class="hs-identifier">evars</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361141"><span class="hs-identifier hs-var">stmtRefs</span></a><span> </span><a href="#local-6989586621682361158"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621682361159"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1762"></a><span>             </span><a name="local-6989586621682361165"><a href="#local-6989586621682361165"><span class="hs-identifier">vars'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361157"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361163"><span class="hs-identifier hs-var">pvars</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361164"><span class="hs-identifier hs-var">evars</span></a><span>
</span><a name="line-1763"></a><span>    </span><span class="hs-identifier">chunter</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361166"><a href="#local-6989586621682361166"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361166"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1764"></a><span>
</span><a name="line-1765"></a><span>    </span><a name="local-6989586621682361141"><a href="#local-6989586621682361141"><span class="hs-identifier">stmtRefs</span></a></a><span> </span><a name="local-6989586621682361167"><a href="#local-6989586621682361167"><span class="hs-identifier">stmt</span></a></a><span> </span><a name="local-6989586621682361168"><a href="#local-6989586621682361168"><span class="hs-identifier">fvs</span></a></a><span>
</span><a name="line-1766"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="RnExpr.html#isLetStmt"><span class="hs-identifier hs-var">isLetStmt</span></a><span> </span><a href="#local-6989586621682361167"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361170"><span class="hs-identifier hs-var">pvars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361169"><span class="hs-identifier hs-var">fvs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361170"><span class="hs-identifier hs-var">pvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1767"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361170"><span class="hs-identifier hs-var">pvars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361169"><span class="hs-identifier hs-var">fvs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1768"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682361169"><a href="#local-6989586621682361169"><span class="hs-identifier">fvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361168"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361137"><span class="hs-identifier hs-var">allvars</span></a><span>
</span><a name="line-1769"></a><span>            </span><a name="local-6989586621682361170"><a href="#local-6989586621682361170"><span class="hs-identifier">pvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectStmtBinders</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682361167"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span>    </span><span class="hs-identifier">isStrictPatternBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1772"></a><span>    </span><a name="local-6989586621682361142"><a href="#local-6989586621682361142"><span class="hs-identifier">isStrictPatternBind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361171"><a href="#local-6989586621682361171"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361171"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-1773"></a><span>    </span><span class="hs-identifier">isStrictPatternBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1774"></a><span>
</span><a name="line-1775"></a><span class="hs-comment">{-
Note [ApplicativeDo and strict patterns]

A strict pattern match is really a dependency.  For example,

do
  (x,y) &lt;- A
  z &lt;- B
  return C

The pattern (_,_) must be matched strictly before we do B.  If we
allowed this to be transformed into

  (\(x,y) -&gt; \z -&gt; C) &lt;$&gt; A &lt;*&gt; B

then it could be lazier than the standard desuraging using &gt;&gt;=.  See #13875
for more examples.

Thus, whenever we have a strict pattern match, we treat it as a
dependency between that statement and the following one.  The
dependency prevents those two statements from being performed &quot;in
parallel&quot; in an ApplicativeStmt, but doesn't otherwise affect what we
can do with the rest of the statements in the same &quot;do&quot; expression.
-}</span><span>
</span><a name="line-1799"></a><span>
</span><a name="line-1800"></a><span class="hs-identifier">isStrictPattern</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682360223"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1801"></a><a name="isStrictPattern"><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier">isStrictPattern</span></a></a><span> </span><a name="local-6989586621682361172"><a href="#local-6989586621682361172"><span class="hs-identifier">lpat</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1802"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682361172"><span class="hs-identifier hs-var">lpat</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1803"></a><span>    </span><span class="hs-identifier hs-var">WildPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1804"></a><span>    </span><span class="hs-identifier hs-var">VarPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1805"></a><span>    </span><span class="hs-identifier hs-var">LazyPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1806"></a><span>    </span><span class="hs-identifier hs-var">AsPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361173"><a href="#local-6989586621682361173"><span class="hs-identifier">p</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361173"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1807"></a><span>    </span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361174"><a href="#local-6989586621682361174"><span class="hs-identifier">p</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361174"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1808"></a><span>    </span><span class="hs-identifier hs-var">ViewPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361175"><a href="#local-6989586621682361175"><span class="hs-identifier">p</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361175"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1809"></a><span>    </span><span class="hs-identifier hs-var">SigPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361176"><a href="#local-6989586621682361176"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361176"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1810"></a><span>    </span><span class="hs-identifier hs-var">BangPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1811"></a><span>    </span><span class="hs-identifier hs-var">ListPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1812"></a><span>    </span><span class="hs-identifier hs-var">TuplePat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1813"></a><span>    </span><span class="hs-identifier hs-var">SumPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1814"></a><span>    </span><span class="hs-identifier hs-var">ConPatIn</span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1815"></a><span>    </span><span class="hs-identifier hs-var">ConPatOut</span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1816"></a><span>    </span><span class="hs-identifier hs-var">LitPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1817"></a><span>    </span><span class="hs-identifier hs-var">NPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1818"></a><span>    </span><span class="hs-identifier hs-var">NPlusKPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1819"></a><span>    </span><span class="hs-identifier hs-var">SplicePat</span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1820"></a><span>    </span><a name="local-6989586621682361177"><a href="#local-6989586621682361177"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;isStrictPattern&quot;</span><span>
</span><a name="line-1821"></a><span>
</span><a name="line-1822"></a><span class="hs-identifier">isLetStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LStmt</span><span> </span><a href="#local-6989586621682360221"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621682360222"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1823"></a><a name="isLetStmt"><a href="RnExpr.html#isLetStmt"><span class="hs-identifier">isLetStmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">LetStmt</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1824"></a><span class="hs-identifier">isLetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1825"></a><span>
</span><a name="line-1826"></a><span class="hs-comment">-- | Find a &quot;good&quot; place to insert a bind in an indivisible segment.</span><span>
</span><a name="line-1827"></a><span class="hs-comment">-- This is the only place where we use heuristics.  The current</span><span>
</span><a name="line-1828"></a><span class="hs-comment">-- heuristic is to peel off the first group of independent statements</span><span>
</span><a name="line-1829"></a><span class="hs-comment">-- and put the bind after those.</span><span>
</span><a name="line-1830"></a><span class="hs-identifier">splitSegment</span><span>
</span><a name="line-1831"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1832"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1833"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1834"></a><a name="splitSegment"><a href="RnExpr.html#splitSegment"><span class="hs-identifier">splitSegment</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682361178"><a href="#local-6989586621682361178"><span class="hs-identifier">one</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361179"><a href="#local-6989586621682361179"><span class="hs-identifier">two</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682361178"><span class="hs-identifier hs-var">one</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><a href="#local-6989586621682361179"><span class="hs-identifier hs-var">two</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1835"></a><span>  </span><span class="hs-comment">-- there is no choice when there are only two statements; this just saves</span><span>
</span><a name="line-1836"></a><span>  </span><span class="hs-comment">-- some work in a common case.</span><span>
</span><a name="line-1837"></a><span class="hs-identifier">splitSegment</span><span> </span><a name="local-6989586621682361180"><a href="#local-6989586621682361180"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-1838"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361181"><a href="#local-6989586621682361181"><span class="hs-identifier">lets</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361182"><a href="#local-6989586621682361182"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><a name="local-6989586621682361183"><a href="#local-6989586621682361183"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#slurpIndependentStmts"><span class="hs-identifier hs-var">slurpIndependentStmts</span></a><span> </span><a href="#local-6989586621682361180"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1839"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682361181"><span class="hs-identifier hs-var">lets</span></a><span class="hs-special">)</span><span>
</span><a name="line-1840"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361181"><span class="hs-identifier hs-var">lets</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361182"><span class="hs-identifier hs-var">binds</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621682361183"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1841"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361181"><span class="hs-identifier hs-var">lets</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621682361182"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361183"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1842"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1843"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361180"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1844"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682361184"><a href="#local-6989586621682361184"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682361185"><a href="#local-6989586621682361185"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682361184"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="#local-6989586621682361185"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1845"></a><span>      </span><a name="local-6989586621682361186"><a href="#local-6989586621682361186"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361180"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1846"></a><span>
</span><a name="line-1847"></a><span class="hs-identifier">slurpIndependentStmts</span><span>
</span><a name="line-1848"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360220"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1849"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360220"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- LetStmts</span><span>
</span><a name="line-1850"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360220"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- BindStmts</span><span>
</span><a name="line-1851"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360220"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1852"></a><a name="slurpIndependentStmts"><a href="RnExpr.html#slurpIndependentStmts"><span class="hs-identifier">slurpIndependentStmts</span></a></a><span> </span><a name="local-6989586621682361187"><a href="#local-6989586621682361187"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361188"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><a href="#local-6989586621682361187"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1853"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1854"></a><span>  </span><span class="hs-comment">-- If we encounter a BindStmt that doesn't depend on a previous BindStmt</span><span>
</span><a name="line-1855"></a><span>  </span><span class="hs-comment">-- in this group, then add it to the group. We have to be careful about</span><span>
</span><a name="line-1856"></a><span>  </span><span class="hs-comment">-- strict patterns though; splitSegments expects that if we return Just</span><span>
</span><a name="line-1857"></a><span>  </span><span class="hs-comment">-- then we have actually done some splitting. Otherwise it will go into</span><span>
</span><a name="line-1858"></a><span>  </span><span class="hs-comment">-- an infinite loop (#14163).</span><span>
</span><a name="line-1859"></a><span>  </span><a name="local-6989586621682361188"><a href="#local-6989586621682361188"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682361189"><a href="#local-6989586621682361189"><span class="hs-identifier">lets</span></a></a><span> </span><a name="local-6989586621682361190"><a href="#local-6989586621682361190"><span class="hs-identifier">indep</span></a></a><span> </span><a name="local-6989586621682361191"><a href="#local-6989586621682361191"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682361192"><a href="#local-6989586621682361192"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361193"><a href="#local-6989586621682361193"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682361194"><a href="#local-6989586621682361194"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621682361195"><a href="#local-6989586621682361195"><span class="hs-identifier">bind_op</span></a></a><span> </span><a name="local-6989586621682361196"><a href="#local-6989586621682361196"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682361197"><a href="#local-6989586621682361197"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682361198"><a href="#local-6989586621682361198"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1860"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyNameSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361191"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361197"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#isStrictPattern"><span class="hs-identifier hs-var">isStrictPattern</span></a><span> </span><a href="#local-6989586621682361193"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-1861"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361188"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682361189"><span class="hs-identifier hs-var">lets</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682361192"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682361193"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621682361194"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682361195"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><a href="#local-6989586621682361196"><span class="hs-identifier hs-var">fail_op</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361197"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361190"><span class="hs-identifier hs-var">indep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1862"></a><span>         </span><a href="#local-6989586621682361199"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621682361198"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1863"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682361199"><a href="#local-6989586621682361199"><span class="hs-identifier">bndrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361191"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621682361193"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-1864"></a><span>  </span><span class="hs-comment">-- If we encounter a LetStmt that doesn't depend on a BindStmt in this</span><span>
</span><a name="line-1865"></a><span>  </span><span class="hs-comment">-- group, then move it to the beginning, so that it doesn't interfere with</span><span>
</span><a name="line-1866"></a><span>  </span><span class="hs-comment">-- grouping more BindStmts.</span><span>
</span><a name="line-1867"></a><span>  </span><span class="hs-comment">-- TODO: perhaps we shouldn't do this if there are any strict bindings,</span><span>
</span><a name="line-1868"></a><span>  </span><span class="hs-comment">-- because we might be moving evaluation earlier.</span><span>
</span><a name="line-1869"></a><span>  </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682361200"><a href="#local-6989586621682361200"><span class="hs-identifier">lets</span></a></a><span> </span><a name="local-6989586621682361201"><a href="#local-6989586621682361201"><span class="hs-identifier">indep</span></a></a><span> </span><a name="local-6989586621682361202"><a href="#local-6989586621682361202"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682361203"><a href="#local-6989586621682361203"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><a name="local-6989586621682361204"><a href="#local-6989586621682361204"><span class="hs-identifier">noExt</span></a></a><span> </span><a name="local-6989586621682361205"><a href="#local-6989586621682361205"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682361206"><a href="#local-6989586621682361206"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682361207"><a href="#local-6989586621682361207"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1870"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyNameSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361202"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361206"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1871"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361188"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682361203"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><a href="#local-6989586621682361204"><span class="hs-identifier hs-var">noExt</span></a><span> </span><a href="#local-6989586621682361205"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361206"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361200"><span class="hs-identifier hs-var">lets</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361201"><span class="hs-identifier hs-var">indep</span></a><span> </span><a href="#local-6989586621682361202"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682361207"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1872"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1873"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1874"></a><span>  </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682361208"><a href="#local-6989586621682361208"><span class="hs-identifier">lets</span></a></a><span> </span><a name="local-6989586621682361209"><a href="#local-6989586621682361209"><span class="hs-identifier">indep</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361210"><a href="#local-6989586621682361210"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682361208"><span class="hs-identifier hs-var">lets</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682361209"><span class="hs-identifier hs-var">indep</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361210"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1875"></a><span>
</span><a name="line-1876"></a><span class="hs-comment">-- | Build an ApplicativeStmt, and strip the &quot;return&quot; from the tail</span><span>
</span><a name="line-1877"></a><span class="hs-comment">-- if necessary.</span><span>
</span><a name="line-1878"></a><span class="hs-comment">--</span><span>
</span><a name="line-1879"></a><span class="hs-comment">-- For example, if we start with</span><span>
</span><a name="line-1880"></a><span class="hs-comment">--   do x &lt;- E1; y &lt;- E2; return (f x y)</span><span>
</span><a name="line-1881"></a><span class="hs-comment">-- then we get</span><span>
</span><a name="line-1882"></a><span class="hs-comment">--   do (E1[x] | E2[y]); f x y</span><span>
</span><a name="line-1883"></a><span class="hs-comment">--</span><span>
</span><a name="line-1884"></a><span class="hs-comment">-- the LastStmt in this case has the return removed, but we set the</span><span>
</span><a name="line-1885"></a><span class="hs-comment">-- flag on the LastStmt to indicate this, so that we can print out the</span><span>
</span><a name="line-1886"></a><span class="hs-comment">-- original statement correctly in error messages.  It is easier to do</span><span>
</span><a name="line-1887"></a><span class="hs-comment">-- it this way rather than try to ignore the return later in both the</span><span>
</span><a name="line-1888"></a><span class="hs-comment">-- typechecker and the desugarer (I tried it that way first!).</span><span>
</span><a name="line-1889"></a><span class="hs-identifier">mkApplicativeStmt</span><span>
</span><a name="line-1890"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1891"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ApplicativeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- ^ The args</span><span>
</span><a name="line-1892"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                               </span><span class="hs-comment">-- ^ True &lt;=&gt; need a join</span><span>
</span><a name="line-1893"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- ^ The body statements</span><span>
</span><a name="line-1894"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1895"></a><a name="mkApplicativeStmt"><a href="RnExpr.html#mkApplicativeStmt"><span class="hs-identifier">mkApplicativeStmt</span></a></a><span> </span><a name="local-6989586621682361211"><a href="#local-6989586621682361211"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361212"><a href="#local-6989586621682361212"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621682361213"><a href="#local-6989586621682361213"><span class="hs-identifier">need_join</span></a></a><span> </span><a name="local-6989586621682361214"><a href="#local-6989586621682361214"><span class="hs-identifier">body_stmts</span></a></a><span>
</span><a name="line-1896"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361215"><a href="#local-6989586621682361215"><span class="hs-identifier">fmap_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361216"><a href="#local-6989586621682361216"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682361211"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">fmapName</span><span>
</span><a name="line-1897"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361217"><a href="#local-6989586621682361217"><span class="hs-identifier">ap_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361218"><a href="#local-6989586621682361218"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682361211"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">apAName</span><span>
</span><a name="line-1898"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361221"><a href="#local-6989586621682361221"><span class="hs-identifier">mb_join</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361222"><a href="#local-6989586621682361222"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1899"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682361213"><span class="hs-identifier hs-var">need_join</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1900"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682361219"><a href="#local-6989586621682361219"><span class="hs-identifier">join_op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361220"><a href="#local-6989586621682361220"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#lookupStmtName"><span class="hs-identifier hs-var">lookupStmtName</span></a><span> </span><a href="#local-6989586621682361211"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">joinMName</span><span>
</span><a name="line-1901"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682361219"><span class="hs-identifier hs-var">join_op</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361220"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1902"></a><span>           </span><span class="hs-keyword">else</span><span>
</span><a name="line-1903"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span>
</span><a name="line-1904"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361223"><a href="#local-6989586621682361223"><span class="hs-identifier">applicative_stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-1905"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361215"><span class="hs-identifier hs-var">fmap_op</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="#local-6989586621682361217"><span class="hs-identifier hs-var">ap_op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361212"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1906"></a><span>               </span><a href="#local-6989586621682361221"><span class="hs-identifier hs-var">mb_join</span></a><span>
</span><a name="line-1907"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682361223"><span class="hs-identifier hs-var">applicative_stmt</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682361214"><span class="hs-identifier hs-var">body_stmts</span></a><span>
</span><a name="line-1908"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361216"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361218"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361222"><span class="hs-identifier hs-var">fvs3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1909"></a><span>
</span><a name="line-1910"></a><span class="hs-comment">-- | Given the statements following an ApplicativeStmt, determine whether</span><span>
</span><a name="line-1911"></a><span class="hs-comment">-- we need a @join@ or not, and remove the @return@ if necessary.</span><span>
</span><a name="line-1912"></a><span class="hs-identifier">needJoin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnExpr.html#MonadNames"><span class="hs-identifier hs-type">MonadNames</span></a><span>
</span><a name="line-1913"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1914"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1915"></a><a name="needJoin"><a href="RnExpr.html#needJoin"><span class="hs-identifier">needJoin</span></a></a><span> </span><a name="local-6989586621682361224"><a href="#local-6989586621682361224"><span class="hs-identifier">_monad_names</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- we're in an ApplicativeArg</span><span>
</span><a name="line-1916"></a><span class="hs-identifier">needJoin</span><span> </span><a name="local-6989586621682361225"><a href="#local-6989586621682361225"><span class="hs-identifier">monad_names</span></a></a><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682361226"><a href="#local-6989586621682361226"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361227"><a href="#local-6989586621682361227"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361228"><a href="#local-6989586621682361228"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1917"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682361229"><a href="#local-6989586621682361229"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#isReturnApp"><span class="hs-identifier hs-var">isReturnApp</span></a><span> </span><a href="#local-6989586621682361225"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361227"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1918"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682361226"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682361229"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682361228"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1919"></a><span class="hs-identifier">needJoin</span><span> </span><a name="local-6989586621682361230"><a href="#local-6989586621682361230"><span class="hs-identifier">_monad_names</span></a></a><span> </span><a name="local-6989586621682361231"><a href="#local-6989586621682361231"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361231"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1920"></a><span>
</span><a name="line-1921"></a><span class="hs-comment">-- | @Just e@, if the expression is @return e@ or @return $ e@,</span><span>
</span><a name="line-1922"></a><span class="hs-comment">-- otherwise @Nothing@</span><span>
</span><a name="line-1923"></a><span class="hs-identifier">isReturnApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnExpr.html#MonadNames"><span class="hs-identifier hs-type">MonadNames</span></a><span>
</span><a name="line-1924"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-1925"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><a name="isReturnApp"><a href="RnExpr.html#isReturnApp"><span class="hs-identifier">isReturnApp</span></a></a><span> </span><a name="local-6989586621682361232"><a href="#local-6989586621682361232"><span class="hs-identifier">monad_names</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361233"><a href="#local-6989586621682361233"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#isReturnApp"><span class="hs-identifier hs-var">isReturnApp</span></a><span> </span><a href="#local-6989586621682361232"><span class="hs-identifier hs-var">monad_names</span></a><span> </span><a href="#local-6989586621682361233"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1927"></a><span class="hs-identifier">isReturnApp</span><span> </span><a name="local-6989586621682361234"><a href="#local-6989586621682361234"><span class="hs-identifier">monad_names</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361235"><a href="#local-6989586621682361235"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361235"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1928"></a><span>  </span><span class="hs-identifier hs-var">OpApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361246"><a href="#local-6989586621682361246"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682361247"><a href="#local-6989586621682361247"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621682361248"><a href="#local-6989586621682361248"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361237"><span class="hs-identifier hs-var">is_return</span></a><span> </span><a href="#local-6989586621682361246"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361238"><span class="hs-identifier hs-var">is_dollar</span></a><span> </span><a href="#local-6989586621682361247"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682361248"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1929"></a><span>  </span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361249"><a href="#local-6989586621682361249"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682361250"><a href="#local-6989586621682361250"><span class="hs-identifier">arg</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361237"><span class="hs-identifier hs-var">is_return</span></a><span> </span><a href="#local-6989586621682361249"><span class="hs-identifier hs-var">f</span></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682361250"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1930"></a><span>  </span><a name="local-6989586621682361251"><a href="#local-6989586621682361251"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1931"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1932"></a><span>  </span><a name="local-6989586621682361236"><a href="#local-6989586621682361236"><span class="hs-identifier">is_var</span></a></a><span> </span><a name="local-6989586621682361239"><a href="#local-6989586621682361239"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361240"><a href="#local-6989586621682361240"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361236"><span class="hs-identifier hs-var">is_var</span></a><span> </span><a href="#local-6989586621682361239"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682361240"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1933"></a><span>  </span><span class="hs-identifier">is_var</span><span> </span><a name="local-6989586621682361241"><a href="#local-6989586621682361241"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361242"><a href="#local-6989586621682361242"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361236"><span class="hs-identifier hs-var">is_var</span></a><span> </span><a href="#local-6989586621682361241"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682361242"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1934"></a><span>  </span><span class="hs-identifier">is_var</span><span> </span><a name="local-6989586621682361243"><a href="#local-6989586621682361243"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361244"><a href="#local-6989586621682361244"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361243"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682361244"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1935"></a><span>       </span><span class="hs-comment">-- TODO: I don't know how to get this right for rebindable syntax</span><span>
</span><a name="line-1936"></a><span>  </span><span class="hs-identifier">is_var</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1937"></a><span>
</span><a name="line-1938"></a><span>  </span><a name="local-6989586621682361237"><a href="#local-6989586621682361237"><span class="hs-identifier">is_return</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361236"><span class="hs-identifier hs-var">is_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682361245"><a href="#local-6989586621682361245"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361245"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">return_name</span><span> </span><a href="#local-6989586621682361234"><span class="hs-identifier hs-var">monad_names</span></a><span>
</span><a name="line-1939"></a><span>                         </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682361245"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">pure_name</span><span> </span><a href="#local-6989586621682361234"><span class="hs-identifier hs-var">monad_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-1940"></a><span>  </span><a name="local-6989586621682361238"><a href="#local-6989586621682361238"><span class="hs-identifier">is_dollar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682361236"><span class="hs-identifier hs-var">is_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">dollarIdKey</span><span class="hs-special">)</span><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsubsection{Errors}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1949"></a><span>
</span><a name="line-1950"></a><span class="hs-identifier">checkEmptyStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1951"></a><span class="hs-comment">-- We've seen an empty sequence of Stmts... is that ok?</span><span>
</span><a name="line-1952"></a><a name="checkEmptyStmts"><a href="RnExpr.html#checkEmptyStmts"><span class="hs-identifier">checkEmptyStmts</span></a></a><span> </span><a name="local-6989586621682361252"><a href="#local-6989586621682361252"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-1953"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="RnExpr.html#okEmpty"><span class="hs-identifier hs-var">okEmpty</span></a><span> </span><a href="#local-6989586621682361252"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#emptyErr"><span class="hs-identifier hs-var">emptyErr</span></a><span> </span><a href="#local-6989586621682361252"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1954"></a><span>
</span><a name="line-1955"></a><span class="hs-identifier">okEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><a href="#local-6989586621682360219"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1956"></a><a name="okEmpty"><a href="RnExpr.html#okEmpty"><span class="hs-identifier">okEmpty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatGuard</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1957"></a><span class="hs-identifier">okEmpty</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1958"></a><span>
</span><a name="line-1959"></a><span class="hs-identifier">emptyErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1960"></a><a name="emptyErr"><a href="RnExpr.html#emptyErr"><span class="hs-identifier">emptyErr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtCtxt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Empty statement group in parallel comprehension&quot;</span><span>
</span><a name="line-1961"></a><span class="hs-identifier">emptyErr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmtCtxt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Empty statement group preceding 'group' or 'then'&quot;</span><span>
</span><a name="line-1962"></a><span class="hs-identifier">emptyErr</span><span> </span><a name="local-6989586621682361253"><a href="#local-6989586621682361253"><span class="hs-identifier">ctxt</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Empty&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprStmtContext</span><span> </span><a href="#local-6989586621682361253"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1965"></a><span class="hs-identifier">checkLastStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360218"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1966"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360218"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1967"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360218"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1968"></a><a name="checkLastStmt"><a href="RnExpr.html#checkLastStmt"><span class="hs-identifier">checkLastStmt</span></a></a><span> </span><a name="local-6989586621682361254"><a href="#local-6989586621682361254"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361255"><a href="#local-6989586621682361255"><span class="hs-identifier">lstmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682361256"><a href="#local-6989586621682361256"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682361257"><a href="#local-6989586621682361257"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1969"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361254"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1970"></a><span>      </span><span class="hs-identifier hs-var">ListComp</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361260"><span class="hs-identifier hs-var">check_comp</span></a><span>
</span><a name="line-1971"></a><span>      </span><span class="hs-identifier hs-var">MonadComp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361260"><span class="hs-identifier hs-var">check_comp</span></a><span>
</span><a name="line-1972"></a><span>      </span><span class="hs-identifier hs-var">ArrowExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361258"><span class="hs-identifier hs-var">check_do</span></a><span>
</span><a name="line-1973"></a><span>      </span><span class="hs-identifier hs-var">DoExpr</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361258"><span class="hs-identifier hs-var">check_do</span></a><span>
</span><a name="line-1974"></a><span>      </span><span class="hs-identifier hs-var">MDoExpr</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361258"><span class="hs-identifier hs-var">check_do</span></a><span>
</span><a name="line-1975"></a><span>      </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682361261"><span class="hs-identifier hs-var">check_other</span></a><span>
</span><a name="line-1976"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1977"></a><span>    </span><a name="local-6989586621682361258"><a href="#local-6989586621682361258"><span class="hs-identifier">check_do</span></a></a><span>    </span><span class="hs-comment">-- Expect BodyStmt, and change it to LastStmt</span><span>
</span><a name="line-1978"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361257"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1979"></a><span>          </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361262"><a href="#local-6989586621682361262"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682361256"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLastStmt</span><span> </span><a href="#local-6989586621682361262"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1980"></a><span>          </span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682361255"><span class="hs-identifier hs-var">lstmt</span></a><span>   </span><span class="hs-comment">-- &quot;Deriving&quot; clauses may generate a</span><span>
</span><a name="line-1981"></a><span>                                             </span><span class="hs-comment">-- LastStmt directly (unlike the parser)</span><span>
</span><a name="line-1982"></a><span>          </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><a href="#local-6989586621682361259"><span class="hs-identifier hs-var">last_error</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682361257"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682361255"><span class="hs-identifier hs-var">lstmt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1983"></a><span>    </span><a name="local-6989586621682361259"><a href="#local-6989586621682361259"><span class="hs-identifier">last_error</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The last statement in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprAStmtContext</span><span> </span><a href="#local-6989586621682361254"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1984"></a><span>                  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must be an expression&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1985"></a><span>
</span><a name="line-1986"></a><span>    </span><a name="local-6989586621682361260"><a href="#local-6989586621682361260"><span class="hs-identifier">check_comp</span></a></a><span>  </span><span class="hs-comment">-- Expect LastStmt; this should be enforced by the parser!</span><span>
</span><a name="line-1987"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361257"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1988"></a><span>          </span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682361255"><span class="hs-identifier hs-var">lstmt</span></a><span>
</span><a name="line-1989"></a><span>          </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;checkLastStmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682361255"><span class="hs-identifier hs-var">lstmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1990"></a><span>
</span><a name="line-1991"></a><span>    </span><a name="local-6989586621682361261"><a href="#local-6989586621682361261"><span class="hs-identifier">check_other</span></a></a><span> </span><span class="hs-comment">-- Behave just as if this wasn't the last stmt</span><span>
</span><a name="line-1992"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnExpr.html#checkStmt"><span class="hs-identifier hs-var">checkStmt</span></a><span> </span><a href="#local-6989586621682361254"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361255"><span class="hs-identifier hs-var">lstmt</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682361255"><span class="hs-identifier hs-var">lstmt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1993"></a><span>
</span><a name="line-1994"></a><span class="hs-comment">-- Checking when a particular Stmt is ok</span><span>
</span><a name="line-1995"></a><span class="hs-identifier">checkStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1996"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360217"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1997"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1998"></a><a name="checkStmt"><a href="RnExpr.html#checkStmt"><span class="hs-identifier">checkStmt</span></a></a><span> </span><a name="local-6989586621682361263"><a href="#local-6989586621682361263"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361264"><a href="#local-6989586621682361264"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1999"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682361266"><a href="#local-6989586621682361266"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-2000"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="RnExpr.html#okStmt"><span class="hs-identifier hs-var">okStmt</span></a><span> </span><a href="#local-6989586621682361266"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361263"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361264"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2001"></a><span>           </span><span class="hs-identifier hs-var">IsValid</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2002"></a><span>           </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621682361267"><a href="#local-6989586621682361267"><span class="hs-identifier">extra</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361265"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621682361267"><span class="hs-identifier hs-var">extra</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2003"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2004"></a><span>   </span><a name="local-6989586621682361265"><a href="#local-6989586621682361265"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unexpected&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="RnExpr.html#pprStmtCat"><span class="hs-identifier hs-var">pprStmtCat</span></a><span> </span><a href="#local-6989586621682361264"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;statement&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2005"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprAStmtContext</span><span> </span><a href="#local-6989586621682361263"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2006"></a><span>
</span><a name="line-2007"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Stmt</span><span> </span><a href="#local-6989586621682360215"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621682360216"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2008"></a><a name="pprStmtCat"><a href="RnExpr.html#pprStmtCat"><span class="hs-identifier">pprStmtCat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;transform&quot;</span><span>
</span><a name="line-2009"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;return expression&quot;</span><span>
</span><a name="line-2010"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;body&quot;</span><span>
</span><a name="line-2011"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;binding&quot;</span><span>
</span><a name="line-2012"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;let&quot;</span><span>
</span><a name="line-2013"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;rec&quot;</span><span>
</span><a name="line-2014"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;parallel&quot;</span><span>
</span><a name="line-2015"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;pprStmtCat: ApplicativeStmt&quot;</span><span>
</span><a name="line-2016"></a><span class="hs-identifier">pprStmtCat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;pprStmtCat: XStmtLR&quot;</span><span>
</span><a name="line-2017"></a><span>
</span><a name="line-2018"></a><span class="hs-comment">------------</span><span>
</span><a name="line-2019"></a><span class="hs-identifier">emptyInvalid</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>  </span><span class="hs-comment">-- Payload is the empty document</span><span>
</span><a name="line-2020"></a><a name="emptyInvalid"><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier">emptyInvalid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-2021"></a><span>
</span><a name="line-2022"></a><span class="hs-identifier">okStmt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">okDoStmt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">okCompStmt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">okParStmt</span><span>
</span><a name="line-2023"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-2024"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Stmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360214"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-2025"></a><span class="hs-comment">-- Return Nothing if OK, (Just extra) if not ok</span><span>
</span><a name="line-2026"></a><span class="hs-comment">-- The &quot;extra&quot; is an SDoc that is appended to a generic error message</span><span>
</span><a name="line-2027"></a><span>
</span><a name="line-2028"></a><a name="okStmt"><a href="RnExpr.html#okStmt"><span class="hs-identifier">okStmt</span></a></a><span> </span><a name="local-6989586621682361268"><a href="#local-6989586621682361268"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682361269"><a href="#local-6989586621682361269"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361270"><a href="#local-6989586621682361270"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-2029"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2030"></a><span>      </span><span class="hs-identifier hs-var">PatGuard</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okPatGuardStmt"><span class="hs-identifier hs-var">okPatGuardStmt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2031"></a><span>      </span><span class="hs-identifier hs-var">ParStmtCtxt</span><span> </span><a name="local-6989586621682361271"><a href="#local-6989586621682361271"><span class="hs-identifier">ctxt</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okParStmt"><span class="hs-identifier hs-var">okParStmt</span></a><span>  </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361271"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2032"></a><span>      </span><span class="hs-identifier hs-var">DoExpr</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okDoStmt"><span class="hs-identifier hs-var">okDoStmt</span></a><span>   </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2033"></a><span>      </span><span class="hs-identifier hs-var">MDoExpr</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okDoStmt"><span class="hs-identifier hs-var">okDoStmt</span></a><span>   </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2034"></a><span>      </span><span class="hs-identifier hs-var">ArrowExpr</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okDoStmt"><span class="hs-identifier hs-var">okDoStmt</span></a><span>   </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2035"></a><span>      </span><span class="hs-identifier hs-var">GhciStmtCtxt</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okDoStmt"><span class="hs-identifier hs-var">okDoStmt</span></a><span>   </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2036"></a><span>      </span><span class="hs-identifier hs-var">ListComp</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okCompStmt"><span class="hs-identifier hs-var">okCompStmt</span></a><span> </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2037"></a><span>      </span><span class="hs-identifier hs-var">MonadComp</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okCompStmt"><span class="hs-identifier hs-var">okCompStmt</span></a><span> </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361269"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2038"></a><span>      </span><span class="hs-identifier hs-var">TransStmtCtxt</span><span> </span><a name="local-6989586621682361272"><a href="#local-6989586621682361272"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okStmt"><span class="hs-identifier hs-var">okStmt</span></a><span> </span><a href="#local-6989586621682361268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361272"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361270"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2039"></a><span>
</span><a name="line-2040"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-2041"></a><span class="hs-identifier">okPatGuardStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Stmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682360213"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-2042"></a><a name="okPatGuardStmt"><a href="RnExpr.html#okPatGuardStmt"><span class="hs-identifier">okPatGuardStmt</span></a></a><span> </span><a name="local-6989586621682361273"><a href="#local-6989586621682361273"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-2043"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361273"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2044"></a><span>      </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2045"></a><span>      </span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2046"></a><span>      </span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2047"></a><span>      </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier hs-var">emptyInvalid</span></a><span>
</span><a name="line-2048"></a><span>
</span><a name="line-2049"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-2050"></a><a name="okParStmt"><a href="RnExpr.html#okParStmt"><span class="hs-identifier">okParStmt</span></a></a><span> </span><a name="local-6989586621682361274"><a href="#local-6989586621682361274"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682361275"><a href="#local-6989586621682361275"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361276"><a href="#local-6989586621682361276"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-2051"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361276"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2052"></a><span>      </span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier hs-var">emptyInvalid</span></a><span>
</span><a name="line-2053"></a><span>      </span><span class="hs-identifier">_</span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#okStmt"><span class="hs-identifier hs-var">okStmt</span></a><span> </span><a href="#local-6989586621682361274"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682361275"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682361276"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-2054"></a><span>
</span><a name="line-2055"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-2056"></a><a name="okDoStmt"><a href="RnExpr.html#okDoStmt"><span class="hs-identifier">okDoStmt</span></a></a><span> </span><a name="local-6989586621682361277"><a href="#local-6989586621682361277"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682361278"><a href="#local-6989586621682361278"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621682361279"><a href="#local-6989586621682361279"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-2057"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361279"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2058"></a><span>       </span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-2059"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">LangExt.RecursiveDo</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xopt</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361277"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2060"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ArrowExpr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682361278"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>    </span><span class="hs-comment">-- Arrows allows 'rec'</span><span>
</span><a name="line-2061"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use RecursiveDo&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2062"></a><span>       </span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2063"></a><span>       </span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2064"></a><span>       </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2065"></a><span>       </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier hs-var">emptyInvalid</span></a><span>
</span><a name="line-2066"></a><span>
</span><a name="line-2067"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-2068"></a><a name="okCompStmt"><a href="RnExpr.html#okCompStmt"><span class="hs-identifier">okCompStmt</span></a></a><span> </span><a name="local-6989586621682361280"><a href="#local-6989586621682361280"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682361281"><a href="#local-6989586621682361281"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-2069"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682361281"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2070"></a><span>       </span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2071"></a><span>       </span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2072"></a><span>       </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2073"></a><span>       </span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-2074"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">LangExt.ParallelListComp</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xopt</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2075"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use ParallelListComp&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2076"></a><span>       </span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-2077"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">LangExt.TransformListComp</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xopt</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-2078"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use TransformListComp&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2079"></a><span>       </span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier hs-var">emptyInvalid</span></a><span>
</span><a name="line-2080"></a><span>       </span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier hs-var">emptyInvalid</span></a><span>  </span><span class="hs-comment">-- Should not happen (dealt with by checkLastStmt)</span><span>
</span><a name="line-2081"></a><span>       </span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnExpr.html#emptyInvalid"><span class="hs-identifier hs-var">emptyInvalid</span></a><span>
</span><a name="line-2082"></a><span>       </span><span class="hs-identifier hs-var">XStmtLR</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;okCompStmt&quot;</span><span>
</span><a name="line-2083"></a><span>
</span><a name="line-2084"></a><span class="hs-comment">---------</span><span>
</span><a name="line-2085"></a><span class="hs-identifier">checkTupleSection</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTupArg</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2086"></a><a name="checkTupleSection"><a href="RnExpr.html#checkTupleSection"><span class="hs-identifier">checkTupleSection</span></a></a><span> </span><a name="local-6989586621682361282"><a href="#local-6989586621682361282"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2087"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682361284"><a href="#local-6989586621682361284"><span class="hs-identifier">tuple_section</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.TupleSections</span><span>
</span><a name="line-2088"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkErr"><span class="hs-identifier hs-var">checkErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">tupArgPresent</span><span> </span><a href="#local-6989586621682361282"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682361284"><span class="hs-identifier hs-var">tuple_section</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361283"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2089"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2090"></a><span>    </span><a name="local-6989586621682361283"><a href="#local-6989586621682361283"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal tuple section: use TupleSections&quot;</span><span>
</span><a name="line-2091"></a><span>
</span><a name="line-2092"></a><span class="hs-comment">---------</span><span>
</span><a name="line-2093"></a><span class="hs-identifier">sectionErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2094"></a><a name="sectionErr"><a href="RnExpr.html#sectionErr"><span class="hs-identifier">sectionErr</span></a></a><span> </span><a name="local-6989586621682361285"><a href="#local-6989586621682361285"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2095"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A section must be enclosed in parentheses&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2096"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;thus:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682361285"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2097"></a><span>
</span><a name="line-2098"></a><span class="hs-identifier">patSynErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-2099"></a><a name="patSynErr"><a href="RnExpr.html#patSynErr"><span class="hs-identifier">patSynErr</span></a></a><span> </span><a name="local-6989586621682361286"><a href="#local-6989586621682361286"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682361287"><a href="#local-6989586621682361287"><span class="hs-identifier">explanation</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Pattern syntax in expression context:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2100"></a><span>                                </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682361286"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-2101"></a><span>                                  </span><a href="#local-6989586621682361287"><span class="hs-identifier hs-var">explanation</span></a><span class="hs-special">)</span><span>
</span><a name="line-2102"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EWildPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2103"></a><span>
</span><a name="line-2104"></a><span class="hs-identifier">badIpBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682360212"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682360212"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2105"></a><a name="badIpBinds"><a href="RnExpr.html#badIpBinds"><span class="hs-identifier">badIpBinds</span></a></a><span> </span><a name="local-6989586621682361288"><a href="#local-6989586621682361288"><span class="hs-identifier">what</span></a></a><span> </span><a name="local-6989586621682361289"><a href="#local-6989586621682361289"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-2106"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Implicit-parameter bindings illegal in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682361288"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span>
</span><a name="line-2107"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682361289"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-2108"></a><span>
</span><a name="line-2109"></a><span class="hs-comment">---------</span><span>
</span><a name="line-2110"></a><span>
</span><a name="line-2111"></a><span class="hs-identifier">monadFailOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-2112"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-2113"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-2114"></a><a name="monadFailOp"><a href="RnExpr.html#monadFailOp"><span class="hs-identifier">monadFailOp</span></a></a><span> </span><a name="local-6989586621682361290"><a href="#local-6989586621682361290"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621682361291"><a href="#local-6989586621682361291"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-2115"></a><span>  </span><span class="hs-comment">-- If the pattern is irrefutable (e.g.: wildcard, tuple, ~pat, etc.)</span><span>
</span><a name="line-2116"></a><span>  </span><span class="hs-comment">-- we should not need to fail.</span><span>
</span><a name="line-2117"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isIrrefutableHsPat</span><span> </span><a href="#local-6989586621682361290"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-2118"></a><span>
</span><a name="line-2119"></a><span>  </span><span class="hs-comment">-- For non-monadic contexts (e.g. guard patterns, list</span><span>
</span><a name="line-2120"></a><span>  </span><span class="hs-comment">-- comprehensions, etc.) we should not need to fail.  See Note</span><span>
</span><a name="line-2121"></a><span>  </span><span class="hs-comment">-- [Failing pattern matches in Stmts]</span><span>
</span><a name="line-2122"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isMonadFailStmtContext</span><span> </span><a href="#local-6989586621682361291"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-2123"></a><span>
</span><a name="line-2124"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnExpr.html#getMonadFailOp"><span class="hs-identifier hs-var">getMonadFailOp</span></a><span>
</span><a name="line-2125"></a><span>
</span><a name="line-2126"></a><span class="hs-comment">{-
Note [Monad fail : Rebindable syntax, overloaded strings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Given the code
  foo x = do { Just y &lt;- x; return y }

we expect it to desugar as
  foo x = x &gt;&gt;= \r -&gt; case r of
                        Just y  -&gt; return y
                        Nothing -&gt; fail &quot;Pattern match error&quot;

But with RebindableSyntax and OverloadedStrings, we really want
it to desugar thus:
  foo x = x &gt;&gt;= \r -&gt; case r of
                        Just y  -&gt; return y
                        Nothing -&gt; fail (fromString &quot;Patterm match error&quot;)

So, in this case, we synthesize the function
  \x -&gt; fail (fromString x)

(rather than plain 'fail') for the 'fail' operation. This is done in
'getMonadFailOp'.
-}</span><span>
</span><a name="line-2150"></a><span class="hs-identifier">getMonadFailOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Syntax expr fail op</span><span>
</span><a name="line-2151"></a><a name="getMonadFailOp"><a href="RnExpr.html#getMonadFailOp"><span class="hs-identifier">getMonadFailOp</span></a></a><span>
</span><a name="line-2152"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682361305"><a href="#local-6989586621682361305"><span class="hs-identifier">xOverloadedStrings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-2153"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682361306"><a href="#local-6989586621682361306"><span class="hs-identifier">xRebindableSyntax</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.RebindableSyntax</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-2154"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682361292"><span class="hs-identifier hs-var">reallyGetMonadFailOp</span></a><span> </span><a href="#local-6989586621682361306"><span class="hs-identifier hs-var">xRebindableSyntax</span></a><span> </span><a href="#local-6989586621682361305"><span class="hs-identifier hs-var">xOverloadedStrings</span></a><span>
</span><a name="line-2155"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-2156"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2157"></a><span>    </span><a name="local-6989586621682361292"><a href="#local-6989586621682361292"><span class="hs-identifier">reallyGetMonadFailOp</span></a></a><span> </span><a name="local-6989586621682361293"><a href="#local-6989586621682361293"><span class="hs-identifier">rebindableSyntax</span></a></a><span> </span><a name="local-6989586621682361294"><a href="#local-6989586621682361294"><span class="hs-identifier">overloadedStrings</span></a></a><span>
</span><a name="line-2158"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682361293"><span class="hs-identifier hs-var">rebindableSyntax</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682361294"><span class="hs-identifier hs-var">overloadedStrings</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2159"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682361295"><a href="#local-6989586621682361295"><span class="hs-identifier">failExpr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361296"><a href="#local-6989586621682361296"><span class="hs-identifier">failFvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">failMName</span><span>
</span><a name="line-2160"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682361297"><a href="#local-6989586621682361297"><span class="hs-identifier">fromStringExpr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682361298"><a href="#local-6989586621682361298"><span class="hs-identifier">fromStringFvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">fromStringName</span><span>
</span><a name="line-2161"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361299"><a href="#local-6989586621682361299"><span class="hs-identifier">arg_lit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;arg&quot;</span><span>
</span><a name="line-2162"></a><span>            </span><a name="local-6989586621682361300"><a href="#local-6989586621682361300"><span class="hs-identifier">arg_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSystemVarName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOccUnique</span><span> </span><a href="#local-6989586621682361299"><span class="hs-identifier hs-var">arg_lit</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682361299"><span class="hs-identifier hs-var">arg_lit</span></a><span>
</span><a name="line-2163"></a><span>            </span><a name="local-6989586621682361301"><a href="#local-6989586621682361301"><span class="hs-identifier">arg_syn_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><a href="#local-6989586621682361300"><span class="hs-identifier hs-var">arg_name</span></a><span>
</span><a name="line-2164"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361302"><a href="#local-6989586621682361302"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2165"></a><span>              </span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">syn_expr</span><span> </span><a href="#local-6989586621682361295"><span class="hs-identifier hs-var">failExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2166"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">syn_expr</span><span> </span><a href="#local-6989586621682361297"><span class="hs-identifier hs-var">fromStringExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2167"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">syn_expr</span><span> </span><a href="#local-6989586621682361301"><span class="hs-identifier hs-var">arg_syn_expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2168"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361303"><a href="#local-6989586621682361303"><span class="hs-identifier">failAfterFromStringExpr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2169"></a><span>              </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsLam</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682361300"><span class="hs-identifier hs-var">arg_name</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682361302"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-2170"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682361304"><a href="#local-6989586621682361304"><span class="hs-identifier">failAfterFromStringSynExpr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2171"></a><span>              </span><span class="hs-identifier hs-var">mkSyntaxExpr</span><span> </span><a href="#local-6989586621682361303"><span class="hs-identifier hs-var">failAfterFromStringExpr</span></a><span>
</span><a name="line-2172"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682361304"><span class="hs-identifier hs-var">failAfterFromStringSynExpr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682361296"><span class="hs-identifier hs-var">failFvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682361298"><span class="hs-identifier hs-var">fromStringFvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2173"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnEnv.html#lookupSyntaxName"><span class="hs-identifier hs-var">lookupSyntaxName</span></a><span> </span><span class="hs-identifier hs-var">failMName</span><span>
</span><a name="line-2174"></a></pre></body></html>