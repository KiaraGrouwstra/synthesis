<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Code generation for ticky-ticky profiling</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">{- OVERVIEW: ticky ticky profiling

Please see
http://ghc.haskell.org/trac/ghc/wiki/Debugging/TickyTicky and also
edit it and the rest of this comment to keep them up-to-date if you
change ticky-ticky. Thanks!

 *** All allocation ticky numbers are in bytes. ***

Some of the relevant source files:

       ***not necessarily an exhaustive list***

  * some codeGen/ modules import this one

  * this module imports cmm/CLabel.hs to manage labels

  * cmm/CmmParse.y expands some macros using generators defined in
    this module

  * includes/stg/Ticky.h declares all of the global counters

  * includes/rts/Ticky.h declares the C data type for an
    STG-declaration's counters

  * some macros defined in includes/Cmm.h (and used within the RTS's
    CMM code) update the global ticky counters

  * at the end of execution rts/Ticky.c generates the final report
    +RTS -r&lt;report-file&gt; -RTS

The rts/Ticky.c function that generates the report includes an
STG-declaration's ticky counters if

  * that declaration was entered, or

  * it was allocated (if -ticky-allocd)

On either of those events, the counter is &quot;registered&quot; by adding it to
a linked list; cf the CMM generated by registerTickyCtr.

Ticky-ticky profiling has evolved over many years. Many of the
counters from its most sophisticated days are no longer
active/accurate. As the RTS has changed, sometimes the ticky code for
relevant counters was not accordingly updated. Unfortunately, neither
were the comments.

As of March 2013, there still exist deprecated code and comments in
the code generator as well as the RTS because:

  * I don't know what is out-of-date versus merely commented out for
    momentary convenience, and

  * someone else might know how to repair it!

-}</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmTicky</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-69"></a><span>  </span><a href="StgCmmTicky.html#withNewTickyCounterFun"><span class="hs-identifier hs-var">withNewTickyCounterFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>  </span><a href="StgCmmTicky.html#withNewTickyCounterLNE"><span class="hs-identifier hs-var">withNewTickyCounterLNE</span></a><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>  </span><a href="StgCmmTicky.html#withNewTickyCounterThunk"><span class="hs-identifier hs-var">withNewTickyCounterThunk</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>  </span><a href="StgCmmTicky.html#withNewTickyCounterStdThunk"><span class="hs-identifier hs-var">withNewTickyCounterStdThunk</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>  </span><a href="StgCmmTicky.html#withNewTickyCounterCon"><span class="hs-identifier hs-var">withNewTickyCounterCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span>  </span><a href="StgCmmTicky.html#tickyDynAlloc"><span class="hs-identifier hs-var">tickyDynAlloc</span></a><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>  </span><a href="StgCmmTicky.html#tickyAllocHeap"><span class="hs-identifier hs-var">tickyAllocHeap</span></a><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>  </span><a href="StgCmmTicky.html#tickyAllocPrim"><span class="hs-identifier hs-var">tickyAllocPrim</span></a><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>  </span><a href="StgCmmTicky.html#tickyAllocThunk"><span class="hs-identifier hs-var">tickyAllocThunk</span></a><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>  </span><a href="StgCmmTicky.html#tickyAllocPAP"><span class="hs-identifier hs-var">tickyAllocPAP</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>  </span><a href="StgCmmTicky.html#tickyHeapCheck"><span class="hs-identifier hs-var">tickyHeapCheck</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>  </span><a href="StgCmmTicky.html#tickyStackCheck"><span class="hs-identifier hs-var">tickyStackCheck</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>  </span><a href="StgCmmTicky.html#tickyUnknownCall"><span class="hs-identifier hs-var">tickyUnknownCall</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmTicky.html#tickyDirectCall"><span class="hs-identifier hs-var">tickyDirectCall</span></a><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>  </span><a href="StgCmmTicky.html#tickyPushUpdateFrame"><span class="hs-identifier hs-var">tickyPushUpdateFrame</span></a><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>  </span><a href="StgCmmTicky.html#tickyUpdateFrameOmitted"><span class="hs-identifier hs-var">tickyUpdateFrameOmitted</span></a><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span>  </span><a href="StgCmmTicky.html#tickyEnterDynCon"><span class="hs-identifier hs-var">tickyEnterDynCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>  </span><a href="StgCmmTicky.html#tickyEnterStaticCon"><span class="hs-identifier hs-var">tickyEnterStaticCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>  </span><a href="StgCmmTicky.html#tickyEnterViaNode"><span class="hs-identifier hs-var">tickyEnterViaNode</span></a><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span>  </span><a href="StgCmmTicky.html#tickyEnterFun"><span class="hs-identifier hs-var">tickyEnterFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>  </span><a href="StgCmmTicky.html#tickyEnterThunk"><span class="hs-identifier hs-var">tickyEnterThunk</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmTicky.html#tickyEnterStdThunk"><span class="hs-identifier hs-var">tickyEnterStdThunk</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- dynamic non-value</span><span>
</span><a name="line-95"></a><span>                                              </span><span class="hs-comment">-- thunks only</span><span>
</span><a name="line-96"></a><span>  </span><a href="StgCmmTicky.html#tickyEnterLNE"><span class="hs-identifier hs-var">tickyEnterLNE</span></a><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>  </span><a href="StgCmmTicky.html#tickyUpdateBhCaf"><span class="hs-identifier hs-var">tickyUpdateBhCaf</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>  </span><a href="StgCmmTicky.html#tickyBlackHole"><span class="hs-identifier hs-var">tickyBlackHole</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>  </span><a href="StgCmmTicky.html#tickyUnboxedTupleReturn"><span class="hs-identifier hs-var">tickyUnboxedTupleReturn</span></a><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>  </span><a href="StgCmmTicky.html#tickyReturnOldCon"><span class="hs-identifier hs-var">tickyReturnOldCon</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmTicky.html#tickyReturnNewCon"><span class="hs-identifier hs-var">tickyReturnNewCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span>  </span><a href="StgCmmTicky.html#tickyKnownCallTooFewArgs"><span class="hs-identifier hs-var">tickyKnownCallTooFewArgs</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmTicky.html#tickyKnownCallExact"><span class="hs-identifier hs-var">tickyKnownCallExact</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmTicky.html#tickyKnownCallExtraArgs"><span class="hs-identifier hs-var">tickyKnownCallExtraArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>  </span><a href="StgCmmTicky.html#tickySlowCall"><span class="hs-identifier hs-var">tickySlowCall</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmTicky.html#tickySlowCallPat"><span class="hs-identifier hs-var">tickySlowCallPat</span></a><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmArgRep.html"><span class="hs-identifier">StgCmmArgRep</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="StgCmmArgRep.html#slowCallPattern"><span class="hs-identifier hs-var">slowCallPattern</span></a><span> </span><span class="hs-special">,</span><span> </span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><span class="hs-special">,</span><span> </span><a href="StgCmmArgRep.html#argRepString"><span class="hs-identifier hs-var">argRepString</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmMonad.html"><span class="hs-identifier">StgCmmMonad</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><a href="CmmExpr.html"><span class="hs-identifier">CmmExpr</span></a><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- Turgid imports for showTypeCategory</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Char</span><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-142"></a><span class="hs-comment">--</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- Ticky-ticky profiling</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-keyword">data</span><span> </span><a name="TickyClosureType"><a href="StgCmmTicky.html#TickyClosureType"><span class="hs-identifier">TickyClosureType</span></a></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="TickyFun"><a href="StgCmmTicky.html#TickyFun"><span class="hs-identifier">TickyFun</span></a></a><span>
</span><a name="line-149"></a><span>        </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- True &lt;-&gt; single entry</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="TickyCon"><a href="StgCmmTicky.html#TickyCon"><span class="hs-identifier">TickyCon</span></a></a><span>
</span><a name="line-151"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="TickyThunk"><a href="StgCmmTicky.html#TickyThunk"><span class="hs-identifier">TickyThunk</span></a></a><span>
</span><a name="line-152"></a><span>        </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- True &lt;-&gt; updateable</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- True &lt;-&gt; standard thunk (AP or selector), has no entry counter</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="TickyLNE"><a href="StgCmmTicky.html#TickyLNE"><span class="hs-identifier">TickyLNE</span></a></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">withNewTickyCounterFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755805"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755805"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-157"></a><a name="withNewTickyCounterFun"><a href="StgCmmTicky.html#withNewTickyCounterFun"><span class="hs-identifier">withNewTickyCounterFun</span></a></a><span> </span><a name="local-6989586621680755806"><a href="#local-6989586621680755806"><span class="hs-identifier">single_entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounter"><span class="hs-identifier hs-var">withNewTickyCounter</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#TickyFun"><span class="hs-identifier hs-var">TickyFun</span></a><span> </span><a href="#local-6989586621680755806"><span class="hs-identifier hs-var">single_entry</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">withNewTickyCounterLNE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755804"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755804"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-160"></a><a name="withNewTickyCounterLNE"><a href="StgCmmTicky.html#withNewTickyCounterLNE"><span class="hs-identifier">withNewTickyCounterLNE</span></a></a><span> </span><a name="local-6989586621680755807"><a href="#local-6989586621680755807"><span class="hs-identifier">nm</span></a></a><span> </span><a name="local-6989586621680755808"><a href="#local-6989586621680755808"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680755809"><a href="#local-6989586621680755809"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>  </span><a name="local-6989586621680755810"><a href="#local-6989586621680755810"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#tickyLNEIsOn"><span class="hs-identifier hs-var">tickyLNEIsOn</span></a><span>
</span><a name="line-162"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755810"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680755809"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounter"><span class="hs-identifier hs-var">withNewTickyCounter</span></a><span> </span><a href="StgCmmTicky.html#TickyLNE"><span class="hs-identifier hs-var">TickyLNE</span></a><span> </span><a href="#local-6989586621680755807"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621680755808"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680755809"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-identifier">thunkHasCounter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-165"></a><a name="thunkHasCounter"><a href="StgCmmTicky.html#thunkHasCounter"><span class="hs-identifier">thunkHasCounter</span></a></a><span> </span><a name="local-6989586621680755811"><a href="#local-6989586621680755811"><span class="hs-identifier">isStatic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-166"></a><span>  </span><a name="local-6989586621680755812"><a href="#local-6989586621680755812"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#tickyDynThunkIsOn"><span class="hs-identifier hs-var">tickyDynThunkIsOn</span></a><span>
</span><a name="line-167"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755811"><span class="hs-identifier hs-var">isStatic</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680755812"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">withNewTickyCounterThunk</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ static</span><span>
</span><a name="line-171"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ updateable</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755803"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755803"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-175"></a><a name="withNewTickyCounterThunk"><a href="StgCmmTicky.html#withNewTickyCounterThunk"><span class="hs-identifier">withNewTickyCounterThunk</span></a></a><span> </span><a name="local-6989586621680755813"><a href="#local-6989586621680755813"><span class="hs-identifier">isStatic</span></a></a><span> </span><a name="local-6989586621680755814"><a href="#local-6989586621680755814"><span class="hs-identifier">isUpdatable</span></a></a><span> </span><a name="local-6989586621680755815"><a href="#local-6989586621680755815"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680755816"><a href="#local-6989586621680755816"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621680755817"><a href="#local-6989586621680755817"><span class="hs-identifier">has_ctr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#thunkHasCounter"><span class="hs-identifier hs-var">thunkHasCounter</span></a><span> </span><a href="#local-6989586621680755813"><span class="hs-identifier hs-var">isStatic</span></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755817"><span class="hs-identifier hs-var">has_ctr</span></a><span>
</span><a name="line-178"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680755816"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-179"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounter"><span class="hs-identifier hs-var">withNewTickyCounter</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#TickyThunk"><span class="hs-identifier hs-var">TickyThunk</span></a><span> </span><a href="#local-6989586621680755814"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755815"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680755816"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">withNewTickyCounterStdThunk</span><span>
</span><a name="line-182"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ updateable</span><span>
</span><a name="line-183"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755802"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-185"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755802"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-186"></a><a name="withNewTickyCounterStdThunk"><a href="StgCmmTicky.html#withNewTickyCounterStdThunk"><span class="hs-identifier">withNewTickyCounterStdThunk</span></a></a><span> </span><a name="local-6989586621680755818"><a href="#local-6989586621680755818"><span class="hs-identifier">isUpdatable</span></a></a><span> </span><a name="local-6989586621680755819"><a href="#local-6989586621680755819"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680755820"><a href="#local-6989586621680755820"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-187"></a><span>    </span><a name="local-6989586621680755821"><a href="#local-6989586621680755821"><span class="hs-identifier">has_ctr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#thunkHasCounter"><span class="hs-identifier hs-var">thunkHasCounter</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755821"><span class="hs-identifier hs-var">has_ctr</span></a><span>
</span><a name="line-189"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680755820"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-190"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounter"><span class="hs-identifier hs-var">withNewTickyCounter</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#TickyThunk"><span class="hs-identifier hs-var">TickyThunk</span></a><span> </span><a href="#local-6989586621680755818"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755819"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680755820"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-identifier">withNewTickyCounterCon</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755801"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755801"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-196"></a><a name="withNewTickyCounterCon"><a href="StgCmmTicky.html#withNewTickyCounterCon"><span class="hs-identifier">withNewTickyCounterCon</span></a></a><span> </span><a name="local-6989586621680755822"><a href="#local-6989586621680755822"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680755823"><a href="#local-6989586621680755823"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-197"></a><span>    </span><a name="local-6989586621680755824"><a href="#local-6989586621680755824"><span class="hs-identifier">has_ctr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#thunkHasCounter"><span class="hs-identifier hs-var">thunkHasCounter</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755824"><span class="hs-identifier hs-var">has_ctr</span></a><span>
</span><a name="line-199"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680755823"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-200"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounter"><span class="hs-identifier hs-var">withNewTickyCounter</span></a><span> </span><a href="StgCmmTicky.html#TickyCon"><span class="hs-identifier hs-var">TickyCon</span></a><span> </span><a href="#local-6989586621680755822"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680755823"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">-- args does not include the void arguments</span><span>
</span><a name="line-203"></a><span class="hs-identifier">withNewTickyCounter</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmTicky.html#TickyClosureType"><span class="hs-identifier hs-type">TickyClosureType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755800"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680755800"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-204"></a><a name="withNewTickyCounter"><a href="StgCmmTicky.html#withNewTickyCounter"><span class="hs-identifier">withNewTickyCounter</span></a></a><span> </span><a name="local-6989586621680755825"><a href="#local-6989586621680755825"><span class="hs-identifier">cloType</span></a></a><span> </span><a name="local-6989586621680755826"><a href="#local-6989586621680755826"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680755827"><a href="#local-6989586621680755827"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680755828"><a href="#local-6989586621680755828"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-205"></a><span>  </span><a name="local-6989586621680755829"><a href="#local-6989586621680755829"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#emitTickyCounter"><span class="hs-identifier hs-var">emitTickyCounter</span></a><span> </span><a href="#local-6989586621680755825"><span class="hs-identifier hs-var">cloType</span></a><span> </span><a href="#local-6989586621680755826"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680755827"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-206"></a><span>  </span><a href="StgCmmMonad.html#setTickyCtrLabel"><span class="hs-identifier hs-var">setTickyCtrLabel</span></a><span> </span><a href="#local-6989586621680755829"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680755828"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-identifier">emitTickyCounter</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmTicky.html#TickyClosureType"><span class="hs-identifier hs-type">TickyClosureType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-209"></a><a name="emitTickyCounter"><a href="StgCmmTicky.html#emitTickyCounter"><span class="hs-identifier">emitTickyCounter</span></a></a><span> </span><a name="local-6989586621680755830"><a href="#local-6989586621680755830"><span class="hs-identifier">cloType</span></a></a><span> </span><a name="local-6989586621680755831"><a href="#local-6989586621680755831"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680755832"><a href="#local-6989586621680755832"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-210"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755833"><a href="#local-6989586621680755833"><span class="hs-identifier">ctr_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkRednCountsLabel"><span class="hs-identifier hs-var">mkRednCountsLabel</span></a><span> </span><a href="#local-6989586621680755831"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-211"></a><span>    </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680755833"><span class="hs-identifier hs-var">ctr_lbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-212"></a><span>    </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680755834"><a href="#local-6989586621680755834"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-214"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680755835"><a href="#local-6989586621680755835"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier hs-var">getTickyCtrLabel</span></a><span>
</span><a name="line-215"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680755836"><a href="#local-6989586621680755836"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier hs-var">getModuleName</span></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span>          </span><span class="hs-comment">-- When printing the name of a thing in a ticky file, we</span><span>
</span><a name="line-218"></a><span>          </span><span class="hs-comment">-- want to give the module name even for *local* things.  We</span><span>
</span><a name="line-219"></a><span>          </span><span class="hs-comment">-- print just &quot;x (M)&quot; rather that &quot;M.x&quot; to distinguish them</span><span>
</span><a name="line-220"></a><span>          </span><span class="hs-comment">-- from the global kind.</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">ppr_for_ticky_name</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-222"></a><span>              </span><a name="local-6989586621680755837"><a href="#local-6989586621680755837"><span class="hs-identifier">ppr_for_ticky_name</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-223"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755838"><a href="#local-6989586621680755838"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680755831"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-224"></a><span>                    </span><a name="local-6989586621680755839"><a href="#local-6989586621680755839"><span class="hs-identifier">ext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680755830"><span class="hs-identifier hs-var">cloType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-225"></a><span>                              </span><a href="StgCmmTicky.html#TickyFun"><span class="hs-identifier hs-var">TickyFun</span></a><span> </span><a name="local-6989586621680755841"><a href="#local-6989586621680755841"><span class="hs-identifier">single_entry</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-226"></a><span>                                  </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;fun&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;se&quot;</span><span class="hs-glyph">|</span><a href="#local-6989586621680755841"><span class="hs-identifier hs-var">single_entry</span></a><span class="hs-special">]</span><span>
</span><a name="line-227"></a><span>                              </span><a href="StgCmmTicky.html#TickyCon"><span class="hs-identifier hs-var">TickyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;con&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>                              </span><a href="StgCmmTicky.html#TickyThunk"><span class="hs-identifier hs-var">TickyThunk</span></a><span> </span><a name="local-6989586621680755842"><a href="#local-6989586621680755842"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621680755843"><a href="#local-6989586621680755843"><span class="hs-identifier">std</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-229"></a><span>                                  </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;thk&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;se&quot;</span><span class="hs-glyph">|</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755842"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;std&quot;</span><span class="hs-glyph">|</span><a href="#local-6989586621680755843"><span class="hs-identifier hs-var">std</span></a><span class="hs-special">]</span><span>
</span><a name="line-230"></a><span>                              </span><a href="StgCmmTicky.html#TickyLNE"><span class="hs-identifier hs-var">TickyLNE</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isInternalName</span><span> </span><a href="#local-6989586621680755831"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;LNE&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>                                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;emitTickyCounter: how is this an external LNE?&quot;</span><span>
</span><a name="line-232"></a><span>                    </span><a name="local-6989586621680755840"><a href="#local-6989586621680755840"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CLabel.html#hasHaskellName"><span class="hs-identifier hs-var">hasHaskellName</span></a><span> </span><a href="#local-6989586621680755835"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-233"></a><span>                            </span><span class="hs-comment">-- NB the default &quot;top&quot; ticky ctr does not</span><span>
</span><a name="line-234"></a><span>                            </span><span class="hs-comment">-- have a Haskell name</span><span>
</span><a name="line-235"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680755844"><a href="#local-6989586621680755844"><span class="hs-identifier">pname</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameUnique</span><span> </span><a href="#local-6989586621680755844"><span class="hs-identifier hs-var">pname</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>                          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-237"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isInternalName</span><span> </span><a href="#local-6989586621680755831"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-238"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680755838"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680755836"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621680755839"><span class="hs-identifier hs-var">ext</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621680755840"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-239"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621680755838"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621680755839"><span class="hs-identifier hs-var">ext</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621680755840"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680755845"><a href="#local-6989586621680755845"><span class="hs-identifier">fun_descr_lit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newStringCLit"><span class="hs-identifier hs-var">newStringCLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showSDocDebug</span><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680755837"><span class="hs-identifier hs-var">ppr_for_ticky_name</span></a><span>
</span><a name="line-242"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680755846"><a href="#local-6989586621680755846"><span class="hs-identifier">arg_descr_lit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newStringCLit"><span class="hs-identifier hs-var">newStringCLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#showTypeCategory"><span class="hs-identifier hs-var">showTypeCategory</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755832"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-243"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmUtils.html#emitDataLits"><span class="hs-identifier hs-var">emitDataLits</span></a><span> </span><a href="#local-6989586621680755833"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- Must match layout of includes/rts/Ticky.h's StgEntCounter</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-comment">-- krc: note that all the fields are I32 now; some were I16</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">-- before, but the code generator wasn't handling that</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">-- properly and it led to chaos, panic and disorder.</span><span>
</span><a name="line-249"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>               </span><span class="hs-comment">-- registered?</span><span>
</span><a name="line-250"></a><span>              </span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680755832"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Arity</span><span>
</span><a name="line-251"></a><span>              </span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>               </span><span class="hs-comment">-- Heap allocated for this thing</span><span>
</span><a name="line-252"></a><span>              </span><a href="#local-6989586621680755845"><span class="hs-identifier hs-var">fun_descr_lit</span></a><span class="hs-special">,</span><span>
</span><a name="line-253"></a><span>              </span><a href="#local-6989586621680755846"><span class="hs-identifier hs-var">arg_descr_lit</span></a><span class="hs-special">,</span><span>
</span><a name="line-254"></a><span>              </span><a href="CmmUtils.html#zeroCLit"><span class="hs-identifier hs-var">zeroCLit</span></a><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- Entries into this thing</span><span>
</span><a name="line-255"></a><span>              </span><a href="CmmUtils.html#zeroCLit"><span class="hs-identifier hs-var">zeroCLit</span></a><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- Heap allocated by this thing</span><span>
</span><a name="line-256"></a><span>              </span><a href="CmmUtils.html#zeroCLit"><span class="hs-identifier hs-var">zeroCLit</span></a><span> </span><a href="#local-6989586621680755834"><span class="hs-identifier hs-var">dflags</span></a><span>                   </span><span class="hs-comment">-- Link to next StgEntCounter</span><span>
</span><a name="line-257"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- Ticky stack frames</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">tickyPushUpdateFrame</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tickyUpdateFrameOmitted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-264"></a><a name="tickyPushUpdateFrame"><a href="StgCmmTicky.html#tickyPushUpdateFrame"><span class="hs-identifier">tickyPushUpdateFrame</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UPDF_PUSHED_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="tickyUpdateFrameOmitted"><a href="StgCmmTicky.html#tickyUpdateFrameOmitted"><span class="hs-identifier">tickyUpdateFrameOmitted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UPDF_OMITTED_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- Ticky entries</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- NB the name-specific entries are only available for names that have</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- dedicated Cmm code. As far as I know, this just rules out</span><span>
</span><a name="line-272"></a><span class="hs-comment">-- constructor thunks. For them, there is no CMM code block to put the</span><span>
</span><a name="line-273"></a><span class="hs-comment">-- bump of name-specific ticky counter into. On the other hand, we can</span><span>
</span><a name="line-274"></a><span class="hs-comment">-- still track allocation their allocation.</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-identifier">tickyEnterDynCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tickyEnterStaticCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tickyEnterViaNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-277"></a><a name="tickyEnterDynCon"><a href="StgCmmTicky.html#tickyEnterDynCon"><span class="hs-identifier">tickyEnterDynCon</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_DYN_CON_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-278"></a><a name="tickyEnterStaticCon"><a href="StgCmmTicky.html#tickyEnterStaticCon"><span class="hs-identifier">tickyEnterStaticCon</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_STATIC_CON_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-279"></a><a name="tickyEnterViaNode"><a href="StgCmmTicky.html#tickyEnterViaNode"><span class="hs-identifier">tickyEnterViaNode</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_VIA_NODE_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-identifier">tickyEnterThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-282"></a><a name="tickyEnterThunk"><a href="StgCmmTicky.html#tickyEnterThunk"><span class="hs-identifier">tickyEnterThunk</span></a></a><span> </span><a name="local-6989586621680755847"><a href="#local-6989586621680755847"><span class="hs-identifier">cl_info</span></a></a><span>
</span><a name="line-283"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><a href="#local-6989586621680755850"><span class="hs-identifier hs-var">ctr</span></a><span>
</span><a name="line-285"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680755851"><a href="#local-6989586621680755851"><span class="hs-identifier">has_ctr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#thunkHasCounter"><span class="hs-identifier hs-var">thunkHasCounter</span></a><span> </span><a href="#local-6989586621680755849"><span class="hs-identifier hs-var">static</span></a><span>
</span><a name="line-286"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621680755851"><span class="hs-identifier hs-var">has_ctr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-287"></a><span>      </span><a name="local-6989586621680755852"><a href="#local-6989586621680755852"><span class="hs-identifier">ticky_ctr_lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier hs-var">getTickyCtrLabel</span></a><span>
</span><a name="line-288"></a><span>      </span><a href="StgCmmTicky.html#registerTickyCtrAtEntryDyn"><span class="hs-identifier hs-var">registerTickyCtrAtEntryDyn</span></a><span> </span><a href="#local-6989586621680755852"><span class="hs-identifier hs-var">ticky_ctr_lbl</span></a><span>
</span><a name="line-289"></a><span>      </span><a href="StgCmmTicky.html#bumpTickyEntryCount"><span class="hs-identifier hs-var">bumpTickyEntryCount</span></a><span> </span><a href="#local-6989586621680755852"><span class="hs-identifier hs-var">ticky_ctr_lbl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-291"></a><span>    </span><a name="local-6989586621680755848"><a href="#local-6989586621680755848"><span class="hs-identifier">updatable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#closureSingleEntry"><span class="hs-identifier hs-var">closureSingleEntry</span></a><span> </span><a href="#local-6989586621680755847"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-292"></a><span>    </span><a name="local-6989586621680755849"><a href="#local-6989586621680755849"><span class="hs-identifier">static</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#isStaticClosure"><span class="hs-identifier hs-var">isStaticClosure</span></a><span> </span><a href="#local-6989586621680755847"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621680755850"><a href="#local-6989586621680755850"><span class="hs-identifier">ctr</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755849"><span class="hs-identifier hs-var">static</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680755848"><span class="hs-identifier hs-var">updatable</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_STATIC_THK_SINGLE_ctr&quot;</span><span>
</span><a name="line-295"></a><span>                                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_STATIC_THK_MANY_ctr&quot;</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680755848"><span class="hs-identifier hs-var">updatable</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_DYN_THK_SINGLE_ctr&quot;</span><span>
</span><a name="line-297"></a><span>                                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_DYN_THK_MANY_ctr&quot;</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-identifier">tickyEnterStdThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><a name="tickyEnterStdThunk"><a href="StgCmmTicky.html#tickyEnterStdThunk"><span class="hs-identifier">tickyEnterStdThunk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#tickyEnterThunk"><span class="hs-identifier hs-var">tickyEnterThunk</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">tickyBlackHole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-comment">{-updatable-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><a name="tickyBlackHole"><a href="StgCmmTicky.html#tickyBlackHole"><span class="hs-identifier">tickyBlackHole</span></a></a><span> </span><a name="local-6989586621680755853"><a href="#local-6989586621680755853"><span class="hs-identifier">updatable</span></a></a><span>
</span><a name="line-304"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><a href="#local-6989586621680755854"><span class="hs-identifier hs-var">ctr</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-306"></a><span>    </span><a name="local-6989586621680755854"><a href="#local-6989586621680755854"><span class="hs-identifier">ctr</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755853"><span class="hs-identifier hs-var">updatable</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UPD_BH_SINGLE_ENTRY_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UPD_BH_UPDATABLE_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-identifier">tickyUpdateBhCaf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><a name="tickyUpdateBhCaf"><a href="StgCmmTicky.html#tickyUpdateBhCaf"><span class="hs-identifier">tickyUpdateBhCaf</span></a></a><span> </span><a name="local-6989586621680755855"><a href="#local-6989586621680755855"><span class="hs-identifier">cl_info</span></a></a><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><a href="#local-6989586621680755856"><span class="hs-identifier hs-var">ctr</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-313"></a><span>    </span><a name="local-6989586621680755856"><a href="#local-6989586621680755856"><span class="hs-identifier">ctr</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="StgCmmClosure.html#closureUpdReqd"><span class="hs-identifier hs-var">closureUpdReqd</span></a><span> </span><a href="#local-6989586621680755855"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UPD_CAF_BH_SINGLE_ENTRY_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UPD_CAF_BH_UPDATABLE_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-identifier">tickyEnterFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-317"></a><a name="tickyEnterFun"><a href="StgCmmTicky.html#tickyEnterFun"><span class="hs-identifier">tickyEnterFun</span></a></a><span> </span><a name="local-6989586621680755857"><a href="#local-6989586621680755857"><span class="hs-identifier">cl_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-318"></a><span>  </span><a name="local-6989586621680755858"><a href="#local-6989586621680755858"><span class="hs-identifier">ctr_lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier hs-var">getTickyCtrLabel</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#isStaticClosure"><span class="hs-identifier hs-var">isStaticClosure</span></a><span> </span><a href="#local-6989586621680755857"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-321"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_STATIC_FUN_DIRECT_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>            </span><a href="StgCmmTicky.html#registerTickyCtr"><span class="hs-identifier hs-var">registerTickyCtr</span></a><span> </span><a href="#local-6989586621680755858"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-323"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_DYN_FUN_DIRECT_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>            </span><a href="StgCmmTicky.html#registerTickyCtrAtEntryDyn"><span class="hs-identifier hs-var">registerTickyCtrAtEntryDyn</span></a><span> </span><a href="#local-6989586621680755858"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyEntryCount"><span class="hs-identifier hs-var">bumpTickyEntryCount</span></a><span> </span><a href="#local-6989586621680755858"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-identifier">tickyEnterLNE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-329"></a><a name="tickyEnterLNE"><a href="StgCmmTicky.html#tickyEnterLNE"><span class="hs-identifier">tickyEnterLNE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-330"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ENT_LNE_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>  </span><a href="StgCmmTicky.html#ifTickyLNE"><span class="hs-identifier hs-var">ifTickyLNE</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-332"></a><span>    </span><a name="local-6989586621680755859"><a href="#local-6989586621680755859"><span class="hs-identifier">ctr_lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier hs-var">getTickyCtrLabel</span></a><span>
</span><a name="line-333"></a><span>    </span><a href="StgCmmTicky.html#registerTickyCtr"><span class="hs-identifier hs-var">registerTickyCtr</span></a><span> </span><a href="#local-6989586621680755859"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-334"></a><span>    </span><a href="StgCmmTicky.html#bumpTickyEntryCount"><span class="hs-identifier hs-var">bumpTickyEntryCount</span></a><span> </span><a href="#local-6989586621680755859"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span class="hs-comment">-- needn't register a counter upon entry if</span><span>
</span><a name="line-337"></a><span class="hs-comment">--</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- 1) it's for a dynamic closure, and</span><span>
</span><a name="line-339"></a><span class="hs-comment">--</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- 2) -ticky-allocd is on</span><span>
</span><a name="line-341"></a><span class="hs-comment">--</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- since the counter was registered already upon being alloc'd</span><span>
</span><a name="line-343"></a><span class="hs-identifier">registerTickyCtrAtEntryDyn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><a name="registerTickyCtrAtEntryDyn"><a href="StgCmmTicky.html#registerTickyCtrAtEntryDyn"><span class="hs-identifier">registerTickyCtrAtEntryDyn</span></a></a><span> </span><a name="local-6989586621680755860"><a href="#local-6989586621680755860"><span class="hs-identifier">ctr_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>  </span><a name="local-6989586621680755861"><a href="#local-6989586621680755861"><span class="hs-identifier">already_registered</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmTicky.html#tickyAllocdIsOn"><span class="hs-identifier hs-var">tickyAllocdIsOn</span></a><span>
</span><a name="line-346"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755861"><span class="hs-identifier hs-var">already_registered</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#registerTickyCtr"><span class="hs-identifier hs-var">registerTickyCtr</span></a><span> </span><a href="#local-6989586621680755860"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">registerTickyCtr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span class="hs-comment">-- Register a ticky counter</span><span>
</span><a name="line-350"></a><span class="hs-comment">--   if ( ! f_ct.registeredp ) {</span><span>
</span><a name="line-351"></a><span class="hs-comment">--          f_ct.link = ticky_entry_ctrs;       /* hook this one onto the front of the list */</span><span>
</span><a name="line-352"></a><span class="hs-comment">--          ticky_entry_ctrs = &amp; (f_ct);        /* mark it as &quot;registered&quot; */</span><span>
</span><a name="line-353"></a><span class="hs-comment">--          f_ct.registeredp = 1 }</span><span>
</span><a name="line-354"></a><a name="registerTickyCtr"><a href="StgCmmTicky.html#registerTickyCtr"><span class="hs-identifier">registerTickyCtr</span></a></a><span> </span><a name="local-6989586621680755862"><a href="#local-6989586621680755862"><span class="hs-identifier">ctr_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-355"></a><span>  </span><a name="local-6989586621680755863"><a href="#local-6989586621680755863"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-357"></a><span>    </span><span class="hs-comment">-- krc: code generator doesn't handle Not, so we test for Eq 0 instead</span><span>
</span><a name="line-358"></a><span>    </span><a name="local-6989586621680755864"><a href="#local-6989586621680755864"><span class="hs-identifier">test</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Eq"><span class="hs-identifier hs-var">MO_Eq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>              </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755862"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-360"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgEntCounter_registeredp</span><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-361"></a><span>               </span><a href="CmmUtils.html#zeroExpr"><span class="hs-identifier hs-var">zeroExpr</span></a><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">]</span><span>
</span><a name="line-362"></a><span>    </span><a name="local-6989586621680755865"><a href="#local-6989586621680755865"><span class="hs-identifier">register_stmts</span></a></a><span>
</span><a name="line-363"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755862"><span class="hs-identifier hs-var">ctr_lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgEntCounter_link</span><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>                   </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a href="#local-6989586621680755866"><span class="hs-identifier hs-var">ticky_entry_ctrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><a href="#local-6989586621680755866"><span class="hs-identifier hs-var">ticky_entry_ctrs</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#mkLblExpr"><span class="hs-identifier hs-var">mkLblExpr</span></a><span> </span><a href="#local-6989586621680755862"><span class="hs-identifier hs-var">ctr_lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755862"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-367"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgEntCounter_registeredp</span><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>                   </span><span class="hs-special">(</span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621680755863"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-369"></a><span>    </span><a name="local-6989586621680755866"><a href="#local-6989586621680755866"><span class="hs-identifier">ticky_entry_ctrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#mkLblExpr"><span class="hs-identifier hs-var">mkLblExpr</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ticky_entry_ctrs&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThen"><span class="hs-identifier hs-var">mkCmmIfThen</span></a><span> </span><a href="#local-6989586621680755864"><span class="hs-identifier hs-var">test</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><a href="#local-6989586621680755865"><span class="hs-identifier hs-var">register_stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-identifier">tickyReturnOldCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tickyReturnNewCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RepArity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><a name="tickyReturnOldCon"><a href="StgCmmTicky.html#tickyReturnOldCon"><span class="hs-identifier">tickyReturnOldCon</span></a></a><span> </span><a name="local-6989586621680755867"><a href="#local-6989586621680755867"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-374"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;RET_OLD_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#bumpHistogram"><span class="hs-identifier hs-var">bumpHistogram</span></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;RET_OLD_hst&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755867"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-376"></a><a name="tickyReturnNewCon"><a href="StgCmmTicky.html#tickyReturnNewCon"><span class="hs-identifier">tickyReturnNewCon</span></a></a><span> </span><a name="local-6989586621680755868"><a href="#local-6989586621680755868"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;RET_NEW_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#bumpHistogram"><span class="hs-identifier hs-var">bumpHistogram</span></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;RET_NEW_hst&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755868"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-identifier">tickyUnboxedTupleReturn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RepArity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><a name="tickyUnboxedTupleReturn"><a href="StgCmmTicky.html#tickyUnboxedTupleReturn"><span class="hs-identifier">tickyUnboxedTupleReturn</span></a></a><span> </span><a name="local-6989586621680755869"><a href="#local-6989586621680755869"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-382"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;RET_UNBOXED_TUP_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#bumpHistogram"><span class="hs-identifier hs-var">bumpHistogram</span></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;RET_UNBOXED_TUP_hst&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755869"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- Ticky calls</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span class="hs-comment">-- Ticks at a *call site*:</span><span>
</span><a name="line-389"></a><span class="hs-identifier">tickyDirectCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RepArity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><a name="tickyDirectCall"><a href="StgCmmTicky.html#tickyDirectCall"><span class="hs-identifier">tickyDirectCall</span></a></a><span> </span><a name="local-6989586621680755870"><a href="#local-6989586621680755870"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621680755871"><a href="#local-6989586621680755871"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-391"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755871"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680755870"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#tickyKnownCallExact"><span class="hs-identifier hs-var">tickyKnownCallExact</span></a><span>
</span><a name="line-392"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="StgCmmTicky.html#tickyKnownCallExtraArgs"><span class="hs-identifier hs-var">tickyKnownCallExtraArgs</span></a><span>
</span><a name="line-393"></a><span>                   </span><a href="StgCmmTicky.html#tickySlowCallPat"><span class="hs-identifier hs-var">tickySlowCallPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgCmmClosure.html#argPrimRep"><span class="hs-identifier hs-var">argPrimRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621680755870"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621680755871"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-identifier">tickyKnownCallTooFewArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><a name="tickyKnownCallTooFewArgs"><a href="StgCmmTicky.html#tickyKnownCallTooFewArgs"><span class="hs-identifier">tickyKnownCallTooFewArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;KNOWN_CALL_TOO_FEW_ARGS_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-identifier">tickyKnownCallExact</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-399"></a><a name="tickyKnownCallExact"><a href="StgCmmTicky.html#tickyKnownCallExact"><span class="hs-identifier">tickyKnownCallExact</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;KNOWN_CALL_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-identifier">tickyKnownCallExtraArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-402"></a><a name="tickyKnownCallExtraArgs"><a href="StgCmmTicky.html#tickyKnownCallExtraArgs"><span class="hs-identifier">tickyKnownCallExtraArgs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;KNOWN_CALL_EXTRA_ARGS_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-identifier">tickyUnknownCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><a name="tickyUnknownCall"><a href="StgCmmTicky.html#tickyUnknownCall"><span class="hs-identifier">tickyUnknownCall</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;UNKNOWN_CALL_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-comment">-- Tick for the call pattern at slow call site (i.e. in addition to</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- tickyUnknownCall, tickyKnownCallExtraArgs, etc.)</span><span>
</span><a name="line-409"></a><span class="hs-identifier">tickySlowCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-410"></a><a name="tickySlowCall"><a href="StgCmmTicky.html#tickySlowCall"><span class="hs-identifier">tickySlowCall</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span class="hs-identifier">tickySlowCall</span><span> </span><a name="local-6989586621680755872"><a href="#local-6989586621680755872"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621680755873"><a href="#local-6989586621680755873"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-412"></a><span> </span><span class="hs-comment">-- see Note [Ticky for slow calls]</span><span>
</span><a name="line-413"></a><span> </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#isKnownFun"><span class="hs-identifier hs-var">isKnownFun</span></a><span> </span><a href="#local-6989586621680755872"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-414"></a><span>   </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmTicky.html#tickyKnownCallTooFewArgs"><span class="hs-identifier hs-var">tickyKnownCallTooFewArgs</span></a><span>
</span><a name="line-415"></a><span>   </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmTicky.html#tickyUnknownCall"><span class="hs-identifier hs-var">tickyUnknownCall</span></a><span>
</span><a name="line-416"></a><span> </span><a href="StgCmmTicky.html#tickySlowCallPat"><span class="hs-identifier hs-var">tickySlowCallPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgCmmClosure.html#argPrimRep"><span class="hs-identifier hs-var">argPrimRep</span></a><span> </span><a href="#local-6989586621680755873"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-identifier">tickySlowCallPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-419"></a><a name="tickySlowCallPat"><a href="StgCmmTicky.html#tickySlowCallPat"><span class="hs-identifier">tickySlowCallPat</span></a></a><span> </span><a name="local-6989586621680755874"><a href="#local-6989586621680755874"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-420"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755875"><a href="#local-6989586621680755875"><span class="hs-identifier">argReps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><a href="#local-6989586621680755874"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-421"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680755876"><a href="#local-6989586621680755876"><span class="hs-identifier">n_matched</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmArgRep.html#slowCallPattern"><span class="hs-identifier hs-var">slowCallPattern</span></a><span> </span><a href="#local-6989586621680755875"><span class="hs-identifier hs-var">argReps</span></a><span>
</span><a name="line-422"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680755876"><span class="hs-identifier hs-var">n_matched</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680755874"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680755876"><span class="hs-identifier hs-var">n_matched</span></a><span>
</span><a name="line-423"></a><span>     </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmTicky.html#bumpTickyLbl"><span class="hs-identifier hs-var">bumpTickyLbl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CLabel.html#mkRtsSlowFastTickyCtrLabel"><span class="hs-identifier hs-var">mkRtsSlowFastTickyCtrLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Data.Char.toLower</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmArgRep.html#argRepString"><span class="hs-identifier hs-var">argRepString</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755875"><span class="hs-identifier hs-var">argReps</span></a><span>
</span><a name="line-424"></a><span>     </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;VERY_SLOW_CALL_ctr&quot;</span><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span class="hs-comment">{-

Note [Ticky for slow calls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Terminology is unfortunately a bit mixed up for these calls. codeGen
uses &quot;slow call&quot; to refer to unknown calls and under-saturated known
calls.

Nowadays, though (ie as of the eval/apply paper), the significantly
slower calls are actually just a subset of these: the ones with no
built-in argument pattern (cf StgCmmArgRep.slowCallPattern)

So for ticky profiling, we split slow calls into
&quot;SLOW_CALL_fast_&lt;pattern&gt;_ctr&quot; (those matching a built-in pattern) and
VERY_SLOW_CALL_ctr (those without a built-in pattern; these are very
bad for both space and time).

-}</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- Ticky allocation</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">tickyDynAlloc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#SMRep"><span class="hs-identifier hs-type">SMRep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- Called when doing a dynamic heap allocation; the LambdaFormInfo</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- used to distinguish between closure types</span><span>
</span><a name="line-451"></a><span class="hs-comment">--</span><span>
</span><a name="line-452"></a><span class="hs-comment">-- TODO what else to count while we're here?</span><span>
</span><a name="line-453"></a><a name="tickyDynAlloc"><a href="StgCmmTicky.html#tickyDynAlloc"><span class="hs-identifier">tickyDynAlloc</span></a></a><span> </span><a name="local-6989586621680755877"><a href="#local-6989586621680755877"><span class="hs-identifier">mb_id</span></a></a><span> </span><a name="local-6989586621680755878"><a href="#local-6989586621680755878"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-6989586621680755879"><a href="#local-6989586621680755879"><span class="hs-identifier">lf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680755880"><a href="#local-6989586621680755880"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-454"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755881"><a href="#local-6989586621680755881"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621680755880"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="SMRep.html#heapClosureSizeW"><span class="hs-identifier hs-var">heapClosureSizeW</span></a><span> </span><a href="#local-6989586621680755880"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680755878"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>      </span><a name="local-6989586621680755882"><a href="#local-6989586621680755882"><span class="hs-identifier">countGlobal</span></a></a><span> </span><a name="local-6989586621680755884"><a href="#local-6989586621680755884"><span class="hs-identifier">tot</span></a></a><span> </span><a name="local-6989586621680755885"><a href="#local-6989586621680755885"><span class="hs-identifier">ctr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-457"></a><span>        </span><a href="StgCmmTicky.html#bumpTickyCounterBy"><span class="hs-identifier hs-var">bumpTickyCounterBy</span></a><span> </span><a href="#local-6989586621680755884"><span class="hs-identifier hs-var">tot</span></a><span> </span><a href="#local-6989586621680755881"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-458"></a><span>        </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span>   </span><a href="#local-6989586621680755885"><span class="hs-identifier hs-var">ctr</span></a><span>
</span><a name="line-459"></a><span>      </span><a name="local-6989586621680755883"><a href="#local-6989586621680755883"><span class="hs-identifier">countSpecific</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTickyAllocd"><span class="hs-identifier hs-var">ifTickyAllocd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680755877"><span class="hs-identifier hs-var">mb_id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-460"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680755886"><a href="#local-6989586621680755886"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-462"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755887"><a href="#local-6989586621680755887"><span class="hs-identifier">ctr_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkRednCountsLabel"><span class="hs-identifier hs-var">mkRednCountsLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680755886"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>          </span><a href="StgCmmTicky.html#registerTickyCtr"><span class="hs-identifier hs-var">registerTickyCtr</span></a><span> </span><a href="#local-6989586621680755887"><span class="hs-identifier hs-var">ctr_lbl</span></a><span>
</span><a name="line-464"></a><span>          </span><a href="StgCmmTicky.html#bumpTickyAllocd"><span class="hs-identifier hs-var">bumpTickyAllocd</span></a><span> </span><a href="#local-6989586621680755887"><span class="hs-identifier hs-var">ctr_lbl</span></a><span> </span><a href="#local-6989586621680755881"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span>  </span><span class="hs-comment">-- TODO are we still tracking &quot;good stuff&quot; (_gds) versus</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-comment">-- administrative (_adm) versus slop (_slp)? I'm going with all _gds</span><span>
</span><a name="line-468"></a><span>  </span><span class="hs-comment">-- for now, since I don't currently know neither if we do nor how to</span><span>
</span><a name="line-469"></a><span>  </span><span class="hs-comment">-- distinguish. NSF Mar 2013</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="SMRep.html#isConRep"><span class="hs-identifier hs-var">isConRep</span></a><span> </span><a href="#local-6989586621680755878"><span class="hs-identifier hs-var">rep</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-473"></a><span>          </span><a href="StgCmmTicky.html#ifTickyDynThunk"><span class="hs-identifier hs-var">ifTickyDynThunk</span></a><span> </span><a href="#local-6989586621680755883"><span class="hs-identifier hs-var">countSpecific</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-474"></a><span>          </span><a href="#local-6989586621680755882"><span class="hs-identifier hs-var">countGlobal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_CON_gds&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_CON_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="SMRep.html#isThunkRep"><span class="hs-identifier hs-var">isThunkRep</span></a><span> </span><a href="#local-6989586621680755878"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-476"></a><span>          </span><a href="StgCmmTicky.html#ifTickyDynThunk"><span class="hs-identifier hs-var">ifTickyDynThunk</span></a><span> </span><a href="#local-6989586621680755883"><span class="hs-identifier hs-var">countSpecific</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-477"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#lfUpdatable"><span class="hs-identifier hs-var">lfUpdatable</span></a><span> </span><a href="#local-6989586621680755879"><span class="hs-identifier hs-var">lf</span></a><span>
</span><a name="line-478"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680755882"><span class="hs-identifier hs-var">countGlobal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_THK_gds&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_UP_THK_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621680755882"><span class="hs-identifier hs-var">countGlobal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_THK_gds&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_SE_THK_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="SMRep.html#isFunRep"><span class="hs-identifier hs-var">isFunRep</span></a><span>   </span><a href="#local-6989586621680755878"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-481"></a><span>          </span><a href="#local-6989586621680755883"><span class="hs-identifier hs-var">countSpecific</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-482"></a><span>          </span><a href="#local-6989586621680755882"><span class="hs-identifier hs-var">countGlobal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_FUN_gds&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_FUN_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;How is this heap object not a con, thunk, or fun?&quot;</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-identifier">tickyAllocHeap</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- is this a genuine allocation? As opposed to</span><span>
</span><a name="line-489"></a><span>          </span><span class="hs-comment">-- StgCmmLayout.adjustHpBackwards</span><span>
</span><a name="line-490"></a><span>  </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- Called when doing a heap check [TICK_ALLOC_HEAP]</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- Must be lazy in the amount of allocation!</span><span>
</span><a name="line-493"></a><a name="tickyAllocHeap"><a href="StgCmmTicky.html#tickyAllocHeap"><span class="hs-identifier">tickyAllocHeap</span></a></a><span> </span><a name="local-6989586621680755888"><a href="#local-6989586621680755888"><span class="hs-identifier">genuine</span></a></a><span> </span><a name="local-6989586621680755889"><a href="#local-6989586621680755889"><span class="hs-identifier">hp</span></a></a><span>
</span><a name="line-494"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680755890"><a href="#local-6989586621680755890"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-496"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680755891"><a href="#local-6989586621680755891"><span class="hs-identifier">ticky_ctr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier hs-var">getTickyCtrLabel</span></a><span>
</span><a name="line-497"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-498"></a><span>            </span><span class="hs-comment">-- only test hp from within the emit so that the monadic</span><span>
</span><a name="line-499"></a><span>            </span><span class="hs-comment">-- computation itself is not strict in hp (cf knot in</span><span>
</span><a name="line-500"></a><span>            </span><span class="hs-comment">-- StgCmmMonad.getHeapUsage)</span><span>
</span><a name="line-501"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680755889"><span class="hs-identifier hs-var">hp</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-502"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680755892"><a href="#local-6989586621680755892"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621680755890"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621680755889"><span class="hs-identifier hs-var">hp</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-503"></a><span>            </span><span class="hs-comment">-- Bump the allocation total in the closure's StgEntCounter</span><span>
</span><a name="line-504"></a><span>            </span><a href="StgCmmUtils.html#addToMem"><span class="hs-identifier hs-var">addToMem</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rEP_StgEntCounter_allocs</span><span> </span><a href="#local-6989586621680755890"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>                     </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755891"><span class="hs-identifier hs-var">ticky_ctr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgEntCounter_allocs</span><span> </span><a href="#local-6989586621680755890"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>                     </span><a href="#local-6989586621680755892"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-507"></a><span>            </span><span class="hs-comment">-- Bump the global allocation total ALLOC_HEAP_tot</span><span>
</span><a name="line-508"></a><span>            </span><a href="StgCmmUtils.html#addToMemLbl"><span class="hs-identifier hs-var">addToMemLbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755890"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>                        </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_HEAP_tot&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>                        </span><a href="#local-6989586621680755892"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-511"></a><span>            </span><span class="hs-comment">-- Bump the global allocation counter ALLOC_HEAP_ctr</span><span>
</span><a name="line-512"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680755888"><span class="hs-identifier hs-var">genuine</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span>
</span><a name="line-513"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmUtils.html#addToMemLbl"><span class="hs-identifier hs-var">addToMemLbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755890"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>                             </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_HEAP_ctr&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>                             </span><span class="hs-number">1</span><span>
</span><a name="line-516"></a><span>            </span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-520"></a><span class="hs-comment">-- these three are only called from CmmParse.y (ie ultimately from the RTS)</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span class="hs-comment">-- the units are bytes</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-identifier">tickyAllocPrim</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>  </span><span class="hs-comment">-- ^ size of the full header, in bytes</span><span>
</span><a name="line-525"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>  </span><span class="hs-comment">-- ^ size of the payload, in bytes</span><span>
</span><a name="line-526"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-527"></a><a name="tickyAllocPrim"><a href="StgCmmTicky.html#tickyAllocPrim"><span class="hs-identifier">tickyAllocPrim</span></a></a><span> </span><a name="local-6989586621680755893"><a href="#local-6989586621680755893"><span class="hs-identifier">_hdr</span></a></a><span> </span><a name="local-6989586621680755894"><a href="#local-6989586621680755894"><span class="hs-identifier">_goods</span></a></a><span> </span><a name="local-6989586621680755895"><a href="#local-6989586621680755895"><span class="hs-identifier">_slop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-528"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PRIM_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PRIM_adm&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755893"><span class="hs-identifier hs-var">_hdr</span></a><span>
</span><a name="line-530"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PRIM_gds&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755894"><span class="hs-identifier hs-var">_goods</span></a><span>
</span><a name="line-531"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PRIM_slp&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755895"><span class="hs-identifier hs-var">_slop</span></a><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-identifier">tickyAllocThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-534"></a><a name="tickyAllocThunk"><a href="StgCmmTicky.html#tickyAllocThunk"><span class="hs-identifier">tickyAllocThunk</span></a></a><span> </span><a name="local-6989586621680755896"><a href="#local-6989586621680755896"><span class="hs-identifier">_goods</span></a></a><span> </span><a name="local-6989586621680755897"><a href="#local-6989586621680755897"><span class="hs-identifier">_slop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-535"></a><span>    </span><span class="hs-comment">-- TODO is it ever called with a Single-Entry thunk?</span><span>
</span><a name="line-536"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_UP_THK_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_THK_gds&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755896"><span class="hs-identifier hs-var">_goods</span></a><span>
</span><a name="line-538"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_THK_slp&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755897"><span class="hs-identifier hs-var">_slop</span></a><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-identifier">tickyAllocPAP</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-541"></a><a name="tickyAllocPAP"><a href="StgCmmTicky.html#tickyAllocPAP"><span class="hs-identifier">tickyAllocPAP</span></a></a><span> </span><a name="local-6989586621680755898"><a href="#local-6989586621680755898"><span class="hs-identifier">_goods</span></a></a><span> </span><a name="local-6989586621680755899"><a href="#local-6989586621680755899"><span class="hs-identifier">_slop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-542"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PAP_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PAP_gds&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755898"><span class="hs-identifier hs-var">_goods</span></a><span>
</span><a name="line-544"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier hs-var">bumpTickyCounterByE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ALLOC_PAP_slp&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755899"><span class="hs-identifier hs-var">_slop</span></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-identifier">tickyHeapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-547"></a><a name="tickyHeapCheck"><a href="StgCmmTicky.html#tickyHeapCheck"><span class="hs-identifier">tickyHeapCheck</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;HEAP_CHK_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span class="hs-identifier">tickyStackCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-550"></a><a name="tickyStackCheck"><a href="StgCmmTicky.html#tickyStackCheck"><span class="hs-identifier">tickyStackCheck</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier hs-var">ifTicky</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier hs-var">bumpTickyCounter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;STK_CHK_ctr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- Ticky utils</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-identifier">ifTicky</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-556"></a><a name="ifTicky"><a href="StgCmmTicky.html#ifTicky"><span class="hs-identifier">ifTicky</span></a></a><span> </span><a name="local-6989586621680755900"><a href="#local-6989586621680755900"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680755901"><a href="#local-6989586621680755901"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Ticky</span><span> </span><a href="#local-6989586621680755901"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755900"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span class="hs-identifier">tickyAllocdIsOn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-560"></a><a name="tickyAllocdIsOn"><a href="StgCmmTicky.html#tickyAllocdIsOn"><span class="hs-identifier">tickyAllocdIsOn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Ticky_Allocd</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span class="hs-identifier">tickyLNEIsOn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-563"></a><a name="tickyLNEIsOn"><a href="StgCmmTicky.html#tickyLNEIsOn"><span class="hs-identifier">tickyLNEIsOn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Ticky_LNE</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-identifier">tickyDynThunkIsOn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-566"></a><a name="tickyDynThunkIsOn"><a href="StgCmmTicky.html#tickyDynThunkIsOn"><span class="hs-identifier">tickyDynThunkIsOn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Ticky_Dyn_Thunk</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span class="hs-identifier">ifTickyAllocd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-569"></a><a name="ifTickyAllocd"><a href="StgCmmTicky.html#ifTickyAllocd"><span class="hs-identifier">ifTickyAllocd</span></a></a><span> </span><a name="local-6989586621680755902"><a href="#local-6989586621680755902"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#tickyAllocdIsOn"><span class="hs-identifier hs-var">tickyAllocdIsOn</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680755903"><a href="#local-6989586621680755903"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621680755903"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680755902"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span class="hs-identifier">ifTickyLNE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-572"></a><a name="ifTickyLNE"><a href="StgCmmTicky.html#ifTickyLNE"><span class="hs-identifier">ifTickyLNE</span></a></a><span> </span><a name="local-6989586621680755904"><a href="#local-6989586621680755904"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#tickyLNEIsOn"><span class="hs-identifier hs-var">tickyLNEIsOn</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680755905"><a href="#local-6989586621680755905"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621680755905"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680755904"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span class="hs-identifier">ifTickyDynThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-575"></a><a name="ifTickyDynThunk"><a href="StgCmmTicky.html#ifTickyDynThunk"><span class="hs-identifier">ifTickyDynThunk</span></a></a><span> </span><a name="local-6989586621680755906"><a href="#local-6989586621680755906"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#tickyDynThunkIsOn"><span class="hs-identifier hs-var">tickyDynThunkIsOn</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680755907"><a href="#local-6989586621680755907"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621680755907"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680755906"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-identifier">bumpTickyCounter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-578"></a><a name="bumpTickyCounter"><a href="StgCmmTicky.html#bumpTickyCounter"><span class="hs-identifier">bumpTickyCounter</span></a></a><span> </span><a name="local-6989586621680755908"><a href="#local-6989586621680755908"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLbl"><span class="hs-identifier hs-var">bumpTickyLbl</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><a href="#local-6989586621680755908"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">bumpTickyCounterBy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-581"></a><a name="bumpTickyCounterBy"><a href="StgCmmTicky.html#bumpTickyCounterBy"><span class="hs-identifier">bumpTickyCounterBy</span></a></a><span> </span><a name="local-6989586621680755909"><a href="#local-6989586621680755909"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLblBy"><span class="hs-identifier hs-var">bumpTickyLblBy</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><a href="#local-6989586621680755909"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-identifier">bumpTickyCounterByE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-584"></a><a name="bumpTickyCounterByE"><a href="StgCmmTicky.html#bumpTickyCounterByE"><span class="hs-identifier">bumpTickyCounterByE</span></a></a><span> </span><a name="local-6989586621680755910"><a href="#local-6989586621680755910"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLblByE"><span class="hs-identifier hs-var">bumpTickyLblByE</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><a href="#local-6989586621680755910"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-identifier">bumpTickyEntryCount</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><a name="bumpTickyEntryCount"><a href="StgCmmTicky.html#bumpTickyEntryCount"><span class="hs-identifier">bumpTickyEntryCount</span></a></a><span> </span><a name="local-6989586621680755911"><a href="#local-6989586621680755911"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-588"></a><span>  </span><a name="local-6989586621680755912"><a href="#local-6989586621680755912"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-589"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyLit"><span class="hs-identifier hs-var">bumpTickyLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755911"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgEntCounter_entry_count</span><span> </span><a href="#local-6989586621680755912"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span class="hs-identifier">bumpTickyAllocd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-592"></a><a name="bumpTickyAllocd"><a href="StgCmmTicky.html#bumpTickyAllocd"><span class="hs-identifier">bumpTickyAllocd</span></a></a><span> </span><a name="local-6989586621680755913"><a href="#local-6989586621680755913"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680755914"><a href="#local-6989586621680755914"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-593"></a><span>  </span><a name="local-6989586621680755915"><a href="#local-6989586621680755915"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-594"></a><span>  </span><a href="StgCmmTicky.html#bumpTickyLitBy"><span class="hs-identifier hs-var">bumpTickyLitBy</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755913"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgEntCounter_allocd</span><span> </span><a href="#local-6989586621680755915"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755914"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span class="hs-identifier">bumpTickyLbl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><a name="bumpTickyLbl"><a href="StgCmmTicky.html#bumpTickyLbl"><span class="hs-identifier">bumpTickyLbl</span></a></a><span> </span><a name="local-6989586621680755916"><a href="#local-6989586621680755916"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLitBy"><span class="hs-identifier hs-var">bumpTickyLitBy</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755916"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-identifier">bumpTickyLblBy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-600"></a><a name="bumpTickyLblBy"><a href="StgCmmTicky.html#bumpTickyLblBy"><span class="hs-identifier">bumpTickyLblBy</span></a></a><span> </span><a name="local-6989586621680755917"><a href="#local-6989586621680755917"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLitBy"><span class="hs-identifier hs-var">bumpTickyLitBy</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755917"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-identifier">bumpTickyLblByE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><a name="bumpTickyLblByE"><a href="StgCmmTicky.html#bumpTickyLblByE"><span class="hs-identifier">bumpTickyLblByE</span></a></a><span> </span><a name="local-6989586621680755918"><a href="#local-6989586621680755918"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLitByE"><span class="hs-identifier hs-var">bumpTickyLitByE</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmLabelOffB"><span class="hs-identifier hs-var">cmmLabelOffB</span></a><span> </span><a href="#local-6989586621680755918"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span class="hs-identifier">bumpTickyLit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><a name="bumpTickyLit"><a href="StgCmmTicky.html#bumpTickyLit"><span class="hs-identifier">bumpTickyLit</span></a></a><span> </span><a name="local-6989586621680755919"><a href="#local-6989586621680755919"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#bumpTickyLitBy"><span class="hs-identifier hs-var">bumpTickyLitBy</span></a><span> </span><a href="#local-6989586621680755919"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span class="hs-identifier">bumpTickyLitBy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-609"></a><a name="bumpTickyLitBy"><a href="StgCmmTicky.html#bumpTickyLitBy"><span class="hs-identifier">bumpTickyLitBy</span></a></a><span> </span><a name="local-6989586621680755920"><a href="#local-6989586621680755920"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621680755921"><a href="#local-6989586621680755921"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-610"></a><span>  </span><a name="local-6989586621680755922"><a href="#local-6989586621680755922"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-611"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmUtils.html#addToMem"><span class="hs-identifier hs-var">addToMem</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755922"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><a href="#local-6989586621680755920"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755921"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span class="hs-identifier">bumpTickyLitByE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><a name="bumpTickyLitByE"><a href="StgCmmTicky.html#bumpTickyLitByE"><span class="hs-identifier">bumpTickyLitByE</span></a></a><span> </span><a name="local-6989586621680755923"><a href="#local-6989586621680755923"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621680755924"><a href="#local-6989586621680755924"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-615"></a><span>  </span><a name="local-6989586621680755925"><a href="#local-6989586621680755925"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-616"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmUtils.html#addToMemE"><span class="hs-identifier hs-var">addToMemE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755925"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><a href="#local-6989586621680755923"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680755924"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span class="hs-identifier">bumpHistogram</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-619"></a><a name="bumpHistogram"><a href="StgCmmTicky.html#bumpHistogram"><span class="hs-identifier">bumpHistogram</span></a></a><span> </span><a name="local-6989586621680755926"><a href="#local-6989586621680755926"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680755927"><a href="#local-6989586621680755927"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-620"></a><span>    </span><a name="local-6989586621680755928"><a href="#local-6989586621680755928"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755929"><a href="#local-6989586621680755929"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680755927"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">min</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tICKY_BIN_COUNT</span><span> </span><a href="#local-6989586621680755928"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span>    </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmUtils.html#addToMem"><span class="hs-identifier hs-var">addToMem</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680755928"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>           </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmIndexExpr"><span class="hs-identifier hs-var">cmmIndexExpr</span></a><span> </span><a href="#local-6989586621680755928"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-624"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680755928"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-625"></a><span>                </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmDataLabel"><span class="hs-identifier hs-var">mkCmmDataLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><a href="#local-6989586621680755926"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>                </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621680755929"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680755928"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>           </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>
</span><a name="line-629"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-630"></a><span class="hs-comment">-- Showing the &quot;type category&quot; for ticky-ticky profiling</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-identifier">showTypeCategory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Char</span><span>
</span><a name="line-633"></a><span>  </span><span class="hs-comment">{-
        +           dictionary

        &gt;           function

        {C,I,F,D,W} char, int, float, double, word
        {c,i,f,d,w} unboxed ditto

        T           tuple

        P           other primitive type
        p           unboxed ditto

        L           list
        E           enumeration type
        S           other single-constructor type
        M           other multi-constructor data-con type

        .           other type

        -           reserved for others to mark as &quot;uninteresting&quot;

  Accurate as of Mar 2013, but I eliminated the Array category instead
  of updating it, for simplicity. It's in P/p, I think --NSF

    -}</span><span>
</span><a name="line-659"></a><a name="showTypeCategory"><a href="StgCmmTicky.html#showTypeCategory"><span class="hs-identifier">showTypeCategory</span></a></a><span> </span><a name="local-6989586621680755930"><a href="#local-6989586621680755930"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDictTy</span><span> </span><a href="#local-6989586621680755930"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'+'</span><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621680755930"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-662"></a><span>  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'.'</span><span>
</span><a name="line-663"></a><span>  </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680755931"><a href="#local-6989586621680755931"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-664"></a><span>    </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isUnliftedTyCon</span><span> </span><a href="#local-6989586621680755931"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Data.Char.toLower</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-665"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680755932"><a href="#local-6989586621680755932"><span class="hs-identifier">anyOf</span></a></a><span> </span><a name="local-6989586621680755933"><a href="#local-6989586621680755933"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621680755931"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680755933"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-667"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">funTyConKey</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'&gt;'</span><span>
</span><a name="line-668"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">charPrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">charTyConKey</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'C'</span><span>
</span><a name="line-669"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">doublePrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">doubleTyConKey</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'D'</span><span>
</span><a name="line-670"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">floatPrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">floatTyConKey</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'F'</span><span>
</span><a name="line-671"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">intPrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int32PrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int64PrimTyConKey</span><span class="hs-special">,</span><span>
</span><a name="line-672"></a><span>                 </span><span class="hs-identifier hs-var">intTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int8TyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int16TyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int32TyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int64TyConKey</span><span>
</span><a name="line-673"></a><span>                </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'I'</span><span>
</span><a name="line-674"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">wordPrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">word32PrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">word64PrimTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">wordTyConKey</span><span class="hs-special">,</span><span>
</span><a name="line-675"></a><span>                 </span><span class="hs-identifier hs-var">word8TyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">word16TyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">word32TyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">word64TyConKey</span><span>
</span><a name="line-676"></a><span>                </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'W'</span><span>
</span><a name="line-677"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680755932"><span class="hs-identifier hs-var">anyOf</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">listTyConKey</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'L'</span><span>
</span><a name="line-678"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTupleTyCon</span><span> </span><a href="#local-6989586621680755931"><span class="hs-identifier hs-var">tycon</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'T'</span><span>
</span><a name="line-679"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPrimTyCon</span><span> </span><a href="#local-6989586621680755931"><span class="hs-identifier hs-var">tycon</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'P'</span><span>
</span><a name="line-680"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEnumerationTyCon</span><span> </span><a href="#local-6989586621680755931"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'E'</span><span>
</span><a name="line-681"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConSingleDataCon_maybe</span><span> </span><a href="#local-6989586621680755931"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'S'</span><span>
</span><a name="line-682"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'M'</span><span> </span><span class="hs-comment">-- oh, well...</span><span>
</span><a name="line-683"></a></pre></body></html>