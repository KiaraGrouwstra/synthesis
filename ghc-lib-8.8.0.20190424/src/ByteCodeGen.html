<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, MagicHash, RecordWildCards, BangPatterns #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# OPTIONS_GHC -fprof-auto-top #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">--  (c) The University of Glasgow 2002-2006</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-comment">-- | ByteCodeGen: Generate bytecode from Core</span><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">ByteCodeGen</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">UnlinkedBCO</span><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#byteCodeGen"><span class="hs-identifier hs-var">byteCodeGen</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#coreExprToBCOs"><span class="hs-identifier hs-var">coreExprToBCOs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="ByteCodeInstr.html"><span class="hs-identifier">ByteCodeInstr</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="ByteCodeAsm.html"><span class="hs-identifier">ByteCodeAsm</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ByteCodeTypes</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.html"><span class="hs-identifier">GHCi</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.FFI</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ForeignCall</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PprCore</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Literal</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrimOp</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Kind</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isLiftedTypeKind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="Bitmap.html"><span class="hs-identifier">Bitmap</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IntMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IntMap</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IntMap</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">FiniteMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Stack.CCS</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Either</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- Generating byte code for a complete module</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-identifier">byteCodeGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-82"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-83"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>
</span><a name="line-84"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-85"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModBreaks</span><span>
</span><a name="line-86"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CompiledByteCode</span><span>
</span><a name="line-87"></a><a name="byteCodeGen"><a href="ByteCodeGen.html#byteCodeGen"><span class="hs-identifier">byteCodeGen</span></a></a><span> </span><a name="local-6989586621681117653"><a href="#local-6989586621681117653"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681117654"><a href="#local-6989586621681117654"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621681117655"><a href="#local-6989586621681117655"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621681117656"><a href="#local-6989586621681117656"><span class="hs-identifier">tycs</span></a></a><span> </span><a name="local-6989586621681117657"><a href="#local-6989586621681117657"><span class="hs-identifier">mb_modBreaks</span></a></a><span>
</span><a name="line-88"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621681117658"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ByteCodeGen&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681117654"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-comment">-- Split top-level binds into strings and others.</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-comment">-- See Note [generating code for top-level string literal bindings].</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117659"><a href="#local-6989586621681117659"><span class="hs-identifier">strings</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117660"><a href="#local-6989586621681117660"><span class="hs-identifier">flatBinds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-94"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621681117661"><a href="#local-6989586621681117661"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117662"><a href="#local-6989586621681117662"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">flattenBinds</span><span> </span><a href="#local-6989586621681117655"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-95"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">exprIsTickedString_maybe</span><span> </span><a href="#local-6989586621681117662"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-96"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117663"><a href="#local-6989586621681117663"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117661"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117663"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>                    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117661"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#simpleFreeVars"><span class="hs-identifier hs-var">simpleFreeVars</span></a><span> </span><a href="#local-6989586621681117662"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>        </span><a name="local-6989586621681117664"><a href="#local-6989586621681117664"><span class="hs-identifier">stringPtrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#allocateTopStrings"><span class="hs-identifier hs-var">allocateTopStrings</span></a><span> </span><a href="#local-6989586621681117653"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681117659"><span class="hs-identifier hs-var">strings</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>        </span><a name="local-6989586621681117665"><a href="#local-6989586621681117665"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'y'</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier hs-var">BcM_State</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681117674"><a href="#local-6989586621681117674"><span class="hs-identifier">proto_bcos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-102"></a><span>           </span><a href="ByteCodeGen.html#runBc"><span class="hs-identifier hs-var">runBc</span></a><span> </span><a href="#local-6989586621681117653"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681117665"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621681117654"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681117657"><span class="hs-identifier hs-var">mb_modBreaks</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarEnv</span><span> </span><a href="#local-6989586621681117664"><span class="hs-identifier hs-var">stringPtrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-103"></a><span>             </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="ByteCodeGen.html#schemeTopBind"><span class="hs-identifier hs-var">schemeTopBind</span></a><span> </span><a href="#local-6989586621681117660"><span class="hs-identifier hs-var">flatBinds</span></a><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621681117670"><span class="hs-identifier hs-var">ffis</span></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.byteCodeGen: missing final emitBc?&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621681117658"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_BCOs</span><span>
</span><a name="line-109"></a><span>           </span><span class="hs-string">&quot;Proto-BCOs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intersperse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681117674"><span class="hs-identifier hs-var">proto_bcos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>        </span><a name="local-6989586621681117676"><a href="#local-6989586621681117676"><span class="hs-identifier">cbc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeAsm.html#assembleBCOs"><span class="hs-identifier hs-var">assembleBCOs</span></a><span> </span><a href="#local-6989586621681117653"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681117674"><span class="hs-identifier hs-var">proto_bcos</span></a><span> </span><a href="#local-6989586621681117656"><span class="hs-identifier hs-var">tycs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621681117664"><span class="hs-identifier hs-var">stringPtrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>          </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681117671"><span class="hs-identifier hs-var">modBreaks</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-113"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-114"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117675"><a href="#local-6989586621681117675"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681117675"><span class="hs-identifier hs-var">mb</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">modBreaks_breakInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117672"><span class="hs-identifier hs-var">breakInfo</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>        </span><span class="hs-comment">-- Squash space leaks in the CompiledByteCode.  This is really</span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-comment">-- important, because when loading a set of modules into GHCi</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-comment">-- we don't touch the CompiledByteCode until the end when we</span><span>
</span><a name="line-119"></a><span>        </span><span class="hs-comment">-- do linking.  Forcing out the thunks here reduces space</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-comment">-- usage by more than 50% when loading a large number of</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-comment">-- modules.</span><span>
</span><a name="line-122"></a><span>        </span><span class="hs-identifier hs-var">evaluate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">seqCompiledByteCode</span><span> </span><a href="#local-6989586621681117676"><span class="hs-identifier hs-var">cbc</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681117676"><span class="hs-identifier hs-var">cbc</span></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681117658"><a href="#local-6989586621681117658"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681117653"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">allocateTopStrings</span><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-131"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-132"></a><a name="allocateTopStrings"><a href="ByteCodeGen.html#allocateTopStrings"><span class="hs-identifier">allocateTopStrings</span></a></a><span> </span><a name="local-6989586621681117677"><a href="#local-6989586621681117677"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681117678"><a href="#local-6989586621681117678"><span class="hs-identifier">topStrings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-133"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a name="local-6989586621681117679"><a href="#local-6989586621681117679"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117680"><a href="#local-6989586621681117680"><span class="hs-identifier">strings</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681117678"><span class="hs-identifier hs-var">topStrings</span></a><span>
</span><a name="line-134"></a><span>  </span><a name="local-6989586621681117681"><a href="#local-6989586621681117681"><span class="hs-identifier">ptrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621681117677"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">MallocStrings</span><span> </span><a href="#local-6989586621681117680"><span class="hs-identifier hs-var">strings</span></a><span>
</span><a name="line-135"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621681117679"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621681117681"><span class="hs-identifier hs-var">ptrs</span></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">{-
Note [generating code for top-level string literal bindings]

Here is a summary on how the byte code generator deals with top-level string
literals:

1. Top-level string literal bindings are separated from the rest of the module.

2. The strings are allocated via iservCmd, in allocateTopStrings

3. The mapping from binders to allocated strings (topStrings) are maintained in
   BcM and used when generating code for variable references.
-}</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- Generating byte code for an expression</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- Returns: the root BCO for this expression</span><span>
</span><a name="line-155"></a><span class="hs-identifier">coreExprToBCOs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-156"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-157"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-158"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">UnlinkedBCO</span><span>
</span><a name="line-159"></a><a name="coreExprToBCOs"><a href="ByteCodeGen.html#coreExprToBCOs"><span class="hs-identifier">coreExprToBCOs</span></a></a><span> </span><a name="local-6989586621681117682"><a href="#local-6989586621681117682"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681117683"><a href="#local-6989586621681117683"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621681117684"><a href="#local-6989586621681117684"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-160"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621681117685"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ByteCodeGen&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681117683"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-163"></a><span>      </span><span class="hs-comment">-- create a totally bogus name for the top-level BCO; this</span><span>
</span><a name="line-164"></a><span>      </span><span class="hs-comment">-- should be harmless, since it's never used for anything</span><span>
</span><a name="line-165"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117686"><a href="#local-6989586621681117686"><span class="hs-identifier">invented_name</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSystemVarName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPseudoUniqueE</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ExprTopLevel&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>          </span><a name="local-6989586621681117687"><a href="#local-6989586621681117687"><span class="hs-identifier">invented_id</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Id.mkLocalId</span><span> </span><a href="#local-6989586621681117686"><span class="hs-identifier hs-var">invented_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;invented_id's type&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span>      </span><span class="hs-comment">-- the uniques are needed to generate fresh variables when we introduce new</span><span>
</span><a name="line-169"></a><span>      </span><span class="hs-comment">-- let bindings for ticked expressions</span><span>
</span><a name="line-170"></a><span>      </span><a name="local-6989586621681117688"><a href="#local-6989586621681117688"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'y'</span><span>
</span><a name="line-171"></a><span>      </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier hs-var">BcM_State</span></a><span> </span><a name="local-6989586621681117689"><a href="#local-6989586621681117689"><span class="hs-identifier">_dflags</span></a></a><span> </span><a name="local-6989586621681117690"><a href="#local-6989586621681117690"><span class="hs-identifier">_us</span></a></a><span> </span><a name="local-6989586621681117691"><a href="#local-6989586621681117691"><span class="hs-identifier">_this_mod</span></a></a><span> </span><a name="local-6989586621681117692"><a href="#local-6989586621681117692"><span class="hs-identifier">_final_ctr</span></a></a><span> </span><a name="local-6989586621681117693"><a href="#local-6989586621681117693"><span class="hs-identifier">mallocd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681117694"><a href="#local-6989586621681117694"><span class="hs-identifier">proto_bco</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#runBc"><span class="hs-identifier hs-var">runBc</span></a><span> </span><a href="#local-6989586621681117682"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681117688"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621681117683"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-173"></a><span>              </span><a href="ByteCodeGen.html#schemeTopBind"><span class="hs-identifier hs-var">schemeTopBind</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117687"><span class="hs-identifier hs-var">invented_id</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#simpleFreeVars"><span class="hs-identifier hs-var">simpleFreeVars</span></a><span> </span><a href="#local-6989586621681117684"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621681117693"><span class="hs-identifier hs-var">mallocd</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.coreExprToBCOs: missing final emitBc?&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>      </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621681117685"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_BCOs</span><span> </span><span class="hs-string">&quot;Proto-BCOs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681117694"><span class="hs-identifier hs-var">proto_bco</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>      </span><a href="ByteCodeAsm.html#assembleOneBCO"><span class="hs-identifier hs-var">assembleOneBCO</span></a><span> </span><a href="#local-6989586621681117682"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681117694"><span class="hs-identifier hs-var">proto_bco</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681117685"><a href="#local-6989586621681117685"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681117682"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">-- The regular freeVars function gives more information than is useful to</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- us here. simpleFreeVars does the impedance matching.</span><span>
</span><a name="line-185"></a><span class="hs-identifier">simpleFreeVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-186"></a><a name="simpleFreeVars"><a href="ByteCodeGen.html#simpleFreeVars"><span class="hs-identifier">simpleFreeVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">freeVars</span><span>
</span><a name="line-187"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">FVAnn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-189"></a><span>    </span><a name="local-6989586621681117695"><a href="#local-6989586621681117695"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117699"><a href="#local-6989586621681117699"><span class="hs-identifier">ann</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117700"><a href="#local-6989586621681117700"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">freeVarsOfAnn</span><span> </span><a href="#local-6989586621681117699"><span class="hs-identifier hs-var">ann</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117696"><span class="hs-identifier hs-var">go'</span></a><span> </span><a href="#local-6989586621681117700"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">FVAnn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621681117696"><a href="#local-6989586621681117696"><span class="hs-identifier">go'</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681117701"><a href="#local-6989586621681117701"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a href="#local-6989586621681117701"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLit</span><span> </span><a name="local-6989586621681117702"><a href="#local-6989586621681117702"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnLit</span><span> </span><a href="#local-6989586621681117702"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLam</span><span> </span><a name="local-6989586621681117703"><a href="#local-6989586621681117703"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681117704"><a href="#local-6989586621681117704"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnLam</span><span> </span><a href="#local-6989586621681117703"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117704"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnApp</span><span> </span><a name="local-6989586621681117705"><a href="#local-6989586621681117705"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621681117706"><a href="#local-6989586621681117706"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117705"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117706"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><a name="local-6989586621681117707"><a href="#local-6989586621681117707"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621681117708"><a href="#local-6989586621681117708"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681117709"><a href="#local-6989586621681117709"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681117710"><a href="#local-6989586621681117710"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnCase</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117707"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117708"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681117709"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681117697"><span class="hs-identifier hs-var">go_alt</span></a><span> </span><a href="#local-6989586621681117710"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLet</span><span> </span><a name="local-6989586621681117711"><a href="#local-6989586621681117711"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621681117712"><a href="#local-6989586621681117712"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnLet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117698"><span class="hs-identifier hs-var">go_bind</span></a><span> </span><a href="#local-6989586621681117711"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117712"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCast</span><span> </span><a name="local-6989586621681117713"><a href="#local-6989586621681117713"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117714"><a href="#local-6989586621681117714"><span class="hs-identifier">ann</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117715"><a href="#local-6989586621681117715"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnCast</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117713"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">freeVarsOfAnn</span><span> </span><a href="#local-6989586621681117714"><span class="hs-identifier hs-var">ann</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117715"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnTick</span><span> </span><a name="local-6989586621681117716"><a href="#local-6989586621681117716"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621681117717"><a href="#local-6989586621681117717"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnTick</span><span> </span><a href="#local-6989586621681117716"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117717"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnType</span><span> </span><a name="local-6989586621681117718"><a href="#local-6989586621681117718"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnType</span><span> </span><a href="#local-6989586621681117718"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-201"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCoercion</span><span> </span><a name="local-6989586621681117719"><a href="#local-6989586621681117719"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnCoercion</span><span> </span><a href="#local-6989586621681117719"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>    </span><a name="local-6989586621681117697"><a href="#local-6989586621681117697"><span class="hs-identifier">go_alt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117720"><a href="#local-6989586621681117720"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117721"><a href="#local-6989586621681117721"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117722"><a href="#local-6989586621681117722"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117720"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117721"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117722"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>    </span><a name="local-6989586621681117698"><a href="#local-6989586621681117698"><span class="hs-identifier">go_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a name="local-6989586621681117723"><a href="#local-6989586621681117723"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681117724"><a href="#local-6989586621681117724"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a href="#local-6989586621681117723"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117724"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-identifier">go_bind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnRec</span><span> </span><a name="local-6989586621681117725"><a href="#local-6989586621681117725"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnRec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">second</span><span> </span><a href="#local-6989586621681117695"><span class="hs-identifier hs-var">go</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117725"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- Compilation schema for the bytecode generator</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-keyword">type</span><span> </span><a name="BCInstrList"><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier">BCInstrList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="ByteCodeInstr.html#BCInstr"><span class="hs-identifier hs-type">BCInstr</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-keyword">newtype</span><span> </span><a name="ByteOff"><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier">ByteOff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ByteOff"><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier">ByteOff</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Integral</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Real</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-keyword">newtype</span><span> </span><a name="WordOff"><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier">WordOff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WordOff"><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier">WordOff</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Integral</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Real</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-identifier">wordsToBytes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-220"></a><a name="wordsToBytes"><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier">wordsToBytes</span></a></a><span> </span><a name="local-6989586621681117726"><a href="#local-6989586621681117726"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681117726"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">-- Used when we know we have a whole number of words</span><span>
</span><a name="line-223"></a><span class="hs-identifier">bytesToWords</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-224"></a><a name="bytesToWords"><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier">bytesToWords</span></a></a><span> </span><a name="local-6989586621681117727"><a href="#local-6989586621681117727"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-var">ByteOff</span></a><span> </span><a name="local-6989586621681117728"><a href="#local-6989586621681117728"><span class="hs-identifier">bytes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117729"><a href="#local-6989586621681117729"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117730"><a href="#local-6989586621681117730"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117728"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681117727"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681117730"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-227"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681117729"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-228"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;ByteCodeGen.bytesToWords: bytes=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681117728"><span class="hs-identifier hs-var">bytes</span></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-identifier">wordSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-231"></a><a name="wordSize"><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier">wordSize</span></a></a><span> </span><a name="local-6989586621681117731"><a href="#local-6989586621681117731"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-var">ByteOff</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681117731"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-keyword">type</span><span> </span><a name="Sequel"><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier">Sequel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-comment">-- back off to this depth before ENTER</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-keyword">type</span><span> </span><a name="StackDepth"><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier">StackDepth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-comment">-- | Maps Ids to their stack depth. This allows us to avoid having to mess with</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- it after each push/pop.</span><span>
</span><a name="line-239"></a><span class="hs-keyword">type</span><span> </span><a name="BCEnv"><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier">BCEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-comment">-- To find vars on the stack</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-comment">{-
ppBCEnv :: BCEnv -&gt; SDoc
ppBCEnv p
   = text &quot;begin-env&quot;
     $$ nest 4 (vcat (map pp_one (sortBy cmp_snd (Map.toList p))))
     $$ text &quot;end-env&quot;
     where
        pp_one (var, offset) = int offset &lt;&gt; colon &lt;+&gt; ppr var &lt;+&gt; ppr (bcIdArgRep var)
        cmp_snd x y = compare (snd x) (snd y)
-}</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">-- Create a BCO and do a spot of peephole optimisation on the insns</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- at the same time.</span><span>
</span><a name="line-254"></a><span class="hs-identifier">mkProtoBCO</span><span>
</span><a name="line-255"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-256"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681117652"><span class="hs-identifier hs-type">name</span></a><span>
</span><a name="line-257"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-258"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnAlt</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-260"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-261"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="SMRep.html#StgWord"><span class="hs-identifier hs-type">StgWord</span></a><span class="hs-special">]</span><span>
</span><a name="line-262"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; is a return point, rather than a function</span><span>
</span><a name="line-263"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FFIInfo</span><span class="hs-special">]</span><span>
</span><a name="line-264"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><a href="#local-6989586621681117652"><span class="hs-identifier hs-type">name</span></a><span>
</span><a name="line-265"></a><a name="mkProtoBCO"><a href="ByteCodeGen.html#mkProtoBCO"><span class="hs-identifier">mkProtoBCO</span></a></a><span> </span><a name="local-6989586621681117732"><a href="#local-6989586621681117732"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681117733"><a href="#local-6989586621681117733"><span class="hs-identifier">nm</span></a></a><span> </span><a name="local-6989586621681117734"><a href="#local-6989586621681117734"><span class="hs-identifier">instrs_ordlist</span></a></a><span> </span><a name="local-6989586621681117735"><a href="#local-6989586621681117735"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-6989586621681117736"><a href="#local-6989586621681117736"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621681117737"><a href="#local-6989586621681117737"><span class="hs-identifier">bitmap_size</span></a></a><span> </span><a name="local-6989586621681117738"><a href="#local-6989586621681117738"><span class="hs-identifier">bitmap</span></a></a><span> </span><a name="local-6989586621681117739"><a href="#local-6989586621681117739"><span class="hs-identifier">is_ret</span></a></a><span> </span><a name="local-6989586621681117740"><a href="#local-6989586621681117740"><span class="hs-identifier">ffis</span></a></a><span>
</span><a name="line-266"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-var">ProtoBCO</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-identifier">protoBCOName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117733"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">,</span><span>
</span><a name="line-268"></a><span>        </span><span class="hs-identifier">protoBCOInstrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117741"><span class="hs-identifier hs-var">maybe_with_stack_check</span></a><span class="hs-special">,</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-identifier">protoBCOBitmap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117738"><span class="hs-identifier hs-var">bitmap</span></a><span class="hs-special">,</span><span>
</span><a name="line-270"></a><span>        </span><span class="hs-identifier">protoBCOBitmapSize</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117737"><span class="hs-identifier hs-var">bitmap_size</span></a><span class="hs-special">,</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-identifier">protoBCOArity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117736"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>        </span><span class="hs-identifier">protoBCOExpr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117735"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>        </span><span class="hs-identifier">protoBCOFFIs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117740"><span class="hs-identifier hs-var">ffis</span></a><span>
</span><a name="line-274"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-275"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-comment">-- Overestimate the stack usage (in words) of this BCO,</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-comment">-- and if &gt;= iNTERP_STACK_CHECK_THRESH, add an explicit</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-comment">-- stack check.  (The interpreter always does a stack check</span><span>
</span><a name="line-279"></a><span>        </span><span class="hs-comment">-- for iNTERP_STACK_CHECK_THRESH words at the start of each</span><span>
</span><a name="line-280"></a><span>        </span><span class="hs-comment">-- BCO anyway, so we only need to add an explicit one in the</span><span>
</span><a name="line-281"></a><span>        </span><span class="hs-comment">-- (hopefully rare) cases when the (overestimated) stack use</span><span>
</span><a name="line-282"></a><span>        </span><span class="hs-comment">-- exceeds iNTERP_STACK_CHECK_THRESH.</span><span>
</span><a name="line-283"></a><span>        </span><a name="local-6989586621681117741"><a href="#local-6989586621681117741"><span class="hs-identifier">maybe_with_stack_check</span></a></a><span>
</span><a name="line-284"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681117739"><span class="hs-identifier hs-var">is_ret</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681117742"><span class="hs-identifier hs-var">stack_usage</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">aP_STACK_SPLIM</span><span> </span><a href="#local-6989586621681117732"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117743"><span class="hs-identifier hs-var">peep_d</span></a><span>
</span><a name="line-285"></a><span>                </span><span class="hs-comment">-- don't do stack checks at return points,</span><span>
</span><a name="line-286"></a><span>                </span><span class="hs-comment">-- everything is aggregated up to the top BCO</span><span>
</span><a name="line-287"></a><span>                </span><span class="hs-comment">-- (which must be a function).</span><span>
</span><a name="line-288"></a><span>                </span><span class="hs-comment">-- That is, unless the stack usage is &gt;= AP_STACK_SPLIM,</span><span>
</span><a name="line-289"></a><span>                </span><span class="hs-comment">-- see bug #1466.</span><span>
</span><a name="line-290"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681117742"><span class="hs-identifier hs-var">stack_usage</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="ByteCodeAsm.html#iNTERP_STACK_CHECK_THRESH"><span class="hs-identifier hs-var">iNTERP_STACK_CHECK_THRESH</span></a><span>
</span><a name="line-291"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#STKCHECK"><span class="hs-identifier hs-var">STKCHECK</span></a><span> </span><a href="#local-6989586621681117742"><span class="hs-identifier hs-var">stack_usage</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681117743"><span class="hs-identifier hs-var">peep_d</span></a><span>
</span><a name="line-292"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-293"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117743"><span class="hs-identifier hs-var">peep_d</span></a><span>     </span><span class="hs-comment">-- the supposedly common case</span><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span>        </span><span class="hs-comment">-- We assume that this sum doesn't wrap</span><span>
</span><a name="line-296"></a><span>        </span><a name="local-6989586621681117742"><a href="#local-6989586621681117742"><span class="hs-identifier">stack_usage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="ByteCodeInstr.html#bciStackUse"><span class="hs-identifier hs-var">bciStackUse</span></a><span> </span><a href="#local-6989586621681117743"><span class="hs-identifier hs-var">peep_d</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>        </span><span class="hs-comment">-- Merge local pushes</span><span>
</span><a name="line-299"></a><span>        </span><a name="local-6989586621681117743"><a href="#local-6989586621681117743"><span class="hs-identifier">peep_d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117744"><span class="hs-identifier hs-var">peep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621681117734"><span class="hs-identifier hs-var">instrs_ordlist</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>        </span><a name="local-6989586621681117744"><a href="#local-6989586621681117744"><span class="hs-identifier">peep</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_L"><span class="hs-identifier hs-var">PUSH_L</span></a><span> </span><a name="local-6989586621681117745"><a href="#local-6989586621681117745"><span class="hs-identifier">off1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="ByteCodeInstr.html#PUSH_L"><span class="hs-identifier hs-var">PUSH_L</span></a><span> </span><a name="local-6989586621681117746"><a href="#local-6989586621681117746"><span class="hs-identifier">off2</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="ByteCodeInstr.html#PUSH_L"><span class="hs-identifier hs-var">PUSH_L</span></a><span> </span><a name="local-6989586621681117747"><a href="#local-6989586621681117747"><span class="hs-identifier">off3</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681117748"><a href="#local-6989586621681117748"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#PUSH_LLL"><span class="hs-identifier hs-var">PUSH_LLL</span></a><span> </span><a href="#local-6989586621681117745"><span class="hs-identifier hs-var">off1</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117746"><span class="hs-identifier hs-var">off2</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117747"><span class="hs-identifier hs-var">off3</span></a><span class="hs-glyph">-</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681117744"><span class="hs-identifier hs-var">peep</span></a><span> </span><a href="#local-6989586621681117748"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-303"></a><span>        </span><span class="hs-identifier">peep</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_L"><span class="hs-identifier hs-var">PUSH_L</span></a><span> </span><a name="local-6989586621681117749"><a href="#local-6989586621681117749"><span class="hs-identifier">off1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="ByteCodeInstr.html#PUSH_L"><span class="hs-identifier hs-var">PUSH_L</span></a><span> </span><a name="local-6989586621681117750"><a href="#local-6989586621681117750"><span class="hs-identifier">off2</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681117751"><a href="#local-6989586621681117751"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#PUSH_LL"><span class="hs-identifier hs-var">PUSH_LL</span></a><span> </span><a href="#local-6989586621681117749"><span class="hs-identifier hs-var">off1</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117750"><span class="hs-identifier hs-var">off2</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681117744"><span class="hs-identifier hs-var">peep</span></a><span> </span><a href="#local-6989586621681117751"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-305"></a><span>        </span><span class="hs-identifier">peep</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117752"><a href="#local-6989586621681117752"><span class="hs-identifier">i</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681117753"><a href="#local-6989586621681117753"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117752"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681117744"><span class="hs-identifier hs-var">peep</span></a><span> </span><a href="#local-6989586621681117753"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-307"></a><span>        </span><span class="hs-identifier">peep</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-308"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-identifier">argBits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-311"></a><a name="argBits"><a href="ByteCodeGen.html#argBits"><span class="hs-identifier">argBits</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-312"></a><span class="hs-identifier">argBits</span><span> </span><a name="local-6989586621681117754"><a href="#local-6989586621681117754"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117755"><a href="#local-6989586621681117755"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681117756"><a href="#local-6989586621681117756"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="ByteCodeGen.html#isFollowableArg"><span class="hs-identifier hs-var">isFollowableArg</span></a><span> </span><a href="#local-6989586621681117755"><span class="hs-identifier hs-var">rep</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="ByteCodeGen.html#argBits"><span class="hs-identifier hs-var">argBits</span></a><span> </span><a href="#local-6989586621681117754"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117756"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-314"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#argRepSizeW"><span class="hs-identifier hs-var">argRepSizeW</span></a><span> </span><a href="#local-6989586621681117754"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117755"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="ByteCodeGen.html#argBits"><span class="hs-identifier hs-var">argBits</span></a><span> </span><a href="#local-6989586621681117754"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117756"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- schemeTopBind</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- Compile code for the right-hand side of a top-level binding</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">schemeTopBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-322"></a><a name="schemeTopBind"><a href="ByteCodeGen.html#schemeTopBind"><span class="hs-identifier">schemeTopBind</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117757"><a href="#local-6989586621681117757"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117758"><a href="#local-6989586621681117758"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117759"><a href="#local-6989586621681117759"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId_maybe</span><span> </span><a href="#local-6989586621681117757"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span>
</span><a name="line-324"></a><span>    </span><span class="hs-identifier hs-var">isNullaryRepDataCon</span><span> </span><a href="#local-6989586621681117759"><span class="hs-identifier hs-var">data_con</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-325"></a><span>    </span><a name="local-6989586621681117760"><a href="#local-6989586621681117760"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-326"></a><span>        </span><span class="hs-comment">-- Special case for the worker of a nullary data con.</span><span>
</span><a name="line-327"></a><span>        </span><span class="hs-comment">-- It'll look like this:        Nil = /\a -&gt; Nil a</span><span>
</span><a name="line-328"></a><span>        </span><span class="hs-comment">-- If we feed it into schemeR, we'll get</span><span>
</span><a name="line-329"></a><span>        </span><span class="hs-comment">--      Nil = Nil</span><span>
</span><a name="line-330"></a><span>        </span><span class="hs-comment">-- because mkConAppCode treats nullary constructor applications</span><span>
</span><a name="line-331"></a><span>        </span><span class="hs-comment">-- by just re-using the single top-level definition.  So</span><span>
</span><a name="line-332"></a><span>        </span><span class="hs-comment">-- for the worker itself, we must allocate it directly.</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-comment">-- ioToBc (putStrLn $ &quot;top level BCO&quot;)</span><span>
</span><a name="line-334"></a><span>    </span><a href="ByteCodeGen.html#emitBc"><span class="hs-identifier hs-var">emitBc</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#mkProtoBCO"><span class="hs-identifier hs-var">mkProtoBCO</span></a><span> </span><a href="#local-6989586621681117760"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621681117757"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">[</span><a href="ByteCodeInstr.html#PACK"><span class="hs-identifier hs-var">PACK</span></a><span> </span><a href="#local-6989586621681117759"><span class="hs-identifier hs-var">data_con</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="ByteCodeInstr.html#ENTER"><span class="hs-identifier hs-var">ENTER</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621681117758"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-comment">{-no bitmap-}</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-comment">{-not alts-}</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-338"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeR"><span class="hs-identifier hs-var">schemeR</span></a><span> </span><span class="hs-special">[</span><span class="hs-comment">{- No free variables -}</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117757"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117758"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- schemeR</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-comment">-- Compile code for a right-hand side, to give a BCO that,</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- when executed with the free variables and arguments on top of the stack,</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- will return with a pointer to the result on top of the stack, after</span><span>
</span><a name="line-347"></a><span class="hs-comment">-- removing the free variables and arguments.</span><span>
</span><a name="line-348"></a><span class="hs-comment">--</span><span>
</span><a name="line-349"></a><span class="hs-comment">-- Park the resulting BCO in the monad.  Also requires the</span><span>
</span><a name="line-350"></a><span class="hs-comment">-- variable to which this value was bound, so as to give the</span><span>
</span><a name="line-351"></a><span class="hs-comment">-- resulting BCO a name.</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">schemeR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Free vars of the RHS, ordered as they</span><span>
</span><a name="line-354"></a><span>                                </span><span class="hs-comment">-- will appear in the thunk.  Empty for</span><span>
</span><a name="line-355"></a><span>                                </span><span class="hs-comment">-- top-level things, which have no free vars.</span><span>
</span><a name="line-356"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-358"></a><a name="schemeR"><a href="ByteCodeGen.html#schemeR"><span class="hs-identifier">schemeR</span></a></a><span> </span><a name="local-6989586621681117761"><a href="#local-6989586621681117761"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117762"><a href="#local-6989586621681117762"><span class="hs-identifier">nm</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117763"><a href="#local-6989586621681117763"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span class="hs-comment">{-
   | trace (showSDoc (
              (char ' '
               $$ (ppr.filter (not.isTyVar).dVarSetElems.fst) rhs
               $$ pprCoreExpr (deAnnotate rhs)
               $$ char ' '
              ))) False
   = undefined
   | otherwise
-}</span><span>
</span><a name="line-369"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeR_wrk"><span class="hs-identifier hs-var">schemeR_wrk</span></a><span> </span><a href="#local-6989586621681117761"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621681117762"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621681117763"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#collect"><span class="hs-identifier hs-var">collect</span></a><span> </span><a href="#local-6989586621681117763"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-identifier">collect</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><a name="collect"><a href="ByteCodeGen.html#collect"><span class="hs-identifier">collect</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681117764"><a href="#local-6989586621681117764"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117765"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681117764"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-373"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-374"></a><span>    </span><a name="local-6989586621681117765"><a href="#local-6989586621681117765"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681117766"><a href="#local-6989586621681117766"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621681117767"><a href="#local-6989586621681117767"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117768"><a href="#local-6989586621681117768"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#bcView"><span class="hs-identifier hs-var">bcView</span></a><span> </span><a href="#local-6989586621681117767"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117765"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681117766"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621681117768"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-375"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621681117769"><a href="#local-6989586621681117769"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLam</span><span> </span><a name="local-6989586621681117770"><a href="#local-6989586621681117770"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681117771"><a href="#local-6989586621681117771"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117770"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-377"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#multiValException"><span class="hs-identifier hs-var">multiValException</span></a><span>
</span><a name="line-378"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-379"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117765"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117770"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681117769"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117771"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-380"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621681117772"><a href="#local-6989586621681117772"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621681117773"><a href="#local-6989586621681117773"><span class="hs-identifier">not_lambda</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621681117772"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117773"><span class="hs-identifier hs-var">not_lambda</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span class="hs-identifier">schemeR_wrk</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-384"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-385"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-386"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><a name="schemeR_wrk"><a href="ByteCodeGen.html#schemeR_wrk"><span class="hs-identifier">schemeR_wrk</span></a></a><span> </span><a name="local-6989586621681117774"><a href="#local-6989586621681117774"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681117775"><a href="#local-6989586621681117775"><span class="hs-identifier">nm</span></a></a><span> </span><a name="local-6989586621681117776"><a href="#local-6989586621681117776"><span class="hs-identifier">original_body</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117777"><a href="#local-6989586621681117777"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117778"><a href="#local-6989586621681117778"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-390"></a><span>     </span><a name="local-6989586621681117779"><a href="#local-6989586621681117779"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-391"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-392"></a><span>         </span><a name="local-6989586621681117780"><a href="#local-6989586621681117780"><span class="hs-identifier">all_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621681117777"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681117774"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-393"></a><span>         </span><a name="local-6989586621681117781"><a href="#local-6989586621681117781"><span class="hs-identifier">arity</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681117780"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-394"></a><span>         </span><span class="hs-comment">-- all_args are the args in reverse order.  We're compiling a function</span><span>
</span><a name="line-395"></a><span>         </span><span class="hs-comment">-- \fv1..fvn x1..xn -&gt; e</span><span>
</span><a name="line-396"></a><span>         </span><span class="hs-comment">-- i.e. the fvs come first</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>         </span><span class="hs-comment">-- Stack arguments always take a whole number of words, we never pack</span><span>
</span><a name="line-399"></a><span>         </span><span class="hs-comment">-- them unlike constructor fields.</span><span>
</span><a name="line-400"></a><span>         </span><a name="local-6989586621681117782"><a href="#local-6989586621681117782"><span class="hs-identifier">szsb_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681117779"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeGen.html#idSizeW"><span class="hs-identifier hs-var">idSizeW</span></a><span> </span><a href="#local-6989586621681117779"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117780"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-401"></a><span>         </span><a name="local-6989586621681117783"><a href="#local-6989586621681117783"><span class="hs-identifier">sum_szsb_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><a href="#local-6989586621681117782"><span class="hs-identifier hs-var">szsb_args</span></a><span>
</span><a name="line-402"></a><span>         </span><a name="local-6989586621681117784"><a href="#local-6989586621681117784"><span class="hs-identifier">p_init</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621681117780"><span class="hs-identifier hs-var">all_args</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#mkStackOffsets"><span class="hs-identifier hs-var">mkStackOffsets</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681117782"><span class="hs-identifier hs-var">szsb_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span>         </span><span class="hs-comment">-- make the arg bitmap</span><span>
</span><a name="line-405"></a><span>         </span><a name="local-6989586621681117785"><a href="#local-6989586621681117785"><span class="hs-identifier">bits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#argBits"><span class="hs-identifier hs-var">argBits</span></a><span> </span><a href="#local-6989586621681117779"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="ByteCodeGen.html#bcIdArgRep"><span class="hs-identifier hs-var">bcIdArgRep</span></a><span> </span><a href="#local-6989586621681117780"><span class="hs-identifier hs-var">all_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>         </span><a name="local-6989586621681117786"><a href="#local-6989586621681117786"><span class="hs-identifier">bitmap_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">genericLength</span><span> </span><a href="#local-6989586621681117785"><span class="hs-identifier hs-var">bits</span></a><span>
</span><a name="line-407"></a><span>         </span><a name="local-6989586621681117787"><a href="#local-6989586621681117787"><span class="hs-identifier">bitmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bitmap.html#mkBitmap"><span class="hs-identifier hs-var">mkBitmap</span></a><span> </span><a href="#local-6989586621681117779"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117785"><span class="hs-identifier hs-var">bits</span></a><span>
</span><a name="line-408"></a><span>     </span><a name="local-6989586621681117788"><a href="#local-6989586621681117788"><span class="hs-identifier">body_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeER_wrk"><span class="hs-identifier hs-var">schemeER_wrk</span></a><span> </span><a href="#local-6989586621681117783"><span class="hs-identifier hs-var">sum_szsb_args</span></a><span> </span><a href="#local-6989586621681117784"><span class="hs-identifier hs-var">p_init</span></a><span> </span><a href="#local-6989586621681117778"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span>     </span><a href="ByteCodeGen.html#emitBc"><span class="hs-identifier hs-var">emitBc</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#mkProtoBCO"><span class="hs-identifier hs-var">mkProtoBCO</span></a><span> </span><a href="#local-6989586621681117779"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621681117775"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117788"><span class="hs-identifier hs-var">body_code</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621681117776"><span class="hs-identifier hs-var">original_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>                 </span><a href="#local-6989586621681117781"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621681117786"><span class="hs-identifier hs-var">bitmap_size</span></a><span> </span><a href="#local-6989586621681117787"><span class="hs-identifier hs-var">bitmap</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-comment">{-not alts-}</span><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-comment">-- introduce break instructions for ticked expressions</span><span>
</span><a name="line-414"></a><span class="hs-identifier">schemeER_wrk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-415"></a><a name="schemeER_wrk"><a href="ByteCodeGen.html#schemeER_wrk"><span class="hs-identifier">schemeER_wrk</span></a></a><span> </span><a name="local-6989586621681117789"><a href="#local-6989586621681117789"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117790"><a href="#local-6989586621681117790"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117791"><a href="#local-6989586621681117791"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-416"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AnnTick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Breakpoint</span><span> </span><a name="local-6989586621681117792"><a href="#local-6989586621681117792"><span class="hs-identifier">tick_no</span></a></a><span> </span><a name="local-6989586621681117793"><a href="#local-6989586621681117793"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117794"><a href="#local-6989586621681117794"><span class="hs-identifier">_annot</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117795"><a href="#local-6989586621681117795"><span class="hs-identifier">newRhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681117791"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-417"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><a name="local-6989586621681117796"><a href="#local-6989586621681117796"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117789"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681117790"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117795"><span class="hs-identifier hs-var">newRhs</span></a><span>
</span><a name="line-418"></a><span>        </span><a name="local-6989586621681117797"><a href="#local-6989586621681117797"><span class="hs-identifier">cc_arr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getCCArray"><span class="hs-identifier hs-var">getCCArray</span></a><span>
</span><a name="line-419"></a><span>        </span><a name="local-6989586621681117798"><a href="#local-6989586621681117798"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="ByteCodeGen.html#getCurrentModule"><span class="hs-identifier hs-var">getCurrentModule</span></a><span>
</span><a name="line-420"></a><span>        </span><a name="local-6989586621681117799"><a href="#local-6989586621681117799"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-421"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117800"><a href="#local-6989586621681117800"><span class="hs-identifier">idOffSets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#getVarOffSets"><span class="hs-identifier hs-var">getVarOffSets</span></a><span> </span><a href="#local-6989586621681117799"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117789"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117790"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117793"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-422"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117801"><a href="#local-6989586621681117801"><span class="hs-identifier">breakInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CgBreakInfo</span><span>
</span><a name="line-423"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgb_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117800"><span class="hs-identifier hs-var">idOffSets</span></a><span>
</span><a name="line-424"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgb_resty</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deAnnotate'</span><span> </span><a href="#local-6989586621681117795"><span class="hs-identifier hs-var">newRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-425"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-426"></a><span>        </span><a href="ByteCodeGen.html#newBreakInfo"><span class="hs-identifier hs-var">newBreakInfo</span></a><span> </span><a href="#local-6989586621681117792"><span class="hs-identifier hs-var">tick_no</span></a><span> </span><a href="#local-6989586621681117801"><span class="hs-identifier hs-var">breakInfo</span></a><span>
</span><a name="line-427"></a><span>        </span><a name="local-6989586621681117803"><a href="#local-6989586621681117803"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117804"><a href="#local-6989586621681117804"><span class="hs-identifier">cc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">interpreterProfiled</span><span> </span><a href="#local-6989586621681117803"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117797"><span class="hs-identifier hs-var">cc_arr</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621681117792"><span class="hs-identifier hs-var">tick_no</span></a><span>
</span><a name="line-429"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toRemotePtr</span><span> </span><span class="hs-identifier hs-var">nullPtr</span><span>
</span><a name="line-430"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117805"><a href="#local-6989586621681117805"><span class="hs-identifier">breakInstr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#BRK_FUN"><span class="hs-identifier hs-var">BRK_FUN</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681117792"><span class="hs-identifier hs-var">tick_no</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621681117798"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117804"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-431"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681117805"><span class="hs-identifier hs-var">breakInstr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681117796"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-432"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117789"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681117790"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117791"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-identifier">getVarOffSets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word16</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-435"></a><a name="getVarOffSets"><a href="ByteCodeGen.html#getVarOffSets"><span class="hs-identifier">getVarOffSets</span></a></a><span> </span><a name="local-6989586621681117806"><a href="#local-6989586621681117806"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681117807"><a href="#local-6989586621681117807"><span class="hs-identifier">depth</span></a></a><span> </span><a name="local-6989586621681117808"><a href="#local-6989586621681117808"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681117809"><span class="hs-identifier hs-var">getOffSet</span></a><span>
</span><a name="line-436"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-437"></a><span>    </span><a name="local-6989586621681117809"><a href="#local-6989586621681117809"><span class="hs-identifier">getOffSet</span></a></a><span> </span><a name="local-6989586621681117810"><a href="#local-6989586621681117810"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="ByteCodeGen.html#lookupBCEnv_maybe"><span class="hs-identifier hs-var">lookupBCEnv_maybe</span></a><span> </span><a href="#local-6989586621681117810"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681117808"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117811"><a href="#local-6989586621681117811"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-440"></a><span>            </span><span class="hs-comment">-- michalt: I'm not entirely sure why we need the stack</span><span>
</span><a name="line-441"></a><span>            </span><span class="hs-comment">-- adjustment by 2 here. I initially thought that there's</span><span>
</span><a name="line-442"></a><span>            </span><span class="hs-comment">-- something off with getIdValFromApStack (the only user of this</span><span>
</span><a name="line-443"></a><span>            </span><span class="hs-comment">-- value), but it looks ok to me. My current hypothesis is that</span><span>
</span><a name="line-444"></a><span>            </span><span class="hs-comment">-- this &quot;adjustment&quot; is needed due to stack manipulation for</span><span>
</span><a name="line-445"></a><span>            </span><span class="hs-comment">-- BRK_FUN in Interpreter.c In any case, this is used only when</span><span>
</span><a name="line-446"></a><span>            </span><span class="hs-comment">-- we trigger a breakpoint.</span><span>
</span><a name="line-447"></a><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681117812"><a href="#local-6989586621681117812"><span class="hs-identifier">var_depth_ws</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-448"></a><span>                    </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681117806"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117807"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681117811"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-449"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117810"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117812"><span class="hs-identifier hs-var">var_depth_ws</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">truncIntegral16</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621681117651"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621681117651"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-452"></a><a name="truncIntegral16"><a href="ByteCodeGen.html#truncIntegral16"><span class="hs-identifier">truncIntegral16</span></a></a><span> </span><a name="local-6989586621681117813"><a href="#local-6989586621681117813"><span class="hs-identifier">w</span></a></a><span>
</span><a name="line-453"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681117813"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maxBound</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;stack depth overflow&quot;</span><span>
</span><a name="line-455"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681117813"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-identifier">trunc16B</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-459"></a><a name="trunc16B"><a href="ByteCodeGen.html#trunc16B"><span class="hs-identifier">trunc16B</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#truncIntegral16"><span class="hs-identifier hs-var">truncIntegral16</span></a><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-identifier">trunc16W</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-462"></a><a name="trunc16W"><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier">trunc16W</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#truncIntegral16"><span class="hs-identifier hs-var">truncIntegral16</span></a><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span class="hs-identifier">fvsToEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- Takes the free variables of a right-hand side, and</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- delivers an ordered list of the local variables that will</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- be captured in the thunk for the RHS</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- The BCEnv argument tells which variables are in the local</span><span>
</span><a name="line-469"></a><span class="hs-comment">-- environment: these are the ones that should be captured</span><span>
</span><a name="line-470"></a><span class="hs-comment">--</span><span>
</span><a name="line-471"></a><span class="hs-comment">-- The code that constructs the thunk, and the code that executes</span><span>
</span><a name="line-472"></a><span class="hs-comment">-- it, have to agree about this layout</span><span>
</span><a name="line-473"></a><a name="fvsToEnv"><a href="ByteCodeGen.html#fvsToEnv"><span class="hs-identifier">fvsToEnv</span></a></a><span> </span><a name="local-6989586621681117814"><a href="#local-6989586621681117814"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117815"><a href="#local-6989586621681117815"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681117816"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681117816"><a href="#local-6989586621681117816"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dVarSetElems</span><span> </span><a href="#local-6989586621681117815"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-474"></a><span>                      </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621681117816"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- Could be a type variable</span><span>
</span><a name="line-475"></a><span>                      </span><a href="#local-6989586621681117816"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681117814"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- schemeE</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-identifier">returnUnboxedAtom</span><span>
</span><a name="line-481"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-482"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-483"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-484"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span>
</span><a name="line-486"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-487"></a><span class="hs-comment">-- Returning an unlifted value.</span><span>
</span><a name="line-488"></a><span class="hs-comment">-- Heave it on the stack, SLIDE, and RETURN.</span><span>
</span><a name="line-489"></a><a name="returnUnboxedAtom"><a href="ByteCodeGen.html#returnUnboxedAtom"><span class="hs-identifier">returnUnboxedAtom</span></a></a><span> </span><a name="local-6989586621681117817"><a href="#local-6989586621681117817"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117818"><a href="#local-6989586621681117818"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117819"><a href="#local-6989586621681117819"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117820"><a href="#local-6989586621681117820"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681117821"><a href="#local-6989586621681117821"><span class="hs-identifier">e_rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-490"></a><span>    </span><a name="local-6989586621681117822"><a href="#local-6989586621681117822"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-491"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681117823"><a href="#local-6989586621681117823"><span class="hs-identifier">push</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117824"><a href="#local-6989586621681117824"><span class="hs-identifier">szb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681117817"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117819"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117820"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-492"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117823"><span class="hs-identifier hs-var">push</span></a><span>                                 </span><span class="hs-comment">-- value onto stack</span><span>
</span><a name="line-493"></a><span>           </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span>  </span><a href="ByteCodeGen.html#mkSlideB"><span class="hs-identifier hs-var">mkSlideB</span></a><span> </span><a href="#local-6989586621681117822"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117824"><span class="hs-identifier hs-var">szb</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117817"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681117818"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- clear to sequel</span><span>
</span><a name="line-494"></a><span>           </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="ByteCodeInstr.html#RETURN_UBX"><span class="hs-identifier hs-var">RETURN_UBX</span></a><span> </span><a href="#local-6989586621681117821"><span class="hs-identifier hs-var">e_rep</span></a><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- go</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span class="hs-comment">-- Compile code to apply the given expression to the remaining args</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- on the stack, returning a HNF.</span><span>
</span><a name="line-498"></a><span class="hs-identifier">schemeE</span><span>
</span><a name="line-499"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-500"></a><a name="schemeE"><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier">schemeE</span></a></a><span> </span><a name="local-6989586621681117825"><a href="#local-6989586621681117825"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117826"><a href="#local-6989586621681117826"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117827"><a href="#local-6989586621681117827"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117828"><a href="#local-6989586621681117828"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-501"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117829"><a href="#local-6989586621681117829"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#bcView"><span class="hs-identifier hs-var">bcView</span></a><span> </span><a href="#local-6989586621681117828"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-502"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117825"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117826"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117827"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117829"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-comment">-- Delegate tail-calls to schemeT.</span><span>
</span><a name="line-505"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117830"><a href="#local-6989586621681117830"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117831"><a href="#local-6989586621681117831"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117832"><a href="#local-6989586621681117832"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117833"><a href="#local-6989586621681117833"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeT"><span class="hs-identifier hs-var">schemeT</span></a><span> </span><a href="#local-6989586621681117830"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117831"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117832"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117833"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117834"><a href="#local-6989586621681117834"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117835"><a href="#local-6989586621681117835"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117836"><a href="#local-6989586621681117836"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117837"><a href="#local-6989586621681117837"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLit</span><span> </span><a name="local-6989586621681117838"><a href="#local-6989586621681117838"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#returnUnboxedAtom"><span class="hs-identifier hs-var">returnUnboxedAtom</span></a><span> </span><a href="#local-6989586621681117834"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117835"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117836"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117837"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#typeArgRep"><span class="hs-identifier hs-var">typeArgRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">literalType</span><span> </span><a href="#local-6989586621681117838"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117839"><a href="#local-6989586621681117839"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117840"><a href="#local-6989586621681117840"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117841"><a href="#local-6989586621681117841"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117842"><a href="#local-6989586621681117842"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCoercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#returnUnboxedAtom"><span class="hs-identifier hs-var">returnUnboxedAtom</span></a><span> </span><a href="#local-6989586621681117839"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117840"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117841"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117842"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="StgCmmArgRep.html#V"><span class="hs-identifier hs-var">V</span></a><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117843"><a href="#local-6989586621681117843"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117844"><a href="#local-6989586621681117844"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117845"><a href="#local-6989586621681117845"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117846"><a href="#local-6989586621681117846"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681117847"><a href="#local-6989586621681117847"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117847"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#returnUnboxedAtom"><span class="hs-identifier hs-var">returnUnboxedAtom</span></a><span> </span><a href="#local-6989586621681117843"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117844"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117845"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117846"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#bcIdArgRep"><span class="hs-identifier hs-var">bcIdArgRep</span></a><span> </span><a href="#local-6989586621681117847"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeT"><span class="hs-identifier hs-var">schemeT</span></a><span> </span><a href="#local-6989586621681117843"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117844"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117845"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117846"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117848"><a href="#local-6989586621681117848"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117849"><a href="#local-6989586621681117849"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117850"><a href="#local-6989586621681117850"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a name="local-6989586621681117851"><a href="#local-6989586621681117851"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681117852"><a href="#local-6989586621681117852"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681117853"><a href="#local-6989586621681117853"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681117854"><a href="#local-6989586621681117854"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117855"><a href="#local-6989586621681117855"><span class="hs-identifier">args_r_to_l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#splitApp"><span class="hs-identifier hs-var">splitApp</span></a><span> </span><a href="#local-6989586621681117852"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-516"></a><span>     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117856"><a href="#local-6989586621681117856"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId_maybe</span><span> </span><a href="#local-6989586621681117854"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span>
</span><a name="line-517"></a><span>     </span><span class="hs-identifier hs-var">dataConRepArity</span><span> </span><a href="#local-6989586621681117856"><span class="hs-identifier hs-var">data_con</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681117855"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-518"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Special case for a non-recursive let whose RHS is a</span><span>
</span><a name="line-519"></a><span>        </span><span class="hs-comment">-- saturated constructor application.</span><span>
</span><a name="line-520"></a><span>        </span><span class="hs-comment">-- Just allocate the constructor and carry on</span><span>
</span><a name="line-521"></a><span>        </span><a name="local-6989586621681117857"><a href="#local-6989586621681117857"><span class="hs-identifier">alloc_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#mkConAppCode"><span class="hs-identifier hs-var">mkConAppCode</span></a><span> </span><a href="#local-6989586621681117848"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117849"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117850"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117856"><span class="hs-identifier hs-var">data_con</span></a><span> </span><a href="#local-6989586621681117855"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-522"></a><span>        </span><a name="local-6989586621681117858"><a href="#local-6989586621681117858"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-523"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681117859"><a href="#local-6989586621681117859"><span class="hs-identifier">d2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117848"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681117858"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-524"></a><span>        </span><a name="local-6989586621681117860"><a href="#local-6989586621681117860"><span class="hs-identifier">body_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117859"><span class="hs-identifier hs-var">d2</span></a><span> </span><a href="#local-6989586621681117849"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621681117851"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621681117859"><span class="hs-identifier hs-var">d2</span></a><span> </span><a href="#local-6989586621681117850"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117853"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-525"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117857"><span class="hs-identifier hs-var">alloc_code</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681117860"><span class="hs-identifier hs-var">body_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-comment">-- General case for let.  Generates correct, if inefficient, code in</span><span>
</span><a name="line-528"></a><span class="hs-comment">-- all situations.</span><span>
</span><a name="line-529"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117861"><a href="#local-6989586621681117861"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117862"><a href="#local-6989586621681117862"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117863"><a href="#local-6989586621681117863"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLet</span><span> </span><a name="local-6989586621681117864"><a href="#local-6989586621681117864"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681117865"><a href="#local-6989586621681117865"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-530"></a><span>     </span><a name="local-6989586621681117866"><a href="#local-6989586621681117866"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-531"></a><span>     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117867"><a href="#local-6989586621681117867"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><a name="local-6989586621681117868"><a href="#local-6989586621681117868"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681117864"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a name="local-6989586621681117883"><a href="#local-6989586621681117883"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621681117884"><a href="#local-6989586621681117884"><span class="hs-identifier">rhs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621681117883"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><a href="#local-6989586621681117884"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>                                   </span><span class="hs-identifier hs-var">AnnRec</span><span> </span><a name="local-6989586621681117885"><a href="#local-6989586621681117885"><span class="hs-identifier">xs_n_rhss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681117885"><span class="hs-identifier hs-var">xs_n_rhss</span></a><span>
</span><a name="line-533"></a><span>         </span><a name="local-6989586621681117869"><a href="#local-6989586621681117869"><span class="hs-identifier">n_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">genericLength</span><span> </span><a href="#local-6989586621681117867"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span>         </span><a name="local-6989586621681117870"><a href="#local-6989586621681117870"><span class="hs-identifier">fvss</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#fvsToEnv"><span class="hs-identifier hs-var">fvsToEnv</span></a><span> </span><a href="#local-6989586621681117875"><span class="hs-identifier hs-var">p'</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117868"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span>         </span><span class="hs-comment">-- Sizes of free vars</span><span>
</span><a name="line-538"></a><span>         </span><a name="local-6989586621681117871"><a href="#local-6989586621681117871"><span class="hs-identifier">size_w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeGen.html#idSizeW"><span class="hs-identifier hs-var">idSizeW</span></a><span> </span><a href="#local-6989586621681117866"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-539"></a><span>         </span><a name="local-6989586621681117872"><a href="#local-6989586621681117872"><span class="hs-identifier">sizes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681117886"><a href="#local-6989586621681117886"><span class="hs-identifier">rhs_fvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681117871"><span class="hs-identifier hs-var">size_w</span></a><span> </span><a href="#local-6989586621681117886"><span class="hs-identifier hs-var">rhs_fvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117870"><span class="hs-identifier hs-var">fvss</span></a><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span>         </span><span class="hs-comment">-- the arity of each rhs</span><span>
</span><a name="line-542"></a><span>         </span><a name="local-6989586621681117873"><a href="#local-6989586621681117873"><span class="hs-identifier">arities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">genericLength</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeGen.html#collect"><span class="hs-identifier hs-var">collect</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117868"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>         </span><span class="hs-comment">-- This p', d' defn is safe because all the items being pushed</span><span>
</span><a name="line-545"></a><span>         </span><span class="hs-comment">-- are ptrs, so all have size 1 word.  d' and p' reflect the stack</span><span>
</span><a name="line-546"></a><span>         </span><span class="hs-comment">-- after the closures have been allocated in the heap (but not</span><span>
</span><a name="line-547"></a><span>         </span><span class="hs-comment">-- filled in), and pointers to them parked on the stack.</span><span>
</span><a name="line-548"></a><span>         </span><a name="local-6989586621681117874"><a href="#local-6989586621681117874"><span class="hs-identifier">offsets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#mkStackOffsets"><span class="hs-identifier hs-var">mkStackOffsets</span></a><span> </span><a href="#local-6989586621681117861"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">genericReplicate</span><span> </span><a href="#local-6989586621681117869"><span class="hs-identifier hs-var">n_binds</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681117866"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>         </span><a name="local-6989586621681117875"><a href="#local-6989586621681117875"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insertList</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117877"><span class="hs-identifier hs-var">zipE</span></a><span> </span><a href="#local-6989586621681117867"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621681117874"><span class="hs-identifier hs-var">offsets</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117863"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-550"></a><span>         </span><a name="local-6989586621681117876"><a href="#local-6989586621681117876"><span class="hs-identifier">d'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117861"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681117866"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681117869"><span class="hs-identifier hs-var">n_binds</span></a><span>
</span><a name="line-551"></a><span>         </span><a name="local-6989586621681117877"><a href="#local-6989586621681117877"><span class="hs-identifier">zipE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;schemeE&quot;</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span>         </span><span class="hs-comment">-- ToDo: don't build thunks for things with no free variables</span><span>
</span><a name="line-554"></a><span>         </span><span class="hs-identifier">build_thunk</span><span>
</span><a name="line-555"></a><span>             </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-556"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-557"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-558"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-559"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-560"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-561"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-562"></a><span>         </span><a name="local-6989586621681117878"><a href="#local-6989586621681117878"><span class="hs-identifier">build_thunk</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681117887"><a href="#local-6989586621681117887"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621681117888"><a href="#local-6989586621681117888"><span class="hs-identifier">bco</span></a></a><span> </span><a name="local-6989586621681117889"><a href="#local-6989586621681117889"><span class="hs-identifier">off</span></a></a><span> </span><a name="local-6989586621681117890"><a href="#local-6989586621681117890"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-563"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_BCO"><span class="hs-identifier hs-var">PUSH_BCO</span></a><span> </span><a href="#local-6989586621681117888"><span class="hs-identifier hs-var">bco</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117891"><span class="hs-identifier hs-var">mkap</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117889"><span class="hs-identifier hs-var">off</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621681117887"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117887"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>           </span><span class="hs-keyword">where</span><span>
</span><a name="line-565"></a><span>                </span><a name="local-6989586621681117891"><a href="#local-6989586621681117891"><span class="hs-identifier">mkap</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681117890"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#MKAP"><span class="hs-identifier hs-var">MKAP</span></a><span>
</span><a name="line-566"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#MKPAP"><span class="hs-identifier hs-var">MKPAP</span></a><span>
</span><a name="line-567"></a><span>         </span><span class="hs-identifier">build_thunk</span><span> </span><a name="local-6989586621681117892"><a href="#local-6989586621681117892"><span class="hs-identifier">dd</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681117893"><a href="#local-6989586621681117893"><span class="hs-identifier">fv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681117894"><a href="#local-6989586621681117894"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681117895"><a href="#local-6989586621681117895"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621681117896"><a href="#local-6989586621681117896"><span class="hs-identifier">bco</span></a></a><span> </span><a name="local-6989586621681117897"><a href="#local-6989586621681117897"><span class="hs-identifier">off</span></a></a><span> </span><a name="local-6989586621681117898"><a href="#local-6989586621681117898"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-568"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621681117899"><a href="#local-6989586621681117899"><span class="hs-identifier">push_code</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117900"><a href="#local-6989586621681117900"><span class="hs-identifier">pushed_szb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681117892"><span class="hs-identifier hs-var">dd</span></a><span> </span><a href="#local-6989586621681117875"><span class="hs-identifier hs-var">p'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a href="#local-6989586621681117893"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>              </span><a name="local-6989586621681117901"><a href="#local-6989586621681117901"><span class="hs-identifier">more_push_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-570"></a><span>                  </span><a href="#local-6989586621681117878"><span class="hs-identifier hs-var">build_thunk</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117892"><span class="hs-identifier hs-var">dd</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681117900"><span class="hs-identifier hs-var">pushed_szb</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117894"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621681117895"><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621681117896"><span class="hs-identifier hs-var">bco</span></a><span> </span><a href="#local-6989586621681117897"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621681117898"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-571"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117899"><span class="hs-identifier hs-var">push_code</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681117901"><span class="hs-identifier hs-var">more_push_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>         </span><a name="local-6989586621681117879"><a href="#local-6989586621681117879"><span class="hs-identifier">alloc_code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621681117902"><span class="hs-identifier hs-var">mkAlloc</span></a><span> </span><a href="#local-6989586621681117872"><span class="hs-identifier hs-var">sizes</span></a><span> </span><a href="#local-6989586621681117873"><span class="hs-identifier hs-var">arities</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>           </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681117902"><a href="#local-6989586621681117902"><span class="hs-identifier">mkAlloc</span></a></a><span> </span><a name="local-6989586621681117903"><a href="#local-6989586621681117903"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-575"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681117880"><span class="hs-identifier hs-var">is_tick</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#ALLOC_AP_NOUPD"><span class="hs-identifier hs-var">ALLOC_AP_NOUPD</span></a><span> </span><a href="#local-6989586621681117903"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-576"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#ALLOC_AP"><span class="hs-identifier hs-var">ALLOC_AP</span></a><span> </span><a href="#local-6989586621681117903"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-577"></a><span>                 </span><span class="hs-identifier">mkAlloc</span><span> </span><a name="local-6989586621681117904"><a href="#local-6989586621681117904"><span class="hs-identifier">sz</span></a></a><span> </span><a name="local-6989586621681117905"><a href="#local-6989586621681117905"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#ALLOC_PAP"><span class="hs-identifier hs-var">ALLOC_PAP</span></a><span> </span><a href="#local-6989586621681117905"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621681117904"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span>         </span><a name="local-6989586621681117880"><a href="#local-6989586621681117880"><span class="hs-identifier">is_tick</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681117864"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-580"></a><span>                     </span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a name="local-6989586621681117906"><a href="#local-6989586621681117906"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621681117906"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="ByteCodeGen.html#tickFS"><span class="hs-identifier hs-var">tickFS</span></a><span>
</span><a name="line-581"></a><span>                     </span><a name="local-6989586621681117907"><a href="#local-6989586621681117907"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span>         </span><a name="local-6989586621681117881"><a href="#local-6989586621681117881"><span class="hs-identifier">compile_bind</span></a></a><span> </span><a name="local-6989586621681117908"><a href="#local-6989586621681117908"><span class="hs-identifier">d'</span></a></a><span> </span><a name="local-6989586621681117909"><a href="#local-6989586621681117909"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681117910"><a href="#local-6989586621681117910"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621681117911"><a href="#local-6989586621681117911"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621681117912"><a href="#local-6989586621681117912"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621681117913"><a href="#local-6989586621681117913"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621681117914"><a href="#local-6989586621681117914"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-584"></a><span>                </span><a name="local-6989586621681117915"><a href="#local-6989586621681117915"><span class="hs-identifier">bco</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeR"><span class="hs-identifier hs-var">schemeR</span></a><span> </span><a href="#local-6989586621681117909"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117910"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621681117911"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>                </span><a href="#local-6989586621681117878"><span class="hs-identifier hs-var">build_thunk</span></a><span> </span><a href="#local-6989586621681117908"><span class="hs-identifier hs-var">d'</span></a><span> </span><a href="#local-6989586621681117909"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621681117912"><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621681117915"><span class="hs-identifier hs-var">bco</span></a><span> </span><a href="#local-6989586621681117914"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621681117913"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span>         </span><a name="local-6989586621681117882"><a href="#local-6989586621681117882"><span class="hs-identifier">compile_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-588"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681117881"><span class="hs-identifier hs-var">compile_bind</span></a><span> </span><a href="#local-6989586621681117876"><span class="hs-identifier hs-var">d'</span></a><span> </span><a href="#local-6989586621681117916"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621681117917"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621681117918"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621681117919"><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621681117920"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><a href="#local-6989586621681117921"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-589"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117916"><a href="#local-6989586621681117916"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117917"><a href="#local-6989586621681117917"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117918"><a href="#local-6989586621681117918"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117919"><a href="#local-6989586621681117919"><span class="hs-identifier">size</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117920"><a href="#local-6989586621681117920"><span class="hs-identifier">arity</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117921"><a href="#local-6989586621681117921"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-590"></a><span>                </span><span class="hs-identifier hs-var">zip6</span><span> </span><a href="#local-6989586621681117870"><span class="hs-identifier hs-var">fvss</span></a><span> </span><a href="#local-6989586621681117867"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621681117868"><span class="hs-identifier hs-var">rhss</span></a><span> </span><a href="#local-6989586621681117872"><span class="hs-identifier hs-var">sizes</span></a><span> </span><a href="#local-6989586621681117873"><span class="hs-identifier hs-var">arities</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681117869"><span class="hs-identifier hs-var">n_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117869"><span class="hs-identifier hs-var">n_binds</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span>
</span><a name="line-591"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>     </span><a name="local-6989586621681117922"><a href="#local-6989586621681117922"><span class="hs-identifier">body_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117876"><span class="hs-identifier hs-var">d'</span></a><span> </span><a href="#local-6989586621681117862"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117875"><span class="hs-identifier hs-var">p'</span></a><span> </span><a href="#local-6989586621681117865"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-593"></a><span>     </span><a name="local-6989586621681117923"><a href="#local-6989586621681117923"><span class="hs-identifier">thunk_codes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><a href="#local-6989586621681117882"><span class="hs-identifier hs-var">compile_binds</span></a><span>
</span><a name="line-594"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117879"><span class="hs-identifier hs-var">alloc_code</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">concatOL</span><span> </span><a href="#local-6989586621681117923"><span class="hs-identifier hs-var">thunk_codes</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681117922"><span class="hs-identifier hs-var">body_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span class="hs-comment">-- Introduce a let binding for a ticked case expression. This rule</span><span>
</span><a name="line-597"></a><span class="hs-comment">-- *should* only fire when the expression was not already let-bound</span><span>
</span><a name="line-598"></a><span class="hs-comment">-- (the code gen for let bindings should take care of that).  Todo: we</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- call exprFreeVars on a deAnnotated expression, this may not be the</span><span>
</span><a name="line-600"></a><span class="hs-comment">-- best way to calculate the free vars but it seemed like the least</span><span>
</span><a name="line-601"></a><span class="hs-comment">-- intrusive thing to do</span><span>
</span><a name="line-602"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117924"><a href="#local-6989586621681117924"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117925"><a href="#local-6989586621681117925"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117926"><a href="#local-6989586621681117926"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117927"><a href="#local-6989586621681117927"><span class="hs-identifier">exp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnTick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Breakpoint</span><span> </span><a name="local-6989586621681117928"><a href="#local-6989586621681117928"><span class="hs-identifier">_id</span></a></a><span> </span><a name="local-6989586621681117929"><a href="#local-6989586621681117929"><span class="hs-identifier">_fvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681117930"><a href="#local-6989586621681117930"><span class="hs-identifier">_rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isLiftedTypeKind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621681117933"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621681117934"><a href="#local-6989586621681117934"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#newId"><span class="hs-identifier hs-var">newId</span></a><span> </span><a href="#local-6989586621681117933"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-605"></a><span>          </span><span class="hs-comment">-- Todo: is emptyVarSet correct on the next line?</span><span>
</span><a name="line-606"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117935"><a href="#local-6989586621681117935"><span class="hs-identifier">letExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a href="#local-6989586621681117934"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117932"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117927"><span class="hs-identifier hs-var">exp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyDVarSet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a href="#local-6989586621681117934"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>          </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117924"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117925"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117926"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117935"><span class="hs-identifier hs-var">letExp</span></a><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-610"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-comment">-- If the result type is not definitely lifted, then we must generate</span><span>
</span><a name="line-611"></a><span>          </span><span class="hs-comment">--   let f = \s . tick&lt;n&gt; e</span><span>
</span><a name="line-612"></a><span>          </span><span class="hs-comment">--   in  f realWorld#</span><span>
</span><a name="line-613"></a><span>          </span><span class="hs-comment">-- When we stop at the breakpoint, _result will have an unlifted</span><span>
</span><a name="line-614"></a><span>          </span><span class="hs-comment">-- type and hence won't be bound in the environment, but the</span><span>
</span><a name="line-615"></a><span>          </span><span class="hs-comment">-- breakpoint will otherwise work fine.</span><span>
</span><a name="line-616"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-617"></a><span>          </span><span class="hs-comment">-- NB (Trac #12007) this /also/ applies for if (ty :: TYPE r), where</span><span>
</span><a name="line-618"></a><span>          </span><span class="hs-comment">--    r :: RuntimeRep is a variable. This can happen in the</span><span>
</span><a name="line-619"></a><span>          </span><span class="hs-comment">--    continuations for a pattern-synonym matcher</span><span>
</span><a name="line-620"></a><span>          </span><span class="hs-comment">--    match = /\(r::RuntimeRep) /\(a::TYPE r).</span><span>
</span><a name="line-621"></a><span>          </span><span class="hs-comment">--            \(k :: Int -&gt; a) \(v::T).</span><span>
</span><a name="line-622"></a><span>          </span><span class="hs-comment">--            case v of MkV n -&gt; k n</span><span>
</span><a name="line-623"></a><span>          </span><span class="hs-comment">-- Here (k n) :: a :: Type r, so we don't know if it's lifted</span><span>
</span><a name="line-624"></a><span>          </span><span class="hs-comment">-- or not; but that should be fine provided we add that void arg.</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span>          </span><a name="local-6989586621681117936"><a href="#local-6989586621681117936"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#newId"><span class="hs-identifier hs-var">newId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><span class="hs-identifier hs-var">realWorldStatePrimTy</span><span> </span><a href="#local-6989586621681117933"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>          </span><a name="local-6989586621681117937"><a href="#local-6989586621681117937"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#newId"><span class="hs-identifier hs-var">newId</span></a><span> </span><span class="hs-identifier hs-var">realWorldStatePrimTy</span><span>
</span><a name="line-628"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681117938"><a href="#local-6989586621681117938"><span class="hs-identifier">letExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnnLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnNonRec</span><span> </span><a href="#local-6989586621681117936"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117932"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnLam</span><span> </span><a href="#local-6989586621681117937"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyDVarSet</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117927"><span class="hs-identifier hs-var">exp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyDVarSet</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyDVarSet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a href="#local-6989586621681117936"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyDVarSet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnVar</span><span> </span><span class="hs-identifier hs-var">realWorldPrimId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>          </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117924"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117925"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117926"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117938"><span class="hs-identifier hs-var">letExp</span></a><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-634"></a><span>     </span><a name="local-6989586621681117931"><a href="#local-6989586621681117931"><span class="hs-identifier">exp'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">deAnnotate'</span><span> </span><a href="#local-6989586621681117927"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-635"></a><span>     </span><a name="local-6989586621681117932"><a href="#local-6989586621681117932"><span class="hs-identifier">fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprFreeVarsDSet</span><span> </span><a href="#local-6989586621681117931"><span class="hs-identifier hs-var">exp'</span></a><span>
</span><a name="line-636"></a><span>     </span><a name="local-6989586621681117933"><a href="#local-6989586621681117933"><span class="hs-identifier">ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621681117931"><span class="hs-identifier hs-var">exp'</span></a><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span class="hs-comment">-- ignore other kinds of tick</span><span>
</span><a name="line-639"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117939"><a href="#local-6989586621681117939"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117940"><a href="#local-6989586621681117940"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117941"><a href="#local-6989586621681117941"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnTick</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681117942"><a href="#local-6989586621681117942"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117939"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117940"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117941"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117942"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117943"><a href="#local-6989586621681117943"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117944"><a href="#local-6989586621681117944"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117945"><a href="#local-6989586621681117945"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681117946"><a href="#local-6989586621681117946"><span class="hs-identifier">scrut</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681117943"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117944"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117945"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117946"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-642"></a><span>        </span><span class="hs-comment">-- no alts: scrut is guaranteed to diverge</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117947"><a href="#local-6989586621681117947"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117948"><a href="#local-6989586621681117948"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117949"><a href="#local-6989586621681117949"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><a name="local-6989586621681117950"><a href="#local-6989586621681117950"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621681117951"><a href="#local-6989586621681117951"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621681117952"><a href="#local-6989586621681117952"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681117953"><a href="#local-6989586621681117953"><span class="hs-identifier">bind1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117954"><a href="#local-6989586621681117954"><span class="hs-identifier">bind2</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681117955"><a href="#local-6989586621681117955"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleCon</span><span> </span><a href="#local-6989586621681117952"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-comment">-- handles pairs with one void argument (e.g. state token)</span><span>
</span><a name="line-646"></a><span>        </span><span class="hs-comment">-- Convert</span><span>
</span><a name="line-647"></a><span>        </span><span class="hs-comment">--      case .... of x { (# V'd-thing, a #) -&gt; ... }</span><span>
</span><a name="line-648"></a><span>        </span><span class="hs-comment">-- to</span><span>
</span><a name="line-649"></a><span>        </span><span class="hs-comment">--      case .... of a { DEFAULT -&gt; ... }</span><span>
</span><a name="line-650"></a><span>        </span><span class="hs-comment">-- because the return convention for both are identical.</span><span>
</span><a name="line-651"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-652"></a><span>        </span><span class="hs-comment">-- Note that it does not matter losing the void-rep thing from the</span><span>
</span><a name="line-653"></a><span>        </span><span class="hs-comment">-- envt (it won't be bound now) because we never look such things up.</span><span>
</span><a name="line-654"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117956"><a href="#local-6989586621681117956"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117953"><span class="hs-identifier hs-var">bind1</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117954"><span class="hs-identifier hs-var">bind2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-655"></a><span>                   </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#doCase"><span class="hs-identifier hs-var">doCase</span></a><span> </span><a href="#local-6989586621681117947"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117948"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117949"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117950"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621681117954"><span class="hs-identifier hs-var">bind2</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117955"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681117951"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>                   </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#doCase"><span class="hs-identifier hs-var">doCase</span></a><span> </span><a href="#local-6989586621681117947"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117948"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117949"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117950"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621681117953"><span class="hs-identifier hs-var">bind1</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117955"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681117951"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>                   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-660"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681117956"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117957"><a href="#local-6989586621681117957"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117958"><a href="#local-6989586621681117958"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117959"><a href="#local-6989586621681117959"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><a name="local-6989586621681117960"><a href="#local-6989586621681117960"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621681117961"><a href="#local-6989586621681117961"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621681117962"><a href="#local-6989586621681117962"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681117963"><a href="#local-6989586621681117963"><span class="hs-identifier">bind1</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681117964"><a href="#local-6989586621681117964"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleCon</span><span> </span><a href="#local-6989586621681117962"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-664"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117961"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthAtMost</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-comment">-- handles unit tuples</span><span>
</span><a name="line-665"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#doCase"><span class="hs-identifier hs-var">doCase</span></a><span> </span><a href="#local-6989586621681117957"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117958"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117959"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117960"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621681117963"><span class="hs-identifier hs-var">bind1</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117964"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681117961"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117965"><a href="#local-6989586621681117965"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117966"><a href="#local-6989586621681117966"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117967"><a href="#local-6989586621681117967"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><a name="local-6989586621681117968"><a href="#local-6989586621681117968"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621681117969"><a href="#local-6989586621681117969"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681117970"><a href="#local-6989586621681117970"><span class="hs-identifier">alt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117969"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117971"><a href="#local-6989586621681117971"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117969"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-670"></a><span>       </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unwrapType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681117969"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-671"></a><span>       </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">voidPrimTy</span><span>
</span><a name="line-672"></a><span>       </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-673"></a><span>       </span><span class="hs-comment">-- handles any pattern with a single non-void binder; in particular I/O</span><span>
</span><a name="line-674"></a><span>       </span><span class="hs-comment">-- monad returns (# RealWorld#, a #)</span><span>
</span><a name="line-675"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#doCase"><span class="hs-identifier hs-var">doCase</span></a><span> </span><a href="#local-6989586621681117965"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117966"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117967"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117968"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117969"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681117971"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681117970"><span class="hs-identifier hs-var">alt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681117969"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-identifier">schemeE</span><span> </span><a name="local-6989586621681117972"><a href="#local-6989586621681117972"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117973"><a href="#local-6989586621681117973"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117974"><a href="#local-6989586621681117974"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><a name="local-6989586621681117975"><a href="#local-6989586621681117975"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621681117976"><a href="#local-6989586621681117976"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681117977"><a href="#local-6989586621681117977"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#doCase"><span class="hs-identifier hs-var">doCase</span></a><span> </span><a href="#local-6989586621681117972"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117973"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117974"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117975"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621681117976"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681117977"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-comment">{-not an unboxed tuple-}</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span class="hs-identifier">schemeE</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681117978"><a href="#local-6989586621681117978"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-681"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.schemeE: unhandled case&quot;</span><span>
</span><a name="line-682"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCoreExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deAnnotate'</span><span> </span><a href="#local-6989586621681117978"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span class="hs-comment">{-
   Ticked Expressions
   ------------------

  The idea is that the &quot;breakpoint&lt;n,fvs&gt; E&quot; is really just an annotation on
  the code. When we find such a thing, we pull out the useful information,
  and then compile the code as if it was just the expression E.

-}</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span class="hs-comment">-- Compile code to do a tail call.  Specifically, push the fn,</span><span>
</span><a name="line-695"></a><span class="hs-comment">-- slide the on-stack app back down to the sequel depth,</span><span>
</span><a name="line-696"></a><span class="hs-comment">-- and enter.  Four cases:</span><span>
</span><a name="line-697"></a><span class="hs-comment">--</span><span>
</span><a name="line-698"></a><span class="hs-comment">-- 0.  (Nasty hack).</span><span>
</span><a name="line-699"></a><span class="hs-comment">--     An application &quot;GHC.Prim.tagToEnum# &lt;type&gt; unboxed-int&quot;.</span><span>
</span><a name="line-700"></a><span class="hs-comment">--     The int will be on the stack.  Generate a code sequence</span><span>
</span><a name="line-701"></a><span class="hs-comment">--     to convert it to the relevant constructor, SLIDE and ENTER.</span><span>
</span><a name="line-702"></a><span class="hs-comment">--</span><span>
</span><a name="line-703"></a><span class="hs-comment">-- 1.  The fn denotes a ccall.  Defer to generateCCall.</span><span>
</span><a name="line-704"></a><span class="hs-comment">--</span><span>
</span><a name="line-705"></a><span class="hs-comment">-- 2.  (Another nasty hack).  Spot (# a::V, b #) and treat</span><span>
</span><a name="line-706"></a><span class="hs-comment">--     it simply as  b  -- since the representations are identical</span><span>
</span><a name="line-707"></a><span class="hs-comment">--     (the V takes up zero stack space).  Also, spot</span><span>
</span><a name="line-708"></a><span class="hs-comment">--     (# b #) and treat it as  b.</span><span>
</span><a name="line-709"></a><span class="hs-comment">--</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- 3.  Application of a constructor, by defn saturated.</span><span>
</span><a name="line-711"></a><span class="hs-comment">--     Split the args into ptrs and non-ptrs, and push the nonptrs,</span><span>
</span><a name="line-712"></a><span class="hs-comment">--     then the ptrs, and then do PACK and RETURN.</span><span>
</span><a name="line-713"></a><span class="hs-comment">--</span><span>
</span><a name="line-714"></a><span class="hs-comment">-- 4.  Otherwise, it must be a function call.  Push the args</span><span>
</span><a name="line-715"></a><span class="hs-comment">--     right to left, SLIDE and ENTER.</span><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span class="hs-identifier">schemeT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>   </span><span class="hs-comment">-- Stack depth</span><span>
</span><a name="line-718"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>       </span><span class="hs-comment">-- Sequel depth</span><span>
</span><a name="line-719"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>        </span><span class="hs-comment">-- stack env</span><span>
</span><a name="line-720"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-721"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><a name="schemeT"><a href="ByteCodeGen.html#schemeT"><span class="hs-identifier">schemeT</span></a></a><span> </span><a name="local-6989586621681117979"><a href="#local-6989586621681117979"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681117980"><a href="#local-6989586621681117980"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681117981"><a href="#local-6989586621681117981"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681117982"><a href="#local-6989586621681117982"><span class="hs-identifier">app</span></a></a><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>   </span><span class="hs-comment">-- Case 0</span><span>
</span><a name="line-726"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681117988"><a href="#local-6989586621681117988"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117989"><a href="#local-6989586621681117989"><span class="hs-identifier">constr_names</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#maybe_is_tagToEnum_call"><span class="hs-identifier hs-var">maybe_is_tagToEnum_call</span></a><span> </span><a href="#local-6989586621681117982"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-727"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#implement_tagToId"><span class="hs-identifier hs-var">implement_tagToId</span></a><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117988"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621681117989"><span class="hs-identifier hs-var">constr_names</span></a><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span>   </span><span class="hs-comment">-- Case 1</span><span>
</span><a name="line-730"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCall</span><span> </span><a name="local-6989586621681117990"><a href="#local-6989586621681117990"><span class="hs-identifier">ccall_spec</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isFCallId_maybe</span><span> </span><a href="#local-6989586621681117983"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-731"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="ByteCodeGen.html#isSupportedCConv"><span class="hs-identifier hs-var">isSupportedCConv</span></a><span> </span><a href="#local-6989586621681117990"><span class="hs-identifier hs-var">ccall_spec</span></a><span>
</span><a name="line-732"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="ByteCodeGen.html#generateCCall"><span class="hs-identifier hs-var">generateCCall</span></a><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117990"><span class="hs-identifier hs-var">ccall_spec</span></a><span> </span><a href="#local-6989586621681117983"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681117984"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-733"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="ByteCodeGen.html#unsupportedCConvException"><span class="hs-identifier hs-var">unsupportedCConvException</span></a><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span>   </span><span class="hs-comment">-- Case 2: Constructor application</span><span>
</span><a name="line-737"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117991"><a href="#local-6989586621681117991"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681117986"><span class="hs-identifier hs-var">maybe_saturated_dcon</span></a><span>
</span><a name="line-738"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleCon</span><span> </span><a href="#local-6989586621681117991"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-739"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681117984"><span class="hs-identifier hs-var">args_r_to_l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-740"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621681117992"><a href="#local-6989586621681117992"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">,</span><a name="local-6989586621681117993"><a href="#local-6989586621681117993"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="ByteCodeGen.html#isVAtom"><span class="hs-identifier hs-var">isVAtom</span></a><span> </span><a href="#local-6989586621681117992"><span class="hs-identifier hs-var">arg1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-741"></a><span>                  </span><a href="ByteCodeGen.html#unboxedTupleReturn"><span class="hs-identifier hs-var">unboxedTupleReturn</span></a><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117993"><span class="hs-identifier hs-var">arg2</span></a><span>
</span><a name="line-742"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621681117994"><a href="#local-6989586621681117994"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">,</span><a name="local-6989586621681117995"><a href="#local-6989586621681117995"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="ByteCodeGen.html#isVAtom"><span class="hs-identifier hs-var">isVAtom</span></a><span> </span><a href="#local-6989586621681117995"><span class="hs-identifier hs-var">arg2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-743"></a><span>                  </span><a href="ByteCodeGen.html#unboxedTupleReturn"><span class="hs-identifier hs-var">unboxedTupleReturn</span></a><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117994"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-744"></a><span>        </span><a name="local-6989586621681117996"><a href="#local-6989586621681117996"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#multiValException"><span class="hs-identifier hs-var">multiValException</span></a><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>   </span><span class="hs-comment">-- Case 3: Ordinary data constructor</span><span>
</span><a name="line-747"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117997"><a href="#local-6989586621681117997"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681117986"><span class="hs-identifier hs-var">maybe_saturated_dcon</span></a><span>
</span><a name="line-748"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681117998"><a href="#local-6989586621681117998"><span class="hs-identifier">alloc_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#mkConAppCode"><span class="hs-identifier hs-var">mkConAppCode</span></a><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117997"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621681117984"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-749"></a><span>        </span><a name="local-6989586621681117999"><a href="#local-6989586621681117999"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-750"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117998"><span class="hs-identifier hs-var">alloc_con</span></a><span>         </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span>
</span><a name="line-751"></a><span>                </span><a href="ByteCodeGen.html#mkSlideW"><span class="hs-identifier hs-var">mkSlideW</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681117999"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span>
</span><a name="line-752"></a><span>                </span><a href="ByteCodeInstr.html#ENTER"><span class="hs-identifier hs-var">ENTER</span></a><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>
</span><a name="line-754"></a><span>   </span><span class="hs-comment">-- Case 4: Tail call of function</span><span>
</span><a name="line-755"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-756"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#doTailCall"><span class="hs-identifier hs-var">doTailCall</span></a><span> </span><a href="#local-6989586621681117979"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681117980"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681117981"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681117983"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681117984"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-comment">-- Extract the args (R-&gt;L) and fn</span><span>
</span><a name="line-760"></a><span>        </span><span class="hs-comment">-- The function will necessarily be a variable,</span><span>
</span><a name="line-761"></a><span>        </span><span class="hs-comment">-- because we are compiling a tail call</span><span>
</span><a name="line-762"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681117983"><a href="#local-6989586621681117983"><span class="hs-identifier">fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681117984"><a href="#local-6989586621681117984"><span class="hs-identifier">args_r_to_l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#splitApp"><span class="hs-identifier hs-var">splitApp</span></a><span> </span><a href="#local-6989586621681117982"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span>      </span><span class="hs-comment">-- Only consider this to be a constructor application iff it is</span><span>
</span><a name="line-765"></a><span>      </span><span class="hs-comment">-- saturated.  Otherwise, we'll call the constructor wrapper.</span><span>
</span><a name="line-766"></a><span>      </span><a name="local-6989586621681117985"><a href="#local-6989586621681117985"><span class="hs-identifier">n_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681117984"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-767"></a><span>      </span><a name="local-6989586621681117986"><a href="#local-6989586621681117986"><span class="hs-identifier">maybe_saturated_dcon</span></a></a><span>
</span><a name="line-768"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId_maybe</span><span> </span><a href="#local-6989586621681117983"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-769"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681117987"><a href="#local-6989586621681117987"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dataConRepArity</span><span> </span><a href="#local-6989586621681117987"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681117985"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681117987"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-770"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-773"></a><span class="hs-comment">-- Generate code to build a constructor application,</span><span>
</span><a name="line-774"></a><span class="hs-comment">-- leaving it on top of the stack</span><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span class="hs-identifier">mkConAppCode</span><span>
</span><a name="line-777"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-778"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-779"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-780"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>                  </span><span class="hs-comment">-- The data constructor</span><span>
</span><a name="line-781"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Args, in *reverse* order</span><span>
</span><a name="line-782"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-783"></a><a name="mkConAppCode"><a href="ByteCodeGen.html#mkConAppCode"><span class="hs-identifier">mkConAppCode</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681118000"><a href="#local-6989586621681118000"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Nullary constructor</span><span>
</span><a name="line-784"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNullaryRepDataCon</span><span> </span><span class="hs-identifier hs-var">con</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_G"><span class="hs-identifier hs-var">PUSH_G</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWorkId</span><span> </span><a href="#local-6989586621681118000"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-786"></a><span>        </span><span class="hs-comment">-- Instead of doing a PACK, which would allocate a fresh</span><span>
</span><a name="line-787"></a><span>        </span><span class="hs-comment">-- copy of this constructor, use the single shared version.</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-identifier">mkConAppCode</span><span> </span><a name="local-6989586621681118001"><a href="#local-6989586621681118001"><span class="hs-identifier">orig_d</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681118002"><a href="#local-6989586621681118002"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118003"><a href="#local-6989586621681118003"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621681118004"><a href="#local-6989586621681118004"><span class="hs-identifier">args_r_to_l</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-790"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">args_r_to_l</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">dataConRepArity</span><span> </span><span class="hs-identifier hs-var">con</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">app_code</span><span>
</span><a name="line-791"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-792"></a><span>    </span><a name="local-6989586621681118005"><a href="#local-6989586621681118005"><span class="hs-identifier">app_code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-793"></a><span>        </span><a name="local-6989586621681118006"><a href="#local-6989586621681118006"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span>        </span><span class="hs-comment">-- The args are initially in reverse order, but mkVirtHeapOffsets</span><span>
</span><a name="line-796"></a><span>        </span><span class="hs-comment">-- expects them to be left-to-right.</span><span>
</span><a name="line-797"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118007"><a href="#local-6989586621681118007"><span class="hs-identifier">non_voids</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-798"></a><span>                </span><span class="hs-special">[</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118011"><span class="hs-identifier hs-var">prim_rep</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118010"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-799"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681118010"><a href="#local-6989586621681118010"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621681118004"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-800"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118011"><a href="#local-6989586621681118011"><span class="hs-identifier">prim_rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#atomPrimRep"><span class="hs-identifier hs-var">atomPrimRep</span></a><span> </span><a href="#local-6989586621681118010"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-801"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isVoidRep</span><span> </span><a href="#local-6989586621681118011"><span class="hs-identifier hs-var">prim_rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-802"></a><span>                </span><span class="hs-special">]</span><span>
</span><a name="line-803"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681118008"><a href="#local-6989586621681118008"><span class="hs-identifier">args_offsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-804"></a><span>                </span><a href="StgCmmLayout.html#mkVirtHeapOffsetsWithPadding"><span class="hs-identifier hs-var">mkVirtHeapOffsetsWithPadding</span></a><span> </span><a href="#local-6989586621681118006"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="StgCmmLayout.html#StdHeader"><span class="hs-identifier hs-var">StdHeader</span></a><span> </span><a href="#local-6989586621681118007"><span class="hs-identifier hs-var">non_voids</span></a><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>            </span><a name="local-6989586621681118009"><a href="#local-6989586621681118009"><span class="hs-identifier">do_pushery</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118012"><a href="#local-6989586621681118012"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681118013"><a href="#local-6989586621681118013"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118014"><a href="#local-6989586621681118014"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-807"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621681118017"><a href="#local-6989586621681118017"><span class="hs-identifier">push</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118018"><a href="#local-6989586621681118018"><span class="hs-identifier">arg_bytes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118013"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-808"></a><span>                    </span><span class="hs-special">(</span><a href="StgCmmLayout.html#Padding"><span class="hs-identifier hs-var">Padding</span></a><span> </span><a name="local-6989586621681118015"><a href="#local-6989586621681118015"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="ByteCodeGen.html#pushPadding"><span class="hs-identifier hs-var">pushPadding</span></a><span> </span><a href="#local-6989586621681118015"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-809"></a><span>                    </span><span class="hs-special">(</span><a href="StgCmmLayout.html#FieldOff"><span class="hs-identifier hs-var">FieldOff</span></a><span> </span><a name="local-6989586621681118016"><a href="#local-6989586621681118016"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#pushConstrAtom"><span class="hs-identifier hs-var">pushConstrAtom</span></a><span> </span><a href="#local-6989586621681118012"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118002"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span> </span><a href="#local-6989586621681118016"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-810"></a><span>                </span><a name="local-6989586621681118019"><a href="#local-6989586621681118019"><span class="hs-identifier">more_push_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118009"><span class="hs-identifier hs-var">do_pushery</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118012"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118018"><span class="hs-identifier hs-var">arg_bytes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118014"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-811"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118017"><span class="hs-identifier hs-var">push</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118019"><span class="hs-identifier hs-var">more_push_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>            </span><span class="hs-identifier">do_pushery</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118020"><a href="#local-6989586621681118020"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-813"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118021"><a href="#local-6989586621681118021"><span class="hs-identifier">n_arg_words</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118006"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118020"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118001"><span class="hs-identifier hs-var">orig_d</span></a><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PACK"><span class="hs-identifier hs-var">PACK</span></a><span> </span><a href="#local-6989586621681118003"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621681118021"><span class="hs-identifier hs-var">n_arg_words</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span>        </span><span class="hs-comment">-- Push on the stack in the reverse order.</span><span>
</span><a name="line-817"></a><span>        </span><a href="#local-6989586621681118009"><span class="hs-identifier hs-var">do_pushery</span></a><span> </span><a href="#local-6989586621681118001"><span class="hs-identifier hs-var">orig_d</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621681118008"><span class="hs-identifier hs-var">args_offsets</span></a><span class="hs-special">)</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-821"></a><span class="hs-comment">-- Returning an unboxed tuple with one non-void component (the only</span><span>
</span><a name="line-822"></a><span class="hs-comment">-- case we can handle).</span><span>
</span><a name="line-823"></a><span class="hs-comment">--</span><span>
</span><a name="line-824"></a><span class="hs-comment">-- Remember, we don't want to *evaluate* the component that is being</span><span>
</span><a name="line-825"></a><span class="hs-comment">-- returned, even if it is a pointed type.  We always just return.</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span class="hs-identifier">unboxedTupleReturn</span><span>
</span><a name="line-828"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-829"></a><a name="unboxedTupleReturn"><a href="ByteCodeGen.html#unboxedTupleReturn"><span class="hs-identifier">unboxedTupleReturn</span></a></a><span> </span><a name="local-6989586621681118022"><a href="#local-6989586621681118022"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118023"><a href="#local-6989586621681118023"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681118024"><a href="#local-6989586621681118024"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118025"><a href="#local-6989586621681118025"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#returnUnboxedAtom"><span class="hs-identifier hs-var">returnUnboxedAtom</span></a><span> </span><a href="#local-6989586621681118022"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118023"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681118024"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118025"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#atomRep"><span class="hs-identifier hs-var">atomRep</span></a><span> </span><a href="#local-6989586621681118025"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-832"></a><span class="hs-comment">-- Generate code for a tail-call</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-identifier">doTailCall</span><span>
</span><a name="line-835"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-836"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-837"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-838"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-839"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">]</span><span>
</span><a name="line-840"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-841"></a><a name="doTailCall"><a href="ByteCodeGen.html#doTailCall"><span class="hs-identifier">doTailCall</span></a></a><span> </span><a name="local-6989586621681118026"><a href="#local-6989586621681118026"><span class="hs-identifier">init_d</span></a></a><span> </span><a name="local-6989586621681118027"><a href="#local-6989586621681118027"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681118028"><a href="#local-6989586621681118028"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118029"><a href="#local-6989586621681118029"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621681118030"><a href="#local-6989586621681118030"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118031"><span class="hs-identifier hs-var">do_pushes</span></a><span> </span><a href="#local-6989586621681118026"><span class="hs-identifier hs-var">init_d</span></a><span> </span><a href="#local-6989586621681118030"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="ByteCodeGen.html#atomRep"><span class="hs-identifier hs-var">atomRep</span></a><span> </span><a href="#local-6989586621681118030"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-842"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-843"></a><span>  </span><a name="local-6989586621681118031"><a href="#local-6989586621681118031"><span class="hs-identifier">do_pushes</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118033"><a href="#local-6989586621681118033"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681118034"><a href="#local-6989586621681118034"><span class="hs-identifier">reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-844"></a><span>        </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">reps</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681118035"><a href="#local-6989586621681118035"><span class="hs-identifier">push_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118036"><a href="#local-6989586621681118036"><span class="hs-identifier">sz</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118033"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118028"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a href="#local-6989586621681118029"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>        </span><a name="local-6989586621681118037"><a href="#local-6989586621681118037"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-847"></a><span>        </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sz</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">wordSize</span><span> </span><span class="hs-identifier">dflags</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118038"><a href="#local-6989586621681118038"><span class="hs-identifier">slide</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#mkSlideB"><span class="hs-identifier hs-var">mkSlideB</span></a><span> </span><a href="#local-6989586621681118037"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118033"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118026"><span class="hs-identifier hs-var">init_d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118037"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118026"><span class="hs-identifier hs-var">init_d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118027"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118035"><span class="hs-identifier hs-var">push_fn</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118038"><span class="hs-identifier hs-var">slide</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="ByteCodeInstr.html#ENTER"><span class="hs-identifier hs-var">ENTER</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-850"></a><span>  </span><span class="hs-identifier">do_pushes</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118039"><a href="#local-6989586621681118039"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118040"><a href="#local-6989586621681118040"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681118041"><a href="#local-6989586621681118041"><span class="hs-identifier">reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-851"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681118042"><a href="#local-6989586621681118042"><span class="hs-identifier">push_apply</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118043"><a href="#local-6989586621681118043"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118044"><a href="#local-6989586621681118044"><span class="hs-identifier">rest_of_reps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#findPushSeq"><span class="hs-identifier hs-var">findPushSeq</span></a><span> </span><a href="#local-6989586621681118041"><span class="hs-identifier hs-var">reps</span></a><span>
</span><a name="line-852"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621681118045"><a href="#local-6989586621681118045"><span class="hs-identifier">these_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118046"><a href="#local-6989586621681118046"><span class="hs-identifier">rest_of_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621681118043"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681118040"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-853"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621681118047"><a href="#local-6989586621681118047"><span class="hs-identifier">next_d</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118048"><a href="#local-6989586621681118048"><span class="hs-identifier">push_code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118032"><span class="hs-identifier hs-var">push_seq</span></a><span> </span><a href="#local-6989586621681118039"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118045"><span class="hs-identifier hs-var">these_args</span></a><span>
</span><a name="line-854"></a><span>      </span><a name="local-6989586621681118049"><a href="#local-6989586621681118049"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-855"></a><span>      </span><a name="local-6989586621681118050"><a href="#local-6989586621681118050"><span class="hs-identifier">instrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118031"><span class="hs-identifier hs-var">do_pushes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118047"><span class="hs-identifier hs-var">next_d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118049"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118046"><span class="hs-identifier hs-var">rest_of_args</span></a><span> </span><a href="#local-6989586621681118044"><span class="hs-identifier hs-var">rest_of_reps</span></a><span>
</span><a name="line-856"></a><span>      </span><span class="hs-comment">--                          ^^^ for the PUSH_APPLY_ instruction</span><span>
</span><a name="line-857"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118048"><span class="hs-identifier hs-var">push_code</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118042"><span class="hs-identifier hs-var">push_apply</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118050"><span class="hs-identifier hs-var">instrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span>  </span><a name="local-6989586621681118032"><a href="#local-6989586621681118032"><span class="hs-identifier">push_seq</span></a></a><span> </span><a name="local-6989586621681118051"><a href="#local-6989586621681118051"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118051"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>  </span><span class="hs-identifier">push_seq</span><span> </span><a name="local-6989586621681118052"><a href="#local-6989586621681118052"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681118053"><a href="#local-6989586621681118053"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681118054"><a href="#local-6989586621681118054"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-861"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681118055"><a href="#local-6989586621681118055"><span class="hs-identifier">push_code</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118056"><a href="#local-6989586621681118056"><span class="hs-identifier">sz</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118052"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118028"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118053"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-862"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681118057"><a href="#local-6989586621681118057"><span class="hs-identifier">final_d</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118058"><a href="#local-6989586621681118058"><span class="hs-identifier">more_push_code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118032"><span class="hs-identifier hs-var">push_seq</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118052"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118056"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118054"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-863"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118057"><span class="hs-identifier hs-var">final_d</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118055"><span class="hs-identifier hs-var">push_code</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118058"><span class="hs-identifier hs-var">more_push_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-comment">-- v. similar to CgStackery.findMatch, ToDo: merge</span><span>
</span><a name="line-866"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#BCInstr"><span class="hs-identifier hs-type">BCInstr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-867"></a><a name="findPushSeq"><a href="ByteCodeGen.html#findPushSeq"><span class="hs-identifier">findPushSeq</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118059"><a href="#local-6989586621681118059"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-868"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_PPPPPP"><span class="hs-identifier hs-var">PUSH_APPLY_PPPPPP</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">6</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118059"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118060"><a href="#local-6989586621681118060"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_PPPPP"><span class="hs-identifier hs-var">PUSH_APPLY_PPPPP</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">5</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118060"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-871"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118061"><a href="#local-6989586621681118061"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_PPPP"><span class="hs-identifier hs-var">PUSH_APPLY_PPPP</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">4</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118061"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-873"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118062"><a href="#local-6989586621681118062"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_PPP"><span class="hs-identifier hs-var">PUSH_APPLY_PPP</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">3</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118062"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118063"><a href="#local-6989586621681118063"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_PP"><span class="hs-identifier hs-var">PUSH_APPLY_PP</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118063"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118064"><a href="#local-6989586621681118064"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_P"><span class="hs-identifier hs-var">PUSH_APPLY_P</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118064"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-879"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#V"><span class="hs-identifier hs-var">V</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118065"><a href="#local-6989586621681118065"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-880"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_V"><span class="hs-identifier hs-var">PUSH_APPLY_V</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118065"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-881"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118066"><a href="#local-6989586621681118066"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-882"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_N"><span class="hs-identifier hs-var">PUSH_APPLY_N</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118066"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#F"><span class="hs-identifier hs-var">F</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118067"><a href="#local-6989586621681118067"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-884"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_F"><span class="hs-identifier hs-var">PUSH_APPLY_F</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118067"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-885"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#D"><span class="hs-identifier hs-var">D</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118068"><a href="#local-6989586621681118068"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-886"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_D"><span class="hs-identifier hs-var">PUSH_APPLY_D</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118068"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-887"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#L"><span class="hs-identifier hs-var">L</span></a><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681118069"><a href="#local-6989586621681118069"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-888"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_APPLY_L"><span class="hs-identifier hs-var">PUSH_APPLY_L</span></a><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118069"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-889"></a><span class="hs-identifier">findPushSeq</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-890"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.findPushSeq&quot;</span><span>
</span><a name="line-891"></a><span>
</span><a name="line-892"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-893"></a><span class="hs-comment">-- Case expressions</span><span>
</span><a name="line-894"></a><span>
</span><a name="line-895"></a><span class="hs-identifier">doCase</span><span>
</span><a name="line-896"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-897"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-898"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-899"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-900"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-901"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnAlt</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">]</span><span>
</span><a name="line-902"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span>  </span><span class="hs-comment">-- Just x &lt;=&gt; is an unboxed tuple case with scrut binder,</span><span>
</span><a name="line-903"></a><span>                 </span><span class="hs-comment">-- don't enter the result</span><span>
</span><a name="line-904"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-905"></a><a name="doCase"><a href="ByteCodeGen.html#doCase"><span class="hs-identifier">doCase</span></a></a><span> </span><a name="local-6989586621681118070"><a href="#local-6989586621681118070"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118071"><a href="#local-6989586621681118071"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681118072"><a href="#local-6989586621681118072"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118073"><a href="#local-6989586621681118073"><span class="hs-identifier">scrut</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118074"><a href="#local-6989586621681118074"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681118075"><a href="#local-6989586621681118075"><span class="hs-identifier">alts</span></a></a><span> </span><a name="local-6989586621681118076"><a href="#local-6989586621681118076"><span class="hs-identifier">is_unboxed_tuple</span></a></a><span>
</span><a name="line-906"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118074"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-907"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#multiValException"><span class="hs-identifier hs-var">multiValException</span></a><span>
</span><a name="line-908"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-909"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-910"></a><span>     </span><a name="local-6989586621681118077"><a href="#local-6989586621681118077"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-911"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-912"></a><span>        </span><a name="local-6989586621681118078"><a href="#local-6989586621681118078"><span class="hs-identifier">profiling</span></a></a><span>
</span><a name="line-913"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-914"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rtsIsProfiled</span><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span>        </span><span class="hs-comment">-- Top of stack is the return itbl, as usual.</span><span>
</span><a name="line-917"></a><span>        </span><span class="hs-comment">-- underneath it is the pointer to the alt_code BCO.</span><span>
</span><a name="line-918"></a><span>        </span><span class="hs-comment">-- When an alt is entered, it assumes the returned value is</span><span>
</span><a name="line-919"></a><span>        </span><span class="hs-comment">-- on top of the itbl.</span><span>
</span><a name="line-920"></a><span>        </span><span class="hs-identifier">ret_frame_size_b</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-921"></a><span>        </span><a name="local-6989586621681118079"><a href="#local-6989586621681118079"><span class="hs-identifier">ret_frame_size_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span>        </span><span class="hs-comment">-- The extra frame we push to save/restor the CCCS when profiling</span><span>
</span><a name="line-924"></a><span>        </span><a name="local-6989586621681118080"><a href="#local-6989586621681118080"><span class="hs-identifier">save_ccs_size_b</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118078"><span class="hs-identifier hs-var">profiling</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-925"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span>        </span><span class="hs-comment">-- An unlifted value gets an extra info table pushed on top</span><span>
</span><a name="line-928"></a><span>        </span><span class="hs-comment">-- when it is returned.</span><span>
</span><a name="line-929"></a><span>        </span><span class="hs-identifier">unlifted_itbl_size_b</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-930"></a><span>        </span><a name="local-6989586621681118081"><a href="#local-6989586621681118081"><span class="hs-identifier">unlifted_itbl_size_b</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118087"><span class="hs-identifier hs-var">isAlgCase</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-931"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-932"></a><span>
</span><a name="line-933"></a><span>        </span><span class="hs-comment">-- depth of stack after the return value has been pushed</span><span>
</span><a name="line-934"></a><span>        </span><a name="local-6989586621681118082"><a href="#local-6989586621681118082"><span class="hs-identifier">d_bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-935"></a><span>            </span><a href="#local-6989586621681118070"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118079"><span class="hs-identifier hs-var">ret_frame_size_b</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#idSizeW"><span class="hs-identifier hs-var">idSizeW</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118074"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span>        </span><span class="hs-comment">-- depth of stack after the extra info table for an unboxed return</span><span>
</span><a name="line-938"></a><span>        </span><span class="hs-comment">-- has been pushed, if any.  This is the stack depth at the</span><span>
</span><a name="line-939"></a><span>        </span><span class="hs-comment">-- continuation.</span><span>
</span><a name="line-940"></a><span>        </span><a name="local-6989586621681118083"><a href="#local-6989586621681118083"><span class="hs-identifier">d_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118082"><span class="hs-identifier hs-var">d_bndr</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118081"><span class="hs-identifier hs-var">unlifted_itbl_size_b</span></a><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>        </span><span class="hs-comment">-- Env in which to compile the alts, not including</span><span>
</span><a name="line-943"></a><span>        </span><span class="hs-comment">-- any vars bound by the alts themselves</span><span>
</span><a name="line-944"></a><span>        </span><a name="local-6989586621681118084"><a href="#local-6989586621681118084"><span class="hs-identifier">p_alts0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621681118074"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681118082"><span class="hs-identifier hs-var">d_bndr</span></a><span> </span><a href="#local-6989586621681118072"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span>        </span><a name="local-6989586621681118085"><a href="#local-6989586621681118085"><span class="hs-identifier">p_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118076"><span class="hs-identifier hs-var">is_unboxed_tuple</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-947"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118094"><a href="#local-6989586621681118094"><span class="hs-identifier">ubx_bndr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621681118094"><span class="hs-identifier hs-var">ubx_bndr</span></a><span> </span><a href="#local-6989586621681118082"><span class="hs-identifier hs-var">d_bndr</span></a><span> </span><a href="#local-6989586621681118084"><span class="hs-identifier hs-var">p_alts0</span></a><span>
</span><a name="line-948"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118084"><span class="hs-identifier hs-var">p_alts0</span></a><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span>        </span><a name="local-6989586621681118086"><a href="#local-6989586621681118086"><span class="hs-identifier">bndr_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118074"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-951"></a><span>        </span><a name="local-6989586621681118087"><a href="#local-6989586621681118087"><span class="hs-identifier">isAlgCase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621681118086"><span class="hs-identifier hs-var">bndr_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621681118076"><span class="hs-identifier hs-var">is_unboxed_tuple</span></a><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span>        </span><span class="hs-comment">-- given an alt, return a discr and code for it.</span><span>
</span><a name="line-954"></a><span>        </span><a name="local-6989586621681118088"><a href="#local-6989586621681118088"><span class="hs-identifier">codeAlt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118095"><a href="#local-6989586621681118095"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118096"><a href="#local-6989586621681118096"><span class="hs-identifier">rhs_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681118083"><span class="hs-identifier hs-var">d_alts</span></a><span> </span><a href="#local-6989586621681118071"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681118085"><span class="hs-identifier hs-var">p_alts</span></a><span> </span><a href="#local-6989586621681118095"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-956"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118096"><span class="hs-identifier hs-var">rhs_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-957"></a><span>
</span><a name="line-958"></a><span>        </span><span class="hs-identifier">codeAlt</span><span> </span><a name="local-6989586621681118097"><a href="#local-6989586621681118097"><span class="hs-identifier">alt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681118098"><a href="#local-6989586621681118098"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118099"><a href="#local-6989586621681118099"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>           </span><span class="hs-comment">-- primitive or nullary constructor alt: no need to UNPACK</span><span>
</span><a name="line-960"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681118100"><span class="hs-identifier hs-var">real_bndrs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-961"></a><span>                </span><a name="local-6989586621681118101"><a href="#local-6989586621681118101"><span class="hs-identifier">rhs_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681118083"><span class="hs-identifier hs-var">d_alts</span></a><span> </span><a href="#local-6989586621681118071"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681118085"><span class="hs-identifier hs-var">p_alts</span></a><span> </span><a href="#local-6989586621681118099"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-962"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118089"><span class="hs-identifier hs-var">my_discr</span></a><span> </span><a href="#local-6989586621681118097"><span class="hs-identifier hs-var">alt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118101"><span class="hs-identifier hs-var">rhs_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>           </span><span class="hs-comment">-- If an alt attempts to match on an unboxed tuple or sum, we must</span><span>
</span><a name="line-964"></a><span>           </span><span class="hs-comment">-- bail out, as the bytecode compiler can't handle them.</span><span>
</span><a name="line-965"></a><span>           </span><span class="hs-comment">-- (See Trac #14608.)</span><span>
</span><a name="line-966"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681118102"><a href="#local-6989586621681118102"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118102"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118098"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-967"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#multiValException"><span class="hs-identifier hs-var">multiValException</span></a><span>
</span><a name="line-968"></a><span>           </span><span class="hs-comment">-- algebraic alt with some binders</span><span>
</span><a name="line-969"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-970"></a><span>             </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681118103"><a href="#local-6989586621681118103"><span class="hs-identifier">tot_wds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118104"><a href="#local-6989586621681118104"><span class="hs-identifier">_ptrs_wds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118105"><a href="#local-6989586621681118105"><span class="hs-identifier">args_offsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-971"></a><span>                     </span><a href="StgCmmLayout.html#mkVirtHeapOffsets"><span class="hs-identifier hs-var">mkVirtHeapOffsets</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="StgCmmLayout.html#NoHeader"><span class="hs-identifier hs-var">NoHeader</span></a><span>
</span><a name="line-972"></a><span>                         </span><span class="hs-special">[</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#bcIdPrimRep"><span class="hs-identifier hs-var">bcIdPrimRep</span></a><span> </span><a href="#local-6989586621681118109"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118109"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-973"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a name="local-6989586621681118109"><a href="#local-6989586621681118109"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span> </span><a href="#local-6989586621681118100"><span class="hs-identifier hs-var">real_bndrs</span></a><span>
</span><a name="line-974"></a><span>                         </span><span class="hs-special">]</span><span>
</span><a name="line-975"></a><span>                 </span><a name="local-6989586621681118106"><a href="#local-6989586621681118106"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-var">WordOff</span></a><span> </span><a href="#local-6989586621681118103"><span class="hs-identifier hs-var">tot_wds</span></a><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span>                 </span><a name="local-6989586621681118107"><a href="#local-6989586621681118107"><span class="hs-identifier">stack_bot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118083"><span class="hs-identifier hs-var">d_alts</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118106"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><span>                 </span><span class="hs-comment">-- convert offsets from Sp into offsets into the virtual stack</span><span>
</span><a name="line-980"></a><span>                 </span><a name="local-6989586621681118108"><a href="#local-6989586621681118108"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insertList</span><span>
</span><a name="line-981"></a><span>                        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118110"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118107"><span class="hs-identifier hs-var">stack_bot</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-var">ByteOff</span></a><span> </span><a href="#local-6989586621681118111"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a name="local-6989586621681118110"><a href="#local-6989586621681118110"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118111"><a href="#local-6989586621681118111"><span class="hs-identifier">offset</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118105"><span class="hs-identifier hs-var">args_offsets</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-983"></a><span>                        </span><a href="#local-6989586621681118085"><span class="hs-identifier hs-var">p_alts</span></a><span>
</span><a name="line-984"></a><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-985"></a><span>             </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isAlgCase</span><span class="hs-special">)</span><span>
</span><a name="line-986"></a><span>             </span><a name="local-6989586621681118112"><a href="#local-6989586621681118112"><span class="hs-identifier">rhs_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><a href="#local-6989586621681118107"><span class="hs-identifier hs-var">stack_bot</span></a><span> </span><a href="#local-6989586621681118071"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681118108"><span class="hs-identifier hs-var">p'</span></a><span> </span><a href="#local-6989586621681118099"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-987"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118089"><span class="hs-identifier hs-var">my_discr</span></a><span> </span><a href="#local-6989586621681118097"><span class="hs-identifier hs-var">alt</span></a><span class="hs-special">,</span><span>
</span><a name="line-988"></a><span>                     </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#UNPACK"><span class="hs-identifier hs-var">UNPACK</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><a href="#local-6989586621681118106"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118112"><span class="hs-identifier hs-var">rhs_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>           </span><span class="hs-keyword">where</span><span>
</span><a name="line-990"></a><span>             </span><a name="local-6989586621681118100"><a href="#local-6989586621681118100"><span class="hs-identifier">real_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621681118098"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-991"></a><span>
</span><a name="line-992"></a><span>        </span><a name="local-6989586621681118089"><a href="#local-6989586621681118089"><span class="hs-identifier">my_discr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span> </span><span class="hs-comment">{-shouldn't really happen-}</span><span>
</span><a name="line-993"></a><span>        </span><span class="hs-identifier">my_discr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621681118113"><a href="#local-6989586621681118113"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleCon</span><span> </span><a href="#local-6989586621681118113"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isUnboxedSumCon</span><span> </span><a href="#local-6989586621681118113"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-995"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#multiValException"><span class="hs-identifier hs-var">multiValException</span></a><span>
</span><a name="line-996"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-997"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTag</span><span> </span><a href="#local-6989586621681118113"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">fIRST_TAG</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>        </span><span class="hs-identifier">my_discr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitAlt</span><span> </span><a name="local-6989586621681118114"><a href="#local-6989586621681118114"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118114"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumInt</span><span> </span><a name="local-6989586621681118115"><a href="#local-6989586621681118115"><span class="hs-identifier">i</span></a></a><span>  </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromInteger</span><span> </span><a href="#local-6989586621681118115"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>                       </span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumWord</span><span> </span><a name="local-6989586621681118116"><a href="#local-6989586621681118116"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromInteger</span><span> </span><a href="#local-6989586621681118116"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>                       </span><span class="hs-identifier hs-var">LitFloat</span><span> </span><a name="local-6989586621681118117"><a href="#local-6989586621681118117"><span class="hs-identifier">r</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromRational</span><span> </span><a href="#local-6989586621681118117"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>                       </span><span class="hs-identifier hs-var">LitDouble</span><span> </span><a name="local-6989586621681118118"><a href="#local-6989586621681118118"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromRational</span><span> </span><a href="#local-6989586621681118118"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>                       </span><span class="hs-identifier hs-var">LitChar</span><span> </span><a name="local-6989586621681118119"><a href="#local-6989586621681118119"><span class="hs-identifier">i</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ord</span><span> </span><a href="#local-6989586621681118119"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>                       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;schemeE(AnnCase).my_discr&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681118114"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span>        </span><a name="local-6989586621681118090"><a href="#local-6989586621681118090"><span class="hs-identifier">maybe_ncons</span></a></a><span>
</span><a name="line-1007"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681118087"><span class="hs-identifier hs-var">isAlgCase</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1008"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1009"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681118120"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621681118120"><a href="#local-6989586621681118120"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118075"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1010"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1011"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621681118121"><a href="#local-6989586621681118121"><span class="hs-identifier">dc</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConFamilySize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621681118121"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span>        </span><span class="hs-comment">-- the bitmap is relative to stack depth d, i.e. before the</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-comment">-- BCO, info table and return value are pushed on.</span><span>
</span><a name="line-1015"></a><span>        </span><span class="hs-comment">-- This bit of code is v. similar to buildLivenessMask in CgBindery,</span><span>
</span><a name="line-1016"></a><span>        </span><span class="hs-comment">-- except that here we build the bitmap from the known bindings of</span><span>
</span><a name="line-1017"></a><span>        </span><span class="hs-comment">-- things that are pointers, whereas in CgBindery the code builds the</span><span>
</span><a name="line-1018"></a><span>        </span><span class="hs-comment">-- bitmap from the free slots and unboxed bindings.</span><span>
</span><a name="line-1019"></a><span>        </span><span class="hs-comment">-- (ToDo: merge?)</span><span>
</span><a name="line-1020"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-comment">-- NOTE [7/12/2006] bug #1013, testcase ghci/should_run/ghci002.</span><span>
</span><a name="line-1022"></a><span>        </span><span class="hs-comment">-- The bitmap must cover the portion of the stack up to the sequel only.</span><span>
</span><a name="line-1023"></a><span>        </span><span class="hs-comment">-- Previously we were building a bitmap for the whole depth (d), but we</span><span>
</span><a name="line-1024"></a><span>        </span><span class="hs-comment">-- really want a bitmap up to depth (d-s).  This affects compilation of</span><span>
</span><a name="line-1025"></a><span>        </span><span class="hs-comment">-- case-of-case expressions, which is the only time we can be compiling a</span><span>
</span><a name="line-1026"></a><span>        </span><span class="hs-comment">-- case expression with s /= 0.</span><span>
</span><a name="line-1027"></a><span>        </span><a name="local-6989586621681118091"><a href="#local-6989586621681118091"><span class="hs-identifier">bitmap_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118070"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118071"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1028"></a><span>        </span><span class="hs-identifier">bitmap_size'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1029"></a><span>        </span><a name="local-6989586621681118092"><a href="#local-6989586621681118092"><span class="hs-identifier">bitmap_size'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681118091"><span class="hs-identifier hs-var">bitmap_size</span></a><span>
</span><a name="line-1030"></a><span>        </span><a name="local-6989586621681118093"><a href="#local-6989586621681118093"><span class="hs-identifier">bitmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bitmap.html#intsToReverseBitmap"><span class="hs-identifier hs-var">intsToReverseBitmap</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118092"><span class="hs-identifier hs-var">bitmap_size'</span></a><span class="hs-comment">{-size-}</span><span>
</span><a name="line-1031"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621681118092"><span class="hs-identifier hs-var">bitmap_size'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118123"><span class="hs-identifier hs-var">rel_slots</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-1033"></a><span>          </span><a name="local-6989586621681118122"><a href="#local-6989586621681118122"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681118072"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1034"></a><span>          </span><span class="hs-comment">-- NB: unboxed tuple cases bind the scrut binder to the same offset</span><span>
</span><a name="line-1035"></a><span>          </span><span class="hs-comment">-- as one of the alt binders, so we have to remove any duplicates here:</span><span>
</span><a name="line-1036"></a><span>          </span><a name="local-6989586621681118123"><a href="#local-6989586621681118123"><span class="hs-identifier">rel_slots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681118124"><span class="hs-identifier hs-var">spread</span></a><span> </span><a href="#local-6989586621681118122"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1037"></a><span>          </span><a name="local-6989586621681118124"><a href="#local-6989586621681118124"><span class="hs-identifier">spread</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681118125"><a href="#local-6989586621681118125"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118126"><a href="#local-6989586621681118126"><span class="hs-identifier">offset</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="ByteCodeGen.html#isFollowableArg"><span class="hs-identifier hs-var">isFollowableArg</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#bcIdArgRep"><span class="hs-identifier hs-var">bcIdArgRep</span></a><span> </span><a href="#local-6989586621681118125"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681118127"><span class="hs-identifier hs-var">rel_offset</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1038"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1039"></a><span>                </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681118127"><a href="#local-6989586621681118127"><span class="hs-identifier">rel_offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118070"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118126"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span>     </span><a name="local-6989586621681118128"><a href="#local-6989586621681118128"><span class="hs-identifier">alt_stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621681118088"><span class="hs-identifier hs-var">codeAlt</span></a><span> </span><a href="#local-6989586621681118075"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-1042"></a><span>     </span><a name="local-6989586621681118129"><a href="#local-6989586621681118129"><span class="hs-identifier">alt_final</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#mkMultiBranch"><span class="hs-identifier hs-var">mkMultiBranch</span></a><span> </span><a href="#local-6989586621681118090"><span class="hs-identifier hs-var">maybe_ncons</span></a><span> </span><a href="#local-6989586621681118128"><span class="hs-identifier hs-var">alt_stuff</span></a><span>
</span><a name="line-1043"></a><span>
</span><a name="line-1044"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-1045"></a><span>         </span><a name="local-6989586621681118130"><a href="#local-6989586621681118130"><span class="hs-identifier">alt_bco_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621681118074"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1046"></a><span>         </span><a name="local-6989586621681118131"><a href="#local-6989586621681118131"><span class="hs-identifier">alt_bco</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#mkProtoBCO"><span class="hs-identifier hs-var">mkProtoBCO</span></a><span> </span><a href="#local-6989586621681118077"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118130"><span class="hs-identifier hs-var">alt_bco_name</span></a><span> </span><a href="#local-6989586621681118129"><span class="hs-identifier hs-var">alt_final</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621681118075"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1047"></a><span>                       </span><span class="hs-number">0</span><span class="hs-comment">{-no arity-}</span><span> </span><a href="#local-6989586621681118091"><span class="hs-identifier hs-var">bitmap_size</span></a><span> </span><a href="#local-6989586621681118093"><span class="hs-identifier hs-var">bitmap</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-comment">{-is alts-}</span><span>
</span><a name="line-1048"></a><span class="hs-comment">--     trace (&quot;case: bndr = &quot; ++ showSDocDebug (ppr bndr) ++ &quot;\ndepth = &quot; ++ show d ++ &quot;\nenv = \n&quot; ++ showSDocDebug (ppBCEnv p) ++</span><span>
</span><a name="line-1049"></a><span class="hs-comment">--            &quot;\n      bitmap = &quot; ++ show bitmap) $ do</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span>     </span><a name="local-6989586621681118132"><a href="#local-6989586621681118132"><span class="hs-identifier">scrut_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#schemeE"><span class="hs-identifier hs-var">schemeE</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118070"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118079"><span class="hs-identifier hs-var">ret_frame_size_b</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118080"><span class="hs-identifier hs-var">save_ccs_size_b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>                           </span><span class="hs-special">(</span><a href="#local-6989586621681118070"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118079"><span class="hs-identifier hs-var">ret_frame_size_b</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118080"><span class="hs-identifier hs-var">save_ccs_size_b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1053"></a><span>                           </span><a href="#local-6989586621681118072"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118073"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-1054"></a><span>     </span><a name="local-6989586621681118133"><a href="#local-6989586621681118133"><span class="hs-identifier">alt_bco'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#emitBc"><span class="hs-identifier hs-var">emitBc</span></a><span> </span><a href="#local-6989586621681118131"><span class="hs-identifier hs-var">alt_bco</span></a><span>
</span><a name="line-1055"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118134"><a href="#local-6989586621681118134"><span class="hs-identifier">push_alts</span></a></a><span>
</span><a name="line-1056"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118087"><span class="hs-identifier hs-var">isAlgCase</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#PUSH_ALTS"><span class="hs-identifier hs-var">PUSH_ALTS</span></a><span> </span><a href="#local-6989586621681118133"><span class="hs-identifier hs-var">alt_bco'</span></a><span>
</span><a name="line-1057"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#PUSH_ALTS_UNLIFTED"><span class="hs-identifier hs-var">PUSH_ALTS_UNLIFTED</span></a><span> </span><a href="#local-6989586621681118133"><span class="hs-identifier hs-var">alt_bco'</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#typeArgRep"><span class="hs-identifier hs-var">typeArgRep</span></a><span> </span><a href="#local-6989586621681118086"><span class="hs-identifier hs-var">bndr_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1058"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118134"><span class="hs-identifier hs-var">push_alts</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118132"><span class="hs-identifier hs-var">scrut_code</span></a><span class="hs-special">)</span><span>
</span><a name="line-1059"></a><span>
</span><a name="line-1060"></a><span>
</span><a name="line-1061"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1062"></a><span class="hs-comment">-- Deal with a CCall.</span><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span class="hs-comment">-- Taggedly push the args onto the stack R-&gt;L,</span><span>
</span><a name="line-1065"></a><span class="hs-comment">-- deferencing ForeignObj#s and adjusting addrs to point to</span><span>
</span><a name="line-1066"></a><span class="hs-comment">-- payloads in Ptr/Byte arrays.  Then, generate the marshalling</span><span>
</span><a name="line-1067"></a><span class="hs-comment">-- (machine) code for the ccall, and create bytecodes to call that and</span><span>
</span><a name="line-1068"></a><span class="hs-comment">-- then return in the right way.</span><span>
</span><a name="line-1069"></a><span>
</span><a name="line-1070"></a><span class="hs-identifier">generateCCall</span><span>
</span><a name="line-1071"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-1073"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-1074"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CCallSpec</span><span>               </span><span class="hs-comment">-- where to call</span><span>
</span><a name="line-1075"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                      </span><span class="hs-comment">-- of target, for type info</span><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- args (atoms)</span><span>
</span><a name="line-1077"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-1078"></a><a name="generateCCall"><a href="ByteCodeGen.html#generateCCall"><span class="hs-identifier">generateCCall</span></a></a><span> </span><a name="local-6989586621681118135"><a href="#local-6989586621681118135"><span class="hs-identifier">d0</span></a></a><span> </span><a name="local-6989586621681118136"><a href="#local-6989586621681118136"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681118137"><a href="#local-6989586621681118137"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCallSpec</span><span> </span><a name="local-6989586621681118138"><a href="#local-6989586621681118138"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621681118139"><a href="#local-6989586621681118139"><span class="hs-identifier">cconv</span></a></a><span> </span><a name="local-6989586621681118140"><a href="#local-6989586621681118140"><span class="hs-identifier">safety</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118141"><a href="#local-6989586621681118141"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621681118142"><a href="#local-6989586621681118142"><span class="hs-identifier">args_r_to_l</span></a></a><span>
</span><a name="line-1079"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1080"></a><span>     </span><a name="local-6989586621681118143"><a href="#local-6989586621681118143"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-1083"></a><span>         </span><span class="hs-comment">-- useful constants</span><span>
</span><a name="line-1084"></a><span>         </span><span class="hs-identifier">addr_size_b</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-1085"></a><span>         </span><a name="local-6989586621681118144"><a href="#local-6989586621681118144"><span class="hs-identifier">addr_size_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1086"></a><span>
</span><a name="line-1087"></a><span>         </span><span class="hs-comment">-- Get the args on the stack, with tags and suitably</span><span>
</span><a name="line-1088"></a><span>         </span><span class="hs-comment">-- dereferenced for the CCall.  For each arg, return the</span><span>
</span><a name="line-1089"></a><span>         </span><span class="hs-comment">-- depth to the first word of the bits for that arg, and the</span><span>
</span><a name="line-1090"></a><span>         </span><span class="hs-comment">-- ArgRep of what was actually pushed.</span><span>
</span><a name="line-1091"></a><span>
</span><a name="line-1092"></a><span>         </span><span class="hs-identifier">pargs</span><span>
</span><a name="line-1093"></a><span>             </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1094"></a><span>         </span><a name="local-6989586621681118145"><a href="#local-6989586621681118145"><span class="hs-identifier">pargs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1095"></a><span>         </span><span class="hs-identifier">pargs</span><span> </span><a name="local-6989586621681118147"><a href="#local-6989586621681118147"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681118148"><a href="#local-6989586621681118148"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681118149"><a href="#local-6989586621681118149"><span class="hs-identifier">az</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1096"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118150"><a href="#local-6989586621681118150"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unwrapType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deAnnotate'</span><span> </span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span><span> </span><a href="#local-6989586621681118150"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1099"></a><span>                    </span><span class="hs-comment">-- Don't push the FO; instead push the Addr# it</span><span>
</span><a name="line-1100"></a><span>                    </span><span class="hs-comment">-- contains.</span><span>
</span><a name="line-1101"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118151"><a href="#local-6989586621681118151"><span class="hs-identifier">t</span></a></a><span>
</span><a name="line-1102"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118151"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">arrayPrimTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681118151"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutableArrayPrimTyCon</span><span>
</span><a name="line-1103"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118152"><a href="#local-6989586621681118152"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118145"><span class="hs-identifier hs-var">pargs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118144"><span class="hs-identifier hs-var">addr_size_b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118149"><span class="hs-identifier hs-var">az</span></a><span>
</span><a name="line-1104"></a><span>                             </span><a name="local-6989586621681118153"><a href="#local-6989586621681118153"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118146"><span class="hs-identifier hs-var">parg_ArrayishRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#arrPtrsHdrSize"><span class="hs-identifier hs-var">arrPtrsHdrSize</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118137"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1105"></a><span>                             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621681118153"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">AddrRep</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621681118152"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1106"></a><span>
</span><a name="line-1107"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118151"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">smallArrayPrimTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681118151"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">smallMutableArrayPrimTyCon</span><span>
</span><a name="line-1108"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118154"><a href="#local-6989586621681118154"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118145"><span class="hs-identifier hs-var">pargs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118144"><span class="hs-identifier hs-var">addr_size_b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118149"><span class="hs-identifier hs-var">az</span></a><span>
</span><a name="line-1109"></a><span>                             </span><a name="local-6989586621681118155"><a href="#local-6989586621681118155"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118146"><span class="hs-identifier hs-var">parg_ArrayishRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#smallArrPtrsHdrSize"><span class="hs-identifier hs-var">smallArrPtrsHdrSize</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118137"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1110"></a><span>                             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621681118155"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">AddrRep</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621681118154"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118151"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">byteArrayPrimTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681118151"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutableByteArrayPrimTyCon</span><span>
</span><a name="line-1113"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118156"><a href="#local-6989586621681118156"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118145"><span class="hs-identifier hs-var">pargs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118144"><span class="hs-identifier hs-var">addr_size_b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118149"><span class="hs-identifier hs-var">az</span></a><span>
</span><a name="line-1114"></a><span>                             </span><a name="local-6989586621681118157"><a href="#local-6989586621681118157"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118146"><span class="hs-identifier hs-var">parg_ArrayishRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#arrWordsHdrSize"><span class="hs-identifier hs-var">arrWordsHdrSize</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118137"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1115"></a><span>                             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621681118157"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">AddrRep</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621681118156"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1116"></a><span>
</span><a name="line-1117"></a><span>                    </span><span class="hs-comment">-- Default case: push taggedly, but otherwise intact.</span><span>
</span><a name="line-1118"></a><span>                    </span><span class="hs-identifier">_</span><span>
</span><a name="line-1119"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681118158"><a href="#local-6989586621681118158"><span class="hs-identifier">code_a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118159"><a href="#local-6989586621681118159"><span class="hs-identifier">sz_a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118137"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1120"></a><span>                             </span><a name="local-6989586621681118160"><a href="#local-6989586621681118160"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118145"><span class="hs-identifier hs-var">pargs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118147"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118159"><span class="hs-identifier hs-var">sz_a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118149"><span class="hs-identifier hs-var">az</span></a><span>
</span><a name="line-1121"></a><span>                             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621681118158"><span class="hs-identifier hs-var">code_a</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#atomPrimRep"><span class="hs-identifier hs-var">atomPrimRep</span></a><span> </span><a href="#local-6989586621681118148"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681118160"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span>         </span><span class="hs-comment">-- Do magic for Ptr/Byte arrays.  Push a ptr to the array on</span><span>
</span><a name="line-1124"></a><span>         </span><span class="hs-comment">-- the stack but then advance it over the headers, so as to</span><span>
</span><a name="line-1125"></a><span>         </span><span class="hs-comment">-- point to the payload.</span><span>
</span><a name="line-1126"></a><span>         </span><span class="hs-identifier">parg_ArrayishRep</span><span>
</span><a name="line-1127"></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-1128"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-1129"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-1130"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-1131"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-1132"></a><span>         </span><a name="local-6989586621681118146"><a href="#local-6989586621681118146"><span class="hs-identifier">parg_ArrayishRep</span></a></a><span> </span><a name="local-6989586621681118161"><a href="#local-6989586621681118161"><span class="hs-identifier">hdrSize</span></a></a><span> </span><a name="local-6989586621681118162"><a href="#local-6989586621681118162"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118163"><a href="#local-6989586621681118163"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118164"><a href="#local-6989586621681118164"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-1133"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681118165"><a href="#local-6989586621681118165"><span class="hs-identifier">push_fo</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118162"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118163"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118164"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1134"></a><span>                 </span><span class="hs-comment">-- The ptr points at the header.  Advance it over the</span><span>
</span><a name="line-1135"></a><span>                 </span><span class="hs-comment">-- header and then pretend this is an Addr#.</span><span>
</span><a name="line-1136"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118165"><span class="hs-identifier hs-var">push_fo</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="ByteCodeInstr.html#SWIZZLE"><span class="hs-identifier hs-var">SWIZZLE</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681118161"><span class="hs-identifier hs-var">hdrSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-1137"></a><span>
</span><a name="line-1138"></a><span>     </span><a name="local-6989586621681118166"><a href="#local-6989586621681118166"><span class="hs-identifier">code_n_reps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118145"><span class="hs-identifier hs-var">pargs</span></a><span> </span><a href="#local-6989586621681118135"><span class="hs-identifier hs-var">d0</span></a><span> </span><a href="#local-6989586621681118142"><span class="hs-identifier hs-var">args_r_to_l</span></a><span>
</span><a name="line-1139"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-1140"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681118167"><a href="#local-6989586621681118167"><span class="hs-identifier">pushs_arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118168"><a href="#local-6989586621681118168"><span class="hs-identifier">a_reps_pushed_r_to_l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681118166"><span class="hs-identifier hs-var">code_n_reps</span></a><span>
</span><a name="line-1141"></a><span>         </span><a name="local-6989586621681118169"><a href="#local-6989586621681118169"><span class="hs-identifier">a_reps_sizeW</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#repSizeWords"><span class="hs-identifier hs-var">repSizeWords</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118168"><span class="hs-identifier hs-var">a_reps_pushed_r_to_l</span></a><span class="hs-special">)</span><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span>         </span><a name="local-6989586621681118170"><a href="#local-6989586621681118170"><span class="hs-identifier">push_args</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatOL</span><span> </span><a href="#local-6989586621681118167"><span class="hs-identifier hs-var">pushs_arg</span></a><span>
</span><a name="line-1144"></a><span>         </span><span class="hs-glyph">!</span><a name="local-6989586621681118171"><a href="#local-6989586621681118171"><span class="hs-identifier">d_after_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118135"><span class="hs-identifier hs-var">d0</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118169"><span class="hs-identifier hs-var">a_reps_sizeW</span></a><span>
</span><a name="line-1145"></a><span>         </span><a name="local-6989586621681118172"><a href="#local-6989586621681118172"><span class="hs-identifier">a_reps_pushed_RAW</span></a></a><span>
</span><a name="line-1146"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681118168"><span class="hs-identifier hs-var">a_reps_pushed_r_to_l</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621681118168"><span class="hs-identifier hs-var">a_reps_pushed_r_to_l</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">VoidRep</span><span>
</span><a name="line-1147"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.generateCCall: missing or invalid World token?&quot;</span><span>
</span><a name="line-1148"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1149"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621681118168"><span class="hs-identifier hs-var">a_reps_pushed_r_to_l</span></a><span class="hs-special">)</span><span>
</span><a name="line-1150"></a><span>
</span><a name="line-1151"></a><span>         </span><span class="hs-comment">-- Now: a_reps_pushed_RAW are the reps which are actually on the stack.</span><span>
</span><a name="line-1152"></a><span>         </span><span class="hs-comment">-- push_args is the code to do that.</span><span>
</span><a name="line-1153"></a><span>         </span><span class="hs-comment">-- d_after_args is the stack depth once the args are on.</span><span>
</span><a name="line-1154"></a><span>
</span><a name="line-1155"></a><span>         </span><span class="hs-comment">-- Get the result rep.</span><span>
</span><a name="line-1156"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681118173"><a href="#local-6989586621681118173"><span class="hs-identifier">returns_void</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118174"><a href="#local-6989586621681118174"><span class="hs-identifier">r_rep</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1157"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="ByteCodeGen.html#maybe_getCCallReturnRep"><span class="hs-identifier hs-var">maybe_getCCallReturnRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118141"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1158"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">VoidRep</span><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118176"><a href="#local-6989586621681118176"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118176"><span class="hs-identifier hs-var">rr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1160"></a><span>         </span><span class="hs-comment">{-
         Because the Haskell stack grows down, the a_reps refer to
         lowest to highest addresses in that order.  The args for the call
         are on the stack.  Now push an unboxed Addr# indicating
         the C function to call.  Then push a dummy placeholder for the
         result.  Finally, emit a CCALL insn with an offset pointing to the
         Addr# just pushed, and a literal field holding the mallocville
         address of the piece of marshalling code we generate.
         So, just prior to the CCALL insn, the stack looks like this
         (growing down, as usual):

            &lt;arg_n&gt;
            ...
            &lt;arg_1&gt;
            Addr# address_of_C_fn
            &lt;placeholder-for-result#&gt; (must be an unboxed type)

         The interpreter then calls the marshall code mentioned
         in the CCALL insn, passing it (&amp; &lt;placeholder-for-result#&gt;),
         that is, the addr of the topmost word in the stack.
         When this returns, the placeholder will have been
         filled in.  The placeholder is slid down to the sequel
         depth, and we RETURN.

         This arrangement makes it simple to do f-i-dynamic since the Addr#
         value is the first arg anyway.

         The marshalling code is generated specifically for this
         call site, and so knows exactly the (Haskell) stack
         offsets of the args, fn address and placeholder.  It
         copies the args to the C stack, calls the stacked addr,
         and parks the result back in the placeholder.  The interpreter
         calls it as a normal C call, assuming it has a signature
            void marshall_code ( StgWord* ptr_to_top_of_stack )
         -}</span><span>
</span><a name="line-1195"></a><span>         </span><span class="hs-comment">-- resolve static address</span><span>
</span><a name="line-1196"></a><span>         </span><span class="hs-identifier">maybe_static_target</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Literal</span><span>
</span><a name="line-1197"></a><span>         </span><a name="local-6989586621681118175"><a href="#local-6989586621681118175"><span class="hs-identifier">maybe_static_target</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1198"></a><span>             </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118138"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1199"></a><span>                 </span><span class="hs-identifier hs-var">DynamicTarget</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1200"></a><span>                 </span><span class="hs-identifier hs-var">StaticTarget</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1201"></a><span>                   </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;generateCCall: unexpected FFI value import&quot;</span><span>
</span><a name="line-1202"></a><span>                 </span><span class="hs-identifier hs-var">StaticTarget</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681118177"><a href="#local-6989586621681118177"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1203"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitLabel</span><span> </span><a href="#local-6989586621681118177"><span class="hs-identifier hs-var">target</span></a><span> </span><a href="#local-6989586621681118178"><span class="hs-identifier hs-var">mb_size</span></a><span> </span><span class="hs-identifier hs-var">IsFunction</span><span class="hs-special">)</span><span>
</span><a name="line-1204"></a><span>                   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1205"></a><span>                      </span><a name="local-6989586621681118178"><a href="#local-6989586621681118178"><span class="hs-identifier">mb_size</span></a></a><span>
</span><a name="line-1206"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1207"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">StdCallConv</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118139"><span class="hs-identifier hs-var">cconv</span></a><span>
</span><a name="line-1208"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681118169"><span class="hs-identifier hs-var">a_reps_sizeW</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1209"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1210"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1211"></a><span>
</span><a name="line-1212"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-1213"></a><span>         </span><a name="local-6989586621681118179"><a href="#local-6989586621681118179"><span class="hs-identifier">is_static</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621681118175"><span class="hs-identifier hs-var">maybe_static_target</span></a><span>
</span><a name="line-1214"></a><span>
</span><a name="line-1215"></a><span>         </span><span class="hs-comment">-- Get the arg reps, zapping the leading Addr# in the dynamic case</span><span>
</span><a name="line-1216"></a><span>         </span><a name="local-6989586621681118180"><a href="#local-6989586621681118180"><span class="hs-identifier">a_reps</span></a></a><span> </span><span class="hs-comment">--  | trace (showSDoc (ppr a_reps_pushed_RAW)) False = error &quot;???&quot;</span><span>
</span><a name="line-1217"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118179"><span class="hs-identifier hs-var">is_static</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118172"><span class="hs-identifier hs-var">a_reps_pushed_RAW</span></a><span>
</span><a name="line-1218"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681118172"><span class="hs-identifier hs-var">a_reps_pushed_RAW</span></a><span>
</span><a name="line-1219"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.generateCCall: dyn with no args&quot;</span><span>
</span><a name="line-1220"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621681118172"><span class="hs-identifier hs-var">a_reps_pushed_RAW</span></a><span>
</span><a name="line-1221"></a><span>
</span><a name="line-1222"></a><span>         </span><span class="hs-comment">-- push the Addr#</span><span>
</span><a name="line-1223"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681118181"><a href="#local-6989586621681118181"><span class="hs-identifier">push_Addr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118182"><a href="#local-6989586621681118182"><span class="hs-identifier">d_after_Addr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1224"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118188"><a href="#local-6989586621681118188"><span class="hs-identifier">machlabel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118175"><span class="hs-identifier hs-var">maybe_static_target</span></a><span>
</span><a name="line-1225"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">[</span><a href="ByteCodeInstr.html#PUSH_UBX"><span class="hs-identifier hs-var">PUSH_UBX</span></a><span> </span><a href="#local-6989586621681118188"><span class="hs-identifier hs-var">machlabel</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118171"><span class="hs-identifier hs-var">d_after_args</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118144"><span class="hs-identifier hs-var">addr_size_b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1226"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- is already on the stack</span><span>
</span><a name="line-1227"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118171"><span class="hs-identifier hs-var">d_after_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span>         </span><span class="hs-comment">-- Push the return placeholder.  For a call returning nothing,</span><span>
</span><a name="line-1230"></a><span>         </span><span class="hs-comment">-- this is a V (tag).</span><span>
</span><a name="line-1231"></a><span>         </span><a name="local-6989586621681118183"><a href="#local-6989586621681118183"><span class="hs-identifier">r_sizeW</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#repSizeWords"><span class="hs-identifier hs-var">repSizeWords</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118174"><span class="hs-identifier hs-var">r_rep</span></a><span>
</span><a name="line-1232"></a><span>         </span><a name="local-6989586621681118184"><a href="#local-6989586621681118184"><span class="hs-identifier">d_after_r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118182"><span class="hs-identifier hs-var">d_after_Addr</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118183"><span class="hs-identifier hs-var">r_sizeW</span></a><span>
</span><a name="line-1233"></a><span>         </span><a name="local-6989586621681118185"><a href="#local-6989586621681118185"><span class="hs-identifier">push_r</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1234"></a><span>             </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681118173"><span class="hs-identifier hs-var">returns_void</span></a><span>
</span><a name="line-1235"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-1236"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_UBX"><span class="hs-identifier hs-var">PUSH_UBX</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#mkDummyLiteral"><span class="hs-identifier hs-var">mkDummyLiteral</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118174"><span class="hs-identifier hs-var">r_rep</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><a href="#local-6989586621681118183"><span class="hs-identifier hs-var">r_sizeW</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1237"></a><span>
</span><a name="line-1238"></a><span>         </span><span class="hs-comment">-- generate the marshalling code we're going to call</span><span>
</span><a name="line-1239"></a><span>
</span><a name="line-1240"></a><span>         </span><span class="hs-comment">-- Offset of the next stack frame down the stack.  The CCALL</span><span>
</span><a name="line-1241"></a><span>         </span><span class="hs-comment">-- instruction needs to describe the chunk of stack containing</span><span>
</span><a name="line-1242"></a><span>         </span><span class="hs-comment">-- the ccall args to the GC, so it needs to know how large it</span><span>
</span><a name="line-1243"></a><span>         </span><span class="hs-comment">-- is.  See comment in Interpreter.c with the CCALL instruction.</span><span>
</span><a name="line-1244"></a><span>         </span><a name="local-6989586621681118186"><a href="#local-6989586621681118186"><span class="hs-identifier">stk_offset</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118184"><span class="hs-identifier hs-var">d_after_r</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118136"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1245"></a><span>
</span><a name="line-1246"></a><span>         </span><a name="local-6989586621681118187"><a href="#local-6989586621681118187"><span class="hs-identifier">conv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118139"><span class="hs-identifier hs-var">cconv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1247"></a><span>           </span><span class="hs-identifier hs-var">CCallConv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFICCall</span><span>
</span><a name="line-1248"></a><span>           </span><span class="hs-identifier hs-var">StdCallConv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFIStdCall</span><span>
</span><a name="line-1249"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ByteCodeGen: unexpected calling convention&quot;</span><span>
</span><a name="line-1250"></a><span>
</span><a name="line-1251"></a><span>     </span><span class="hs-comment">-- the only difference in libffi mode is that we prepare a cif</span><span>
</span><a name="line-1252"></a><span>     </span><span class="hs-comment">-- describing the call type by calling libffi, and we attach the</span><span>
</span><a name="line-1253"></a><span>     </span><span class="hs-comment">-- address of this to the CCALL instruction.</span><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><span>
</span><a name="line-1256"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118189"><a href="#local-6989586621681118189"><span class="hs-identifier">ffires</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#primRepToFFIType"><span class="hs-identifier hs-var">primRepToFFIType</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118174"><span class="hs-identifier hs-var">r_rep</span></a><span>
</span><a name="line-1257"></a><span>         </span><a name="local-6989586621681118190"><a href="#local-6989586621681118190"><span class="hs-identifier">ffiargs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#primRepToFFIType"><span class="hs-identifier hs-var">primRepToFFIType</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118180"><span class="hs-identifier hs-var">a_reps</span></a><span>
</span><a name="line-1258"></a><span>     </span><a name="local-6989586621681118191"><a href="#local-6989586621681118191"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1259"></a><span>     </span><a name="local-6989586621681118192"><a href="#local-6989586621681118192"><span class="hs-identifier">token</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#ioToBc"><span class="hs-identifier hs-var">ioToBc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621681118191"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrepFFI</span><span> </span><a href="#local-6989586621681118187"><span class="hs-identifier hs-var">conv</span></a><span> </span><a href="#local-6989586621681118190"><span class="hs-identifier hs-var">ffiargs</span></a><span> </span><a href="#local-6989586621681118189"><span class="hs-identifier hs-var">ffires</span></a><span class="hs-special">)</span><span>
</span><a name="line-1260"></a><span>     </span><a href="ByteCodeGen.html#recordFFIBc"><span class="hs-identifier hs-var">recordFFIBc</span></a><span> </span><a href="#local-6989586621681118192"><span class="hs-identifier hs-var">token</span></a><span>
</span><a name="line-1261"></a><span>
</span><a name="line-1262"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-1263"></a><span>         </span><span class="hs-comment">-- do the call</span><span>
</span><a name="line-1264"></a><span>         </span><a name="local-6989586621681118193"><a href="#local-6989586621681118193"><span class="hs-identifier">do_call</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#CCALL"><span class="hs-identifier hs-var">CCALL</span></a><span> </span><a href="#local-6989586621681118186"><span class="hs-identifier hs-var">stk_offset</span></a><span> </span><a href="#local-6989586621681118192"><span class="hs-identifier hs-var">token</span></a><span> </span><a href="#local-6989586621681118196"><span class="hs-identifier hs-var">flags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1265"></a><span>           </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681118196"><a href="#local-6989586621681118196"><span class="hs-identifier">flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118140"><span class="hs-identifier hs-var">safety</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1266"></a><span>                           </span><span class="hs-identifier hs-var">PlaySafe</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0x0</span><span>
</span><a name="line-1267"></a><span>                           </span><span class="hs-identifier hs-var">PlayInterruptible</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0x1</span><span>
</span><a name="line-1268"></a><span>                           </span><span class="hs-identifier hs-var">PlayRisky</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0x2</span><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span>         </span><span class="hs-comment">-- slide and return</span><span>
</span><a name="line-1271"></a><span>         </span><a name="local-6989586621681118194"><a href="#local-6989586621681118194"><span class="hs-identifier">d_after_r_min_s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118143"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118184"><span class="hs-identifier hs-var">d_after_r</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118136"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1272"></a><span>         </span><a name="local-6989586621681118195"><a href="#local-6989586621681118195"><span class="hs-identifier">wrapup</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#mkSlideW"><span class="hs-identifier hs-var">mkSlideW</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><a href="#local-6989586621681118183"><span class="hs-identifier hs-var">r_sizeW</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118194"><span class="hs-identifier hs-var">d_after_r_min_s</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118183"><span class="hs-identifier hs-var">r_sizeW</span></a><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="ByteCodeInstr.html#RETURN_UBX"><span class="hs-identifier hs-var">RETURN_UBX</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><a href="#local-6989586621681118174"><span class="hs-identifier hs-var">r_rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>         </span><span class="hs-comment">--trace (show (arg1_offW, args_offW  ,  (map argRepSizeW a_reps) )) $</span><span>
</span><a name="line-1275"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1276"></a><span>         </span><a href="#local-6989586621681118170"><span class="hs-identifier hs-var">push_args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span>
</span><a name="line-1277"></a><span>         </span><a href="#local-6989586621681118181"><span class="hs-identifier hs-var">push_Addr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118185"><span class="hs-identifier hs-var">push_r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118193"><span class="hs-identifier hs-var">do_call</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118195"><span class="hs-identifier hs-var">wrapup</span></a><span>
</span><a name="line-1278"></a><span>         </span><span class="hs-special">)</span><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span class="hs-identifier">primRepToFFIType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FFIType</span><span>
</span><a name="line-1281"></a><a name="primRepToFFIType"><a href="ByteCodeGen.html#primRepToFFIType"><span class="hs-identifier">primRepToFFIType</span></a></a><span> </span><a name="local-6989586621681118197"><a href="#local-6989586621681118197"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681118198"><a href="#local-6989586621681118198"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-1282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118198"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1283"></a><span>     </span><span class="hs-identifier hs-var">VoidRep</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFIVoid</span><span>
</span><a name="line-1284"></a><span>     </span><span class="hs-identifier hs-var">IntRep</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118199"><span class="hs-identifier hs-var">signed_word</span></a><span>
</span><a name="line-1285"></a><span>     </span><span class="hs-identifier hs-var">WordRep</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118200"><span class="hs-identifier hs-var">unsigned_word</span></a><span>
</span><a name="line-1286"></a><span>     </span><span class="hs-identifier hs-var">Int64Rep</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFISInt64</span><span>
</span><a name="line-1287"></a><span>     </span><span class="hs-identifier hs-var">Word64Rep</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFIUInt64</span><span>
</span><a name="line-1288"></a><span>     </span><span class="hs-identifier hs-var">AddrRep</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFIPointer</span><span>
</span><a name="line-1289"></a><span>     </span><span class="hs-identifier hs-var">FloatRep</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFIFloat</span><span>
</span><a name="line-1290"></a><span>     </span><span class="hs-identifier hs-var">DoubleRep</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FFIDouble</span><span>
</span><a name="line-1291"></a><span>     </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;primRepToFFIType&quot;</span><span>
</span><a name="line-1292"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1293"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681118199"><a href="#local-6989586621681118199"><span class="hs-identifier">signed_word</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118200"><a href="#local-6989586621681118200"><span class="hs-identifier">unsigned_word</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1294"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681118197"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">4</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FFISInt32</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FFIUInt32</span><span class="hs-special">)</span><span>
</span><a name="line-1295"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681118197"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">8</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FFISInt64</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FFIUInt64</span><span class="hs-special">)</span><span>
</span><a name="line-1296"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;primTyDescChar&quot;</span><span>
</span><a name="line-1297"></a><span>
</span><a name="line-1298"></a><span class="hs-comment">-- Make a dummy literal, to be used as a placeholder for FFI return</span><span>
</span><a name="line-1299"></a><span class="hs-comment">-- values on the stack.</span><span>
</span><a name="line-1300"></a><span class="hs-identifier">mkDummyLiteral</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Literal</span><span>
</span><a name="line-1301"></a><a name="mkDummyLiteral"><a href="ByteCodeGen.html#mkDummyLiteral"><span class="hs-identifier">mkDummyLiteral</span></a></a><span> </span><a name="local-6989586621681118201"><a href="#local-6989586621681118201"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681118202"><a href="#local-6989586621681118202"><span class="hs-identifier">pr</span></a></a><span>
</span><a name="line-1302"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118202"><span class="hs-identifier hs-var">pr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1303"></a><span>        </span><span class="hs-identifier hs-var">IntRep</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkLitInt</span><span> </span><a href="#local-6989586621681118201"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1304"></a><span>        </span><span class="hs-identifier hs-var">WordRep</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkLitWord</span><span> </span><a href="#local-6989586621681118201"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1305"></a><span>        </span><span class="hs-identifier hs-var">Int64Rep</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkLitInt64</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1306"></a><span>        </span><span class="hs-identifier hs-var">Word64Rep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkLitWord64</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1307"></a><span>        </span><span class="hs-identifier hs-var">AddrRep</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">LitNullAddr</span><span>
</span><a name="line-1308"></a><span>        </span><span class="hs-identifier hs-var">DoubleRep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">LitDouble</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1309"></a><span>        </span><span class="hs-identifier hs-var">FloatRep</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">LitFloat</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1310"></a><span>        </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkDummyLiteral&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681118202"><span class="hs-identifier hs-var">pr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span>
</span><a name="line-1313"></a><span class="hs-comment">-- Convert (eg)</span><span>
</span><a name="line-1314"></a><span class="hs-comment">--     GHC.Prim.Char# -&gt; GHC.Prim.State# GHC.Prim.RealWorld</span><span>
</span><a name="line-1315"></a><span class="hs-comment">--                   -&gt; (# GHC.Prim.State# GHC.Prim.RealWorld, GHC.Prim.Int# #)</span><span>
</span><a name="line-1316"></a><span class="hs-comment">--</span><span>
</span><a name="line-1317"></a><span class="hs-comment">-- to  Just IntRep</span><span>
</span><a name="line-1318"></a><span class="hs-comment">-- and check that an unboxed pair is returned wherein the first arg is V'd.</span><span>
</span><a name="line-1319"></a><span class="hs-comment">--</span><span>
</span><a name="line-1320"></a><span class="hs-comment">-- Alternatively, for call-targets returning nothing, convert</span><span>
</span><a name="line-1321"></a><span class="hs-comment">--</span><span>
</span><a name="line-1322"></a><span class="hs-comment">--     GHC.Prim.Char# -&gt; GHC.Prim.State# GHC.Prim.RealWorld</span><span>
</span><a name="line-1323"></a><span class="hs-comment">--                   -&gt; (# GHC.Prim.State# GHC.Prim.RealWorld #)</span><span>
</span><a name="line-1324"></a><span class="hs-comment">--</span><span>
</span><a name="line-1325"></a><span class="hs-comment">-- to  Nothing</span><span>
</span><a name="line-1326"></a><span>
</span><a name="line-1327"></a><span class="hs-identifier">maybe_getCCallReturnRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span>
</span><a name="line-1328"></a><a name="maybe_getCCallReturnRep"><a href="ByteCodeGen.html#maybe_getCCallReturnRep"><span class="hs-identifier">maybe_getCCallReturnRep</span></a></a><span> </span><a name="local-6989586621681118203"><a href="#local-6989586621681118203"><span class="hs-identifier">fn_ty</span></a></a><span>
</span><a name="line-1329"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-1330"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621681118204"><a href="#local-6989586621681118204"><span class="hs-identifier">_a_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118205"><a href="#local-6989586621681118205"><span class="hs-identifier">r_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitFunTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dropForAlls</span><span> </span><a href="#local-6989586621681118203"><span class="hs-identifier hs-var">fn_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1331"></a><span>       </span><a name="local-6989586621681118206"><a href="#local-6989586621681118206"><span class="hs-identifier">r_reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typePrimRepArgs</span><span> </span><a href="#local-6989586621681118205"><span class="hs-identifier hs-var">r_ty</span></a><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span>       </span><span class="hs-identifier">blargh</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681118208"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-comment">-- Used at more than one type</span><span>
</span><a name="line-1334"></a><span>       </span><a name="local-6989586621681118207"><a href="#local-6989586621681118207"><span class="hs-identifier">blargh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;maybe_getCCallReturn: can't handle:&quot;</span><span>
</span><a name="line-1335"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprType</span><span> </span><a href="#local-6989586621681118203"><span class="hs-identifier hs-var">fn_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1336"></a><span>     </span><span class="hs-keyword">in</span><span>
</span><a name="line-1337"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118206"><span class="hs-identifier hs-var">r_reps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1338"></a><span>         </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;empty typePrimRepArgs&quot;</span><span>
</span><a name="line-1339"></a><span>         </span><span class="hs-special">[</span><span class="hs-identifier hs-var">VoidRep</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1340"></a><span>         </span><span class="hs-special">[</span><a name="local-6989586621681118209"><a href="#local-6989586621681118209"><span class="hs-identifier">rep</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-1341"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGcPtrRep</span><span> </span><a href="#local-6989586621681118209"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118207"><span class="hs-identifier hs-var">blargh</span></a><span>
</span><a name="line-1342"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681118209"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-1343"></a><span>
</span><a name="line-1344"></a><span>                 </span><span class="hs-comment">-- if it was, it would be impossible to create a</span><span>
</span><a name="line-1345"></a><span>                 </span><span class="hs-comment">-- valid return value placeholder on the stack</span><span>
</span><a name="line-1346"></a><span>         </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118207"><span class="hs-identifier hs-var">blargh</span></a><span>
</span><a name="line-1347"></a><span>
</span><a name="line-1348"></a><span class="hs-identifier">maybe_is_tagToEnum_call</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1349"></a><span class="hs-comment">-- Detect and extract relevant info for the tagToEnum kludge.</span><span>
</span><a name="line-1350"></a><a name="maybe_is_tagToEnum_call"><a href="ByteCodeGen.html#maybe_is_tagToEnum_call"><span class="hs-identifier">maybe_is_tagToEnum_call</span></a></a><span> </span><a name="local-6989586621681118210"><a href="#local-6989586621681118210"><span class="hs-identifier">app</span></a></a><span>
</span><a name="line-1351"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681118215"><a href="#local-6989586621681118215"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnType</span><span> </span><a name="local-6989586621681118216"><a href="#local-6989586621681118216"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681118217"><a href="#local-6989586621681118217"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118210"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-1352"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">TagToEnumOp</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isPrimOpId_maybe</span><span> </span><a href="#local-6989586621681118215"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1353"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621681118217"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118211"><span class="hs-identifier hs-var">extract_constr_Names</span></a><span> </span><a href="#local-6989586621681118216"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1354"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1355"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1356"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1357"></a><span>    </span><a name="local-6989586621681118211"><a href="#local-6989586621681118211"><span class="hs-identifier">extract_constr_Names</span></a></a><span> </span><a name="local-6989586621681118212"><a href="#local-6989586621681118212"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1358"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681118213"><a href="#local-6989586621681118213"><span class="hs-identifier">rep_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unwrapType</span><span> </span><a href="#local-6989586621681118212"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1359"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118214"><a href="#local-6989586621681118214"><span class="hs-identifier">tyc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span><span> </span><a href="#local-6989586621681118213"><span class="hs-identifier hs-var">rep_ty</span></a><span>
</span><a name="line-1360"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isDataTyCon</span><span> </span><a href="#local-6989586621681118214"><span class="hs-identifier hs-var">tyc</span></a><span>
</span><a name="line-1361"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">dataConWorkId</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621681118214"><span class="hs-identifier hs-var">tyc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1362"></a><span>           </span><span class="hs-comment">-- NOTE: use the worker name, not the source name of</span><span>
</span><a name="line-1363"></a><span>           </span><span class="hs-comment">-- the DataCon.  See DataCon.hs for details.</span><span>
</span><a name="line-1364"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1365"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;maybe_is_tagToEnum_call.extract_constr_Ids&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681118212"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1366"></a><span>
</span><a name="line-1367"></a><span class="hs-comment">{- -----------------------------------------------------------------------------
Note [Implementing tagToEnum#]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(implement_tagToId arg names) compiles code which takes an argument
'arg', (call it i), and enters the i'th closure in the supplied list
as a consequence.  The [Name] is a list of the constructors of this
(enumeration) type.

The code we generate is this:
                push arg
                push bogus-word

                TESTEQ_I 0 L1
                  PUSH_G &lt;lbl for first data con&gt;
                  JMP L_Exit

        L1:     TESTEQ_I 1 L2
                  PUSH_G &lt;lbl for second data con&gt;
                  JMP L_Exit
        ...etc...
        Ln:     TESTEQ_I n L_fail
                  PUSH_G &lt;lbl for last data con&gt;
                  JMP L_Exit

        L_fail: CASEFAIL

        L_exit: SLIDE 1 n
                ENTER

The 'bogus-word' push is because TESTEQ_I expects the top of the stack
to have an info-table, and the next word to have the value to be
tested.  This is very weird, but it's the way it is right now.  See
Interpreter.c.  We don't acutally need an info-table here; we just
need to have the argument to be one-from-top on the stack, hence pushing
a 1-word null. See Trac #8383.
-}</span><span>
</span><a name="line-1403"></a><span>
</span><a name="line-1404"></a><span>
</span><a name="line-1405"></a><span class="hs-identifier">implement_tagToId</span><span>
</span><a name="line-1406"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span>
</span><a name="line-1407"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-1408"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span>
</span><a name="line-1409"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span>
</span><a name="line-1410"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1411"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-1412"></a><span class="hs-comment">-- See Note [Implementing tagToEnum#]</span><span>
</span><a name="line-1413"></a><a name="implement_tagToId"><a href="ByteCodeGen.html#implement_tagToId"><span class="hs-identifier">implement_tagToId</span></a></a><span> </span><a name="local-6989586621681118218"><a href="#local-6989586621681118218"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118219"><a href="#local-6989586621681118219"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681118220"><a href="#local-6989586621681118220"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118221"><a href="#local-6989586621681118221"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621681118222"><a href="#local-6989586621681118222"><span class="hs-identifier">names</span></a></a><span>
</span><a name="line-1414"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">names</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1415"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681118229"><a href="#local-6989586621681118229"><span class="hs-identifier">push_arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118230"><a href="#local-6989586621681118230"><span class="hs-identifier">arg_bytes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118218"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118220"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118221"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1416"></a><span>       </span><a name="local-6989586621681118231"><a href="#local-6989586621681118231"><span class="hs-identifier">labels</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getLabelsBc"><span class="hs-identifier hs-var">getLabelsBc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">genericLength</span><span> </span><a href="#local-6989586621681118222"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-1417"></a><span>       </span><a name="local-6989586621681118232"><a href="#local-6989586621681118232"><span class="hs-identifier">label_fail</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getLabelBc"><span class="hs-identifier hs-var">getLabelBc</span></a><span>
</span><a name="line-1418"></a><span>       </span><a name="local-6989586621681118233"><a href="#local-6989586621681118233"><span class="hs-identifier">label_exit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getLabelBc"><span class="hs-identifier hs-var">getLabelBc</span></a><span>
</span><a name="line-1419"></a><span>       </span><a name="local-6989586621681118234"><a href="#local-6989586621681118234"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1420"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118235"><a href="#local-6989586621681118235"><span class="hs-identifier">infos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip4</span><span> </span><a href="#local-6989586621681118231"><span class="hs-identifier hs-var">labels</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621681118231"><span class="hs-identifier hs-var">labels</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681118232"><span class="hs-identifier hs-var">label_fail</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1421"></a><span>                               </span><span class="hs-special">[</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681118222"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-1422"></a><span>           </span><a name="local-6989586621681118236"><a href="#local-6989586621681118236"><span class="hs-identifier">steps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118223"><span class="hs-identifier hs-var">mkStep</span></a><span> </span><a href="#local-6989586621681118233"><span class="hs-identifier hs-var">label_exit</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118235"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-1423"></a><span>           </span><a name="local-6989586621681118237"><a href="#local-6989586621681118237"><span class="hs-identifier">slide_ws</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118234"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118218"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118219"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118230"><span class="hs-identifier hs-var">arg_bytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>
</span><a name="line-1425"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118229"><span class="hs-identifier hs-var">push_arg</span></a><span>
</span><a name="line-1426"></a><span>               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_UBX"><span class="hs-identifier hs-var">PUSH_UBX</span></a><span> </span><span class="hs-identifier hs-var">LitNullAddr</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1427"></a><span>                   </span><span class="hs-comment">-- Push bogus word (see Note [Implementing tagToEnum#])</span><span>
</span><a name="line-1428"></a><span>               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">concatOL</span><span> </span><a href="#local-6989586621681118236"><span class="hs-identifier hs-var">steps</span></a><span>
</span><a name="line-1429"></a><span>               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">[</span><span> </span><a href="ByteCodeInstr.html#LABEL"><span class="hs-identifier hs-var">LABEL</span></a><span> </span><a href="#local-6989586621681118232"><span class="hs-identifier hs-var">label_fail</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeInstr.html#CASEFAIL"><span class="hs-identifier hs-var">CASEFAIL</span></a><span class="hs-special">,</span><span>
</span><a name="line-1430"></a><span>                              </span><a href="ByteCodeInstr.html#LABEL"><span class="hs-identifier hs-var">LABEL</span></a><span> </span><a href="#local-6989586621681118233"><span class="hs-identifier hs-var">label_exit</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1431"></a><span>               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="ByteCodeGen.html#mkSlideW"><span class="hs-identifier hs-var">mkSlideW</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118237"><span class="hs-identifier hs-var">slide_ws</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1432"></a><span>                   </span><span class="hs-comment">-- &quot;+1&quot; to account for bogus word</span><span>
</span><a name="line-1433"></a><span>                   </span><span class="hs-comment">--      (see Note [Implementing tagToEnum#])</span><span>
</span><a name="line-1434"></a><span>               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="ByteCodeInstr.html#ENTER"><span class="hs-identifier hs-var">ENTER</span></a><span class="hs-special">)</span><span>
</span><a name="line-1435"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1436"></a><span>        </span><a name="local-6989586621681118223"><a href="#local-6989586621681118223"><span class="hs-identifier">mkStep</span></a></a><span> </span><a name="local-6989586621681118224"><a href="#local-6989586621681118224"><span class="hs-identifier">l_exit</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681118225"><a href="#local-6989586621681118225"><span class="hs-identifier">my_label</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118226"><a href="#local-6989586621681118226"><span class="hs-identifier">next_label</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118227"><a href="#local-6989586621681118227"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118228"><a href="#local-6989586621681118228"><span class="hs-identifier">name_for_n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1437"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">[</span><a href="ByteCodeInstr.html#LABEL"><span class="hs-identifier hs-var">LABEL</span></a><span> </span><a href="#local-6989586621681118225"><span class="hs-identifier hs-var">my_label</span></a><span class="hs-special">,</span><span>
</span><a name="line-1438"></a><span>                   </span><a href="ByteCodeInstr.html#TESTEQ_I"><span class="hs-identifier hs-var">TESTEQ_I</span></a><span> </span><a href="#local-6989586621681118227"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681118226"><span class="hs-identifier hs-var">next_label</span></a><span class="hs-special">,</span><span>
</span><a name="line-1439"></a><span>                   </span><a href="ByteCodeInstr.html#PUSH_G"><span class="hs-identifier hs-var">PUSH_G</span></a><span> </span><a href="#local-6989586621681118228"><span class="hs-identifier hs-var">name_for_n</span></a><span class="hs-special">,</span><span>
</span><a name="line-1440"></a><span>                   </span><a href="ByteCodeInstr.html#JMP"><span class="hs-identifier hs-var">JMP</span></a><span> </span><a href="#local-6989586621681118224"><span class="hs-identifier hs-var">l_exit</span></a><span class="hs-special">]</span><span>
</span><a name="line-1441"></a><span>
</span><a name="line-1442"></a><span>
</span><a name="line-1443"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1444"></a><span class="hs-comment">-- pushAtom</span><span>
</span><a name="line-1445"></a><span>
</span><a name="line-1446"></a><span class="hs-comment">-- Push an atom onto the stack, returning suitable code &amp; number of</span><span>
</span><a name="line-1447"></a><span class="hs-comment">-- stack words used.</span><span>
</span><a name="line-1448"></a><span class="hs-comment">--</span><span>
</span><a name="line-1449"></a><span class="hs-comment">-- The env p must map each variable to the highest- numbered stack</span><span>
</span><a name="line-1450"></a><span class="hs-comment">-- slot for it.  For example, if the stack has depth 4 and we</span><span>
</span><a name="line-1451"></a><span class="hs-comment">-- tagged-ly push (v :: Int#) on it, the value will be in stack[4],</span><span>
</span><a name="line-1452"></a><span class="hs-comment">-- the tag in stack[5], the stack will have depth 6, and p must map v</span><span>
</span><a name="line-1453"></a><span class="hs-comment">-- to 5 and not to 4.  Stack locations are numbered from zero, so a</span><span>
</span><a name="line-1454"></a><span class="hs-comment">-- depth 6 stack has valid words 0 .. 5.</span><span>
</span><a name="line-1455"></a><span>
</span><a name="line-1456"></a><span class="hs-identifier">pushAtom</span><span>
</span><a name="line-1457"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-1458"></a><a name="pushAtom"><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier">pushAtom</span></a></a><span> </span><a name="local-6989586621681118238"><a href="#local-6989586621681118238"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118239"><a href="#local-6989586621681118239"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118240"><a href="#local-6989586621681118240"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-1459"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118241"><a href="#local-6989586621681118241"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#bcView"><span class="hs-identifier hs-var">bcView</span></a><span> </span><a href="#local-6989586621681118240"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1460"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118238"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118239"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118241"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1461"></a><span>
</span><a name="line-1462"></a><span class="hs-identifier">pushAtom</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCoercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Coercions are zero-width things,</span><span>
</span><a name="line-1463"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- treated just like a variable V</span><span>
</span><a name="line-1464"></a><span>
</span><a name="line-1465"></a><span class="hs-comment">-- See Note [Empty case alternatives] in coreSyn/CoreSyn.hs</span><span>
</span><a name="line-1466"></a><span class="hs-comment">-- and Note [Bottoming expressions] in coreSyn/CoreUtils.hs:</span><span>
</span><a name="line-1467"></a><span class="hs-comment">-- The scrutinee of an empty case evaluates to bottom</span><span>
</span><a name="line-1468"></a><span class="hs-identifier">pushAtom</span><span> </span><a name="local-6989586621681118242"><a href="#local-6989586621681118242"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118243"><a href="#local-6989586621681118243"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681118244"><a href="#local-6989586621681118244"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- trac #12128</span><span>
</span><a name="line-1469"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118242"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118243"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118244"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1470"></a><span>
</span><a name="line-1471"></a><span class="hs-identifier">pushAtom</span><span> </span><a name="local-6989586621681118245"><a href="#local-6989586621681118245"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118246"><a href="#local-6989586621681118246"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681118247"><a href="#local-6989586621681118247"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1472"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-1473"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-1474"></a><span>
</span><a name="line-1475"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFCallId</span><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1476"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;pushAtom: shouldn't get an FCallId here&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-1477"></a><span>
</span><a name="line-1478"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118248"><a href="#local-6989586621681118248"><span class="hs-identifier">primop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isPrimOpId_maybe</span><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1479"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1480"></a><span>       </span><a name="local-6989586621681118249"><a href="#local-6989586621681118249"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1481"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_PRIMOP"><span class="hs-identifier hs-var">PUSH_PRIMOP</span></a><span> </span><a href="#local-6989586621681118248"><span class="hs-identifier hs-var">primop</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118249"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1482"></a><span>
</span><a name="line-1483"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118250"><a href="#local-6989586621681118250"><span class="hs-identifier">d_v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#lookupBCEnv_maybe"><span class="hs-identifier hs-var">lookupBCEnv_maybe</span></a><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621681118246"><span class="hs-identifier hs-var">p</span></a><span>  </span><span class="hs-comment">-- var is a local variable</span><span>
</span><a name="line-1484"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118251"><a href="#local-6989586621681118251"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1485"></a><span>
</span><a name="line-1486"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118252"><a href="#local-6989586621681118252"><span class="hs-identifier">szb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#idSizeCon"><span class="hs-identifier hs-var">idSizeCon</span></a><span> </span><a href="#local-6989586621681118251"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1487"></a><span>            </span><a name="local-6989586621681118253"><a href="#local-6989586621681118253"><span class="hs-identifier">with_instr</span></a></a><span> </span><a name="local-6989586621681118254"><a href="#local-6989586621681118254"><span class="hs-identifier">instr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1488"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118255"><a href="#local-6989586621681118255"><span class="hs-identifier">off_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16B"><span class="hs-identifier hs-var">trunc16B</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681118245"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118250"><span class="hs-identifier hs-var">d_v</span></a><span>
</span><a name="line-1489"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118254"><span class="hs-identifier hs-var">instr</span></a><span> </span><a href="#local-6989586621681118255"><span class="hs-identifier hs-var">off_b</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#wordSize"><span class="hs-identifier hs-var">wordSize</span></a><span> </span><a href="#local-6989586621681118251"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1490"></a><span>
</span><a name="line-1491"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118252"><span class="hs-identifier hs-var">szb</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1492"></a><span>            </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118253"><span class="hs-identifier hs-var">with_instr</span></a><span> </span><a href="ByteCodeInstr.html#PUSH8_W"><span class="hs-identifier hs-var">PUSH8_W</span></a><span>
</span><a name="line-1493"></a><span>            </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118253"><span class="hs-identifier hs-var">with_instr</span></a><span> </span><a href="ByteCodeInstr.html#PUSH16_W"><span class="hs-identifier hs-var">PUSH16_W</span></a><span>
</span><a name="line-1494"></a><span>            </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118253"><span class="hs-identifier hs-var">with_instr</span></a><span> </span><a href="ByteCodeInstr.html#PUSH32_W"><span class="hs-identifier hs-var">PUSH32_W</span></a><span>
</span><a name="line-1495"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1496"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118256"><a href="#local-6989586621681118256"><span class="hs-identifier">szw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118251"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118252"><span class="hs-identifier hs-var">szb</span></a><span>
</span><a name="line-1497"></a><span>                    </span><span class="hs-glyph">!</span><a name="local-6989586621681118257"><a href="#local-6989586621681118257"><span class="hs-identifier">off_w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118251"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118245"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118250"><span class="hs-identifier hs-var">d_v</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681118256"><span class="hs-identifier hs-var">szw</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1498"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">genericReplicate</span><span> </span><a href="#local-6989586621681118256"><span class="hs-identifier hs-var">szw</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_L"><span class="hs-identifier hs-var">PUSH_L</span></a><span> </span><a href="#local-6989586621681118257"><span class="hs-identifier hs-var">off_w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118252"><span class="hs-identifier hs-var">szb</span></a><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>        </span><span class="hs-comment">-- d - d_v           offset from TOS to the first slot of the object</span><span>
</span><a name="line-1500"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1501"></a><span>        </span><span class="hs-comment">-- d - d_v + sz - 1  offset from the TOS of the last slot of the object</span><span>
</span><a name="line-1502"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1503"></a><span>        </span><span class="hs-comment">-- Having found the last slot, we proceed to copy the right number of</span><span>
</span><a name="line-1504"></a><span>        </span><span class="hs-comment">-- slots on to the top of the stack.</span><span>
</span><a name="line-1505"></a><span>
</span><a name="line-1506"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- var must be a global variable</span><span>
</span><a name="line-1507"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118258"><a href="#local-6989586621681118258"><span class="hs-identifier">topStrings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getTopStrings"><span class="hs-identifier hs-var">getTopStrings</span></a><span>
</span><a name="line-1508"></a><span>        </span><a name="local-6989586621681118259"><a href="#local-6989586621681118259"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1509"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621681118258"><span class="hs-identifier hs-var">topStrings</span></a><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1510"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118260"><a href="#local-6989586621681118260"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118245"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118246"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">AnnLit</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLitWord</span><span> </span><a href="#local-6989586621681118259"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1511"></a><span>              </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ptrToWordPtr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromRemotePtr</span><span> </span><a href="#local-6989586621681118260"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-1512"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1513"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118261"><a href="#local-6989586621681118261"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#idSizeCon"><span class="hs-identifier hs-var">idSizeCon</span></a><span> </span><a href="#local-6989586621681118259"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1514"></a><span>                </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sz</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">wordSize</span><span> </span><span class="hs-identifier">dflags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_G"><span class="hs-identifier hs-var">PUSH_G</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621681118247"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118261"><span class="hs-identifier hs-var">sz</span></a><span class="hs-special">)</span><span>
</span><a name="line-1516"></a><span>
</span><a name="line-1517"></a><span>
</span><a name="line-1518"></a><span class="hs-identifier">pushAtom</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLit</span><span> </span><a name="local-6989586621681118262"><a href="#local-6989586621681118262"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1519"></a><span>     </span><a name="local-6989586621681118263"><a href="#local-6989586621681118263"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1520"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118264"><a href="#local-6989586621681118264"><span class="hs-identifier">code</span></a></a><span> </span><a name="local-6989586621681118265"><a href="#local-6989586621681118265"><span class="hs-identifier">rep</span></a></a><span>
</span><a name="line-1521"></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118266"><a href="#local-6989586621681118266"><span class="hs-identifier">size_words</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-var">WordOff</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#argRepSizeW"><span class="hs-identifier hs-var">argRepSizeW</span></a><span> </span><a href="#local-6989586621681118263"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118265"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1522"></a><span>               </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_UBX"><span class="hs-identifier hs-var">PUSH_UBX</span></a><span> </span><a href="#local-6989586621681118262"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><a href="#local-6989586621681118266"><span class="hs-identifier hs-var">size_words</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1523"></a><span>                           </span><a href="ByteCodeGen.html#wordsToBytes"><span class="hs-identifier hs-var">wordsToBytes</span></a><span> </span><a href="#local-6989586621681118263"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118266"><span class="hs-identifier hs-var">size_words</span></a><span class="hs-special">)</span><span>
</span><a name="line-1524"></a><span>
</span><a name="line-1525"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118262"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1526"></a><span>        </span><span class="hs-identifier hs-var">LitLabel</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1527"></a><span>        </span><span class="hs-identifier hs-var">LitFloat</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#F"><span class="hs-identifier hs-var">F</span></a><span>
</span><a name="line-1528"></a><span>        </span><span class="hs-identifier hs-var">LitDouble</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#D"><span class="hs-identifier hs-var">D</span></a><span>
</span><a name="line-1529"></a><span>        </span><span class="hs-identifier hs-var">LitChar</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1530"></a><span>        </span><span class="hs-identifier hs-var">LitNullAddr</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1531"></a><span>        </span><span class="hs-identifier hs-var">LitString</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1532"></a><span>        </span><span class="hs-identifier hs-var">LitRubbish</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1533"></a><span>        </span><span class="hs-identifier hs-var">LitNumber</span><span> </span><a name="local-6989586621681118267"><a href="#local-6989586621681118267"><span class="hs-identifier">nt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118267"><span class="hs-identifier hs-var">nt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1534"></a><span>          </span><span class="hs-identifier hs-var">LitNumInt</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1535"></a><span>          </span><span class="hs-identifier hs-var">LitNumWord</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#N"><span class="hs-identifier hs-var">N</span></a><span>
</span><a name="line-1536"></a><span>          </span><span class="hs-identifier hs-var">LitNumInt64</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#L"><span class="hs-identifier hs-var">L</span></a><span>
</span><a name="line-1537"></a><span>          </span><span class="hs-identifier hs-var">LitNumWord64</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118264"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="StgCmmArgRep.html#L"><span class="hs-identifier hs-var">L</span></a><span>
</span><a name="line-1538"></a><span>          </span><span class="hs-comment">-- No LitInteger's or LitNatural's should be left by the time this is</span><span>
</span><a name="line-1539"></a><span>          </span><span class="hs-comment">-- called. CorePrep should have converted them all to a real core</span><span>
</span><a name="line-1540"></a><span>          </span><span class="hs-comment">-- representation.</span><span>
</span><a name="line-1541"></a><span>          </span><span class="hs-identifier hs-var">LitNumInteger</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;pushAtom: LitInteger&quot;</span><span>
</span><a name="line-1542"></a><span>          </span><span class="hs-identifier hs-var">LitNumNatural</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;pushAtom: LitNatural&quot;</span><span>
</span><a name="line-1543"></a><span>
</span><a name="line-1544"></a><span class="hs-identifier">pushAtom</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681118268"><a href="#local-6989586621681118268"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-1545"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;ByteCodeGen.pushAtom&quot;</span><span>
</span><a name="line-1546"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCoreExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deAnnotate'</span><span> </span><a href="#local-6989586621681118268"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1547"></a><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span class="hs-comment">-- | Push an atom for constructor (i.e., PACK instruction) onto the stack.</span><span>
</span><a name="line-1550"></a><span class="hs-comment">-- This is slightly different to @pushAtom@ due to the fact that we allow</span><span>
</span><a name="line-1551"></a><span class="hs-comment">-- packing constructor fields. See also @mkConAppCode@ and @pushPadding@.</span><span>
</span><a name="line-1552"></a><span class="hs-identifier">pushConstrAtom</span><span>
</span><a name="line-1553"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#StackDepth"><span class="hs-identifier hs-type">StackDepth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-identifier hs-type">DVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-1554"></a><span>
</span><a name="line-1555"></a><a name="pushConstrAtom"><a href="ByteCodeGen.html#pushConstrAtom"><span class="hs-identifier">pushConstrAtom</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLit</span><span> </span><a name="local-6989586621681118269"><a href="#local-6989586621681118269"><span class="hs-identifier">lit</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitFloat</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1556"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#PUSH_UBX32"><span class="hs-identifier hs-var">PUSH_UBX32</span></a><span> </span><a href="#local-6989586621681118269"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span>
</span><a name="line-1557"></a><span>
</span><a name="line-1558"></a><span class="hs-identifier">pushConstrAtom</span><span> </span><a name="local-6989586621681118270"><a href="#local-6989586621681118270"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118271"><a href="#local-6989586621681118271"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681118272"><a href="#local-6989586621681118272"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1559"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118273"><a href="#local-6989586621681118273"><span class="hs-identifier">d_v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#lookupBCEnv_maybe"><span class="hs-identifier hs-var">lookupBCEnv_maybe</span></a><span> </span><a href="#local-6989586621681118272"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621681118271"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- v is a local variable</span><span>
</span><a name="line-1560"></a><span>        </span><a name="local-6989586621681118274"><a href="#local-6989586621681118274"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1561"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118275"><a href="#local-6989586621681118275"><span class="hs-identifier">szb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#idSizeCon"><span class="hs-identifier hs-var">idSizeCon</span></a><span> </span><a href="#local-6989586621681118274"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118272"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1562"></a><span>            </span><a name="local-6989586621681118276"><a href="#local-6989586621681118276"><span class="hs-identifier">done</span></a></a><span> </span><a name="local-6989586621681118277"><a href="#local-6989586621681118277"><span class="hs-identifier">instr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1563"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118278"><a href="#local-6989586621681118278"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16B"><span class="hs-identifier hs-var">trunc16B</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681118270"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681118273"><span class="hs-identifier hs-var">d_v</span></a><span>
</span><a name="line-1564"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118277"><span class="hs-identifier hs-var">instr</span></a><span> </span><a href="#local-6989586621681118278"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118275"><span class="hs-identifier hs-var">szb</span></a><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118275"><span class="hs-identifier hs-var">szb</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1566"></a><span>            </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118276"><span class="hs-identifier hs-var">done</span></a><span> </span><a href="ByteCodeInstr.html#PUSH8"><span class="hs-identifier hs-var">PUSH8</span></a><span>
</span><a name="line-1567"></a><span>            </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118276"><span class="hs-identifier hs-var">done</span></a><span> </span><a href="ByteCodeInstr.html#PUSH16"><span class="hs-identifier hs-var">PUSH16</span></a><span>
</span><a name="line-1568"></a><span>            </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118276"><span class="hs-identifier hs-var">done</span></a><span> </span><a href="ByteCodeInstr.html#PUSH32"><span class="hs-identifier hs-var">PUSH32</span></a><span>
</span><a name="line-1569"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118270"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118271"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a href="#local-6989586621681118272"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1570"></a><span>
</span><a name="line-1571"></a><span class="hs-identifier">pushConstrAtom</span><span> </span><a name="local-6989586621681118279"><a href="#local-6989586621681118279"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621681118280"><a href="#local-6989586621681118280"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681118281"><a href="#local-6989586621681118281"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#pushAtom"><span class="hs-identifier hs-var">pushAtom</span></a><span> </span><a href="#local-6989586621681118279"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621681118280"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681118281"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span class="hs-identifier">pushPadding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-1574"></a><a name="pushPadding"><a href="ByteCodeGen.html#pushPadding"><span class="hs-identifier">pushPadding</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118282"><a href="#local-6989586621681118282"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118283"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681118282"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-1575"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1576"></a><span>    </span><a name="local-6989586621681118283"><a href="#local-6989586621681118283"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681118284"><a href="#local-6989586621681118284"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621681118285"><a href="#local-6989586621681118285"><span class="hs-identifier">acc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621681118286"><a href="#local-6989586621681118286"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118287"><a href="#local-6989586621681118287"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118284"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1577"></a><span>        </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118285"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1578"></a><span>        </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118286"><span class="hs-identifier hs-var">instrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="ByteCodeInstr.html#PUSH_PAD8"><span class="hs-identifier hs-var">PUSH_PAD8</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118287"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1579"></a><span>        </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118286"><span class="hs-identifier hs-var">instrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="ByteCodeInstr.html#PUSH_PAD16"><span class="hs-identifier hs-var">PUSH_PAD16</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118287"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-1580"></a><span>        </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118283"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118283"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621681118285"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1581"></a><span>        </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118286"><span class="hs-identifier hs-var">instrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="ByteCodeInstr.html#PUSH_PAD32"><span class="hs-identifier hs-var">PUSH_PAD32</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118287"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span>
</span><a name="line-1582"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681118283"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118284"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118283"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621681118285"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1583"></a><span>
</span><a name="line-1584"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1585"></a><span class="hs-comment">-- Given a bunch of alts code and their discrs, do the donkey work</span><span>
</span><a name="line-1586"></a><span class="hs-comment">-- of making a multiway branch using a switch tree.</span><span>
</span><a name="line-1587"></a><span class="hs-comment">-- What a load of hassle!</span><span>
</span><a name="line-1588"></a><span>
</span><a name="line-1589"></a><span class="hs-identifier">mkMultiBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>      </span><span class="hs-comment">-- # datacons in tycon, if alg alt</span><span>
</span><a name="line-1590"></a><span>                                </span><span class="hs-comment">-- a hint; generates better code</span><span>
</span><a name="line-1591"></a><span>                                </span><span class="hs-comment">-- Nothing is always safe</span><span>
</span><a name="line-1592"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="ByteCodeGen.html#Discr"><span class="hs-identifier hs-type">Discr</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1593"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-1594"></a><a name="mkMultiBranch"><a href="ByteCodeGen.html#mkMultiBranch"><span class="hs-identifier">mkMultiBranch</span></a></a><span> </span><a name="local-6989586621681118288"><a href="#local-6989586621681118288"><span class="hs-identifier">maybe_ncons</span></a></a><span> </span><a name="local-6989586621681118289"><a href="#local-6989586621681118289"><span class="hs-identifier">raw_ways</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1595"></a><span>     </span><a name="local-6989586621681118330"><a href="#local-6989586621681118330"><span class="hs-identifier">lbl_default</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getLabelBc"><span class="hs-identifier hs-var">getLabelBc</span></a><span>
</span><a name="line-1596"></a><span>
</span><a name="line-1597"></a><span>     </span><span class="hs-keyword">let</span><span>
</span><a name="line-1598"></a><span>         </span><span class="hs-identifier">mkTree</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="ByteCodeGen.html#Discr"><span class="hs-identifier hs-type">Discr</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Discr"><span class="hs-identifier hs-type">Discr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#Discr"><span class="hs-identifier hs-type">Discr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="ByteCodeGen.html#BCInstrList"><span class="hs-identifier hs-type">BCInstrList</span></a><span>
</span><a name="line-1599"></a><span>         </span><a name="local-6989586621681118331"><a href="#local-6989586621681118331"><span class="hs-identifier">mkTree</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681118333"><a href="#local-6989586621681118333"><span class="hs-identifier">_range_lo</span></a></a><span> </span><a name="local-6989586621681118334"><a href="#local-6989586621681118334"><span class="hs-identifier">_range_hi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#JMP"><span class="hs-identifier hs-var">JMP</span></a><span> </span><a href="#local-6989586621681118330"><span class="hs-identifier hs-var">lbl_default</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1600"></a><span>             </span><span class="hs-comment">-- shouldn't happen?</span><span>
</span><a name="line-1601"></a><span>
</span><a name="line-1602"></a><span>         </span><span class="hs-identifier">mkTree</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681118335"><a href="#local-6989586621681118335"><span class="hs-identifier">val</span></a></a><span class="hs-special">]</span><span> </span><a name="local-6989586621681118336"><a href="#local-6989586621681118336"><span class="hs-identifier">range_lo</span></a></a><span> </span><a name="local-6989586621681118337"><a href="#local-6989586621681118337"><span class="hs-identifier">range_hi</span></a></a><span>
</span><a name="line-1603"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118336"><span class="hs-identifier hs-var">range_lo</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681118337"><span class="hs-identifier hs-var">range_hi</span></a><span>
</span><a name="line-1604"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621681118335"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-1605"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681118290"><span class="hs-identifier hs-var">defaults</span></a><span> </span><span class="hs-comment">-- Note [CASEFAIL]</span><span>
</span><a name="line-1606"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681118338"><a href="#local-6989586621681118338"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getLabelBc"><span class="hs-identifier hs-var">getLabelBc</span></a><span>
</span><a name="line-1607"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118294"><span class="hs-identifier hs-var">testEQ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621681118335"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118338"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-1608"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621681118335"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-1609"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span>  </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#LABEL"><span class="hs-identifier hs-var">LABEL</span></a><span> </span><a href="#local-6989586621681118338"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="ByteCodeInstr.html#CASEFAIL"><span class="hs-identifier hs-var">CASEFAIL</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1610"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1611"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118294"><span class="hs-identifier hs-var">testEQ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621681118335"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118330"><span class="hs-identifier hs-var">lbl_default</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621681118335"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span>            </span><span class="hs-comment">-- Note [CASEFAIL] It may be that this case has no default</span><span>
</span><a name="line-1614"></a><span>            </span><span class="hs-comment">-- branch, but the alternatives are not exhaustive - this</span><span>
</span><a name="line-1615"></a><span>            </span><span class="hs-comment">-- happens for GADT cases for example, where the types</span><span>
</span><a name="line-1616"></a><span>            </span><span class="hs-comment">-- prove that certain branches are impossible.  We could</span><span>
</span><a name="line-1617"></a><span>            </span><span class="hs-comment">-- just assume that the other cases won't occur, but if</span><span>
</span><a name="line-1618"></a><span>            </span><span class="hs-comment">-- this assumption was wrong (because of a bug in GHC)</span><span>
</span><a name="line-1619"></a><span>            </span><span class="hs-comment">-- then the result would be a segfault.  So instead we</span><span>
</span><a name="line-1620"></a><span>            </span><span class="hs-comment">-- emit an explicit test and a CASEFAIL instruction that</span><span>
</span><a name="line-1621"></a><span>            </span><span class="hs-comment">-- causes the interpreter to barf() if it is ever</span><span>
</span><a name="line-1622"></a><span>            </span><span class="hs-comment">-- executed.</span><span>
</span><a name="line-1623"></a><span>
</span><a name="line-1624"></a><span>         </span><span class="hs-identifier">mkTree</span><span> </span><a name="local-6989586621681118339"><a href="#local-6989586621681118339"><span class="hs-identifier">vals</span></a></a><span> </span><a name="local-6989586621681118340"><a href="#local-6989586621681118340"><span class="hs-identifier">range_lo</span></a></a><span> </span><a name="local-6989586621681118341"><a href="#local-6989586621681118341"><span class="hs-identifier">range_hi</span></a></a><span>
</span><a name="line-1625"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118342"><a href="#local-6989586621681118342"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681118339"><span class="hs-identifier hs-var">vals</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-1626"></a><span>                  </span><a name="local-6989586621681118343"><a href="#local-6989586621681118343"><span class="hs-identifier">vals_lo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621681118342"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681118339"><span class="hs-identifier hs-var">vals</span></a><span>
</span><a name="line-1627"></a><span>                  </span><a name="local-6989586621681118344"><a href="#local-6989586621681118344"><span class="hs-identifier">vals_hi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621681118342"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681118339"><span class="hs-identifier hs-var">vals</span></a><span>
</span><a name="line-1628"></a><span>                  </span><a name="local-6989586621681118345"><a href="#local-6989586621681118345"><span class="hs-identifier">v_mid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621681118344"><span class="hs-identifier hs-var">vals_hi</span></a><span class="hs-special">)</span><span>
</span><a name="line-1629"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1630"></a><span>              </span><a name="local-6989586621681118346"><a href="#local-6989586621681118346"><span class="hs-identifier">label_geq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#getLabelBc"><span class="hs-identifier hs-var">getLabelBc</span></a><span>
</span><a name="line-1631"></a><span>              </span><a name="local-6989586621681118347"><a href="#local-6989586621681118347"><span class="hs-identifier">code_lo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118331"><span class="hs-identifier hs-var">mkTree</span></a><span> </span><a href="#local-6989586621681118343"><span class="hs-identifier hs-var">vals_lo</span></a><span> </span><a href="#local-6989586621681118340"><span class="hs-identifier hs-var">range_lo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118300"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621681118345"><span class="hs-identifier hs-var">v_mid</span></a><span class="hs-special">)</span><span>
</span><a name="line-1632"></a><span>              </span><a name="local-6989586621681118348"><a href="#local-6989586621681118348"><span class="hs-identifier">code_hi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118331"><span class="hs-identifier hs-var">mkTree</span></a><span> </span><a href="#local-6989586621681118344"><span class="hs-identifier hs-var">vals_hi</span></a><span> </span><a href="#local-6989586621681118345"><span class="hs-identifier hs-var">v_mid</span></a><span> </span><a href="#local-6989586621681118341"><span class="hs-identifier hs-var">range_hi</span></a><span>
</span><a name="line-1633"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118293"><span class="hs-identifier hs-var">testLT</span></a><span> </span><a href="#local-6989586621681118345"><span class="hs-identifier hs-var">v_mid</span></a><span> </span><a href="#local-6989586621681118346"><span class="hs-identifier hs-var">label_geq</span></a><span>
</span><a name="line-1634"></a><span>                      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118347"><span class="hs-identifier hs-var">code_lo</span></a><span>
</span><a name="line-1635"></a><span>                      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span>   </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#LABEL"><span class="hs-identifier hs-var">LABEL</span></a><span> </span><a href="#local-6989586621681118346"><span class="hs-identifier hs-var">label_geq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1636"></a><span>                      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span>   </span><a href="#local-6989586621681118348"><span class="hs-identifier hs-var">code_hi</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1637"></a><span>
</span><a name="line-1638"></a><span>         </span><a name="local-6989586621681118332"><a href="#local-6989586621681118332"><span class="hs-identifier">the_default</span></a></a><span>
</span><a name="line-1639"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118290"><span class="hs-identifier hs-var">defaults</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1640"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-1641"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681118349"><a href="#local-6989586621681118349"><span class="hs-identifier">def</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeInstr.html#LABEL"><span class="hs-identifier hs-var">LABEL</span></a><span> </span><a href="#local-6989586621681118330"><span class="hs-identifier hs-var">lbl_default</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118349"><span class="hs-identifier hs-var">def</span></a><span>
</span><a name="line-1642"></a><span>                </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkMultiBranch/the_default&quot;</span><span>
</span><a name="line-1643"></a><span>     </span><a name="local-6989586621681118350"><a href="#local-6989586621681118350"><span class="hs-identifier">instrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118331"><span class="hs-identifier hs-var">mkTree</span></a><span> </span><a href="#local-6989586621681118292"><span class="hs-identifier hs-var">notd_ways</span></a><span> </span><a href="#local-6989586621681118295"><span class="hs-identifier hs-var">init_lo</span></a><span> </span><a href="#local-6989586621681118296"><span class="hs-identifier hs-var">init_hi</span></a><span>
</span><a name="line-1644"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118350"><span class="hs-identifier hs-var">instrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681118332"><span class="hs-identifier hs-var">the_default</span></a><span class="hs-special">)</span><span>
</span><a name="line-1645"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1646"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681118290"><a href="#local-6989586621681118290"><span class="hs-identifier">defaults</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118291"><a href="#local-6989586621681118291"><span class="hs-identifier">not_defaults</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118299"><span class="hs-identifier hs-var">isNoDiscr</span></a><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118289"><span class="hs-identifier hs-var">raw_ways</span></a><span>
</span><a name="line-1647"></a><span>         </span><a name="local-6989586621681118292"><a href="#local-6989586621681118292"><span class="hs-identifier">notd_ways</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118291"><span class="hs-identifier hs-var">not_defaults</span></a><span>
</span><a name="line-1648"></a><span>
</span><a name="line-1649"></a><span>         </span><a name="local-6989586621681118293"><a href="#local-6989586621681118293"><span class="hs-identifier">testLT</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><a name="local-6989586621681118305"><a href="#local-6989586621681118305"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118306"><a href="#local-6989586621681118306"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTLT_I"><span class="hs-identifier hs-var">TESTLT_I</span></a><span> </span><a href="#local-6989586621681118305"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118306"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1650"></a><span>         </span><span class="hs-identifier">testLT</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><a name="local-6989586621681118307"><a href="#local-6989586621681118307"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118308"><a href="#local-6989586621681118308"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTLT_W"><span class="hs-identifier hs-var">TESTLT_W</span></a><span> </span><a href="#local-6989586621681118307"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118308"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1651"></a><span>         </span><span class="hs-identifier">testLT</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><a name="local-6989586621681118309"><a href="#local-6989586621681118309"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118310"><a href="#local-6989586621681118310"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTLT_F"><span class="hs-identifier hs-var">TESTLT_F</span></a><span> </span><a href="#local-6989586621681118309"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118310"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1652"></a><span>         </span><span class="hs-identifier">testLT</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><a name="local-6989586621681118311"><a href="#local-6989586621681118311"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118312"><a href="#local-6989586621681118312"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTLT_D"><span class="hs-identifier hs-var">TESTLT_D</span></a><span> </span><a href="#local-6989586621681118311"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118312"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1653"></a><span>         </span><span class="hs-identifier">testLT</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><a name="local-6989586621681118313"><a href="#local-6989586621681118313"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118314"><a href="#local-6989586621681118314"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTLT_P"><span class="hs-identifier hs-var">TESTLT_P</span></a><span> </span><a href="#local-6989586621681118313"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118314"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1654"></a><span>         </span><span class="hs-identifier">testLT</span><span> </span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span>    </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkMultiBranch NoDiscr&quot;</span><span>
</span><a name="line-1655"></a><span>
</span><a name="line-1656"></a><span>         </span><a name="local-6989586621681118294"><a href="#local-6989586621681118294"><span class="hs-identifier">testEQ</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><a name="local-6989586621681118315"><a href="#local-6989586621681118315"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118316"><a href="#local-6989586621681118316"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTEQ_I"><span class="hs-identifier hs-var">TESTEQ_I</span></a><span> </span><a href="#local-6989586621681118315"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118316"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1657"></a><span>         </span><span class="hs-identifier">testEQ</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><a name="local-6989586621681118317"><a href="#local-6989586621681118317"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118318"><a href="#local-6989586621681118318"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTEQ_W"><span class="hs-identifier hs-var">TESTEQ_W</span></a><span> </span><a href="#local-6989586621681118317"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118318"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1658"></a><span>         </span><span class="hs-identifier">testEQ</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><a name="local-6989586621681118319"><a href="#local-6989586621681118319"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118320"><a href="#local-6989586621681118320"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTEQ_F"><span class="hs-identifier hs-var">TESTEQ_F</span></a><span> </span><a href="#local-6989586621681118319"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118320"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1659"></a><span>         </span><span class="hs-identifier">testEQ</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><a name="local-6989586621681118321"><a href="#local-6989586621681118321"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118322"><a href="#local-6989586621681118322"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTEQ_D"><span class="hs-identifier hs-var">TESTEQ_D</span></a><span> </span><a href="#local-6989586621681118321"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118322"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1660"></a><span>         </span><span class="hs-identifier">testEQ</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><a name="local-6989586621681118323"><a href="#local-6989586621681118323"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118324"><a href="#local-6989586621681118324"><span class="hs-identifier">fail_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#TESTEQ_P"><span class="hs-identifier hs-var">TESTEQ_P</span></a><span> </span><a href="#local-6989586621681118323"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621681118324"><span class="hs-identifier hs-var">fail_label</span></a><span>
</span><a name="line-1661"></a><span>         </span><span class="hs-identifier">testEQ</span><span> </span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span>    </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkMultiBranch NoDiscr&quot;</span><span>
</span><a name="line-1662"></a><span>
</span><a name="line-1663"></a><span>         </span><span class="hs-comment">-- None of these will be needed if there are no non-default alts</span><span>
</span><a name="line-1664"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681118295"><a href="#local-6989586621681118295"><span class="hs-identifier">init_lo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118296"><a href="#local-6989586621681118296"><span class="hs-identifier">init_hi</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1665"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681118292"><span class="hs-identifier hs-var">notd_ways</span></a><span>
</span><a name="line-1666"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkMultiBranch: awesome foursome&quot;</span><span>
</span><a name="line-1667"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1668"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621681118292"><span class="hs-identifier hs-var">notd_ways</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1669"></a><span>                </span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><span class="hs-identifier hs-var">minBound</span><span class="hs-special">,</span><span>  </span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><span class="hs-identifier hs-var">maxBound</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1670"></a><span>                </span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><span class="hs-identifier hs-var">minBound</span><span class="hs-special">,</span><span>  </span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><span class="hs-identifier hs-var">maxBound</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1671"></a><span>                </span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><a href="#local-6989586621681118301"><span class="hs-identifier hs-var">minF</span></a><span class="hs-special">,</span><span>      </span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><a href="#local-6989586621681118302"><span class="hs-identifier hs-var">maxF</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1672"></a><span>                </span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><a href="#local-6989586621681118303"><span class="hs-identifier hs-var">minD</span></a><span class="hs-special">,</span><span>      </span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><a href="#local-6989586621681118304"><span class="hs-identifier hs-var">maxD</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1673"></a><span>                </span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><a href="#local-6989586621681118297"><span class="hs-identifier hs-var">algMinBound</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><a href="#local-6989586621681118298"><span class="hs-identifier hs-var">algMaxBound</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1674"></a><span>                </span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkMultiBranch NoDiscr&quot;</span><span>
</span><a name="line-1675"></a><span>
</span><a name="line-1676"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681118297"><a href="#local-6989586621681118297"><span class="hs-identifier">algMinBound</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118298"><a href="#local-6989586621681118298"><span class="hs-identifier">algMaxBound</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1677"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118288"><span class="hs-identifier hs-var">maybe_ncons</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1678"></a><span>                 </span><span class="hs-comment">-- XXX What happens when n == 0?</span><span>
</span><a name="line-1679"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118325"><a href="#local-6989586621681118325"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681118325"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">minBound</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">)</span><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span>         </span><a name="local-6989586621681118299"><a href="#local-6989586621681118299"><span class="hs-identifier">isNoDiscr</span></a></a><span> </span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1683"></a><span>         </span><span class="hs-identifier">isNoDiscr</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1684"></a><span>
</span><a name="line-1685"></a><span>         </span><a name="local-6989586621681118300"><a href="#local-6989586621681118300"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><a name="local-6989586621681118326"><a href="#local-6989586621681118326"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118326"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1686"></a><span>         </span><span class="hs-identifier">dec</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><a name="local-6989586621681118327"><a href="#local-6989586621681118327"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118327"><span class="hs-identifier hs-var">w</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1687"></a><span>         </span><span class="hs-identifier">dec</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><a name="local-6989586621681118328"><a href="#local-6989586621681118328"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118328"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1688"></a><span>         </span><span class="hs-identifier">dec</span><span> </span><a name="local-6989586621681118329"><a href="#local-6989586621681118329"><span class="hs-identifier">other</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118329"><span class="hs-identifier hs-var">other</span></a><span>         </span><span class="hs-comment">-- not really right, but if you</span><span>
</span><a name="line-1689"></a><span>                </span><span class="hs-comment">-- do cases on floating values, you'll get what you deserve</span><span>
</span><a name="line-1690"></a><span>
</span><a name="line-1691"></a><span>         </span><span class="hs-comment">-- same snotty comment applies to the following</span><span>
</span><a name="line-1692"></a><span>         </span><span class="hs-identifier">minF</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxF</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-1693"></a><span>         </span><span class="hs-identifier">minD</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">maxD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-1694"></a><span>         </span><a name="local-6989586621681118301"><a href="#local-6989586621681118301"><span class="hs-identifier">minF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1.0e37</span><span>
</span><a name="line-1695"></a><span>         </span><a name="local-6989586621681118302"><a href="#local-6989586621681118302"><span class="hs-identifier">maxF</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-number">1.0e37</span><span>
</span><a name="line-1696"></a><span>         </span><a name="local-6989586621681118303"><a href="#local-6989586621681118303"><span class="hs-identifier">minD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1.0e308</span><span>
</span><a name="line-1697"></a><span>         </span><a name="local-6989586621681118304"><a href="#local-6989586621681118304"><span class="hs-identifier">maxD</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-number">1.0e308</span><span>
</span><a name="line-1698"></a><span>
</span><a name="line-1699"></a><span>
</span><a name="line-1700"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1701"></a><span class="hs-comment">-- Supporting junk for the compilation schemes</span><span>
</span><a name="line-1702"></a><span>
</span><a name="line-1703"></a><span class="hs-comment">-- Describes case alts</span><span>
</span><a name="line-1704"></a><span class="hs-keyword">data</span><span> </span><a name="Discr"><a href="ByteCodeGen.html#Discr"><span class="hs-identifier">Discr</span></a></a><span>
</span><a name="line-1705"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="DiscrI"><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier">DiscrI</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1706"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="DiscrW"><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier">DiscrW</span></a></a><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-1707"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="DiscrF"><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier">DiscrF</span></a></a><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-1708"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="DiscrD"><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier">DiscrD</span></a></a><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-1709"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="DiscrP"><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier">DiscrP</span></a></a><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-1710"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="NoDiscr"><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier">NoDiscr</span></a></a><span>
</span><a name="line-1711"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-1712"></a><span>
</span><a name="line-1713"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="ByteCodeGen.html#Discr"><span class="hs-identifier hs-type">Discr</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1714"></a><span>   </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrI"><span class="hs-identifier hs-var">DiscrI</span></a><span> </span><a name="local-6989586621681117632"><a href="#local-6989586621681117632"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621681117632"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1715"></a><span>   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrW"><span class="hs-identifier hs-var">DiscrW</span></a><span> </span><a name="local-6989586621681117633"><a href="#local-6989586621681117633"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681117633"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-1716"></a><span>   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrF"><span class="hs-identifier hs-var">DiscrF</span></a><span> </span><a name="local-6989586621681117634"><a href="#local-6989586621681117634"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681117634"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1717"></a><span>   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrD"><span class="hs-identifier hs-var">DiscrD</span></a><span> </span><a name="local-6989586621681117635"><a href="#local-6989586621681117635"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681117635"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-1718"></a><span>   </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#DiscrP"><span class="hs-identifier hs-var">DiscrP</span></a><span> </span><a name="local-6989586621681117636"><a href="#local-6989586621681117636"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681117636"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1719"></a><span>   </span><span class="hs-identifier">ppr</span><span> </span><a href="ByteCodeGen.html#NoDiscr"><span class="hs-identifier hs-var">NoDiscr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DEF&quot;</span><span>
</span><a name="line-1720"></a><span>
</span><a name="line-1721"></a><span>
</span><a name="line-1722"></a><span class="hs-identifier">lookupBCEnv_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BCEnv"><span class="hs-identifier hs-type">BCEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-1723"></a><a name="lookupBCEnv_maybe"><a href="ByteCodeGen.html#lookupBCEnv_maybe"><span class="hs-identifier">lookupBCEnv_maybe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span>
</span><a name="line-1724"></a><span>
</span><a name="line-1725"></a><span class="hs-identifier">idSizeW</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-1726"></a><a name="idSizeW"><a href="ByteCodeGen.html#idSizeW"><span class="hs-identifier">idSizeW</span></a></a><span> </span><a name="local-6989586621681118351"><a href="#local-6989586621681118351"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-var">WordOff</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmArgRep.html#argRepSizeW"><span class="hs-identifier hs-var">argRepSizeW</span></a><span> </span><a href="#local-6989586621681118351"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeGen.html#bcIdArgRep"><span class="hs-identifier hs-var">bcIdArgRep</span></a><span>
</span><a name="line-1727"></a><span>
</span><a name="line-1728"></a><span class="hs-identifier">idSizeCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-1729"></a><a name="idSizeCon"><a href="ByteCodeGen.html#idSizeCon"><span class="hs-identifier">idSizeCon</span></a></a><span> </span><a name="local-6989586621681118352"><a href="#local-6989586621681118352"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-var">ByteOff</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">primRepSizeB</span><span> </span><a href="#local-6989586621681118352"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeGen.html#bcIdPrimRep"><span class="hs-identifier hs-var">bcIdPrimRep</span></a><span>
</span><a name="line-1730"></a><span>
</span><a name="line-1731"></a><span class="hs-identifier">bcIdArgRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span>
</span><a name="line-1732"></a><a name="bcIdArgRep"><a href="ByteCodeGen.html#bcIdArgRep"><span class="hs-identifier">bcIdArgRep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="ByteCodeGen.html#bcIdPrimRep"><span class="hs-identifier hs-var">bcIdPrimRep</span></a><span>
</span><a name="line-1733"></a><span>
</span><a name="line-1734"></a><span class="hs-identifier">bcIdPrimRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span>
</span><a name="line-1735"></a><a name="bcIdPrimRep"><a href="ByteCodeGen.html#bcIdPrimRep"><span class="hs-identifier">bcIdPrimRep</span></a></a><span> </span><a name="local-6989586621681118353"><a href="#local-6989586621681118353"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1736"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681118354"><a href="#local-6989586621681118354"><span class="hs-identifier">rep</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typePrimRepArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118353"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118354"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-1738"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1739"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;bcIdPrimRep&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681118353"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681118353"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1740"></a><span>
</span><a name="line-1741"></a><span class="hs-identifier">repSizeWords</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-1742"></a><a name="repSizeWords"><a href="ByteCodeGen.html#repSizeWords"><span class="hs-identifier">repSizeWords</span></a></a><span> </span><a name="local-6989586621681118355"><a href="#local-6989586621681118355"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681118356"><a href="#local-6989586621681118356"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-var">WordOff</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmArgRep.html#argRepSizeW"><span class="hs-identifier hs-var">argRepSizeW</span></a><span> </span><a href="#local-6989586621681118355"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><a href="#local-6989586621681118356"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1743"></a><span>
</span><a name="line-1744"></a><span class="hs-identifier">isFollowableArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1745"></a><a name="isFollowableArg"><a href="ByteCodeGen.html#isFollowableArg"><span class="hs-identifier">isFollowableArg</span></a></a><span> </span><a href="StgCmmArgRep.html#P"><span class="hs-identifier hs-var">P</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1746"></a><span class="hs-identifier">isFollowableArg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1747"></a><span>
</span><a name="line-1748"></a><span class="hs-identifier">isVoidArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1749"></a><a name="isVoidArg"><a href="ByteCodeGen.html#isVoidArg"><span class="hs-identifier">isVoidArg</span></a></a><span> </span><a href="StgCmmArgRep.html#V"><span class="hs-identifier hs-var">V</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1750"></a><span class="hs-identifier">isVoidArg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1751"></a><span>
</span><a name="line-1752"></a><span class="hs-comment">-- See bug #1257</span><span>
</span><a name="line-1753"></a><span class="hs-identifier">multiValException</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681117650"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1754"></a><a name="multiValException"><a href="ByteCodeGen.html#multiValException"><span class="hs-identifier">multiValException</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwGhcException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span>
</span><a name="line-1755"></a><span>  </span><span class="hs-special">(</span><span class="hs-string">&quot;Error: bytecode compiler can't handle unboxed tuples and sums.\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1756"></a><span>   </span><span class="hs-string">&quot;  Possibly due to foreign import/export decls in source.\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1757"></a><span>   </span><span class="hs-string">&quot;  Workaround: use -fobject-code, or compile this module to .o separately.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1758"></a><span>
</span><a name="line-1759"></a><span class="hs-comment">-- | Indicate if the calling convention is supported</span><span>
</span><a name="line-1760"></a><span class="hs-identifier">isSupportedCConv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CCallSpec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1761"></a><a name="isSupportedCConv"><a href="ByteCodeGen.html#isSupportedCConv"><span class="hs-identifier">isSupportedCConv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCallSpec</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681118357"><a href="#local-6989586621681118357"><span class="hs-identifier">cconv</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681118357"><span class="hs-identifier hs-var">cconv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1762"></a><span>   </span><span class="hs-identifier hs-var">CCallConv</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>     </span><span class="hs-comment">-- we explicitly pattern match on every</span><span>
</span><a name="line-1763"></a><span>   </span><span class="hs-identifier hs-var">StdCallConv</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>     </span><span class="hs-comment">-- convention to ensure that a warning</span><span>
</span><a name="line-1764"></a><span>   </span><span class="hs-identifier hs-var">PrimCallConv</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>    </span><span class="hs-comment">-- is triggered when a new one is added</span><span>
</span><a name="line-1765"></a><span>   </span><span class="hs-identifier hs-var">JavaScriptCallConv</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1766"></a><span>   </span><span class="hs-identifier hs-var">CApiConv</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1767"></a><span>
</span><a name="line-1768"></a><span class="hs-comment">-- See bug #10462</span><span>
</span><a name="line-1769"></a><span class="hs-identifier">unsupportedCConvException</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681117649"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1770"></a><a name="unsupportedCConvException"><a href="ByteCodeGen.html#unsupportedCConvException"><span class="hs-identifier">unsupportedCConvException</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwGhcException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span>
</span><a name="line-1771"></a><span>  </span><span class="hs-special">(</span><span class="hs-string">&quot;Error: bytecode compiler can't handle some foreign calling conventions\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1772"></a><span>   </span><span class="hs-string">&quot;  Workaround: use -fobject-code, or compile this module to .o separately.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-identifier">mkSlideB</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="ByteCodeInstr.html#BCInstr"><span class="hs-identifier hs-type">BCInstr</span></a><span>
</span><a name="line-1775"></a><a name="mkSlideB"><a href="ByteCodeGen.html#mkSlideB"><span class="hs-identifier">mkSlideB</span></a></a><span> </span><a name="local-6989586621681118358"><a href="#local-6989586621681118358"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118359"><a href="#local-6989586621681118359"><span class="hs-identifier">nb</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118360"><a href="#local-6989586621681118360"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#mkSlideW"><span class="hs-identifier hs-var">mkSlideW</span></a><span> </span><a href="#local-6989586621681118361"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681118362"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-1776"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1777"></a><span>    </span><span class="hs-glyph">!</span><a name="local-6989586621681118361"><a href="#local-6989586621681118361"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#trunc16W"><span class="hs-identifier hs-var">trunc16W</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118358"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118359"><span class="hs-identifier hs-var">nb</span></a><span>
</span><a name="line-1778"></a><span>    </span><span class="hs-glyph">!</span><a name="local-6989586621681118362"><a href="#local-6989586621681118362"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#bytesToWords"><span class="hs-identifier hs-var">bytesToWords</span></a><span> </span><a href="#local-6989586621681118358"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681118360"><span class="hs-identifier hs-var">db</span></a><span>
</span><a name="line-1779"></a><span>
</span><a name="line-1780"></a><span class="hs-identifier">mkSlideW</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="ByteCodeInstr.html#BCInstr"><span class="hs-identifier hs-type">BCInstr</span></a><span>
</span><a name="line-1781"></a><a name="mkSlideW"><a href="ByteCodeGen.html#mkSlideW"><span class="hs-identifier">mkSlideW</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118363"><a href="#local-6989586621681118363"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681118364"><a href="#local-6989586621681118364"><span class="hs-identifier">ws</span></a></a><span>
</span><a name="line-1782"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118364"><span class="hs-identifier hs-var">ws</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681118365"><span class="hs-identifier hs-var">limit</span></a><span>
</span><a name="line-1783"></a><span>    </span><span class="hs-comment">-- If the amount to slide doesn't fit in a Word16, generate multiple slide</span><span>
</span><a name="line-1784"></a><span>    </span><span class="hs-comment">-- instructions</span><span>
</span><a name="line-1785"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeInstr.html#SLIDE"><span class="hs-identifier hs-var">SLIDE</span></a><span> </span><a href="#local-6989586621681118363"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681118365"><span class="hs-identifier hs-var">limit</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="ByteCodeGen.html#mkSlideW"><span class="hs-identifier hs-var">mkSlideW</span></a><span> </span><a href="#local-6989586621681118363"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118364"><span class="hs-identifier hs-var">ws</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681118365"><span class="hs-identifier hs-var">limit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1786"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681118364"><span class="hs-identifier hs-var">ws</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1787"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-1788"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1789"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#SLIDE"><span class="hs-identifier hs-var">SLIDE</span></a><span> </span><a href="#local-6989586621681118363"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681118364"><span class="hs-identifier hs-var">ws</span></a><span class="hs-special">)</span><span>
</span><a name="line-1790"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1791"></a><span>    </span><span class="hs-identifier">limit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-1792"></a><span>    </span><a name="local-6989586621681118365"><a href="#local-6989586621681118365"><span class="hs-identifier">limit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span>
</span><a name="line-1793"></a><span>
</span><a name="line-1794"></a><span class="hs-identifier">splitApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><a href="#local-6989586621681117648"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><a href="#local-6989586621681117648"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><a href="#local-6989586621681117648"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1795"></a><span>        </span><span class="hs-comment">-- The arguments are returned in *right-to-left* order</span><span>
</span><a name="line-1796"></a><a name="splitApp"><a href="ByteCodeGen.html#splitApp"><span class="hs-identifier">splitApp</span></a></a><span> </span><a name="local-6989586621681118366"><a href="#local-6989586621681118366"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118367"><a href="#local-6989586621681118367"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#bcView"><span class="hs-identifier hs-var">bcView</span></a><span> </span><a href="#local-6989586621681118366"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#splitApp"><span class="hs-identifier hs-var">splitApp</span></a><span> </span><a href="#local-6989586621681118367"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1797"></a><span class="hs-identifier">splitApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118368"><a href="#local-6989586621681118368"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118369"><a href="#local-6989586621681118369"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="ByteCodeGen.html#splitApp"><span class="hs-identifier hs-var">splitApp</span></a><span> </span><a href="#local-6989586621681118368"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1798"></a><span>                                      </span><span class="hs-special">(</span><a name="local-6989586621681118370"><a href="#local-6989586621681118370"><span class="hs-identifier">f'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118370"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118369"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1799"></a><span class="hs-identifier">splitApp</span><span> </span><a name="local-6989586621681118372"><a href="#local-6989586621681118372"><span class="hs-identifier">e</span></a></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118372"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1800"></a><span>
</span><a name="line-1801"></a><span>
</span><a name="line-1802"></a><span class="hs-identifier">bcView</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><a href="#local-6989586621681117647"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><a href="#local-6989586621681117647"><span class="hs-identifier hs-type">ann</span></a><span class="hs-special">)</span><span>
</span><a name="line-1803"></a><span class="hs-comment">-- The &quot;bytecode view&quot; of a term discards</span><span>
</span><a name="line-1804"></a><span class="hs-comment">--  a) type abstractions</span><span>
</span><a name="line-1805"></a><span class="hs-comment">--  b) type applications</span><span>
</span><a name="line-1806"></a><span class="hs-comment">--  c) casts</span><span>
</span><a name="line-1807"></a><span class="hs-comment">--  d) ticks (but not breakpoints)</span><span>
</span><a name="line-1808"></a><span class="hs-comment">-- Type lambdas *can* occur in random expressions,</span><span>
</span><a name="line-1809"></a><span class="hs-comment">-- whereas value lambdas cannot; that is why they are nuked here</span><span>
</span><a name="line-1810"></a><a name="bcView"><a href="ByteCodeGen.html#bcView"><span class="hs-identifier">bcView</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCast</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118373"><a href="#local-6989586621681118373"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681118373"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1811"></a><span class="hs-identifier">bcView</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLam</span><span> </span><a name="local-6989586621681118374"><a href="#local-6989586621681118374"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118375"><a href="#local-6989586621681118375"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621681118374"><span class="hs-identifier hs-var">v</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681118375"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1812"></a><span class="hs-identifier">bcView</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118376"><a href="#local-6989586621681118376"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AnnType</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681118376"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1813"></a><span class="hs-identifier">bcView</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnTick</span><span> </span><span class="hs-identifier hs-var">Breakpoint</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1814"></a><span class="hs-identifier">bcView</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnTick</span><span> </span><a name="local-6989586621681118377"><a href="#local-6989586621681118377"><span class="hs-identifier">_other_tick</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681118378"><a href="#local-6989586621681118378"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681118378"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1815"></a><span class="hs-identifier">bcView</span><span> </span><span class="hs-identifier">_</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1816"></a><span>
</span><a name="line-1817"></a><span class="hs-identifier">isVAtom</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><a href="#local-6989586621681117646"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1818"></a><a name="isVAtom"><a href="ByteCodeGen.html#isVAtom"><span class="hs-identifier">isVAtom</span></a></a><span> </span><a name="local-6989586621681118379"><a href="#local-6989586621681118379"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118380"><a href="#local-6989586621681118380"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#bcView"><span class="hs-identifier hs-var">bcView</span></a><span> </span><a href="#local-6989586621681118379"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#isVAtom"><span class="hs-identifier hs-var">isVAtom</span></a><span> </span><a href="#local-6989586621681118380"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1819"></a><span class="hs-identifier">isVAtom</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681118381"><a href="#local-6989586621681118381"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#isVoidArg"><span class="hs-identifier hs-var">isVoidArg</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#bcIdArgRep"><span class="hs-identifier hs-var">bcIdArgRep</span></a><span> </span><a href="#local-6989586621681118381"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1820"></a><span class="hs-identifier">isVAtom</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCoercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1821"></a><span class="hs-identifier">isVAtom</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1822"></a><span>
</span><a name="line-1823"></a><span class="hs-identifier">atomPrimRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><a href="#local-6989586621681117645"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span>
</span><a name="line-1824"></a><a name="atomPrimRep"><a href="ByteCodeGen.html#atomPrimRep"><span class="hs-identifier">atomPrimRep</span></a></a><span> </span><a name="local-6989586621681118382"><a href="#local-6989586621681118382"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681118383"><a href="#local-6989586621681118383"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#bcView"><span class="hs-identifier hs-var">bcView</span></a><span> </span><a href="#local-6989586621681118382"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#atomPrimRep"><span class="hs-identifier hs-var">atomPrimRep</span></a><span> </span><a href="#local-6989586621681118383"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1825"></a><span class="hs-identifier">atomPrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnVar</span><span> </span><a name="local-6989586621681118384"><a href="#local-6989586621681118384"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#bcIdPrimRep"><span class="hs-identifier hs-var">bcIdPrimRep</span></a><span> </span><a href="#local-6989586621681118384"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1826"></a><span class="hs-identifier">atomPrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnLit</span><span> </span><a name="local-6989586621681118385"><a href="#local-6989586621681118385"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typePrimRep1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">literalType</span><span> </span><a href="#local-6989586621681118385"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-1827"></a><span>
</span><a name="line-1828"></a><span class="hs-comment">-- Trac #12128:</span><span>
</span><a name="line-1829"></a><span class="hs-comment">-- A case expression can be an atom because empty cases evaluate to bottom.</span><span>
</span><a name="line-1830"></a><span class="hs-comment">-- See Note [Empty case alternatives] in coreSyn/CoreSyn.hs</span><span>
</span><a name="line-1831"></a><span class="hs-identifier">atomPrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCase</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681118386"><a href="#local-6989586621681118386"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">typePrimRep</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">LiftedRep</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">LiftedRep</span><span>
</span><a name="line-1832"></a><span class="hs-identifier">atomPrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnCoercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VoidRep</span><span>
</span><a name="line-1833"></a><span class="hs-identifier">atomPrimRep</span><span> </span><a name="local-6989586621681118387"><a href="#local-6989586621681118387"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;atomPrimRep&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deAnnotate'</span><span> </span><a href="#local-6989586621681118387"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1834"></a><span>
</span><a name="line-1835"></a><span class="hs-identifier">atomRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnExpr'</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><a href="#local-6989586621681117644"><span class="hs-identifier hs-type">ann</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span>
</span><a name="line-1836"></a><a name="atomRep"><a href="ByteCodeGen.html#atomRep"><span class="hs-identifier">atomRep</span></a></a><span> </span><a name="local-6989586621681118388"><a href="#local-6989586621681118388"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#atomPrimRep"><span class="hs-identifier hs-var">atomPrimRep</span></a><span> </span><a href="#local-6989586621681118388"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1837"></a><span>
</span><a name="line-1838"></a><span class="hs-comment">-- | Let szsw be the sizes in bytes of some items pushed onto the stack, which</span><span>
</span><a name="line-1839"></a><span class="hs-comment">-- has initial depth @original_depth@.  Return the values which the stack</span><span>
</span><a name="line-1840"></a><span class="hs-comment">-- environment should map these items to.</span><span>
</span><a name="line-1841"></a><span class="hs-identifier">mkStackOffsets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="ByteCodeGen.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">]</span><span>
</span><a name="line-1842"></a><a name="mkStackOffsets"><a href="ByteCodeGen.html#mkStackOffsets"><span class="hs-identifier">mkStackOffsets</span></a></a><span> </span><a name="local-6989586621681118389"><a href="#local-6989586621681118389"><span class="hs-identifier">original_depth</span></a></a><span> </span><a name="local-6989586621681118390"><a href="#local-6989586621681118390"><span class="hs-identifier">szsb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">scanl'</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681118389"><span class="hs-identifier hs-var">original_depth</span></a><span> </span><a href="#local-6989586621681118390"><span class="hs-identifier hs-var">szsb</span></a><span class="hs-special">)</span><span>
</span><a name="line-1843"></a><span>
</span><a name="line-1844"></a><span class="hs-identifier">typeArgRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmArgRep.html#ArgRep"><span class="hs-identifier hs-type">ArgRep</span></a><span>
</span><a name="line-1845"></a><a name="typeArgRep"><a href="ByteCodeGen.html#typeArgRep"><span class="hs-identifier">typeArgRep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmArgRep.html#toArgRep"><span class="hs-identifier hs-var">toArgRep</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">typePrimRep1</span><span>
</span><a name="line-1846"></a><span>
</span><a name="line-1847"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1848"></a><span class="hs-comment">-- The bytecode generator's monad</span><span>
</span><a name="line-1849"></a><span>
</span><a name="line-1850"></a><span class="hs-keyword">data</span><span> </span><a name="BcM_State"><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier">BcM_State</span></a></a><span>
</span><a name="line-1851"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="BcM_State"><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier">BcM_State</span></a></a><span>
</span><a name="line-1852"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="bcm_hsc_env"><a href="ByteCodeGen.html#bcm_hsc_env"><span class="hs-identifier">bcm_hsc_env</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1853"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="uniqSupply"><a href="ByteCodeGen.html#uniqSupply"><span class="hs-identifier">uniqSupply</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>      </span><span class="hs-comment">-- for generating fresh variable names</span><span>
</span><a name="line-1854"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="thisModule"><a href="ByteCodeGen.html#thisModule"><span class="hs-identifier">thisModule</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span>          </span><span class="hs-comment">-- current module (for breakpoints)</span><span>
</span><a name="line-1855"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="nextlabel"><a href="ByteCodeGen.html#nextlabel"><span class="hs-identifier">nextlabel</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>          </span><span class="hs-comment">-- for generating local labels</span><span>
</span><a name="line-1856"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ffis"><a href="ByteCodeGen.html#ffis"><span class="hs-identifier">ffis</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FFIInfo</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- ffi info blocks, to free later</span><span>
</span><a name="line-1857"></a><span>                                         </span><span class="hs-comment">-- Should be free()d when it is GCd</span><span>
</span><a name="line-1858"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="modBreaks"><a href="ByteCodeGen.html#modBreaks"><span class="hs-identifier">modBreaks</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModBreaks</span><span> </span><span class="hs-comment">-- info about breakpoints</span><span>
</span><a name="line-1859"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="breakInfo"><a href="ByteCodeGen.html#breakInfo"><span class="hs-identifier">breakInfo</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-identifier hs-type">CgBreakInfo</span><span>
</span><a name="line-1860"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="topStrings"><a href="ByteCodeGen.html#topStrings"><span class="hs-identifier">topStrings</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- top-level string literals</span><span>
</span><a name="line-1861"></a><span>          </span><span class="hs-comment">-- See Note [generating code for top-level string literal bindings].</span><span>
</span><a name="line-1862"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1863"></a><span>
</span><a name="line-1864"></a><span class="hs-keyword">newtype</span><span> </span><a name="BcM"><a href="ByteCodeGen.html#BcM"><span class="hs-identifier">BcM</span></a></a><span> </span><a name="local-6989586621681117630"><a href="#local-6989586621681117630"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BcM"><a href="ByteCodeGen.html#BcM"><span class="hs-identifier">BcM</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier hs-type">BcM_State</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier hs-type">BcM_State</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117630"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1865"></a><span>
</span><a name="line-1866"></a><span class="hs-identifier">ioToBc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681117643"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117643"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1867"></a><a name="ioToBc"><a href="ByteCodeGen.html#ioToBc"><span class="hs-identifier">ioToBc</span></a></a><span> </span><a name="local-6989586621681118391"><a href="#local-6989586621681118391"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118392"><a href="#local-6989586621681118392"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1868"></a><span>  </span><a name="local-6989586621681118393"><a href="#local-6989586621681118393"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118391"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-1869"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118392"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118393"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1870"></a><span>
</span><a name="line-1871"></a><span class="hs-identifier">runBc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModBreaks</span><span>
</span><a name="line-1872"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1873"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117642"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-1874"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier hs-type">BcM_State</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681117642"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1875"></a><a name="runBc"><a href="ByteCodeGen.html#runBc"><span class="hs-identifier">runBc</span></a></a><span> </span><a name="local-6989586621681118394"><a href="#local-6989586621681118394"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681118395"><a href="#local-6989586621681118395"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621681118396"><a href="#local-6989586621681118396"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621681118397"><a href="#local-6989586621681118397"><span class="hs-identifier">modBreaks</span></a></a><span> </span><a name="local-6989586621681118398"><a href="#local-6989586621681118398"><span class="hs-identifier">topStrings</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><a name="local-6989586621681118399"><a href="#local-6989586621681118399"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1876"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118399"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM_State"><span class="hs-identifier hs-var">BcM_State</span></a><span> </span><a href="#local-6989586621681118394"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681118395"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621681118396"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681118397"><span class="hs-identifier hs-var">modBreaks</span></a><span> </span><span class="hs-identifier hs-var">IntMap.empty</span><span> </span><a href="#local-6989586621681118398"><span class="hs-identifier hs-var">topStrings</span></a><span class="hs-special">)</span><span>
</span><a name="line-1877"></a><span>
</span><a name="line-1878"></a><span class="hs-identifier">thenBc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117640"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117640"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117641"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117641"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1879"></a><a name="thenBc"><a href="ByteCodeGen.html#thenBc"><span class="hs-identifier">thenBc</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><a name="local-6989586621681118400"><a href="#local-6989586621681118400"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681118401"><a href="#local-6989586621681118401"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118402"><a href="#local-6989586621681118402"><span class="hs-identifier">st0</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1880"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681118403"><a href="#local-6989586621681118403"><span class="hs-identifier">st1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118404"><a href="#local-6989586621681118404"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118400"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621681118402"><span class="hs-identifier hs-var">st0</span></a><span>
</span><a name="line-1881"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><a name="local-6989586621681118405"><a href="#local-6989586621681118405"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118401"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621681118404"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-1882"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681118406"><a href="#local-6989586621681118406"><span class="hs-identifier">st2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118407"><a href="#local-6989586621681118407"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118405"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621681118403"><span class="hs-identifier hs-var">st1</span></a><span>
</span><a name="line-1883"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118406"><span class="hs-identifier hs-var">st2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118407"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1884"></a><span>
</span><a name="line-1885"></a><span class="hs-identifier">thenBc_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117638"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117639"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117639"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1886"></a><a name="thenBc_"><a href="ByteCodeGen.html#thenBc_"><span class="hs-identifier">thenBc_</span></a></a><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><a name="local-6989586621681118408"><a href="#local-6989586621681118408"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><a name="local-6989586621681118409"><a href="#local-6989586621681118409"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118410"><a href="#local-6989586621681118410"><span class="hs-identifier">st0</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1887"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681118411"><a href="#local-6989586621681118411"><span class="hs-identifier">st1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118408"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621681118410"><span class="hs-identifier hs-var">st0</span></a><span>
</span><a name="line-1888"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681118412"><a href="#local-6989586621681118412"><span class="hs-identifier">st2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118413"><a href="#local-6989586621681118413"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681118409"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621681118411"><span class="hs-identifier hs-var">st1</span></a><span>
</span><a name="line-1889"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118412"><span class="hs-identifier hs-var">st2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118413"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1890"></a><span>
</span><a name="line-1891"></a><span class="hs-identifier">returnBc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681117637"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><a href="#local-6989586621681117637"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1892"></a><a name="returnBc"><a href="ByteCodeGen.html#returnBc"><span class="hs-identifier">returnBc</span></a></a><span> </span><a name="local-6989586621681118414"><a href="#local-6989586621681118414"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118415"><a href="#local-6989586621681118415"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118415"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118414"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1893"></a><span>
</span><a name="line-1894"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1895"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-1896"></a><span>
</span><a name="line-1897"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1898"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#returnBc"><span class="hs-identifier hs-var">returnBc</span></a><span>
</span><a name="line-1899"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-1900"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541681"><span class="hs-operator">*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#thenBc_"><span class="hs-identifier hs-var">thenBc_</span></a><span>
</span><a name="line-1901"></a><span>
</span><a name="line-1902"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1903"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#thenBc"><span class="hs-identifier hs-var">thenBc</span></a><span>
</span><a name="line-1904"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541100"><span class="hs-operator">&gt;&gt;</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-1905"></a><span>
</span><a name="line-1906"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasDynFlags</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1907"></a><span>    </span><a name="local-8214565720323804398"><span class="hs-identifier">getDynFlags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681117631"><a href="#local-6989586621681117631"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681117631"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bcm_hsc_env</span><span> </span><a href="#local-6989586621681117631"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1908"></a><span>
</span><a name="line-1909"></a><span class="hs-identifier">getHscEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1910"></a><a name="getHscEnv"><a href="ByteCodeGen.html#getHscEnv"><span class="hs-identifier">getHscEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118416"><a href="#local-6989586621681118416"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118416"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">bcm_hsc_env</span><span> </span><a href="#local-6989586621681118416"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1911"></a><span>
</span><a name="line-1912"></a><span class="hs-identifier">emitBc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">FFIInfo</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><a href="ByteCodeInstr.html#ProtoBCO"><span class="hs-identifier hs-type">ProtoBCO</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-1913"></a><a name="emitBc"><a href="ByteCodeGen.html#emitBc"><span class="hs-identifier">emitBc</span></a></a><span> </span><a name="local-6989586621681118417"><a href="#local-6989586621681118417"><span class="hs-identifier">bco</span></a></a><span>
</span><a name="line-1914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118418"><a href="#local-6989586621681118418"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118418"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">{</span><span class="hs-identifier">ffis</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118417"><span class="hs-identifier hs-var">bco</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ffis</span><span> </span><a href="#local-6989586621681118418"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1915"></a><span>
</span><a name="line-1916"></a><span class="hs-identifier">recordFFIBc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-identifier hs-type">C_ffi_cif</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1917"></a><a name="recordFFIBc"><a href="ByteCodeGen.html#recordFFIBc"><span class="hs-identifier">recordFFIBc</span></a></a><span> </span><a name="local-6989586621681118419"><a href="#local-6989586621681118419"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-1918"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118420"><a href="#local-6989586621681118420"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118420"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">{</span><span class="hs-identifier">ffis</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FFIInfo</span><span> </span><a href="#local-6989586621681118419"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ffis</span><span> </span><a href="#local-6989586621681118420"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1919"></a><span>
</span><a name="line-1920"></a><span class="hs-identifier">getLabelBc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-1921"></a><a name="getLabelBc"><a href="ByteCodeGen.html#getLabelBc"><span class="hs-identifier">getLabelBc</span></a></a><span>
</span><a name="line-1922"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118421"><a href="#local-6989586621681118421"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118422"><a href="#local-6989586621681118422"><span class="hs-identifier">nl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nextlabel</span><span> </span><a href="#local-6989586621681118421"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-1923"></a><span>                    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118422"><span class="hs-identifier hs-var">nl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1924"></a><span>                        </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getLabelBc: Ran out of labels&quot;</span><span>
</span><a name="line-1925"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118421"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">{</span><span class="hs-identifier">nextlabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118422"><span class="hs-identifier hs-var">nl</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118422"><span class="hs-identifier hs-var">nl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>
</span><a name="line-1927"></a><span class="hs-identifier">getLabelsBc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word16</span><span class="hs-special">]</span><span>
</span><a name="line-1928"></a><a name="getLabelsBc"><a href="ByteCodeGen.html#getLabelsBc"><span class="hs-identifier">getLabelsBc</span></a></a><span> </span><a name="local-6989586621681118423"><a href="#local-6989586621681118423"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118424"><a href="#local-6989586621681118424"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118425"><a href="#local-6989586621681118425"><span class="hs-identifier">ctr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nextlabel</span><span> </span><a href="#local-6989586621681118424"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-1930"></a><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118424"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">{</span><span class="hs-identifier">nextlabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118425"><span class="hs-identifier hs-var">ctr</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621681118423"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681118425"><span class="hs-identifier hs-var">ctr</span></a><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621681118425"><span class="hs-identifier hs-var">ctr</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621681118423"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1931"></a><span>
</span><a name="line-1932"></a><span class="hs-identifier">getCCArray</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Array</span><span> </span><span class="hs-identifier hs-type">BreakIndex</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1933"></a><a name="getCCArray"><a href="ByteCodeGen.html#getCCArray"><span class="hs-identifier">getCCArray</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118426"><a href="#local-6989586621681118426"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1934"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118427"><a href="#local-6989586621681118427"><span class="hs-identifier">breaks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;ByteCodeGen.getCCArray&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">modBreaks</span><span> </span><a href="#local-6989586621681118426"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1935"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118426"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">modBreaks_ccs</span><span> </span><a href="#local-6989586621681118427"><span class="hs-identifier hs-var">breaks</span></a><span class="hs-special">)</span><span>
</span><a name="line-1936"></a><span>
</span><a name="line-1937"></a><span>
</span><a name="line-1938"></a><span class="hs-identifier">newBreakInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BreakIndex</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CgBreakInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1939"></a><a name="newBreakInfo"><a href="ByteCodeGen.html#newBreakInfo"><span class="hs-identifier">newBreakInfo</span></a></a><span> </span><a name="local-6989586621681118428"><a href="#local-6989586621681118428"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621681118429"><a href="#local-6989586621681118429"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118430"><a href="#local-6989586621681118430"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1940"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118430"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">{</span><span class="hs-identifier">breakInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IntMap.insert</span><span> </span><a href="#local-6989586621681118428"><span class="hs-identifier hs-var">ix</span></a><span> </span><a href="#local-6989586621681118429"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">breakInfo</span><span> </span><a href="#local-6989586621681118430"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span class="hs-identifier">newUnique</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-identifier hs-type">Unique</span><span>
</span><a name="line-1943"></a><a name="newUnique"><a href="ByteCodeGen.html#newUnique"><span class="hs-identifier">newUnique</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1944"></a><span>   </span><span class="hs-glyph">\</span><a name="local-6989586621681118431"><a href="#local-6989586621681118431"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uniqSupply</span><span> </span><a href="#local-6989586621681118431"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1945"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621681118432"><a href="#local-6989586621681118432"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681118433"><a href="#local-6989586621681118433"><span class="hs-identifier">us</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681118434"><a href="#local-6989586621681118434"><span class="hs-identifier">newState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118431"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uniqSupply</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681118433"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1946"></a><span>                           </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118434"><span class="hs-identifier hs-var">newState</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681118432"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1947"></a><span>
</span><a name="line-1948"></a><span class="hs-identifier">getCurrentModule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-1949"></a><a name="getCurrentModule"><a href="ByteCodeGen.html#getCurrentModule"><span class="hs-identifier">getCurrentModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118435"><a href="#local-6989586621681118435"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118435"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">thisModule</span><span> </span><a href="#local-6989586621681118435"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1950"></a><span>
</span><a name="line-1951"></a><span class="hs-identifier">getTopStrings</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1952"></a><a name="getTopStrings"><a href="ByteCodeGen.html#getTopStrings"><span class="hs-identifier">getTopStrings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-var">BcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681118436"><a href="#local-6989586621681118436"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681118436"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">topStrings</span><span> </span><a href="#local-6989586621681118436"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-1953"></a><span>
</span><a name="line-1954"></a><span class="hs-identifier">newId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ByteCodeGen.html#BcM"><span class="hs-identifier hs-type">BcM</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1955"></a><a name="newId"><a href="ByteCodeGen.html#newId"><span class="hs-identifier">newId</span></a></a><span> </span><a name="local-6989586621681118437"><a href="#local-6989586621681118437"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1956"></a><span>    </span><a name="local-6989586621681118438"><a href="#local-6989586621681118438"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-1957"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkSysLocal</span><span> </span><a href="ByteCodeGen.html#tickFS"><span class="hs-identifier hs-var">tickFS</span></a><span> </span><a href="#local-6989586621681118438"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621681118437"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1958"></a><span>
</span><a name="line-1959"></a><span class="hs-identifier">tickFS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>
</span><a name="line-1960"></a><a name="tickFS"><a href="ByteCodeGen.html#tickFS"><span class="hs-identifier">tickFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ticked&quot;</span><span>
</span><a name="line-1961"></a></pre></body></html>