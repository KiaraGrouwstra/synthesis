<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[TcBinds]{TcBinds}
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP, RankNTypes, ScopedTypeVariables #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcBinds</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcBinds.html#tcLocalBinds"><span class="hs-identifier hs-var">tcLocalBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcBinds.html#tcTopBinds"><span class="hs-identifier hs-var">tcTopBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcBinds.html#tcValBinds"><span class="hs-identifier hs-var">tcValBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>                 </span><a href="TcBinds.html#tcHsBootSigs"><span class="hs-identifier hs-var">tcHsBootSigs</span></a><span class="hs-special">,</span><span> </span><a href="TcBinds.html#tcPolyCheck"><span class="hs-identifier hs-var">tcPolyCheck</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>                 </span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>                 </span><a href="TcBinds.html#chooseInferredQuantifiers"><span class="hs-identifier hs-var">chooseInferredQuantifiers</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>                 </span><a href="TcBinds.html#badBootDeclErr"><span class="hs-identifier hs-var">badBootDeclErr</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcMatches.html"><span class="hs-identifier">TcMatches</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcMatches.html#tcGRHSsPat"><span class="hs-identifier hs-var">tcGRHSsPat</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcMatchesFun"><span class="hs-identifier hs-var">tcMatchesFun</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcPatSyn.html"><span class="hs-identifier">TcPatSyn</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcPatSyn.html#tcPatSynDecl"><span class="hs-identifier hs-var">tcPatSynDecl</span></a><span class="hs-special">,</span><span> </span><a href="TcPatSyn.html#tcPatSynBuilderBind"><span class="hs-identifier hs-var">tcPatSynBuilderBind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUserCC</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CCFlavour</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DeclCC</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isHsBootOrSig</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TcSigs.html"><span class="hs-identifier">TcSigs</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcPat.html"><span class="hs-identifier">TcPat</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">normaliseType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span class="hs-special">(</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tidyOpenType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkBoxedTupleTy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">ipClassName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-73"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
               A useful helper function
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-identifier">addTypecheckedBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-80"></a><a name="addTypecheckedBinds"><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier">addTypecheckedBinds</span></a></a><span> </span><a name="local-6989586621683390823"><a href="#local-6989586621683390823"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621683390824"><a href="#local-6989586621683390824"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-81"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isHsBootOrSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_src</span><span> </span><a href="#local-6989586621683390823"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390823"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-comment">-- Do not add the code for record-selector bindings</span><span>
</span><a name="line-83"></a><span>    </span><span class="hs-comment">-- when compiling hs-boot files</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390823"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">unionBags</span><span>
</span><a name="line-85"></a><span>                                            </span><span class="hs-special">(</span><span class="hs-identifier">tcg_binds</span><span> </span><a href="#local-6989586621683390823"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>                                            </span><a href="#local-6989586621683390824"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Type-checking bindings}
*                                                                      *
************************************************************************

@tcBindsAndThen@ typechecks a @HsBinds@.  The &quot;and then&quot; part is because
it needs to know something about the {\em usage} of the things bound,
so that it can create specialisations of them.  So @tcBindsAndThen@
takes a function which, given an extended environment, E, typechecks
the scope of the bindings returning a typechecked thing and (most
important) an LIE.  It is this LIE which is then used as the basis for
specialising the things bound.

@tcBindsAndThen@ also takes a &quot;combiner&quot; which glues together the
bindings and the &quot;thing&quot; to make a new &quot;thing&quot;.

The real work is done by @tcBindWithSigsAndThen@.

Recursive and non-recursive binds are handled in essentially the same
way: because of uniques there are no scoping issues left.  The only
difference is that non-recursive bindings can bind primitive values.

Even for non-recursive binding groups we add typings for each binder
to the LVE for the following reason.  When each individual binding is
checked the type of its LHS is unified with that of its RHS; and
type-checking the LHS of course requires that the binder is in scope.

At the top-level the LIE is sure to contain nothing but constant
dictionaries, which we resolve at the module level.

Note [Polymorphic recursion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The game plan for polymorphic recursion in the code above is

        * Bind any variable for which we have a type signature
          to an Id with a polymorphic type.  Then when type-checking
          the RHSs we'll make a full polymorphic call.

This fine, but if you aren't a bit careful you end up with a horrendous
amount of partial application and (worse) a huge space leak. For example:

        f :: Eq a =&gt; [a] -&gt; [a]
        f xs = ...f...

If we don't take care, after typechecking we get

        f = /\a -&gt; \d::Eq a -&gt; let f' = f a d
                               in
                               \ys:[a] -&gt; ...f'...

Notice the stupid construction of (f a d), which is of course
identical to the function we're executing.  In this case, the
polymorphic recursion isn't being used (but that's a very common case).
This can lead to a massive space leak, from the following top-level defn
(post-typechecking)

        ff :: [Int] -&gt; [Int]
        ff = f Int dEqInt

Now (f dEqInt) evaluates to a lambda that has f' as a free variable; but
f' is another thunk which evaluates to the same thing... and you end
up with a chain of identical values all hung onto by the CAF ff.

        ff = f Int dEqInt

           = let f' = f Int dEqInt in \ys. ...f'...

           = let f' = let f' = f Int dEqInt in \ys. ...f'...
                      in \ys. ...f'...

Etc.

NOTE: a bit of arity anaysis would push the (f a d) inside the (\ys...),
which would make the space leak go away in this case

Solution: when typechecking the RHSs we always have in hand the
*monomorphic* Ids for each binding.  So we just need to make sure that
if (Method f a d) shows up in the constraints emerging from (...f...)
we just use the monomorphic Id.  We achieve this by adding monomorphic Ids
to the &quot;givens&quot; when simplifying constraints.  That's what the &quot;lies_avail&quot;
is doing.

Then we get

        f = /\a -&gt; \d::Eq a -&gt; letrec
                                 fm = \ys:[a] -&gt; ...fm...
                               in
                               fm
-}</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-identifier">tcTopBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-181"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- The TcGblEnv contains the new tcg_binds and tcg_spects</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- The TcLclEnv has an extended type envt for the new bindings</span><span>
</span><a name="line-184"></a><a name="tcTopBinds"><a href="TcBinds.html#tcTopBinds"><span class="hs-identifier">tcTopBinds</span></a></a><span> </span><a name="local-6989586621683390825"><a href="#local-6989586621683390825"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621683390826"><a href="#local-6989586621683390826"><span class="hs-identifier">sigs</span></a></a><span>
</span><a name="line-185"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Pattern synonym bindings populate the global environment</span><span>
</span><a name="line-186"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621683390829"><a href="#local-6989586621683390829"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390830"><a href="#local-6989586621683390830"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390831"><a href="#local-6989586621683390831"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcValBinds"><span class="hs-identifier hs-var">tcValBinds</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><a href="#local-6989586621683390825"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621683390826"><span class="hs-identifier hs-var">sigs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390827"><a href="#local-6989586621683390827"><span class="hs-identifier">gbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-188"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390828"><a href="#local-6989586621683390828"><span class="hs-identifier">lcl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-189"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390827"><span class="hs-identifier hs-var">gbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390828"><span class="hs-identifier hs-var">lcl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390832"><a href="#local-6989586621683390832"><span class="hs-identifier">specs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcImpPrags"><span class="hs-identifier hs-var">tcImpPrags</span></a><span> </span><a href="#local-6989586621683390826"><span class="hs-identifier hs-var">sigs</span></a><span>   </span><span class="hs-comment">-- SPECIALISE prags for imported Ids</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390833"><a href="#local-6989586621683390833"><span class="hs-identifier">complete_matches</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390830"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390831"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcBinds.html#tcCompleteSigs"><span class="hs-identifier hs-var">tcCompleteSigs</span></a><span> </span><a href="#local-6989586621683390826"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-193"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;complete_matches&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390825"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390826"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;complete_matches&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390833"><span class="hs-identifier hs-var">complete_matches</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390834"><a href="#local-6989586621683390834"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390830"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_imp_specs</span><span>
</span><a name="line-197"></a><span>                                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390832"><span class="hs-identifier hs-var">specs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_imp_specs</span><span> </span><a href="#local-6989586621683390830"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-198"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_complete_matches</span><span>
</span><a name="line-199"></a><span>                                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390833"><span class="hs-identifier hs-var">complete_matches</span></a><span>
</span><a name="line-200"></a><span>                                          </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_complete_matches</span><span> </span><a href="#local-6989586621683390830"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-201"></a><span>                           </span><span class="hs-special">`</span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683390829"><span class="hs-identifier hs-var">binds'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390834"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390831"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-comment">-- The top level bindings are flattened into a giant</span><span>
</span><a name="line-205"></a><span>        </span><span class="hs-comment">-- implicitly-mutually-recursive LHsBinds</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- Note [Typechecking Complete Matches]</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- Much like when a user bundled a pattern synonym, the result types of</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- all the constructors in the match pragma must be consistent.</span><span>
</span><a name="line-211"></a><span class="hs-comment">--</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- If we allowed pragmas with inconsistent types then it would be</span><span>
</span><a name="line-213"></a><span class="hs-comment">-- impossible to ever match every constructor in the list and so</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- the pragma would be useless.</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-comment">-- This is only used in `tcCompleteSig`. We fold over all the conlikes,</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- this accumulator keeps track of the first `ConLike` with a concrete</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- return type. After fixing the return type, all other constructors with</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- a fixed return type must agree with this.</span><span>
</span><a name="line-224"></a><span class="hs-comment">--</span><span>
</span><a name="line-225"></a><span class="hs-comment">-- The fields of `Fixed` cache the first conlike and its return type so</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- that that we can compare all the other conlikes to it. The conlike is</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- stored for error messages.</span><span>
</span><a name="line-228"></a><span class="hs-comment">--</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- `Nothing` in the case that the type is fixed by a type signature</span><span>
</span><a name="line-230"></a><span class="hs-keyword">data</span><span> </span><a name="CompleteSigType"><a href="TcBinds.html#CompleteSigType"><span class="hs-identifier">CompleteSigType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="AcceptAny"><a href="TcBinds.html#AcceptAny"><span class="hs-identifier">AcceptAny</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Fixed"><a href="TcBinds.html#Fixed"><span class="hs-identifier">Fixed</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-identifier">tcCompleteSigs</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CompleteMatch</span><span class="hs-special">]</span><span>
</span><a name="line-233"></a><a name="tcCompleteSigs"><a href="TcBinds.html#tcCompleteSigs"><span class="hs-identifier">tcCompleteSigs</span></a></a><span> </span><a name="local-6989586621683390835"><a href="#local-6989586621683390835"><span class="hs-identifier">sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-234"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-235"></a><span>      </span><span class="hs-identifier">doOne</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Sig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CompleteMatch</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>      </span><a name="local-6989586621683390836"><a href="#local-6989586621683390836"><span class="hs-identifier">doOne</span></a></a><span> </span><a name="local-6989586621683390839"><a href="#local-6989586621683390839"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CompleteMatchSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390840"><a href="#local-6989586621683390840"><span class="hs-identifier">lns</span></a></a><span> </span><a name="local-6989586621683390841"><a href="#local-6989586621683390841"><span class="hs-identifier">mtc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-238"></a><span>           </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390839"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-239"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683390841"><span class="hs-identifier hs-var">mtc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-240"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683390843"><span class="hs-identifier hs-var">infer_complete_match</span></a><span>
</span><a name="line-241"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683390855"><a href="#local-6989586621683390855"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683390844"><span class="hs-identifier hs-var">check_complete_match</span></a><span> </span><a href="#local-6989586621683390855"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-242"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span>          </span><a name="local-6989586621683390842"><a href="#local-6989586621683390842"><span class="hs-identifier">checkCLTypes</span></a></a><span> </span><a name="local-6989586621683390846"><a href="#local-6989586621683390846"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621683390838"><span class="hs-identifier hs-var">checkCLType</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390846"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683390840"><span class="hs-identifier hs-var">lns</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>          </span><a name="local-6989586621683390843"><a href="#local-6989586621683390843"><span class="hs-identifier">infer_complete_match</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-247"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621683390847"><a href="#local-6989586621683390847"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390848"><a href="#local-6989586621683390848"><span class="hs-identifier">cls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390842"><span class="hs-identifier hs-var">checkCLTypes</span></a><span> </span><a href="TcBinds.html#AcceptAny"><span class="hs-identifier hs-var">AcceptAny</span></a><span>
</span><a name="line-248"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683390847"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-249"></a><span>              </span><a href="TcBinds.html#AcceptAny"><span class="hs-identifier hs-var">AcceptAny</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621683390837"><span class="hs-identifier hs-var">ambiguousError</span></a><span>
</span><a name="line-250"></a><span>              </span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390849"><a href="#local-6989586621683390849"><span class="hs-identifier">tc</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683390845"><span class="hs-identifier hs-var">mkMatch</span></a><span> </span><a href="#local-6989586621683390848"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683390849"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span>          </span><a name="local-6989586621683390844"><a href="#local-6989586621683390844"><span class="hs-identifier">check_complete_match</span></a></a><span> </span><a name="local-6989586621683390850"><a href="#local-6989586621683390850"><span class="hs-identifier">tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-253"></a><span>            </span><a name="local-6989586621683390851"><a href="#local-6989586621683390851"><span class="hs-identifier">ty_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLocatedTyCon"><span class="hs-identifier hs-var">tcLookupLocatedTyCon</span></a><span> </span><a href="#local-6989586621683390850"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-254"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683390852"><a href="#local-6989586621683390852"><span class="hs-identifier">cls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390842"><span class="hs-identifier hs-var">checkCLTypes</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683390851"><span class="hs-identifier hs-var">ty_con</span></a><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683390845"><span class="hs-identifier hs-var">mkMatch</span></a><span> </span><a href="#local-6989586621683390852"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683390851"><span class="hs-identifier hs-var">ty_con</span></a><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>          </span><span class="hs-identifier">mkMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompleteMatch</span><span>
</span><a name="line-258"></a><span>          </span><a name="local-6989586621683390845"><a href="#local-6989586621683390845"><span class="hs-identifier">mkMatch</span></a></a><span> </span><a name="local-6989586621683390853"><a href="#local-6989586621683390853"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621683390854"><a href="#local-6989586621683390854"><span class="hs-identifier">ty_con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CompleteMatch</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-259"></a><span>            </span><span class="hs-identifier">completeMatchConLikes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">conLikeName</span><span> </span><a href="#local-6989586621683390853"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span>
</span><a name="line-260"></a><span>            </span><span class="hs-identifier">completeMatchTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683390854"><span class="hs-identifier hs-var">ty_con</span></a><span>
</span><a name="line-261"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-262"></a><span>      </span><span class="hs-identifier">doOne</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span>      </span><span class="hs-identifier">ambiguousError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-265"></a><span>      </span><a name="local-6989586621683390837"><a href="#local-6989586621683390837"><span class="hs-identifier">ambiguousError</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-266"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A type signature must be provided for a set of polymorphic&quot;</span><span>
</span><a name="line-267"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;pattern synonyms.&quot;</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span>      </span><span class="hs-comment">-- See note [Typechecking Complete Matches]</span><span>
</span><a name="line-271"></a><span>      </span><span class="hs-identifier">checkCLType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#CompleteSigType"><span class="hs-identifier hs-type">CompleteSigType</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-272"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#CompleteSigType"><span class="hs-identifier hs-type">CompleteSigType</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>      </span><a name="local-6989586621683390838"><a href="#local-6989586621683390838"><span class="hs-identifier">checkCLType</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683390856"><a href="#local-6989586621683390856"><span class="hs-identifier">cst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390857"><a href="#local-6989586621683390857"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683390858"><a href="#local-6989586621683390858"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-274"></a><span>        </span><a name="local-6989586621683390859"><a href="#local-6989586621683390859"><span class="hs-identifier">cl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcEnv.html#tcLookupConLike"><span class="hs-identifier hs-var">tcLookupConLike</span></a><span> </span><a href="#local-6989586621683390858"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-275"></a><span>        </span><span class="hs-keyword">let</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683390860"><a href="#local-6989586621683390860"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFullSig</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span>
</span><a name="line-276"></a><span>              </span><a name="local-6989586621683390861"><a href="#local-6989586621683390861"><span class="hs-identifier">res_ty_con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621683390860"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-277"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390856"><span class="hs-identifier hs-var">cst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390861"><span class="hs-identifier hs-var">res_ty_con</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-278"></a><span>          </span><span class="hs-special">(</span><a href="TcBinds.html#AcceptAny"><span class="hs-identifier hs-var">AcceptAny</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#AcceptAny"><span class="hs-identifier hs-var">AcceptAny</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683390857"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>          </span><span class="hs-special">(</span><a href="TcBinds.html#AcceptAny"><span class="hs-identifier hs-var">AcceptAny</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683390862"><a href="#local-6989586621683390862"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683390862"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683390857"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>          </span><span class="hs-special">(</span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><a name="local-6989586621683390863"><a href="#local-6989586621683390863"><span class="hs-identifier">mfcl</span></a></a><span> </span><a name="local-6989586621683390864"><a href="#local-6989586621683390864"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><a href="#local-6989586621683390863"><span class="hs-identifier hs-var">mfcl</span></a><span> </span><a href="#local-6989586621683390864"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683390857"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>          </span><span class="hs-special">(</span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><a name="local-6989586621683390865"><a href="#local-6989586621683390865"><span class="hs-identifier">mfcl</span></a></a><span> </span><a name="local-6989586621683390866"><a href="#local-6989586621683390866"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683390867"><a href="#local-6989586621683390867"><span class="hs-identifier">tc'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-282"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683390866"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683390867"><span class="hs-identifier hs-var">tc'</span></a><span>
</span><a name="line-283"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#Fixed"><span class="hs-identifier hs-var">Fixed</span></a><span> </span><a href="#local-6989586621683390865"><span class="hs-identifier hs-var">mfcl</span></a><span> </span><a href="#local-6989586621683390866"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683390857"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683390865"><span class="hs-identifier hs-var">mfcl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-285"></a><span>                     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-286"></a><span>                      </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-287"></a><span>                        </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621683390868"><span class="hs-identifier hs-var">typeSigErrMsg</span></a><span>
</span><a name="line-288"></a><span>                     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683390871"><a href="#local-6989586621683390871"><span class="hs-identifier">cl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390869"><span class="hs-identifier hs-var">errMsg</span></a><span> </span><a href="#local-6989586621683390871"><span class="hs-identifier hs-var">cl</span></a><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-290"></a><span>              </span><span class="hs-identifier">typeSigErrMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-291"></a><span>              </span><a name="local-6989586621683390868"><a href="#local-6989586621683390868"><span class="hs-identifier">typeSigErrMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-292"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Couldn't match expected type&quot;</span><span>
</span><a name="line-293"></a><span>                      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390866"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>                      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with&quot;</span><span>
</span><a name="line-295"></a><span>                      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390867"><span class="hs-identifier hs-var">tc'</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>              </span><span class="hs-identifier">errMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-298"></a><span>              </span><a name="local-6989586621683390869"><a href="#local-6989586621683390869"><span class="hs-identifier">errMsg</span></a></a><span> </span><a name="local-6989586621683390870"><a href="#local-6989586621683390870"><span class="hs-identifier">fcl</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-299"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot form a group of complete patterns from patterns&quot;</span><span>
</span><a name="line-300"></a><span>                  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390870"><span class="hs-identifier hs-var">fcl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390859"><span class="hs-identifier hs-var">cl</span></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>                  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;as they match different type constructors&quot;</span><span>
</span><a name="line-302"></a><span>                  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390866"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>                               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;resp.&quot;</span><span>
</span><a name="line-304"></a><span>                               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390867"><span class="hs-identifier hs-var">tc'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="#local-6989586621683390836"><span class="hs-identifier hs-var">doOne</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683390835"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">tcHsBootSigs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-308"></a><span class="hs-comment">-- A hs-boot file has only one BindGroup, and it only has type</span><span>
</span><a name="line-309"></a><span class="hs-comment">-- signatures in it.  The renamer checked all this</span><span>
</span><a name="line-310"></a><a name="tcHsBootSigs"><a href="TcBinds.html#tcHsBootSigs"><span class="hs-identifier">tcHsBootSigs</span></a></a><span> </span><a name="local-6989586621683390872"><a href="#local-6989586621683390872"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621683390873"><a href="#local-6989586621683390873"><span class="hs-identifier">sigs</span></a></a><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683390872"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span> </span><a href="TcBinds.html#badBootDeclErr"><span class="hs-identifier hs-var">badBootDeclErr</span></a><span>
</span><a name="line-312"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="#local-6989586621683390874"><span class="hs-identifier hs-var">tc_boot_sig</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isTypeLSig</span><span> </span><a href="#local-6989586621683390873"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-314"></a><span>    </span><a name="local-6989586621683390874"><a href="#local-6989586621683390874"><span class="hs-identifier">tc_boot_sig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390875"><a href="#local-6989586621683390875"><span class="hs-identifier">lnames</span></a></a><span> </span><a name="local-6989586621683390876"><a href="#local-6989586621683390876"><span class="hs-identifier">hs_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683390877"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683390875"><span class="hs-identifier hs-var">lnames</span></a><span>
</span><a name="line-315"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-316"></a><span>        </span><a name="local-6989586621683390877"><a href="#local-6989586621683390877"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390878"><a href="#local-6989586621683390878"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390879"><a href="#local-6989586621683390879"><span class="hs-identifier">sigma_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsSigWcType"><span class="hs-identifier hs-var">tcHsSigWcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683390878"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683390876"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-318"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVanillaGlobal</span><span> </span><a href="#local-6989586621683390878"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683390879"><span class="hs-identifier hs-var">sigma_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-319"></a><span>        </span><span class="hs-comment">-- Notice that we make GlobalIds, not LocalIds</span><span>
</span><a name="line-320"></a><span>    </span><span class="hs-identifier">tc_boot_sig</span><span> </span><a name="local-6989586621683390880"><a href="#local-6989586621683390880"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcHsBootSigs/tc_boot_sig&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390880"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-identifier">badBootDeclErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span>
</span><a name="line-323"></a><a name="badBootDeclErr"><a href="TcBinds.html#badBootDeclErr"><span class="hs-identifier">badBootDeclErr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal declarations in an hs-boot file&quot;</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-326"></a><span class="hs-identifier">tcLocalBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsLocalBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390822"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-327"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsLocalBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390822"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><a name="tcLocalBinds"><a href="TcBinds.html#tcLocalBinds"><span class="hs-identifier">tcLocalBinds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EmptyLocalBinds</span><span> </span><a name="local-6989586621683390881"><a href="#local-6989586621683390881"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683390882"><a href="#local-6989586621683390882"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390883"><a href="#local-6989586621683390883"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390882"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-331"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EmptyLocalBinds</span><span> </span><a href="#local-6989586621683390881"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390883"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-identifier">tcLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><a name="local-6989586621683390884"><a href="#local-6989586621683390884"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><a name="local-6989586621683390885"><a href="#local-6989586621683390885"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621683390886"><a href="#local-6989586621683390886"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683390887"><a href="#local-6989586621683390887"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-334"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390888"><a href="#local-6989586621683390888"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390889"><a href="#local-6989586621683390889"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcValBinds"><span class="hs-identifier hs-var">tcValBinds</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621683390885"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621683390886"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-6989586621683390887"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-335"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><a href="#local-6989586621683390884"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><a href="#local-6989586621683390888"><span class="hs-identifier hs-var">binds'</span></a><span> </span><a href="#local-6989586621683390886"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390889"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-336"></a><span class="hs-identifier">tcLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValBinds</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcLocalBinds&quot;</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-identifier">tcLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><a name="local-6989586621683390890"><a href="#local-6989586621683390890"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390891"><a href="#local-6989586621683390891"><span class="hs-identifier">ip_binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683390892"><a href="#local-6989586621683390892"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390908"><a href="#local-6989586621683390908"><span class="hs-identifier">ipClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">ipClassName</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390909"><a href="#local-6989586621683390909"><span class="hs-identifier">given_ips</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390910"><a href="#local-6989586621683390910"><span class="hs-identifier">ip_binds'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-341"></a><span>            </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocSndM"><span class="hs-identifier hs-var">wrapLocSndM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390894"><span class="hs-identifier hs-var">tc_ip_bind</span></a><span> </span><a href="#local-6989586621683390908"><span class="hs-identifier hs-var">ipClass</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683390891"><span class="hs-identifier hs-var">ip_binds</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>        </span><span class="hs-comment">-- If the binding binds ?x = E, we  must now</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-comment">-- discharge any ?x constraints in expr_lie</span><span>
</span><a name="line-345"></a><span>        </span><span class="hs-comment">-- See Note [Implicit parameter untouchables]</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390911"><a href="#local-6989586621683390911"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390912"><a href="#local-6989586621683390912"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPSkol</span><span> </span><a href="#local-6989586621683390893"><span class="hs-identifier hs-var">ips</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>                                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683390909"><span class="hs-identifier hs-var">given_ips</span></a><span> </span><a href="#local-6989586621683390892"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><a href="#local-6989586621683390890"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBinds</span><span> </span><a href="#local-6989586621683390911"><span class="hs-identifier hs-var">ev_binds</span></a><span> </span><a href="#local-6989586621683390910"><span class="hs-identifier hs-var">ip_binds'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390912"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-351"></a><span>    </span><a name="local-6989586621683390893"><a href="#local-6989586621683390893"><span class="hs-identifier">ips</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683390896"><span class="hs-identifier hs-var">ip</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390896"><a href="#local-6989586621683390896"><span class="hs-identifier">ip</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390891"><span class="hs-identifier hs-var">ip_binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>        </span><span class="hs-comment">-- I wonder if we should do these one at at time</span><span>
</span><a name="line-354"></a><span>        </span><span class="hs-comment">-- Consider     ?x = 4</span><span>
</span><a name="line-355"></a><span>        </span><span class="hs-comment">--              ?y = ?x + 1</span><span>
</span><a name="line-356"></a><span>    </span><a name="local-6989586621683390894"><a href="#local-6989586621683390894"><span class="hs-identifier">tc_ip_bind</span></a></a><span> </span><a name="local-6989586621683390897"><a href="#local-6989586621683390897"><span class="hs-identifier">ipClass</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390898"><a href="#local-6989586621683390898"><span class="hs-identifier">ip</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683390899"><a href="#local-6989586621683390899"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390900"><a href="#local-6989586621683390900"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-358"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390901"><a href="#local-6989586621683390901"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hsIPNameFS</span><span> </span><a href="#local-6989586621683390898"><span class="hs-identifier hs-var">ip</span></a><span>
</span><a name="line-359"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390902"><a href="#local-6989586621683390902"><span class="hs-identifier">ip_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newDict"><span class="hs-identifier hs-var">newDict</span></a><span> </span><a href="#local-6989586621683390897"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683390901"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390900"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-360"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390903"><a href="#local-6989586621683390903"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683390899"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683390900"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390904"><a href="#local-6989586621683390904"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390895"><span class="hs-identifier hs-var">toDict</span></a><span> </span><a href="#local-6989586621683390897"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><a href="#local-6989586621683390901"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683390900"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683390903"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-362"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390902"><span class="hs-identifier hs-var">ip_id</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBind</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621683390902"><span class="hs-identifier hs-var">ip_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683390904"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-363"></a><span>    </span><span class="hs-identifier">tc_ip_bind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_ip_bind&quot;</span><span>
</span><a name="line-364"></a><span>    </span><span class="hs-identifier">tc_ip_bind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XIPBind</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_ip_bind&quot;</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>    </span><span class="hs-comment">-- Coerces a `t` into a dictionry for `IP &quot;x&quot; t`.</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-comment">-- co : t -&gt; IP &quot;x&quot; t</span><span>
</span><a name="line-368"></a><span>    </span><a name="local-6989586621683390895"><a href="#local-6989586621683390895"><span class="hs-identifier">toDict</span></a></a><span> </span><a name="local-6989586621683390905"><a href="#local-6989586621683390905"><span class="hs-identifier">ipClass</span></a></a><span> </span><a name="local-6989586621683390906"><a href="#local-6989586621683390906"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683390907"><a href="#local-6989586621683390907"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkWpCastR</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-369"></a><span>                          </span><span class="hs-identifier hs-var">wrapIP</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683390905"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683390906"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621683390907"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-identifier">tcLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsIPBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcLocalBinds&quot;</span><span>
</span><a name="line-372"></a><span class="hs-identifier">tcLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsLocalBindsLR</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcLocalBinds&quot;</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-comment">{- Note [Implicit parameter untouchables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We add the type variables in the types of the implicit parameters
as untouchables, not so much because we really must not unify them,
but rather because we otherwise end up with constraints like this
    Num alpha, Implic { wanted = alpha ~ Int }
The constraint solver solves alpha~Int by unification, but then
doesn't float that solved constraint out (it's not an unsolved
wanted).  Result disaster: the (Num alpha) is again solved, this
time by defaulting.  No no no.

However [Oct 10] this is all handled automatically by the
untouchable-range idea.
-}</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-identifier">tcValBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>
</span><a name="line-390"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-391"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390821"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-392"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390821"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><a name="tcValBinds"><a href="TcBinds.html#tcValBinds"><span class="hs-identifier">tcValBinds</span></a></a><span> </span><a name="local-6989586621683390913"><a href="#local-6989586621683390913"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621683390914"><a href="#local-6989586621683390914"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621683390915"><a href="#local-6989586621683390915"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-6989586621683390916"><a href="#local-6989586621683390916"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-395"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390917"><a href="#local-6989586621683390917"><span class="hs-identifier">patsyns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getPatSynBinds</span><span> </span><a href="#local-6989586621683390914"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span>            </span><span class="hs-comment">-- Typecheck the signature</span><span>
</span><a name="line-398"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390918"><a href="#local-6989586621683390918"><span class="hs-identifier">poly_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390919"><a href="#local-6989586621683390919"><span class="hs-identifier">sig_fn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcAddPatSynPlaceholders"><span class="hs-identifier hs-var">tcAddPatSynPlaceholders</span></a><span> </span><a href="#local-6989586621683390917"><span class="hs-identifier hs-var">patsyns</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-399"></a><span>                                </span><a href="TcSigs.html#tcTySigs"><span class="hs-identifier hs-var">tcTySigs</span></a><span> </span><a href="#local-6989586621683390915"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390920"><a href="#local-6989586621683390920"><span class="hs-identifier">prag_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#mkPragEnv"><span class="hs-identifier hs-var">mkPragEnv</span></a><span> </span><a href="#local-6989586621683390915"><span class="hs-identifier hs-var">sigs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unionBags</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span> </span><a href="#local-6989586621683390914"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span>                </span><span class="hs-comment">-- Extend the envt right away with all the Ids</span><span>
</span><a name="line-404"></a><span>                </span><span class="hs-comment">-- declared with complete type signatures</span><span>
</span><a name="line-405"></a><span>                </span><span class="hs-comment">-- Do not extend the TcBinderStack; instead</span><span>
</span><a name="line-406"></a><span>                </span><span class="hs-comment">-- we extend it on a per-rhs basis in tcExtendForRhs</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendSigIds"><span class="hs-identifier hs-var">tcExtendSigIds</span></a><span> </span><a href="#local-6989586621683390913"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390918"><span class="hs-identifier hs-var">poly_ids</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-408"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390925"><a href="#local-6989586621683390925"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390926"><a href="#local-6989586621683390926"><span class="hs-identifier">extra_binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390927"><a href="#local-6989586621683390927"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcBindGroups"><span class="hs-identifier hs-var">tcBindGroups</span></a><span> </span><a href="#local-6989586621683390913"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390919"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390920"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683390914"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-409"></a><span>                   </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390921"><a href="#local-6989586621683390921"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390916"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-410"></a><span>                     </span><span class="hs-comment">-- See Note [Pattern synonym builders don't yield dependencies]</span><span>
</span><a name="line-411"></a><span>                     </span><span class="hs-comment">--     in RnBinds</span><span>
</span><a name="line-412"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390922"><a href="#local-6989586621683390922"><span class="hs-identifier">patsyn_builders</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcPatSyn.html#tcPatSynBuilderBind"><span class="hs-identifier hs-var">tcPatSynBuilderBind</span></a><span> </span><a href="#local-6989586621683390917"><span class="hs-identifier hs-var">patsyns</span></a><span>
</span><a name="line-413"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390923"><a href="#local-6989586621683390923"><span class="hs-identifier">extra_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRecursive</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390924"><span class="hs-identifier hs-var">builder</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683390924"><a href="#local-6989586621683390924"><span class="hs-identifier">builder</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390922"><span class="hs-identifier hs-var">patsyn_builders</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-414"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390923"><span class="hs-identifier hs-var">extra_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390921"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-415"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390925"><span class="hs-identifier hs-var">binds'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683390926"><span class="hs-identifier hs-var">extra_binds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390927"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-418"></a><span class="hs-identifier">tcBindGroups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-419"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390820"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-420"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390820"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span class="hs-comment">-- Typecheck a whole lot of value bindings,</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- one strongly-connected component at a time</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- Here a &quot;strongly connected component&quot; has the strightforward</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- meaning of a group of bindings that mention each other,</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- ignoring type signatures (that part comes later)</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><a name="tcBindGroups"><a href="TcBinds.html#tcBindGroups"><span class="hs-identifier">tcBindGroups</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621683390928"><a href="#local-6989586621683390928"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-428"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390929"><a href="#local-6989586621683390929"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390928"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-429"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390929"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">tcBindGroups</span><span> </span><a name="local-6989586621683390930"><a href="#local-6989586621683390930"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621683390931"><a href="#local-6989586621683390931"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683390932"><a href="#local-6989586621683390932"><span class="hs-identifier">prag_fn</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683390933"><a href="#local-6989586621683390933"><span class="hs-identifier">group</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683390934"><a href="#local-6989586621683390934"><span class="hs-identifier">groups</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683390935"><a href="#local-6989586621683390935"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [Closed binder groups]</span><span>
</span><a name="line-433"></a><span>          </span><a name="local-6989586621683390936"><a href="#local-6989586621683390936"><span class="hs-identifier">type_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier hs-var">getLclTypeEnv</span></a><span>
</span><a name="line-434"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390937"><a href="#local-6989586621683390937"><span class="hs-identifier">closed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#isClosedBndrGroup"><span class="hs-identifier hs-var">isClosedBndrGroup</span></a><span> </span><a href="#local-6989586621683390936"><span class="hs-identifier hs-var">type_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683390933"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390938"><a href="#local-6989586621683390938"><span class="hs-identifier">group'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390939"><a href="#local-6989586621683390939"><span class="hs-identifier">groups'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390940"><a href="#local-6989586621683390940"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tc_group"><span class="hs-identifier hs-var">tc_group</span></a><span> </span><a href="#local-6989586621683390930"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390931"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390932"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683390933"><span class="hs-identifier hs-var">group</span></a><span> </span><a href="#local-6989586621683390937"><span class="hs-identifier hs-var">closed</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-437"></a><span>                   </span><a href="TcBinds.html#tcBindGroups"><span class="hs-identifier hs-var">tcBindGroups</span></a><span> </span><a href="#local-6989586621683390930"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390931"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390932"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683390934"><span class="hs-identifier hs-var">groups</span></a><span> </span><a href="#local-6989586621683390935"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-438"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390938"><span class="hs-identifier hs-var">group'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683390939"><span class="hs-identifier hs-var">groups'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390940"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span class="hs-comment">-- Note [Closed binder groups]</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-442"></a><span class="hs-comment">--</span><span>
</span><a name="line-443"></a><span class="hs-comment">--  A mutually recursive group is &quot;closed&quot; if all of the free variables of</span><span>
</span><a name="line-444"></a><span class="hs-comment">--  the bindings are closed. For example</span><span>
</span><a name="line-445"></a><span class="hs-comment">--</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- &gt;  h = \x -&gt; let f = ...g...</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- &gt;                g = ....f...x...</span><span>
</span><a name="line-448"></a><span class="hs-comment">-- &gt;             in ...</span><span>
</span><a name="line-449"></a><span class="hs-comment">--</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- Here @g@ is not closed because it mentions @x@; and hence neither is @f@</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- closed.</span><span>
</span><a name="line-452"></a><span class="hs-comment">--</span><span>
</span><a name="line-453"></a><span class="hs-comment">-- So we need to compute closed-ness on each strongly connected components,</span><span>
</span><a name="line-454"></a><span class="hs-comment">-- before we sub-divide it based on what type signatures it has.</span><span>
</span><a name="line-455"></a><span class="hs-comment">--</span><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-458"></a><span class="hs-identifier">tc_group</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683390819"><a href="#local-6989586621683390819"><span class="hs-identifier">thing</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-459"></a><span>            </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-460"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsGroupClosed</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390819"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-461"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390819"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-comment">-- Typecheck one strongly-connected component of the original program.</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- We get a list of groups back, because there may</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- be specialisations etc as well</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><a name="tc_group"><a href="TcBinds.html#tc_group"><span class="hs-identifier">tc_group</span></a></a><span> </span><a name="local-6989586621683390941"><a href="#local-6989586621683390941"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621683390942"><a href="#local-6989586621683390942"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683390943"><a href="#local-6989586621683390943"><span class="hs-identifier">prag_fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRecursive</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683390944"><a href="#local-6989586621683390944"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683390945"><a href="#local-6989586621683390945"><span class="hs-identifier">closed</span></a></a><span> </span><a name="local-6989586621683390946"><a href="#local-6989586621683390946"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-468"></a><span>        </span><span class="hs-comment">-- A single non-recursive binding</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-comment">-- We want to keep non-recursive things non-recursive</span><span>
</span><a name="line-470"></a><span>        </span><span class="hs-comment">-- so that we desugar unlifted bindings correctly</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683390947"><a href="#local-6989586621683390947"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621683390944"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-472"></a><span>                 </span><span class="hs-special">[</span><a name="local-6989586621683390948"><a href="#local-6989586621683390948"><span class="hs-identifier">bind</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683390948"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-473"></a><span>                 </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_group: empty list of binds&quot;</span><span>
</span><a name="line-474"></a><span>                 </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_group: NonRecursive binds is not a singleton bag&quot;</span><span>
</span><a name="line-475"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390949"><a href="#local-6989586621683390949"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390950"><a href="#local-6989586621683390950"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tc_single"><span class="hs-identifier hs-var">tc_single</span></a><span> </span><a href="#local-6989586621683390941"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390942"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390943"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683390947"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621683390945"><span class="hs-identifier hs-var">closed</span></a><span>
</span><a name="line-476"></a><span>                                     </span><a href="#local-6989586621683390946"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-477"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRecursive</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390949"><span class="hs-identifier hs-var">bind'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390950"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-identifier">tc_group</span><span> </span><a name="local-6989586621683390951"><a href="#local-6989586621683390951"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621683390952"><a href="#local-6989586621683390952"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683390953"><a href="#local-6989586621683390953"><span class="hs-identifier">prag_fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Recursive</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683390954"><a href="#local-6989586621683390954"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683390955"><a href="#local-6989586621683390955"><span class="hs-identifier">closed</span></a></a><span> </span><a name="local-6989586621683390956"><a href="#local-6989586621683390956"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- To maximise polymorphism, we do a new</span><span>
</span><a name="line-481"></a><span>        </span><span class="hs-comment">-- strongly-connected-component analysis, this time omitting</span><span>
</span><a name="line-482"></a><span>        </span><span class="hs-comment">-- any references to variables with type signatures.</span><span>
</span><a name="line-483"></a><span>        </span><span class="hs-comment">-- (This used to be optional, but isn't now.)</span><span>
</span><a name="line-484"></a><span>        </span><span class="hs-comment">-- See Note [Polymorphic recursion] in HsBinds.</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_group rec&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprLHsBinds</span><span> </span><a href="#local-6989586621683390954"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621683390957"><span class="hs-identifier hs-var">hasPatSyn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcBinds.html#recursivePatSynErr"><span class="hs-identifier hs-var">recursivePatSynErr</span></a><span> </span><a href="#local-6989586621683390954"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-487"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390974"><a href="#local-6989586621683390974"><span class="hs-identifier">binds1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390975"><a href="#local-6989586621683390975"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390960"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683390959"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-488"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Recursive</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390974"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390975"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-489"></a><span>                </span><span class="hs-comment">-- Rec them all together</span><span>
</span><a name="line-490"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-491"></a><span>    </span><a name="local-6989586621683390957"><a href="#local-6989586621683390957"><span class="hs-identifier">hasPatSyn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">anyBag</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390958"><span class="hs-identifier hs-var">isPatSyn</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683390954"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-492"></a><span>    </span><a name="local-6989586621683390958"><a href="#local-6989586621683390958"><span class="hs-identifier">isPatSyn</span></a></a><span> </span><span class="hs-identifier hs-var">PatSynBind</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-493"></a><span>    </span><span class="hs-identifier">isPatSyn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span>    </span><span class="hs-identifier">sccs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-496"></a><span>    </span><a name="local-6989586621683390959"><a href="#local-6989586621683390959"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#mkEdges"><span class="hs-identifier hs-var">mkEdges</span></a><span> </span><a href="#local-6989586621683390952"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390954"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390819"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>    </span><a name="local-6989586621683390960"><a href="#local-6989586621683390960"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683390963"><a href="#local-6989586621683390963"><span class="hs-identifier">scc</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683390964"><a href="#local-6989586621683390964"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390965"><a href="#local-6989586621683390965"><span class="hs-identifier">binds1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390966"><a href="#local-6989586621683390966"><span class="hs-identifier">ids1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390961"><span class="hs-identifier hs-var">tc_scc</span></a><span> </span><a href="#local-6989586621683390963"><span class="hs-identifier hs-var">scc</span></a><span>
</span><a name="line-500"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390967"><a href="#local-6989586621683390967"><span class="hs-identifier">binds2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390968"><a href="#local-6989586621683390968"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendLetEnv"><span class="hs-identifier hs-var">tcExtendLetEnv</span></a><span> </span><a href="#local-6989586621683390951"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390952"><span class="hs-identifier hs-var">sig_fn</span></a><span>
</span><a name="line-501"></a><span>                                                            </span><a href="#local-6989586621683390955"><span class="hs-identifier hs-var">closed</span></a><span> </span><a href="#local-6989586621683390966"><span class="hs-identifier hs-var">ids1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-502"></a><span>                                             </span><a href="#local-6989586621683390960"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683390964"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-503"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390965"><span class="hs-identifier hs-var">binds1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683390967"><span class="hs-identifier hs-var">binds2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390968"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-504"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683390969"><a href="#local-6989586621683390969"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683390956"><span class="hs-identifier hs-var">thing_inside</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390969"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span>    </span><a name="local-6989586621683390961"><a href="#local-6989586621683390961"><span class="hs-identifier">tc_scc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621683390970"><a href="#local-6989586621683390970"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390962"><span class="hs-identifier hs-var">tc_sub_group</span></a><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683390970"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">]</span><span>
</span><a name="line-507"></a><span>    </span><span class="hs-identifier">tc_scc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621683390971"><a href="#local-6989586621683390971"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683390962"><span class="hs-identifier hs-var">tc_sub_group</span></a><span> </span><span class="hs-identifier hs-var">Recursive</span><span>    </span><a href="#local-6989586621683390971"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-508"></a><span>
</span><a name="line-509"></a><span>    </span><a name="local-6989586621683390962"><a href="#local-6989586621683390962"><span class="hs-identifier">tc_sub_group</span></a></a><span> </span><a name="local-6989586621683390972"><a href="#local-6989586621683390972"><span class="hs-identifier">rec_tc</span></a></a><span> </span><a name="local-6989586621683390973"><a href="#local-6989586621683390973"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-510"></a><span>      </span><a href="TcBinds.html#tcPolyBinds"><span class="hs-identifier hs-var">tcPolyBinds</span></a><span> </span><a href="#local-6989586621683390952"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390953"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><span class="hs-identifier hs-var">Recursive</span><span> </span><a href="#local-6989586621683390972"><span class="hs-identifier hs-var">rec_tc</span></a><span> </span><a href="#local-6989586621683390955"><span class="hs-identifier hs-var">closed</span></a><span> </span><a href="#local-6989586621683390973"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-identifier">recursivePatSynErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutputableBndrId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683390817"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-513"></a><span>                      </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683390817"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390818"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-514"></a><a name="recursivePatSynErr"><a href="TcBinds.html#recursivePatSynErr"><span class="hs-identifier">recursivePatSynErr</span></a></a><span> </span><a name="local-6989586621683390976"><a href="#local-6989586621683390976"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-516"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Recursive pattern synonym definition with following bindings:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-517"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683390978"><span class="hs-identifier hs-var">pprLBind</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683390976"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621683390977"><a href="#local-6989586621683390977"><span class="hs-identifier">pprLoc</span></a></a><span> </span><a name="local-6989586621683390979"><a href="#local-6989586621683390979"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;defined at&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390979"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>    </span><a name="local-6989586621683390978"><a href="#local-6989586621683390978"><span class="hs-identifier">pprLBind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683390980"><a href="#local-6989586621683390980"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683390981"><a href="#local-6989586621683390981"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectHsBindBinders</span><span> </span><a href="#local-6989586621683390981"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>                                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683390977"><span class="hs-identifier hs-var">pprLoc</span></a><span> </span><a href="#local-6989586621683390980"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">tc_single</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683390816"><a href="#local-6989586621683390816"><span class="hs-identifier">thing</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-524"></a><span>            </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-525"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsGroupClosed</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390816"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-526"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390816"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><a name="tc_single"><a href="TcBinds.html#tc_single"><span class="hs-identifier">tc_single</span></a></a><span> </span><a name="local-6989586621683390982"><a href="#local-6989586621683390982"><span class="hs-identifier">_top_lvl</span></a></a><span> </span><a name="local-6989586621683390983"><a href="#local-6989586621683390983"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683390984"><a href="#local-6989586621683390984"><span class="hs-identifier">_prag_fn</span></a></a><span>
</span><a name="line-528"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynBind</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390985"><a href="#local-6989586621683390985"><span class="hs-identifier">psb</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">PSB</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psb_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390986"><a href="#local-6989586621683390986"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>          </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390987"><a href="#local-6989586621683390987"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390988"><a href="#local-6989586621683390988"><span class="hs-identifier">aux_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390989"><a href="#local-6989586621683390989"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPatSyn.html#tcPatSynDecl"><span class="hs-identifier hs-var">tcPatSynDecl</span></a><span> </span><a href="#local-6989586621683390985"><span class="hs-identifier hs-var">psb</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390983"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390986"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390990"><a href="#local-6989586621683390990"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683390989"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="#local-6989586621683390987"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-532"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390988"><span class="hs-identifier hs-var">aux_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390990"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-identifier">tc_single</span><span> </span><a name="local-6989586621683390991"><a href="#local-6989586621683390991"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621683390992"><a href="#local-6989586621683390992"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683390993"><a href="#local-6989586621683390993"><span class="hs-identifier">prag_fn</span></a></a><span> </span><a name="local-6989586621683390994"><a href="#local-6989586621683390994"><span class="hs-identifier">lbind</span></a></a><span> </span><a name="local-6989586621683390995"><a href="#local-6989586621683390995"><span class="hs-identifier">closed</span></a></a><span> </span><a name="local-6989586621683390996"><a href="#local-6989586621683390996"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683390997"><a href="#local-6989586621683390997"><span class="hs-identifier">binds1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683390998"><a href="#local-6989586621683390998"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcPolyBinds"><span class="hs-identifier hs-var">tcPolyBinds</span></a><span> </span><a href="#local-6989586621683390992"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390993"><span class="hs-identifier hs-var">prag_fn</span></a><span>
</span><a name="line-537"></a><span>                                      </span><span class="hs-identifier hs-var">NonRecursive</span><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span>
</span><a name="line-538"></a><span>                                      </span><a href="#local-6989586621683390995"><span class="hs-identifier hs-var">closed</span></a><span>
</span><a name="line-539"></a><span>                                      </span><span class="hs-special">[</span><a href="#local-6989586621683390994"><span class="hs-identifier hs-var">lbind</span></a><span class="hs-special">]</span><span>
</span><a name="line-540"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683390999"><a href="#local-6989586621683390999"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendLetEnv"><span class="hs-identifier hs-var">tcExtendLetEnv</span></a><span> </span><a href="#local-6989586621683390991"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683390992"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683390995"><span class="hs-identifier hs-var">closed</span></a><span> </span><a href="#local-6989586621683390998"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621683390996"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-541"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683390997"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683390999"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-544"></a><span class="hs-keyword">type</span><span> </span><a name="BKey"><a href="TcBinds.html#BKey"><span class="hs-identifier">BKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- Just number off the bindings</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-identifier">mkEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Node</span><span> </span><a href="TcBinds.html#BKey"><span class="hs-identifier hs-type">BKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-547"></a><span class="hs-comment">-- See Note [Polymorphic recursion] in HsBinds.</span><span>
</span><a name="line-548"></a><a name="mkEdges"><a href="TcBinds.html#mkEdges"><span class="hs-identifier">mkEdges</span></a></a><span> </span><a name="local-6989586621683391000"><a href="#local-6989586621683391000"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683391001"><a href="#local-6989586621683391001"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621683391012"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621683391013"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683391015"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391014"><a href="#local-6989586621683391014"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391002"><span class="hs-identifier hs-var">bind_fvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683391012"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-550"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391015"><a href="#local-6989586621683391015"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683391005"><span class="hs-identifier hs-var">key_map</span></a><span> </span><a href="#local-6989586621683391014"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391003"><span class="hs-identifier hs-var">no_sig</span></a><span> </span><a href="#local-6989586621683391014"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-551"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391012"><a href="#local-6989586621683391012"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391013"><a href="#local-6989586621683391013"><span class="hs-identifier">key</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391004"><span class="hs-identifier hs-var">keyd_binds</span></a><span>
</span><a name="line-552"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here as stronglyConnCompFromEdgedVertices</span><span>
</span><a name="line-554"></a><span>    </span><span class="hs-comment">-- is still deterministic even if the edges are in nondeterministic order</span><span>
</span><a name="line-555"></a><span>    </span><span class="hs-comment">-- as explained in Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-556"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-557"></a><span>    </span><a name="local-6989586621683391002"><a href="#local-6989586621683391002"><span class="hs-identifier">bind_fvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391006"><a href="#local-6989586621683391006"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391006"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-558"></a><span>    </span><span class="hs-identifier">bind_fvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391007"><a href="#local-6989586621683391007"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391007"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-559"></a><span>    </span><span class="hs-identifier">bind_fvs</span><span> </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>    </span><span class="hs-identifier">no_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-562"></a><span>    </span><a name="local-6989586621683391003"><a href="#local-6989586621683391003"><span class="hs-identifier">no_sig</span></a></a><span> </span><a name="local-6989586621683391008"><a href="#local-6989586621683391008"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hasCompleteSig</span><span> </span><a href="#local-6989586621683391000"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391008"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>    </span><a name="local-6989586621683391004"><a href="#local-6989586621683391004"><span class="hs-identifier">keyd_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621683391001"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">::</span><a href="TcBinds.html#BKey"><span class="hs-identifier hs-type">BKey</span></a><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>    </span><span class="hs-identifier">key_map</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><a href="TcBinds.html#BKey"><span class="hs-identifier hs-type">BKey</span></a><span>     </span><span class="hs-comment">-- Which binding it comes from</span><span>
</span><a name="line-567"></a><span>    </span><a name="local-6989586621683391005"><a href="#local-6989586621683391005"><span class="hs-identifier">key_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683391011"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391010"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391009"><a href="#local-6989586621683391009"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391010"><a href="#local-6989586621683391010"><span class="hs-identifier">key</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391004"><span class="hs-identifier hs-var">keyd_binds</span></a><span>
</span><a name="line-568"></a><span>                                     </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683391011"><a href="#local-6989586621683391011"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">collectHsBindBinders</span><span> </span><a href="#local-6989586621683391009"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-571"></a><span class="hs-identifier">tcPolyBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-572"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>         </span><span class="hs-comment">-- Whether the group is really recursive</span><span>
</span><a name="line-573"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>         </span><span class="hs-comment">-- Whether it's recursive after breaking</span><span>
</span><a name="line-574"></a><span>                               </span><span class="hs-comment">-- dependencies based on type signatures</span><span>
</span><a name="line-575"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsGroupClosed</span><span>   </span><span class="hs-comment">-- Whether the group is closed</span><span>
</span><a name="line-576"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- None are PatSynBind</span><span>
</span><a name="line-577"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span class="hs-comment">-- Typechecks a single bunch of values bindings all together,</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- and generalises them.  The bunch may be only part of a recursive</span><span>
</span><a name="line-581"></a><span class="hs-comment">-- group, because we use type signatures to maximise polymorphism</span><span>
</span><a name="line-582"></a><span class="hs-comment">--</span><span>
</span><a name="line-583"></a><span class="hs-comment">-- Returns a list because the input may be a single non-recursive binding,</span><span>
</span><a name="line-584"></a><span class="hs-comment">-- in which case the dependency order of the resulting bindings is</span><span>
</span><a name="line-585"></a><span class="hs-comment">-- important.</span><span>
</span><a name="line-586"></a><span class="hs-comment">--</span><span>
</span><a name="line-587"></a><span class="hs-comment">-- Knows nothing about the scope of the bindings</span><span>
</span><a name="line-588"></a><span class="hs-comment">-- None of the bindings are pattern synonyms</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><a name="tcPolyBinds"><a href="TcBinds.html#tcPolyBinds"><span class="hs-identifier">tcPolyBinds</span></a></a><span> </span><a name="local-6989586621683391016"><a href="#local-6989586621683391016"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683391017"><a href="#local-6989586621683391017"><span class="hs-identifier">prag_fn</span></a></a><span> </span><a name="local-6989586621683391018"><a href="#local-6989586621683391018"><span class="hs-identifier">rec_group</span></a></a><span> </span><a name="local-6989586621683391019"><a href="#local-6989586621683391019"><span class="hs-identifier">rec_tc</span></a></a><span> </span><a name="local-6989586621683391020"><a href="#local-6989586621683391020"><span class="hs-identifier">closed</span></a></a><span> </span><a name="local-6989586621683391021"><a href="#local-6989586621683391021"><span class="hs-identifier">bind_list</span></a></a><span>
</span><a name="line-591"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683391023"><span class="hs-identifier hs-var">loc</span></a><span>                              </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-592"></a><span>    </span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#recoveryCode"><span class="hs-identifier hs-var">recoveryCode</span></a><span> </span><a href="#local-6989586621683391022"><span class="hs-identifier hs-var">binder_names</span></a><span> </span><a href="#local-6989586621683391016"><span class="hs-identifier hs-var">sig_fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-593"></a><span>        </span><span class="hs-comment">-- Set up main recover; take advantage of any type sigs</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;------------------------------------------------&quot;</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-596"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Bindings for {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391022"><span class="hs-identifier hs-var">binder_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391024"><a href="#local-6989586621683391024"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-598"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391025"><a href="#local-6989586621683391025"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#decideGeneralisationPlan"><span class="hs-identifier hs-var">decideGeneralisationPlan</span></a><span> </span><a href="#local-6989586621683391024"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683391021"><span class="hs-identifier hs-var">bind_list</span></a><span> </span><a href="#local-6989586621683391020"><span class="hs-identifier hs-var">closed</span></a><span> </span><a href="#local-6989586621683391016"><span class="hs-identifier hs-var">sig_fn</span></a><span>
</span><a name="line-599"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Generalisation plan&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391025"><span class="hs-identifier hs-var">plan</span></a><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391029"><a href="#local-6989586621683391029"><span class="hs-identifier">result</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683391030"><a href="#local-6989586621683391030"><span class="hs-identifier">poly_ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683391025"><span class="hs-identifier hs-var">plan</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-601"></a><span>         </span><a href="TcBinds.html#NoGen"><span class="hs-identifier hs-var">NoGen</span></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcBinds.html#tcPolyNoGen"><span class="hs-identifier hs-var">tcPolyNoGen</span></a><span> </span><a href="#local-6989586621683391019"><span class="hs-identifier hs-var">rec_tc</span></a><span> </span><a href="#local-6989586621683391017"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391016"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391021"><span class="hs-identifier hs-var">bind_list</span></a><span>
</span><a name="line-602"></a><span>         </span><a href="TcBinds.html#InferGen"><span class="hs-identifier hs-var">InferGen</span></a><span> </span><a name="local-6989586621683391026"><a href="#local-6989586621683391026"><span class="hs-identifier">mn</span></a></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcBinds.html#tcPolyInfer"><span class="hs-identifier hs-var">tcPolyInfer</span></a><span> </span><a href="#local-6989586621683391019"><span class="hs-identifier hs-var">rec_tc</span></a><span> </span><a href="#local-6989586621683391017"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391016"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391026"><span class="hs-identifier hs-var">mn</span></a><span> </span><a href="#local-6989586621683391021"><span class="hs-identifier hs-var">bind_list</span></a><span>
</span><a name="line-603"></a><span>         </span><a href="TcBinds.html#CheckGen"><span class="hs-identifier hs-var">CheckGen</span></a><span> </span><a name="local-6989586621683391027"><a href="#local-6989586621683391027"><span class="hs-identifier">lbind</span></a></a><span> </span><a name="local-6989586621683391028"><a href="#local-6989586621683391028"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcBinds.html#tcPolyCheck"><span class="hs-identifier hs-var">tcPolyCheck</span></a><span> </span><a href="#local-6989586621683391017"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391028"><span class="hs-identifier hs-var">sig</span></a><span> </span><a href="#local-6989586621683391027"><span class="hs-identifier hs-var">lbind</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;} End of bindings for&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391022"><span class="hs-identifier hs-var">binder_names</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391018"><span class="hs-identifier hs-var">rec_group</span></a><span>
</span><a name="line-606"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391031"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391031"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391031"><a href="#local-6989586621683391031"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391030"><span class="hs-identifier hs-var">poly_ids</span></a><span class="hs-special">]</span><span>
</span><a name="line-607"></a><span>                                          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683391029"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-610"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-611"></a><span>    </span><a name="local-6989586621683391022"><a href="#local-6989586621683391022"><span class="hs-identifier">binder_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectHsBindListBinders</span><span> </span><a href="#local-6989586621683391021"><span class="hs-identifier hs-var">bind_list</span></a><span>
</span><a name="line-612"></a><span>    </span><a name="local-6989586621683391023"><a href="#local-6989586621683391023"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-identifier hs-var">combineSrcSpans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621683391021"><span class="hs-identifier hs-var">bind_list</span></a><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>         </span><span class="hs-comment">-- The mbinds have been dependency analysed and</span><span>
</span><a name="line-614"></a><span>         </span><span class="hs-comment">-- may no longer be adjacent; so find the narrowest</span><span>
</span><a name="line-615"></a><span>         </span><span class="hs-comment">-- span that includes them all</span><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-618"></a><span class="hs-comment">-- If typechecking the binds fails, then return with each</span><span>
</span><a name="line-619"></a><span class="hs-comment">-- signature-less binder given type (forall a.a), to minimise</span><span>
</span><a name="line-620"></a><span class="hs-comment">-- subsequent error messages</span><span>
</span><a name="line-621"></a><span class="hs-identifier">recoveryCode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-622"></a><a name="recoveryCode"><a href="TcBinds.html#recoveryCode"><span class="hs-identifier">recoveryCode</span></a></a><span> </span><a name="local-6989586621683391032"><a href="#local-6989586621683391032"><span class="hs-identifier">binder_names</span></a></a><span> </span><a name="local-6989586621683391033"><a href="#local-6989586621683391033"><span class="hs-identifier">sig_fn</span></a></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcBindsWithSigs: error recovery&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391032"><span class="hs-identifier hs-var">binder_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391038"><a href="#local-6989586621683391038"><span class="hs-identifier">poly_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683391034"><span class="hs-identifier hs-var">mk_dummy</span></a><span> </span><a href="#local-6989586621683391032"><span class="hs-identifier hs-var">binder_names</span></a><span>
</span><a name="line-625"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391038"><span class="hs-identifier hs-var">poly_ids</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-626"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-627"></a><span>    </span><a name="local-6989586621683391034"><a href="#local-6989586621683391034"><span class="hs-identifier">mk_dummy</span></a></a><span> </span><a name="local-6989586621683391035"><a href="#local-6989586621683391035"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-628"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391036"><a href="#local-6989586621683391036"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391033"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391035"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-629"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391037"><a href="#local-6989586621683391037"><span class="hs-identifier">poly_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#completeSigPolyId_maybe"><span class="hs-identifier hs-var">completeSigPolyId_maybe</span></a><span> </span><a href="#local-6989586621683391036"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-630"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391037"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-631"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-632"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683391035"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="TcBinds.html#forall_a_a"><span class="hs-identifier hs-var">forall_a_a</span></a><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span class="hs-identifier">forall_a_a</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-635"></a><span class="hs-comment">-- At one point I had (forall r (a :: TYPE r). a), but of course</span><span>
</span><a name="line-636"></a><span class="hs-comment">-- that type is ill-formed: its mentions 'r' which escapes r's scope.</span><span>
</span><a name="line-637"></a><span class="hs-comment">-- Another alternative would be (forall (a :: TYPE kappa). a), where</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- kappa is a unification variable. But I don't think we need that</span><span>
</span><a name="line-639"></a><span class="hs-comment">-- complication here. I'm going to just use (forall (a::*). a).</span><span>
</span><a name="line-640"></a><span class="hs-comment">-- See Trac #15276</span><span>
</span><a name="line-641"></a><a name="forall_a_a"><a href="TcBinds.html#forall_a_a"><span class="hs-identifier">forall_a_a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">alphaTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">alphaTy</span><span>
</span><a name="line-642"></a><span>
</span><a name="line-643"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                         tcPolyNoGen
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span class="hs-identifier">tcPolyNoGen</span><span>     </span><span class="hs-comment">-- No generalisation whatsoever</span><span>
</span><a name="line-650"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>       </span><span class="hs-comment">-- Whether it's recursive after breaking</span><span>
</span><a name="line-651"></a><span>                   </span><span class="hs-comment">-- dependencies based on type signatures</span><span>
</span><a name="line-652"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span>
</span><a name="line-653"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-654"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><a name="tcPolyNoGen"><a href="TcBinds.html#tcPolyNoGen"><span class="hs-identifier">tcPolyNoGen</span></a></a><span> </span><a name="local-6989586621683391039"><a href="#local-6989586621683391039"><span class="hs-identifier">rec_tc</span></a></a><span> </span><a name="local-6989586621683391040"><a href="#local-6989586621683391040"><span class="hs-identifier">prag_fn</span></a></a><span> </span><a name="local-6989586621683391041"><a href="#local-6989586621683391041"><span class="hs-identifier">tc_sig_fn</span></a></a><span> </span><a name="local-6989586621683391042"><a href="#local-6989586621683391042"><span class="hs-identifier">bind_list</span></a></a><span>
</span><a name="line-657"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391047"><a href="#local-6989586621683391047"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391048"><a href="#local-6989586621683391048"><span class="hs-identifier">mono_infos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcMonoBinds"><span class="hs-identifier hs-var">tcMonoBinds</span></a><span> </span><a href="#local-6989586621683391039"><span class="hs-identifier hs-var">rec_tc</span></a><span> </span><a href="#local-6989586621683391041"><span class="hs-identifier hs-var">tc_sig_fn</span></a><span>
</span><a name="line-658"></a><span>                                             </span><span class="hs-special">(</span><a href="TcPat.html#LetGblBndr"><span class="hs-identifier hs-var">LetGblBndr</span></a><span> </span><a href="#local-6989586621683391040"><span class="hs-identifier hs-var">prag_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>                                             </span><a href="#local-6989586621683391042"><span class="hs-identifier hs-var">bind_list</span></a><span>
</span><a name="line-660"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391049"><a href="#local-6989586621683391049"><span class="hs-identifier">mono_ids'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683391043"><span class="hs-identifier hs-var">tc_mono_info</span></a><span> </span><a href="#local-6989586621683391048"><span class="hs-identifier hs-var">mono_infos</span></a><span>
</span><a name="line-661"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391047"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391049"><span class="hs-identifier hs-var">mono_ids'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-662"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-663"></a><span>    </span><a name="local-6989586621683391043"><a href="#local-6989586621683391043"><span class="hs-identifier">tc_mono_info</span></a></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391044"><a href="#local-6989586621683391044"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391045"><a href="#local-6989586621683391045"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-664"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391046"><a href="#local-6989586621683391046"><span class="hs-identifier">_specs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcSpecPrags"><span class="hs-identifier hs-var">tcSpecPrags</span></a><span> </span><a href="#local-6989586621683391045"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-special">(</span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span> </span><a href="#local-6989586621683391040"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391044"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683391045"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-666"></a><span>           </span><span class="hs-comment">-- NB: tcPrags generates error messages for</span><span>
</span><a name="line-667"></a><span>           </span><span class="hs-comment">--     specialisation pragmas for non-overloaded sigs</span><span>
</span><a name="line-668"></a><span>           </span><span class="hs-comment">-- Indeed that is why we call it here!</span><span>
</span><a name="line-669"></a><span>           </span><span class="hs-comment">-- So we can safely ignore _specs</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                         tcPolyCheck
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span class="hs-identifier">tcPolyCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-679"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span>     </span><span class="hs-comment">-- Must be a complete signature</span><span>
</span><a name="line-680"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>   </span><span class="hs-comment">-- Must be a FunBind</span><span>
</span><a name="line-681"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-682"></a><span class="hs-comment">-- There is just one binding,</span><span>
</span><a name="line-683"></a><span class="hs-comment">--   it is a Funbind</span><span>
</span><a name="line-684"></a><span class="hs-comment">--   it has a complete type signature,</span><span>
</span><a name="line-685"></a><a name="tcPolyCheck"><a href="TcBinds.html#tcPolyCheck"><span class="hs-identifier">tcPolyCheck</span></a></a><span> </span><a name="local-6989586621683391050"><a href="#local-6989586621683391050"><span class="hs-identifier">prag_fn</span></a></a><span>
</span><a name="line-686"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391051"><a href="#local-6989586621683391051"><span class="hs-identifier">poly_id</span></a></a><span>
</span><a name="line-687"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_ctxt</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391052"><a href="#local-6989586621683391052"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-688"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391053"><a href="#local-6989586621683391053"><span class="hs-identifier">sig_loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-689"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683391054"><a href="#local-6989586621683391054"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683391055"><a href="#local-6989586621683391055"><span class="hs-identifier">nm_loc</span></a></a><span> </span><a name="local-6989586621683391056"><a href="#local-6989586621683391056"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-690"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391057"><a href="#local-6989586621683391057"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-691"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683391053"><span class="hs-identifier hs-var">sig_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-692"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPolyCheck&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391051"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391053"><span class="hs-identifier hs-var">sig_loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-693"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391058"><a href="#local-6989586621683391058"><span class="hs-identifier">tv_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391059"><a href="#local-6989586621683391059"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391060"><a href="#local-6989586621683391060"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstType"><span class="hs-identifier hs-var">tcInstType</span></a><span> </span><a href="TcMType.html#tcInstSkolTyVars"><span class="hs-identifier hs-var">tcInstSkolTyVars</span></a><span> </span><a href="#local-6989586621683391051"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-694"></a><span>                </span><span class="hs-comment">-- See Note [Instantiate sig with fresh variables]</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391061"><a href="#local-6989586621683391061"><span class="hs-identifier">mono_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newNameAt"><span class="hs-identifier hs-var">newNameAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683391056"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391055"><span class="hs-identifier hs-var">nm_loc</span></a><span>
</span><a name="line-697"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391062"><a href="#local-6989586621683391062"><span class="hs-identifier">ev_vars</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newEvVars"><span class="hs-identifier hs-var">newEvVars</span></a><span> </span><a href="#local-6989586621683391059"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-698"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391063"><a href="#local-6989586621683391063"><span class="hs-identifier">mono_id</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683391061"><span class="hs-identifier hs-var">mono_name</span></a><span> </span><a href="#local-6989586621683391060"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-699"></a><span>             </span><a name="local-6989586621683391064"><a href="#local-6989586621683391064"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SigSkol</span><span> </span><a href="#local-6989586621683391052"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391051"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391058"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-700"></a><span>             </span><a name="local-6989586621683391065"><a href="#local-6989586621683391065"><span class="hs-identifier">skol_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683391058"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391066"><a href="#local-6989586621683391066"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391067"><a href="#local-6989586621683391067"><span class="hs-identifier">co_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391068"><a href="#local-6989586621683391068"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-6989586621683391064"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683391065"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-6989586621683391062"><span class="hs-identifier hs-var">ev_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-704"></a><span>               </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TcIdBndr</span><span> </span><a href="#local-6989586621683391063"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span class="hs-special">]</span><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-705"></a><span>               </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683391058"><span class="hs-identifier hs-var">tv_prs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-706"></a><span>               </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683391054"><span class="hs-identifier hs-var">loc</span></a><span>           </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-707"></a><span>               </span><a href="TcMatches.html#tcMatchesFun"><span class="hs-identifier hs-var">tcMatchesFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391055"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391061"><span class="hs-identifier hs-var">mono_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391057"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683391060"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>
</span><a name="line-709"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391069"><a href="#local-6989586621683391069"><span class="hs-identifier">prag_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span> </span><a href="#local-6989586621683391050"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391056"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-710"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391070"><a href="#local-6989586621683391070"><span class="hs-identifier">spec_prags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcSpecPrags"><span class="hs-identifier hs-var">tcSpecPrags</span></a><span> </span><a href="#local-6989586621683391051"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621683391069"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-711"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391071"><a href="#local-6989586621683391071"><span class="hs-identifier">poly_id</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier hs-var">addInlinePrags</span></a><span> </span><a href="#local-6989586621683391051"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621683391069"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391072"><a href="#local-6989586621683391072"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-714"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391073"><a href="#local-6989586621683391073"><span class="hs-identifier">tick</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#funBindTicks"><span class="hs-identifier hs-var">funBindTicks</span></a><span> </span><a href="#local-6989586621683391055"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391063"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><a href="#local-6989586621683391072"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621683391069"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-715"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391074"><a href="#local-6989586621683391074"><span class="hs-identifier">bind'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391055"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391063"><span class="hs-identifier hs-var">mono_id</span></a><span>
</span><a name="line-716"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391068"><span class="hs-identifier hs-var">matches'</span></a><span>
</span><a name="line-717"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_co_fn</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391067"><span class="hs-identifier hs-var">co_fn</span></a><span>
</span><a name="line-718"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_ext</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">placeHolderNamesTc</span><span>
</span><a name="line-719"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_tick</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391073"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span>             </span><span class="hs-keyword">export</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-722"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span>
</span><a name="line-723"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391071"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-724"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_mono</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391063"><span class="hs-identifier hs-var">mono_id</span></a><span>
</span><a name="line-725"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_prags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SpecPrags</span><span> </span><a href="#local-6989586621683391070"><span class="hs-identifier hs-var">spec_prags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span>             </span><a name="local-6989586621683391076"><a href="#local-6989586621683391076"><span class="hs-identifier">abs_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391054"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-728"></a><span>                        </span><span class="hs-identifier hs-var">AbsBinds</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abs_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-729"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_tvs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391065"><span class="hs-identifier hs-var">skol_tvs</span></a><span>
</span><a name="line-730"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_vars</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391062"><span class="hs-identifier hs-var">ev_vars</span></a><span>
</span><a name="line-731"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683391066"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-732"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_exports</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-keyword">export</span><span class="hs-special">]</span><span>
</span><a name="line-733"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391054"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683391074"><span class="hs-identifier hs-var">bind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_sig</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683391076"><span class="hs-identifier hs-var">abs_bind</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683391071"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span class="hs-identifier">tcPolyCheck</span><span> </span><a name="local-6989586621683391077"><a href="#local-6989586621683391077"><span class="hs-identifier">_prag_fn</span></a></a><span> </span><a name="local-6989586621683391078"><a href="#local-6989586621683391078"><span class="hs-identifier">sig</span></a></a><span> </span><a name="local-6989586621683391079"><a href="#local-6989586621683391079"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-739"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcPolyCheck&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391078"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391079"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-740"></a><span>
</span><a name="line-741"></a><span class="hs-identifier">funBindTicks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-742"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span>
</span><a name="line-743"></a><a name="funBindTicks"><a href="TcBinds.html#funBindTicks"><span class="hs-identifier">funBindTicks</span></a></a><span> </span><a name="local-6989586621683391080"><a href="#local-6989586621683391080"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683391081"><a href="#local-6989586621683391081"><span class="hs-identifier">fun_id</span></a></a><span> </span><a name="local-6989586621683391082"><a href="#local-6989586621683391082"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621683391083"><a href="#local-6989586621683391083"><span class="hs-identifier">sigs</span></a></a><span>
</span><a name="line-744"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391085"><a href="#local-6989586621683391085"><span class="hs-identifier">mb_cc_str</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683391084"><span class="hs-identifier hs-var">cc_name</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SCCFunSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391084"><a href="#local-6989586621683391084"><span class="hs-identifier">cc_name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391083"><span class="hs-identifier hs-var">sigs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-745"></a><span>      </span><span class="hs-comment">-- this can only be a singleton list, as duplicate pragmas are rejected</span><span>
</span><a name="line-746"></a><span>      </span><span class="hs-comment">-- by the renamer</span><span>
</span><a name="line-747"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391086"><a href="#local-6989586621683391086"><span class="hs-identifier">cc_str</span></a></a><span>
</span><a name="line-748"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391088"><a href="#local-6989586621683391088"><span class="hs-identifier">cc_str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391085"><span class="hs-identifier hs-var">mb_cc_str</span></a><span>
</span><a name="line-749"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683391088"><span class="hs-identifier hs-var">cc_str</span></a><span>
</span><a name="line-750"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-751"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Var.varName</span><span> </span><a href="#local-6989586621683391081"><span class="hs-identifier hs-var">fun_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>        </span><a name="local-6989586621683391087"><a href="#local-6989586621683391087"><span class="hs-identifier">cc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621683391082"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appendFS</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">consFS</span><span> </span><span class="hs-char">'.'</span><span> </span><a href="#local-6989586621683391086"><span class="hs-identifier hs-var">cc_str</span></a><span>
</span><a name="line-753"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-754"></a><span>      </span><a name="local-6989586621683391089"><a href="#local-6989586621683391089"><span class="hs-identifier">flavour</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">DeclCC</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getCCIndexM"><span class="hs-identifier hs-var">getCCIndexM</span></a><span> </span><a href="#local-6989586621683391087"><span class="hs-identifier hs-var">cc_name</span></a><span>
</span><a name="line-755"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391090"><a href="#local-6989586621683391090"><span class="hs-identifier">cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUserCC</span><span> </span><a href="#local-6989586621683391087"><span class="hs-identifier hs-var">cc_name</span></a><span> </span><a href="#local-6989586621683391082"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621683391080"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683391089"><span class="hs-identifier hs-var">flavour</span></a><span>
</span><a name="line-756"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ProfNote</span><span> </span><a href="#local-6989586621683391090"><span class="hs-identifier hs-var">cc</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">]</span><span>
</span><a name="line-757"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span class="hs-comment">{- Note [Instantiate sig with fresh variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's vital to instantiate a type signature with fresh variables.
For example:
      type T = forall a. [a] -&gt; [a]
      f :: T;
      f = g where { g :: T; g = &lt;rhs&gt; }

 We must not use the same 'a' from the defn of T at both places!!
(Instantiation is only necessary because of type synonyms.  Otherwise,
it's all cool; each signature has distinct type variables from the renamer.)
-}</span><span>
</span><a name="line-772"></a><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                         tcPolyInfer
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span class="hs-identifier">tcPolyInfer</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>       </span><span class="hs-comment">-- Whether it's recursive after breaking</span><span>
</span><a name="line-782"></a><span>                   </span><span class="hs-comment">-- dependencies based on type signatures</span><span>
</span><a name="line-783"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span>
</span><a name="line-784"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>         </span><span class="hs-comment">-- True &lt;=&gt; apply the monomorphism restriction</span><span>
</span><a name="line-785"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-786"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-787"></a><a name="tcPolyInfer"><a href="TcBinds.html#tcPolyInfer"><span class="hs-identifier">tcPolyInfer</span></a></a><span> </span><a name="local-6989586621683391091"><a href="#local-6989586621683391091"><span class="hs-identifier">rec_tc</span></a></a><span> </span><a name="local-6989586621683391092"><a href="#local-6989586621683391092"><span class="hs-identifier">prag_fn</span></a></a><span> </span><a name="local-6989586621683391093"><a href="#local-6989586621683391093"><span class="hs-identifier">tc_sig_fn</span></a></a><span> </span><a name="local-6989586621683391094"><a href="#local-6989586621683391094"><span class="hs-identifier">mono</span></a></a><span> </span><a name="local-6989586621683391095"><a href="#local-6989586621683391095"><span class="hs-identifier">bind_list</span></a></a><span>
</span><a name="line-788"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391096"><a href="#local-6989586621683391096"><span class="hs-identifier">tclvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391097"><a href="#local-6989586621683391097"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391098"><a href="#local-6989586621683391098"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391099"><a href="#local-6989586621683391099"><span class="hs-identifier">mono_infos</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-789"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-790"></a><span>                </span><a href="TcBinds.html#tcMonoBinds"><span class="hs-identifier hs-var">tcMonoBinds</span></a><span> </span><a href="#local-6989586621683391091"><span class="hs-identifier hs-var">rec_tc</span></a><span> </span><a href="#local-6989586621683391093"><span class="hs-identifier hs-var">tc_sig_fn</span></a><span> </span><a href="TcPat.html#LetLclBndr"><span class="hs-identifier hs-var">LetLclBndr</span></a><span> </span><a href="#local-6989586621683391095"><span class="hs-identifier hs-var">bind_list</span></a><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391100"><a href="#local-6989586621683391100"><span class="hs-identifier">name_taus</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mbi_poly_name</span><span> </span><a href="#local-6989586621683391103"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mbi_mono_id</span><span> </span><a href="#local-6989586621683391103"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-793"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391103"><a href="#local-6989586621683391103"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391099"><span class="hs-identifier hs-var">mono_infos</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-794"></a><span>             </span><a name="local-6989586621683391101"><a href="#local-6989586621683391101"><span class="hs-identifier">sigs</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683391104"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391104"><a href="#local-6989586621683391104"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391099"><span class="hs-identifier hs-var">mono_infos</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-795"></a><span>             </span><a name="local-6989586621683391102"><a href="#local-6989586621683391102"><span class="hs-identifier">infer_mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683391094"><span class="hs-identifier hs-var">mono</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="TcSimplify.html#ApplyMR"><span class="hs-identifier hs-var">ApplyMR</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="TcSimplify.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#checkOverloadedSig"><span class="hs-identifier hs-var">checkOverloadedSig</span></a><span> </span><a href="#local-6989586621683391094"><span class="hs-identifier hs-var">mono</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391101"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simplifyInfer call&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391096"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391100"><span class="hs-identifier hs-var">name_taus</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391097"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span>
</span><a name="line-800"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391105"><a href="#local-6989586621683391105"><span class="hs-identifier">qtvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391106"><a href="#local-6989586621683391106"><span class="hs-identifier">givens</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391107"><a href="#local-6989586621683391107"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391108"><a href="#local-6989586621683391108"><span class="hs-identifier">residual</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391109"><a href="#local-6989586621683391109"><span class="hs-identifier">insoluble</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span>                 </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simplifyInfer"><span class="hs-identifier hs-var">simplifyInfer</span></a><span> </span><a href="#local-6989586621683391096"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-6989586621683391102"><span class="hs-identifier hs-var">infer_mode</span></a><span> </span><a href="#local-6989586621683391101"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-6989586621683391100"><span class="hs-identifier hs-var">name_taus</span></a><span> </span><a href="#local-6989586621683391097"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-802"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier hs-var">emitConstraints</span></a><span> </span><a href="#local-6989586621683391108"><span class="hs-identifier hs-var">residual</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391110"><a href="#local-6989586621683391110"><span class="hs-identifier">inferred_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">evVarPred</span><span> </span><a href="#local-6989586621683391106"><span class="hs-identifier hs-var">givens</span></a><span>
</span><a name="line-805"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391111"><a href="#local-6989586621683391111"><span class="hs-identifier">exports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-806"></a><span>                    </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#mkExport"><span class="hs-identifier hs-var">mkExport</span></a><span> </span><a href="#local-6989586621683391092"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391109"><span class="hs-identifier hs-var">insoluble</span></a><span> </span><a href="#local-6989586621683391105"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><a href="#local-6989586621683391110"><span class="hs-identifier hs-var">inferred_theta</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391099"><span class="hs-identifier hs-var">mono_infos</span></a><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391112"><a href="#local-6989586621683391112"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-809"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391113"><a href="#local-6989586621683391113"><span class="hs-identifier">poly_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><a href="#local-6989586621683391111"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-810"></a><span>             </span><a name="local-6989586621683391114"><a href="#local-6989586621683391114"><span class="hs-identifier">abs_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391112"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-811"></a><span>                        </span><span class="hs-identifier hs-var">AbsBinds</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abs_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-812"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391105"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-813"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391106"><span class="hs-identifier hs-var">givens</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683391107"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-814"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_exports</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391111"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391098"><span class="hs-identifier hs-var">binds'</span></a><span>
</span><a name="line-815"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-816"></a><span>
</span><a name="line-817"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Binding:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391113"><span class="hs-identifier hs-var">poly_ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391113"><span class="hs-identifier hs-var">poly_ids</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-818"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683391114"><span class="hs-identifier hs-var">abs_bind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391113"><span class="hs-identifier hs-var">poly_ids</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-819"></a><span>         </span><span class="hs-comment">-- poly_ids are guaranteed zonked by mkExport</span><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-822"></a><span class="hs-identifier">mkExport</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-823"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                        </span><span class="hs-comment">-- True &lt;=&gt; there was an insoluble type error</span><span>
</span><a name="line-824"></a><span>                                        </span><span class="hs-comment">--          when typechecking the bindings</span><span>
</span><a name="line-825"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span>      </span><span class="hs-comment">-- Both already zonked</span><span>
</span><a name="line-826"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span>
</span><a name="line-827"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ABExport</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span class="hs-comment">-- Only called for generalisation plan InferGen, not by CheckGen or NoGen</span><span>
</span><a name="line-829"></a><span class="hs-comment">--</span><span>
</span><a name="line-830"></a><span class="hs-comment">-- mkExport generates exports with</span><span>
</span><a name="line-831"></a><span class="hs-comment">--      zonked type variables,</span><span>
</span><a name="line-832"></a><span class="hs-comment">--      zonked poly_ids</span><span>
</span><a name="line-833"></a><span class="hs-comment">-- The former is just because no further unifications will change</span><span>
</span><a name="line-834"></a><span class="hs-comment">-- the quantified type variables, so we can fix their final form</span><span>
</span><a name="line-835"></a><span class="hs-comment">-- right now.</span><span>
</span><a name="line-836"></a><span class="hs-comment">-- The latter is needed because the poly_ids are used to extend the</span><span>
</span><a name="line-837"></a><span class="hs-comment">-- type environment; see the invariant on TcEnv.tcExtendIdEnv</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-comment">-- Pre-condition: the qtvs and theta are already zonked</span><span>
</span><a name="line-840"></a><span>
</span><a name="line-841"></a><a name="mkExport"><a href="TcBinds.html#mkExport"><span class="hs-identifier">mkExport</span></a></a><span> </span><a name="local-6989586621683391115"><a href="#local-6989586621683391115"><span class="hs-identifier">prag_fn</span></a></a><span> </span><a name="local-6989586621683391116"><a href="#local-6989586621683391116"><span class="hs-identifier">insoluble</span></a></a><span> </span><a name="local-6989586621683391117"><a href="#local-6989586621683391117"><span class="hs-identifier">qtvs</span></a></a><span> </span><a name="local-6989586621683391118"><a href="#local-6989586621683391118"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-842"></a><span>         </span><a name="local-6989586621683391119"><a href="#local-6989586621683391119"><span class="hs-identifier">mono_info</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391120"><a href="#local-6989586621683391120"><span class="hs-identifier">poly_name</span></a></a><span>
</span><a name="line-843"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391121"><a href="#local-6989586621683391121"><span class="hs-identifier">mb_sig</span></a></a><span>
</span><a name="line-844"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391122"><a href="#local-6989586621683391122"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391125"><a href="#local-6989586621683391125"><span class="hs-identifier">mono_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391122"><span class="hs-identifier hs-var">mono_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391126"><a href="#local-6989586621683391126"><span class="hs-identifier">poly_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#mkInferredPolyId"><span class="hs-identifier hs-var">mkInferredPolyId</span></a><span> </span><a href="#local-6989586621683391116"><span class="hs-identifier hs-var">insoluble</span></a><span> </span><a href="#local-6989586621683391117"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><a href="#local-6989586621683391118"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621683391120"><span class="hs-identifier hs-var">poly_name</span></a><span> </span><a href="#local-6989586621683391121"><span class="hs-identifier hs-var">mb_sig</span></a><span> </span><a href="#local-6989586621683391125"><span class="hs-identifier hs-var">mono_ty</span></a><span>
</span><a name="line-847"></a><span>
</span><a name="line-848"></a><span>        </span><span class="hs-comment">-- NB: poly_id has a zonked type</span><span>
</span><a name="line-849"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391127"><a href="#local-6989586621683391127"><span class="hs-identifier">poly_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier hs-var">addInlinePrags</span></a><span> </span><a href="#local-6989586621683391126"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621683391123"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-850"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391128"><a href="#local-6989586621683391128"><span class="hs-identifier">spec_prags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcSpecPrags"><span class="hs-identifier hs-var">tcSpecPrags</span></a><span> </span><a href="#local-6989586621683391127"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621683391123"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-851"></a><span>                </span><span class="hs-comment">-- tcPrags requires a zonked poly_id</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span>        </span><span class="hs-comment">-- See Note [Impedance matching]</span><span>
</span><a name="line-854"></a><span>        </span><span class="hs-comment">-- NB: we have already done checkValidType, including an ambiguity check,</span><span>
</span><a name="line-855"></a><span>        </span><span class="hs-comment">--     on the type; either when we checked the sig or in mkInferredPolyId</span><span>
</span><a name="line-856"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391129"><a href="#local-6989586621683391129"><span class="hs-identifier">poly_ty</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391127"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-857"></a><span>              </span><a name="local-6989586621683391130"><a href="#local-6989586621683391130"><span class="hs-identifier">sel_poly_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInfSigmaTy</span><span> </span><a href="#local-6989586621683391117"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><a href="#local-6989586621683391118"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621683391125"><span class="hs-identifier hs-var">mono_ty</span></a><span>
</span><a name="line-858"></a><span>                </span><span class="hs-comment">-- This type is just going into tcSubType,</span><span>
</span><a name="line-859"></a><span>                </span><span class="hs-comment">-- so Inferred vs. Specified doesn't matter</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391131"><a href="#local-6989586621683391131"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683391130"><span class="hs-identifier hs-var">sel_poly_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391129"><span class="hs-identifier hs-var">poly_ty</span></a><span>  </span><span class="hs-comment">-- NB: eqType ignores visibility</span><span>
</span><a name="line-862"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span>  </span><span class="hs-comment">-- Fast path; also avoids complaint when we infer</span><span>
</span><a name="line-863"></a><span>                                           </span><span class="hs-comment">-- an ambiguous type and have AllowAmbiguousType</span><span>
</span><a name="line-864"></a><span>                                           </span><span class="hs-comment">-- e..g infer  x :: forall a. F a -&gt; Int</span><span>
</span><a name="line-865"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#mk_impedance_match_msg"><span class="hs-identifier hs-var">mk_impedance_match_msg</span></a><span> </span><a href="#local-6989586621683391119"><span class="hs-identifier hs-var">mono_info</span></a><span> </span><a href="#local-6989586621683391130"><span class="hs-identifier hs-var">sel_poly_ty</span></a><span> </span><a href="#local-6989586621683391129"><span class="hs-identifier hs-var">poly_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-866"></a><span>                       </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span> </span><a href="#local-6989586621683391124"><span class="hs-identifier hs-var">sig_ctxt</span></a><span> </span><a href="#local-6989586621683391130"><span class="hs-identifier hs-var">sel_poly_ty</span></a><span> </span><a href="#local-6989586621683391129"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391132"><a href="#local-6989586621683391132"><span class="hs-identifier">warn_missing_sigs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingLocalSignatures</span><span>
</span><a name="line-869"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621683391132"><span class="hs-identifier hs-var">warn_missing_sigs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-870"></a><span>              </span><a href="TcBinds.html#localSigWarn"><span class="hs-identifier hs-var">localSigWarn</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingLocalSignatures</span><span> </span><a href="#local-6989586621683391127"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621683391121"><span class="hs-identifier hs-var">mb_sig</span></a><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-873"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391131"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-874"></a><span>                        </span><span class="hs-comment">-- abe_wrap :: idType poly_id ~ (forall qtvs. theta =&gt; mono_ty)</span><span>
</span><a name="line-875"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391127"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-876"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_mono</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391122"><span class="hs-identifier hs-var">mono_id</span></a><span>
</span><a name="line-877"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_prags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SpecPrags</span><span> </span><a href="#local-6989586621683391128"><span class="hs-identifier hs-var">spec_prags</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-878"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-879"></a><span>    </span><a name="local-6989586621683391123"><a href="#local-6989586621683391123"><span class="hs-identifier">prag_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span> </span><a href="#local-6989586621683391115"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683391120"><span class="hs-identifier hs-var">poly_name</span></a><span>
</span><a name="line-880"></a><span>    </span><a name="local-6989586621683391124"><a href="#local-6989586621683391124"><span class="hs-identifier">sig_ctxt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InfSigCtxt</span><span> </span><a href="#local-6989586621683391120"><span class="hs-identifier hs-var">poly_name</span></a><span>
</span><a name="line-881"></a><span>
</span><a name="line-882"></a><span class="hs-identifier">mkInferredPolyId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- True &lt;=&gt; there was an insoluble error when</span><span>
</span><a name="line-883"></a><span>                          </span><span class="hs-comment">--          checking the binding group for this Id</span><span>
</span><a name="line-884"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span>
</span><a name="line-885"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-886"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-887"></a><a name="mkInferredPolyId"><a href="TcBinds.html#mkInferredPolyId"><span class="hs-identifier">mkInferredPolyId</span></a></a><span> </span><a name="local-6989586621683391133"><a href="#local-6989586621683391133"><span class="hs-identifier">insoluble</span></a></a><span> </span><a name="local-6989586621683391134"><a href="#local-6989586621683391134"><span class="hs-identifier">qtvs</span></a></a><span> </span><a name="local-6989586621683391135"><a href="#local-6989586621683391135"><span class="hs-identifier">inferred_theta</span></a></a><span> </span><a name="local-6989586621683391136"><a href="#local-6989586621683391136"><span class="hs-identifier">poly_name</span></a></a><span> </span><a name="local-6989586621683391137"><a href="#local-6989586621683391137"><span class="hs-identifier">mb_sig_inst</span></a></a><span> </span><a name="local-6989586621683391138"><a href="#local-6989586621683391138"><span class="hs-identifier">mono_ty</span></a></a><span>
</span><a name="line-888"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391139"><a href="#local-6989586621683391139"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391137"><span class="hs-identifier hs-var">mb_sig_inst</span></a><span>
</span><a name="line-889"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391140"><a href="#local-6989586621683391140"><span class="hs-identifier">poly_id</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391139"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-890"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683391140"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-891"></a><span>
</span><a name="line-892"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- Either no type sig or partial type sig</span><span>
</span><a name="line-893"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- The checkNoErrs ensures that if the type is ambiguous</span><span>
</span><a name="line-894"></a><span>                   </span><span class="hs-comment">-- we don't carry on to the impedance matching, and generate</span><span>
</span><a name="line-895"></a><span>                   </span><span class="hs-comment">-- a duplicate ambiguity error.  There is a similar</span><span>
</span><a name="line-896"></a><span>                   </span><span class="hs-comment">-- checkNoErrs for complete type signatures too.</span><span>
</span><a name="line-897"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391141"><a href="#local-6989586621683391141"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-898"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391142"><a href="#local-6989586621683391142"><span class="hs-identifier">_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391143"><a href="#local-6989586621683391143"><span class="hs-identifier">mono_ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">normaliseType</span><span> </span><a href="#local-6989586621683391141"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621683391138"><span class="hs-identifier hs-var">mono_ty</span></a><span>
</span><a name="line-899"></a><span>               </span><span class="hs-comment">-- Unification may not have normalised the type,</span><span>
</span><a name="line-900"></a><span>               </span><span class="hs-comment">-- (see Note [Lazy flattening] in TcFlatten) so do it</span><span>
</span><a name="line-901"></a><span>               </span><span class="hs-comment">-- here to make it as uncomplicated as possible.</span><span>
</span><a name="line-902"></a><span>               </span><span class="hs-comment">-- Example: f :: [F Int] -&gt; Bool</span><span>
</span><a name="line-903"></a><span>               </span><span class="hs-comment">-- should be rewritten to f :: [Char] -&gt; Bool, if possible</span><span>
</span><a name="line-904"></a><span>               </span><span class="hs-comment">--</span><span>
</span><a name="line-905"></a><span>               </span><span class="hs-comment">-- We can discard the coercion _co, because we'll reconstruct</span><span>
</span><a name="line-906"></a><span>               </span><span class="hs-comment">-- it in the call to tcSubType below</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391144"><a href="#local-6989586621683391144"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391145"><a href="#local-6989586621683391145"><span class="hs-identifier">theta'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#chooseInferredQuantifiers"><span class="hs-identifier hs-var">chooseInferredQuantifiers</span></a><span> </span><a href="#local-6989586621683391135"><span class="hs-identifier hs-var">inferred_theta</span></a><span>
</span><a name="line-909"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683391143"><span class="hs-identifier hs-var">mono_ty'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391134"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><a href="#local-6989586621683391137"><span class="hs-identifier hs-var">mb_sig_inst</span></a><span>
</span><a name="line-910"></a><span>
</span><a name="line-911"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391146"><a href="#local-6989586621683391146"><span class="hs-identifier">inferred_poly_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkForAllTys</span><span> </span><a href="#local-6989586621683391144"><span class="hs-identifier hs-var">binders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPhiTy</span><span> </span><a href="#local-6989586621683391145"><span class="hs-identifier hs-var">theta'</span></a><span> </span><a href="#local-6989586621683391143"><span class="hs-identifier hs-var">mono_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;mkInferredPolyId&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391136"><span class="hs-identifier hs-var">poly_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391134"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391145"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-914"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391146"><span class="hs-identifier hs-var">inferred_poly_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621683391133"><span class="hs-identifier hs-var">insoluble</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-916"></a><span>         </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#mk_inf_msg"><span class="hs-identifier hs-var">mk_inf_msg</span></a><span> </span><a href="#local-6989586621683391136"><span class="hs-identifier hs-var">poly_name</span></a><span> </span><a href="#local-6989586621683391146"><span class="hs-identifier hs-var">inferred_poly_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-917"></a><span>         </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfSigCtxt</span><span> </span><a href="#local-6989586621683391136"><span class="hs-identifier hs-var">poly_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391146"><span class="hs-identifier hs-var">inferred_poly_ty</span></a><span>
</span><a name="line-918"></a><span>         </span><span class="hs-comment">-- See Note [Validity of inferred types]</span><span>
</span><a name="line-919"></a><span>         </span><span class="hs-comment">-- If we found an insoluble error in the function definition, don't</span><span>
</span><a name="line-920"></a><span>         </span><span class="hs-comment">-- do this check; otherwise (Trac #14000) we may report an ambiguity</span><span>
</span><a name="line-921"></a><span>         </span><span class="hs-comment">-- error for a rather bogus type.</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLocalIdOrCoVar</span><span> </span><a href="#local-6989586621683391136"><span class="hs-identifier hs-var">poly_name</span></a><span> </span><a href="#local-6989586621683391146"><span class="hs-identifier hs-var">inferred_poly_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span class="hs-identifier">chooseInferredQuantifiers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span>   </span><span class="hs-comment">-- inferred</span><span>
</span><a name="line-927"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVarSet</span><span>    </span><span class="hs-comment">-- tvs free in tau type</span><span>
</span><a name="line-928"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- inferred quantified tvs</span><span>
</span><a name="line-929"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span>
</span><a name="line-930"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBinder</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span class="hs-special">)</span><span>
</span><a name="line-931"></a><a name="chooseInferredQuantifiers"><a href="TcBinds.html#chooseInferredQuantifiers"><span class="hs-identifier">chooseInferredQuantifiers</span></a></a><span> </span><a name="local-6989586621683391147"><a href="#local-6989586621683391147"><span class="hs-identifier">inferred_theta</span></a></a><span> </span><a name="local-6989586621683391148"><a href="#local-6989586621683391148"><span class="hs-identifier">tau_tvs</span></a></a><span> </span><a name="local-6989586621683391149"><a href="#local-6989586621683391149"><span class="hs-identifier">qtvs</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-932"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- No type signature (partial or complete) for this binder,</span><span>
</span><a name="line-933"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391150"><a href="#local-6989586621683391150"><span class="hs-identifier">free_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">closeOverKinds</span><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#growThetaTyVars"><span class="hs-identifier hs-var">growThetaTyVars</span></a><span> </span><a href="#local-6989586621683391147"><span class="hs-identifier hs-var">inferred_theta</span></a><span> </span><a href="#local-6989586621683391148"><span class="hs-identifier hs-var">tau_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-934"></a><span>                        </span><span class="hs-comment">-- Include kind variables!  Trac #7916</span><span>
</span><a name="line-935"></a><span>             </span><a name="local-6989586621683391151"><a href="#local-6989586621683391151"><span class="hs-identifier">my_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pickCapturedPreds</span><span> </span><a href="#local-6989586621683391150"><span class="hs-identifier hs-var">free_tvs</span></a><span> </span><a href="#local-6989586621683391147"><span class="hs-identifier hs-var">inferred_theta</span></a><span>
</span><a name="line-936"></a><span>             </span><a name="local-6989586621683391152"><a href="#local-6989586621683391152"><span class="hs-identifier">binders</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkTyVarBinder</span><span> </span><span class="hs-identifier hs-var">Inferred</span><span> </span><a href="#local-6989586621683391153"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-937"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391153"><a href="#local-6989586621683391153"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391149"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-938"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391153"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391150"><span class="hs-identifier hs-var">free_tvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-939"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391152"><span class="hs-identifier hs-var">binders</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391151"><span class="hs-identifier hs-var">my_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span class="hs-identifier">chooseInferredQuantifiers</span><span> </span><a name="local-6989586621683391154"><a href="#local-6989586621683391154"><span class="hs-identifier">inferred_theta</span></a></a><span> </span><a name="local-6989586621683391155"><a href="#local-6989586621683391155"><span class="hs-identifier">tau_tvs</span></a></a><span> </span><a name="local-6989586621683391156"><a href="#local-6989586621683391156"><span class="hs-identifier">qtvs</span></a></a><span>
</span><a name="line-942"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_sig</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391157"><a href="#local-6989586621683391157"><span class="hs-identifier">sig</span></a></a><span>  </span><span class="hs-comment">-- Always PartialSig</span><span>
</span><a name="line-943"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_wcx</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391158"><a href="#local-6989586621683391158"><span class="hs-identifier">wcx</span></a></a><span>
</span><a name="line-944"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391159"><a href="#local-6989586621683391159"><span class="hs-identifier">annotated_theta</span></a></a><span>
</span><a name="line-945"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_skols</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391160"><a href="#local-6989586621683391160"><span class="hs-identifier">annotated_tvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-946"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Choose quantifiers for a partial type signature</span><span>
</span><a name="line-947"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391187"><a href="#local-6989586621683391187"><span class="hs-identifier">psig_qtv_prs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTyVarTyVarPairs"><span class="hs-identifier hs-var">zonkTyVarTyVarPairs</span></a><span> </span><a href="#local-6989586621683391160"><span class="hs-identifier hs-var">annotated_tvs</span></a><span>
</span><a name="line-948"></a><span>
</span><a name="line-949"></a><span>            </span><span class="hs-comment">-- Check whether the quantified variables of the</span><span>
</span><a name="line-950"></a><span>            </span><span class="hs-comment">-- partial signature have been unified together</span><span>
</span><a name="line-951"></a><span>            </span><span class="hs-comment">-- See Note [Quantified variables in partial type signatures]</span><span>
</span><a name="line-952"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683391161"><span class="hs-identifier hs-var">report_dup_tyvar_tv_err</span></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">findDupTyVarTvs</span><span> </span><a href="#local-6989586621683391187"><span class="hs-identifier hs-var">psig_qtv_prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span>            </span><span class="hs-comment">-- Check whether a quantified variable of the partial type</span><span>
</span><a name="line-955"></a><span>            </span><span class="hs-comment">-- signature is not actually quantified.  How can that happen?</span><span>
</span><a name="line-956"></a><span>            </span><span class="hs-comment">-- See Note [Quantification and partial signatures] Wrinkle 4</span><span>
</span><a name="line-957"></a><span>            </span><span class="hs-comment">--     in TcSimplify</span><span>
</span><a name="line-958"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683391162"><span class="hs-identifier hs-var">report_mono_sig_tv_err</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683391188"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391188"><a href="#local-6989586621683391188"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621683391189"><a href="#local-6989586621683391189"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391187"><span class="hs-identifier hs-var">psig_qtv_prs</span></a><span>
</span><a name="line-959"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391189"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391156"><span class="hs-identifier hs-var">qtvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-960"></a><span>
</span><a name="line-961"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391190"><a href="#local-6989586621683391190"><span class="hs-identifier">psig_qtvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683391187"><span class="hs-identifier hs-var">psig_qtv_prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-962"></a><span>
</span><a name="line-963"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391191"><a href="#local-6989586621683391191"><span class="hs-identifier">annotated_theta</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypes"><span class="hs-identifier hs-var">zonkTcTypes</span></a><span> </span><a href="#local-6989586621683391159"><span class="hs-identifier hs-var">annotated_theta</span></a><span>
</span><a name="line-964"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391192"><a href="#local-6989586621683391192"><span class="hs-identifier">free_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391193"><a href="#local-6989586621683391193"><span class="hs-identifier">my_theta</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391163"><span class="hs-identifier hs-var">choose_psig_context</span></a><span> </span><a href="#local-6989586621683391190"><span class="hs-identifier hs-var">psig_qtvs</span></a><span> </span><a href="#local-6989586621683391191"><span class="hs-identifier hs-var">annotated_theta</span></a><span> </span><a href="#local-6989586621683391158"><span class="hs-identifier hs-var">wcx</span></a><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391194"><a href="#local-6989586621683391194"><span class="hs-identifier">keep_me</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391192"><span class="hs-identifier hs-var">free_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391190"><span class="hs-identifier hs-var">psig_qtvs</span></a><span>
</span><a name="line-967"></a><span>             </span><a name="local-6989586621683391195"><a href="#local-6989586621683391195"><span class="hs-identifier">final_qtvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkTyVarBinder</span><span> </span><a href="#local-6989586621683391197"><span class="hs-identifier hs-var">vis</span></a><span> </span><a href="#local-6989586621683391196"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-968"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391196"><a href="#local-6989586621683391196"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391156"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><span class="hs-comment">-- Pulling from qtvs maintains original order</span><span>
</span><a name="line-969"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391196"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391194"><span class="hs-identifier hs-var">keep_me</span></a><span>
</span><a name="line-970"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391197"><a href="#local-6989586621683391197"><span class="hs-identifier">vis</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683391196"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391190"><span class="hs-identifier hs-var">psig_qtvs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Specified</span><span>
</span><a name="line-971"></a><span>                                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Inferred</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391195"><span class="hs-identifier hs-var">final_qtvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391193"><span class="hs-identifier hs-var">my_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-974"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-975"></a><span>    </span><a name="local-6989586621683391161"><a href="#local-6989586621683391161"><span class="hs-identifier">report_dup_tyvar_tv_err</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683391165"><a href="#local-6989586621683391165"><span class="hs-identifier">n1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683391166"><a href="#local-6989586621683391166"><span class="hs-identifier">n2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391167"><a href="#local-6989586621683391167"><span class="hs-identifier">fn_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">psig_hs_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391168"><a href="#local-6989586621683391168"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391157"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-977"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Couldn't match&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391165"><span class="hs-identifier hs-var">n1</span></a><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>                        </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391166"><span class="hs-identifier hs-var">n2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span>                     </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;both bound by the partial type signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-980"></a><span>                           </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391167"><span class="hs-identifier hs-var">fn_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391168"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- Can't happen; by now we know it's a partial sig</span><span>
</span><a name="line-983"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;report_tyvar_tv_err&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391157"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>
</span><a name="line-985"></a><span>    </span><a name="local-6989586621683391162"><a href="#local-6989586621683391162"><span class="hs-identifier">report_mono_sig_tv_err</span></a></a><span> </span><a name="local-6989586621683391169"><a href="#local-6989586621683391169"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-986"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391170"><a href="#local-6989586621683391170"><span class="hs-identifier">fn_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">psig_hs_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391171"><a href="#local-6989586621683391171"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391157"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-987"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't quantify over&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391169"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>                     </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;bound by the partial type signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>                           </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391170"><span class="hs-identifier hs-var">fn_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391171"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- Can't happen; by now we know it's a partial sig</span><span>
</span><a name="line-991"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;report_mono_sig_tv_err&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391157"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span>    </span><span class="hs-identifier">choose_psig_context</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-994"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">VarSet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>    </span><a name="local-6989586621683391163"><a href="#local-6989586621683391163"><span class="hs-identifier">choose_psig_context</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391172"><a href="#local-6989586621683391172"><span class="hs-identifier">annotated_theta</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-996"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391173"><a href="#local-6989586621683391173"><span class="hs-identifier">free_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">closeOverKinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683391172"><span class="hs-identifier hs-var">annotated_theta</span></a><span>
</span><a name="line-997"></a><span>                                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391155"><span class="hs-identifier hs-var">tau_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391173"><span class="hs-identifier hs-var">free_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391172"><span class="hs-identifier hs-var">annotated_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span>    </span><span class="hs-identifier">choose_psig_context</span><span> </span><a name="local-6989586621683391174"><a href="#local-6989586621683391174"><span class="hs-identifier">psig_qtvs</span></a></a><span> </span><a name="local-6989586621683391175"><a href="#local-6989586621683391175"><span class="hs-identifier">annotated_theta</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391176"><a href="#local-6989586621683391176"><span class="hs-identifier">wc_var_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391177"><a href="#local-6989586621683391177"><span class="hs-identifier">free_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">closeOverKinds</span><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#growThetaTyVars"><span class="hs-identifier hs-var">growThetaTyVars</span></a><span> </span><a href="#local-6989586621683391154"><span class="hs-identifier hs-var">inferred_theta</span></a><span> </span><a href="#local-6989586621683391178"><span class="hs-identifier hs-var">seed_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>                            </span><span class="hs-comment">-- growThetaVars just like the no-type-sig case</span><span>
</span><a name="line-1003"></a><span>                            </span><span class="hs-comment">-- Omitting this caused #12844</span><span>
</span><a name="line-1004"></a><span>                 </span><a name="local-6989586621683391178"><a href="#local-6989586621683391178"><span class="hs-identifier">seed_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683391175"><span class="hs-identifier hs-var">annotated_theta</span></a><span>  </span><span class="hs-comment">-- These are put there</span><span>
</span><a name="line-1005"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391155"><span class="hs-identifier hs-var">tau_tvs</span></a><span>            </span><span class="hs-comment">--       by the user</span><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391179"><a href="#local-6989586621683391179"><span class="hs-identifier">keep_me</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391174"><span class="hs-identifier hs-var">psig_qtvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391177"><span class="hs-identifier hs-var">free_tvs</span></a><span>
</span><a name="line-1008"></a><span>                 </span><a name="local-6989586621683391180"><a href="#local-6989586621683391180"><span class="hs-identifier">my_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pickCapturedPreds</span><span> </span><a href="#local-6989586621683391179"><span class="hs-identifier hs-var">keep_me</span></a><span> </span><a href="#local-6989586621683391154"><span class="hs-identifier hs-var">inferred_theta</span></a><span>
</span><a name="line-1009"></a><span>
</span><a name="line-1010"></a><span>           </span><span class="hs-comment">-- Fill in the extra-constraints wildcard hole with inferred_theta,</span><span>
</span><a name="line-1011"></a><span>           </span><span class="hs-comment">-- so that the Hole constraint we have already emitted</span><span>
</span><a name="line-1012"></a><span>           </span><span class="hs-comment">-- (in tcHsPartialSigType) can report what filled it in.</span><span>
</span><a name="line-1013"></a><span>           </span><span class="hs-comment">-- NB: my_theta already includes all the annotated constraints</span><span>
</span><a name="line-1014"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391181"><a href="#local-6989586621683391181"><span class="hs-identifier">inferred_diff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683391182"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1015"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391182"><a href="#local-6989586621683391182"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391180"><span class="hs-identifier hs-var">my_theta</span></a><span>
</span><a name="line-1016"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683391182"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391175"><span class="hs-identifier hs-var">annotated_theta</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1017"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391183"><a href="#local-6989586621683391183"><span class="hs-identifier">ctuple</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391164"><span class="hs-identifier hs-var">mk_ctuple</span></a><span> </span><a href="#local-6989586621683391181"><span class="hs-identifier hs-var">inferred_diff</span></a><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcGetCastedTyVar_maybe</span><span> </span><a href="#local-6989586621683391176"><span class="hs-identifier hs-var">wc_var_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1020"></a><span>               </span><span class="hs-comment">-- We know that wc_co must have type kind(wc_var) ~ Constraint, as it</span><span>
</span><a name="line-1021"></a><span>               </span><span class="hs-comment">-- comes from the checkExpectedKind in TcHsType.tcWildCardOcc. So, to</span><span>
</span><a name="line-1022"></a><span>               </span><span class="hs-comment">-- make the kinds work out, we reverse the cast here.</span><span>
</span><a name="line-1023"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391184"><a href="#local-6989586621683391184"><span class="hs-identifier">wc_var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391185"><a href="#local-6989586621683391185"><span class="hs-identifier">wc_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#writeMetaTyVar"><span class="hs-identifier hs-var">writeMetaTyVar</span></a><span> </span><a href="#local-6989586621683391184"><span class="hs-identifier hs-var">wc_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391183"><span class="hs-identifier hs-var">ctuple</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621683391185"><span class="hs-identifier hs-var">wc_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;chooseInferredQuantifiers 1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391176"><span class="hs-identifier hs-var">wc_var_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;completeTheta&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1027"></a><span>                </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391157"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1028"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391175"><span class="hs-identifier hs-var">annotated_theta</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391154"><span class="hs-identifier hs-var">inferred_theta</span></a><span>
</span><a name="line-1029"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391181"><span class="hs-identifier hs-var">inferred_diff</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1030"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391177"><span class="hs-identifier hs-var">free_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391180"><span class="hs-identifier hs-var">my_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span>    </span><a name="local-6989586621683391164"><a href="#local-6989586621683391164"><span class="hs-identifier">mk_ctuple</span></a></a><span> </span><a name="local-6989586621683391186"><a href="#local-6989586621683391186"><span class="hs-identifier">preds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBoxedTupleTy</span><span> </span><a href="#local-6989586621683391186"><span class="hs-identifier hs-var">preds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1033"></a><span>       </span><span class="hs-comment">-- Hack alert!  See TcHsType:</span><span>
</span><a name="line-1034"></a><span>       </span><span class="hs-comment">-- Note [Extra-constraint holes in partial type signatures]</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span class="hs-identifier">mk_impedance_match_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span>
</span><a name="line-1038"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1039"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span class="hs-comment">-- This is a rare but rather awkward error messages</span><span>
</span><a name="line-1041"></a><a name="mk_impedance_match_msg"><a href="TcBinds.html#mk_impedance_match_msg"><span class="hs-identifier">mk_impedance_match_msg</span></a></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391198"><a href="#local-6989586621683391198"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391199"><a href="#local-6989586621683391199"><span class="hs-identifier">mb_sig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1042"></a><span>                       </span><a name="local-6989586621683391200"><a href="#local-6989586621683391200"><span class="hs-identifier">inf_ty</span></a></a><span> </span><a name="local-6989586621683391201"><a href="#local-6989586621683391201"><span class="hs-identifier">sig_ty</span></a></a><span> </span><a name="local-6989586621683391202"><a href="#local-6989586621683391202"><span class="hs-identifier">tidy_env</span></a></a><span>
</span><a name="line-1043"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391205"><a href="#local-6989586621683391205"><span class="hs-identifier">tidy_env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391206"><a href="#local-6989586621683391206"><span class="hs-identifier">inf_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683391202"><span class="hs-identifier hs-var">tidy_env</span></a><span>  </span><a href="#local-6989586621683391200"><span class="hs-identifier hs-var">inf_ty</span></a><span>
</span><a name="line-1044"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391207"><a href="#local-6989586621683391207"><span class="hs-identifier">tidy_env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391208"><a href="#local-6989586621683391208"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683391205"><span class="hs-identifier hs-var">tidy_env1</span></a><span> </span><a href="#local-6989586621683391201"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-1045"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391209"><a href="#local-6989586621683391209"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking that the inferred type&quot;</span><span>
</span><a name="line-1046"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391198"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391206"><span class="hs-identifier hs-var">inf_ty</span></a><span>
</span><a name="line-1047"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is as general as its&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683391203"><span class="hs-identifier hs-var">what</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;signature&quot;</span><span>
</span><a name="line-1048"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391198"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391208"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1049"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391207"><span class="hs-identifier hs-var">tidy_env2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391209"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1050"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1051"></a><span>    </span><a name="local-6989586621683391203"><a href="#local-6989586621683391203"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683391199"><span class="hs-identifier hs-var">mb_sig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1052"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;inferred&quot;</span><span>
</span><a name="line-1053"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391204"><a href="#local-6989586621683391204"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPartialSig</span><span> </span><a href="#local-6989586621683391204"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(partial)&quot;</span><span>
</span><a name="line-1054"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span>
</span><a name="line-1057"></a><span class="hs-identifier">mk_inf_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-1058"></a><a name="mk_inf_msg"><a href="TcBinds.html#mk_inf_msg"><span class="hs-identifier">mk_inf_msg</span></a></a><span> </span><a name="local-6989586621683391210"><a href="#local-6989586621683391210"><span class="hs-identifier">poly_name</span></a></a><span> </span><a name="local-6989586621683391211"><a href="#local-6989586621683391211"><span class="hs-identifier">poly_ty</span></a></a><span> </span><a name="local-6989586621683391212"><a href="#local-6989586621683391212"><span class="hs-identifier">tidy_env</span></a></a><span>
</span><a name="line-1059"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391213"><a href="#local-6989586621683391213"><span class="hs-identifier">tidy_env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391214"><a href="#local-6989586621683391214"><span class="hs-identifier">poly_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683391212"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621683391211"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-1060"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391215"><a href="#local-6989586621683391215"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking the inferred type&quot;</span><span>
</span><a name="line-1061"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391210"><span class="hs-identifier hs-var">poly_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391214"><span class="hs-identifier hs-var">poly_ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1062"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391213"><span class="hs-identifier hs-var">tidy_env1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391215"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span class="hs-comment">-- | Warn the user about polymorphic local binders that lack type signatures.</span><span>
</span><a name="line-1066"></a><span class="hs-identifier">localSigWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1067"></a><a name="localSigWarn"><a href="TcBinds.html#localSigWarn"><span class="hs-identifier">localSigWarn</span></a></a><span> </span><a name="local-6989586621683391216"><a href="#local-6989586621683391216"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621683391217"><a href="#local-6989586621683391217"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621683391218"><a href="#local-6989586621683391218"><span class="hs-identifier">mb_sig</span></a></a><span>
</span><a name="line-1068"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391218"><span class="hs-identifier hs-var">mb_sig</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1069"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isSigmaTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391217"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1070"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#warnMissingSignatures"><span class="hs-identifier hs-var">warnMissingSignatures</span></a><span> </span><a href="#local-6989586621683391216"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621683391219"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621683391217"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1071"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1072"></a><span>    </span><a name="local-6989586621683391219"><a href="#local-6989586621683391219"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Polymorphic local binding with no type signature:&quot;</span><span>
</span><a name="line-1073"></a><span>
</span><a name="line-1074"></a><span class="hs-identifier">warnMissingSignatures</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1075"></a><a name="warnMissingSignatures"><a href="TcBinds.html#warnMissingSignatures"><span class="hs-identifier">warnMissingSignatures</span></a></a><span> </span><a name="local-6989586621683391220"><a href="#local-6989586621683391220"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621683391221"><a href="#local-6989586621683391221"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621683391222"><a href="#local-6989586621683391222"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1076"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391225"><a href="#local-6989586621683391225"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>
</span><a name="line-1077"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391226"><a href="#local-6989586621683391226"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391227"><a href="#local-6989586621683391227"><span class="hs-identifier">tidy_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyOpenType</span><span> </span><a href="#local-6989586621683391225"><span class="hs-identifier hs-var">env0</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391222"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1078"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addWarnTcM"><span class="hs-identifier hs-var">addWarnTcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621683391220"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391226"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391223"><span class="hs-identifier hs-var">mk_msg</span></a><span> </span><a href="#local-6989586621683391227"><span class="hs-identifier hs-var">tidy_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1080"></a><span>    </span><a name="local-6989586621683391223"><a href="#local-6989586621683391223"><span class="hs-identifier">mk_msg</span></a></a><span> </span><a name="local-6989586621683391224"><a href="#local-6989586621683391224"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683391221"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pprPrefixName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683391222"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391224"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span class="hs-identifier">checkOverloadedSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1083"></a><span class="hs-comment">-- Example:</span><span>
</span><a name="line-1084"></a><span class="hs-comment">--   f :: Eq a =&gt; a -&gt; a</span><span>
</span><a name="line-1085"></a><span class="hs-comment">--   K f = e</span><span>
</span><a name="line-1086"></a><span class="hs-comment">-- The MR applies, but the signature is overloaded, and it's</span><span>
</span><a name="line-1087"></a><span class="hs-comment">-- best to complain about this directly</span><span>
</span><a name="line-1088"></a><span class="hs-comment">-- c.f Trac #11339</span><span>
</span><a name="line-1089"></a><a name="checkOverloadedSig"><a href="TcBinds.html#checkOverloadedSig"><span class="hs-identifier">checkOverloadedSig</span></a></a><span> </span><a name="local-6989586621683391228"><a href="#local-6989586621683391228"><span class="hs-identifier">monomorphism_restriction_applies</span></a></a><span> </span><a name="local-6989586621683391229"><a href="#local-6989586621683391229"><span class="hs-identifier">sig</span></a></a><span>
</span><a name="line-1090"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_inst_theta</span><span> </span><a href="#local-6989586621683391229"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1091"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391228"><span class="hs-identifier hs-var">monomorphism_restriction_applies</span></a><span>
</span><a name="line-1092"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391230"><a href="#local-6989586621683391230"><span class="hs-identifier">orig_sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sig_inst_sig</span><span> </span><a href="#local-6989586621683391229"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1093"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_loc</span><span> </span><a href="#local-6989586621683391230"><span class="hs-identifier hs-var">orig_sig</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1094"></a><span>    </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1095"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Overloaded signature conflicts with monomorphism restriction&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1096"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391230"><span class="hs-identifier hs-var">orig_sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1098"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>
</span><a name="line-1100"></a><span class="hs-comment">{- Note [Partial type signatures and generalisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If /any/ of the signatures in the gropu is a partial type signature
   f :: _ -&gt; Int
then we *always* use the InferGen plan, and hence tcPolyInfer.
We do this even for a local binding with -XMonoLocalBinds, when
we normally use NoGen.

Reasons:
  * The TcSigInfo for 'f' has a unification variable for the '_',
    whose TcLevel is one level deeper than the current level.
    (See pushTcLevelM in tcTySig.)  But NoGen doesn't increase
    the TcLevel like InferGen, so we lose the level invariant.

  * The signature might be   f :: forall a. _ -&gt; a
    so it really is polymorphic.  It's not clear what it would
    mean to use NoGen on this, and indeed the ASSERT in tcLhs,
    in the (Just sig) case, checks that if there is a signature
    then we are using LetLclBndr, and hence a nested AbsBinds with
    increased TcLevel

It might be possible to fix these difficulties somehow, but there
doesn't seem much point.  Indeed, adding a partial type signature is a
way to get per-binding inferred generalisation.

We apply the MR if /all/ of the partial signatures lack a context.
In particular (Trac #11016):
   f2 :: (?loc :: Int) =&gt; _
   f2 = ?loc
It's stupid to apply the MR here.  This test includes an extra-constraints
wildcard; that is, we don't apply the MR if you write
   f3 :: _ =&gt; blah

Note [Quantified variables in partial type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f :: forall a. a -&gt; a -&gt; _
  f x y = g x y
  g :: forall b. b -&gt; b -&gt; _
  g x y = [x, y]

Here, 'f' and 'g' are mutually recursive, and we end up unifying 'a' and 'b'
together, which is fine.  So we bind 'a' and 'b' to TyVarTvs, which can then
unify with each other.

But now consider:
  f :: forall a b. a -&gt; b -&gt; _
  f x y = [x, y]

We want to get an error from this, because 'a' and 'b' get unified.
So we make a test, one per parital signature, to check that the
explicitly-quantified type variables have not been unified together.
Trac #14449 showed this up.


Note [Validity of inferred types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to check inferred type for validity, in case it uses language
extensions that are not turned on.  The principle is that if the user
simply adds the inferred type to the program source, it'll compile fine.
See #8883.

Examples that might fail:
 - the type might be ambiguous

 - an inferred theta that requires type equalities e.g. (F a ~ G b)
                                or multi-parameter type classes
 - an inferred type that includes unboxed tuples


Note [Impedance matching]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f 0 x = x
   f n x = g [] (not x)

   g [] y = f 10 y
   g _  y = f 9  y

After typechecking we'll get
  f_mono_ty :: a -&gt; Bool -&gt; Bool
  g_mono_ty :: [b] -&gt; Bool -&gt; Bool
with constraints
  (Eq a, Num a)

Note that f is polymorphic in 'a' and g in 'b'; and these are not linked.
The types we really want for f and g are
   f :: forall a. (Eq a, Num a) =&gt; a -&gt; Bool -&gt; Bool
   g :: forall b. [b] -&gt; Bool -&gt; Bool

We can get these by &quot;impedance matching&quot;:
   tuple :: forall a b. (Eq a, Num a) =&gt; (a -&gt; Bool -&gt; Bool, [b] -&gt; Bool -&gt; Bool)
   tuple a b d1 d1 = let ...bind f_mono, g_mono in (f_mono, g_mono)

   f a d1 d2 = case tuple a Any d1 d2 of (f, g) -&gt; f
   g b = case tuple Integer b dEqInteger dNumInteger of (f,g) -&gt; g

Suppose the shared quantified tyvars are qtvs and constraints theta.
Then we want to check that
     forall qtvs. theta =&gt; f_mono_ty   is more polymorphic than   f's polytype
and the proof is the impedance matcher.

Notice that the impedance matcher may do defaulting.  See Trac #7173.

It also cleverly does an ambiguity check; for example, rejecting
   f :: F a -&gt; F a
where F is a non-injective type function.
-}</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span>
</span><a name="line-1210"></a><span class="hs-comment">{-
Note [SPECIALISE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~
There is no point in a SPECIALISE pragma for a non-overloaded function:
   reverse :: [a] -&gt; [a]
   {-# SPECIALISE reverse :: [Int] -&gt; [Int] #-}

But SPECIALISE INLINE *can* make sense for GADTS:
   data Arr e where
     ArrInt :: !Int -&gt; ByteArray# -&gt; Arr Int
     ArrPair :: !Int -&gt; Arr e1 -&gt; Arr e2 -&gt; Arr (e1, e2)

   (!:) :: Arr e -&gt; Int -&gt; e
   {-# SPECIALISE INLINE (!:) :: Arr Int -&gt; Int -&gt; Int #-}
   {-# SPECIALISE INLINE (!:) :: Arr (a, b) -&gt; Int -&gt; (a, b) #-}
   (ArrInt _ ba)     !: (I# i) = I# (indexIntArray# ba i)
   (ArrPair _ a1 a2) !: i      = (a1 !: i, a2 !: i)

When (!:) is specialised it becomes non-recursive, and can usefully
be inlined.  Scary!  So we only warn for SPECIALISE *without* INLINE
for a non-overloaded function.

************************************************************************
*                                                                      *
                         tcMonoBinds
*                                                                      *
************************************************************************

@tcMonoBinds@ deals with a perhaps-recursive group of HsBinds.
The signatures have been dealt with already.
-}</span><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span class="hs-keyword">data</span><span> </span><a name="MonoBindInfo"><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier">MonoBindInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MBI"><a href="TcBinds.html#MBI"><span class="hs-identifier">MBI</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="mbi_poly_name"><a href="TcBinds.html#mbi_poly_name"><span class="hs-identifier">mbi_poly_name</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1243"></a><span>                        </span><span class="hs-special">,</span><span> </span><a name="mbi_sig"><a href="TcBinds.html#mbi_sig"><span class="hs-identifier">mbi_sig</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span>
</span><a name="line-1244"></a><span>                        </span><span class="hs-special">,</span><span> </span><a name="mbi_mono_id"><a href="TcBinds.html#mbi_mono_id"><span class="hs-identifier">mbi_mono_id</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1245"></a><span>
</span><a name="line-1246"></a><span class="hs-identifier">tcMonoBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>  </span><span class="hs-comment">-- Whether the binding is recursive for typechecking purposes</span><span>
</span><a name="line-1247"></a><span>                        </span><span class="hs-comment">-- i.e. the binders are mentioned in their RHSs, and</span><span>
</span><a name="line-1248"></a><span>                        </span><span class="hs-comment">--      we are not rescued by a type signature</span><span>
</span><a name="line-1249"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span>
</span><a name="line-1250"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1251"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><a name="tcMonoBinds"><a href="TcBinds.html#tcMonoBinds"><span class="hs-identifier">tcMonoBinds</span></a></a><span> </span><a name="local-6989586621683391231"><a href="#local-6989586621683391231"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621683391232"><a href="#local-6989586621683391232"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683391233"><a href="#local-6989586621683391233"><span class="hs-identifier">no_gen</span></a></a><span>
</span><a name="line-1253"></a><span>           </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683391234"><a href="#local-6989586621683391234"><span class="hs-identifier">b_loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683391235"><a href="#local-6989586621683391235"><span class="hs-identifier">nm_loc</span></a></a><span> </span><a name="local-6989586621683391236"><a href="#local-6989586621683391236"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1254"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391237"><a href="#local-6989586621683391237"><span class="hs-identifier">matches</span></a></a><span>
</span><a name="line-1255"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391238"><a href="#local-6989586621683391238"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1256"></a><span>                             </span><span class="hs-comment">-- Single function binding,</span><span>
</span><a name="line-1257"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391231"><span class="hs-identifier hs-var">is_rec</span></a><span>   </span><span class="hs-comment">-- ...binder isn't mentioned in RHS</span><span>
</span><a name="line-1258"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391232"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391236"><span class="hs-identifier hs-var">name</span></a><span>   </span><span class="hs-comment">-- ...with no type signature</span><span>
</span><a name="line-1259"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- Note [Single function non-recursive binding special-case]</span><span>
</span><a name="line-1260"></a><span>        </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1261"></a><span>        </span><span class="hs-comment">-- In this very special case we infer the type of the</span><span>
</span><a name="line-1262"></a><span>        </span><span class="hs-comment">-- right hand side first (it may have a higher-rank type)</span><span>
</span><a name="line-1263"></a><span>        </span><span class="hs-comment">-- and *then* make the monomorphic Id for the LHS</span><span>
</span><a name="line-1264"></a><span>        </span><span class="hs-comment">-- e.g.         f = \(x::forall a. a-&gt;a) -&gt; &lt;body&gt;</span><span>
</span><a name="line-1265"></a><span>        </span><span class="hs-comment">--      We want to infer a higher-rank type for f</span><span>
</span><a name="line-1266"></a><span>    </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683391234"><span class="hs-identifier hs-var">b_loc</span></a><span>    </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1267"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683391240"><a href="#local-6989586621683391240"><span class="hs-identifier">co_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391241"><a href="#local-6989586621683391241"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683391242"><a href="#local-6989586621683391242"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1268"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcInferInst"><span class="hs-identifier hs-var">tcInferInst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683391239"><a href="#local-6989586621683391239"><span class="hs-identifier">exp_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1269"></a><span>                  </span><span class="hs-comment">-- tcInferInst: see TcUnify,</span><span>
</span><a name="line-1270"></a><span>                  </span><span class="hs-comment">-- Note [Deep instantiation of InferResult]</span><span>
</span><a name="line-1271"></a><span>               </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TcIdBndr_ExpType</span><span> </span><a href="#local-6989586621683391236"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683391239"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1272"></a><span>                  </span><span class="hs-comment">-- We extend the error context even for a non-recursive</span><span>
</span><a name="line-1273"></a><span>                  </span><span class="hs-comment">-- function so that in type error messages we show the</span><span>
</span><a name="line-1274"></a><span>                  </span><span class="hs-comment">-- type of the thing whose rhs we are type checking</span><span>
</span><a name="line-1275"></a><span>               </span><a href="TcMatches.html#tcMatchesFun"><span class="hs-identifier hs-var">tcMatchesFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391235"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391236"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391237"><span class="hs-identifier hs-var">matches</span></a><span> </span><a href="#local-6989586621683391239"><span class="hs-identifier hs-var">exp_ty</span></a><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391243"><a href="#local-6989586621683391243"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#newLetBndr"><span class="hs-identifier hs-var">newLetBndr</span></a><span> </span><a href="#local-6989586621683391233"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><a href="#local-6989586621683391236"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683391242"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1278"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391234"><span class="hs-identifier hs-var">b_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1279"></a><span>                     </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391235"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391243"><span class="hs-identifier hs-var">mono_id</span></a><span class="hs-special">,</span><span>
</span><a name="line-1280"></a><span>                               </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391241"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391238"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1281"></a><span>                               </span><span class="hs-identifier">fun_co_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391240"><span class="hs-identifier hs-var">co_fn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_tick</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1282"></a><span>                  </span><span class="hs-special">[</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391236"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1283"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1284"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391243"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1285"></a><span>
</span><a name="line-1286"></a><span class="hs-identifier">tcMonoBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391244"><a href="#local-6989586621683391244"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683391245"><a href="#local-6989586621683391245"><span class="hs-identifier">no_gen</span></a></a><span> </span><a name="local-6989586621683391246"><a href="#local-6989586621683391246"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-1287"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391247"><a href="#local-6989586621683391247"><span class="hs-identifier">tc_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#tcLhs"><span class="hs-identifier hs-var">tcLhs</span></a><span> </span><a href="#local-6989586621683391244"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391245"><span class="hs-identifier hs-var">no_gen</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391246"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1288"></a><span>
</span><a name="line-1289"></a><span>        </span><span class="hs-comment">-- Bring the monomorphic Ids, into scope for the RHSs</span><span>
</span><a name="line-1290"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391248"><a href="#local-6989586621683391248"><span class="hs-identifier">mono_infos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#getMonoBindInfo"><span class="hs-identifier hs-var">getMonoBindInfo</span></a><span> </span><a href="#local-6989586621683391247"><span class="hs-identifier hs-var">tc_binds</span></a><span>
</span><a name="line-1291"></a><span>              </span><a name="local-6989586621683391249"><a href="#local-6989586621683391249"><span class="hs-identifier">rhs_id_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391250"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391252"><span class="hs-identifier hs-var">mono_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391250"><a href="#local-6989586621683391250"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1293"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391251"><a href="#local-6989586621683391251"><span class="hs-identifier">mb_sig</span></a></a><span>
</span><a name="line-1294"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391252"><a href="#local-6989586621683391252"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391248"><span class="hs-identifier hs-var">mono_infos</span></a><span>
</span><a name="line-1295"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683391251"><span class="hs-identifier hs-var">mb_sig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1296"></a><span>                               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391253"><a href="#local-6989586621683391253"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isPartialSig</span><span> </span><a href="#local-6989586621683391253"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1297"></a><span>                               </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1298"></a><span>                </span><span class="hs-comment">-- A monomorphic binding for each term variable that lacks</span><span>
</span><a name="line-1299"></a><span>                </span><span class="hs-comment">-- a complete type sig.  (Ones with a sig are already in scope.)</span><span>
</span><a name="line-1300"></a><span>
</span><a name="line-1301"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcMonoBinds&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391254"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391255"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391255"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>                                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391254"><a href="#local-6989586621683391254"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621683391255"><a href="#local-6989586621683391255"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391249"><span class="hs-identifier hs-var">rhs_id_env</span></a><span class="hs-special">]</span><span>
</span><a name="line-1303"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391256"><a href="#local-6989586621683391256"><span class="hs-identifier">binds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendRecIds"><span class="hs-identifier hs-var">tcExtendRecIds</span></a><span> </span><a href="#local-6989586621683391249"><span class="hs-identifier hs-var">rhs_id_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1304"></a><span>                    </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcBinds.html#tcRhs"><span class="hs-identifier hs-var">tcRhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391247"><span class="hs-identifier hs-var">tc_binds</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621683391256"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391248"><span class="hs-identifier hs-var">mono_infos</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span>
</span><a name="line-1309"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1310"></a><span class="hs-comment">-- tcLhs typechecks the LHS of the bindings, to construct the environment in which</span><span>
</span><a name="line-1311"></a><span class="hs-comment">-- we typecheck the RHSs.  Basically what we are doing is this: for each binder:</span><span>
</span><a name="line-1312"></a><span class="hs-comment">--      if there's a signature for it, use the instantiated signature type</span><span>
</span><a name="line-1313"></a><span class="hs-comment">--      otherwise invent a type variable</span><span>
</span><a name="line-1314"></a><span class="hs-comment">-- You see that quite directly in the FunBind case.</span><span>
</span><a name="line-1315"></a><span class="hs-comment">--</span><span>
</span><a name="line-1316"></a><span class="hs-comment">-- But there's a complication for pattern bindings:</span><span>
</span><a name="line-1317"></a><span class="hs-comment">--      data T = MkT (forall a. a-&gt;a)</span><span>
</span><a name="line-1318"></a><span class="hs-comment">--      MkT f = e</span><span>
</span><a name="line-1319"></a><span class="hs-comment">-- Here we can guess a type variable for the entire LHS (which will be refined to T)</span><span>
</span><a name="line-1320"></a><span class="hs-comment">-- but we want to get (f::forall a. a-&gt;a) as the RHS environment.</span><span>
</span><a name="line-1321"></a><span class="hs-comment">-- The simplest way to do this is to typecheck the pattern, and then look up the</span><span>
</span><a name="line-1322"></a><span class="hs-comment">-- bound mono-ids.  Then we want to retain the typechecked pattern to avoid re-doing</span><span>
</span><a name="line-1323"></a><span class="hs-comment">-- it; hence the TcMonoBind data type in which the LHS is done but the RHS isn't</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span class="hs-keyword">data</span><span> </span><a name="TcMonoBind"><a href="TcBinds.html#TcMonoBind"><span class="hs-identifier">TcMonoBind</span></a></a><span>         </span><span class="hs-comment">-- Half completed; LHS done, RHS not done</span><span>
</span><a name="line-1326"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TcFunBind"><a href="TcBinds.html#TcFunBind"><span class="hs-identifier">TcFunBind</span></a></a><span>  </span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span>  </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1327"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TcPatBind"><a href="TcBinds.html#TcPatBind"><span class="hs-identifier">TcPatBind</span></a></a><span> </span><span class="hs-special">[</span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1328"></a><span>              </span><span class="hs-identifier hs-type">TcSigmaType</span><span>
</span><a name="line-1329"></a><span>
</span><a name="line-1330"></a><span class="hs-identifier">tcLhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcBinds.html#TcMonoBind"><span class="hs-identifier hs-type">TcMonoBind</span></a><span>
</span><a name="line-1331"></a><span class="hs-comment">-- Only called with plan InferGen (LetBndrSpec = LetLclBndr)</span><span>
</span><a name="line-1332"></a><span class="hs-comment">--                    or NoGen    (LetBndrSpec = LetGblBndr)</span><span>
</span><a name="line-1333"></a><span class="hs-comment">-- CheckGen is used only for functions with a complete type signature,</span><span>
</span><a name="line-1334"></a><span class="hs-comment">--          and tcPolyCheck doesn't use tcMonoBinds at all</span><span>
</span><a name="line-1335"></a><span>
</span><a name="line-1336"></a><a name="tcLhs"><a href="TcBinds.html#tcLhs"><span class="hs-identifier">tcLhs</span></a></a><span> </span><a name="local-6989586621683391257"><a href="#local-6989586621683391257"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683391258"><a href="#local-6989586621683391258"><span class="hs-identifier">no_gen</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683391259"><a href="#local-6989586621683391259"><span class="hs-identifier">nm_loc</span></a></a><span> </span><a name="local-6989586621683391260"><a href="#local-6989586621683391260"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1337"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391261"><a href="#local-6989586621683391261"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><a name="local-6989586621683391262"><a href="#local-6989586621683391262"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391257"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391260"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- There is a type signature.</span><span>
</span><a name="line-1340"></a><span>    </span><span class="hs-comment">-- It must be partial; if complete we'd be in tcPolyCheck!</span><span>
</span><a name="line-1341"></a><span>    </span><span class="hs-comment">--    e.g.   f :: _ -&gt; _</span><span>
</span><a name="line-1342"></a><span>    </span><span class="hs-comment">--           f x = ...g...</span><span>
</span><a name="line-1343"></a><span>    </span><span class="hs-comment">--           Just g = ...f...</span><span>
</span><a name="line-1344"></a><span>    </span><span class="hs-comment">-- Hence always typechecked with InferGen</span><span>
</span><a name="line-1345"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391263"><a href="#local-6989586621683391263"><span class="hs-identifier">mono_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcLhsSigId"><span class="hs-identifier hs-var">tcLhsSigId</span></a><span> </span><a href="#local-6989586621683391258"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391260"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391262"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1346"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcFunBind"><span class="hs-identifier hs-var">TcFunBind</span></a><span> </span><a href="#local-6989586621683391263"><span class="hs-identifier hs-var">mono_info</span></a><span> </span><a href="#local-6989586621683391259"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391261"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1347"></a><span>
</span><a name="line-1348"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- No type signature</span><span>
</span><a name="line-1349"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391264"><a href="#local-6989586621683391264"><span class="hs-identifier">mono_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-1350"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391265"><a href="#local-6989586621683391265"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#newLetBndr"><span class="hs-identifier hs-var">newLetBndr</span></a><span> </span><a href="#local-6989586621683391258"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><a href="#local-6989586621683391260"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683391264"><span class="hs-identifier hs-var">mono_ty</span></a><span>
</span><a name="line-1351"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391266"><a href="#local-6989586621683391266"><span class="hs-identifier">mono_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391260"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1352"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1353"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391265"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1354"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcFunBind"><span class="hs-identifier hs-var">TcFunBind</span></a><span> </span><a href="#local-6989586621683391266"><span class="hs-identifier hs-var">mono_info</span></a><span> </span><a href="#local-6989586621683391259"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683391261"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1355"></a><span>
</span><a name="line-1356"></a><span class="hs-identifier">tcLhs</span><span> </span><a name="local-6989586621683391267"><a href="#local-6989586621683391267"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683391268"><a href="#local-6989586621683391268"><span class="hs-identifier">no_gen</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391269"><a href="#local-6989586621683391269"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391270"><a href="#local-6989586621683391270"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1357"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Typechecking pattern bindings]</span><span>
</span><a name="line-1358"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391280"><a href="#local-6989586621683391280"><span class="hs-identifier">sig_mbis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#tcLhsSigId"><span class="hs-identifier hs-var">tcLhsSigId</span></a><span> </span><a href="#local-6989586621683391268"><span class="hs-identifier hs-var">no_gen</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391273"><span class="hs-identifier hs-var">sig_names</span></a><span>
</span><a name="line-1359"></a><span>
</span><a name="line-1360"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391281"><a href="#local-6989586621683391281"><span class="hs-identifier">inst_sig_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1361"></a><span>                             </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mbi_poly_name</span><span> </span><a href="#local-6989586621683391282"><span class="hs-identifier hs-var">mbi</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span> </span><a href="#local-6989586621683391282"><span class="hs-identifier hs-var">mbi</span></a><span class="hs-special">)</span><span>
</span><a name="line-1362"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391282"><a href="#local-6989586621683391282"><span class="hs-identifier">mbi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391280"><span class="hs-identifier hs-var">sig_mbis</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1363"></a><span>
</span><a name="line-1364"></a><span>            </span><span class="hs-comment">-- See Note [Existentials in pattern bindings]</span><span>
</span><a name="line-1365"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683391284"><a href="#local-6989586621683391284"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391285"><a href="#local-6989586621683391285"><span class="hs-identifier">nosig_mbis</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683391286"><a href="#local-6989586621683391286"><span class="hs-identifier">pat_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1366"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#patMonoBindsCtxt"><span class="hs-identifier hs-var">patMonoBindsCtxt</span></a><span> </span><a href="#local-6989586621683391269"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683391270"><span class="hs-identifier hs-var">grhss</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1367"></a><span>               </span><a href="TcUnify.html#tcInferNoInst"><span class="hs-identifier hs-var">tcInferNoInst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683391283"><a href="#local-6989586621683391283"><span class="hs-identifier">exp_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1368"></a><span>               </span><a href="TcPat.html#tcLetPat"><span class="hs-identifier hs-var">tcLetPat</span></a><span> </span><a href="#local-6989586621683391281"><span class="hs-identifier hs-var">inst_sig_fun</span></a><span> </span><a href="#local-6989586621683391268"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><a href="#local-6989586621683391269"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683391283"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1369"></a><span>               </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683391275"><span class="hs-identifier hs-var">lookup_info</span></a><span> </span><a href="#local-6989586621683391272"><span class="hs-identifier hs-var">nosig_names</span></a><span>
</span><a name="line-1370"></a><span>
</span><a name="line-1371"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391287"><a href="#local-6989586621683391287"><span class="hs-identifier">mbis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391280"><span class="hs-identifier hs-var">sig_mbis</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683391285"><span class="hs-identifier hs-var">nosig_mbis</span></a><span>
</span><a name="line-1372"></a><span>
</span><a name="line-1373"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcLhs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391289"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391289"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1374"></a><span>                                </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391288"><a href="#local-6989586621683391288"><span class="hs-identifier">mbi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391287"><span class="hs-identifier hs-var">mbis</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391289"><a href="#local-6989586621683391289"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span> </span><a href="#local-6989586621683391288"><span class="hs-identifier hs-var">mbi</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1375"></a><span>                           </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391268"><span class="hs-identifier hs-var">no_gen</span></a><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>
</span><a name="line-1377"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcPatBind"><span class="hs-identifier hs-var">TcPatBind</span></a><span> </span><a href="#local-6989586621683391287"><span class="hs-identifier hs-var">mbis</span></a><span> </span><a href="#local-6989586621683391284"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683391270"><span class="hs-identifier hs-var">grhss</span></a><span> </span><a href="#local-6989586621683391286"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1378"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1379"></a><span>    </span><a name="local-6989586621683391271"><a href="#local-6989586621683391271"><span class="hs-identifier">bndr_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621683391269"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-1380"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683391272"><a href="#local-6989586621683391272"><span class="hs-identifier">nosig_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391273"><a href="#local-6989586621683391273"><span class="hs-identifier">sig_names</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionWith</span><span> </span><a href="#local-6989586621683391274"><span class="hs-identifier hs-var">find_sig</span></a><span> </span><a href="#local-6989586621683391271"><span class="hs-identifier hs-var">bndr_names</span></a><span>
</span><a name="line-1381"></a><span>
</span><a name="line-1382"></a><span>    </span><span class="hs-identifier">find_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span class="hs-special">)</span><span>
</span><a name="line-1383"></a><span>    </span><a name="local-6989586621683391274"><a href="#local-6989586621683391274"><span class="hs-identifier">find_sig</span></a></a><span> </span><a name="local-6989586621683391276"><a href="#local-6989586621683391276"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683391267"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391276"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1384"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><a name="local-6989586621683391277"><a href="#local-6989586621683391277"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391276"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391277"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1385"></a><span>                      </span><span class="hs-identifier">_</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621683391276"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1386"></a><span>
</span><a name="line-1387"></a><span>      </span><span class="hs-comment">-- After typechecking the pattern, look up the binder</span><span>
</span><a name="line-1388"></a><span>      </span><span class="hs-comment">-- names that lack a signature, which the pattern has brought</span><span>
</span><a name="line-1389"></a><span>      </span><span class="hs-comment">-- into scope.</span><span>
</span><a name="line-1390"></a><span>    </span><span class="hs-identifier">lookup_info</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span>
</span><a name="line-1391"></a><span>    </span><a name="local-6989586621683391275"><a href="#local-6989586621683391275"><span class="hs-identifier">lookup_info</span></a></a><span> </span><a name="local-6989586621683391278"><a href="#local-6989586621683391278"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1392"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391279"><a href="#local-6989586621683391279"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683391278"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1393"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391278"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1394"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1395"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391279"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1396"></a><span>
</span><a name="line-1397"></a><span class="hs-identifier">tcLhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391290"><a href="#local-6989586621683391290"><span class="hs-identifier">other_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLhs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391290"><span class="hs-identifier hs-var">other_bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1398"></a><span>        </span><span class="hs-comment">-- AbsBind, VarBind impossible</span><span>
</span><a name="line-1399"></a><span>
</span><a name="line-1400"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-1401"></a><span class="hs-identifier">tcLhsSigId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span>
</span><a name="line-1402"></a><a name="tcLhsSigId"><a href="TcBinds.html#tcLhsSigId"><span class="hs-identifier">tcLhsSigId</span></a></a><span> </span><a name="local-6989586621683391291"><a href="#local-6989586621683391291"><span class="hs-identifier">no_gen</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683391292"><a href="#local-6989586621683391292"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391293"><a href="#local-6989586621683391293"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1403"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683391294"><a href="#local-6989586621683391294"><span class="hs-identifier">inst_sig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcInstSig"><span class="hs-identifier hs-var">tcInstSig</span></a><span> </span><a href="#local-6989586621683391293"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1404"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391295"><a href="#local-6989586621683391295"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#newSigLetBndr"><span class="hs-identifier hs-var">newSigLetBndr</span></a><span> </span><a href="#local-6989586621683391291"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><a href="#local-6989586621683391292"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683391294"><span class="hs-identifier hs-var">inst_sig</span></a><span>
</span><a name="line-1405"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_poly_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391292"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1406"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_sig</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683391294"><span class="hs-identifier hs-var">inst_sig</span></a><span>
</span><a name="line-1407"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391295"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1408"></a><span>
</span><a name="line-1409"></a><span class="hs-comment">------------</span><span>
</span><a name="line-1410"></a><span class="hs-identifier">newSigLetBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-1411"></a><a name="newSigLetBndr"><a href="TcBinds.html#newSigLetBndr"><span class="hs-identifier">newSigLetBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#LetGblBndr"><span class="hs-identifier hs-var">LetGblBndr</span></a><span> </span><a name="local-6989586621683391296"><a href="#local-6989586621683391296"><span class="hs-identifier">prags</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683391297"><a href="#local-6989586621683391297"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391298"><a href="#local-6989586621683391298"><span class="hs-identifier">id_sig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1412"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391299"><a href="#local-6989586621683391299"><span class="hs-identifier">poly_id</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391298"><span class="hs-identifier hs-var">id_sig</span></a><span>
</span><a name="line-1413"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier hs-var">addInlinePrags</span></a><span> </span><a href="#local-6989586621683391299"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-special">(</span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span> </span><a href="#local-6989586621683391296"><span class="hs-identifier hs-var">prags</span></a><span> </span><a href="#local-6989586621683391297"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1414"></a><span class="hs-identifier">newSigLetBndr</span><span> </span><a name="local-6989586621683391300"><a href="#local-6989586621683391300"><span class="hs-identifier">no_gen</span></a></a><span> </span><a name="local-6989586621683391301"><a href="#local-6989586621683391301"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_tau</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391302"><a href="#local-6989586621683391302"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#newLetBndr"><span class="hs-identifier hs-var">newLetBndr</span></a><span> </span><a href="#local-6989586621683391300"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><a href="#local-6989586621683391301"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683391302"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-1416"></a><span>
</span><a name="line-1417"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-1418"></a><span class="hs-identifier">tcRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcBinds.html#TcMonoBind"><span class="hs-identifier hs-type">TcMonoBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsBind</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1419"></a><a name="tcRhs"><a href="TcBinds.html#tcRhs"><span class="hs-identifier">tcRhs</span></a></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcFunBind"><span class="hs-identifier hs-var">TcFunBind</span></a><span> </span><a name="local-6989586621683391303"><a href="#local-6989586621683391303"><span class="hs-identifier">info</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391304"><a href="#local-6989586621683391304"><span class="hs-identifier">mb_sig</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391305"><a href="#local-6989586621683391305"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><span>                 </span><a name="local-6989586621683391306"><a href="#local-6989586621683391306"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683391307"><a href="#local-6989586621683391307"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1421"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#tcExtendIdBinderStackForRhs"><span class="hs-identifier hs-var">tcExtendIdBinderStackForRhs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683391303"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">]</span><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1422"></a><span>    </span><a href="TcBinds.html#tcExtendTyVarEnvForRhs"><span class="hs-identifier hs-var">tcExtendTyVarEnvForRhs</span></a><span> </span><a href="#local-6989586621683391304"><span class="hs-identifier hs-var">mb_sig</span></a><span>       </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1423"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcRhs: fun bind&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391305"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391305"><span class="hs-identifier hs-var">mono_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391308"><a href="#local-6989586621683391308"><span class="hs-identifier">co_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391309"><a href="#local-6989586621683391309"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcMatchesFun"><span class="hs-identifier hs-var">tcMatchesFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391306"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683391305"><span class="hs-identifier hs-var">mono_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1425"></a><span>                                 </span><a href="#local-6989586621683391307"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683391305"><span class="hs-identifier hs-var">mono_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1426"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683391306"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683391305"><span class="hs-identifier hs-var">mono_id</span></a><span>
</span><a name="line-1427"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391309"><span class="hs-identifier hs-var">matches'</span></a><span>
</span><a name="line-1428"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_co_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391308"><span class="hs-identifier hs-var">co_fn</span></a><span>
</span><a name="line-1429"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">placeHolderNamesTc</span><span>
</span><a name="line-1430"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_tick</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1431"></a><span>
</span><a name="line-1432"></a><span class="hs-identifier">tcRhs</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcPatBind"><span class="hs-identifier hs-var">TcPatBind</span></a><span> </span><a name="local-6989586621683391310"><a href="#local-6989586621683391310"><span class="hs-identifier">infos</span></a></a><span> </span><a name="local-6989586621683391311"><a href="#local-6989586621683391311"><span class="hs-identifier">pat'</span></a></a><span> </span><a name="local-6989586621683391312"><a href="#local-6989586621683391312"><span class="hs-identifier">grhss</span></a></a><span> </span><a name="local-6989586621683391313"><a href="#local-6989586621683391313"><span class="hs-identifier">pat_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1433"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- When we are doing pattern bindings we *don't* bring any scoped</span><span>
</span><a name="line-1434"></a><span>    </span><span class="hs-comment">-- type variables into scope unlike function bindings</span><span>
</span><a name="line-1435"></a><span>    </span><span class="hs-comment">-- Wny not?  They are not completely rigid.</span><span>
</span><a name="line-1436"></a><span>    </span><span class="hs-comment">-- That's why we have the special case for a single FunBind in tcMonoBinds</span><span>
</span><a name="line-1437"></a><span>    </span><a href="TcBinds.html#tcExtendIdBinderStackForRhs"><span class="hs-identifier hs-var">tcExtendIdBinderStackForRhs</span></a><span> </span><a href="#local-6989586621683391310"><span class="hs-identifier hs-var">infos</span></a><span>        </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1438"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcRhs: pat bind&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391311"><span class="hs-identifier hs-var">pat'</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391313"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1439"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683391314"><a href="#local-6989586621683391314"><span class="hs-identifier">grhss'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#patMonoBindsCtxt"><span class="hs-identifier hs-var">patMonoBindsCtxt</span></a><span> </span><a href="#local-6989586621683391311"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683391312"><span class="hs-identifier hs-var">grhss</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1440"></a><span>                    </span><a href="TcMatches.html#tcGRHSsPat"><span class="hs-identifier hs-var">tcGRHSsPat</span></a><span> </span><a href="#local-6989586621683391312"><span class="hs-identifier hs-var">grhss</span></a><span> </span><a href="#local-6989586621683391313"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-1441"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391311"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391314"><span class="hs-identifier hs-var">grhss'</span></a><span>
</span><a name="line-1442"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NPatBindTc</span><span> </span><span class="hs-identifier hs-var">placeHolderNamesTc</span><span> </span><a href="#local-6989586621683391313"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-1443"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_ticks</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-1444"></a><span>
</span><a name="line-1445"></a><span class="hs-identifier">tcExtendTyVarEnvForRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390815"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390815"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1446"></a><a name="tcExtendTyVarEnvForRhs"><a href="TcBinds.html#tcExtendTyVarEnvForRhs"><span class="hs-identifier">tcExtendTyVarEnvForRhs</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621683391315"><a href="#local-6989586621683391315"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391315"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1448"></a><span class="hs-identifier">tcExtendTyVarEnvForRhs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391316"><a href="#local-6989586621683391316"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683391317"><a href="#local-6989586621683391317"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1449"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#tcExtendTyVarEnvFromSig"><span class="hs-identifier hs-var">tcExtendTyVarEnvFromSig</span></a><span> </span><a href="#local-6989586621683391316"><span class="hs-identifier hs-var">sig</span></a><span> </span><a href="#local-6989586621683391317"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span class="hs-identifier">tcExtendTyVarEnvFromSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390814"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390814"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1452"></a><a name="tcExtendTyVarEnvFromSig"><a href="TcBinds.html#tcExtendTyVarEnvFromSig"><span class="hs-identifier">tcExtendTyVarEnvFromSig</span></a></a><span> </span><a name="local-6989586621683391318"><a href="#local-6989586621683391318"><span class="hs-identifier">sig_inst</span></a></a><span> </span><a name="local-6989586621683391319"><a href="#local-6989586621683391319"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1453"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_skols</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391320"><a href="#local-6989586621683391320"><span class="hs-identifier">skol_prs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_wcs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391321"><a href="#local-6989586621683391321"><span class="hs-identifier">wcs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391318"><span class="hs-identifier hs-var">sig_inst</span></a><span>
</span><a name="line-1454"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683391321"><span class="hs-identifier hs-var">wcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1455"></a><span>    </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683391320"><span class="hs-identifier hs-var">skol_prs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1456"></a><span>    </span><a href="#local-6989586621683391319"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1457"></a><span>
</span><a name="line-1458"></a><span class="hs-identifier">tcExtendIdBinderStackForRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390813"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683390813"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1459"></a><span class="hs-comment">-- Extend the TcBinderStack for the RHS of the binding, with</span><span>
</span><a name="line-1460"></a><span class="hs-comment">-- the monomorphic Id.  That way, if we have, say</span><span>
</span><a name="line-1461"></a><span class="hs-comment">--     f = \x -&gt; blah</span><span>
</span><a name="line-1462"></a><span class="hs-comment">-- and something goes wrong in 'blah', we get a &quot;relevant binding&quot;</span><span>
</span><a name="line-1463"></a><span class="hs-comment">-- looking like  f :: alpha -&gt; beta</span><span>
</span><a name="line-1464"></a><span class="hs-comment">-- This applies if 'f' has a type signature too:</span><span>
</span><a name="line-1465"></a><span class="hs-comment">--    f :: forall a. [a] -&gt; [a]</span><span>
</span><a name="line-1466"></a><span class="hs-comment">--    f x = True</span><span>
</span><a name="line-1467"></a><span class="hs-comment">-- We can't unify True with [a], and a relevant binding is f :: [a] -&gt; [a]</span><span>
</span><a name="line-1468"></a><span class="hs-comment">-- If we had the *polymorphic* version of f in the TcBinderStack, it</span><span>
</span><a name="line-1469"></a><span class="hs-comment">-- would not be reported as relevant, because its type is closed</span><span>
</span><a name="line-1470"></a><a name="tcExtendIdBinderStackForRhs"><a href="TcBinds.html#tcExtendIdBinderStackForRhs"><span class="hs-identifier">tcExtendIdBinderStackForRhs</span></a></a><span> </span><a name="local-6989586621683391322"><a href="#local-6989586621683391322"><span class="hs-identifier">infos</span></a></a><span> </span><a name="local-6989586621683391323"><a href="#local-6989586621683391323"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1471"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">TcIdBndr</span><span> </span><a href="#local-6989586621683391324"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span>
</span><a name="line-1472"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="TcBinds.html#MBI"><span class="hs-identifier hs-var">MBI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mbi_mono_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391324"><a href="#local-6989586621683391324"><span class="hs-identifier">mono_id</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391322"><span class="hs-identifier hs-var">infos</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1473"></a><span>                        </span><a href="#local-6989586621683391323"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1474"></a><span>    </span><span class="hs-comment">-- NotTopLevel: it's a monomorphic binding</span><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-1477"></a><span class="hs-identifier">getMonoBindInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><a href="TcBinds.html#TcMonoBind"><span class="hs-identifier hs-type">TcMonoBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcBinds.html#MonoBindInfo"><span class="hs-identifier hs-type">MonoBindInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-1478"></a><a name="getMonoBindInfo"><a href="TcBinds.html#getMonoBindInfo"><span class="hs-identifier">getMonoBindInfo</span></a></a><span> </span><a name="local-6989586621683391325"><a href="#local-6989586621683391325"><span class="hs-identifier">tc_binds</span></a></a><span>
</span><a name="line-1479"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391326"><span class="hs-identifier hs-var">get_info</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683391325"><span class="hs-identifier hs-var">tc_binds</span></a><span>
</span><a name="line-1480"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1481"></a><span>    </span><a name="local-6989586621683391326"><a href="#local-6989586621683391326"><span class="hs-identifier">get_info</span></a></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcFunBind"><span class="hs-identifier hs-var">TcFunBind</span></a><span> </span><a name="local-6989586621683391327"><a href="#local-6989586621683391327"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><a name="local-6989586621683391328"><a href="#local-6989586621683391328"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391327"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683391328"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1482"></a><span>    </span><span class="hs-identifier">get_info</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#TcPatBind"><span class="hs-identifier hs-var">TcPatBind</span></a><span> </span><a name="local-6989586621683391329"><a href="#local-6989586621683391329"><span class="hs-identifier">infos</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683391330"><a href="#local-6989586621683391330"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391329"><span class="hs-identifier hs-var">infos</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683391330"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1483"></a><span>
</span><a name="line-1484"></a><span>
</span><a name="line-1485"></a><span class="hs-comment">{- Note [Typechecking pattern bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Look at:
   - typecheck/should_compile/ExPat
   - Trac #12427, typecheck/should_compile/T12427{a,b}

  data T where
    MkT :: Integral a =&gt; a -&gt; Int -&gt; T

and suppose t :: T.  Which of these pattern bindings are ok?

  E1. let { MkT p _ = t } in &lt;body&gt;

  E2. let { MkT _ q = t } in &lt;body&gt;

  E3. let { MkT (toInteger -&gt; r) _ = t } in &lt;body&gt;

* (E1) is clearly wrong because the existential 'a' escapes.
  What type could 'p' possibly have?

* (E2) is fine, despite the existential pattern, because
  q::Int, and nothing escapes.

* Even (E3) is fine.  The existential pattern binds a dictionary
  for (Integral a) which the view pattern can use to convert the
  a-valued field to an Integer, so r :: Integer.

An easy way to see all three is to imagine the desugaring.
For (E2) it would look like
    let q = case t of MkT _ q' -&gt; q'
    in &lt;body&gt;


We typecheck pattern bindings as follows.  First tcLhs does this:

  1. Take each type signature q :: ty, partial or complete, and
     instantiate it (with tcLhsSigId) to get a MonoBindInfo.  This
     gives us a fresh &quot;mono_id&quot; qm :: instantiate(ty), where qm has
     a fresh name.

     Any fresh unification variables in instantiate(ty) born here, not
     deep under implications as would happen if we allocated them when
     we encountered q during tcPat.

  2. Build a little environment mapping &quot;q&quot; -&gt; &quot;qm&quot; for those Ids
     with signatures (inst_sig_fun)

  3. Invoke tcLetPat to typecheck the pattern.

     - We pass in the current TcLevel.  This is captured by
       TcPat.tcLetPat, and put into the pc_lvl field of PatCtxt, in
       PatEnv.

     - When tcPat finds an existential constructor, it binds fresh
       type variables and dictionaries as usual, increments the TcLevel,
       and emits an implication constraint.

     - When we come to a binder (TcPat.tcPatBndr), it looks it up
       in the little environment (the pc_sig_fn field of PatCtxt).

         Success =&gt; There was a type signature, so just use it,
                    checking compatibility with the expected type.

         Failure =&gt; No type sigature.
             Infer case: (happens only outside any constructor pattern)
                         use a unification variable
                         at the outer level pc_lvl

             Check case: use promoteTcType to promote the type
                         to the outer level pc_lvl.  This is the
                         place where we emit a constraint that'll blow
                         up if existential capture takes place

       Result: the type of the binder is always at pc_lvl. This is
       crucial.

  4. Throughout, when we are making up an Id for the pattern-bound variables
     (newLetBndr), we have two cases:

     - If we are generalising (generalisation plan is InferGen or
       CheckGen), then the let_bndr_spec will be LetLclBndr.  In that case
       we want to bind a cloned, local version of the variable, with the
       type given by the pattern context, *not* by the signature (even if
       there is one; see Trac #7268). The mkExport part of the
       generalisation step will do the checking and impedance matching
       against the signature.

     - If for some some reason we are not generalising (plan = NoGen), the
       LetBndrSpec will be LetGblBndr.  In that case we must bind the
       global version of the Id, and do so with precisely the type given
       in the signature.  (Then we unify with the type from the pattern
       context type.)


And that's it!  The implication constraints check for the skolem
escape.  It's quite simple and neat, and more expressive than before
e.g. GHC 8.0 rejects (E2) and (E3).

Example for (E1), starting at level 1.  We generate
     p :: beta:1, with constraints (forall:3 a. Integral a =&gt; a ~ beta)
The (a~beta) can't float (because of the 'a'), nor be solved (because
beta is untouchable.)

Example for (E2), we generate
     q :: beta:1, with constraint (forall:3 a. Integral a =&gt; Int ~ beta)
The beta is untoucable, but floats out of the constraint and can
be solved absolutely fine.


************************************************************************
*                                                                      *
                Generalisation
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1599"></a><span>
</span><a name="line-1600"></a><span class="hs-keyword">data</span><span> </span><a name="GeneralisationPlan"><a href="TcBinds.html#GeneralisationPlan"><span class="hs-identifier">GeneralisationPlan</span></a></a><span>
</span><a name="line-1601"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NoGen"><a href="TcBinds.html#NoGen"><span class="hs-identifier">NoGen</span></a></a><span>               </span><span class="hs-comment">-- No generalisation, no AbsBinds</span><span>
</span><a name="line-1602"></a><span>
</span><a name="line-1603"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InferGen"><a href="TcBinds.html#InferGen"><span class="hs-identifier">InferGen</span></a></a><span>            </span><span class="hs-comment">-- Implicit generalisation; there is an AbsBinds</span><span>
</span><a name="line-1604"></a><span>       </span><span class="hs-identifier hs-type">Bool</span><span>             </span><span class="hs-comment">--   True &lt;=&gt; apply the MR; generalise only unconstrained type vars</span><span>
</span><a name="line-1605"></a><span>
</span><a name="line-1606"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CheckGen"><a href="TcBinds.html#CheckGen"><span class="hs-identifier">CheckGen</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span>
</span><a name="line-1607"></a><span>                        </span><span class="hs-comment">-- One FunBind with a signature</span><span>
</span><a name="line-1608"></a><span>                        </span><span class="hs-comment">-- Explicit generalisation</span><span>
</span><a name="line-1609"></a><span>
</span><a name="line-1610"></a><span class="hs-comment">-- A consequence of the no-AbsBinds choice (NoGen) is that there is</span><span>
</span><a name="line-1611"></a><span class="hs-comment">-- no &quot;polymorphic Id&quot; and &quot;monmomorphic Id&quot;; there is just the one</span><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcBinds.html#GeneralisationPlan"><span class="hs-identifier hs-type">GeneralisationPlan</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1614"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="TcBinds.html#NoGen"><span class="hs-identifier hs-var">NoGen</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;NoGen&quot;</span><span>
</span><a name="line-1615"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#InferGen"><span class="hs-identifier hs-var">InferGen</span></a><span> </span><a name="local-6989586621683390809"><a href="#local-6989586621683390809"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;InferGen&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390809"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1616"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcBinds.html#CheckGen"><span class="hs-identifier hs-var">CheckGen</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683390810"><a href="#local-6989586621683390810"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CheckGen&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683390810"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1617"></a><span>
</span><a name="line-1618"></a><span class="hs-identifier">decideGeneralisationPlan</span><span>
</span><a name="line-1619"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsGroupClosed</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span>
</span><a name="line-1620"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcBinds.html#GeneralisationPlan"><span class="hs-identifier hs-type">GeneralisationPlan</span></a><span>
</span><a name="line-1621"></a><a name="decideGeneralisationPlan"><a href="TcBinds.html#decideGeneralisationPlan"><span class="hs-identifier">decideGeneralisationPlan</span></a></a><span> </span><a name="local-6989586621683391331"><a href="#local-6989586621683391331"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683391332"><a href="#local-6989586621683391332"><span class="hs-identifier">lbinds</span></a></a><span> </span><a name="local-6989586621683391333"><a href="#local-6989586621683391333"><span class="hs-identifier">closed</span></a></a><span> </span><a name="local-6989586621683391334"><a href="#local-6989586621683391334"><span class="hs-identifier">sig_fn</span></a></a><span>
</span><a name="line-1622"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683391337"><span class="hs-identifier hs-var">has_partial_sigs</span></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#InferGen"><span class="hs-identifier hs-var">InferGen</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">and</span><span> </span><a href="#local-6989586621683391336"><span class="hs-identifier hs-var">partial_sig_mrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1623"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683391355"><a href="#local-6989586621683391355"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683391356"><a href="#local-6989586621683391356"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391340"><span class="hs-identifier hs-var">one_funbind_with_sig</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#CheckGen"><span class="hs-identifier hs-var">CheckGen</span></a><span> </span><a href="#local-6989586621683391355"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621683391356"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1624"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683391339"><span class="hs-identifier hs-var">do_not_generalise</span></a><span> </span><a href="#local-6989586621683391333"><span class="hs-identifier hs-var">closed</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#NoGen"><span class="hs-identifier hs-var">NoGen</span></a><span>
</span><a name="line-1625"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                </span><span class="hs-glyph">=</span><span> </span><a href="TcBinds.html#InferGen"><span class="hs-identifier hs-var">InferGen</span></a><span> </span><a href="#local-6989586621683391338"><span class="hs-identifier hs-var">mono_restriction</span></a><span>
</span><a name="line-1626"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1627"></a><span>    </span><a name="local-6989586621683391335"><a href="#local-6989586621683391335"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683391332"><span class="hs-identifier hs-var">lbinds</span></a><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span>    </span><span class="hs-identifier">partial_sig_mrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-1630"></a><span>    </span><span class="hs-comment">-- One for each partial signature (so empty =&gt; no partial sigs)</span><span>
</span><a name="line-1631"></a><span>    </span><span class="hs-comment">-- The Bool is True if the signature has no constraint context</span><span>
</span><a name="line-1632"></a><span>    </span><span class="hs-comment">--      so we should apply the MR</span><span>
</span><a name="line-1633"></a><span>    </span><span class="hs-comment">-- See Note [Partial type signatures and generalisation]</span><span>
</span><a name="line-1634"></a><span>    </span><a name="local-6989586621683391336"><a href="#local-6989586621683391336"><span class="hs-identifier">partial_sig_mrs</span></a></a><span>
</span><a name="line-1635"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683391345"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1636"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_hs_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391344"><a href="#local-6989586621683391344"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1637"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621683391334"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectHsBindListBinders</span><span> </span><a href="#local-6989586621683391332"><span class="hs-identifier hs-var">lbinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1638"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391345"><a href="#local-6989586621683391345"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitLHsSigmaTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsSigWcType</span><span> </span><a href="#local-6989586621683391344"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1639"></a><span>
</span><a name="line-1640"></a><span>    </span><a name="local-6989586621683391337"><a href="#local-6989586621683391337"><span class="hs-identifier">has_partial_sigs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683391336"><span class="hs-identifier hs-var">partial_sig_mrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1641"></a><span>
</span><a name="line-1642"></a><span>    </span><a name="local-6989586621683391338"><a href="#local-6989586621683391338"><span class="hs-identifier">mono_restriction</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.MonomorphismRestriction</span><span> </span><a href="#local-6989586621683391331"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1643"></a><span>                     </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621683391341"><span class="hs-identifier hs-var">restricted</span></a><span> </span><a href="#local-6989586621683391335"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1644"></a><span>
</span><a name="line-1645"></a><span>    </span><a name="local-6989586621683391339"><a href="#local-6989586621683391339"><span class="hs-identifier">do_not_generalise</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IsGroupClosed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1646"></a><span>        </span><span class="hs-comment">-- The 'True' means that all of the group's</span><span>
</span><a name="line-1647"></a><span>        </span><span class="hs-comment">-- free vars have ClosedTypeId=True; so we can ignore</span><span>
</span><a name="line-1648"></a><span>        </span><span class="hs-comment">-- -XMonoLocalBinds, and generalise anyway</span><span>
</span><a name="line-1649"></a><span>    </span><span class="hs-identifier">do_not_generalise</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.MonoLocalBinds</span><span> </span><a href="#local-6989586621683391331"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1650"></a><span>
</span><a name="line-1651"></a><span>    </span><span class="hs-comment">-- With OutsideIn, all nested bindings are monomorphic</span><span>
</span><a name="line-1652"></a><span>    </span><span class="hs-comment">-- except a single function binding with a signature</span><span>
</span><a name="line-1653"></a><span>    </span><a name="local-6989586621683391340"><a href="#local-6989586621683391340"><span class="hs-identifier">one_funbind_with_sig</span></a></a><span>
</span><a name="line-1654"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683391346"><a href="#local-6989586621683391346"><span class="hs-identifier">lbind</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391347"><a href="#local-6989586621683391347"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391332"><span class="hs-identifier hs-var">lbinds</span></a><span>
</span><a name="line-1655"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><a name="local-6989586621683391348"><a href="#local-6989586621683391348"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683391334"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683391347"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1656"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391346"><span class="hs-identifier hs-var">lbind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391348"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1657"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1658"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1659"></a><span>
</span><a name="line-1660"></a><span>    </span><span class="hs-comment">-- The Haskell 98 monomorphism restriction</span><span>
</span><a name="line-1661"></a><span>    </span><a name="local-6989586621683391341"><a href="#local-6989586621683391341"><span class="hs-identifier">restricted</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1662"></a><span>    </span><span class="hs-identifier">restricted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">var_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391349"><a href="#local-6989586621683391349"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391343"><span class="hs-identifier hs-var">no_sig</span></a><span> </span><a href="#local-6989586621683391349"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1663"></a><span>    </span><span class="hs-identifier">restricted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391350"><a href="#local-6989586621683391350"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391351"><a href="#local-6989586621683391351"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391342"><span class="hs-identifier hs-var">restricted_match</span></a><span> </span><a href="#local-6989586621683391351"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1664"></a><span>                                                           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683391343"><span class="hs-identifier hs-var">no_sig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683391350"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1665"></a><span>    </span><span class="hs-identifier">restricted</span><span> </span><a name="local-6989586621683391352"><a href="#local-6989586621683391352"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;isRestrictedGroup/unrestricted&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391352"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1666"></a><span>
</span><a name="line-1667"></a><span>    </span><a name="local-6989586621683391342"><a href="#local-6989586621683391342"><span class="hs-identifier">restricted_match</span></a></a><span> </span><a name="local-6989586621683391353"><a href="#local-6989586621683391353"><span class="hs-identifier">mg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">matchGroupArity</span><span> </span><a href="#local-6989586621683391353"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1668"></a><span>        </span><span class="hs-comment">-- No args =&gt; like a pattern binding</span><span>
</span><a name="line-1669"></a><span>        </span><span class="hs-comment">-- Some args =&gt; a function binding</span><span>
</span><a name="line-1670"></a><span>
</span><a name="line-1671"></a><span>    </span><a name="local-6989586621683391343"><a href="#local-6989586621683391343"><span class="hs-identifier">no_sig</span></a></a><span> </span><a name="local-6989586621683391354"><a href="#local-6989586621683391354"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hasCompleteSig</span><span> </span><a href="#local-6989586621683391334"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683391354"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1672"></a><span>
</span><a name="line-1673"></a><span class="hs-identifier">isClosedBndrGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsGroupClosed</span><span>
</span><a name="line-1674"></a><a name="isClosedBndrGroup"><a href="TcBinds.html#isClosedBndrGroup"><span class="hs-identifier">isClosedBndrGroup</span></a></a><span> </span><a name="local-6989586621683391357"><a href="#local-6989586621683391357"><span class="hs-identifier">type_env</span></a></a><span> </span><a name="local-6989586621683391358"><a href="#local-6989586621683391358"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-1675"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsGroupClosed</span><span> </span><a href="#local-6989586621683391360"><span class="hs-identifier hs-var">fv_env</span></a><span> </span><a href="#local-6989586621683391359"><span class="hs-identifier hs-var">type_closed</span></a><span>
</span><a name="line-1676"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1677"></a><span>    </span><a name="local-6989586621683391359"><a href="#local-6989586621683391359"><span class="hs-identifier">type_closed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">allUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameSetAll</span><span> </span><a href="#local-6989586621683391364"><span class="hs-identifier hs-var">is_closed_type_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391360"><span class="hs-identifier hs-var">fv_env</span></a><span>
</span><a name="line-1678"></a><span>
</span><a name="line-1679"></a><span>    </span><span class="hs-identifier">fv_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1680"></a><span>    </span><a name="local-6989586621683391360"><a href="#local-6989586621683391360"><span class="hs-identifier">fv_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683391361"><span class="hs-identifier hs-var">bindFvs</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391358"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span>    </span><span class="hs-identifier">bindFvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsBindLR</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1683"></a><span>    </span><a name="local-6989586621683391361"><a href="#local-6989586621683391361"><span class="hs-identifier">bindFvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391365"><a href="#local-6989586621683391365"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1684"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391366"><a href="#local-6989586621683391366"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1685"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391367"><a href="#local-6989586621683391367"><span class="hs-identifier">open_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391362"><span class="hs-identifier hs-var">get_open_fvs</span></a><span> </span><a href="#local-6989586621683391366"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1686"></a><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683391365"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391367"><span class="hs-identifier hs-var">open_fvs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1687"></a><span>    </span><span class="hs-identifier">bindFvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391368"><a href="#local-6989586621683391368"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683391369"><a href="#local-6989586621683391369"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1688"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683391370"><a href="#local-6989586621683391370"><span class="hs-identifier">open_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683391362"><span class="hs-identifier hs-var">get_open_fvs</span></a><span> </span><a href="#local-6989586621683391369"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1689"></a><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683391371"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683391370"><span class="hs-identifier hs-var">open_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683391371"><a href="#local-6989586621683391371"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621683391368"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">]</span><span>
</span><a name="line-1690"></a><span>    </span><span class="hs-identifier">bindFvs</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1691"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1692"></a><span>
</span><a name="line-1693"></a><span>    </span><a name="local-6989586621683391362"><a href="#local-6989586621683391362"><span class="hs-identifier">get_open_fvs</span></a></a><span> </span><a name="local-6989586621683391372"><a href="#local-6989586621683391372"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683391363"><span class="hs-identifier hs-var">is_closed</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683391372"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1694"></a><span>
</span><a name="line-1695"></a><span>    </span><span class="hs-identifier">is_closed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ClosedTypeId</span><span>
</span><a name="line-1696"></a><span>    </span><a name="local-6989586621683391363"><a href="#local-6989586621683391363"><span class="hs-identifier">is_closed</span></a></a><span> </span><a name="local-6989586621683391373"><a href="#local-6989586621683391373"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1697"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391374"><a href="#local-6989586621683391374"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683391357"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621683391373"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1698"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683391374"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1699"></a><span>          </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1700"></a><span>          </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ClosedLet</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1701"></a><span>          </span><span class="hs-identifier">_</span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1702"></a><span>
</span><a name="line-1703"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1704"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-comment">-- The free-var set for a top level binding mentions</span><span>
</span><a name="line-1705"></a><span>
</span><a name="line-1706"></a><span>
</span><a name="line-1707"></a><span>    </span><span class="hs-identifier">is_closed_type_id</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1708"></a><span>    </span><span class="hs-comment">-- We're already removed Global and ClosedLet Ids</span><span>
</span><a name="line-1709"></a><span>    </span><a name="local-6989586621683391364"><a href="#local-6989586621683391364"><span class="hs-identifier">is_closed_type_id</span></a></a><span> </span><a name="local-6989586621683391375"><a href="#local-6989586621683391375"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1710"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683391376"><a href="#local-6989586621683391376"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683391357"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621683391375"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1711"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683391376"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1712"></a><span>          </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonClosedLet</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683391377"><a href="#local-6989586621683391377"><span class="hs-identifier">cl</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683391377"><span class="hs-identifier hs-var">cl</span></a><span>
</span><a name="line-1713"></a><span>          </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotLetBound</span><span> </span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1714"></a><span>          </span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1715"></a><span>               </span><span class="hs-comment">-- In-scope type variables are not closed!</span><span>
</span><a name="line-1716"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;is_closed_id&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683391375"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1717"></a><span>
</span><a name="line-1718"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1719"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- The free-var set for a top level binding mentions</span><span>
</span><a name="line-1720"></a><span>               </span><span class="hs-comment">-- imported things too, so that we can report unused imports</span><span>
</span><a name="line-1721"></a><span>               </span><span class="hs-comment">-- These won't be in the local type env.</span><span>
</span><a name="line-1722"></a><span>               </span><span class="hs-comment">-- Ditto class method etc from the current module</span><span>
</span><a name="line-1723"></a><span>
</span><a name="line-1724"></a><span>
</span><a name="line-1725"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
               Error contexts and messages
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1730"></a><span>
</span><a name="line-1731"></a><span class="hs-comment">-- This one is called on LHS, when pat and grhss are both Name</span><span>
</span><a name="line-1732"></a><span class="hs-comment">-- and on RHS, when pat is TcId and grhss is still Name</span><span>
</span><a name="line-1733"></a><span class="hs-identifier">patMonoBindsCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutputableBndrId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683390811"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621683390812"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-1734"></a><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683390811"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621683390812"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1735"></a><a name="patMonoBindsCtxt"><a href="TcBinds.html#patMonoBindsCtxt"><span class="hs-identifier">patMonoBindsCtxt</span></a></a><span> </span><a name="local-6989586621683391378"><a href="#local-6989586621683391378"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683391379"><a href="#local-6989586621683391379"><span class="hs-identifier">grhss</span></a></a><span>
</span><a name="line-1736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In a pattern binding:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprPatBind</span><span> </span><a href="#local-6989586621683391378"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683391379"><span class="hs-identifier hs-var">grhss</span></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a></pre></body></html>