<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">--</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- Copyright (c) 2018 Andreas Klebinger</span><span>
</span><a name="line-3"></a><span class="hs-comment">--</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies, ScopedTypeVariables, CPP #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# OPTIONS_GHC -fprof-auto #-}</span><span>
</span><a name="line-8"></a><span class="hs-comment">--{-# OPTIONS_GHC -ddump-simpl -ddump-to-file -ddump-cmm #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">BlockLayout</span><span>
</span><a name="line-11"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="BlockLayout.html#sequenceTop"><span class="hs-identifier hs-var">sequenceTop</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Instruction.html"><span class="hs-identifier">Instruction</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="NCGMonad.html"><span class="hs-identifier">NCGMonad</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="CFG.html"><span class="hs-identifier">CFG</span></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GeneralFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">backendMaintainsCfg</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- DEBUGGING ONLY</span><span>
</span><a name="line-37"></a><span class="hs-comment">--import Debug</span><span>
</span><a name="line-38"></a><span class="hs-comment">--import Debug.Trace</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">removeDups</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmm.html"><span class="hs-identifier">PprCmm</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toList</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl.Graph</span></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">{-
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~~~ Note [Chain based CFG serialization]
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  For additional information also look at
  https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/CodeLayout

  We have a CFG with edge weights based on which we try to place blocks next to
  each other.

  Edge weights not only represent likelyhood of control transfer between blocks
  but also how much a block would benefit from being placed sequentially after
  it's predecessor.
  For example blocks which are preceeded by an info table are more likely to end
  up in a different cache line than their predecessor. So there is less benefit
  in placing them sequentially.

  For example consider this example:

  A:  ...
      jmp cond D (weak successor)
      jmp B
  B:  ...
      jmp C
  C:  ...
      jmp X
  D:  ...
      jmp B (weak successor)

  We determine a block layout by building up chunks (calling them chains) of
  possible control flows for which blocks will be placed sequentially.

  Eg for our example we might end up with two chains like:
  [A-&gt;B-&gt;C-&gt;X],[D]. Blocks inside chains will always be placed sequentially.
  However there is no particular order in which chains are placed since
  (hopefully) the blocks for which sequentially is important have already
  been placed in the same chain.

  -----------------------------------------------------------------------------
      First try to create a lists of good chains.
  -----------------------------------------------------------------------------

  We do so by taking a block not yet placed in a chain and
  looking at these cases:

  *)  Check if the best predecessor of the block is at the end of a chain.
      If so add the current block to the end of that chain.

      Eg if we look at block C and already have the chain (A -&gt; B)
      then we extend the chain to (A -&gt; B -&gt; C).

      Combined with the fact that we process blocks in reverse post order
      this means loop bodies and trivially sequential control flow already
      ends up as a single chain.

  *)  Otherwise we create a singleton chain from the block we are looking at.
      Eg if we have from the example above already constructed (A-&gt;B)
      and look at D we create the chain (D) resulting in the chains [A-&gt;B, D]

  -----------------------------------------------------------------------------
      We then try to fuse chains.
  -----------------------------------------------------------------------------

  There are edge cases which result in two chains being created which trivially
  represent linear control flow. For example we might have the chains
  [(A-B-C),(D-E)] with an cfg triangle:

      A-----&gt;C-&gt;D-&gt;E
       \-&gt;B-/

  We also get three independent chains if two branches end with a jump
  to a common successor.

  We take care of these cases by fusing chains which are connected by an
  edge.

  We do so by looking at the list of edges sorted by weight.
  Given the edge (C -&gt; D) we try to find two chains such that:
      * C is at the end of chain one.
      * D is in front of chain two.
      * If two such chains exist we fuse them.
  We then remove the edge and repeat the process for the rest of the edges.

  -----------------------------------------------------------------------------
      Place indirect successors (neighbours) after each other
  -----------------------------------------------------------------------------

  We might have chains [A,B,C,X],[E] in a CFG of the sort:

    A ---&gt; B ---&gt; C --------&gt; X(exit)
                   \- -&gt;E- -/

  While E does not follow X it's still beneficial to place them near each other.
  This can be advantageous if eg C,X,E will end up in the same cache line.

  TODO: If we remove edges as we use them (eg if we build up A-&gt;B remove A-&gt;B
        from the list) we could save some more work in later phases.


  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~~~ Note [Triangle Control Flow]
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  Checking if an argument is already evaluating leads to a somewhat
  special case  which looks like this:

    A:
        if (R1 &amp; 7 != 0) goto Leval; else goto Lwork;
    Leval: // global
        call (I64[R1])(R1) returns to Lwork, args: 8, res: 8, upd: 8;
    Lwork: // global
        ...

        A
        |\
        | Leval
        |/ - (This edge can be missing because of optimizations)
        Lwork

  Once we hit the metal the call instruction is just 2-3 bytes large
  depending on the register used. So we lay out the assembly like this:

        movq %rbx,%rax
        andl $7,%eax
        cmpq $1,%rax
        jne Lwork
    Leval:
        jmp *(%rbx) # encoded in 2-3 bytes.
    &lt;info table&gt;
    Lwork:
        ...

  We could explicitly check for this control flow pattern.

  This is advantageous because:
  * It's optimal if the argument isn't evaluated.
  * If it's evaluated we only have the extra cost of jumping over
    the 2-3 bytes for the call.
  * Guarantees the smaller encoding for the conditional jump.

  However given that Lwork usually has an info table we
  penalize this edge. So Leval should get placed first
  either way and things work out for the best.

  Optimizing for the evaluated case instead would penalize
  the other code path. It adds an jump as we can't fall through
  to Lwork because of the info table.
  Assuming that Lwork is large the chance that the &quot;call&quot; ends up
  in the same cache line is also fairly small.

-}</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- | Look at X number of blocks in two chains to determine</span><span>
</span><a name="line-205"></a><span class="hs-comment">--   if they are &quot;neighbours&quot;.</span><span>
</span><a name="line-206"></a><span class="hs-identifier">neighbourOverlapp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-207"></a><a name="neighbourOverlapp"><a href="BlockLayout.html#neighbourOverlapp"><span class="hs-identifier">neighbourOverlapp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-comment">-- | Only edges heavier than this are considered</span><span>
</span><a name="line-210"></a><span class="hs-comment">--   for fusing two chains into a single chain.</span><span>
</span><a name="line-211"></a><span class="hs-identifier">fuseEdgeThreshold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span>
</span><a name="line-212"></a><a name="fuseEdgeThreshold"><a href="BlockLayout.html#fuseEdgeThreshold"><span class="hs-identifier">fuseEdgeThreshold</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">-- | A non empty ordered sequence of basic blocks.</span><span>
</span><a name="line-216"></a><span class="hs-comment">--   It is suitable for serialization in this order.</span><span>
</span><a name="line-217"></a><span class="hs-keyword">data</span><span> </span><a name="BlockChain"><a href="BlockLayout.html#BlockChain"><span class="hs-identifier">BlockChain</span></a></a><span>
</span><a name="line-218"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="BlockChain"><a href="BlockLayout.html#BlockChain"><span class="hs-identifier">BlockChain</span></a></a><span>
</span><a name="line-219"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="chainMembers"><a href="BlockLayout.html#chainMembers"><span class="hs-identifier">chainMembers</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-220"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="chainBlocks"><a href="BlockLayout.html#chainBlocks"><span class="hs-identifier">chainBlocks</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span>
</span><a name="line-221"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871380"><a href="#local-6989586621684871380"><span class="hs-identifier">s1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871381"><a href="#local-6989586621684871381"><span class="hs-identifier">s2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871380"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871381"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-228"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684871379"><a href="#local-6989586621684871379"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Chain:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#seqToList"><span class="hs-identifier hs-var">seqToList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871379"><span class="hs-identifier hs-var">blks</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-keyword">data</span><span> </span><a name="WeightedEdge"><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier">WeightedEdge</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="WeightedEdge"><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier">WeightedEdge</span></a></a><span> </span><span class="hs-glyph">!</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">!</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-comment">-- Useful for things like sets and debugging purposes, sorts by blocks</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- in the chain.</span><span>
</span><a name="line-235"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-236"></a><span>   </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871377"><a href="#local-6989586621684871377"><span class="hs-identifier">lbls1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871378"><a href="#local-6989586621684871378"><span class="hs-identifier">lbls2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871377"><span class="hs-identifier hs-var">lbls1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871378"><span class="hs-identifier hs-var">lbls2</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">-- | Non deterministic! (Uniques) Sorts edges by weight and nodes.</span><span>
</span><a name="line-240"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-type">WeightedEdge</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-241"></a><span>  </span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-var">WeightedEdge</span></a><span> </span><a name="local-6989586621684871371"><a href="#local-6989586621684871371"><span class="hs-identifier">from1</span></a></a><span> </span><a name="local-6989586621684871372"><a href="#local-6989586621684871372"><span class="hs-identifier">to1</span></a></a><span> </span><a name="local-6989586621684871373"><a href="#local-6989586621684871373"><span class="hs-identifier">weight1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>          </span><span class="hs-special">(</span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-var">WeightedEdge</span></a><span> </span><a name="local-6989586621684871374"><a href="#local-6989586621684871374"><span class="hs-identifier">from2</span></a></a><span> </span><a name="local-6989586621684871375"><a href="#local-6989586621684871375"><span class="hs-identifier">to2</span></a></a><span> </span><a name="local-6989586621684871376"><a href="#local-6989586621684871376"><span class="hs-identifier">weight2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684871373"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621684871376"><span class="hs-identifier hs-var">weight2</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684871373"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871376"><span class="hs-identifier hs-var">weight2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684871371"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621684871374"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-244"></a><span>      </span><a href="#local-6989586621684871373"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871376"><span class="hs-identifier hs-var">weight2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684871371"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871374"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684871372"><span class="hs-identifier hs-var">to1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621684871375"><span class="hs-identifier hs-var">to2</span></a><span>
</span><a name="line-245"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-246"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684871371"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871374"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684871372"><span class="hs-identifier hs-var">to1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871375"><span class="hs-identifier hs-var">to2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684871373"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871376"><span class="hs-identifier hs-var">weight2</span></a><span>
</span><a name="line-247"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-248"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-249"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-type">WeightedEdge</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-252"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-var">WeightedEdge</span></a><span> </span><a name="local-6989586621684871368"><a href="#local-6989586621684871368"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621684871369"><a href="#local-6989586621684871369"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621684871370"><a href="#local-6989586621684871370"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684871368"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-&gt;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684871369"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684871370"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-keyword">type</span><span> </span><a name="WeightedEdgeList"><a href="BlockLayout.html#WeightedEdgeList"><span class="hs-identifier">WeightedEdgeList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-type">WeightedEdge</span></a><span class="hs-special">]</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span class="hs-identifier">noDups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-258"></a><a name="noDups"><a href="BlockLayout.html#noDups"><span class="hs-identifier">noDups</span></a></a><span> </span><a name="local-6989586621684871397"><a href="#local-6989586621684871397"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871398"><a href="#local-6989586621684871398"><span class="hs-identifier">chainBlocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="BlockLayout.html#chainToBlocks"><span class="hs-identifier hs-var">chainToBlocks</span></a><span> </span><a href="#local-6989586621684871397"><span class="hs-identifier hs-var">chains</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684871399"><a href="#local-6989586621684871399"><span class="hs-identifier">_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871400"><a href="#local-6989586621684871400"><span class="hs-identifier">dups</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">removeDups</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621684871398"><span class="hs-identifier hs-var">chainBlocks</span></a><span>
</span><a name="line-261"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684871400"><span class="hs-identifier hs-var">dups</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-262"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pprTrace</span><span> </span><span class="hs-string">&quot;Duplicates:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621684871400"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;chains&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684871397"><span class="hs-identifier hs-var">chains</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-identifier">inFront</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-265"></a><a name="inFront"><a href="BlockLayout.html#inFront"><span class="hs-identifier">inFront</span></a></a><span> </span><a name="local-6989586621684871401"><a href="#local-6989586621684871401"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684871402"><a href="#local-6989586621684871402"><span class="hs-identifier">seq</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#seqFront"><span class="hs-identifier hs-var">seqFront</span></a><span> </span><a href="#local-6989586621684871402"><span class="hs-identifier hs-var">seq</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871401"><span class="hs-identifier hs-var">bid</span></a><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span class="hs-identifier">chainMember</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-269"></a><a name="chainMember"><a href="BlockLayout.html#chainMember"><span class="hs-identifier">chainMember</span></a></a><span> </span><a name="local-6989586621684871403"><a href="#local-6989586621684871403"><span class="hs-identifier">bid</span></a></a><span> </span><a name="local-6989586621684871404"><a href="#local-6989586621684871404"><span class="hs-identifier">chain</span></a></a><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><a href="#local-6989586621684871403"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">chainMembers</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871404"><span class="hs-identifier hs-var">chain</span></a><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-identifier">chainSingleton</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-273"></a><a name="chainSingleton"><a href="BlockLayout.html#chainSingleton"><span class="hs-identifier">chainSingleton</span></a></a><span> </span><a name="local-6989586621684871405"><a href="#local-6989586621684871405"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setSingleton"><span class="hs-identifier hs-var">setSingleton</span></a><span> </span><a href="#local-6989586621684871405"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a href="#local-6989586621684871405"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-identifier">chainSnoc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-277"></a><a name="chainSnoc"><a href="BlockLayout.html#chainSnoc"><span class="hs-identifier">chainSnoc</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871406"><a href="#local-6989586621684871406"><span class="hs-identifier">lbls</span></a></a><span> </span><a name="local-6989586621684871407"><a href="#local-6989586621684871407"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871408"><a href="#local-6989586621684871408"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-278"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setInsert"><span class="hs-identifier hs-var">setInsert</span></a><span> </span><a href="#local-6989586621684871408"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684871406"><span class="hs-identifier hs-var">lbls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#seqSnoc"><span class="hs-identifier hs-var">seqSnoc</span></a><span> </span><a href="#local-6989586621684871407"><span class="hs-identifier hs-var">blks</span></a><span> </span><a href="#local-6989586621684871408"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-identifier">chainConcat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-281"></a><a name="chainConcat"><a href="BlockLayout.html#chainConcat"><span class="hs-identifier">chainConcat</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871409"><a href="#local-6989586621684871409"><span class="hs-identifier">lbls1</span></a></a><span> </span><a name="local-6989586621684871410"><a href="#local-6989586621684871410"><span class="hs-identifier">blks1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871411"><a href="#local-6989586621684871411"><span class="hs-identifier">lbls2</span></a></a><span> </span><a name="local-6989586621684871412"><a href="#local-6989586621684871412"><span class="hs-identifier">blks2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setUnion"><span class="hs-identifier hs-var">setUnion</span></a><span> </span><a href="#local-6989586621684871409"><span class="hs-identifier hs-var">lbls1</span></a><span> </span><a href="#local-6989586621684871411"><span class="hs-identifier hs-var">lbls2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871410"><span class="hs-identifier hs-var">blks1</span></a><span> </span><span class="hs-special">`</span><a href="BlockLayout.html#seqConcat"><span class="hs-identifier hs-var">seqConcat</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871412"><span class="hs-identifier hs-var">blks2</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">chainToBlocks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-285"></a><a name="chainToBlocks"><a href="BlockLayout.html#chainToBlocks"><span class="hs-identifier">chainToBlocks</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684871413"><a href="#local-6989586621684871413"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#seqToList"><span class="hs-identifier hs-var">seqToList</span></a><span> </span><a href="#local-6989586621684871413"><span class="hs-identifier hs-var">blks</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- | Given the Chain A -&gt; B -&gt; C -&gt; D and we break at C</span><span>
</span><a name="line-288"></a><span class="hs-comment">--   we get the two Chains (A -&gt; B, C -&gt; D) as result.</span><span>
</span><a name="line-289"></a><span class="hs-identifier">breakChainAt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-290"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">,</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><a name="breakChainAt"><a href="BlockLayout.html#breakChainAt"><span class="hs-identifier">breakChainAt</span></a></a><span> </span><a name="local-6989586621684871414"><a href="#local-6989586621684871414"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><a name="local-6989586621684871415"><a href="#local-6989586621684871415"><span class="hs-identifier">lbls</span></a></a><span> </span><a name="local-6989586621684871416"><a href="#local-6989586621684871416"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><a href="#local-6989586621684871414"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621684871415"><span class="hs-identifier hs-var">lbls</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Block not in chain&quot;</span><span>
</span><a name="line-294"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-295"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871417"><a href="#local-6989586621684871417"><span class="hs-identifier">lblks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871418"><a href="#local-6989586621684871418"><span class="hs-identifier">rblks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871419"><a href="#local-6989586621684871419"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684871419"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871414"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>                                 </span><span class="hs-special">(</span><a href="BlockLayout.html#seqToList"><span class="hs-identifier hs-var">seqToList</span></a><span> </span><a href="#local-6989586621684871416"><span class="hs-identifier hs-var">blks</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>          </span><span class="hs-comment">--TODO: Remove old</span><span>
</span><a name="line-298"></a><span>          </span><span class="hs-comment">--lblSet :: [GenBasicBlock i] -&gt; BlockChain</span><span>
</span><a name="line-299"></a><span>          </span><span class="hs-comment">--lblSet blks =</span><span>
</span><a name="line-300"></a><span>          </span><span class="hs-comment">--  setFromList</span><span>
</span><a name="line-301"></a><span>                </span><span class="hs-comment">--(map (\(BasicBlock lbl _) -&gt; lbl) $ toList blks)</span><span>
</span><a name="line-302"></a><span>      </span><span class="hs-keyword">in</span><span>
</span><a name="line-303"></a><span>      </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><a href="#local-6989586621684871417"><span class="hs-identifier hs-var">lblks</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#seqFromBids"><span class="hs-identifier hs-var">seqFromBids</span></a><span> </span><a href="#local-6989586621684871417"><span class="hs-identifier hs-var">lblks</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-304"></a><span>       </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><a href="#local-6989586621684871418"><span class="hs-identifier hs-var">rblks</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#seqFromBids"><span class="hs-identifier hs-var">seqFromBids</span></a><span> </span><a href="#local-6989586621684871418"><span class="hs-identifier hs-var">rblks</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-identifier">takeR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-307"></a><a name="takeR"><a href="BlockLayout.html#takeR"><span class="hs-identifier">takeR</span></a></a><span> </span><a name="local-6989586621684871420"><a href="#local-6989586621684871420"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684871421"><a href="#local-6989586621684871421"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621684871420"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="BlockLayout.html#seqToRList"><span class="hs-identifier hs-var">seqToRList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871421"><span class="hs-identifier hs-var">blks</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">takeL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-312"></a><a name="takeL"><a href="BlockLayout.html#takeL"><span class="hs-identifier">takeL</span></a></a><span> </span><a name="local-6989586621684871422"><a href="#local-6989586621684871422"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-var">BlockChain</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684871423"><a href="#local-6989586621684871423"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--error &quot;TODO: takeLn&quot;</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621684871422"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="BlockLayout.html#seqToList"><span class="hs-identifier hs-var">seqToList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871423"><span class="hs-identifier hs-var">blks</span></a><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">-- | For a given list of chains try to fuse chains with strong</span><span>
</span><a name="line-316"></a><span class="hs-comment">--   edges between them into a single chain.</span><span>
</span><a name="line-317"></a><span class="hs-comment">--   Returns the list of fused chains together with a set of</span><span>
</span><a name="line-318"></a><span class="hs-comment">--   used edges. The set of edges is indirectly encoded in the</span><span>
</span><a name="line-319"></a><span class="hs-comment">--   chains so doesn't need to be considered for later passes.</span><span>
</span><a name="line-320"></a><span class="hs-identifier">fuseChains</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#WeightedEdgeList"><span class="hs-identifier hs-type">WeightedEdgeList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-321"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-type">WeightedEdge</span></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><a name="fuseChains"><a href="BlockLayout.html#fuseChains"><span class="hs-identifier">fuseChains</span></a></a><span> </span><a name="local-6989586621684871424"><a href="#local-6989586621684871424"><span class="hs-identifier">weights</span></a></a><span> </span><a name="local-6989586621684871425"><a href="#local-6989586621684871425"><span class="hs-identifier">chains</span></a></a><span>
</span><a name="line-323"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871445"><a href="#local-6989586621684871445"><span class="hs-identifier">fronts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-324"></a><span>                    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871448"><a href="#local-6989586621684871448"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="BlockLayout.html#takeL"><span class="hs-identifier hs-var">takeL</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621684871448"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">,</span><a href="#local-6989586621684871448"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-325"></a><span>                    </span><a href="Hoopl.Collections.html#mapElems"><span class="hs-identifier hs-var">mapElems</span></a><span> </span><a href="#local-6989586621684871425"><span class="hs-identifier hs-var">chains</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-326"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684871446"><a href="#local-6989586621684871446"><span class="hs-identifier">chains'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871447"><a href="#local-6989586621684871447"><span class="hs-identifier">used</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871426"><span class="hs-identifier hs-var">applyEdges</span></a><span> </span><a href="#local-6989586621684871424"><span class="hs-identifier hs-var">weights</span></a><span> </span><a href="#local-6989586621684871425"><span class="hs-identifier hs-var">chains</span></a><span> </span><a href="#local-6989586621684871445"><span class="hs-identifier hs-var">fronts</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-327"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871446"><span class="hs-identifier hs-var">chains'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871447"><span class="hs-identifier hs-var">used</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-329"></a><span>        </span><span class="hs-identifier">applyEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#WeightedEdgeList"><span class="hs-identifier hs-type">WeightedEdgeList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-330"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-type">WeightedEdge</span></a><span>
</span><a name="line-331"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-type">WeightedEdge</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>        </span><a name="local-6989586621684871426"><a href="#local-6989586621684871426"><span class="hs-identifier">applyEdges</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684871427"><a href="#local-6989586621684871427"><span class="hs-identifier">chainsEnd</span></a></a><span> </span><a name="local-6989586621684871428"><a href="#local-6989586621684871428"><span class="hs-identifier">chainsFront</span></a></a><span> </span><a name="local-6989586621684871429"><a href="#local-6989586621684871429"><span class="hs-identifier">used</span></a></a><span>
</span><a name="line-333"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871427"><span class="hs-identifier hs-var">chainsEnd</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871429"><span class="hs-identifier hs-var">used</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871428"><span class="hs-identifier hs-var">chainsFront</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-identifier">applyEdges</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871430"><a href="#local-6989586621684871430"><span class="hs-identifier">edge</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-var">WeightedEdge</span></a><span> </span><a name="local-6989586621684871431"><a href="#local-6989586621684871431"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621684871432"><a href="#local-6989586621684871432"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621684871433"><a href="#local-6989586621684871433"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684871434"><a href="#local-6989586621684871434"><span class="hs-identifier">edges</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871435"><a href="#local-6989586621684871435"><span class="hs-identifier">chainsEnd</span></a></a><span> </span><a name="local-6989586621684871436"><a href="#local-6989586621684871436"><span class="hs-identifier">chainsFront</span></a></a><span> </span><a name="local-6989586621684871437"><a href="#local-6989586621684871437"><span class="hs-identifier">used</span></a></a><span>
</span><a name="line-335"></a><span>            </span><span class="hs-comment">--Since we order edges descending by weight we can stop here</span><span>
</span><a name="line-336"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684871433"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="BlockLayout.html#fuseEdgeThreshold"><span class="hs-identifier hs-var">fuseEdgeThreshold</span></a><span>
</span><a name="line-337"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684871435"><span class="hs-identifier hs-var">chainsEnd</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871437"><span class="hs-identifier hs-var">used</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871436"><span class="hs-identifier hs-var">chainsFront</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>            </span><span class="hs-comment">--Fuse the two chains</span><span>
</span><a name="line-339"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684871438"><a href="#local-6989586621684871438"><span class="hs-identifier">c1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684871431"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621684871435"><span class="hs-identifier hs-var">chainsEnd</span></a><span>
</span><a name="line-340"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684871439"><a href="#local-6989586621684871439"><span class="hs-identifier">c2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684871432"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621684871436"><span class="hs-identifier hs-var">chainsFront</span></a><span>
</span><a name="line-341"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871438"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621684871439"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-342"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871440"><a href="#local-6989586621684871440"><span class="hs-identifier">newChain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#chainConcat"><span class="hs-identifier hs-var">chainConcat</span></a><span> </span><a href="#local-6989586621684871438"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621684871439"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-343"></a><span>                  </span><a name="local-6989586621684871441"><a href="#local-6989586621684871441"><span class="hs-identifier">front</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="BlockLayout.html#takeL"><span class="hs-identifier hs-var">takeL</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621684871440"><span class="hs-identifier hs-var">newChain</span></a><span>
</span><a name="line-344"></a><span>                  </span><a name="local-6989586621684871442"><a href="#local-6989586621684871442"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="BlockLayout.html#takeR"><span class="hs-identifier hs-var">takeR</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621684871440"><span class="hs-identifier hs-var">newChain</span></a><span>
</span><a name="line-345"></a><span>                  </span><a name="local-6989586621684871443"><a href="#local-6989586621684871443"><span class="hs-identifier">chainsFront'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871441"><span class="hs-identifier hs-var">front</span></a><span> </span><a href="#local-6989586621684871440"><span class="hs-identifier hs-var">newChain</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-346"></a><span>                                 </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621684871432"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621684871436"><span class="hs-identifier hs-var">chainsFront</span></a><span>
</span><a name="line-347"></a><span>                  </span><a name="local-6989586621684871444"><a href="#local-6989586621684871444"><span class="hs-identifier">chainsEnd'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871442"><span class="hs-identifier hs-var">end</span></a><span> </span><a href="#local-6989586621684871440"><span class="hs-identifier hs-var">newChain</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-348"></a><span>                                 </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621684871431"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621684871435"><span class="hs-identifier hs-var">chainsEnd</span></a><span>
</span><a name="line-349"></a><span>              </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621684871426"><span class="hs-identifier hs-var">applyEdges</span></a><span> </span><a href="#local-6989586621684871434"><span class="hs-identifier hs-var">edges</span></a><span> </span><a href="#local-6989586621684871444"><span class="hs-identifier hs-var">chainsEnd'</span></a><span> </span><a href="#local-6989586621684871443"><span class="hs-identifier hs-var">chainsFront'</span></a><span>
</span><a name="line-350"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.insert</span><span> </span><a href="#local-6989586621684871430"><span class="hs-identifier hs-var">edge</span></a><span> </span><a href="#local-6989586621684871437"><span class="hs-identifier hs-var">used</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-352"></a><span>            </span><span class="hs-comment">--Check next edge</span><span>
</span><a name="line-353"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871426"><span class="hs-identifier hs-var">applyEdges</span></a><span> </span><a href="#local-6989586621684871434"><span class="hs-identifier hs-var">edges</span></a><span> </span><a href="#local-6989586621684871435"><span class="hs-identifier hs-var">chainsEnd</span></a><span> </span><a href="#local-6989586621684871436"><span class="hs-identifier hs-var">chainsFront</span></a><span> </span><a href="#local-6989586621684871437"><span class="hs-identifier hs-var">used</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-comment">-- See also Note [Chain based CFG serialization]</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- We have the chains (A-B-C-D) and (E-F) and an Edge C-&gt;E.</span><span>
</span><a name="line-358"></a><span class="hs-comment">--</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- While placing the later after the former doesn't result in sequential</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- control flow it is still be benefical since block C and E might end</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- up in the same cache line.</span><span>
</span><a name="line-362"></a><span class="hs-comment">--</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- So we place these chains next to each other even if we can't fuse them.</span><span>
</span><a name="line-364"></a><span class="hs-comment">--</span><span>
</span><a name="line-365"></a><span class="hs-comment">--   A -&gt; B -&gt; C -&gt; D</span><span>
</span><a name="line-366"></a><span class="hs-comment">--             v</span><span>
</span><a name="line-367"></a><span class="hs-comment">--             - -&gt; E -&gt; F ...</span><span>
</span><a name="line-368"></a><span class="hs-comment">--</span><span>
</span><a name="line-369"></a><span class="hs-comment">-- Simple heuristic to chose which chains we want to combine:</span><span>
</span><a name="line-370"></a><span class="hs-comment">--   * Process edges in descending priority.</span><span>
</span><a name="line-371"></a><span class="hs-comment">--   * Check if there is a edge near the end of one chain which goes</span><span>
</span><a name="line-372"></a><span class="hs-comment">--     to a block near the start of another edge.</span><span>
</span><a name="line-373"></a><span class="hs-comment">--</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- While we could take into account the space between the two blocks which</span><span>
</span><a name="line-375"></a><span class="hs-comment">-- share an edge this blows up compile times quite a bit. It requires</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- us to find all edges between two chains, check the distance for all edges,</span><span>
</span><a name="line-377"></a><span class="hs-comment">-- rank them based on the distance and and only then we can select two chains</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- to combine. Which would add a lot of complexity for little gain.</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-comment">-- | For a given list of chains and edges try to combine chains with strong</span><span>
</span><a name="line-381"></a><span class="hs-comment">--   edges between them.</span><span>
</span><a name="line-382"></a><span class="hs-identifier">combineNeighbourhood</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#WeightedEdgeList"><span class="hs-identifier hs-type">WeightedEdgeList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">]</span><span>
</span><a name="line-383"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">]</span><span>
</span><a name="line-384"></a><a name="combineNeighbourhood"><a href="BlockLayout.html#combineNeighbourhood"><span class="hs-identifier">combineNeighbourhood</span></a></a><span> </span><a name="local-6989586621684871449"><a href="#local-6989586621684871449"><span class="hs-identifier">edges</span></a></a><span> </span><a name="local-6989586621684871450"><a href="#local-6989586621684871450"><span class="hs-identifier">chains</span></a></a><span>
</span><a name="line-385"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTraceIt &quot;Neigbours&quot; $</span><span>
</span><a name="line-386"></a><span>      </span><a href="#local-6989586621684871453"><span class="hs-identifier hs-var">applyEdges</span></a><span> </span><a href="#local-6989586621684871449"><span class="hs-identifier hs-var">edges</span></a><span> </span><a href="#local-6989586621684871451"><span class="hs-identifier hs-var">endFrontier</span></a><span> </span><a href="#local-6989586621684871452"><span class="hs-identifier hs-var">startFrontier</span></a><span>
</span><a name="line-387"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-388"></a><span>        </span><span class="hs-comment">--Build maps from chain ends to chains</span><span>
</span><a name="line-389"></a><span>        </span><span class="hs-identifier">endFrontier</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">startFrontier</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#FrontierMap"><span class="hs-identifier hs-type">FrontierMap</span></a><span>
</span><a name="line-390"></a><span>        </span><a name="local-6989586621684871451"><a href="#local-6989586621684871451"><span class="hs-identifier">endFrontier</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-391"></a><span>            </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871456"><a href="#local-6989586621684871456"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-392"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871457"><a href="#local-6989586621684871457"><span class="hs-identifier">ends</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871455"><span class="hs-identifier hs-var">getEnds</span></a><span> </span><a href="#local-6989586621684871456"><span class="hs-identifier hs-var">chain</span></a><span>
</span><a name="line-393"></a><span>                                    </span><a name="local-6989586621684871458"><a href="#local-6989586621684871458"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871457"><span class="hs-identifier hs-var">ends</span></a><span class="hs-special">,</span><a href="#local-6989586621684871456"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>                                </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871459"><a href="#local-6989586621684871459"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871459"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621684871458"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871457"><span class="hs-identifier hs-var">ends</span></a><span> </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871450"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-395"></a><span>        </span><a name="local-6989586621684871452"><a href="#local-6989586621684871452"><span class="hs-identifier">startFrontier</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-396"></a><span>            </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871460"><a href="#local-6989586621684871460"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-397"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871461"><a href="#local-6989586621684871461"><span class="hs-identifier">front</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871454"><span class="hs-identifier hs-var">getFronts</span></a><span> </span><a href="#local-6989586621684871460"><span class="hs-identifier hs-var">chain</span></a><span>
</span><a name="line-398"></a><span>                                    </span><a name="local-6989586621684871462"><a href="#local-6989586621684871462"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871461"><span class="hs-identifier hs-var">front</span></a><span class="hs-special">,</span><a href="#local-6989586621684871460"><span class="hs-identifier hs-var">chain</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>                                </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871463"><a href="#local-6989586621684871463"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871463"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621684871462"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871461"><span class="hs-identifier hs-var">front</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871450"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-400"></a><span>        </span><span class="hs-identifier">applyEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#WeightedEdgeList"><span class="hs-identifier hs-type">WeightedEdgeList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#FrontierMap"><span class="hs-identifier hs-type">FrontierMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#FrontierMap"><span class="hs-identifier hs-type">FrontierMap</span></a><span>
</span><a name="line-401"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">]</span><span>
</span><a name="line-402"></a><span>        </span><a name="local-6989586621684871453"><a href="#local-6989586621684871453"><span class="hs-identifier">applyEdges</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684871464"><a href="#local-6989586621684871464"><span class="hs-identifier">chainEnds</span></a></a><span> </span><a name="local-6989586621684871465"><a href="#local-6989586621684871465"><span class="hs-identifier">_chainFronts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-403"></a><span>            </span><span class="hs-identifier hs-var">ordNub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapElems"><span class="hs-identifier hs-var">mapElems</span></a><span> </span><a href="#local-6989586621684871464"><span class="hs-identifier hs-var">chainEnds</span></a><span>
</span><a name="line-404"></a><span>        </span><span class="hs-identifier">applyEdges</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-var">WeightedEdge</span></a><span> </span><a name="local-6989586621684871466"><a href="#local-6989586621684871466"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621684871467"><a href="#local-6989586621684871467"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621684871468"><a href="#local-6989586621684871468"><span class="hs-identifier">_w</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684871469"><a href="#local-6989586621684871469"><span class="hs-identifier">edges</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871470"><a href="#local-6989586621684871470"><span class="hs-identifier">chainEnds</span></a></a><span> </span><a name="local-6989586621684871471"><a href="#local-6989586621684871471"><span class="hs-identifier">chainFronts</span></a></a><span>
</span><a name="line-405"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871472"><a href="#local-6989586621684871472"><span class="hs-identifier">c1_e</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871473"><a href="#local-6989586621684871473"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684871466"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621684871470"><span class="hs-identifier hs-var">chainEnds</span></a><span>
</span><a name="line-406"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871474"><a href="#local-6989586621684871474"><span class="hs-identifier">c2_f</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871475"><a href="#local-6989586621684871475"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684871467"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621684871471"><span class="hs-identifier hs-var">chainFronts</span></a><span>
</span><a name="line-407"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871473"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621684871475"><span class="hs-identifier hs-var">c2</span></a><span> </span><span class="hs-comment">-- Avoid trying to concat a short chain with itself.</span><span>
</span><a name="line-408"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871476"><a href="#local-6989586621684871476"><span class="hs-identifier">newChain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#chainConcat"><span class="hs-identifier hs-var">chainConcat</span></a><span> </span><a href="#local-6989586621684871473"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621684871475"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-409"></a><span>                  </span><a name="local-6989586621684871477"><a href="#local-6989586621684871477"><span class="hs-identifier">newChainFrontier</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871454"><span class="hs-identifier hs-var">getFronts</span></a><span> </span><a href="#local-6989586621684871476"><span class="hs-identifier hs-var">newChain</span></a><span>
</span><a name="line-410"></a><span>                  </span><a name="local-6989586621684871478"><a href="#local-6989586621684871478"><span class="hs-identifier">newChainEnds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871455"><span class="hs-identifier hs-var">getEnds</span></a><span> </span><a href="#local-6989586621684871476"><span class="hs-identifier hs-var">newChain</span></a><span>
</span><a name="line-411"></a><span>                  </span><span class="hs-identifier">newFronts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#FrontierMap"><span class="hs-identifier hs-type">FrontierMap</span></a><span>
</span><a name="line-412"></a><span>                  </span><a name="local-6989586621684871479"><a href="#local-6989586621684871479"><span class="hs-identifier">newFronts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-413"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871481"><a href="#local-6989586621684871481"><span class="hs-identifier">withoutOld</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-414"></a><span>                            </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871483"><a href="#local-6989586621684871483"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684871484"><a href="#local-6989586621684871484"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621684871484"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684871483"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#FrontierMap"><span class="hs-identifier hs-type">FrontierMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871471"><span class="hs-identifier hs-var">chainFronts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871474"><span class="hs-identifier hs-var">c2_f</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684871454"><span class="hs-identifier hs-var">getFronts</span></a><span> </span><a href="#local-6989586621684871473"><span class="hs-identifier hs-var">c1</span></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>                        </span><a name="local-6989586621684871482"><a href="#local-6989586621684871482"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-416"></a><span>                            </span><span class="hs-special">(</span><a href="#local-6989586621684871477"><span class="hs-identifier hs-var">newChainFrontier</span></a><span class="hs-special">,</span><a href="#local-6989586621684871476"><span class="hs-identifier hs-var">newChain</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">--let bound to ensure sharing</span><span>
</span><a name="line-417"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871485"><a href="#local-6989586621684871485"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684871486"><a href="#local-6989586621684871486"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871486"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684871482"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621684871485"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>                              </span><a href="#local-6989586621684871481"><span class="hs-identifier hs-var">withoutOld</span></a><span> </span><a href="#local-6989586621684871477"><span class="hs-identifier hs-var">newChainFrontier</span></a><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span>                  </span><a name="local-6989586621684871480"><a href="#local-6989586621684871480"><span class="hs-identifier">newEnds</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-421"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871487"><a href="#local-6989586621684871487"><span class="hs-identifier">withoutOld</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871489"><a href="#local-6989586621684871489"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684871490"><a href="#local-6989586621684871490"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621684871490"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684871489"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871470"><span class="hs-identifier hs-var">chainEnds</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871472"><span class="hs-identifier hs-var">c1_e</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684871455"><span class="hs-identifier hs-var">getEnds</span></a><span> </span><a href="#local-6989586621684871475"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span>
</span><a name="line-422"></a><span>                        </span><a name="local-6989586621684871488"><a href="#local-6989586621684871488"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871478"><span class="hs-identifier hs-var">newChainEnds</span></a><span class="hs-special">,</span><a href="#local-6989586621684871476"><span class="hs-identifier hs-var">newChain</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">--let bound to ensure sharing</span><span>
</span><a name="line-423"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871491"><a href="#local-6989586621684871491"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684871492"><a href="#local-6989586621684871492"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871492"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684871488"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621684871491"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                              </span><a href="#local-6989586621684871487"><span class="hs-identifier hs-var">withoutOld</span></a><span> </span><a href="#local-6989586621684871478"><span class="hs-identifier hs-var">newChainEnds</span></a><span>
</span><a name="line-425"></a><span>              </span><span class="hs-keyword">in</span><span>
</span><a name="line-426"></a><span>                </span><span class="hs-comment">-- pprTrace &quot;ApplyEdges&quot;</span><span>
</span><a name="line-427"></a><span>                </span><span class="hs-comment">--  (text &quot;before&quot; $$</span><span>
</span><a name="line-428"></a><span>                </span><span class="hs-comment">--   text &quot;fronts&quot; &lt;+&gt; ppr chainFronts $$</span><span>
</span><a name="line-429"></a><span>                </span><span class="hs-comment">--   text &quot;ends&quot; &lt;+&gt; ppr chainEnds $$</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>                </span><span class="hs-comment">--   text &quot;various&quot; $$</span><span>
</span><a name="line-432"></a><span>                </span><span class="hs-comment">--   text &quot;newChain&quot; &lt;+&gt; ppr newChain $$</span><span>
</span><a name="line-433"></a><span>                </span><span class="hs-comment">--   text &quot;newChainFrontier&quot; &lt;+&gt; ppr newChainFrontier $$</span><span>
</span><a name="line-434"></a><span>                </span><span class="hs-comment">--   text &quot;newChainEnds&quot; &lt;+&gt; ppr newChainEnds $$</span><span>
</span><a name="line-435"></a><span>                </span><span class="hs-comment">--   text &quot;drop&quot; &lt;+&gt; ppr ((c2_f ++ getFronts c1) ++ (c1_e ++ getEnds c2)) $$</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>                </span><span class="hs-comment">--   text &quot;after&quot; $$</span><span>
</span><a name="line-438"></a><span>                </span><span class="hs-comment">--   text &quot;fronts&quot; &lt;+&gt; ppr newFronts $$</span><span>
</span><a name="line-439"></a><span>                </span><span class="hs-comment">--   text &quot;ends&quot; &lt;+&gt; ppr newEnds</span><span>
</span><a name="line-440"></a><span>                </span><span class="hs-comment">--   )</span><span>
</span><a name="line-441"></a><span>                 </span><a href="#local-6989586621684871453"><span class="hs-identifier hs-var">applyEdges</span></a><span> </span><a href="#local-6989586621684871469"><span class="hs-identifier hs-var">edges</span></a><span> </span><a href="#local-6989586621684871480"><span class="hs-identifier hs-var">newEnds</span></a><span> </span><a href="#local-6989586621684871479"><span class="hs-identifier hs-var">newFronts</span></a><span>
</span><a name="line-442"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-443"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--pprTrace &quot;noNeigbours&quot; (ppr ()) $</span><span>
</span><a name="line-444"></a><span>              </span><a href="#local-6989586621684871453"><span class="hs-identifier hs-var">applyEdges</span></a><span> </span><a href="#local-6989586621684871469"><span class="hs-identifier hs-var">edges</span></a><span> </span><a href="#local-6989586621684871470"><span class="hs-identifier hs-var">chainEnds</span></a><span> </span><a href="#local-6989586621684871471"><span class="hs-identifier hs-var">chainFronts</span></a><span>
</span><a name="line-445"></a><span>         </span><span class="hs-keyword">where</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span>        </span><a name="local-6989586621684871454"><a href="#local-6989586621684871454"><span class="hs-identifier">getFronts</span></a></a><span> </span><a name="local-6989586621684871493"><a href="#local-6989586621684871493"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#takeL"><span class="hs-identifier hs-var">takeL</span></a><span> </span><a href="BlockLayout.html#neighbourOverlapp"><span class="hs-identifier hs-var">neighbourOverlapp</span></a><span> </span><a href="#local-6989586621684871493"><span class="hs-identifier hs-var">chain</span></a><span>
</span><a name="line-448"></a><span>        </span><a name="local-6989586621684871455"><a href="#local-6989586621684871455"><span class="hs-identifier">getEnds</span></a></a><span> </span><a name="local-6989586621684871494"><a href="#local-6989586621684871494"><span class="hs-identifier">chain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#takeR"><span class="hs-identifier hs-var">takeR</span></a><span> </span><a href="BlockLayout.html#neighbourOverlapp"><span class="hs-identifier hs-var">neighbourOverlapp</span></a><span> </span><a href="#local-6989586621684871494"><span class="hs-identifier hs-var">chain</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-comment">-- See [Chain based CFG serialization]</span><span>
</span><a name="line-453"></a><span class="hs-identifier">buildChains</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-454"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>  </span><span class="hs-comment">-- Resulting chains.</span><span>
</span><a name="line-455"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">--List of fused edges.</span><span>
</span><a name="line-456"></a><a name="buildChains"><a href="BlockLayout.html#buildChains"><span class="hs-identifier">buildChains</span></a></a><span> </span><a name="local-6989586621684871495"><a href="#local-6989586621684871495"><span class="hs-identifier">succWeights</span></a></a><span> </span><a name="local-6989586621684871496"><a href="#local-6989586621684871496"><span class="hs-identifier">blocks</span></a></a><span>
</span><a name="line-457"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684871524"><a href="#local-6989586621684871524"><span class="hs-identifier">fusedEdges</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871525"><a href="#local-6989586621684871525"><span class="hs-identifier">chains</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871497"><span class="hs-identifier hs-var">buildNext</span></a><span> </span><a href="Hoopl.Collections.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621684871496"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span>
</span><a name="line-458"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871525"><span class="hs-identifier hs-var">chains</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871524"><span class="hs-identifier hs-var">fusedEdges</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-460"></a><span>    </span><span class="hs-comment">-- We keep a map from the last block in a chain to the chain itself.</span><span>
</span><a name="line-461"></a><span>    </span><span class="hs-comment">-- This we we can easily check if an block should be appened to an</span><span>
</span><a name="line-462"></a><span>    </span><span class="hs-comment">-- existing chain!</span><span>
</span><a name="line-463"></a><span>    </span><span class="hs-identifier">buildNext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-464"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span> </span><span class="hs-comment">-- Map from last element to chain.</span><span>
</span><a name="line-465"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Blocks to place</span><span>
</span><a name="line-466"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span>
</span><a name="line-467"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Placed Blocks</span><span>
</span><a name="line-468"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">--List of fused edges</span><span>
</span><a name="line-469"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span>
</span><a name="line-470"></a><span>                 </span><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621684871497"><a href="#local-6989586621684871497"><span class="hs-identifier">buildNext</span></a></a><span> </span><a name="local-6989586621684871499"><a href="#local-6989586621684871499"><span class="hs-identifier">_placed</span></a></a><span> </span><a name="local-6989586621684871500"><a href="#local-6989586621684871500"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684871501"><a href="#local-6989586621684871501"><span class="hs-identifier">linked</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-472"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871501"><span class="hs-identifier hs-var">linked</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871500"><span class="hs-identifier hs-var">chains</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>    </span><span class="hs-identifier">buildNext</span><span> </span><a name="local-6989586621684871502"><a href="#local-6989586621684871502"><span class="hs-identifier">placed</span></a></a><span> </span><a name="local-6989586621684871503"><a href="#local-6989586621684871503"><span class="hs-identifier">chains</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684871504"><a href="#local-6989586621684871504"><span class="hs-identifier">block</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871505"><a href="#local-6989586621684871505"><span class="hs-identifier">todo</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871506"><a href="#local-6989586621684871506"><span class="hs-identifier">linked</span></a></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><a href="#local-6989586621684871504"><span class="hs-identifier hs-var">block</span></a><span> </span><a href="#local-6989586621684871502"><span class="hs-identifier hs-var">placed</span></a><span>
</span><a name="line-475"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871497"><span class="hs-identifier hs-var">buildNext</span></a><span> </span><a href="#local-6989586621684871502"><span class="hs-identifier hs-var">placed</span></a><span> </span><a href="#local-6989586621684871503"><span class="hs-identifier hs-var">chains</span></a><span> </span><a href="#local-6989586621684871505"><span class="hs-identifier hs-var">todo</span></a><span> </span><a href="#local-6989586621684871506"><span class="hs-identifier hs-var">linked</span></a><span>
</span><a name="line-476"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-477"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871497"><span class="hs-identifier hs-var">buildNext</span></a><span> </span><a href="#local-6989586621684871507"><span class="hs-identifier hs-var">placed'</span></a><span> </span><a href="#local-6989586621684871510"><span class="hs-identifier hs-var">chains'</span></a><span> </span><a href="#local-6989586621684871505"><span class="hs-identifier hs-var">todo</span></a><span> </span><a href="#local-6989586621684871508"><span class="hs-identifier hs-var">linked'</span></a><span>
</span><a name="line-478"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-479"></a><span>        </span><a name="local-6989586621684871507"><a href="#local-6989586621684871507"><span class="hs-identifier">placed'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Hoopl.Collections.html#setInsert"><span class="hs-identifier hs-var">setInsert</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871502"><span class="hs-identifier hs-var">placed</span></a><span> </span><a href="#local-6989586621684871509"><span class="hs-identifier hs-var">placedBlocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>        </span><a name="local-6989586621684871508"><a href="#local-6989586621684871508"><span class="hs-identifier">linked'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.union</span><span> </span><a href="#local-6989586621684871506"><span class="hs-identifier hs-var">linked</span></a><span> </span><a href="#local-6989586621684871511"><span class="hs-identifier hs-var">linkedEdges</span></a><span>
</span><a name="line-481"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684871509"><a href="#local-6989586621684871509"><span class="hs-identifier">placedBlocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871510"><a href="#local-6989586621684871510"><span class="hs-identifier">chains'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871511"><a href="#local-6989586621684871511"><span class="hs-identifier">linkedEdges</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871512"><span class="hs-identifier hs-var">findChain</span></a><span> </span><a href="#local-6989586621684871504"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span>        </span><span class="hs-comment">--Add the block to a existing or new chain</span><span>
</span><a name="line-484"></a><span>        </span><span class="hs-comment">--Returns placed blocks, list of resulting chains</span><span>
</span><a name="line-485"></a><span>        </span><span class="hs-comment">--and fused edges</span><span>
</span><a name="line-486"></a><span>        </span><span class="hs-identifier">findChain</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-487"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>        </span><a name="local-6989586621684871512"><a href="#local-6989586621684871512"><span class="hs-identifier">findChain</span></a></a><span> </span><a name="local-6989586621684871513"><a href="#local-6989586621684871513"><span class="hs-identifier">block</span></a></a><span>
</span><a name="line-489"></a><span>        </span><span class="hs-comment">-- B) place block at end of existing chain if</span><span>
</span><a name="line-490"></a><span>        </span><span class="hs-comment">-- there is no better block to append.</span><span>
</span><a name="line-491"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871519"><a href="#local-6989586621684871519"><span class="hs-identifier">pred</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684871517"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-492"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871514"><span class="hs-identifier hs-var">alreadyPlaced</span></a><span> </span><a href="#local-6989586621684871519"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-493"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684871520"><a href="#local-6989586621684871520"><span class="hs-identifier">predChain</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684871519"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621684871503"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-494"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871521"><a href="#local-6989586621684871521"><span class="hs-identifier">best</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684871514"><span class="hs-identifier hs-var">alreadyPlaced</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871516"><span class="hs-identifier hs-var">getSuccs</span></a><span> </span><a href="#local-6989586621684871519"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-495"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871521"><span class="hs-identifier hs-var">best</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-496"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--pprTrace &quot;B.2)&quot; (ppr (pred,lbl)) $</span><span>
</span><a name="line-497"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871522"><a href="#local-6989586621684871522"><span class="hs-identifier">newChain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#chainSnoc"><span class="hs-identifier hs-var">chainSnoc</span></a><span> </span><a href="#local-6989586621684871520"><span class="hs-identifier hs-var">predChain</span></a><span> </span><a href="#local-6989586621684871513"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-498"></a><span>                </span><a name="local-6989586621684871523"><a href="#local-6989586621684871523"><span class="hs-identifier">chainMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684871522"><span class="hs-identifier hs-var">newChain</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621684871519"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621684871503"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-499"></a><span>            </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">]</span><span>
</span><a name="line-500"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871523"><span class="hs-identifier hs-var">chainMap</span></a><span>
</span><a name="line-501"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.singleton</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871519"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-504"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--pprTrace &quot;single&quot; (ppr lbl)</span><span>
</span><a name="line-505"></a><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">]</span><span>
</span><a name="line-506"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#chainSingleton"><span class="hs-identifier hs-var">chainSingleton</span></a><span> </span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871503"><span class="hs-identifier hs-var">chains</span></a><span>
</span><a name="line-507"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-509"></a><span>              </span><a name="local-6989586621684871514"><a href="#local-6989586621684871514"><span class="hs-identifier">alreadyPlaced</span></a></a><span> </span><a name="local-6989586621684871518"><a href="#local-6989586621684871518"><span class="hs-identifier">blkId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><a href="#local-6989586621684871518"><span class="hs-identifier hs-var">blkId</span></a><span> </span><a href="#local-6989586621684871502"><span class="hs-identifier hs-var">placed</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>              </span><a name="local-6989586621684871515"><a href="#local-6989586621684871515"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871513"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-511"></a><span>              </span><a name="local-6989586621684871516"><a href="#local-6989586621684871516"><span class="hs-identifier">getSuccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-var">getSuccEdgesSorted</span></a><span> </span><a href="#local-6989586621684871495"><span class="hs-identifier hs-var">succWeights</span></a><span>
</span><a name="line-512"></a><span>              </span><a name="local-6989586621684871517"><a href="#local-6989586621684871517"><span class="hs-identifier">preds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-var">getSuccEdgesSorted</span></a><span> </span><a href="#local-6989586621684871498"><span class="hs-identifier hs-var">predWeights</span></a><span> </span><a href="#local-6989586621684871515"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-513"></a><span>    </span><span class="hs-comment">--For efficiency we also create the map to look up predecessors here</span><span>
</span><a name="line-514"></a><span>    </span><a name="local-6989586621684871498"><a href="#local-6989586621684871498"><span class="hs-identifier">predWeights</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#reverseEdges"><span class="hs-identifier hs-var">reverseEdges</span></a><span> </span><a href="#local-6989586621684871495"><span class="hs-identifier hs-var">succWeights</span></a><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-comment">-- We make the CFG a Hoopl Graph, so we can reuse revPostOrder.</span><span>
</span><a name="line-519"></a><span class="hs-keyword">newtype</span><span> </span><a name="BlockNode"><a href="BlockLayout.html#BlockNode"><span class="hs-identifier">BlockNode</span></a></a><span> </span><a name="local-6989586621684871364"><a href="#local-6989586621684871364"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684871365"><a href="#local-6989586621684871365"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BN"><a href="BlockLayout.html#BN"><span class="hs-identifier">BN</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span class="hs-keyword">instance</span><span> </span><a href="Hoopl.Graph.html#NonLocal"><span class="hs-identifier hs-type">NonLocal</span></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BlockNode"><span class="hs-identifier hs-type">BlockNode</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-521"></a><span>  </span><a name="local-8214565720324533399"><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier">entryLabel</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BN"><span class="hs-identifier hs-var">BN</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684871366"><a href="#local-6989586621684871366"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871366"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-522"></a><span>  </span><a name="local-8214565720324533400"><a href="Hoopl.Graph.html#successors"><span class="hs-identifier">successors</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BN"><span class="hs-identifier hs-var">BN</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684871367"><a href="#local-6989586621684871367"><span class="hs-identifier">succs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871367"><span class="hs-identifier hs-var">succs</span></a><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-identifier">fromNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockNode"><span class="hs-identifier hs-type">BlockNode</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-525"></a><a name="fromNode"><a href="BlockLayout.html#fromNode"><span class="hs-identifier">fromNode</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#BN"><span class="hs-identifier hs-var">BN</span></a><span> </span><a name="local-6989586621684871526"><a href="#local-6989586621684871526"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684871526"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-identifier">sequenceChain</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621684871395"><a href="#local-6989586621684871395"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621684871396"><a href="#local-6989586621684871396"><span class="hs-identifier">i</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684871396"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684871396"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684871395"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-528"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871396"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871396"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">]</span><span>
</span><a name="line-529"></a><a name="sequenceChain"><a href="BlockLayout.html#sequenceChain"><span class="hs-identifier">sequenceChain</span></a></a><span> </span><a name="local-6989586621684871527"><a href="#local-6989586621684871527"><span class="hs-identifier">_info</span></a></a><span> </span><a name="local-6989586621684871528"><a href="#local-6989586621684871528"><span class="hs-identifier">_weights</span></a></a><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-530"></a><span class="hs-identifier">sequenceChain</span><span> </span><a name="local-6989586621684871529"><a href="#local-6989586621684871529"><span class="hs-identifier">_info</span></a></a><span> </span><a name="local-6989586621684871530"><a href="#local-6989586621684871530"><span class="hs-identifier">_weights</span></a></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621684871531"><a href="#local-6989586621684871531"><span class="hs-identifier">x</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871531"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-531"></a><span class="hs-identifier">sequenceChain</span><span>  </span><a name="local-6989586621684871532"><a href="#local-6989586621684871532"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684871533"><a href="#local-6989586621684871533"><span class="hs-identifier">weights'</span></a></a><span>     </span><a name="local-6989586621684871534"><a href="#local-6989586621684871534"><span class="hs-identifier">blocks</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684871535"><a href="#local-6989586621684871535"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-532"></a><span>    </span><span class="hs-comment">--Optimization, delete edges of weight &lt;= 0.</span><span>
</span><a name="line-533"></a><span>    </span><span class="hs-comment">--This significantly improves performance whenever</span><span>
</span><a name="line-534"></a><span>    </span><span class="hs-comment">--we iterate over all edges, which is a few times!</span><span>
</span><a name="line-535"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">weights</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-536"></a><span>        </span><a name="local-6989586621684871536"><a href="#local-6989586621684871536"><span class="hs-identifier">weights</span></a></a><span>
</span><a name="line-537"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#filterEdges"><span class="hs-identifier hs-var">filterEdges</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871557"><a href="#local-6989586621684871557"><span class="hs-identifier">_f</span></a></a><span> </span><a name="local-6989586621684871558"><a href="#local-6989586621684871558"><span class="hs-identifier">_t</span></a></a><span> </span><a name="local-6989586621684871559"><a href="#local-6989586621684871559"><span class="hs-identifier">edgeInfo</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621684871559"><span class="hs-identifier hs-var">edgeInfo</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871533"><span class="hs-identifier hs-var">weights'</span></a><span>
</span><a name="line-538"></a><span>        </span><span class="hs-identifier">blockMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871396"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-539"></a><span>        </span><a name="local-6989586621684871537"><a href="#local-6989586621684871537"><span class="hs-identifier">blockMap</span></a></a><span>
</span><a name="line-540"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871560"><a href="#local-6989586621684871560"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684871561"><a href="#local-6989586621684871561"><span class="hs-identifier">blk</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684871562"><a href="#local-6989586621684871562"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684871563"><a href="#local-6989586621684871563"><span class="hs-identifier">_ins</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-541"></a><span>                        </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621684871562"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684871561"><span class="hs-identifier hs-var">blk</span></a><span> </span><a href="#local-6989586621684871560"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>                     </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621684871534"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>        </span><span class="hs-identifier">toNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockNode"><span class="hs-identifier hs-type">BlockNode</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-545"></a><span>        </span><a name="local-6989586621684871538"><a href="#local-6989586621684871538"><span class="hs-identifier">toNode</span></a></a><span> </span><a name="local-6989586621684871564"><a href="#local-6989586621684871564"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-546"></a><span>            </span><span class="hs-comment">-- sorted such that heavier successors come first.</span><span>
</span><a name="line-547"></a><span>            </span><a href="BlockLayout.html#BN"><span class="hs-identifier hs-var">BN</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871564"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-var">getSuccEdgesSorted</span></a><span> </span><a href="#local-6989586621684871533"><span class="hs-identifier hs-var">weights'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871564"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span>        </span><span class="hs-identifier">orderedBlocks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-550"></a><span>        </span><a name="local-6989586621684871539"><a href="#local-6989586621684871539"><span class="hs-identifier">orderedBlocks</span></a></a><span>
</span><a name="line-551"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="BlockLayout.html#fromNode"><span class="hs-identifier hs-var">fromNode</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-552"></a><span>              </span><a href="Hoopl.Graph.html#revPostorderFrom"><span class="hs-identifier hs-var">revPostorderFrom</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871538"><span class="hs-identifier hs-var">toNode</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Cmm.html#blockId"><span class="hs-identifier hs-var">blockId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871537"><span class="hs-identifier hs-var">blockMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871535"><span class="hs-identifier hs-var">entry</span></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684871540"><a href="#local-6989586621684871540"><span class="hs-identifier">builtChains</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871541"><a href="#local-6989586621684871541"><span class="hs-identifier">builtEdges</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;buildChains&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-556"></a><span>              </span><span class="hs-comment">--pprTraceIt &quot;generatedChains&quot; $</span><span>
</span><a name="line-557"></a><span>              </span><span class="hs-comment">--pprTrace &quot;orderedBlocks&quot; (ppr orderedBlocks) $</span><span>
</span><a name="line-558"></a><span>              </span><a href="BlockLayout.html#buildChains"><span class="hs-identifier hs-var">buildChains</span></a><span> </span><a href="#local-6989586621684871536"><span class="hs-identifier hs-var">weights</span></a><span> </span><a href="#local-6989586621684871539"><span class="hs-identifier hs-var">orderedBlocks</span></a><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span>        </span><span class="hs-identifier">rankedEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#WeightedEdgeList"><span class="hs-identifier hs-type">WeightedEdgeList</span></a><span>
</span><a name="line-561"></a><span>        </span><span class="hs-comment">-- Sort edges descending, remove fused eges</span><span>
</span><a name="line-562"></a><span>        </span><a name="local-6989586621684871542"><a href="#local-6989586621684871542"><span class="hs-identifier">rankedEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-563"></a><span>            </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684871565"><a href="#local-6989586621684871565"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871566"><a href="#local-6989586621684871566"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871567"><a href="#local-6989586621684871567"><span class="hs-identifier">weight</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#WeightedEdge"><span class="hs-identifier hs-var">WeightedEdge</span></a><span> </span><a href="#local-6989586621684871565"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621684871566"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621684871567"><span class="hs-identifier hs-var">weight</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-564"></a><span>            </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684871568"><a href="#local-6989586621684871568"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871569"><a href="#local-6989586621684871569"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.member</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871568"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621684871569"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871541"><span class="hs-identifier hs-var">builtEdges</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-566"></a><span>            </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684871570"><a href="#local-6989586621684871570"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621684871570"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CFG.html#weightedEdgeList"><span class="hs-identifier hs-var">weightedEdgeList</span></a><span> </span><a href="#local-6989586621684871536"><span class="hs-identifier hs-var">weights</span></a><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684871543"><a href="#local-6989586621684871543"><span class="hs-identifier">fusedChains</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871544"><a href="#local-6989586621684871544"><span class="hs-identifier">fusedEdges</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">noDups</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mapElems</span><span> </span><span class="hs-identifier">builtChains</span><span class="hs-special">)</span><span>
</span><a name="line-570"></a><span>              </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;fuseChains&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-571"></a><span>              </span><span class="hs-comment">--(pprTrace &quot;RankedEdges&quot; $ ppr rankedEdges) $</span><span>
</span><a name="line-572"></a><span>              </span><span class="hs-comment">--pprTraceIt &quot;FusedChains&quot; $</span><span>
</span><a name="line-573"></a><span>              </span><a href="BlockLayout.html#fuseChains"><span class="hs-identifier hs-var">fuseChains</span></a><span> </span><a href="#local-6989586621684871542"><span class="hs-identifier hs-var">rankedEdges</span></a><span> </span><a href="#local-6989586621684871540"><span class="hs-identifier hs-var">builtChains</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>        </span><a name="local-6989586621684871545"><a href="#local-6989586621684871545"><span class="hs-identifier">rankedEdges'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-576"></a><span>            </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871571"><a href="#local-6989586621684871571"><span class="hs-identifier">edge</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Set.member</span><span> </span><a href="#local-6989586621684871571"><span class="hs-identifier hs-var">edge</span></a><span> </span><a href="#local-6989586621684871544"><span class="hs-identifier hs-var">fusedEdges</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871542"><span class="hs-identifier hs-var">rankedEdges</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>        </span><a name="local-6989586621684871546"><a href="#local-6989586621684871546"><span class="hs-identifier">neighbourChains</span></a></a><span>
</span><a name="line-579"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">noDups</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mapElems</span><span> </span><span class="hs-identifier">fusedChains</span><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>              </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;groupNeighbourChains&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-581"></a><span>              </span><span class="hs-comment">--pprTraceIt &quot;ResultChains&quot; $</span><span>
</span><a name="line-582"></a><span>              </span><a href="BlockLayout.html#combineNeighbourhood"><span class="hs-identifier hs-var">combineNeighbourhood</span></a><span> </span><a href="#local-6989586621684871545"><span class="hs-identifier hs-var">rankedEdges'</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapElems"><span class="hs-identifier hs-var">mapElems</span></a><span> </span><a href="#local-6989586621684871543"><span class="hs-identifier hs-var">fusedChains</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>        </span><span class="hs-comment">--Make sure the first block stays first</span><span>
</span><a name="line-585"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621684871547"><a href="#local-6989586621684871547"><span class="hs-identifier">entryChain</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><a name="local-6989586621684871548"><a href="#local-6989586621684871548"><span class="hs-identifier">chains'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">noDups</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">neighbourChains</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>              </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#chainMember"><span class="hs-identifier hs-var">chainMember</span></a><span> </span><a href="#local-6989586621684871535"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871546"><span class="hs-identifier hs-var">neighbourChains</span></a><span>
</span><a name="line-588"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684871549"><a href="#local-6989586621684871549"><span class="hs-identifier">entryChain'</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871550"><a href="#local-6989586621684871550"><span class="hs-identifier">entryRest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-589"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="BlockLayout.html#inFront"><span class="hs-identifier hs-var">inFront</span></a><span> </span><a href="#local-6989586621684871535"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621684871547"><span class="hs-identifier hs-var">entryChain</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871547"><span class="hs-identifier hs-var">entryChain</span></a><span class="hs-special">]</span><span>
</span><a name="line-590"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871572"><a href="#local-6989586621684871572"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871573"><a href="#local-6989586621684871573"><span class="hs-identifier">entry</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockLayout.html#breakChainAt"><span class="hs-identifier hs-var">breakChainAt</span></a><span> </span><a href="#local-6989586621684871535"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621684871547"><span class="hs-identifier hs-var">entryChain</span></a><span>
</span><a name="line-591"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871573"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">,</span><a href="#local-6989586621684871572"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;Entry point eliminated&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-593"></a><span>                            </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621684871547"><span class="hs-identifier hs-var">entryChain</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="#local-6989586621684871548"><span class="hs-identifier hs-var">chains'</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>        </span><a name="local-6989586621684871551"><a href="#local-6989586621684871551"><span class="hs-identifier">prepedChains</span></a></a><span>
</span><a name="line-596"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871549"><span class="hs-identifier hs-var">entryChain'</span></a><span class="hs-glyph">:</span><span class="hs-special">(</span><a href="#local-6989586621684871550"><span class="hs-identifier hs-var">entryRest</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621684871548"><span class="hs-identifier hs-var">chains'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">]</span><span>
</span><a name="line-597"></a><span>        </span><a name="local-6989586621684871552"><a href="#local-6989586621684871552"><span class="hs-identifier">blockList</span></a></a><span>
</span><a name="line-598"></a><span>            </span><span class="hs-comment">-- = (concatMap chainToBlocks prepedChains)</span><span>
</span><a name="line-599"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="BlockLayout.html#seqToList"><span class="hs-identifier hs-var">seqToList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">chainBlocks</span><span> </span><a href="#local-6989586621684871551"><span class="hs-identifier hs-var">prepedChains</span></a><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span>        </span><span class="hs-comment">--chainPlaced = setFromList $ map blockId blockList :: LabelSet</span><span>
</span><a name="line-602"></a><span>        </span><a name="local-6989586621684871553"><a href="#local-6989586621684871553"><span class="hs-identifier">chainPlaced</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871552"><span class="hs-identifier hs-var">blockList</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-603"></a><span>        </span><a name="local-6989586621684871554"><a href="#local-6989586621684871554"><span class="hs-identifier">unplaced</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-604"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871574"><a href="#local-6989586621684871574"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a><span> </span><a href="#local-6989586621684871537"><span class="hs-identifier hs-var">blockMap</span></a><span>
</span><a name="line-605"></a><span>                </span><a name="local-6989586621684871575"><a href="#local-6989586621684871575"><span class="hs-identifier">isPlaced</span></a></a><span> </span><a name="local-6989586621684871576"><a href="#local-6989586621684871576"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871576"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871553"><span class="hs-identifier hs-var">chainPlaced</span></a><span>
</span><a name="line-606"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684871577"><a href="#local-6989586621684871577"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871575"><span class="hs-identifier hs-var">isPlaced</span></a><span> </span><a href="#local-6989586621684871577"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871574"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span>        </span><a name="local-6989586621684871555"><a href="#local-6989586621684871555"><span class="hs-identifier">placedBlocks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-609"></a><span>            </span><span class="hs-comment">--pprTraceIt &quot;placedBlocks&quot; $</span><span>
</span><a name="line-610"></a><span>            </span><a href="#local-6989586621684871552"><span class="hs-identifier hs-var">blockList</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684871554"><span class="hs-identifier hs-var">unplaced</span></a><span>
</span><a name="line-611"></a><span>        </span><a name="local-6989586621684871556"><a href="#local-6989586621684871556"><span class="hs-identifier">getBlock</span></a></a><span> </span><a name="local-6989586621684871578"><a href="#local-6989586621684871578"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;Block placment&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684871578"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621684871537"><span class="hs-identifier hs-var">blockMap</span></a><span>
</span><a name="line-612"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-613"></a><span>        </span><span class="hs-comment">--Assert we placed all blocks given as input</span><span>
</span><a name="line-614"></a><span>        </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">bid</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">mapMember</span><span> </span><span class="hs-identifier">bid</span><span> </span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">blockMap</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">placedBlocks</span><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>        </span><a href="BlockLayout.html#dropJumps"><span class="hs-identifier hs-var">dropJumps</span></a><span> </span><a href="#local-6989586621684871532"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684871556"><span class="hs-identifier hs-var">getBlock</span></a><span> </span><a href="#local-6989586621684871555"><span class="hs-identifier hs-var">placedBlocks</span></a><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span class="hs-identifier">dropJumps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621684871393"><a href="#local-6989586621684871393"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621684871394"><a href="#local-6989586621684871394"><span class="hs-identifier">i</span></a></a><span class="hs-operator">.</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684871394"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684871393"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871394"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">]</span><span>
</span><a name="line-618"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871394"><span class="hs-identifier hs-type">i</span></a><span class="hs-special">]</span><span>
</span><a name="line-619"></a><a name="dropJumps"><a href="BlockLayout.html#dropJumps"><span class="hs-identifier">dropJumps</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-620"></a><span class="hs-identifier">dropJumps</span><span> </span><a name="local-6989586621684871580"><a href="#local-6989586621684871580"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684871581"><a href="#local-6989586621684871581"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684871582"><a href="#local-6989586621684871582"><span class="hs-identifier">ins</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684871583"><a href="#local-6989586621684871583"><span class="hs-identifier">todo</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871582"><span class="hs-identifier hs-var">ins</span></a><span> </span><span class="hs-comment">--This can happen because of shortcutting</span><span>
</span><a name="line-622"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684871584"><a href="#local-6989586621684871584"><span class="hs-identifier">dest</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Instruction.html#jumpDestsOfInstr"><span class="hs-identifier hs-var">jumpDestsOfInstr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621684871582"><span class="hs-identifier hs-var">ins</span></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684871585"><a href="#local-6989586621684871585"><span class="hs-identifier">nextLbl</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684871583"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-624"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621684871584"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621684871580"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-625"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684871585"><span class="hs-identifier hs-var">nextLbl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684871584"><span class="hs-identifier hs-var">dest</span></a><span>
</span><a name="line-626"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684871581"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621684871582"><span class="hs-identifier hs-var">ins</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="BlockLayout.html#dropJumps"><span class="hs-identifier hs-var">dropJumps</span></a><span> </span><a href="#local-6989586621684871580"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684871583"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-627"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-628"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684871581"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684871582"><span class="hs-identifier hs-var">ins</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="BlockLayout.html#dropJumps"><span class="hs-identifier hs-var">dropJumps</span></a><span> </span><a href="#local-6989586621684871580"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684871583"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-632"></a><span class="hs-comment">-- Sequencing the basic blocks</span><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span class="hs-comment">-- Cmm BasicBlocks are self-contained entities: they always end in a</span><span>
</span><a name="line-635"></a><span class="hs-comment">-- jump, either non-local or to another basic block in the same proc.</span><span>
</span><a name="line-636"></a><span class="hs-comment">-- In this phase, we attempt to place the basic blocks in a sequence</span><span>
</span><a name="line-637"></a><span class="hs-comment">-- such that as many of the local jumps as possible turn into</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- fallthroughs.</span><span>
</span><a name="line-639"></a><span>
</span><a name="line-640"></a><span class="hs-identifier">sequenceTop</span><span>
</span><a name="line-641"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684871390"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684871390"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-comment">--Use new layout code</span><span>
</span><a name="line-643"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684871391"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684871390"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684871392"><span class="hs-identifier hs-type">jumpDest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-644"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684871391"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684871390"><span class="hs-identifier hs-type">instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684871391"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684871390"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><a name="sequenceTop"><a href="BlockLayout.html#sequenceTop"><span class="hs-identifier">sequenceTop</span></a></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-identifier">_</span><span>       </span><span class="hs-identifier">_</span><span>           </span><a name="local-6989586621684871586"><a href="#local-6989586621684871586"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871586"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-647"></a><span class="hs-identifier">sequenceTop</span><span> </span><a name="local-6989586621684871587"><a href="#local-6989586621684871587"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684871588"><a href="#local-6989586621684871588"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684871589"><a href="#local-6989586621684871589"><span class="hs-identifier">edgeWeights</span></a></a><span>
</span><a name="line-648"></a><span>            </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684871590"><a href="#local-6989586621684871590"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684871591"><a href="#local-6989586621684871591"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684871592"><a href="#local-6989586621684871592"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684871593"><a href="#local-6989586621684871593"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CfgBlocklayout</span><span> </span><a href="#local-6989586621684871587"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">backendMaintainsCfg</span><span> </span><a href="#local-6989586621684871587"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-650"></a><span>  </span><span class="hs-comment">--Use chain based algorithm</span><span>
</span><a name="line-651"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684871590"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684871591"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684871592"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ncgMakeFarBranches</span><span> </span><a href="#local-6989586621684871588"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684871590"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-652"></a><span>                            </span><a href="BlockLayout.html#sequenceChain"><span class="hs-identifier hs-var">sequenceChain</span></a><span> </span><a href="#local-6989586621684871590"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684871589"><span class="hs-identifier hs-var">edgeWeights</span></a><span> </span><a href="#local-6989586621684871593"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-654"></a><span>  </span><span class="hs-comment">--Use old algorithm</span><span>
</span><a name="line-655"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684871590"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684871591"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684871592"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ncgMakeFarBranches</span><span> </span><a href="#local-6989586621684871588"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684871590"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-656"></a><span>                            </span><a href="BlockLayout.html#sequenceBlocks"><span class="hs-identifier hs-var">sequenceBlocks</span></a><span> </span><a href="#local-6989586621684871594"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621684871590"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684871593"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-658"></a><span>    </span><a name="local-6989586621684871594"><a href="#local-6989586621684871594"><span class="hs-identifier">cfg</span></a></a><span>
</span><a name="line-659"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WeightlessBlocklayout</span><span> </span><a href="#local-6989586621684871587"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-660"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">backendMaintainsCfg</span><span> </span><a href="#local-6989586621684871587"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span>      </span><span class="hs-comment">-- Don't make use of cfg in the old algorithm</span><span>
</span><a name="line-662"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-663"></a><span>      </span><span class="hs-comment">-- Use cfg in the old algorithm</span><span>
</span><a name="line-664"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684871589"><span class="hs-identifier hs-var">edgeWeights</span></a><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span class="hs-comment">-- The old algorithm:</span><span>
</span><a name="line-667"></a><span class="hs-comment">-- It is very simple (and stupid): We make a graph out of</span><span>
</span><a name="line-668"></a><span class="hs-comment">-- the blocks where there is an edge from one block to another iff the</span><span>
</span><a name="line-669"></a><span class="hs-comment">-- first block ends by jumping to the second.  Then we topologically</span><span>
</span><a name="line-670"></a><span class="hs-comment">-- sort this graph.  Then traverse the list: for each block, we first</span><span>
</span><a name="line-671"></a><span class="hs-comment">-- output the block, then if it has an out edge, we move the</span><span>
</span><a name="line-672"></a><span class="hs-comment">-- destination of the out edge to the front of the list, and continue.</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-comment">-- FYI, the classic layout for basic blocks uses postorder DFS; this</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- algorithm is implemented in Hoopl.</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-identifier">sequenceBlocks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684871388"><span class="hs-identifier hs-type">inst</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684871389"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-678"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871388"><span class="hs-identifier hs-type">inst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871388"><span class="hs-identifier hs-type">inst</span></a><span class="hs-special">]</span><span>
</span><a name="line-679"></a><a name="sequenceBlocks"><a href="BlockLayout.html#sequenceBlocks"><span class="hs-identifier">sequenceBlocks</span></a></a><span> </span><a name="local-6989586621684871595"><a href="#local-6989586621684871595"><span class="hs-identifier">_edgeWeight</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-680"></a><span class="hs-identifier">sequenceBlocks</span><span> </span><a name="local-6989586621684871596"><a href="#local-6989586621684871596"><span class="hs-identifier">edgeWeights</span></a></a><span> </span><a name="local-6989586621684871597"><a href="#local-6989586621684871597"><span class="hs-identifier">infos</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684871598"><a href="#local-6989586621684871598"><span class="hs-identifier">entry</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871599"><a href="#local-6989586621684871599"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-681"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684871600"><a href="#local-6989586621684871600"><span class="hs-identifier">entryNode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#mkNode"><span class="hs-identifier hs-var">mkNode</span></a><span> </span><a href="#local-6989586621684871596"><span class="hs-identifier hs-var">edgeWeights</span></a><span> </span><a href="#local-6989586621684871598"><span class="hs-identifier hs-var">entry</span></a><span>
</span><a name="line-682"></a><span>        </span><a name="local-6989586621684871601"><a href="#local-6989586621684871601"><span class="hs-identifier">bodyNodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span>
</span><a name="line-683"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flattenSCCs</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#sccBlocks"><span class="hs-identifier hs-var">sccBlocks</span></a><span> </span><a href="#local-6989586621684871596"><span class="hs-identifier hs-var">edgeWeights</span></a><span> </span><a href="#local-6989586621684871599"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="BlockLayout.html#dropJumps"><span class="hs-identifier hs-var">dropJumps</span></a><span> </span><a href="#local-6989586621684871597"><span class="hs-identifier hs-var">infos</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="BlockLayout.html#seqBlocks"><span class="hs-identifier hs-var">seqBlocks</span></a><span> </span><a href="#local-6989586621684871597"><span class="hs-identifier hs-var">infos</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684871600"><span class="hs-identifier hs-var">entryNode</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684871601"><span class="hs-identifier hs-var">bodyNodes</span></a><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-comment">-- the first block is the entry point ==&gt; it must remain at the start.</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span class="hs-identifier">sccBlocks</span><span>
</span><a name="line-688"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684871387"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-689"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684871387"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-690"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Node</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-special">(</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684871387"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-691"></a><a name="sccBlocks"><a href="BlockLayout.html#sccBlocks"><span class="hs-identifier">sccBlocks</span></a></a><span> </span><a name="local-6989586621684871602"><a href="#local-6989586621684871602"><span class="hs-identifier">edgeWeights</span></a></a><span> </span><a name="local-6989586621684871603"><a href="#local-6989586621684871603"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-692"></a><span>    </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniqR</span><span>
</span><a name="line-693"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#mkNode"><span class="hs-identifier hs-var">mkNode</span></a><span> </span><a href="#local-6989586621684871602"><span class="hs-identifier hs-var">edgeWeights</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871603"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span class="hs-identifier">mkNode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684871386"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871386"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-697"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871386"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-698"></a><a name="mkNode"><a href="BlockLayout.html#mkNode"><span class="hs-identifier">mkNode</span></a></a><span> </span><a name="local-6989586621684871604"><a href="#local-6989586621684871604"><span class="hs-identifier">edgeWeights</span></a></a><span> </span><a name="local-6989586621684871605"><a href="#local-6989586621684871605"><span class="hs-identifier">block</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684871606"><a href="#local-6989586621684871606"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684871607"><a href="#local-6989586621684871607"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-699"></a><span>    </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621684871605"><span class="hs-identifier hs-var">block</span></a><span> </span><a href="#local-6989586621684871606"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684871608"><span class="hs-identifier hs-var">outEdges</span></a><span>
</span><a name="line-700"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-701"></a><span>    </span><span class="hs-identifier">outEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-702"></a><span>    </span><a name="local-6989586621684871608"><a href="#local-6989586621684871608"><span class="hs-identifier">outEdges</span></a></a><span>
</span><a name="line-703"></a><span>      </span><span class="hs-comment">--Select the heaviest successor, ignore weights &lt;= zero</span><span>
</span><a name="line-704"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871609"><span class="hs-identifier hs-var">successor</span></a><span>
</span><a name="line-705"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-706"></a><span>        </span><a name="local-6989586621684871609"><a href="#local-6989586621684871609"><span class="hs-identifier">successor</span></a></a><span>
</span><a name="line-707"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684871610"><a href="#local-6989586621684871610"><span class="hs-identifier">successors</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-var">getSuccEdgesSorted</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871606"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>                                    </span><a href="#local-6989586621684871604"><span class="hs-identifier hs-var">edgeWeights</span></a><span> </span><span class="hs-comment">-- :: Maybe [(Label, EdgeInfo)]</span><span>
</span><a name="line-709"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684871610"><span class="hs-identifier hs-var">successors</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-710"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-711"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684871611"><a href="#local-6989586621684871611"><span class="hs-identifier">target</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871612"><a href="#local-6989586621684871612"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684871610"><span class="hs-identifier hs-var">successors</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621684871612"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871611"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">]</span><span>
</span><a name="line-714"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-715"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Instruction.html#jumpDestsOfInstr"><span class="hs-identifier hs-var">jumpDestsOfInstr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621684871607"><span class="hs-identifier hs-var">instrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-716"></a><span>                </span><span class="hs-special">[</span><a name="local-6989586621684871613"><a href="#local-6989586621684871613"><span class="hs-identifier">one</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871613"><span class="hs-identifier hs-var">one</span></a><span class="hs-special">]</span><span>
</span><a name="line-717"></a><span>                </span><a name="local-6989586621684871614"><a href="#local-6989586621684871614"><span class="hs-identifier">_many</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-identifier">seqBlocks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684871384"><span class="hs-identifier hs-type">i</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Node</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871385"><span class="hs-identifier hs-type">t1</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-721"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><a href="#local-6989586621684871385"><span class="hs-identifier hs-type">t1</span></a><span class="hs-special">]</span><span>
</span><a name="line-722"></a><a name="seqBlocks"><a href="BlockLayout.html#seqBlocks"><span class="hs-identifier">seqBlocks</span></a></a><span> </span><a name="local-6989586621684871615"><a href="#local-6989586621684871615"><span class="hs-identifier">infos</span></a></a><span> </span><a name="local-6989586621684871616"><a href="#local-6989586621684871616"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871619"><span class="hs-identifier hs-var">placeNext</span></a><span> </span><a href="#local-6989586621684871617"><span class="hs-identifier hs-var">pullable0</span></a><span> </span><a href="#local-6989586621684871618"><span class="hs-identifier hs-var">todo0</span></a><span>
</span><a name="line-723"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-724"></a><span>    </span><span class="hs-comment">-- pullable: Blocks that are not yet placed</span><span>
</span><a name="line-725"></a><span>    </span><span class="hs-comment">-- todo:     Original order of blocks, to be followed if we have no good</span><span>
</span><a name="line-726"></a><span>    </span><span class="hs-comment">--           reason not to;</span><span>
</span><a name="line-727"></a><span>    </span><span class="hs-comment">--           may include blocks that have already been placed, but then</span><span>
</span><a name="line-728"></a><span>    </span><span class="hs-comment">--           these are not in pullable</span><span>
</span><a name="line-729"></a><span>    </span><a name="local-6989586621684871617"><a href="#local-6989586621684871617"><span class="hs-identifier">pullable0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToUFM</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871622"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="#local-6989586621684871621"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621684871623"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a name="local-6989586621684871621"><a href="#local-6989586621684871621"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684871622"><a href="#local-6989586621684871622"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621684871623"><a href="#local-6989586621684871623"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684871616"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-730"></a><span>    </span><a name="local-6989586621684871618"><a href="#local-6989586621684871618"><span class="hs-identifier">todo0</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">node_key</span><span> </span><a href="#local-6989586621684871616"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-731"></a><span>
</span><a name="line-732"></a><span>    </span><a name="local-6989586621684871619"><a href="#local-6989586621684871619"><span class="hs-identifier">placeNext</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-733"></a><span>    </span><span class="hs-identifier">placeNext</span><span> </span><a name="local-6989586621684871624"><a href="#local-6989586621684871624"><span class="hs-identifier">pullable</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684871625"><a href="#local-6989586621684871625"><span class="hs-identifier">i</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871626"><a href="#local-6989586621684871626"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871627"><a href="#local-6989586621684871627"><span class="hs-identifier">block</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871628"><a href="#local-6989586621684871628"><span class="hs-identifier">pullable'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockLayout.html#lookupDeleteUFM"><span class="hs-identifier hs-var">lookupDeleteUFM</span></a><span> </span><a href="#local-6989586621684871624"><span class="hs-identifier hs-var">pullable</span></a><span> </span><a href="#local-6989586621684871625"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-735"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871620"><span class="hs-identifier hs-var">place</span></a><span> </span><a href="#local-6989586621684871628"><span class="hs-identifier hs-var">pullable'</span></a><span> </span><a href="#local-6989586621684871626"><span class="hs-identifier hs-var">rest</span></a><span> </span><a href="#local-6989586621684871627"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-736"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-737"></a><span>        </span><span class="hs-comment">-- We already placed this block, so ignore</span><span>
</span><a name="line-738"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871619"><span class="hs-identifier hs-var">placeNext</span></a><span> </span><a href="#local-6989586621684871624"><span class="hs-identifier hs-var">pullable</span></a><span> </span><a href="#local-6989586621684871626"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span>    </span><a name="local-6989586621684871620"><a href="#local-6989586621684871620"><span class="hs-identifier">place</span></a></a><span> </span><a name="local-6989586621684871629"><a href="#local-6989586621684871629"><span class="hs-identifier">pullable</span></a></a><span> </span><a name="local-6989586621684871630"><a href="#local-6989586621684871630"><span class="hs-identifier">todo</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684871631"><a href="#local-6989586621684871631"><span class="hs-identifier">block</span></a></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-741"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871631"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684871619"><span class="hs-identifier hs-var">placeNext</span></a><span> </span><a href="#local-6989586621684871629"><span class="hs-identifier hs-var">pullable</span></a><span> </span><a href="#local-6989586621684871630"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-742"></a><span>    </span><span class="hs-identifier">place</span><span> </span><a name="local-6989586621684871632"><a href="#local-6989586621684871632"><span class="hs-identifier">pullable</span></a></a><span> </span><a name="local-6989586621684871633"><a href="#local-6989586621684871633"><span class="hs-identifier">todo</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684871634"><a href="#local-6989586621684871634"><span class="hs-identifier">block</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684871635"><a href="#local-6989586621684871635"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684871636"><a href="#local-6989586621684871636"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">[</span><a name="local-6989586621684871637"><a href="#local-6989586621684871637"><span class="hs-identifier">next</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621684871637"><span class="hs-identifier hs-var">next</span></a><span> </span><a href="#local-6989586621684871615"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-744"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871634"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684871619"><span class="hs-identifier hs-var">placeNext</span></a><span> </span><a href="#local-6989586621684871632"><span class="hs-identifier hs-var">pullable</span></a><span> </span><a href="#local-6989586621684871633"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-745"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871638"><a href="#local-6989586621684871638"><span class="hs-identifier">nextBlock</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684871639"><a href="#local-6989586621684871639"><span class="hs-identifier">pullable'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockLayout.html#lookupDeleteUFM"><span class="hs-identifier hs-var">lookupDeleteUFM</span></a><span> </span><a href="#local-6989586621684871632"><span class="hs-identifier hs-var">pullable</span></a><span> </span><a href="#local-6989586621684871637"><span class="hs-identifier hs-var">next</span></a><span>
</span><a name="line-746"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684871635"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684871636"><span class="hs-identifier hs-var">instrs</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684871620"><span class="hs-identifier hs-var">place</span></a><span> </span><a href="#local-6989586621684871639"><span class="hs-identifier hs-var">pullable'</span></a><span> </span><a href="#local-6989586621684871633"><span class="hs-identifier hs-var">todo</span></a><span> </span><a href="#local-6989586621684871638"><span class="hs-identifier hs-var">nextBlock</span></a><span>
</span><a name="line-747"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-748"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871634"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684871619"><span class="hs-identifier hs-var">placeNext</span></a><span> </span><a href="#local-6989586621684871632"><span class="hs-identifier hs-var">pullable</span></a><span> </span><a href="#local-6989586621684871633"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-749"></a><span>    </span><span class="hs-identifier">place</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684871640"><a href="#local-6989586621684871640"><span class="hs-identifier">tooManyNextNodes</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;seqBlocks&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684871640"><span class="hs-identifier hs-var">tooManyNextNodes</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span class="hs-identifier">lookupDeleteUFM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Uniquable</span><span> </span><a href="#local-6989586621684871382"><span class="hs-identifier hs-type">key</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">UniqFM</span><span> </span><a href="#local-6989586621684871383"><span class="hs-identifier hs-type">elt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684871382"><span class="hs-identifier hs-type">key</span></a><span>
</span><a name="line-754"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871383"><span class="hs-identifier hs-type">elt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UniqFM</span><span> </span><a href="#local-6989586621684871383"><span class="hs-identifier hs-type">elt</span></a><span class="hs-special">)</span><span>
</span><a name="line-755"></a><a name="lookupDeleteUFM"><a href="BlockLayout.html#lookupDeleteUFM"><span class="hs-identifier">lookupDeleteUFM</span></a></a><span> </span><a name="local-6989586621684871641"><a href="#local-6989586621684871641"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684871642"><a href="#local-6989586621684871642"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Maybe monad</span><span>
</span><a name="line-756"></a><span>    </span><a name="local-6989586621684871643"><a href="#local-6989586621684871643"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621684871641"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684871642"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-757"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871643"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><a href="#local-6989586621684871641"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684871642"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a><span class="hs-comment">-- -------------------------------------------------------------------</span><span>
</span><a name="line-760"></a><span class="hs-comment">-- Some specialized data structures to speed things up:</span><span>
</span><a name="line-761"></a><span class="hs-comment">--  * BlockSequence: A specialized version of Data.Sequence.</span><span>
</span><a name="line-762"></a><span class="hs-comment">--    Better at indexing at the front/end but lacks ability</span><span>
</span><a name="line-763"></a><span class="hs-comment">--    to do lookup by position.</span><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span class="hs-keyword">type</span><span> </span><a name="FrontierMap"><a href="BlockLayout.html#FrontierMap"><span class="hs-identifier">FrontierMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="BlockLayout.html#BlockChain"><span class="hs-identifier hs-type">BlockChain</span></a><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span class="hs-comment">-- | A &quot;reverse zipper&quot; of sorts.</span><span>
</span><a name="line-768"></a><span class="hs-comment">-- We store a list of blocks in two parts, the initial part from left to right</span><span>
</span><a name="line-769"></a><span class="hs-comment">-- and the remaining part stored in reverse order. This makes it easy to look</span><span>
</span><a name="line-770"></a><span class="hs-comment">-- the last/first element and append on both sides.</span><span>
</span><a name="line-771"></a><span class="hs-keyword">data</span><span> </span><a name="BlockSequence"><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier">BlockSequence</span></a></a><span>
</span><a name="line-772"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Singleton"><a href="BlockLayout.html#Singleton"><span class="hs-identifier">Singleton</span></a></a><span> </span><span class="hs-glyph">!</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-773"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Pair"><a href="BlockLayout.html#Pair"><span class="hs-identifier">Pair</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span>
</span><a name="line-774"></a><span>    </span><span class="hs-comment">-- ^ For a non empty pair there is at least one element in the left part.</span><span>
</span><a name="line-775"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Empty"><a href="BlockLayout.html#Empty"><span class="hs-identifier">Empty</span></a></a><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-identifier">seqFront</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-778"></a><a name="seqFront"><a href="BlockLayout.html#seqFront"><span class="hs-identifier">seqFront</span></a></a><span> </span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Empty sequence&quot;</span><span>
</span><a name="line-779"></a><span class="hs-identifier">seqFront</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871644"><a href="#local-6989586621684871644"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871644"><span class="hs-identifier hs-var">bid</span></a><span>
</span><a name="line-780"></a><span class="hs-identifier">seqFront</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871645"><a href="#local-6989586621684871645"><span class="hs-identifier">lefts</span></a></a><span> </span><a name="local-6989586621684871646"><a href="#local-6989586621684871646"><span class="hs-identifier">rights</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;Seq invariant&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-781"></a><span>    </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621684871645"><span class="hs-identifier hs-var">lefts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverseOL</span><span> </span><a href="#local-6989586621684871646"><span class="hs-identifier hs-var">rights</span></a><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span class="hs-comment">-- seqEnd :: BlockSequence -&gt; BlockId</span><span>
</span><a name="line-784"></a><span class="hs-comment">-- seqEnd Empty = panic &quot;Empty sequence&quot;</span><span>
</span><a name="line-785"></a><span class="hs-comment">-- seqEnd (Singleton bid) = bid</span><span>
</span><a name="line-786"></a><span class="hs-comment">-- seqEnd (Pair lefts rights) = expectJust &quot;Seq invariant&quot; $</span><span>
</span><a name="line-787"></a><span class="hs-comment">--     listToMaybe (fromOL rights) &lt;|&gt; listToMaybe (fromOL $ reverseOL lefts)</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-identifier">seqToList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-790"></a><a name="seqToList"><a href="BlockLayout.html#seqToList"><span class="hs-identifier">seqToList</span></a></a><span> </span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-791"></a><span class="hs-identifier">seqToList</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871647"><a href="#local-6989586621684871647"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871647"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">]</span><span>
</span><a name="line-792"></a><span class="hs-identifier">seqToList</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871648"><a href="#local-6989586621684871648"><span class="hs-identifier">lefts</span></a></a><span> </span><a name="local-6989586621684871649"><a href="#local-6989586621684871649"><span class="hs-identifier">rights</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromOL</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871648"><span class="hs-identifier hs-var">lefts</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">reverseOL</span><span> </span><a href="#local-6989586621684871649"><span class="hs-identifier hs-var">rights</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span class="hs-identifier">seqToRList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-796"></a><a name="seqToRList"><a href="BlockLayout.html#seqToRList"><span class="hs-identifier">seqToRList</span></a></a><span> </span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-797"></a><span class="hs-identifier">seqToRList</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871650"><a href="#local-6989586621684871650"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871650"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">]</span><span>
</span><a name="line-798"></a><span class="hs-identifier">seqToRList</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871651"><a href="#local-6989586621684871651"><span class="hs-identifier">lefts</span></a></a><span> </span><a name="local-6989586621684871652"><a href="#local-6989586621684871652"><span class="hs-identifier">rights</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromOL</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684871652"><span class="hs-identifier hs-var">rights</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">reverseOL</span><span> </span><a href="#local-6989586621684871651"><span class="hs-identifier hs-var">lefts</span></a><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span class="hs-identifier">seqSnoc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span>
</span><a name="line-801"></a><a name="seqSnoc"><a href="BlockLayout.html#seqSnoc"><span class="hs-identifier">seqSnoc</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871653"><a href="#local-6989586621684871653"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a href="#local-6989586621684871653"><span class="hs-identifier hs-var">bid</span></a><span>
</span><a name="line-802"></a><span class="hs-identifier">seqSnoc</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871654"><a href="#local-6989586621684871654"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871655"><a href="#local-6989586621684871655"><span class="hs-identifier">bid</span></a></a><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871654"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871655"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span>
</span><a name="line-803"></a><span class="hs-identifier">seqSnoc</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871656"><a href="#local-6989586621684871656"><span class="hs-identifier">lefts</span></a></a><span> </span><a name="local-6989586621684871657"><a href="#local-6989586621684871657"><span class="hs-identifier">rights</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871658"><a href="#local-6989586621684871658"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621684871656"><span class="hs-identifier hs-var">lefts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871658"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871657"><span class="hs-identifier hs-var">rights</span></a><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span>
</span><a name="line-805"></a><span class="hs-identifier">seqConcat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span>
</span><a name="line-806"></a><a name="seqConcat"><a href="BlockLayout.html#seqConcat"><span class="hs-identifier">seqConcat</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684871659"><a href="#local-6989586621684871659"><span class="hs-identifier">x2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871659"><span class="hs-identifier hs-var">x2</span></a><span>
</span><a name="line-807"></a><span class="hs-identifier">seqConcat</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871660"><a href="#local-6989586621684871660"><span class="hs-identifier">b1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871661"><a href="#local-6989586621684871661"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871660"><span class="hs-identifier hs-var">b1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871661"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span>
</span><a name="line-808"></a><span class="hs-identifier">seqConcat</span><span> </span><a name="local-6989586621684871662"><a href="#local-6989586621684871662"><span class="hs-identifier">x1</span></a></a><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684871662"><span class="hs-identifier hs-var">x1</span></a><span>
</span><a name="line-809"></a><span class="hs-identifier">seqConcat</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871663"><a href="#local-6989586621684871663"><span class="hs-identifier">b1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871664"><a href="#local-6989586621684871664"><span class="hs-identifier">lefts</span></a></a><span> </span><a name="local-6989586621684871665"><a href="#local-6989586621684871665"><span class="hs-identifier">rights</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871663"><span class="hs-identifier hs-var">b1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871664"><span class="hs-identifier hs-var">lefts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871665"><span class="hs-identifier hs-var">rights</span></a><span>
</span><a name="line-810"></a><span class="hs-identifier">seqConcat</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871666"><a href="#local-6989586621684871666"><span class="hs-identifier">lefts</span></a></a><span> </span><a name="local-6989586621684871667"><a href="#local-6989586621684871667"><span class="hs-identifier">rights</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a name="local-6989586621684871668"><a href="#local-6989586621684871668"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621684871666"><span class="hs-identifier hs-var">lefts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871668"><span class="hs-identifier hs-var">b2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871667"><span class="hs-identifier hs-var">rights</span></a><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span class="hs-identifier">seqConcat</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871669"><a href="#local-6989586621684871669"><span class="hs-identifier">lefts1</span></a></a><span> </span><a name="local-6989586621684871670"><a href="#local-6989586621684871670"><span class="hs-identifier">rights1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684871671"><a href="#local-6989586621684871671"><span class="hs-identifier">lefts2</span></a></a><span> </span><a name="local-6989586621684871672"><a href="#local-6989586621684871672"><span class="hs-identifier">rights2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-812"></a><span>    </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684871669"><span class="hs-identifier hs-var">lefts1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverseOL</span><span> </span><a href="#local-6989586621684871670"><span class="hs-identifier hs-var">rights1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684871671"><span class="hs-identifier hs-var">lefts2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684871672"><span class="hs-identifier hs-var">rights2</span></a><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span class="hs-identifier">seqFromBids</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockLayout.html#BlockSequence"><span class="hs-identifier hs-type">BlockSequence</span></a><span>
</span><a name="line-815"></a><a name="seqFromBids"><a href="BlockLayout.html#seqFromBids"><span class="hs-identifier">seqFromBids</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span>
</span><a name="line-816"></a><span class="hs-identifier">seqFromBids</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684871673"><a href="#local-6989586621684871673"><span class="hs-identifier">b1</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Singleton"><span class="hs-identifier hs-var">Singleton</span></a><span> </span><a href="#local-6989586621684871673"><span class="hs-identifier hs-var">b1</span></a><span>
</span><a name="line-817"></a><span class="hs-identifier">seqFromBids</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684871674"><a href="#local-6989586621684871674"><span class="hs-identifier">b1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871675"><a href="#local-6989586621684871675"><span class="hs-identifier">b2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871674"><span class="hs-identifier hs-var">b1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871675"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span>
</span><a name="line-818"></a><span class="hs-identifier">seqFromBids</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684871676"><a href="#local-6989586621684871676"><span class="hs-identifier">b1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871677"><a href="#local-6989586621684871677"><span class="hs-identifier">b2</span></a></a><span class="hs-special">,</span><a name="local-6989586621684871678"><a href="#local-6989586621684871678"><span class="hs-identifier">b3</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">consOL</span><span> </span><a href="#local-6989586621684871676"><span class="hs-identifier hs-var">b1</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871677"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684871678"><span class="hs-identifier hs-var">b3</span></a><span class="hs-special">)</span><span>
</span><a name="line-819"></a><span class="hs-identifier">seqFromBids</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684871679"><a href="#local-6989586621684871679"><span class="hs-identifier">b1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871680"><a href="#local-6989586621684871680"><span class="hs-identifier">b2</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871681"><a href="#local-6989586621684871681"><span class="hs-identifier">b3</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684871682"><a href="#local-6989586621684871682"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockLayout.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684871679"><span class="hs-identifier hs-var">b1</span></a><span class="hs-special">,</span><a href="#local-6989586621684871680"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">,</span><a href="#local-6989586621684871681"><span class="hs-identifier hs-var">b3</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><a href="#local-6989586621684871682"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-820"></a></pre></body></html>