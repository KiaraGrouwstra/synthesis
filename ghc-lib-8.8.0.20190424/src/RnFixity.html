<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">{-

This module contains code which maintains and manipulates the
fixity environment during renaming.

-}</span><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RnFixity</span><span> </span><span class="hs-special">(</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>                  </span><a href="RnFixity.html#addLocalFixities"><span class="hs-identifier hs-var">addLocalFixities</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>  </span><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier hs-var">lookupFixityRn</span></a><span class="hs-special">,</span><span> </span><a href="RnFixity.html#lookupFixityRn_help"><span class="hs-identifier hs-var">lookupFixityRn_help</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>  </span><a href="RnFixity.html#lookupFieldFixityRn"><span class="hs-identifier hs-var">lookupFieldFixityRn</span></a><span class="hs-special">,</span><span> </span><a href="RnFixity.html#lookupTyFixityRn"><span class="hs-identifier hs-var">lookupTyFixityRn</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FixityDirection</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">minPrecedence</span><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>                          </span><span class="hs-identifier hs-var">defaultFixity</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SourceText</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">on</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="RnUnbound.html"><span class="hs-identifier">RnUnbound</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
                Fixities
*                                                      *
*********************************************************

Note [Fixity signature lookup]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A fixity declaration like

    infixr 2 ?

can refer to a value-level operator, e.g.:

    (?) :: String -&gt; String -&gt; String

or a type-level operator, like:

    data (?) a b = A a | B b

so we extend the lookup of the reader name '?' to the TcClsName namespace, as
well as the original namespace.

The extended lookup is also used in other places, like resolution of
deprecation declarations, and lookup of names in GHCi.
-}</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">--------------------------------</span><span>
</span><a name="line-62"></a><span class="hs-keyword">type</span><span> </span><a name="MiniFixityEnv"><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier">MiniFixityEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">FastStringEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>        </span><span class="hs-comment">-- Mini fixity env for the names we're about</span><span>
</span><a name="line-64"></a><span>        </span><span class="hs-comment">-- to bind, in a single binding group</span><span>
</span><a name="line-65"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-66"></a><span>        </span><span class="hs-comment">-- It is keyed by the *FastString*, not the *OccName*, because</span><span>
</span><a name="line-67"></a><span>        </span><span class="hs-comment">-- the single fixity decl       infix 3 T</span><span>
</span><a name="line-68"></a><span>        </span><span class="hs-comment">-- affects both the data constructor T and the type constrctor T</span><span>
</span><a name="line-69"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-70"></a><span>        </span><span class="hs-comment">-- We keep the location so that if we find</span><span>
</span><a name="line-71"></a><span>        </span><span class="hs-comment">-- a duplicate, we can report it sensibly</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">--------------------------------</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- Used for nested fixity decls to bind names along with their fixities.</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- the fixities are given as a UFM from an OccName's FastString to a fixity decl</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">addLocalFixities</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><a href="#local-6989586621682061840"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><a href="#local-6989586621682061840"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-78"></a><a name="addLocalFixities"><a href="RnFixity.html#addLocalFixities"><span class="hs-identifier">addLocalFixities</span></a></a><span> </span><a name="local-6989586621682061841"><a href="#local-6989586621682061841"><span class="hs-identifier">mini_fix_env</span></a></a><span> </span><a name="local-6989586621682061842"><a href="#local-6989586621682061842"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621682061843"><a href="#local-6989586621682061843"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#extendFixityEnv"><span class="hs-identifier hs-var">extendFixityEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621682061844"><span class="hs-identifier hs-var">find_fixity</span></a><span> </span><a href="#local-6989586621682061842"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682061843"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-80"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-81"></a><span>    </span><a name="local-6989586621682061844"><a href="#local-6989586621682061844"><span class="hs-identifier">find_fixity</span></a></a><span> </span><a name="local-6989586621682061845"><a href="#local-6989586621682061845"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-82"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupFsEnv</span><span> </span><a href="#local-6989586621682061841"><span class="hs-identifier hs-var">mini_fix_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><a href="#local-6989586621682061846"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-83"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682061847"><a href="#local-6989586621682061847"><span class="hs-identifier">lfix</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682061845"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FixItem</span><span> </span><a href="#local-6989586621682061846"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682061847"><span class="hs-identifier hs-var">lfix</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-85"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-86"></a><span>        </span><a name="local-6989586621682061846"><a href="#local-6989586621682061846"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682061845"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">{-
--------------------------------
lookupFixity is a bit strange.

* Nested local fixity decls are put in the local fixity env, which we
  find with getFixtyEnv

* Imported fixities are found in the PIT

* Top-level fixity decls in this module may be for Names that are
    either  Global         (constructors, class operations)
    or      Local/Exported (everything else)
  (See notes with RnNames.getLocalDeclBinders for why we have this split.)
  We put them all in the local fixity environment
-}</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">lookupFixityRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>
</span><a name="line-105"></a><a name="lookupFixityRn"><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier">lookupFixityRn</span></a></a><span> </span><a name="local-6989586621682061848"><a href="#local-6989586621682061848"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnFixity.html#lookupFixityRn%27"><span class="hs-identifier hs-var">lookupFixityRn'</span></a><span> </span><a href="#local-6989586621682061848"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682061848"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-identifier">lookupFixityRn'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>
</span><a name="line-108"></a><a name="lookupFixityRn%27"><a href="RnFixity.html#lookupFixityRn%27"><span class="hs-identifier">lookupFixityRn'</span></a></a><span> </span><a name="local-6989586621682061849"><a href="#local-6989586621682061849"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="RnFixity.html#lookupFixityRn_help%27"><span class="hs-identifier hs-var">lookupFixityRn_help'</span></a><span> </span><a href="#local-6989586621682061849"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | 'lookupFixityRn_help' returns @(True, fixity)@ if it finds a 'Fixity'</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- in a local environment or from an interface file. Otherwise, it returns</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- @(False, fixity)@ (e.g., for unbound 'Name's or 'Name's without</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- user-supplied fixity declarations).</span><span>
</span><a name="line-114"></a><span class="hs-identifier">lookupFixityRn_help</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-115"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><a name="lookupFixityRn_help"><a href="RnFixity.html#lookupFixityRn_help"><span class="hs-identifier">lookupFixityRn_help</span></a></a><span> </span><a name="local-6989586621682061850"><a href="#local-6989586621682061850"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-117"></a><span>    </span><a href="RnFixity.html#lookupFixityRn_help%27"><span class="hs-identifier hs-var">lookupFixityRn_help'</span></a><span> </span><a href="#local-6989586621682061850"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682061850"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">lookupFixityRn_help'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-120"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-121"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>
</span><a name="line-122"></a><a name="lookupFixityRn_help%27"><a href="RnFixity.html#lookupFixityRn_help%27"><span class="hs-identifier">lookupFixityRn_help'</span></a></a><span> </span><a name="local-6989586621682061851"><a href="#local-6989586621682061851"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682061852"><a href="#local-6989586621682061852"><span class="hs-identifier">occ</span></a></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboundName</span><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-identifier hs-var">minPrecedence</span><span> </span><span class="hs-identifier hs-var">InfixL</span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-comment">-- Minimise errors from ubound names; eg</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-comment">--    a&gt;0 `foo` b&gt;0</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-comment">-- where 'foo' is not in scope, should not give an error (Trac #7937)</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682061860"><a href="#local-6989586621682061860"><span class="hs-identifier">local_fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-131"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621682061860"><span class="hs-identifier hs-var">local_fix_env</span></a><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-132"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FixItem</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682061861"><a href="#local-6989586621682061861"><span class="hs-identifier">fix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682061861"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-133"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682061862"><a href="#local-6989586621682061862"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-136"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682061862"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-137"></a><span>               </span><span class="hs-comment">-- Local (and interactive) names are all in the</span><span>
</span><a name="line-138"></a><span>               </span><span class="hs-comment">-- fixity env, and don't have entries in the HPT</span><span>
</span><a name="line-139"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaultFixity</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682061853"><span class="hs-identifier hs-var">lookup_imported</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-142"></a><span>    </span><a name="local-6989586621682061853"><a href="#local-6989586621682061853"><span class="hs-identifier">lookup_imported</span></a></a><span>
</span><a name="line-143"></a><span>      </span><span class="hs-comment">-- For imported names, we have to get their fixities by doing a</span><span>
</span><a name="line-144"></a><span>      </span><span class="hs-comment">-- loadInterfaceForName, and consulting the Ifaces that comes back</span><span>
</span><a name="line-145"></a><span>      </span><span class="hs-comment">-- from that, because the interface file for the Name might not</span><span>
</span><a name="line-146"></a><span>      </span><span class="hs-comment">-- have been loaded yet.  Why not?  Suppose you import module A,</span><span>
</span><a name="line-147"></a><span>      </span><span class="hs-comment">-- which exports a function 'f', thus;</span><span>
</span><a name="line-148"></a><span>      </span><span class="hs-comment">--        module CurrentModule where</span><span>
</span><a name="line-149"></a><span>      </span><span class="hs-comment">--          import A( f )</span><span>
</span><a name="line-150"></a><span>      </span><span class="hs-comment">--        module A( f ) where</span><span>
</span><a name="line-151"></a><span>      </span><span class="hs-comment">--          import B( f )</span><span>
</span><a name="line-152"></a><span>      </span><span class="hs-comment">-- Then B isn't loaded right away (after all, it's possible that</span><span>
</span><a name="line-153"></a><span>      </span><span class="hs-comment">-- nothing from B will be used).  When we come across a use of</span><span>
</span><a name="line-154"></a><span>      </span><span class="hs-comment">-- 'f', we need to know its fixity, and it's then, and only</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-comment">-- then, that we load B.hi.  That is what's happening here.</span><span>
</span><a name="line-156"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-157"></a><span>      </span><span class="hs-comment">-- loadInterfaceForName will find B.hi even if B is a hidden module,</span><span>
</span><a name="line-158"></a><span>      </span><span class="hs-comment">-- and that's what we want.</span><span>
</span><a name="line-159"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682061855"><a href="#local-6989586621682061855"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier hs-var">loadInterfaceForName</span></a><span> </span><a href="#local-6989586621682061854"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-160"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682061856"><a href="#local-6989586621682061856"><span class="hs-identifier">mb_fix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_fix_fn</span><span> </span><a href="#local-6989586621682061855"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682061852"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-161"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682061857"><a href="#local-6989586621682061857"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682061856"><span class="hs-identifier hs-var">mb_fix</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-162"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-163"></a><span>                                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;looking up name&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-164"></a><span>                              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in iface, but found no fixity for it.&quot;</span><span>
</span><a name="line-165"></a><span>                              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Using default fixity instead.&quot;</span><span>
</span><a name="line-166"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682061858"><a href="#local-6989586621682061858"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-167"></a><span>                                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;looking up name in iface and found:&quot;</span><span>
</span><a name="line-168"></a><span>                              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061858"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">]</span><span>
</span><a name="line-169"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;lookupFixityRn_either:&quot;</span><span> </span><a href="#local-6989586621682061857"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-170"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaultFixity</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682061859"><a href="#local-6989586621682061859"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682061859"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682061856"><span class="hs-identifier hs-var">mb_fix</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>    </span><a name="local-6989586621682061854"><a href="#local-6989586621682061854"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Checking fixity for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061851"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-175"></a><span class="hs-identifier">lookupTyFixityRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>
</span><a name="line-176"></a><a name="lookupTyFixityRn"><a href="RnFixity.html#lookupTyFixityRn"><span class="hs-identifier">lookupTyFixityRn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier hs-var">lookupFixityRn</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-comment">-- | Look up the fixity of a (possibly ambiguous) occurrence of a record field</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- selector.  We use 'lookupFixityRn'' so that we can specifiy the 'OccName' as</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- the field label, which might be different to the 'OccName' of the selector</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- 'Name' if @DuplicateRecordFields@ is in use (Trac #1173). If there are</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- multiple possible selectors with different fixities, generate an error.</span><span>
</span><a name="line-183"></a><span class="hs-identifier">lookupFieldFixityRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>
</span><a name="line-184"></a><a name="lookupFieldFixityRn"><a href="RnFixity.html#lookupFieldFixityRn"><span class="hs-identifier">lookupFieldFixityRn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a name="local-6989586621682061863"><a href="#local-6989586621682061863"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682061864"><a href="#local-6989586621682061864"><span class="hs-identifier">lrdr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnFixity.html#lookupFixityRn%27"><span class="hs-identifier hs-var">lookupFixityRn'</span></a><span> </span><a href="#local-6989586621682061863"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682061864"><span class="hs-identifier hs-var">lrdr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span class="hs-identifier">lookupFieldFixityRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ambiguous</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682061865"><a href="#local-6989586621682061865"><span class="hs-identifier">lrdr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682061866"><span class="hs-identifier hs-var">get_ambiguous_fixity</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682061865"><span class="hs-identifier hs-var">lrdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-identifier">get_ambiguous_fixity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span>
</span><a name="line-189"></a><span>    </span><a name="local-6989586621682061866"><a href="#local-6989586621682061866"><span class="hs-identifier">get_ambiguous_fixity</span></a></a><span> </span><a name="local-6989586621682061870"><a href="#local-6989586621682061870"><span class="hs-identifier">rdr_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-190"></a><span>      </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;get_ambiguous_fixity&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061870"><span class="hs-identifier hs-var">rdr_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>      </span><a name="local-6989586621682061871"><a href="#local-6989586621682061871"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-192"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682061872"><a href="#local-6989586621682061872"><span class="hs-identifier">elts</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">lookupGRE_RdrName</span><span> </span><a href="#local-6989586621682061870"><span class="hs-identifier hs-var">rdr_name</span></a><span> </span><a href="#local-6989586621682061871"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span>      </span><a name="local-6989586621682061873"><a href="#local-6989586621682061873"><span class="hs-identifier">fixities</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621682061872"><span class="hs-identifier hs-var">elts</span></a><span>
</span><a name="line-195"></a><span>                  </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621682061867"><span class="hs-identifier hs-var">lookup_gre_fixity</span></a><span> </span><a href="#local-6989586621682061872"><span class="hs-identifier hs-var">elts</span></a><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682061873"><span class="hs-identifier hs-var">fixities</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-comment">-- There should always be at least one fixity.</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-comment">-- Something's very wrong if there are no fixity candidates, so panic</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;get_ambiguous_fixity: no candidates for a given RdrName&quot;</span><span>
</span><a name="line-201"></a><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682061874"><a href="#local-6989586621682061874"><span class="hs-identifier">fix</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682061874"><span class="hs-identifier hs-var">fix</span></a><span>
</span><a name="line-202"></a><span>        </span><a name="local-6989586621682061875"><a href="#local-6989586621682061875"><span class="hs-identifier">ambigs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682061868"><span class="hs-identifier hs-var">ambiguous_fixity_err</span></a><span> </span><a href="#local-6989586621682061870"><span class="hs-identifier hs-var">rdr_name</span></a><span> </span><a href="#local-6989586621682061875"><span class="hs-identifier hs-var">ambigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>                  </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-identifier hs-var">minPrecedence</span><span> </span><span class="hs-identifier hs-var">InfixL</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>    </span><a name="local-6989586621682061867"><a href="#local-6989586621682061867"><span class="hs-identifier">lookup_gre_fixity</span></a></a><span> </span><a name="local-6989586621682061876"><a href="#local-6989586621682061876"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnFixity.html#lookupFixityRn%27"><span class="hs-identifier hs-var">lookupFixityRn'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682061876"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">greOccName</span><span> </span><a href="#local-6989586621682061876"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>    </span><a name="local-6989586621682061868"><a href="#local-6989586621682061868"><span class="hs-identifier">ambiguous_fixity_err</span></a></a><span> </span><a name="local-6989586621682061877"><a href="#local-6989586621682061877"><span class="hs-identifier">rn</span></a></a><span> </span><a name="local-6989586621682061878"><a href="#local-6989586621682061878"><span class="hs-identifier">ambigs</span></a></a><span>
</span><a name="line-208"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Ambiguous fixity for record field&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061877"><span class="hs-identifier hs-var">rn</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Conflicts: &quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-210"></a><span>               </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682061869"><span class="hs-identifier hs-var">format_ambig</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682061878"><span class="hs-identifier hs-var">ambigs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621682061869"><a href="#local-6989586621682061869"><span class="hs-identifier">format_ambig</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682061879"><a href="#local-6989586621682061879"><span class="hs-identifier">elt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682061880"><a href="#local-6989586621682061880"><span class="hs-identifier">fix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682061880"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>                                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprNameProvenance</span><span> </span><a href="#local-6989586621682061879"><span class="hs-identifier hs-var">elt</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span class="hs-identifier">lookupFieldFixityRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XAmbiguousFieldOcc</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;lookupFieldFixityRn&quot;</span><span>
</span><a name="line-215"></a></pre></body></html>