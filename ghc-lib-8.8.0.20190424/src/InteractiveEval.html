<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, MagicHash, NondecreasingIndentation, UnboxedTuples,
    RecordWildCards, BangPatterns #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- (c) The University of Glasgow, 2005-2007</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Running statements interactively</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">InteractiveEval</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><span class="hs-identifier hs-type">Resume</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">History</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="InteractiveEval.html#execStmt"><span class="hs-identifier hs-var">execStmt</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#execStmt%27"><span class="hs-identifier hs-var">execStmt'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ExecOptions</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#execOptions"><span class="hs-identifier hs-var">execOptions</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ExecResult</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#resumeExec"><span class="hs-identifier hs-var">resumeExec</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="InteractiveEval.html#runDecls"><span class="hs-identifier hs-var">runDecls</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#runDeclsWithLocation"><span class="hs-identifier hs-var">runDeclsWithLocation</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#runParsedDecls"><span class="hs-identifier hs-var">runParsedDecls</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="InteractiveEval.html#isStmt"><span class="hs-identifier hs-var">isStmt</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#hasImport"><span class="hs-identifier hs-var">hasImport</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#isImport"><span class="hs-identifier hs-var">isImport</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#isDecl"><span class="hs-identifier hs-var">isDecl</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="InteractiveEval.html#parseImportDecl"><span class="hs-identifier hs-var">parseImportDecl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SingleStep</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="InteractiveEval.html#abandon"><span class="hs-identifier hs-var">abandon</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#abandonAll"><span class="hs-identifier hs-var">abandonAll</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="InteractiveEval.html#getResumeContext"><span class="hs-identifier hs-var">getResumeContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="InteractiveEval.html#getHistorySpan"><span class="hs-identifier hs-var">getHistorySpan</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="InteractiveEval.html#getModBreaks"><span class="hs-identifier hs-var">getModBreaks</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="InteractiveEval.html#getHistoryModule"><span class="hs-identifier hs-var">getHistoryModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="InteractiveEval.html#back"><span class="hs-identifier hs-var">back</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#forward"><span class="hs-identifier hs-var">forward</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="InteractiveEval.html#setContext"><span class="hs-identifier hs-var">setContext</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#getContext"><span class="hs-identifier hs-var">getContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="InteractiveEval.html#availsToGlobalRdrEnv"><span class="hs-identifier hs-var">availsToGlobalRdrEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="InteractiveEval.html#getNamesInScope"><span class="hs-identifier hs-var">getNamesInScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="InteractiveEval.html#getRdrNamesInScope"><span class="hs-identifier hs-var">getRdrNamesInScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="InteractiveEval.html#moduleIsInterpreted"><span class="hs-identifier hs-var">moduleIsInterpreted</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="InteractiveEval.html#getInfo"><span class="hs-identifier hs-var">getInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="InteractiveEval.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="InteractiveEval.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="InteractiveEval.html#parseName"><span class="hs-identifier hs-var">parseName</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="InteractiveEval.html#getDocs"><span class="hs-identifier hs-var">getDocs</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="InteractiveEval.html#GetDocsFailure"><span class="hs-identifier hs-type">GetDocsFailure</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="InteractiveEval.html#showModule"><span class="hs-identifier hs-var">showModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="InteractiveEval.html#moduleIsBootOrNotObjectLinkable"><span class="hs-identifier hs-var">moduleIsBootOrNotObjectLinkable</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="InteractiveEval.html#parseExpr"><span class="hs-identifier hs-var">parseExpr</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#compileParsedExpr"><span class="hs-identifier hs-var">compileParsedExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="InteractiveEval.html#compileExpr"><span class="hs-identifier hs-var">compileExpr</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#dynCompileExpr"><span class="hs-identifier hs-var">dynCompileExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="InteractiveEval.html#compileExprRemote"><span class="hs-identifier hs-var">compileExprRemote</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#compileParsedExprRemote"><span class="hs-identifier hs-var">compileParsedExprRemote</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#obtainTermFromId"><span class="hs-identifier hs-var">obtainTermFromId</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#obtainTermFromVal"><span class="hs-identifier hs-var">obtainTermFromVal</span></a><span class="hs-special">,</span><span> </span><a href="InteractiveEval.html#reconstructType"><span class="hs-identifier hs-var">reconstructType</span></a><span>
</span><a name="line-41"></a><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InteractiveEvalTypes</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.html"><span class="hs-identifier">GHCi</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.Message</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcMonad</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="HscMain.html"><span class="hs-identifier">HscMain</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="IfaceEnv.html#newInteractiveBinder"><span class="hs-identifier hs-var">newInteractiveBinder</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">orphNamesOfFamInst</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>             </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">typeKind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>           </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">typeKind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>             </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">varName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Avail</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ByteCodeTypes</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="Linker.html"><span class="hs-identifier">Linker</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">toDynName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pretendNameIsInScope</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isCTupleTyConName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><a href="RtClosureInspect.html"><span class="hs-identifier">RtClosureInspect</span></a><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Lexer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">P</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ParseResult</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unP</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkPState</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Parser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parseStmt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parseModule</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parseDeclaration</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parseImport</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Dynamic</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Either</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IntMap</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">find</span><span class="hs-special">,</span><span class="hs-identifier hs-var">intercalate</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">StringBuffer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stringToStringBuffer</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- running a statement interactively</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">getResumeContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103426"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103426"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Resume</span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><a name="getResumeContext"><a href="InteractiveEval.html#getResumeContext"><span class="hs-identifier">getResumeContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hsc_IC</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-identifier">mkHistory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BreakInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">History</span><span>
</span><a name="line-112"></a><a name="mkHistory"><a href="InteractiveEval.html#mkHistory"><span class="hs-identifier">mkHistory</span></a></a><span> </span><a name="local-6989586621685103427"><a href="#local-6989586621685103427"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103428"><a href="#local-6989586621685103428"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621685103429"><a href="#local-6989586621685103429"><span class="hs-identifier">bi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">History</span><span> </span><a href="#local-6989586621685103428"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621685103429"><span class="hs-identifier hs-var">bi</span></a><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#findEnclosingDecls"><span class="hs-identifier hs-var">findEnclosingDecls</span></a><span> </span><a href="#local-6989586621685103427"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103429"><span class="hs-identifier hs-var">bi</span></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">getHistoryModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">History</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-115"></a><a name="getHistoryModule"><a href="InteractiveEval.html#getHistoryModule"><span class="hs-identifier">getHistoryModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">breakInfo_module</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">historyBreakInfo</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">getHistorySpan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">History</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-118"></a><a name="getHistorySpan"><a href="InteractiveEval.html#getHistorySpan"><span class="hs-identifier">getHistorySpan</span></a></a><span> </span><a name="local-6989586621685103430"><a href="#local-6989586621685103430"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-identifier hs-var">History</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">BreakInfo</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103436"><span class="hs-identifier hs-var">historyBreakInfo</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103430"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685103442"><span class="hs-identifier hs-var">breakInfo_module</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-121"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103444"><a href="#local-6989586621685103444"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">modBreaks_locs</span><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#getModBreaks"><span class="hs-identifier hs-var">getModBreaks</span></a><span> </span><a href="#local-6989586621685103444"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621685103443"><span class="hs-identifier hs-var">breakInfo_number</span></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getHistorySpan&quot;</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">getModBreaks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModBreaks</span><span>
</span><a name="line-125"></a><a name="getModBreaks"><a href="InteractiveEval.html#getModBreaks"><span class="hs-identifier">getModBreaks</span></a></a><span> </span><a name="local-6989586621685103445"><a href="#local-6989586621685103445"><span class="hs-identifier">hmi</span></a></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103446"><a href="#local-6989586621685103446"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685103445"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">,</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-special">[</span><span class="hs-identifier hs-var">BCOs</span><span> </span><a name="local-6989586621685103447"><a href="#local-6989586621685103447"><span class="hs-identifier">cbc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621685103446"><span class="hs-identifier hs-var">linkable</span></a><span>
</span><a name="line-128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">emptyModBreaks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bc_breaks</span><span> </span><a href="#local-6989586621685103447"><span class="hs-identifier hs-var">cbc</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyModBreaks</span><span> </span><span class="hs-comment">-- probably object code</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-comment">{- | Finds the enclosing top level function name -}</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- ToDo: a better way to do this would be to keep hold of the decl_path computed</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- by the coverage pass, which gives the list of lexically-enclosing bindings</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- for each tick.</span><span>
</span><a name="line-136"></a><span class="hs-identifier">findEnclosingDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BreakInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-137"></a><a name="findEnclosingDecls"><a href="InteractiveEval.html#findEnclosingDecls"><span class="hs-identifier">findEnclosingDecls</span></a></a><span> </span><a name="local-6989586621685103448"><a href="#local-6989586621685103448"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BreakInfo</span><span> </span><a name="local-6989586621685103449"><a href="#local-6989586621685103449"><span class="hs-identifier">modl</span></a></a><span> </span><a name="local-6989586621685103450"><a href="#local-6989586621685103450"><span class="hs-identifier">ix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-138"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103451"><a href="#local-6989586621685103451"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;findEnclosingDecls&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-139"></a><span>             </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103448"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685103449"><span class="hs-identifier hs-var">modl</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>       </span><a name="local-6989586621685103452"><a href="#local-6989586621685103452"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#getModBreaks"><span class="hs-identifier hs-var">getModBreaks</span></a><span> </span><a href="#local-6989586621685103451"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-141"></a><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier">modBreaks_decls</span><span> </span><a href="#local-6989586621685103452"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621685103450"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | Update fixity environment in the current interactive context.</span><span>
</span><a name="line-144"></a><span class="hs-identifier">updateFixityEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103425"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103425"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><a name="updateFixityEnv"><a href="InteractiveEval.html#updateFixityEnv"><span class="hs-identifier">updateFixityEnv</span></a></a><span> </span><a name="local-6989586621685103453"><a href="#local-6989586621685103453"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-146"></a><span>  </span><a name="local-6989586621685103454"><a href="#local-6989586621685103454"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-147"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103455"><a href="#local-6989586621685103455"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103454"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-148"></a><span>  </span><span class="hs-identifier hs-var">setSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685103454"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103455"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_fix_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103453"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- execStmt</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | default ExecOptions</span><span>
</span><a name="line-154"></a><span class="hs-identifier">execOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExecOptions</span><span>
</span><a name="line-155"></a><a name="execOptions"><a href="InteractiveEval.html#execOptions"><span class="hs-identifier">execOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ExecOptions</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">execSingleStep</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RunToCompletion</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">execSourceFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">execLineNumber</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">execWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EvalThis</span><span> </span><span class="hs-comment">-- just run the statement, don't wrap it in anything</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- | Run a statement in the current interactive context.</span><span>
</span><a name="line-163"></a><span class="hs-identifier">execStmt</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103424"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-165"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>             </span><span class="hs-comment">-- ^ a statement (bind or expression)</span><span>
</span><a name="line-166"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExecOptions</span><span>
</span><a name="line-167"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103424"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ExecResult</span><span>
</span><a name="line-168"></a><a name="execStmt"><a href="InteractiveEval.html#execStmt"><span class="hs-identifier">execStmt</span></a></a><span> </span><a name="local-6989586621685103460"><a href="#local-6989586621685103460"><span class="hs-identifier">input</span></a></a><span> </span><a name="local-6989586621685103461"><a href="#local-6989586621685103461"><span class="hs-identifier">exec_opts</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">ExecOptions</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621685103466"><a href="#local-6989586621685103466"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>    </span><a name="local-6989586621685103467"><a href="#local-6989586621685103467"><span class="hs-identifier">mb_stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-172"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-173"></a><span>      </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621685103466"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-174"></a><span>      </span><a href="HscMain.html#hscParseStmtWithLocation"><span class="hs-identifier hs-var">hscParseStmtWithLocation</span></a><span> </span><a href="#local-6989586621685103463"><span class="hs-identifier hs-var">execSourceFile</span></a><span> </span><a href="#local-6989586621685103464"><span class="hs-identifier hs-var">execLineNumber</span></a><span> </span><a href="#local-6989586621685103460"><span class="hs-identifier hs-var">input</span></a><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103467"><span class="hs-identifier hs-var">mb_stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-177"></a><span>      </span><span class="hs-comment">-- empty statement / comment</span><span>
</span><a name="line-178"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExecComplete</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103468"><a href="#local-6989586621685103468"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#execStmt%27"><span class="hs-identifier hs-var">execStmt'</span></a><span> </span><a href="#local-6989586621685103468"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621685103460"><span class="hs-identifier hs-var">input</span></a><span> </span><a href="#local-6989586621685103461"><span class="hs-identifier hs-var">exec_opts</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">-- | Like `execStmt`, but takes a parsed statement as argument. Useful when</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- doing preprocessing on the AST before execution, e.g. in GHCi (see</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- GHCi.UI.runStmt).</span><span>
</span><a name="line-184"></a><span class="hs-identifier">execStmt'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103423"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExecOptions</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103423"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ExecResult</span><span>
</span><a name="line-185"></a><a name="execStmt%27"><a href="InteractiveEval.html#execStmt%27"><span class="hs-identifier">execStmt'</span></a></a><span> </span><a name="local-6989586621685103469"><a href="#local-6989586621685103469"><span class="hs-identifier">stmt</span></a></a><span> </span><a name="local-6989586621685103470"><a href="#local-6989586621685103470"><span class="hs-identifier">stmt_text</span></a></a><span> </span><span class="hs-identifier hs-var">ExecOptions</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621685103475"><a href="#local-6989586621685103475"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-comment">-- Turn off -fwarn-unused-local-binds when running a statement, to hide</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-comment">-- warnings about the implicit bindings we introduce.</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-comment">-- (This is basically `mkInteractiveHscEnv hsc_env`, except we unset</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-comment">-- -wwarn-unused-local-binds)</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103476"><a href="#local-6989586621685103476"><span class="hs-identifier">ic</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103475"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-comment">-- use the interactive dflags</span><span>
</span><a name="line-193"></a><span>        </span><a name="local-6989586621685103477"><a href="#local-6989586621685103477"><span class="hs-identifier">idflags'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_dflags</span><span> </span><a href="#local-6989586621685103476"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">wopt_unset</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Opt_WarnUnusedLocalBinds</span><span>
</span><a name="line-194"></a><span>        </span><a name="local-6989586621685103478"><a href="#local-6989586621685103478"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInteractiveHscEnv</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103475"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103476"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103477"><span class="hs-identifier hs-var">idflags'</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621685103479"><a href="#local-6989586621685103479"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscParsedStmt"><span class="hs-identifier hs-var">hscParsedStmt</span></a><span> </span><a href="#local-6989586621685103478"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><a href="#local-6989586621685103469"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103479"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-199"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-comment">-- empty statement / comment</span><span>
</span><a name="line-201"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExecComplete</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103480"><a href="#local-6989586621685103480"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103481"><a href="#local-6989586621685103481"><span class="hs-identifier">hval</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103482"><a href="#local-6989586621685103482"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>        </span><a href="InteractiveEval.html#updateFixityEnv"><span class="hs-identifier hs-var">updateFixityEnv</span></a><span> </span><a href="#local-6989586621685103482"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>        </span><a name="local-6989586621685103483"><a href="#local-6989586621685103483"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-206"></a><span>          </span><a href="InteractiveEval.html#withVirtualCWD"><span class="hs-identifier hs-var">withVirtualCWD</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-207"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-208"></a><span>              </span><a href="GHCi.html#evalStmt"><span class="hs-identifier hs-var">evalStmt</span></a><span> </span><a href="#local-6989586621685103478"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStep</span><span> </span><a href="#local-6989586621685103471"><span class="hs-identifier hs-var">execSingleStep</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103474"><span class="hs-identifier hs-var">execWrap</span></a><span> </span><a href="#local-6989586621685103481"><span class="hs-identifier hs-var">hval</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103484"><a href="#local-6989586621685103484"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103475"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-211"></a><span>            </span><a name="local-6989586621685103485"><a href="#local-6989586621685103485"><span class="hs-identifier">bindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621685103484"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><a href="#local-6989586621685103484"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>            </span><a name="local-6989586621685103486"><a href="#local-6989586621685103486"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghciHistSize</span><span> </span><a href="#local-6989586621685103477"><span class="hs-identifier hs-var">idflags'</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>        </span><a href="InteractiveEval.html#handleRunStatus"><span class="hs-identifier hs-var">handleRunStatus</span></a><span> </span><a href="#local-6989586621685103471"><span class="hs-identifier hs-var">execSingleStep</span></a><span> </span><a href="#local-6989586621685103470"><span class="hs-identifier hs-var">stmt_text</span></a><span> </span><a href="#local-6989586621685103485"><span class="hs-identifier hs-var">bindings</span></a><span> </span><a href="#local-6989586621685103480"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-216"></a><span>                        </span><a href="#local-6989586621685103483"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#emptyHistory"><span class="hs-identifier hs-var">emptyHistory</span></a><span> </span><a href="#local-6989586621685103486"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-identifier">runDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103422"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103422"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-219"></a><a name="runDecls"><a href="InteractiveEval.html#runDecls"><span class="hs-identifier">runDecls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#runDeclsWithLocation"><span class="hs-identifier hs-var">runDeclsWithLocation</span></a><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">-- | Run some declarations and return any user-visible names that were brought</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- into scope.</span><span>
</span><a name="line-223"></a><span class="hs-identifier">runDeclsWithLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103421"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103421"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-224"></a><a name="runDeclsWithLocation"><a href="InteractiveEval.html#runDeclsWithLocation"><span class="hs-identifier">runDeclsWithLocation</span></a></a><span> </span><a name="local-6989586621685103487"><a href="#local-6989586621685103487"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621685103488"><a href="#local-6989586621685103488"><span class="hs-identifier">line_num</span></a></a><span> </span><a name="local-6989586621685103489"><a href="#local-6989586621685103489"><span class="hs-identifier">input</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>    </span><a name="local-6989586621685103490"><a href="#local-6989586621685103490"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-226"></a><span>    </span><a name="local-6989586621685103491"><a href="#local-6989586621685103491"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="HscMain.html#hscParseDeclsWithLocation"><span class="hs-identifier hs-var">hscParseDeclsWithLocation</span></a><span> </span><a href="#local-6989586621685103490"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103487"><span class="hs-identifier hs-var">source</span></a><span> </span><a href="#local-6989586621685103488"><span class="hs-identifier hs-var">line_num</span></a><span> </span><a href="#local-6989586621685103489"><span class="hs-identifier hs-var">input</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>    </span><a href="InteractiveEval.html#runParsedDecls"><span class="hs-identifier hs-var">runParsedDecls</span></a><span> </span><a href="#local-6989586621685103491"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">-- | Like `runDeclsWithLocation`, but takes parsed declarations as argument.</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- Useful when doing preprocessing on the AST before execution, e.g. in GHCi</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- (see GHCi.UI.runStmt).</span><span>
</span><a name="line-232"></a><span class="hs-identifier">runParsedDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103420"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103420"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-233"></a><a name="runParsedDecls"><a href="InteractiveEval.html#runParsedDecls"><span class="hs-identifier">runParsedDecls</span></a></a><span> </span><a name="local-6989586621685103492"><a href="#local-6989586621685103492"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-234"></a><span>    </span><a name="local-6989586621685103493"><a href="#local-6989586621685103493"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-235"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685103494"><a href="#local-6989586621685103494"><span class="hs-identifier">tyThings</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103495"><a href="#local-6989586621685103495"><span class="hs-identifier">ic</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="HscMain.html#hscParsedDecls"><span class="hs-identifier hs-var">hscParsedDecls</span></a><span> </span><a href="#local-6989586621685103493"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103492"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>    </span><span class="hs-identifier hs-var">setSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685103493"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103495"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-238"></a><span>    </span><a name="local-6989586621685103496"><a href="#local-6989586621685103496"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621685103497"><a href="#local-6989586621685103497"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="InteractiveEval.html#rttiEnvironment"><span class="hs-identifier hs-var">rttiEnvironment</span></a><span> </span><a href="#local-6989586621685103496"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-240"></a><span>    </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103497"><span class="hs-identifier hs-var">hsc_env'</span></a><span>
</span><a name="line-241"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isDerivedOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>             </span><span class="hs-comment">-- For this filter, see Note [What to show to users]</span><span>
</span><a name="line-243"></a><span>           </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621685103494"><span class="hs-identifier hs-var">tyThings</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-comment">{- Note [What to show to users]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't want to display internally-generated bindings to users.
Things like the coercion axiom for newtypes. These bindings all get
OccNames that users can't write, to avoid the possibility of name
clashes (in linker symbols).  That gives a convenient way to suppress
them. The relevant predicate is OccName.isDerivedOccName.
See Trac #11051 for more background and examples.
-}</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">withVirtualCWD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103418"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103418"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621685103419"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103418"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621685103419"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-256"></a><a name="withVirtualCWD"><a href="InteractiveEval.html#withVirtualCWD"><span class="hs-identifier">withVirtualCWD</span></a></a><span> </span><a name="local-6989586621685103498"><a href="#local-6989586621685103498"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-257"></a><span>  </span><a name="local-6989586621685103499"><a href="#local-6989586621685103499"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span>    </span><span class="hs-comment">-- a virtual CWD is only necessary when we're running interpreted code in</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-comment">-- the same process as the compiler.</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103499"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685103498"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103500"><a href="#local-6989586621685103500"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103499"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103501"><a href="#local-6989586621685103501"><span class="hs-identifier">set_cwd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-265"></a><span>        </span><a name="local-6989586621685103503"><a href="#local-6989586621685103503"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-266"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ic_cwd</span><span> </span><a href="#local-6989586621685103500"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-267"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103504"><a href="#local-6989586621685103504"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">setCurrentDirectory</span><span> </span><a href="#local-6989586621685103504"><span class="hs-identifier hs-var">dir</span></a><span>
</span><a name="line-268"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685103503"><span class="hs-identifier hs-var">dir</span></a><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>      </span><a name="local-6989586621685103502"><a href="#local-6989586621685103502"><span class="hs-identifier">reset_cwd</span></a></a><span> </span><a name="local-6989586621685103505"><a href="#local-6989586621685103505"><span class="hs-identifier">orig_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-272"></a><span>        </span><a name="local-6989586621685103506"><a href="#local-6989586621685103506"><span class="hs-identifier">virt_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-273"></a><span>        </span><a name="local-6989586621685103507"><a href="#local-6989586621685103507"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-274"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103508"><a href="#local-6989586621685103508"><span class="hs-identifier">old_IC</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103507"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-275"></a><span>        </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103507"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span>  </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103508"><span class="hs-identifier hs-var">old_IC</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_cwd</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685103506"><span class="hs-identifier hs-var">virt_dir</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">setCurrentDirectory</span><span> </span><a href="#local-6989586621685103505"><span class="hs-identifier hs-var">orig_dir</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>  </span><span class="hs-identifier hs-var">gbracket</span><span> </span><a href="#local-6989586621685103501"><span class="hs-identifier hs-var">set_cwd</span></a><span> </span><a href="#local-6989586621685103502"><span class="hs-identifier hs-var">reset_cwd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103498"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-identifier">parseImportDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103417"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103417"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><a name="parseImportDecl"><a href="InteractiveEval.html#parseImportDecl"><span class="hs-identifier">parseImportDecl</span></a></a><span> </span><a name="local-6989586621685103509"><a href="#local-6989586621685103509"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103510"><a href="#local-6989586621685103510"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscImport"><span class="hs-identifier hs-var">hscImport</span></a><span> </span><a href="#local-6989586621685103510"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103509"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-identifier">emptyHistory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><span class="hs-identifier hs-type">History</span><span>
</span><a name="line-284"></a><a name="emptyHistory"><a href="InteractiveEval.html#emptyHistory"><span class="hs-identifier">emptyHistory</span></a></a><span> </span><a name="local-6989586621685103511"><a href="#local-6989586621685103511"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#nilBL"><span class="hs-identifier hs-var">nilBL</span></a><span> </span><a href="#local-6989586621685103511"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span class="hs-identifier">handleRunStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103416"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-287"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SingleStep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-288"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvalStatus_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span>
</span><a name="line-289"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><span class="hs-identifier hs-type">History</span><span>
</span><a name="line-290"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103416"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ExecResult</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><a name="handleRunStatus"><a href="InteractiveEval.html#handleRunStatus"><span class="hs-identifier">handleRunStatus</span></a></a><span> </span><a name="local-6989586621685103512"><a href="#local-6989586621685103512"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621685103513"><a href="#local-6989586621685103513"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621685103514"><a href="#local-6989586621685103514"><span class="hs-identifier">bindings</span></a></a><span> </span><a name="local-6989586621685103515"><a href="#local-6989586621685103515"><span class="hs-identifier">final_ids</span></a></a><span> </span><a name="local-6989586621685103516"><a href="#local-6989586621685103516"><span class="hs-identifier">status</span></a></a><span> </span><a name="local-6989586621685103517"><a href="#local-6989586621685103517"><span class="hs-identifier">history</span></a></a><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">RunAndLogSteps</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103512"><span class="hs-identifier hs-var">step</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103518"><span class="hs-identifier hs-var">tracing</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103519"><span class="hs-identifier hs-var">not_tracing</span></a><span>
</span><a name="line-295"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-296"></a><span>  </span><a name="local-6989586621685103518"><a href="#local-6989586621685103518"><span class="hs-identifier">tracing</span></a></a><span>
</span><a name="line-297"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">EvalBreak</span><span> </span><a name="local-6989586621685103520"><a href="#local-6989586621685103520"><span class="hs-identifier">is_exception</span></a></a><span> </span><a name="local-6989586621685103521"><a href="#local-6989586621685103521"><span class="hs-identifier">apStack_ref</span></a></a><span> </span><a name="local-6989586621685103522"><a href="#local-6989586621685103522"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621685103523"><a href="#local-6989586621685103523"><span class="hs-identifier">mod_uniq</span></a></a><span> </span><a name="local-6989586621685103524"><a href="#local-6989586621685103524"><span class="hs-identifier">resume_ctxt</span></a></a><span> </span><a name="local-6989586621685103525"><a href="#local-6989586621685103525"><span class="hs-identifier">_ccs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103516"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-298"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685103520"><span class="hs-identifier hs-var">is_exception</span></a><span>
</span><a name="line-299"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-300"></a><span>       </span><a name="local-6989586621685103526"><a href="#local-6989586621685103526"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-301"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103527"><a href="#local-6989586621685103527"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;handleRunStatus&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-302"></a><span>                   </span><span class="hs-identifier hs-var">lookupHptDirectly</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103526"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUniqueGrimily</span><span> </span><a href="#local-6989586621685103523"><span class="hs-identifier hs-var">mod_uniq</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>           </span><a name="local-6989586621685103528"><a href="#local-6989586621685103528"><span class="hs-identifier">modl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hm_iface</span><span> </span><a href="#local-6989586621685103527"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>           </span><a name="local-6989586621685103529"><a href="#local-6989586621685103529"><span class="hs-identifier">breaks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#getModBreaks"><span class="hs-identifier hs-var">getModBreaks</span></a><span> </span><a href="#local-6989586621685103527"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>       </span><a name="local-6989586621685103530"><a href="#local-6989586621685103530"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-308"></a><span>              </span><a href="GHCi.html#breakpointStatus"><span class="hs-identifier hs-var">breakpointStatus</span></a><span> </span><a href="#local-6989586621685103526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">modBreaks_flags</span><span> </span><a href="#local-6989586621685103529"><span class="hs-identifier hs-var">breaks</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103522"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-309"></a><span>       </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685103530"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-310"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685103519"><span class="hs-identifier hs-var">not_tracing</span></a><span>
</span><a name="line-311"></a><span>           </span><span class="hs-comment">-- This breakpoint is explicitly enabled; we want to stop</span><span>
</span><a name="line-312"></a><span>           </span><span class="hs-comment">-- instead of just logging it.</span><span>
</span><a name="line-313"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>           </span><a name="local-6989586621685103531"><a href="#local-6989586621685103531"><span class="hs-identifier">apStack_fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621685103526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103521"><span class="hs-identifier hs-var">apStack_ref</span></a><span>
</span><a name="line-315"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103532"><a href="#local-6989586621685103532"><span class="hs-identifier">bi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BreakInfo</span><span> </span><a href="#local-6989586621685103528"><span class="hs-identifier hs-var">modl</span></a><span> </span><a href="#local-6989586621685103522"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-316"></a><span>               </span><span class="hs-glyph">!</span><a name="local-6989586621685103533"><a href="#local-6989586621685103533"><span class="hs-identifier">history'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#mkHistory"><span class="hs-identifier hs-var">mkHistory</span></a><span> </span><a href="#local-6989586621685103526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103531"><span class="hs-identifier hs-var">apStack_fhv</span></a><span> </span><a href="#local-6989586621685103532"><span class="hs-identifier hs-var">bi</span></a><span> </span><span class="hs-special">`</span><a href="InteractiveEval.html#consBL"><span class="hs-identifier hs-var">consBL</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621685103517"><span class="hs-identifier hs-var">history</span></a><span>
</span><a name="line-317"></a><span>                 </span><span class="hs-comment">-- history is strict, otherwise our BoundedList is pointless.</span><span>
</span><a name="line-318"></a><span>           </span><a name="local-6989586621685103534"><a href="#local-6989586621685103534"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621685103526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103524"><span class="hs-identifier hs-var">resume_ctxt</span></a><span>
</span><a name="line-319"></a><span>           </span><a name="local-6989586621685103535"><a href="#local-6989586621685103535"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#resumeStmt"><span class="hs-identifier hs-var">GHCi.resumeStmt</span></a><span> </span><a href="#local-6989586621685103526"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621685103534"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-320"></a><span>           </span><a href="InteractiveEval.html#handleRunStatus"><span class="hs-identifier hs-var">handleRunStatus</span></a><span> </span><span class="hs-identifier hs-var">RunAndLogSteps</span><span> </span><a href="#local-6989586621685103513"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621685103514"><span class="hs-identifier hs-var">bindings</span></a><span> </span><a href="#local-6989586621685103515"><span class="hs-identifier hs-var">final_ids</span></a><span>
</span><a name="line-321"></a><span>                           </span><a href="#local-6989586621685103535"><span class="hs-identifier hs-var">status</span></a><span> </span><a href="#local-6989586621685103533"><span class="hs-identifier hs-var">history'</span></a><span>
</span><a name="line-322"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103519"><span class="hs-identifier hs-var">not_tracing</span></a><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span>  </span><a name="local-6989586621685103519"><a href="#local-6989586621685103519"><span class="hs-identifier">not_tracing</span></a></a><span>
</span><a name="line-326"></a><span>    </span><span class="hs-comment">-- Hit a breakpoint</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">EvalBreak</span><span> </span><a name="local-6989586621685103536"><a href="#local-6989586621685103536"><span class="hs-identifier">is_exception</span></a></a><span> </span><a name="local-6989586621685103537"><a href="#local-6989586621685103537"><span class="hs-identifier">apStack_ref</span></a></a><span> </span><a name="local-6989586621685103538"><a href="#local-6989586621685103538"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621685103539"><a href="#local-6989586621685103539"><span class="hs-identifier">mod_uniq</span></a></a><span> </span><a name="local-6989586621685103540"><a href="#local-6989586621685103540"><span class="hs-identifier">resume_ctxt</span></a></a><span> </span><a name="local-6989586621685103541"><a href="#local-6989586621685103541"><span class="hs-identifier">ccs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103516"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-329"></a><span>         </span><a name="local-6989586621685103542"><a href="#local-6989586621685103542"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-330"></a><span>         </span><a name="local-6989586621685103543"><a href="#local-6989586621685103543"><span class="hs-identifier">resume_ctxt_fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621685103542"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103540"><span class="hs-identifier hs-var">resume_ctxt</span></a><span>
</span><a name="line-331"></a><span>         </span><a name="local-6989586621685103544"><a href="#local-6989586621685103544"><span class="hs-identifier">apStack_fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621685103542"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103537"><span class="hs-identifier hs-var">apStack_ref</span></a><span>
</span><a name="line-332"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103545"><a href="#local-6989586621685103545"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;handleRunStatus&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-333"></a><span>                     </span><span class="hs-identifier hs-var">lookupHptDirectly</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103542"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUniqueGrimily</span><span> </span><a href="#local-6989586621685103539"><span class="hs-identifier hs-var">mod_uniq</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>             </span><a name="local-6989586621685103546"><a href="#local-6989586621685103546"><span class="hs-identifier">modl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hm_iface</span><span> </span><a href="#local-6989586621685103545"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>             </span><a name="local-6989586621685103547"><a href="#local-6989586621685103547"><span class="hs-identifier">bp</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685103536"><span class="hs-identifier hs-var">is_exception</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-337"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BreakInfo</span><span> </span><a href="#local-6989586621685103546"><span class="hs-identifier hs-var">modl</span></a><span> </span><a href="#local-6989586621685103538"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621685103548"><a href="#local-6989586621685103548"><span class="hs-identifier">hsc_env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103549"><a href="#local-6989586621685103549"><span class="hs-identifier">names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103550"><a href="#local-6989586621685103550"><span class="hs-identifier">span</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103551"><a href="#local-6989586621685103551"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-339"></a><span>           </span><a href="InteractiveEval.html#bindLocalsAtBreakpoint"><span class="hs-identifier hs-var">bindLocalsAtBreakpoint</span></a><span> </span><a href="#local-6989586621685103542"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103544"><span class="hs-identifier hs-var">apStack_fhv</span></a><span> </span><a href="#local-6989586621685103547"><span class="hs-identifier hs-var">bp</span></a><span>
</span><a name="line-340"></a><span>         </span><span class="hs-keyword">let</span><span>
</span><a name="line-341"></a><span>           </span><a name="local-6989586621685103552"><a href="#local-6989586621685103552"><span class="hs-identifier">resume</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Resume</span><span>
</span><a name="line-342"></a><span>             </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">resumeStmt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103513"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeContext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103543"><span class="hs-identifier hs-var">resume_ctxt_fhv</span></a><span>
</span><a name="line-343"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeBindings</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103514"><span class="hs-identifier hs-var">bindings</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeFinalIds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103515"><span class="hs-identifier hs-var">final_ids</span></a><span>
</span><a name="line-344"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeApStack</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103544"><span class="hs-identifier hs-var">apStack_fhv</span></a><span>
</span><a name="line-345"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeBreakInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103547"><span class="hs-identifier hs-var">bp</span></a><span>
</span><a name="line-346"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeSpan</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103550"><span class="hs-identifier hs-var">span</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeHistory</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#toListBL"><span class="hs-identifier hs-var">toListBL</span></a><span> </span><a href="#local-6989586621685103517"><span class="hs-identifier hs-var">history</span></a><span>
</span><a name="line-347"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeDecl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103551"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-348"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeCCS</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103541"><span class="hs-identifier hs-var">ccs</span></a><span>
</span><a name="line-349"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeHistoryIx</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-350"></a><span>           </span><a name="local-6989586621685103553"><a href="#local-6989586621685103553"><span class="hs-identifier">hsc_env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#pushResume"><span class="hs-identifier hs-var">pushResume</span></a><span> </span><a href="#local-6989586621685103548"><span class="hs-identifier hs-var">hsc_env1</span></a><span> </span><a href="#local-6989586621685103552"><span class="hs-identifier hs-var">resume</span></a><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>         </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103553"><span class="hs-identifier hs-var">hsc_env2</span></a><span>
</span><a name="line-353"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExecBreak</span><span> </span><a href="#local-6989586621685103549"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621685103547"><span class="hs-identifier hs-var">bp</span></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>    </span><span class="hs-comment">-- Completed successfully</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">EvalComplete</span><span> </span><a name="local-6989586621685103558"><a href="#local-6989586621685103558"><span class="hs-identifier">allocs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalSuccess</span><span> </span><a name="local-6989586621685103559"><a href="#local-6989586621685103559"><span class="hs-identifier">hvals</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103516"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685103560"><a href="#local-6989586621685103560"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-358"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103561"><a href="#local-6989586621685103561"><span class="hs-identifier">final_ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInteractiveContextWithIds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103560"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103515"><span class="hs-identifier hs-var">final_ids</span></a><span>
</span><a name="line-359"></a><span>             </span><a name="local-6989586621685103562"><a href="#local-6989586621685103562"><span class="hs-identifier">final_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621685103515"><span class="hs-identifier hs-var">final_ids</span></a><span>
</span><a name="line-360"></a><span>         </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Linker.html#extendLinkEnv"><span class="hs-identifier hs-var">Linker.extendLinkEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685103562"><span class="hs-identifier hs-var">final_names</span></a><span> </span><a href="#local-6989586621685103559"><span class="hs-identifier hs-var">hvals</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>         </span><a name="local-6989586621685103563"><a href="#local-6989586621685103563"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="InteractiveEval.html#rttiEnvironment"><span class="hs-identifier hs-var">rttiEnvironment</span></a><span> </span><a href="#local-6989586621685103560"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span class="hs-identifier">hsc_IC</span><span class="hs-glyph">=</span><a href="#local-6989586621685103561"><span class="hs-identifier hs-var">final_ic</span></a><span class="hs-special">}</span><span>
</span><a name="line-362"></a><span>         </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103563"><span class="hs-identifier hs-var">hsc_env'</span></a><span>
</span><a name="line-363"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExecComplete</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621685103562"><span class="hs-identifier hs-var">final_names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103558"><span class="hs-identifier hs-var">allocs</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>    </span><span class="hs-comment">-- Completed with an exception</span><span>
</span><a name="line-366"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">EvalComplete</span><span> </span><a name="local-6989586621685103564"><a href="#local-6989586621685103564"><span class="hs-identifier">alloc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalException</span><span> </span><a name="local-6989586621685103565"><a href="#local-6989586621685103565"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103516"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-367"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExecComplete</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSerializableException</span><span> </span><a href="#local-6989586621685103565"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103564"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-370"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;not_tracing&quot;</span><span> </span><span class="hs-comment">-- actually exhaustive, but GHC can't tell</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-identifier">resumeExec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103415"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SingleStep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103415"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ExecResult</span><span>
</span><a name="line-374"></a><a name="resumeExec"><a href="InteractiveEval.html#resumeExec"><span class="hs-identifier">resumeExec</span></a></a><span> </span><a name="local-6989586621685103566"><a href="#local-6989586621685103566"><span class="hs-identifier">canLogSpan</span></a></a><span> </span><a name="local-6989586621685103567"><a href="#local-6989586621685103567"><span class="hs-identifier">step</span></a></a><span>
</span><a name="line-375"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-376"></a><span>   </span><a name="local-6989586621685103568"><a href="#local-6989586621685103568"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-377"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103569"><a href="#local-6989586621685103569"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103568"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-378"></a><span>       </span><a name="local-6989586621685103570"><a href="#local-6989586621685103570"><span class="hs-identifier">resume</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><a href="#local-6989586621685103569"><span class="hs-identifier hs-var">ic</span></a><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103570"><span class="hs-identifier hs-var">resume</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-381"></a><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-382"></a><span>           </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;not stopped at a breakpoint&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621685103571"><a href="#local-6989586621685103571"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685103572"><a href="#local-6989586621685103572"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-384"></a><span>        </span><span class="hs-comment">-- unbind the temporary locals by restoring the TypeEnv from</span><span>
</span><a name="line-385"></a><span>        </span><span class="hs-comment">-- before the breakpoint, and drop this Resume from the</span><span>
</span><a name="line-386"></a><span>        </span><span class="hs-comment">-- InteractiveContext.</span><span>
</span><a name="line-387"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103573"><a href="#local-6989586621685103573"><span class="hs-identifier">resume_tmp_te</span></a></a><span class="hs-special">,</span><a name="local-6989586621685103574"><a href="#local-6989586621685103574"><span class="hs-identifier">resume_rdr_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">resumeBindings</span><span> </span><a href="#local-6989586621685103571"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-388"></a><span>            </span><a name="local-6989586621685103575"><a href="#local-6989586621685103575"><span class="hs-identifier">ic'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103569"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_tythings</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103573"><span class="hs-identifier hs-var">resume_tmp_te</span></a><span class="hs-special">,</span><span>
</span><a name="line-389"></a><span>                       </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103574"><span class="hs-identifier hs-var">resume_rdr_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-390"></a><span>                       </span><span class="hs-identifier">ic_resume</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103572"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-391"></a><span>        </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103568"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103575"><span class="hs-identifier hs-var">ic'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span>        </span><span class="hs-comment">-- remove any bindings created since the breakpoint from the</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-comment">-- linker's environment</span><span>
</span><a name="line-395"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103576"><a href="#local-6989586621685103576"><span class="hs-identifier">old_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621685103573"><span class="hs-identifier hs-var">resume_tmp_te</span></a><span>
</span><a name="line-396"></a><span>            </span><a name="local-6989586621685103577"><a href="#local-6989586621685103577"><span class="hs-identifier">new_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685103579"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685103578"><a href="#local-6989586621685103578"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621685103569"><span class="hs-identifier hs-var">ic</span></a><span>
</span><a name="line-397"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103579"><a href="#local-6989586621685103579"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621685103578"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-398"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103579"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685103576"><span class="hs-identifier hs-var">old_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-399"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Linker.html#deleteFromLinkEnv"><span class="hs-identifier hs-var">Linker.deleteFromLinkEnv</span></a><span> </span><a href="#local-6989586621685103577"><span class="hs-identifier hs-var">new_names</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103571"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-402"></a><span>          </span><span class="hs-identifier hs-var">Resume</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">resumeStmt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103580"><a href="#local-6989586621685103580"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeContext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103581"><a href="#local-6989586621685103581"><span class="hs-identifier">fhv</span></a></a><span>
</span><a name="line-403"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeBindings</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103582"><a href="#local-6989586621685103582"><span class="hs-identifier">bindings</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeFinalIds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103583"><a href="#local-6989586621685103583"><span class="hs-identifier">final_ids</span></a></a><span>
</span><a name="line-404"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeApStack</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103584"><a href="#local-6989586621685103584"><span class="hs-identifier">apStack</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeBreakInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103585"><a href="#local-6989586621685103585"><span class="hs-identifier">mb_brkpt</span></a></a><span>
</span><a name="line-405"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeSpan</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103586"><a href="#local-6989586621685103586"><span class="hs-identifier">span</span></a></a><span>
</span><a name="line-406"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">resumeHistory</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103587"><a href="#local-6989586621685103587"><span class="hs-identifier">hist</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-407"></a><span>               </span><a href="InteractiveEval.html#withVirtualCWD"><span class="hs-identifier hs-var">withVirtualCWD</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-408"></a><span>                </span><a name="local-6989586621685103588"><a href="#local-6989586621685103588"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#resumeStmt"><span class="hs-identifier hs-var">GHCi.resumeStmt</span></a><span> </span><a href="#local-6989586621685103568"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStep</span><span> </span><a href="#local-6989586621685103567"><span class="hs-identifier hs-var">step</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103581"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-409"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103589"><a href="#local-6989586621685103589"><span class="hs-identifier">prevHistoryLst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#fromListBL"><span class="hs-identifier hs-var">fromListBL</span></a><span> </span><span class="hs-number">50</span><span> </span><a href="#local-6989586621685103587"><span class="hs-identifier hs-var">hist</span></a><span>
</span><a name="line-410"></a><span>                    </span><a name="local-6989586621685103590"><a href="#local-6989586621685103590"><span class="hs-identifier">hist'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103585"><span class="hs-identifier hs-var">mb_brkpt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-411"></a><span>                       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103589"><span class="hs-identifier hs-var">prevHistoryLst</span></a><span>
</span><a name="line-412"></a><span>                       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103591"><a href="#local-6989586621685103591"><span class="hs-identifier">bi</span></a></a><span>
</span><a name="line-413"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><a href="#local-6989586621685103566"><span class="hs-identifier hs-var">canLogSpan</span></a><span> </span><a href="#local-6989586621685103586"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103589"><span class="hs-identifier hs-var">prevHistoryLst</span></a><span>
</span><a name="line-414"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#mkHistory"><span class="hs-identifier hs-var">mkHistory</span></a><span> </span><a href="#local-6989586621685103568"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103584"><span class="hs-identifier hs-var">apStack</span></a><span> </span><a href="#local-6989586621685103591"><span class="hs-identifier hs-var">bi</span></a><span> </span><span class="hs-special">`</span><a href="InteractiveEval.html#consBL"><span class="hs-identifier hs-var">consBL</span></a><span class="hs-special">`</span><span>
</span><a name="line-415"></a><span>                                                        </span><a href="InteractiveEval.html#fromListBL"><span class="hs-identifier hs-var">fromListBL</span></a><span> </span><span class="hs-number">50</span><span> </span><a href="#local-6989586621685103587"><span class="hs-identifier hs-var">hist</span></a><span>
</span><a name="line-416"></a><span>                </span><a href="InteractiveEval.html#handleRunStatus"><span class="hs-identifier hs-var">handleRunStatus</span></a><span> </span><a href="#local-6989586621685103567"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621685103580"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621685103582"><span class="hs-identifier hs-var">bindings</span></a><span> </span><a href="#local-6989586621685103583"><span class="hs-identifier hs-var">final_ids</span></a><span> </span><a href="#local-6989586621685103588"><span class="hs-identifier hs-var">status</span></a><span> </span><a href="#local-6989586621685103590"><span class="hs-identifier hs-var">hist'</span></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-identifier">back</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103414"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103414"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-419"></a><a name="back"><a href="InteractiveEval.html#back"><span class="hs-identifier">back</span></a></a><span> </span><a name="local-6989586621685103592"><a href="#local-6989586621685103592"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#moveHist"><span class="hs-identifier hs-var">moveHist</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621685103592"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-identifier">forward</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103413"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103413"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-422"></a><a name="forward"><a href="InteractiveEval.html#forward"><span class="hs-identifier">forward</span></a></a><span> </span><a name="local-6989586621685103593"><a href="#local-6989586621685103593"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#moveHist"><span class="hs-identifier hs-var">moveHist</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">subtract</span><span> </span><a href="#local-6989586621685103593"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-identifier">moveHist</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103412"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103412"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-425"></a><a name="moveHist"><a href="InteractiveEval.html#moveHist"><span class="hs-identifier">moveHist</span></a></a><span> </span><a name="local-6989586621685103594"><a href="#local-6989586621685103594"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>  </span><a name="local-6989586621685103595"><a href="#local-6989586621685103595"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-427"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103595"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-428"></a><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-429"></a><span>           </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;not stopped at a breakpoint&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621685103596"><a href="#local-6989586621685103596"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685103597"><a href="#local-6989586621685103597"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-431"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103598"><a href="#local-6989586621685103598"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">resumeHistoryIx</span><span> </span><a href="#local-6989586621685103596"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-432"></a><span>            </span><a name="local-6989586621685103599"><a href="#local-6989586621685103599"><span class="hs-identifier">history</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">resumeHistory</span><span> </span><a href="#local-6989586621685103596"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-433"></a><span>            </span><a name="local-6989586621685103600"><a href="#local-6989586621685103600"><span class="hs-identifier">new_ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103594"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621685103598"><span class="hs-identifier hs-var">ix</span></a><span>
</span><a name="line-434"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103599"><span class="hs-identifier hs-var">history</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthLessThan</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685103600"><span class="hs-identifier hs-var">new_ix</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-436"></a><span>           </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;no more logged breakpoints&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103600"><span class="hs-identifier hs-var">new_ix</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-438"></a><span>           </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;already at the beginning of the history&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-441"></a><span>          </span><a name="local-6989586621685103601"><a href="#local-6989586621685103601"><span class="hs-identifier">update_ic</span></a></a><span> </span><a name="local-6989586621685103602"><a href="#local-6989586621685103602"><span class="hs-identifier">apStack</span></a></a><span> </span><a name="local-6989586621685103603"><a href="#local-6989586621685103603"><span class="hs-identifier">mb_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-442"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621685103604"><a href="#local-6989586621685103604"><span class="hs-identifier">hsc_env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103605"><a href="#local-6989586621685103605"><span class="hs-identifier">names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103606"><a href="#local-6989586621685103606"><span class="hs-identifier">span</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103607"><a href="#local-6989586621685103607"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-443"></a><span>              </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="InteractiveEval.html#bindLocalsAtBreakpoint"><span class="hs-identifier hs-var">bindLocalsAtBreakpoint</span></a><span> </span><a href="#local-6989586621685103595"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103602"><span class="hs-identifier hs-var">apStack</span></a><span> </span><a href="#local-6989586621685103603"><span class="hs-identifier hs-var">mb_info</span></a><span>
</span><a name="line-444"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103608"><a href="#local-6989586621685103608"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103604"><span class="hs-identifier hs-var">hsc_env1</span></a><span>
</span><a name="line-445"></a><span>                </span><a name="local-6989586621685103609"><a href="#local-6989586621685103609"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103596"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">resumeHistoryIx</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103600"><span class="hs-identifier hs-var">new_ix</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>                </span><a name="local-6989586621685103610"><a href="#local-6989586621685103610"><span class="hs-identifier">ic'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103608"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103609"><span class="hs-identifier hs-var">r'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685103597"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span>            </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103604"><span class="hs-identifier hs-var">hsc_env1</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103610"><span class="hs-identifier hs-var">ic'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103605"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103600"><span class="hs-identifier hs-var">new_ix</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103606"><span class="hs-identifier hs-var">span</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103607"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>        </span><span class="hs-comment">-- careful: we want apStack to be the AP_STACK itself, not a thunk</span><span>
</span><a name="line-453"></a><span>        </span><span class="hs-comment">-- around it, hence the cases are carefully constructed below to</span><span>
</span><a name="line-454"></a><span>        </span><span class="hs-comment">-- make this the case.  ToDo: this is v. fragile, do something better.</span><span>
</span><a name="line-455"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685103600"><span class="hs-identifier hs-var">new_ix</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-456"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103596"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-457"></a><span>                   </span><span class="hs-identifier hs-var">Resume</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">resumeApStack</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103611"><a href="#local-6989586621685103611"><span class="hs-identifier">apStack</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-458"></a><span>                            </span><span class="hs-identifier">resumeBreakInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103612"><a href="#local-6989586621685103612"><span class="hs-identifier">mb_brkpt</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-459"></a><span>                          </span><a href="#local-6989586621685103601"><span class="hs-identifier hs-var">update_ic</span></a><span> </span><a href="#local-6989586621685103611"><span class="hs-identifier hs-var">apStack</span></a><span> </span><a href="#local-6989586621685103612"><span class="hs-identifier hs-var">mb_brkpt</span></a><span>
</span><a name="line-460"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103599"><span class="hs-identifier hs-var">history</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103600"><span class="hs-identifier hs-var">new_ix</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-461"></a><span>                   </span><span class="hs-identifier hs-var">History</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-462"></a><span>                     </span><a href="#local-6989586621685103601"><span class="hs-identifier hs-var">update_ic</span></a><span> </span><a href="#local-6989586621685103613"><span class="hs-identifier hs-var">historyApStack</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685103614"><span class="hs-identifier hs-var">historyBreakInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- After stopping at a breakpoint, add free variables to the environment</span><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span class="hs-identifier">result_fs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>
</span><a name="line-469"></a><a name="result_fs"><a href="InteractiveEval.html#result_fs"><span class="hs-identifier">result_fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;_result&quot;</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span class="hs-identifier">bindLocalsAtBreakpoint</span><span>
</span><a name="line-472"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-473"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-474"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">BreakInfo</span><span>
</span><a name="line-475"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">-- Nothing case: we stopped when an exception was raised, not at a</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- breakpoint.  We have no location information or local variables to</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- bind, all we can do is bind a local variable to the exception</span><span>
</span><a name="line-480"></a><span class="hs-comment">-- value.</span><span>
</span><a name="line-481"></a><a name="bindLocalsAtBreakpoint"><a href="InteractiveEval.html#bindLocalsAtBreakpoint"><span class="hs-identifier">bindLocalsAtBreakpoint</span></a></a><span> </span><a name="local-6989586621685103616"><a href="#local-6989586621685103616"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103617"><a href="#local-6989586621685103617"><span class="hs-identifier">apStack</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-482"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103618"><a href="#local-6989586621685103618"><span class="hs-identifier">exn_occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;_exception&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>       </span><a name="local-6989586621685103619"><a href="#local-6989586621685103619"><span class="hs-identifier">span</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkGeneralSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;&lt;unknown&gt;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>   </span><a name="local-6989586621685103620"><a href="#local-6989586621685103620"><span class="hs-identifier">exn_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IfaceEnv.html#newInteractiveBinder"><span class="hs-identifier hs-var">newInteractiveBinder</span></a><span> </span><a href="#local-6989586621685103616"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103618"><span class="hs-identifier hs-var">exn_occ</span></a><span> </span><a href="#local-6989586621685103619"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103621"><a href="#local-6989586621685103621"><span class="hs-identifier">e_fs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;e&quot;</span><span>
</span><a name="line-487"></a><span>       </span><a name="local-6989586621685103622"><a href="#local-6989586621685103622"><span class="hs-identifier">e_name</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621685103621"><span class="hs-identifier hs-var">e_fs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarOccFS</span><span> </span><a href="#local-6989586621685103621"><span class="hs-identifier hs-var">e_fs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103619"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-488"></a><span>       </span><a name="local-6989586621685103623"><a href="#local-6989586621685103623"><span class="hs-identifier">e_tyvar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#mkRuntimeUnkTyVar"><span class="hs-identifier hs-var">mkRuntimeUnkTyVar</span></a><span> </span><a href="#local-6989586621685103622"><span class="hs-identifier hs-var">e_name</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-489"></a><span>       </span><a name="local-6989586621685103624"><a href="#local-6989586621685103624"><span class="hs-identifier">exn_id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Id.mkVanillaGlobal</span><span> </span><a href="#local-6989586621685103620"><span class="hs-identifier hs-var">exn_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621685103623"><span class="hs-identifier hs-var">e_tyvar</span></a><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>       </span><a name="local-6989586621685103625"><a href="#local-6989586621685103625"><span class="hs-identifier">ictxt0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103616"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-492"></a><span>       </span><a name="local-6989586621685103626"><a href="#local-6989586621685103626"><span class="hs-identifier">ictxt1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInteractiveContextWithIds</span><span> </span><a href="#local-6989586621685103625"><span class="hs-identifier hs-var">ictxt0</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103624"><span class="hs-identifier hs-var">exn_id</span></a><span class="hs-special">]</span><span>
</span><a name="line-493"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-494"></a><span>   </span><a href="Linker.html#extendLinkEnv"><span class="hs-identifier hs-var">Linker.extendLinkEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621685103620"><span class="hs-identifier hs-var">exn_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103617"><span class="hs-identifier hs-var">apStack</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-495"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103616"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103626"><span class="hs-identifier hs-var">ictxt1</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103620"><span class="hs-identifier hs-var">exn_name</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103619"><span class="hs-identifier hs-var">span</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;&lt;exception thrown&gt;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-comment">-- Just case: we stopped at a breakpoint, we have information about the location</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- of the breakpoint and the free variables of the expression.</span><span>
</span><a name="line-499"></a><span class="hs-identifier">bindLocalsAtBreakpoint</span><span> </span><a name="local-6989586621685103627"><a href="#local-6989586621685103627"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103628"><a href="#local-6989586621685103628"><span class="hs-identifier">apStack_fhv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">BreakInfo</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-500"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-501"></a><span>       </span><a name="local-6989586621685103642"><a href="#local-6989586621685103642"><span class="hs-identifier">hmi</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;bindLocalsAtBreakpoint&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-502"></a><span>                     </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685103629"><span class="hs-identifier hs-var">breakInfo_module</span></a><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>       </span><a name="local-6989586621685103643"><a href="#local-6989586621685103643"><span class="hs-identifier">breaks</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#getModBreaks"><span class="hs-identifier hs-var">getModBreaks</span></a><span> </span><a href="#local-6989586621685103642"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-504"></a><span>       </span><a name="local-6989586621685103644"><a href="#local-6989586621685103644"><span class="hs-identifier">info</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;bindLocalsAtBreakpoint2&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-505"></a><span>                     </span><span class="hs-identifier hs-var">IntMap.lookup</span><span> </span><a href="#local-6989586621685103630"><span class="hs-identifier hs-var">breakInfo_number</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">modBreaks_breakInfo</span><span> </span><a href="#local-6989586621685103643"><span class="hs-identifier hs-var">breaks</span></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>       </span><a name="local-6989586621685103645"><a href="#local-6989586621685103645"><span class="hs-identifier">vars</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgb_vars</span><span> </span><a href="#local-6989586621685103644"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-507"></a><span>       </span><a name="local-6989586621685103646"><a href="#local-6989586621685103646"><span class="hs-identifier">result_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgb_resty</span><span> </span><a href="#local-6989586621685103644"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-508"></a><span>       </span><a name="local-6989586621685103647"><a href="#local-6989586621685103647"><span class="hs-identifier">occs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">modBreaks_vars</span><span> </span><a href="#local-6989586621685103643"><span class="hs-identifier hs-var">breaks</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621685103630"><span class="hs-identifier hs-var">breakInfo_number</span></a><span>
</span><a name="line-509"></a><span>       </span><a name="local-6989586621685103648"><a href="#local-6989586621685103648"><span class="hs-identifier">span</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">modBreaks_locs</span><span> </span><a href="#local-6989586621685103643"><span class="hs-identifier hs-var">breaks</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621685103630"><span class="hs-identifier hs-var">breakInfo_number</span></a><span>
</span><a name="line-510"></a><span>       </span><a name="local-6989586621685103649"><a href="#local-6989586621685103649"><span class="hs-identifier">decl</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;.&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">modBreaks_decls</span><span> </span><a href="#local-6989586621685103643"><span class="hs-identifier hs-var">breaks</span></a><span> </span><span class="hs-glyph">!</span><span> </span><a href="#local-6989586621685103630"><span class="hs-identifier hs-var">breakInfo_number</span></a><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>           </span><span class="hs-comment">-- Filter out any unboxed ids;</span><span>
</span><a name="line-513"></a><span>           </span><span class="hs-comment">-- we can't bind these at the prompt</span><span>
</span><a name="line-514"></a><span>       </span><a name="local-6989586621685103650"><a href="#local-6989586621685103650"><span class="hs-identifier">pointers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621685103655"><a href="#local-6989586621685103655"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103651"><span class="hs-identifier hs-var">isPointer</span></a><span> </span><a href="#local-6989586621685103655"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103645"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-515"></a><span>       </span><a name="local-6989586621685103651"><a href="#local-6989586621685103651"><span class="hs-identifier">isPointer</span></a></a><span> </span><a name="local-6989586621685103656"><a href="#local-6989586621685103656"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><a name="local-6989586621685103657"><a href="#local-6989586621685103657"><span class="hs-identifier">rep</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685103656"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isGcPtrRep</span><span> </span><a href="#local-6989586621685103657"><span class="hs-identifier hs-var">rep</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-517"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621685103652"><a href="#local-6989586621685103652"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103653"><a href="#local-6989586621685103653"><span class="hs-identifier">offsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621685103650"><span class="hs-identifier hs-var">pointers</span></a><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span>       </span><a name="local-6989586621685103654"><a href="#local-6989586621685103654"><span class="hs-identifier">free_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypesList</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103646"><span class="hs-identifier hs-var">result_ty</span></a><span class="hs-glyph">:</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685103652"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>   </span><span class="hs-comment">-- It might be that getIdValFromApStack fails, because the AP_STACK</span><span>
</span><a name="line-524"></a><span>   </span><span class="hs-comment">-- has been accidentally evaluated, or something else has gone wrong.</span><span>
</span><a name="line-525"></a><span>   </span><span class="hs-comment">-- So that we don't fall over in a heap when this happens, just don't</span><span>
</span><a name="line-526"></a><span>   </span><span class="hs-comment">-- bind any free variables instead, and we emit a warning.</span><span>
</span><a name="line-527"></a><span>   </span><a name="local-6989586621685103658"><a href="#local-6989586621685103658"><span class="hs-identifier">mb_hValues</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-528"></a><span>      </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#getBreakpointVar"><span class="hs-identifier hs-var">getBreakpointVar</span></a><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103628"><span class="hs-identifier hs-var">apStack_fhv</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103653"><span class="hs-identifier hs-var">offsets</span></a><span>
</span><a name="line-529"></a><span>   </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621685103658"><span class="hs-identifier hs-var">mb_hValues</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-530"></a><span>      </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-531"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warning: _result has been evaluated, some bindings have been lost&quot;</span><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span>   </span><a name="local-6989586621685103659"><a href="#local-6989586621685103659"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'I'</span><span>   </span><span class="hs-comment">-- Dodgy; will give the same uniques every time</span><span>
</span><a name="line-534"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103660"><a href="#local-6989586621685103660"><span class="hs-identifier">tv_subst</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103632"><span class="hs-identifier hs-var">newTyVars</span></a><span> </span><a href="#local-6989586621685103659"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621685103654"><span class="hs-identifier hs-var">free_tvs</span></a><span>
</span><a name="line-535"></a><span>       </span><a name="local-6989586621685103661"><a href="#local-6989586621685103661"><span class="hs-identifier">filtered_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685103663"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103663"><a href="#local-6989586621685103663"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103664"><a href="#local-6989586621685103664"><span class="hs-identifier">_hv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685103652"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621685103658"><span class="hs-identifier hs-var">mb_hValues</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-536"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621685103662"><a href="#local-6989586621685103662"><span class="hs-identifier">tidy_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyOpenTypes</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-537"></a><span>                      </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621685103660"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103661"><span class="hs-identifier hs-var">filtered_ids</span></a><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>   </span><a name="local-6989586621685103665"><a href="#local-6989586621685103665"><span class="hs-identifier">new_ids</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith3M</span><span> </span><a href="#local-6989586621685103631"><span class="hs-identifier hs-var">mkNewId</span></a><span> </span><a href="#local-6989586621685103647"><span class="hs-identifier hs-var">occs</span></a><span> </span><a href="#local-6989586621685103662"><span class="hs-identifier hs-var">tidy_tys</span></a><span> </span><a href="#local-6989586621685103661"><span class="hs-identifier hs-var">filtered_ids</span></a><span>
</span><a name="line-540"></a><span>   </span><a name="local-6989586621685103666"><a href="#local-6989586621685103666"><span class="hs-identifier">result_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IfaceEnv.html#newInteractiveBinder"><span class="hs-identifier hs-var">newInteractiveBinder</span></a><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOccFS</span><span> </span><a href="InteractiveEval.html#result_fs"><span class="hs-identifier hs-var">result_fs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103648"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103667"><a href="#local-6989586621685103667"><span class="hs-identifier">result_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Id.mkVanillaGlobal</span><span> </span><a href="#local-6989586621685103666"><span class="hs-identifier hs-var">result_name</span></a><span>
</span><a name="line-543"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621685103660"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><a href="#local-6989586621685103646"><span class="hs-identifier hs-var">result_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>       </span><a name="local-6989586621685103668"><a href="#local-6989586621685103668"><span class="hs-identifier">result_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103651"><span class="hs-identifier hs-var">isPointer</span></a><span> </span><a href="#local-6989586621685103667"><span class="hs-identifier hs-var">result_id</span></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span>       </span><a name="local-6989586621685103669"><a href="#local-6989586621685103669"><span class="hs-identifier">final_ids</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685103668"><span class="hs-identifier hs-var">result_ok</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103667"><span class="hs-identifier hs-var">result_id</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685103665"><span class="hs-identifier hs-var">new_ids</span></a><span>
</span><a name="line-547"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103665"><span class="hs-identifier hs-var">new_ids</span></a><span>
</span><a name="line-548"></a><span>       </span><a name="local-6989586621685103670"><a href="#local-6989586621685103670"><span class="hs-identifier">ictxt0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-549"></a><span>       </span><a name="local-6989586621685103671"><a href="#local-6989586621685103671"><span class="hs-identifier">ictxt1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInteractiveContextWithIds</span><span> </span><a href="#local-6989586621685103670"><span class="hs-identifier hs-var">ictxt0</span></a><span> </span><a href="#local-6989586621685103669"><span class="hs-identifier hs-var">final_ids</span></a><span>
</span><a name="line-550"></a><span>       </span><a name="local-6989586621685103672"><a href="#local-6989586621685103672"><span class="hs-identifier">names</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621685103665"><span class="hs-identifier hs-var">new_ids</span></a><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103673"><a href="#local-6989586621685103673"><span class="hs-identifier">fhvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621685103658"><span class="hs-identifier hs-var">mb_hValues</span></a><span>
</span><a name="line-553"></a><span>   </span><a href="Linker.html#extendLinkEnv"><span class="hs-identifier hs-var">Linker.extendLinkEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685103672"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621685103673"><span class="hs-identifier hs-var">fhvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>   </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621685103668"><span class="hs-identifier hs-var">result_ok</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Linker.html#extendLinkEnv"><span class="hs-identifier hs-var">Linker.extendLinkEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621685103666"><span class="hs-identifier hs-var">result_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103628"><span class="hs-identifier hs-var">apStack_fhv</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-555"></a><span>   </span><a name="local-6989586621685103674"><a href="#local-6989586621685103674"><span class="hs-identifier">hsc_env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#rttiEnvironment"><span class="hs-identifier hs-var">rttiEnvironment</span></a><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103671"><span class="hs-identifier hs-var">ictxt1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-556"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103674"><span class="hs-identifier hs-var">hsc_env1</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685103668"><span class="hs-identifier hs-var">result_ok</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685103666"><span class="hs-identifier hs-var">result_name</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685103672"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685103672"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103648"><span class="hs-identifier hs-var">span</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103649"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-558"></a><span>        </span><span class="hs-comment">-- We need a fresh Unique for each Id we bind, because the linker</span><span>
</span><a name="line-559"></a><span>        </span><span class="hs-comment">-- state is single-threaded and otherwise we'd spam old bindings</span><span>
</span><a name="line-560"></a><span>        </span><span class="hs-comment">-- whenever we stop at a breakpoint.  The InteractveContext is properly</span><span>
</span><a name="line-561"></a><span>        </span><span class="hs-comment">-- saved/restored, but not the linker state.  See #1743, test break026.</span><span>
</span><a name="line-562"></a><span>   </span><span class="hs-identifier">mkNewId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-563"></a><span>   </span><a name="local-6989586621685103631"><a href="#local-6989586621685103631"><span class="hs-identifier">mkNewId</span></a></a><span> </span><a name="local-6989586621685103633"><a href="#local-6989586621685103633"><span class="hs-identifier">occ</span></a></a><span> </span><a name="local-6989586621685103634"><a href="#local-6989586621685103634"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621685103635"><a href="#local-6989586621685103635"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-564"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685103636"><a href="#local-6989586621685103636"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IfaceEnv.html#newInteractiveBinder"><span class="hs-identifier hs-var">newInteractiveBinder</span></a><span> </span><a href="#local-6989586621685103627"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103633"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621685103635"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Id.mkVanillaGlobalWithInfo</span><span> </span><a href="#local-6989586621685103636"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685103634"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInfo</span><span> </span><a href="#local-6989586621685103635"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span>   </span><span class="hs-identifier">newTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span>
</span><a name="line-568"></a><span>     </span><span class="hs-comment">-- Similarly, clone the type variables mentioned in the types</span><span>
</span><a name="line-569"></a><span>     </span><span class="hs-comment">-- we have here, *and* make them all RuntimeUnk tyvars</span><span>
</span><a name="line-570"></a><span>   </span><a name="local-6989586621685103632"><a href="#local-6989586621685103632"><span class="hs-identifier">newTyVars</span></a></a><span> </span><a name="local-6989586621685103637"><a href="#local-6989586621685103637"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621685103638"><a href="#local-6989586621685103638"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-571"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTvSubstPrs</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103639"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#mkRuntimeUnkTyVar"><span class="hs-identifier hs-var">mkRuntimeUnkTyVar</span></a><span> </span><a href="#local-6989586621685103641"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621685103639"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103639"><a href="#local-6989586621685103639"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103640"><a href="#local-6989586621685103640"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103638"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">uniqsFromSupply</span><span> </span><a href="#local-6989586621685103637"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-573"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103641"><a href="#local-6989586621685103641"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setNameUnique</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarName</span><span> </span><a href="#local-6989586621685103639"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103640"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-identifier">rttiEnvironment</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-576"></a><a name="rttiEnvironment"><a href="InteractiveEval.html#rttiEnvironment"><span class="hs-identifier">rttiEnvironment</span></a></a><span> </span><a name="local-6989586621685103675"><a href="#local-6989586621685103675"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-identifier">hsc_IC</span><span class="hs-glyph">=</span><a name="local-6989586621685103676"><a href="#local-6989586621685103676"><span class="hs-identifier">ic</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-577"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103692"><a href="#local-6989586621685103692"><span class="hs-identifier">tmp_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103694"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621685103694"><a href="#local-6989586621685103694"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621685103676"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">]</span><span>
</span><a name="line-578"></a><span>       </span><a name="local-6989586621685103693"><a href="#local-6989586621685103693"><span class="hs-identifier">incompletelyTypedIds</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-579"></a><span>           </span><span class="hs-special">[</span><a href="#local-6989586621685103695"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685103695"><a href="#local-6989586621685103695"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103692"><span class="hs-identifier hs-var">tmp_ids</span></a><span>
</span><a name="line-580"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685103677"><span class="hs-identifier hs-var">noSkolems</span></a><span> </span><a href="#local-6989586621685103695"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-581"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">nameOccName</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">idName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103695"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="InteractiveEval.html#result_fs"><span class="hs-identifier hs-var">result_fs</span></a><span class="hs-special">]</span><span>
</span><a name="line-582"></a><span>   </span><a name="local-6989586621685103696"><a href="#local-6989586621685103696"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621685103678"><span class="hs-identifier hs-var">improveTypes</span></a><span> </span><a href="#local-6989586621685103675"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621685103693"><span class="hs-identifier hs-var">incompletelyTypedIds</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685103696"><span class="hs-identifier hs-var">hsc_env'</span></a><span>
</span><a name="line-584"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-585"></a><span>     </span><a name="local-6989586621685103677"><a href="#local-6989586621685103677"><span class="hs-identifier">noSkolems</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noFreeVarsOfType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span>
</span><a name="line-586"></a><span>     </span><a name="local-6989586621685103678"><a href="#local-6989586621685103678"><span class="hs-identifier">improveTypes</span></a></a><span> </span><a name="local-6989586621685103679"><a href="#local-6989586621685103679"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-identifier">hsc_IC</span><span class="hs-glyph">=</span><a name="local-6989586621685103680"><a href="#local-6989586621685103680"><span class="hs-identifier">ic</span></a></a><span class="hs-special">}</span><span> </span><a name="local-6989586621685103681"><a href="#local-6989586621685103681"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-587"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103682"><a href="#local-6989586621685103682"><span class="hs-identifier">tmp_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103684"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621685103684"><a href="#local-6989586621685103684"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621685103680"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">]</span><span>
</span><a name="line-588"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103683"><a href="#local-6989586621685103683"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685103685"><a href="#local-6989586621685103685"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621685103685"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685103681"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103682"><span class="hs-identifier hs-var">tmp_ids</span></a><span>
</span><a name="line-589"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685103677"><span class="hs-identifier hs-var">noSkolems</span></a><span> </span><a href="#local-6989586621685103683"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-590"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685103679"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-591"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-592"></a><span>           </span><a name="local-6989586621685103686"><a href="#local-6989586621685103686"><span class="hs-identifier">mb_new_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#reconstructType"><span class="hs-identifier hs-var">reconstructType</span></a><span> </span><a href="#local-6989586621685103679"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-number">10</span><span> </span><a href="#local-6989586621685103683"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-593"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103687"><a href="#local-6989586621685103687"><span class="hs-identifier">old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685103683"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-594"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103686"><span class="hs-identifier hs-var">mb_new_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-595"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685103679"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-596"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103688"><a href="#local-6989586621685103688"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-597"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="RtClosureInspect.html#improveRTTIType"><span class="hs-identifier hs-var">improveRTTIType</span></a><span> </span><a href="#local-6989586621685103679"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103687"><span class="hs-identifier hs-var">old_ty</span></a><span> </span><a href="#local-6989586621685103688"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-598"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-599"></a><span>                        </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;:print failed to calculate the &quot;</span><span>
</span><a name="line-600"></a><span>                                           </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;improvement for a type&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">hsc_env</span><span>
</span><a name="line-601"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103689"><a href="#local-6989586621685103689"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-602"></a><span>                 </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103690"><a href="#local-6989586621685103690"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103679"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-603"></a><span>                 </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621685103690"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rtti</span><span> </span><span class="hs-string">&quot;RTTI&quot;</span><span>
</span><a name="line-604"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RTTI Improvement for&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685103683"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">equals</span><span class="hs-special">,</span><span>
</span><a name="line-605"></a><span>                          </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685103689"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>                 </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103691"><a href="#local-6989586621685103691"><span class="hs-identifier">ic'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substInteractiveContext</span><span> </span><a href="#local-6989586621685103680"><span class="hs-identifier hs-var">ic</span></a><span> </span><a href="#local-6989586621685103689"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-608"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685103679"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span class="hs-identifier">hsc_IC</span><span class="hs-glyph">=</span><a href="#local-6989586621685103691"><span class="hs-identifier hs-var">ic'</span></a><span class="hs-special">}</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span class="hs-identifier">pushResume</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Resume</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-611"></a><a name="pushResume"><a href="InteractiveEval.html#pushResume"><span class="hs-identifier">pushResume</span></a></a><span> </span><a name="local-6989586621685103697"><a href="#local-6989586621685103697"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103698"><a href="#local-6989586621685103698"><span class="hs-identifier">resume</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103697"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103700"><span class="hs-identifier hs-var">ictxt1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-612"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-613"></a><span>        </span><a name="local-6989586621685103699"><a href="#local-6989586621685103699"><span class="hs-identifier">ictxt0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103697"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-614"></a><span>        </span><a name="local-6989586621685103700"><a href="#local-6989586621685103700"><span class="hs-identifier">ictxt1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103699"><span class="hs-identifier hs-var">ictxt0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103698"><span class="hs-identifier hs-var">resume</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><a href="#local-6989586621685103699"><span class="hs-identifier hs-var">ictxt0</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-617"></a><span class="hs-comment">-- Abandoning a resume context</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-identifier">abandon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103411"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103411"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-620"></a><a name="abandon"><a href="InteractiveEval.html#abandon"><span class="hs-identifier">abandon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-621"></a><span>   </span><a name="local-6989586621685103701"><a href="#local-6989586621685103701"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-622"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103702"><a href="#local-6989586621685103702"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103701"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-623"></a><span>       </span><a name="local-6989586621685103703"><a href="#local-6989586621685103703"><span class="hs-identifier">resume</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><a href="#local-6989586621685103702"><span class="hs-identifier hs-var">ic</span></a><span>
</span><a name="line-624"></a><span>   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103703"><span class="hs-identifier hs-var">resume</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-625"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-626"></a><span>      </span><a name="local-6989586621685103704"><a href="#local-6989586621685103704"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685103705"><a href="#local-6989586621685103705"><span class="hs-identifier">rs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-627"></a><span>         </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103701"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103702"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103705"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-628"></a><span>         </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#abandonStmt"><span class="hs-identifier hs-var">abandonStmt</span></a><span> </span><a href="#local-6989586621685103701"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">resumeContext</span><span> </span><a href="#local-6989586621685103704"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span class="hs-identifier">abandonAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103410"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103410"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-632"></a><a name="abandonAll"><a href="InteractiveEval.html#abandonAll"><span class="hs-identifier">abandonAll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-633"></a><span>   </span><a name="local-6989586621685103706"><a href="#local-6989586621685103706"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-634"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103707"><a href="#local-6989586621685103707"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103706"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-635"></a><span>       </span><a name="local-6989586621685103708"><a href="#local-6989586621685103708"><span class="hs-identifier">resume</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><a href="#local-6989586621685103707"><span class="hs-identifier hs-var">ic</span></a><span>
</span><a name="line-636"></a><span>   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103708"><span class="hs-identifier hs-var">resume</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-637"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-638"></a><span>      </span><a name="local-6989586621685103709"><a href="#local-6989586621685103709"><span class="hs-identifier">rs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-639"></a><span>         </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685103706"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103707"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_resume</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-640"></a><span>         </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#abandonStmt"><span class="hs-identifier hs-var">abandonStmt</span></a><span> </span><a href="#local-6989586621685103706"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">resumeContext</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103709"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-641"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-642"></a><span>
</span><a name="line-643"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-644"></a><span class="hs-comment">-- Bounded list, optimised for repeated cons</span><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span class="hs-keyword">data</span><span> </span><a name="BoundedList"><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier">BoundedList</span></a></a><span> </span><a name="local-6989586621685103382"><a href="#local-6989586621685103382"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BL"><a href="InteractiveEval.html#BL"><span class="hs-identifier">BL</span></a></a><span>
</span><a name="line-647"></a><span>                        </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- length</span><span>
</span><a name="line-648"></a><span>                        </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- bound</span><span>
</span><a name="line-649"></a><span>                        </span><span class="hs-special">[</span><a href="#local-6989586621685103382"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- left</span><span>
</span><a name="line-650"></a><span>                        </span><span class="hs-special">[</span><a href="#local-6989586621685103382"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- right,  list is (left ++ reverse right)</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span class="hs-identifier">nilBL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><a href="#local-6989586621685103409"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-653"></a><a name="nilBL"><a href="InteractiveEval.html#nilBL"><span class="hs-identifier">nilBL</span></a></a><span> </span><a name="local-6989586621685103710"><a href="#local-6989586621685103710"><span class="hs-identifier">bound</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621685103710"><span class="hs-identifier hs-var">bound</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span class="hs-identifier">consBL</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621685103408"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><a href="#local-6989586621685103408"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><a href="#local-6989586621685103408"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-656"></a><a name="consBL"><a href="InteractiveEval.html#consBL"><span class="hs-identifier">consBL</span></a></a><span> </span><a name="local-6989586621685103711"><a href="#local-6989586621685103711"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><a name="local-6989586621685103712"><a href="#local-6989586621685103712"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621685103713"><a href="#local-6989586621685103713"><span class="hs-identifier">bound</span></a></a><span> </span><a name="local-6989586621685103714"><a href="#local-6989586621685103714"><span class="hs-identifier">left</span></a></a><span> </span><a name="local-6989586621685103715"><a href="#local-6989586621685103715"><span class="hs-identifier">right</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685103712"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621685103713"><span class="hs-identifier hs-var">bound</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103712"><span class="hs-identifier hs-var">len</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103713"><span class="hs-identifier hs-var">bound</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103711"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685103714"><span class="hs-identifier hs-var">left</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103715"><span class="hs-identifier hs-var">right</span></a><span>
</span><a name="line-658"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685103715"><span class="hs-identifier hs-var">right</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><a href="#local-6989586621685103712"><span class="hs-identifier hs-var">len</span></a><span>     </span><a href="#local-6989586621685103713"><span class="hs-identifier hs-var">bound</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103711"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>      </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621685103714"><span class="hs-identifier hs-var">left</span></a><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><a href="#local-6989586621685103712"><span class="hs-identifier hs-var">len</span></a><span>     </span><a href="#local-6989586621685103713"><span class="hs-identifier hs-var">bound</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103711"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685103714"><span class="hs-identifier hs-var">left</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621685103715"><span class="hs-identifier hs-var">right</span></a><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span class="hs-identifier">toListBL</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><a href="#local-6989586621685103407"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103407"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-662"></a><a name="toListBL"><a href="InteractiveEval.html#toListBL"><span class="hs-identifier">toListBL</span></a></a><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685103716"><a href="#local-6989586621685103716"><span class="hs-identifier">left</span></a></a><span> </span><a name="local-6989586621685103717"><a href="#local-6989586621685103717"><span class="hs-identifier">right</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103716"><span class="hs-identifier hs-var">left</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621685103717"><span class="hs-identifier hs-var">right</span></a><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span class="hs-identifier">fromListBL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103406"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="InteractiveEval.html#BoundedList"><span class="hs-identifier hs-type">BoundedList</span></a><span> </span><a href="#local-6989586621685103406"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-665"></a><a name="fromListBL"><a href="InteractiveEval.html#fromListBL"><span class="hs-identifier">fromListBL</span></a></a><span> </span><a name="local-6989586621685103718"><a href="#local-6989586621685103718"><span class="hs-identifier">bound</span></a></a><span> </span><a name="local-6989586621685103719"><a href="#local-6989586621685103719"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="InteractiveEval.html#BL"><span class="hs-identifier hs-var">BL</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621685103719"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103718"><span class="hs-identifier hs-var">bound</span></a><span> </span><a href="#local-6989586621685103719"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span class="hs-comment">-- lenBL (BL len _ _ _) = len</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-670"></a><span class="hs-comment">-- | Set the interactive evaluation context.</span><span>
</span><a name="line-671"></a><span class="hs-comment">--</span><span>
</span><a name="line-672"></a><span class="hs-comment">-- (setContext imports) sets the ic_imports field (which in turn</span><span>
</span><a name="line-673"></a><span class="hs-comment">-- determines what is in scope at the prompt) to 'imports', and</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- constructs the ic_rn_glb_env environment to reflect it.</span><span>
</span><a name="line-675"></a><span class="hs-comment">--</span><span>
</span><a name="line-676"></a><span class="hs-comment">-- We retain in scope all the things defined at the prompt, and kept</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- in ic_tythings.  (Indeed, they shadow stuff from ic_imports.)</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-identifier">setContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103405"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InteractiveImport</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103405"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-680"></a><a name="setContext"><a href="InteractiveEval.html#setContext"><span class="hs-identifier">setContext</span></a></a><span> </span><a name="local-6989586621685103720"><a href="#local-6989586621685103720"><span class="hs-identifier">imports</span></a></a><span>
</span><a name="line-681"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685103725"><a href="#local-6989586621685103725"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-682"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103726"><a href="#local-6989586621685103726"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103725"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-683"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685103727"><a href="#local-6989586621685103727"><span class="hs-identifier">all_env_err</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="InteractiveEval.html#findGlobalRdrEnv"><span class="hs-identifier hs-var">findGlobalRdrEnv</span></a><span> </span><a href="#local-6989586621685103725"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103720"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-684"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103727"><span class="hs-identifier hs-var">all_env_err</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-685"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103728"><a href="#local-6989586621685103728"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103729"><a href="#local-6989586621685103729"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-686"></a><span>               </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103721"><span class="hs-identifier hs-var">formatError</span></a><span> </span><a href="#local-6989586621685103726"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103728"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685103729"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685103730"><a href="#local-6989586621685103730"><span class="hs-identifier">all_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-688"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103731"><a href="#local-6989586621685103731"><span class="hs-identifier">old_ic</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103725"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-689"></a><span>             </span><span class="hs-glyph">!</span><a name="local-6989586621685103732"><a href="#local-6989586621685103732"><span class="hs-identifier">final_rdr_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103730"><span class="hs-identifier hs-var">all_env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">icExtendGblRdrEnv</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621685103731"><span class="hs-identifier hs-var">old_ic</span></a><span>
</span><a name="line-690"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">setSession</span><span>
</span><a name="line-691"></a><span>         </span><a href="#local-6989586621685103725"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103731"><span class="hs-identifier hs-var">old_ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_imports</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103720"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-692"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103732"><span class="hs-identifier hs-var">final_rdr_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-693"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-694"></a><span>    </span><a name="local-6989586621685103721"><a href="#local-6989586621685103721"><span class="hs-identifier">formatError</span></a></a><span> </span><a name="local-6989586621685103722"><a href="#local-6989586621685103722"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685103723"><a href="#local-6989586621685103723"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621685103724"><a href="#local-6989586621685103724"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621685103722"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-695"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot add module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685103723"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-696"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to context:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685103724"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span class="hs-identifier">findGlobalRdrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InteractiveImport</span><span class="hs-special">]</span><span>
</span><a name="line-699"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span class="hs-comment">-- Compute the GlobalRdrEnv for the interactive context</span><span>
</span><a name="line-701"></a><a name="findGlobalRdrEnv"><a href="InteractiveEval.html#findGlobalRdrEnv"><span class="hs-identifier">findGlobalRdrEnv</span></a></a><span> </span><a name="local-6989586621685103733"><a href="#local-6989586621685103733"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103734"><a href="#local-6989586621685103734"><span class="hs-identifier">imports</span></a></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685103743"><a href="#local-6989586621685103743"><span class="hs-identifier">idecls_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscRnImportDecls"><span class="hs-identifier hs-var">hscRnImportDecls</span></a><span> </span><a href="#local-6989586621685103733"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103735"><span class="hs-identifier hs-var">idecls</span></a><span>
</span><a name="line-703"></a><span>                    </span><span class="hs-comment">-- This call also loads any orphan modules</span><span>
</span><a name="line-704"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621685103737"><span class="hs-identifier hs-var">mkEnv</span></a><span> </span><a href="#local-6989586621685103736"><span class="hs-identifier hs-var">imods</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-705"></a><span>           </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685103744"><a href="#local-6989586621685103744"><span class="hs-identifier">imods_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">plusGlobalRdrEnv</span><span> </span><a href="#local-6989586621685103743"><span class="hs-identifier hs-var">idecls_env</span></a><span> </span><a href="#local-6989586621685103744"><span class="hs-identifier hs-var">imods_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-706"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621685103745"><a href="#local-6989586621685103745"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621685103745"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-707"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-708"></a><span>    </span><span class="hs-identifier">idecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-709"></a><span>    </span><a name="local-6989586621685103735"><a href="#local-6989586621685103735"><span class="hs-identifier">idecls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621685103738"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">IIDecl</span><span> </span><a name="local-6989586621685103738"><a href="#local-6989586621685103738"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103734"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">]</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span>    </span><span class="hs-identifier">imods</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>
</span><a name="line-712"></a><span>    </span><a name="local-6989586621685103736"><a href="#local-6989586621685103736"><span class="hs-identifier">imods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685103739"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">IIModule</span><span> </span><a name="local-6989586621685103739"><a href="#local-6989586621685103739"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685103734"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span>    </span><a name="local-6989586621685103737"><a href="#local-6989586621685103737"><span class="hs-identifier">mkEnv</span></a></a><span> </span><a name="local-6989586621685103740"><a href="#local-6989586621685103740"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="InteractiveEval.html#mkTopLevEnv"><span class="hs-identifier hs-var">mkTopLevEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103733"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103740"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-715"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685103741"><a href="#local-6989586621685103741"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103740"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103741"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685103742"><a href="#local-6989586621685103742"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621685103742"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-717"></a><span>
</span><a name="line-718"></a><span class="hs-identifier">availsToGlobalRdrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-719"></a><a name="availsToGlobalRdrEnv"><a href="InteractiveEval.html#availsToGlobalRdrEnv"><span class="hs-identifier">availsToGlobalRdrEnv</span></a></a><span> </span><a name="local-6989586621685103746"><a href="#local-6989586621685103746"><span class="hs-identifier">mod_name</span></a></a><span> </span><a name="local-6989586621685103747"><a href="#local-6989586621685103747"><span class="hs-identifier">avails</span></a></a><span>
</span><a name="line-720"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkGlobalRdrEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gresFromAvails</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685103748"><span class="hs-identifier hs-var">imp_spec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103747"><span class="hs-identifier hs-var">avails</span></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-722"></a><span>      </span><span class="hs-comment">-- We're building a GlobalRdrEnv as if the user imported</span><span>
</span><a name="line-723"></a><span>      </span><span class="hs-comment">-- all the specified modules into the global interactive module</span><span>
</span><a name="line-724"></a><span>    </span><a name="local-6989586621685103748"><a href="#local-6989586621685103748"><span class="hs-identifier">imp_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpSpec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_decl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103749"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_item</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpAll</span><span class="hs-special">}</span><span>
</span><a name="line-725"></a><span>    </span><a name="local-6989586621685103749"><a href="#local-6989586621685103749"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpDeclSpec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103746"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103746"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">,</span><span>
</span><a name="line-726"></a><span>                         </span><span class="hs-identifier">is_qual</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-727"></a><span>                         </span><span class="hs-identifier">is_dloc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-identifier hs-var">interactiveSrcLoc</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-identifier">mkTopLevEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-730"></a><a name="mkTopLevEnv"><a href="InteractiveEval.html#mkTopLevEnv"><span class="hs-identifier">mkTopLevEnv</span></a></a><span> </span><a name="local-6989586621685103750"><a href="#local-6989586621685103750"><span class="hs-identifier">hpt</span></a></a><span> </span><a name="local-6989586621685103751"><a href="#local-6989586621685103751"><span class="hs-identifier">modl</span></a></a><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685103750"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621685103751"><span class="hs-identifier hs-var">modl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-732"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;not a home module&quot;</span><span>
</span><a name="line-733"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103752"><a href="#local-6989586621685103752"><span class="hs-identifier">details</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-734"></a><span>         </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mi_globals</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hm_iface</span><span> </span><a href="#local-6989586621685103752"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-735"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;not interpreted&quot;</span><span>
</span><a name="line-736"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103753"><a href="#local-6989586621685103753"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621685103753"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span class="hs-comment">-- | Get the interactive evaluation context, consisting of a pair of the</span><span>
</span><a name="line-739"></a><span class="hs-comment">-- set of modules from which we take the full top-level scope, and the set</span><span>
</span><a name="line-740"></a><span class="hs-comment">-- of modules from which we take just the exports respectively.</span><span>
</span><a name="line-741"></a><span class="hs-identifier">getContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103404"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103404"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InteractiveImport</span><span class="hs-special">]</span><span>
</span><a name="line-742"></a><a name="getContext"><a href="InteractiveEval.html#getContext"><span class="hs-identifier">getContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span class="hs-glyph">=</span><a name="local-6989586621685103754"><a href="#local-6989586621685103754"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-743"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_imports</span><span> </span><a href="#local-6989586621685103754"><span class="hs-identifier hs-var">ic</span></a><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span class="hs-comment">-- | Returns @True@ if the specified module is interpreted, and hence has</span><span>
</span><a name="line-746"></a><span class="hs-comment">-- its full top-level scope available.</span><span>
</span><a name="line-747"></a><span class="hs-identifier">moduleIsInterpreted</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103403"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103403"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-748"></a><a name="moduleIsInterpreted"><a href="InteractiveEval.html#moduleIsInterpreted"><span class="hs-identifier">moduleIsInterpreted</span></a></a><span> </span><a name="local-6989586621685103755"><a href="#local-6989586621685103755"><span class="hs-identifier">modl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103756"><a href="#local-6989586621685103756"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-749"></a><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621685103755"><span class="hs-identifier hs-var">modl</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103756"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-751"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103756"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685103755"><span class="hs-identifier hs-var">modl</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-752"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103757"><a href="#local-6989586621685103757"><span class="hs-identifier">details</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_globals</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hm_iface</span><span> </span><a href="#local-6989586621685103757"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>                </span><a name="local-6989586621685103758"><a href="#local-6989586621685103758"><span class="hs-identifier">_not_a_home_module</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span class="hs-comment">-- | Looks up an identifier in the current interactive context (for :info)</span><span>
</span><a name="line-756"></a><span class="hs-comment">-- Filter the instances by the ones whose tycons (or clases resp)</span><span>
</span><a name="line-757"></a><span class="hs-comment">-- are in scope (qualified or otherwise).  Otherwise we list a whole lot too many!</span><span>
</span><a name="line-758"></a><span class="hs-comment">-- The exact choice of which ones to show, and which to hide, is a judgement call.</span><span>
</span><a name="line-759"></a><span class="hs-comment">--      (see Trac #1581)</span><span>
</span><a name="line-760"></a><span class="hs-identifier">getInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103402"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-761"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103402"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-762"></a><a name="getInfo"><a href="InteractiveEval.html#getInfo"><span class="hs-identifier">getInfo</span></a></a><span> </span><a name="local-6989586621685103759"><a href="#local-6989586621685103759"><span class="hs-identifier">allInfo</span></a></a><span> </span><a name="local-6989586621685103760"><a href="#local-6989586621685103760"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-763"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103766"><a href="#local-6989586621685103766"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-764"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685103767"><a href="#local-6989586621685103767"><span class="hs-identifier">mb_stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscTcRnGetInfo"><span class="hs-identifier hs-var">hscTcRnGetInfo</span></a><span> </span><a href="#local-6989586621685103766"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103760"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-765"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103767"><span class="hs-identifier hs-var">mb_stuff</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-766"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-767"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103768"><a href="#local-6989586621685103768"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103769"><a href="#local-6989586621685103769"><span class="hs-identifier">fixity</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103770"><a href="#local-6989586621685103770"><span class="hs-identifier">cls_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103771"><a href="#local-6989586621685103771"><span class="hs-identifier">fam_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103772"><a href="#local-6989586621685103772"><span class="hs-identifier">docs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-768"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103773"><a href="#local-6989586621685103773"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103766"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>           </span><span class="hs-comment">-- Filter the instances based on whether the constituent names of their</span><span>
</span><a name="line-771"></a><span>           </span><span class="hs-comment">-- instance heads are all in scope.</span><span>
</span><a name="line-772"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103774"><a href="#local-6989586621685103774"><span class="hs-identifier">cls_insts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103761"><span class="hs-identifier hs-var">plausible</span></a><span> </span><a href="#local-6989586621685103773"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">orphNamesOfClsInst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103770"><span class="hs-identifier hs-var">cls_insts</span></a><span>
</span><a name="line-773"></a><span>               </span><a name="local-6989586621685103775"><a href="#local-6989586621685103775"><span class="hs-identifier">fam_insts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103761"><span class="hs-identifier hs-var">plausible</span></a><span> </span><a href="#local-6989586621685103773"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">orphNamesOfFamInst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103771"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-774"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103768"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103769"><span class="hs-identifier hs-var">fixity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103774"><span class="hs-identifier hs-var">cls_insts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103775"><span class="hs-identifier hs-var">fam_insts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103772"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-775"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-776"></a><span>    </span><a name="local-6989586621685103761"><a href="#local-6989586621685103761"><span class="hs-identifier">plausible</span></a></a><span> </span><a name="local-6989586621685103762"><a href="#local-6989586621685103762"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621685103763"><a href="#local-6989586621685103763"><span class="hs-identifier">names</span></a></a><span>
</span><a name="line-777"></a><span>          </span><span class="hs-comment">-- Dfun involving only names that are in ic_rn_glb_env</span><span>
</span><a name="line-778"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685103759"><span class="hs-identifier hs-var">allInfo</span></a><span>
</span><a name="line-779"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">nameSetAll</span><span> </span><a href="#local-6989586621685103764"><span class="hs-identifier hs-var">ok</span></a><span> </span><a href="#local-6989586621685103763"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-780"></a><span>        </span><span class="hs-keyword">where</span><span>   </span><span class="hs-comment">-- A name is ok if it's in the rdr_env,</span><span>
</span><a name="line-781"></a><span>                </span><span class="hs-comment">-- whether qualified or not</span><span>
</span><a name="line-782"></a><span>          </span><a name="local-6989586621685103764"><a href="#local-6989586621685103764"><span class="hs-identifier">ok</span></a></a><span> </span><a name="local-6989586621685103765"><a href="#local-6989586621685103765"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685103765"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685103760"><span class="hs-identifier hs-var">name</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-783"></a><span>                       </span><span class="hs-comment">-- The one we looked for in the first place!</span><span>
</span><a name="line-784"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">pretendNameIsInScope</span><span> </span><a href="#local-6989586621685103765"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-785"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBuiltInSyntax</span><span> </span><a href="#local-6989586621685103765"><span class="hs-identifier hs-var">n</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-786"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCTupleTyConName</span><span> </span><a href="#local-6989586621685103765"><span class="hs-identifier hs-var">n</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-787"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621685103765"><span class="hs-identifier hs-var">n</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupGRE_Name</span><span> </span><a href="#local-6989586621685103762"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621685103765"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-789"></a><span>
</span><a name="line-790"></a><span class="hs-comment">-- | Returns all names in scope in the current interactive context</span><span>
</span><a name="line-791"></a><span class="hs-identifier">getNamesInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103401"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103401"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-792"></a><a name="getNamesInScope"><a href="InteractiveEval.html#getNamesInScope"><span class="hs-identifier">getNamesInScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103776"><a href="#local-6989586621685103776"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-793"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103776"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span class="hs-comment">-- | Returns all 'RdrName's in scope in the current interactive</span><span>
</span><a name="line-796"></a><span class="hs-comment">-- context, excluding any that are internally-generated.</span><span>
</span><a name="line-797"></a><span class="hs-identifier">getRdrNamesInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103400"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685103400"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span>
</span><a name="line-798"></a><a name="getRdrNamesInScope"><a href="InteractiveEval.html#getRdrNamesInScope"><span class="hs-identifier">getRdrNamesInScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103777"><a href="#local-6989586621685103777"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-799"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-800"></a><span>      </span><a name="local-6989586621685103778"><a href="#local-6989586621685103778"><span class="hs-identifier">ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685103777"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-801"></a><span>      </span><a name="local-6989586621685103779"><a href="#local-6989586621685103779"><span class="hs-identifier">gbl_rdrenv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><a href="#local-6989586621685103778"><span class="hs-identifier hs-var">ic</span></a><span>
</span><a name="line-802"></a><span>      </span><a name="local-6989586621685103780"><a href="#local-6989586621685103780"><span class="hs-identifier">gbl_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">greRdrNames</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><a href="#local-6989586621685103779"><span class="hs-identifier hs-var">gbl_rdrenv</span></a><span>
</span><a name="line-803"></a><span>  </span><span class="hs-comment">-- Exclude internally generated names; see e.g. Trac #11328</span><span>
</span><a name="line-804"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isDerivedOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103780"><span class="hs-identifier hs-var">gbl_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span class="hs-comment">-- | Parses a string as an identifier, and returns the list of 'Name's that</span><span>
</span><a name="line-808"></a><span class="hs-comment">-- the identifier can refer to in the current interactive context.</span><span>
</span><a name="line-809"></a><span class="hs-identifier">parseName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103399"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103399"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-810"></a><a name="parseName"><a href="InteractiveEval.html#parseName"><span class="hs-identifier">parseName</span></a></a><span> </span><a name="local-6989586621685103781"><a href="#local-6989586621685103781"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103782"><a href="#local-6989586621685103782"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-811"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685103783"><a href="#local-6989586621685103783"><span class="hs-identifier">lrdr_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscParseIdentifier"><span class="hs-identifier hs-var">hscParseIdentifier</span></a><span> </span><a href="#local-6989586621685103782"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103781"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-812"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="HscMain.html#hscTcRnLookupRdrName"><span class="hs-identifier hs-var">hscTcRnLookupRdrName</span></a><span> </span><a href="#local-6989586621685103782"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103783"><span class="hs-identifier hs-var">lrdr_name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span class="hs-comment">-- | Returns @True@ if passed string is a statement.</span><span>
</span><a name="line-815"></a><span class="hs-identifier">isStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-816"></a><a name="isStmt"><a href="InteractiveEval.html#isStmt"><span class="hs-identifier">isStmt</span></a></a><span> </span><a name="local-6989586621685103784"><a href="#local-6989586621685103784"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685103785"><a href="#local-6989586621685103785"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-817"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="InteractiveEval.html#parseThing"><span class="hs-identifier hs-var">parseThing</span></a><span> </span><span class="hs-identifier hs-var">Parser.parseStmt</span><span> </span><a href="#local-6989586621685103784"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103785"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-818"></a><span>    </span><span class="hs-identifier hs-var">Lexer.POk</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-819"></a><span>    </span><span class="hs-identifier hs-var">Lexer.PFailed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-comment">-- | Returns @True@ if passed string has an import declaration.</span><span>
</span><a name="line-822"></a><span class="hs-identifier">hasImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-823"></a><a name="hasImport"><a href="InteractiveEval.html#hasImport"><span class="hs-identifier">hasImport</span></a></a><span> </span><a name="local-6989586621685103786"><a href="#local-6989586621685103786"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685103787"><a href="#local-6989586621685103787"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-824"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="InteractiveEval.html#parseThing"><span class="hs-identifier hs-var">parseThing</span></a><span> </span><span class="hs-identifier hs-var">Parser.parseModule</span><span> </span><a href="#local-6989586621685103786"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103787"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-825"></a><span>    </span><span class="hs-identifier hs-var">Lexer.POk</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685103789"><a href="#local-6989586621685103789"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103788"><span class="hs-identifier hs-var">hasImports</span></a><span> </span><a href="#local-6989586621685103789"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-826"></a><span>    </span><span class="hs-identifier hs-var">Lexer.PFailed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-827"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-828"></a><span>    </span><a name="local-6989586621685103788"><a href="#local-6989586621685103788"><span class="hs-identifier">hasImports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hsmodImports</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-829"></a><span>
</span><a name="line-830"></a><span class="hs-comment">-- | Returns @True@ if passed string is an import declaration.</span><span>
</span><a name="line-831"></a><span class="hs-identifier">isImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-832"></a><a name="isImport"><a href="InteractiveEval.html#isImport"><span class="hs-identifier">isImport</span></a></a><span> </span><a name="local-6989586621685103790"><a href="#local-6989586621685103790"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685103791"><a href="#local-6989586621685103791"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-833"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="InteractiveEval.html#parseThing"><span class="hs-identifier hs-var">parseThing</span></a><span> </span><span class="hs-identifier hs-var">Parser.parseImport</span><span> </span><a href="#local-6989586621685103790"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103791"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-834"></a><span>    </span><span class="hs-identifier hs-var">Lexer.POk</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-835"></a><span>    </span><span class="hs-identifier hs-var">Lexer.PFailed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span class="hs-comment">-- | Returns @True@ if passed string is a declaration but __/not a splice/__.</span><span>
</span><a name="line-838"></a><span class="hs-identifier">isDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-839"></a><a name="isDecl"><a href="InteractiveEval.html#isDecl"><span class="hs-identifier">isDecl</span></a></a><span> </span><a name="local-6989586621685103792"><a href="#local-6989586621685103792"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685103793"><a href="#local-6989586621685103793"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-840"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="InteractiveEval.html#parseThing"><span class="hs-identifier hs-var">parseThing</span></a><span> </span><span class="hs-identifier hs-var">Parser.parseDeclaration</span><span> </span><a href="#local-6989586621685103792"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103793"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-841"></a><span>    </span><span class="hs-identifier hs-var">Lexer.POk</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685103794"><a href="#local-6989586621685103794"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-842"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621685103794"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-843"></a><span>        </span><span class="hs-identifier hs-var">SpliceD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-844"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-845"></a><span>    </span><span class="hs-identifier hs-var">Lexer.PFailed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-identifier">parseThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Lexer.P</span><span> </span><a href="#local-6989586621685103398"><span class="hs-identifier hs-type">thing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Lexer.ParseResult</span><span> </span><a href="#local-6989586621685103398"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-848"></a><a name="parseThing"><a href="InteractiveEval.html#parseThing"><span class="hs-identifier">parseThing</span></a></a><span> </span><a name="local-6989586621685103795"><a href="#local-6989586621685103795"><span class="hs-identifier">parser</span></a></a><span> </span><a name="local-6989586621685103796"><a href="#local-6989586621685103796"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685103797"><a href="#local-6989586621685103797"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-849"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103798"><a href="#local-6989586621685103798"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stringToStringBuffer</span><span> </span><a href="#local-6989586621685103797"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-850"></a><span>      </span><a name="local-6989586621685103799"><a href="#local-6989586621685103799"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-identifier">Lexer.unP</span><span> </span><a href="#local-6989586621685103795"><span class="hs-identifier hs-var">parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lexer.mkPState</span><span> </span><a href="#local-6989586621685103796"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103798"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621685103799"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span class="hs-identifier">getDocs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103397"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-855"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-856"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103397"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="InteractiveEval.html#GetDocsFailure"><span class="hs-identifier hs-type">GetDocsFailure</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">HsDocString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">HsDocString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>           </span><span class="hs-comment">-- TODO: What about docs for constructors etc.?</span><span>
</span><a name="line-858"></a><a name="getDocs"><a href="InteractiveEval.html#getDocs"><span class="hs-identifier">getDocs</span></a></a><span> </span><a name="local-6989586621685103800"><a href="#local-6989586621685103800"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-859"></a><span>  </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103802"><a href="#local-6989586621685103802"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-860"></a><span>     </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameModule_maybe</span><span> </span><a href="#local-6989586621685103800"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-861"></a><span>       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#NameHasNoModule"><span class="hs-identifier hs-var">NameHasNoModule</span></a><span> </span><a href="#local-6989586621685103800"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103803"><a href="#local-6989586621685103803"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-863"></a><span>         </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isInteractiveModule</span><span> </span><a href="#local-6989586621685103803"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-864"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="InteractiveEval.html#InteractiveName"><span class="hs-identifier hs-var">InteractiveName</span></a><span class="hs-special">)</span><span>
</span><a name="line-865"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-866"></a><span>             </span><span class="hs-identifier hs-var">ModIface</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mi_doc_hdr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685103804"><a href="#local-6989586621685103804"><span class="hs-identifier">mb_doc_hdr</span></a></a><span>
</span><a name="line-867"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mi_decl_docs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DeclDocMap</span><span> </span><a name="local-6989586621685103805"><a href="#local-6989586621685103805"><span class="hs-identifier">dmap</span></a></a><span>
</span><a name="line-868"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mi_arg_docs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ArgDocMap</span><span> </span><a name="local-6989586621685103806"><a href="#local-6989586621685103806"><span class="hs-identifier">amap</span></a></a><span>
</span><a name="line-869"></a><span>                      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscGetModuleInterface"><span class="hs-identifier hs-var">hscGetModuleInterface</span></a><span> </span><a href="#local-6989586621685103802"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103803"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-870"></a><span>             </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621685103804"><span class="hs-identifier hs-var">mb_doc_hdr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Map.null</span><span> </span><a href="#local-6989586621685103805"><span class="hs-identifier hs-var">dmap</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">Map.null</span><span> </span><a href="#local-6989586621685103806"><span class="hs-identifier hs-var">amap</span></a><span>
</span><a name="line-871"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#NoDocsInIface"><span class="hs-identifier hs-var">NoDocsInIface</span></a><span> </span><a href="#local-6989586621685103803"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685103801"><span class="hs-identifier hs-var">compiled</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span>               </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621685103800"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685103805"><span class="hs-identifier hs-var">dmap</span></a><span>
</span><a name="line-873"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map.findWithDefault</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621685103800"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685103806"><span class="hs-identifier hs-var">amap</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-875"></a><span>    </span><a name="local-6989586621685103801"><a href="#local-6989586621685103801"><span class="hs-identifier">compiled</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-876"></a><span>      </span><span class="hs-comment">-- TODO: Find a more direct indicator.</span><span>
</span><a name="line-877"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameSrcLoc</span><span> </span><a href="#local-6989586621685103800"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-878"></a><span>        </span><span class="hs-identifier hs-var">RealSrcLoc</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-identifier hs-var">UnhelpfulLoc</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span class="hs-comment">-- | Failure modes for 'getDocs'.</span><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span class="hs-comment">-- TODO: Find a way to differentiate between modules loaded without '-haddock'</span><span>
</span><a name="line-884"></a><span class="hs-comment">-- and modules that contain no docs.</span><span>
</span><a name="line-885"></a><span class="hs-keyword">data</span><span> </span><a name="GetDocsFailure"><a href="InteractiveEval.html#GetDocsFailure"><span class="hs-identifier">GetDocsFailure</span></a></a><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span>    </span><span class="hs-comment">-- | 'nameModule_maybe' returned 'Nothing'.</span><span>
</span><a name="line-888"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NameHasNoModule"><a href="InteractiveEval.html#NameHasNoModule"><span class="hs-identifier">NameHasNoModule</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-889"></a><span>
</span><a name="line-890"></a><span>    </span><span class="hs-comment">-- | This is probably because the module was loaded without @-haddock@,</span><span>
</span><a name="line-891"></a><span>    </span><span class="hs-comment">-- but it's also possible that the entire module contains no documentation.</span><span>
</span><a name="line-892"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NoDocsInIface"><a href="InteractiveEval.html#NoDocsInIface"><span class="hs-identifier">NoDocsInIface</span></a></a><span>
</span><a name="line-893"></a><span>      </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-894"></a><span>      </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ 'True': The module was compiled.</span><span>
</span><a name="line-895"></a><span>           </span><span class="hs-comment">-- 'False': The module was :loaded.</span><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span>    </span><span class="hs-comment">-- | The 'Name' was defined interactively.</span><span>
</span><a name="line-898"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InteractiveName"><a href="InteractiveEval.html#InteractiveName"><span class="hs-identifier">InteractiveName</span></a></a><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="InteractiveEval.html#GetDocsFailure"><span class="hs-identifier hs-type">GetDocsFailure</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-901"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#NameHasNoModule"><span class="hs-identifier hs-var">NameHasNoModule</span></a><span> </span><a name="local-6989586621685103383"><a href="#local-6989586621685103383"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-902"></a><span>    </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685103383"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has no module where we could look for docs.&quot;</span><span>
</span><a name="line-903"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="InteractiveEval.html#NoDocsInIface"><span class="hs-identifier hs-var">NoDocsInIface</span></a><span> </span><a name="local-6989586621685103384"><a href="#local-6989586621685103384"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621685103385"><a href="#local-6989586621685103385"><span class="hs-identifier">compiled</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-904"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't find any documentation for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685103384"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'.'</span><span>
</span><a name="line-905"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;This is probably because the module was&quot;</span><span>
</span><a name="line-906"></a><span>        </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685103385"><span class="hs-identifier hs-var">compiled</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;compiled&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;loaded&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-907"></a><span>        </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;without '-haddock',&quot;</span><span>
</span><a name="line-908"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but it's also possible that the module contains no documentation.&quot;</span><span>
</span><a name="line-909"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-910"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685103385"><span class="hs-identifier hs-var">compiled</span></a><span>
</span><a name="line-911"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Try re-compiling with '-haddock'.&quot;</span><span>
</span><a name="line-912"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Try running ':set -haddock' and :load the file again.&quot;</span><span>
</span><a name="line-913"></a><span>        </span><span class="hs-comment">-- TODO: Figure out why :reload doesn't load the docs and maybe fix it.</span><span>
</span><a name="line-914"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-915"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="InteractiveEval.html#InteractiveName"><span class="hs-identifier hs-var">InteractiveName</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-916"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Docs are unavailable for interactive declarations.&quot;</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-919"></a><span class="hs-comment">-- Getting the type of an expression</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-comment">-- | Get the type of an expression</span><span>
</span><a name="line-922"></a><span class="hs-comment">-- Returns the type as described by 'TcRnExprMode'</span><span>
</span><a name="line-923"></a><span class="hs-identifier">exprType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103396"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcRnDriver.html#TcRnExprMode"><span class="hs-identifier hs-type">TcRnExprMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103396"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-924"></a><a name="exprType"><a href="InteractiveEval.html#exprType"><span class="hs-identifier">exprType</span></a></a><span> </span><a name="local-6989586621685103807"><a href="#local-6989586621685103807"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621685103808"><a href="#local-6989586621685103808"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103809"><a href="#local-6989586621685103809"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-925"></a><span>   </span><a name="local-6989586621685103810"><a href="#local-6989586621685103810"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscTcExpr"><span class="hs-identifier hs-var">hscTcExpr</span></a><span> </span><a href="#local-6989586621685103809"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103807"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621685103808"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-926"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tidyType</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><a href="#local-6989586621685103810"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-929"></a><span class="hs-comment">-- Getting the kind of a type</span><span>
</span><a name="line-930"></a><span>
</span><a name="line-931"></a><span class="hs-comment">-- | Get the kind of a  type</span><span>
</span><a name="line-932"></a><span class="hs-identifier">typeKind</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103395"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103395"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><a name="typeKind"><a href="InteractiveEval.html#typeKind"><span class="hs-identifier">typeKind</span></a></a><span> </span><a name="local-6989586621685103811"><a href="#local-6989586621685103811"><span class="hs-identifier">normalise</span></a></a><span> </span><a name="local-6989586621685103812"><a href="#local-6989586621685103812"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103813"><a href="#local-6989586621685103813"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-934"></a><span>   </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscKcType"><span class="hs-identifier hs-var">hscKcType</span></a><span> </span><a href="#local-6989586621685103813"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103811"><span class="hs-identifier hs-var">normalise</span></a><span> </span><a href="#local-6989586621685103812"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-937"></a><span class="hs-comment">-- Compile an expression, run it, and deliver the result</span><span>
</span><a name="line-938"></a><span>
</span><a name="line-939"></a><span class="hs-comment">-- | Parse an expression, the parsed expression can be further processed and</span><span>
</span><a name="line-940"></a><span class="hs-comment">-- passed to compileParsedExpr.</span><span>
</span><a name="line-941"></a><span class="hs-identifier">parseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103394"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103394"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-942"></a><a name="parseExpr"><a href="InteractiveEval.html#parseExpr"><span class="hs-identifier">parseExpr</span></a></a><span> </span><a name="local-6989586621685103814"><a href="#local-6989586621685103814"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103815"><a href="#local-6989586621685103815"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-943"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621685103815"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscParseExpr"><span class="hs-identifier hs-var">hscParseExpr</span></a><span> </span><a href="#local-6989586621685103814"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-944"></a><span>
</span><a name="line-945"></a><span class="hs-comment">-- | Compile an expression, run it, and deliver the resulting HValue.</span><span>
</span><a name="line-946"></a><span class="hs-identifier">compileExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103393"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103393"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">HValue</span><span>
</span><a name="line-947"></a><a name="compileExpr"><a href="InteractiveEval.html#compileExpr"><span class="hs-identifier">compileExpr</span></a></a><span> </span><a name="local-6989586621685103816"><a href="#local-6989586621685103816"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-948"></a><span>  </span><a name="local-6989586621685103817"><a href="#local-6989586621685103817"><span class="hs-identifier">parsed_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#parseExpr"><span class="hs-identifier hs-var">parseExpr</span></a><span> </span><a href="#local-6989586621685103816"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-949"></a><span>  </span><a href="InteractiveEval.html#compileParsedExpr"><span class="hs-identifier hs-var">compileParsedExpr</span></a><span> </span><a href="#local-6989586621685103817"><span class="hs-identifier hs-var">parsed_expr</span></a><span>
</span><a name="line-950"></a><span>
</span><a name="line-951"></a><span class="hs-comment">-- | Compile an expression, run it, and deliver the resulting HValue.</span><span>
</span><a name="line-952"></a><span class="hs-identifier">compileExprRemote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103392"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103392"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-953"></a><a name="compileExprRemote"><a href="InteractiveEval.html#compileExprRemote"><span class="hs-identifier">compileExprRemote</span></a></a><span> </span><a name="local-6989586621685103818"><a href="#local-6989586621685103818"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-954"></a><span>  </span><a name="local-6989586621685103819"><a href="#local-6989586621685103819"><span class="hs-identifier">parsed_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#parseExpr"><span class="hs-identifier hs-var">parseExpr</span></a><span> </span><a href="#local-6989586621685103818"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-955"></a><span>  </span><a href="InteractiveEval.html#compileParsedExprRemote"><span class="hs-identifier hs-var">compileParsedExprRemote</span></a><span> </span><a href="#local-6989586621685103819"><span class="hs-identifier hs-var">parsed_expr</span></a><span>
</span><a name="line-956"></a><span>
</span><a name="line-957"></a><span class="hs-comment">-- | Compile a parsed expression (before renaming), run it, and deliver</span><span>
</span><a name="line-958"></a><span class="hs-comment">-- the resulting HValue.</span><span>
</span><a name="line-959"></a><span class="hs-identifier">compileParsedExprRemote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103391"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103391"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-960"></a><a name="compileParsedExprRemote"><a href="InteractiveEval.html#compileParsedExprRemote"><span class="hs-identifier">compileParsedExprRemote</span></a></a><span> </span><a name="local-6989586621685103820"><a href="#local-6989586621685103820"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621685103821"><a href="#local-6989586621685103821"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103822"><a href="#local-6989586621685103822"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-961"></a><span>  </span><span class="hs-comment">-- &gt; let _compileParsedExpr = expr</span><span>
</span><a name="line-962"></a><span>  </span><span class="hs-comment">-- Create let stmt from expr to make hscParsedStmt happy.</span><span>
</span><a name="line-963"></a><span>  </span><span class="hs-comment">-- We will ignore the returned [Id], namely [expr_id], and not really</span><span>
</span><a name="line-964"></a><span>  </span><span class="hs-comment">-- create a new binding.</span><span>
</span><a name="line-965"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103823"><a href="#local-6989586621685103823"><span class="hs-identifier">expr_fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;_compileParsedExpr&quot;</span><span>
</span><a name="line-966"></a><span>      </span><a name="local-6989586621685103824"><a href="#local-6989586621685103824"><span class="hs-identifier">expr_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621685103823"><span class="hs-identifier hs-var">expr_fs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarOccFS</span><span> </span><a href="#local-6989586621685103823"><span class="hs-identifier hs-var">expr_fs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103821"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-967"></a><span>      </span><a name="local-6989586621685103825"><a href="#local-6989586621685103825"><span class="hs-identifier">let_stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685103821"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685103821"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-968"></a><span>        </span><span class="hs-identifier hs-var">ValBinds</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-969"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsVarBind</span><span> </span><a href="#local-6989586621685103821"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getRdrName</span><span> </span><a href="#local-6989586621685103824"><span class="hs-identifier hs-var">expr_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103820"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-970"></a><span>
</span><a name="line-971"></a><span>  </span><a name="local-6989586621685103826"><a href="#local-6989586621685103826"><span class="hs-identifier">pstmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscParsedStmt"><span class="hs-identifier hs-var">hscParsedStmt</span></a><span> </span><a href="#local-6989586621685103822"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103825"><span class="hs-identifier hs-var">let_stmt</span></a><span>
</span><a name="line-972"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685103827"><a href="#local-6989586621685103827"><span class="hs-identifier">hvals_io</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103828"><a href="#local-6989586621685103828"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103826"><span class="hs-identifier hs-var">pstmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-973"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621685103829"><a href="#local-6989586621685103829"><span class="hs-identifier">_id</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685103830"><a href="#local-6989586621685103830"><span class="hs-identifier">hvals_io'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685103831"><a href="#local-6989586621685103831"><span class="hs-identifier">fix_env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685103830"><span class="hs-identifier hs-var">hvals_io'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685103831"><span class="hs-identifier hs-var">fix_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;compileParsedExprRemote&quot;</span><span>
</span><a name="line-975"></a><span>
</span><a name="line-976"></a><span>  </span><a href="InteractiveEval.html#updateFixityEnv"><span class="hs-identifier hs-var">updateFixityEnv</span></a><span> </span><a href="#local-6989586621685103828"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-977"></a><span>  </span><a name="local-6989586621685103832"><a href="#local-6989586621685103832"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#evalStmt"><span class="hs-identifier hs-var">evalStmt</span></a><span> </span><a href="#local-6989586621685103822"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalThis</span><span> </span><a href="#local-6989586621685103827"><span class="hs-identifier hs-var">hvals_io</span></a><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685103832"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-979"></a><span>    </span><span class="hs-identifier hs-var">EvalComplete</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalSuccess</span><span> </span><span class="hs-special">[</span><a name="local-6989586621685103833"><a href="#local-6989586621685103833"><span class="hs-identifier">hval</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685103833"><span class="hs-identifier hs-var">hval</span></a><span>
</span><a name="line-980"></a><span>    </span><span class="hs-identifier hs-var">EvalComplete</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalException</span><span> </span><a name="local-6989586621685103834"><a href="#local-6989586621685103834"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-981"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSerializableException</span><span> </span><a href="#local-6989586621685103834"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;compileParsedExpr&quot;</span><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span class="hs-identifier">compileParsedExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103390"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103390"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">HValue</span><span>
</span><a name="line-985"></a><a name="compileParsedExpr"><a href="InteractiveEval.html#compileParsedExpr"><span class="hs-identifier">compileParsedExpr</span></a></a><span> </span><a name="local-6989586621685103835"><a href="#local-6989586621685103835"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-986"></a><span>   </span><a name="local-6989586621685103836"><a href="#local-6989586621685103836"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#compileParsedExprRemote"><span class="hs-identifier hs-var">compileParsedExprRemote</span></a><span> </span><a href="#local-6989586621685103835"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-987"></a><span>   </span><a name="local-6989586621685103837"><a href="#local-6989586621685103837"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-988"></a><span>   </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#wormhole"><span class="hs-identifier hs-var">wormhole</span></a><span> </span><a href="#local-6989586621685103837"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685103836"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-989"></a><span>
</span><a name="line-990"></a><span class="hs-comment">-- | Compile an expression, run it and return the result as a Dynamic.</span><span>
</span><a name="line-991"></a><span class="hs-identifier">dynCompileExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103389"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103389"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Dynamic</span><span>
</span><a name="line-992"></a><a name="dynCompileExpr"><a href="InteractiveEval.html#dynCompileExpr"><span class="hs-identifier">dynCompileExpr</span></a></a><span> </span><a name="local-6989586621685103838"><a href="#local-6989586621685103838"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-993"></a><span>  </span><a name="local-6989586621685103839"><a href="#local-6989586621685103839"><span class="hs-identifier">parsed_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#parseExpr"><span class="hs-identifier hs-var">parseExpr</span></a><span> </span><a href="#local-6989586621685103838"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-994"></a><span>  </span><span class="hs-comment">-- &gt; Data.Dynamic.toDyn expr</span><span>
</span><a name="line-995"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103840"><a href="#local-6989586621685103840"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621685103839"><span class="hs-identifier hs-var">parsed_expr</span></a><span>
</span><a name="line-996"></a><span>      </span><a name="local-6989586621685103841"><a href="#local-6989586621685103841"><span class="hs-identifier">to_dyn_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685103840"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685103840"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getRdrName</span><span> </span><span class="hs-identifier hs-var">toDynName</span><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>                            </span><a href="#local-6989586621685103839"><span class="hs-identifier hs-var">parsed_expr</span></a><span>
</span><a name="line-998"></a><span>  </span><a name="local-6989586621685103842"><a href="#local-6989586621685103842"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#compileParsedExpr"><span class="hs-identifier hs-var">compileParsedExpr</span></a><span> </span><a href="#local-6989586621685103841"><span class="hs-identifier hs-var">to_dyn_expr</span></a><span>
</span><a name="line-999"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce#</span><span> </span><a href="#local-6989586621685103842"><span class="hs-identifier hs-var">hval</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Dynamic</span><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1002"></a><span class="hs-comment">-- show a module and it's source/object filenames</span><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span class="hs-identifier">showModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103388"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103388"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1005"></a><a name="showModule"><a href="InteractiveEval.html#showModule"><span class="hs-identifier">showModule</span></a></a><span> </span><a name="local-6989586621685103843"><a href="#local-6989586621685103843"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1006"></a><span>    </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103844"><a href="#local-6989586621685103844"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1007"></a><span>        </span><a name="local-6989586621685103845"><a href="#local-6989586621685103845"><span class="hs-identifier">interpreted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="InteractiveEval.html#moduleIsBootOrNotObjectLinkable"><span class="hs-identifier hs-var">moduleIsBootOrNotObjectLinkable</span></a><span> </span><a href="#local-6989586621685103843"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1008"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685103846"><a href="#local-6989586621685103846"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103844"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1009"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showModMsg</span><span> </span><a href="#local-6989586621685103846"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685103846"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103845"><span class="hs-identifier hs-var">interpreted</span></a><span> </span><a href="#local-6989586621685103843"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-identifier">moduleIsBootOrNotObjectLinkable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685103387"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103387"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1012"></a><a name="moduleIsBootOrNotObjectLinkable"><a href="InteractiveEval.html#moduleIsBootOrNotObjectLinkable"><span class="hs-identifier">moduleIsBootOrNotObjectLinkable</span></a></a><span> </span><a name="local-6989586621685103847"><a href="#local-6989586621685103847"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685103848"><a href="#local-6989586621685103848"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1013"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685103848"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685103847"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;missing linkable&quot;</span><span>
</span><a name="line-1015"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103849"><a href="#local-6989586621685103849"><span class="hs-identifier">mod_info</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685103849"><span class="hs-identifier hs-var">mod_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1016"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1017"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685103850"><a href="#local-6989586621685103850"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectLinkable</span><span> </span><a href="#local-6989586621685103850"><span class="hs-identifier hs-var">linkable</span></a><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-1020"></a><span class="hs-comment">-- RTTI primitives</span><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><span class="hs-identifier">obtainTermFromVal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685103386"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-1023"></a><a name="obtainTermFromVal"><a href="InteractiveEval.html#obtainTermFromVal"><span class="hs-identifier">obtainTermFromVal</span></a></a><span> </span><a name="local-6989586621685103851"><a href="#local-6989586621685103851"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103852"><a href="#local-6989586621685103852"><span class="hs-identifier">bound</span></a></a><span> </span><a name="local-6989586621685103853"><a href="#local-6989586621685103853"><span class="hs-identifier">force</span></a></a><span> </span><a name="local-6989586621685103854"><a href="#local-6989586621685103854"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621685103855"><a href="#local-6989586621685103855"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-1024"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685103851"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstallationError</span><span>
</span><a name="line-1026"></a><span>      </span><span class="hs-string">&quot;this operation requires -fno-external-interpreter&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1028"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#cvObtainTerm"><span class="hs-identifier hs-var">cvObtainTerm</span></a><span> </span><a href="#local-6989586621685103851"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103852"><span class="hs-identifier hs-var">bound</span></a><span> </span><a href="#local-6989586621685103853"><span class="hs-identifier hs-var">force</span></a><span> </span><a href="#local-6989586621685103854"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce#</span><span> </span><a href="#local-6989586621685103855"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1029"></a><span>
</span><a name="line-1030"></a><span class="hs-identifier">obtainTermFromId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-1031"></a><a name="obtainTermFromId"><a href="InteractiveEval.html#obtainTermFromId"><span class="hs-identifier">obtainTermFromId</span></a></a><span> </span><a name="local-6989586621685103856"><a href="#local-6989586621685103856"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103857"><a href="#local-6989586621685103857"><span class="hs-identifier">bound</span></a></a><span> </span><a name="local-6989586621685103858"><a href="#local-6989586621685103858"><span class="hs-identifier">force</span></a></a><span> </span><a name="local-6989586621685103859"><a href="#local-6989586621685103859"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><a name="line-1032"></a><span>  </span><a name="local-6989586621685103860"><a href="#local-6989586621685103860"><span class="hs-identifier">hv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getHValue"><span class="hs-identifier hs-var">Linker.getHValue</span></a><span> </span><a href="#local-6989586621685103856"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varName</span><span> </span><a href="#local-6989586621685103859"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1033"></a><span>  </span><a href="RtClosureInspect.html#cvObtainTerm"><span class="hs-identifier hs-var">cvObtainTerm</span></a><span> </span><a href="#local-6989586621685103856"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103857"><span class="hs-identifier hs-var">bound</span></a><span> </span><a href="#local-6989586621685103858"><span class="hs-identifier hs-var">force</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685103859"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103860"><span class="hs-identifier hs-var">hv</span></a><span>
</span><a name="line-1034"></a><span>
</span><a name="line-1035"></a><span class="hs-comment">-- Uses RTTI to reconstruct the type of an Id, making it less polymorphic</span><span>
</span><a name="line-1036"></a><span class="hs-identifier">reconstructType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-1037"></a><a name="reconstructType"><a href="InteractiveEval.html#reconstructType"><span class="hs-identifier">reconstructType</span></a></a><span> </span><a name="local-6989586621685103861"><a href="#local-6989586621685103861"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685103862"><a href="#local-6989586621685103862"><span class="hs-identifier">bound</span></a></a><span> </span><a name="local-6989586621685103863"><a href="#local-6989586621685103863"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1038"></a><span>  </span><a name="local-6989586621685103864"><a href="#local-6989586621685103864"><span class="hs-identifier">hv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getHValue"><span class="hs-identifier hs-var">Linker.getHValue</span></a><span> </span><a href="#local-6989586621685103861"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varName</span><span> </span><a href="#local-6989586621685103863"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1039"></a><span>  </span><a href="RtClosureInspect.html#cvReconstructType"><span class="hs-identifier hs-var">cvReconstructType</span></a><span> </span><a href="#local-6989586621685103861"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685103862"><span class="hs-identifier hs-var">bound</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685103863"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685103864"><span class="hs-identifier hs-var">hv</span></a><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-identifier">mkRuntimeUnkTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span>
</span><a name="line-1042"></a><a name="mkRuntimeUnkTyVar"><a href="InteractiveEval.html#mkRuntimeUnkTyVar"><span class="hs-identifier">mkRuntimeUnkTyVar</span></a></a><span> </span><a name="local-6989586621685103865"><a href="#local-6989586621685103865"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621685103866"><a href="#local-6989586621685103866"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcTyVar</span><span> </span><a href="#local-6989586621685103865"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685103866"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-identifier hs-var">RuntimeUnk</span><span>
</span><a name="line-1043"></a></pre></body></html>