<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Stg to C-- code generation</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmm</span><span> </span><span class="hs-special">(</span><span> </span><a href="StgCmm.html#codeGen"><span class="hs-identifier hs-var">codeGen</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmProf.html"><span class="hs-identifier">StgCmmProf</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#initCostCentres"><span class="hs-identifier hs-var">initCostCentres</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#ldvEnter"><span class="hs-identifier hs-var">ldvEnter</span></a><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmMonad.html"><span class="hs-identifier">StgCmmMonad</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmEnv.html"><span class="hs-identifier">StgCmmEnv</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmBind.html"><span class="hs-identifier">StgCmmBind</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmCon.html"><span class="hs-identifier">StgCmmCon</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmHpc.html"><span class="hs-identifier">StgCmmHpc</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmTicky.html"><span class="hs-identifier">StgCmmTicky</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Stream.html"><span class="hs-identifier">Stream</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isEmptyDVarSet</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-identifier">codeGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-59"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-60"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-61"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CollectedCCs</span><span>                </span><span class="hs-comment">-- (Local/global) cost-centres needing declaring/registering.</span><span>
</span><a name="line-62"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#CgStgTopBinding"><span class="hs-identifier hs-type">CgStgTopBinding</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Bindings to convert</span><span>
</span><a name="line-63"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HpcInfo</span><span>
</span><a name="line-64"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#CmmGroup"><span class="hs-identifier hs-type">CmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Output as a stream, so codegen can</span><span>
</span><a name="line-65"></a><span>                                       </span><span class="hs-comment">-- be interleaved with output</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><a name="codeGen"><a href="StgCmm.html#codeGen"><span class="hs-identifier">codeGen</span></a></a><span> </span><a name="local-6989586621681639447"><a href="#local-6989586621681639447"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681639448"><a href="#local-6989586621681639448"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621681639449"><a href="#local-6989586621681639449"><span class="hs-identifier">data_tycons</span></a></a><span>
</span><a name="line-68"></a><span>        </span><a name="local-6989586621681639450"><a href="#local-6989586621681639450"><span class="hs-identifier">cost_centre_info</span></a></a><span> </span><a name="local-6989586621681639451"><a href="#local-6989586621681639451"><span class="hs-identifier">stg_binds</span></a></a><span> </span><a name="local-6989586621681639452"><a href="#local-6989586621681639452"><span class="hs-identifier">hpc_info</span></a></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- cg: run the code generator, and yield the resulting CmmGroup</span><span>
</span><a name="line-70"></a><span>              </span><span class="hs-comment">-- Using an IORef to store the state is a bit crude, but otherwise</span><span>
</span><a name="line-71"></a><span>              </span><span class="hs-comment">-- we would need to add a state monad layer.</span><span>
</span><a name="line-72"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681639453"><a href="#local-6989586621681639453"><span class="hs-identifier">cgref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Stream.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="StgCmmMonad.html#initC"><span class="hs-identifier hs-var">initC</span></a><span>
</span><a name="line-73"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">cg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#CmmGroup"><span class="hs-identifier hs-type">CmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>              </span><a name="local-6989586621681639454"><a href="#local-6989586621681639454"><span class="hs-identifier">cg</span></a></a><span> </span><a name="local-6989586621681639455"><a href="#local-6989586621681639455"><span class="hs-identifier">fcode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-75"></a><span>                </span><a name="local-6989586621681639459"><a href="#local-6989586621681639459"><span class="hs-identifier">cmm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Stream.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-76"></a><span>                         </span><a name="local-6989586621681639456"><a href="#local-6989586621681639456"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621681639453"><span class="hs-identifier hs-var">cgref</span></a><span>
</span><a name="line-77"></a><span>                         </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681639457"><a href="#local-6989586621681639457"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621681639458"><a href="#local-6989586621681639458"><span class="hs-identifier">st'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#runC"><span class="hs-identifier hs-var">runC</span></a><span> </span><a href="#local-6989586621681639447"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639448"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681639456"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#getCmm"><span class="hs-identifier hs-var">getCmm</span></a><span> </span><a href="#local-6989586621681639455"><span class="hs-identifier hs-var">fcode</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>                         </span><span class="hs-comment">-- NB. stub-out cgs_tops and cgs_stmts.  This fixes</span><span>
</span><a name="line-80"></a><span>                         </span><span class="hs-comment">-- a big space leak.  DO NOT REMOVE!</span><span>
</span><a name="line-81"></a><span>                         </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621681639453"><span class="hs-identifier hs-var">cgref</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621681639458"><span class="hs-identifier hs-var">st'</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>                                                  </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-83"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681639457"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-84"></a><span>                </span><a href="Stream.html#yield"><span class="hs-identifier hs-var">yield</span></a><span> </span><a href="#local-6989586621681639459"><span class="hs-identifier hs-var">cmm</span></a><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>               </span><span class="hs-comment">-- Note [codegen-split-init] the cmm_init block must come</span><span>
</span><a name="line-87"></a><span>               </span><span class="hs-comment">-- FIRST.  This is because when -split-objs is on we need to</span><span>
</span><a name="line-88"></a><span>               </span><span class="hs-comment">-- combine this block with its initialisation routines; see</span><span>
</span><a name="line-89"></a><span>               </span><span class="hs-comment">-- Note [pipeline-split-init].</span><span>
</span><a name="line-90"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621681639454"><span class="hs-identifier hs-var">cg</span></a><span> </span><span class="hs-special">(</span><a href="StgCmm.html#mkModuleInit"><span class="hs-identifier hs-var">mkModuleInit</span></a><span> </span><a href="#local-6989586621681639450"><span class="hs-identifier hs-var">cost_centre_info</span></a><span> </span><a href="#local-6989586621681639448"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681639452"><span class="hs-identifier hs-var">hpc_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681639454"><span class="hs-identifier hs-var">cg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmm.html#cgTopBinding"><span class="hs-identifier hs-var">cgTopBinding</span></a><span> </span><a href="#local-6989586621681639447"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681639451"><span class="hs-identifier hs-var">stg_binds</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>                </span><span class="hs-comment">-- Put datatype_stuff after code_stuff, because the</span><span>
</span><a name="line-95"></a><span>                </span><span class="hs-comment">-- datatype closure table (for enumeration types) to</span><span>
</span><a name="line-96"></a><span>                </span><span class="hs-comment">-- (say) PrelBase_True_closure, which is defined in</span><span>
</span><a name="line-97"></a><span>                </span><span class="hs-comment">-- code_stuff</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681639460"><a href="#local-6989586621681639460"><span class="hs-identifier">do_tycon</span></a></a><span> </span><a name="local-6989586621681639461"><a href="#local-6989586621681639461"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-99"></a><span>                </span><span class="hs-comment">-- Generate a table of static closures for an</span><span>
</span><a name="line-100"></a><span>                </span><span class="hs-comment">-- enumeration type Note that the closure pointers are</span><span>
</span><a name="line-101"></a><span>                </span><span class="hs-comment">-- tagged.</span><span>
</span><a name="line-102"></a><span>                 </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEnumerationTyCon</span><span> </span><a href="#local-6989586621681639461"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681639454"><span class="hs-identifier hs-var">cg</span></a><span> </span><span class="hs-special">(</span><a href="StgCmm.html#cgEnumerationTyCon"><span class="hs-identifier hs-var">cgEnumerationTyCon</span></a><span> </span><a href="#local-6989586621681639461"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>                 </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681639454"><span class="hs-identifier hs-var">cg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmm.html#cgDataCon"><span class="hs-identifier hs-var">cgDataCon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621681639461"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621681639460"><span class="hs-identifier hs-var">do_tycon</span></a><span> </span><a href="#local-6989586621681639449"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-109"></a><span class="hs-comment">--      Top-level bindings</span><span>
</span><a name="line-110"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">{- 'cgTopBinding' is only used for top-level bindings, since they need
to be allocated statically (not in the heap) and need to be labelled.
No unboxed bindings can happen at top level.

In the code below, the static bindings are accumulated in the
@MkCgState@, and transferred into the ``statics'' slot by @forkStatics@.
This is so that we can write the top level processing in a compositional
style, with the increasing static environment being plumbed as a state
variable. -}</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">cgTopBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgTopBinding"><span class="hs-identifier hs-type">CgStgTopBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><a name="cgTopBinding"><a href="StgCmm.html#cgTopBinding"><span class="hs-identifier">cgTopBinding</span></a></a><span> </span><a name="local-6989586621681639462"><a href="#local-6989586621681639462"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621681639463"><a href="#local-6989586621681639463"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621681639464"><a href="#local-6989586621681639464"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681639465"><a href="#local-6989586621681639465"><span class="hs-identifier">id'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmm.html#maybeExternaliseId"><span class="hs-identifier hs-var">maybeExternaliseId</span></a><span> </span><a href="#local-6989586621681639462"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639463"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-125"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681639466"><a href="#local-6989586621681639466"><span class="hs-identifier">info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681639467"><a href="#local-6989586621681639467"><span class="hs-identifier">fcode</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmm.html#cgTopRhs"><span class="hs-identifier hs-var">cgTopRhs</span></a><span> </span><a href="#local-6989586621681639462"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span> </span><a href="#local-6989586621681639465"><span class="hs-identifier hs-var">id'</span></a><span> </span><a href="#local-6989586621681639464"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-126"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621681639467"><span class="hs-identifier hs-var">fcode</span></a><span>
</span><a name="line-127"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmEnv.html#addBindC"><span class="hs-identifier hs-var">addBindC</span></a><span> </span><a href="#local-6989586621681639466"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-comment">-- Add the *un-externalised* Id to the envt,</span><span>
</span><a name="line-128"></a><span>                        </span><span class="hs-comment">-- so we find it when we look up occurrences</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">cgTopBinding</span><span> </span><a name="local-6989586621681639468"><a href="#local-6989586621681639468"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621681639469"><a href="#local-6989586621681639469"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681639470"><a href="#local-6989586621681639470"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681639471"><a href="#local-6989586621681639471"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681639469"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-133"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681639472"><a href="#local-6989586621681639472"><span class="hs-identifier">bndrs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Prelude.mapM</span><span> </span><span class="hs-special">(</span><a href="StgCmm.html#maybeExternaliseId"><span class="hs-identifier hs-var">maybeExternaliseId</span></a><span> </span><a href="#local-6989586621681639468"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681639470"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-134"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681639473"><a href="#local-6989586621681639473"><span class="hs-identifier">pairs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621681639472"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621681639471"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-135"></a><span>              </span><a name="local-6989586621681639474"><a href="#local-6989586621681639474"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzipWith</span><span> </span><span class="hs-special">(</span><a href="StgCmm.html#cgTopRhs"><span class="hs-identifier hs-var">cgTopRhs</span></a><span> </span><a href="#local-6989586621681639468"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Recursive</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681639473"><span class="hs-identifier hs-var">pairs'</span></a><span>
</span><a name="line-136"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621681639475"><a href="#local-6989586621681639475"><span class="hs-identifier">infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681639476"><a href="#local-6989586621681639476"><span class="hs-identifier">fcodes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681639474"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-137"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmEnv.html#addBindsC"><span class="hs-identifier hs-var">addBindsC</span></a><span> </span><a href="#local-6989586621681639475"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">sequence_</span><span> </span><a href="#local-6989586621681639476"><span class="hs-identifier hs-var">fcodes</span></a><span>
</span><a name="line-139"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">cgTopBinding</span><span> </span><a name="local-6989586621681639477"><a href="#local-6989586621681639477"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopStringLit"><span class="hs-identifier hs-var">StgTopStringLit</span></a><span> </span><a name="local-6989586621681639478"><a href="#local-6989586621681639478"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621681639479"><a href="#local-6989586621681639479"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681639480"><a href="#local-6989586621681639480"><span class="hs-identifier">id'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmm.html#maybeExternaliseId"><span class="hs-identifier hs-var">maybeExternaliseId</span></a><span> </span><a href="#local-6989586621681639477"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639478"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-143"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkBytesLabel"><span class="hs-identifier hs-var">mkBytesLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681639480"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681639482"><a href="#local-6989586621681639482"><span class="hs-identifier">lit</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681639483"><a href="#local-6989586621681639483"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#mkByteStringCLit"><span class="hs-identifier hs-var">mkByteStringCLit</span></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.unpack</span><span> </span><a href="#local-6989586621681639479"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitDecl"><span class="hs-identifier hs-var">emitDecl</span></a><span> </span><a href="#local-6989586621681639483"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-146"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmEnv.html#addBindC"><span class="hs-identifier hs-var">addBindC</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#litIdInfo"><span class="hs-identifier hs-var">litIdInfo</span></a><span> </span><a href="#local-6989586621681639477"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639480"><span class="hs-identifier hs-var">id'</span></a><span> </span><a href="StgCmmClosure.html#mkLFStringLit"><span class="hs-identifier hs-var">mkLFStringLit</span></a><span> </span><a href="#local-6989586621681639482"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">cgTopRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgRhs"><span class="hs-identifier hs-type">CgStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-comment">-- The Id is passed along for setting up a binding...</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-comment">-- It's already been externalised if necessary</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><a name="cgTopRhs"><a href="StgCmm.html#cgTopRhs"><span class="hs-identifier">cgTopRhs</span></a></a><span> </span><a name="local-6989586621681639484"><a href="#local-6989586621681639484"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681639485"><a href="#local-6989586621681639485"><span class="hs-identifier">_rec</span></a></a><span> </span><a name="local-6989586621681639486"><a href="#local-6989586621681639486"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621681639487"><a href="#local-6989586621681639487"><span class="hs-identifier">_cc</span></a></a><span> </span><a name="local-6989586621681639488"><a href="#local-6989586621681639488"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621681639489"><a href="#local-6989586621681639489"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmCon.html#cgTopRhsCon"><span class="hs-identifier hs-var">cgTopRhsCon</span></a><span> </span><a href="#local-6989586621681639484"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639486"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681639488"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#assertNonVoidStgArgs"><span class="hs-identifier hs-var">assertNonVoidStgArgs</span></a><span> </span><a href="#local-6989586621681639489"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-comment">-- con args are always non-void,</span><span>
</span><a name="line-156"></a><span>      </span><span class="hs-comment">-- see Note [Post-unarisation invariants] in UnariseStg</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-identifier">cgTopRhs</span><span> </span><a name="local-6989586621681639490"><a href="#local-6989586621681639490"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681639491"><a href="#local-6989586621681639491"><span class="hs-identifier">rec</span></a></a><span> </span><a name="local-6989586621681639492"><a href="#local-6989586621681639492"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621681639493"><a href="#local-6989586621681639493"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681639494"><a href="#local-6989586621681639494"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681639495"><a href="#local-6989586621681639495"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621681639496"><a href="#local-6989586621681639496"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681639497"><a href="#local-6989586621681639497"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isEmptyDVarSet</span><span> </span><span class="hs-identifier hs-var">fvs</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- There should be no free variables</span><span>
</span><a name="line-160"></a><span>    </span><a href="StgCmmBind.html#cgTopRhsClosure"><span class="hs-identifier hs-var">cgTopRhsClosure</span></a><span> </span><a href="#local-6989586621681639490"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639491"><span class="hs-identifier hs-var">rec</span></a><span> </span><a href="#local-6989586621681639492"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681639494"><span class="hs-identifier hs-var">cc</span></a><span> </span><a href="#local-6989586621681639495"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621681639496"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621681639497"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-164"></a><span class="hs-comment">--      Module initialisation code</span><span>
</span><a name="line-165"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">mkModuleInit</span><span>
</span><a name="line-168"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CollectedCCs</span><span>         </span><span class="hs-comment">-- cost centre info</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-170"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HpcInfo</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><a name="mkModuleInit"><a href="StgCmm.html#mkModuleInit"><span class="hs-identifier">mkModuleInit</span></a></a><span> </span><a name="local-6989586621681639498"><a href="#local-6989586621681639498"><span class="hs-identifier">cost_centre_info</span></a></a><span> </span><a name="local-6989586621681639499"><a href="#local-6989586621681639499"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621681639500"><a href="#local-6989586621681639500"><span class="hs-identifier">hpc_info</span></a></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="StgCmmHpc.html#initHpc"><span class="hs-identifier hs-var">initHpc</span></a><span> </span><a href="#local-6989586621681639499"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681639500"><span class="hs-identifier hs-var">hpc_info</span></a><span>
</span><a name="line-175"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#initCostCentres"><span class="hs-identifier hs-var">initCostCentres</span></a><span> </span><a href="#local-6989586621681639498"><span class="hs-identifier hs-var">cost_centre_info</span></a><span>
</span><a name="line-176"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-180"></a><span class="hs-comment">--      Generating static stuff for algebraic data types</span><span>
</span><a name="line-181"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">cgEnumerationTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><a name="cgEnumerationTyCon"><a href="StgCmm.html#cgEnumerationTyCon"><span class="hs-identifier">cgEnumerationTyCon</span></a></a><span> </span><a name="local-6989586621681639501"><a href="#local-6989586621681639501"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-186"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681639502"><a href="#local-6989586621681639502"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-187"></a><span>       </span><a href="StgCmmUtils.html#emitRODataLits"><span class="hs-identifier hs-var">emitRODataLits</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkLocalClosureTableLabel"><span class="hs-identifier hs-var">mkLocalClosureTableLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621681639501"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">NoCafRefs</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>             </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmLabelOff"><span class="hs-identifier hs-var">CmmLabelOff</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkLocalClosureLabel"><span class="hs-identifier hs-var">mkLocalClosureLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621681639503"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">NoCafRefs</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>                           </span><span class="hs-special">(</span><a href="StgCmmClosure.html#tagForCon"><span class="hs-identifier hs-var">tagForCon</span></a><span> </span><a href="#local-6989586621681639502"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639503"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681639503"><a href="#local-6989586621681639503"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621681639501"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">]</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">cgDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- Generate the entry code, info tables, and (for niladic constructor)</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- the static closure, for a constructor.</span><span>
</span><a name="line-196"></a><a name="cgDataCon"><a href="StgCmm.html#cgDataCon"><span class="hs-identifier">cgDataCon</span></a></a><span> </span><a name="local-6989586621681639504"><a href="#local-6989586621681639504"><span class="hs-identifier">data_con</span></a></a><span>
</span><a name="line-197"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681639505"><a href="#local-6989586621681639505"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-199"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621681639506"><a href="#local-6989586621681639506"><span class="hs-identifier">tot_wds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-comment">--  #ptr_wds + #nonptr_wds</span><span>
</span><a name="line-200"></a><span>             </span><a name="local-6989586621681639507"><a href="#local-6989586621681639507"><span class="hs-identifier">ptr_wds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-comment">--  #ptr_wds</span><span>
</span><a name="line-201"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmLayout.html#mkVirtConstrSizes"><span class="hs-identifier hs-var">mkVirtConstrSizes</span></a><span> </span><a href="#local-6989586621681639505"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639510"><span class="hs-identifier hs-var">arg_reps</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>            </span><a name="local-6989586621681639508"><a href="#local-6989586621681639508"><span class="hs-identifier">nonptr_wds</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681639506"><span class="hs-identifier hs-var">tot_wds</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681639507"><span class="hs-identifier hs-var">ptr_wds</span></a><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span>            </span><a name="local-6989586621681639509"><a href="#local-6989586621681639509"><span class="hs-identifier">dyn_info_tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-206"></a><span>              </span><a href="StgCmmClosure.html#mkDataConInfoTable"><span class="hs-identifier hs-var">mkDataConInfoTable</span></a><span> </span><a href="#local-6989586621681639505"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639504"><span class="hs-identifier hs-var">data_con</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621681639507"><span class="hs-identifier hs-var">ptr_wds</span></a><span> </span><a href="#local-6989586621681639508"><span class="hs-identifier hs-var">nonptr_wds</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>            </span><span class="hs-comment">-- We're generating info tables, so we don't know and care about</span><span>
</span><a name="line-209"></a><span>            </span><span class="hs-comment">-- what the actual arguments are. Using () here as the place holder.</span><span>
</span><a name="line-210"></a><span>            </span><span class="hs-identifier">arg_reps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">]</span><span>
</span><a name="line-211"></a><span>            </span><a name="local-6989586621681639510"><a href="#local-6989586621681639510"><span class="hs-identifier">arg_reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681639512"><span class="hs-identifier hs-var">rep_ty</span></a><span>
</span><a name="line-212"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681639511"><a href="#local-6989586621681639511"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dataConRepArgTys</span><span> </span><a href="#local-6989586621681639504"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-213"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="local-6989586621681639512"><a href="#local-6989586621681639512"><span class="hs-identifier">rep_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><a href="#local-6989586621681639511"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-214"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isVoidRep</span><span> </span><a href="#local-6989586621681639512"><span class="hs-identifier hs-var">rep_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#emitClosureAndInfoTable"><span class="hs-identifier hs-var">emitClosureAndInfoTable</span></a><span> </span><a href="#local-6989586621681639509"><span class="hs-identifier hs-var">dyn_info_tbl</span></a><span> </span><a href="CmmNode.html#NativeDirectCall"><span class="hs-identifier hs-var">NativeDirectCall</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-217"></a><span>            </span><span class="hs-comment">-- NB: the closure pointer is assumed *untagged* on</span><span>
</span><a name="line-218"></a><span>            </span><span class="hs-comment">-- entry to a constructor.  If the pointer is tagged,</span><span>
</span><a name="line-219"></a><span>            </span><span class="hs-comment">-- then we should not be entering it.  This assumption</span><span>
</span><a name="line-220"></a><span>            </span><span class="hs-comment">-- is used in ldvEnter and when tagging the pointer to</span><span>
</span><a name="line-221"></a><span>            </span><span class="hs-comment">-- return it.</span><span>
</span><a name="line-222"></a><span>            </span><span class="hs-comment">-- NB 2: We don't set CC when entering data (WDP 94/06)</span><span>
</span><a name="line-223"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#tickyEnterDynCon"><span class="hs-identifier hs-var">tickyEnterDynCon</span></a><span>
</span><a name="line-224"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#ldvEnter"><span class="hs-identifier hs-var">ldvEnter</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#nodeReg"><span class="hs-identifier hs-var">nodeReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#tickyReturnOldCon"><span class="hs-identifier hs-var">tickyReturnOldCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681639510"><span class="hs-identifier hs-var">arg_reps</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">[</span><a href="CmmUtils.html#cmmOffsetB"><span class="hs-identifier hs-var">cmmOffsetB</span></a><span> </span><a href="#local-6989586621681639505"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#nodeReg"><span class="hs-identifier hs-var">nodeReg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#tagForCon"><span class="hs-identifier hs-var">tagForCon</span></a><span> </span><a href="#local-6989586621681639505"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681639504"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-227"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-228"></a><span>                    </span><span class="hs-comment">-- The case continuation code expects a tagged pointer</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-232"></a><span class="hs-comment">--      Stuff to support splitting</span><span>
</span><a name="line-233"></a><span class="hs-comment">---------------------------------------------------------------</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-identifier">maybeExternaliseId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-236"></a><a name="maybeExternaliseId"><a href="StgCmm.html#maybeExternaliseId"><span class="hs-identifier">maybeExternaliseId</span></a></a><span> </span><a name="local-6989586621681639513"><a href="#local-6989586621681639513"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681639514"><a href="#local-6989586621681639514"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-237"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621681639513"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- See Note [Externalise when splitting]</span><span>
</span><a name="line-238"></a><span>                                </span><span class="hs-comment">-- in StgCmmMonad</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-identifier hs-var">isInternalName</span><span> </span><a href="#local-6989586621681639516"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681639521"><a href="#local-6989586621681639521"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier hs-var">getModuleName</span></a><span>
</span><a name="line-240"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setIdName</span><span> </span><a href="#local-6989586621681639514"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681639515"><span class="hs-identifier hs-var">externalise</span></a><span> </span><a href="#local-6989586621681639521"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-241"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681639514"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-242"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-243"></a><span>    </span><a name="local-6989586621681639515"><a href="#local-6989586621681639515"><span class="hs-identifier">externalise</span></a></a><span> </span><a name="local-6989586621681639520"><a href="#local-6989586621681639520"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkExternalName</span><span> </span><a href="#local-6989586621681639517"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621681639520"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681639518"><span class="hs-identifier hs-var">new_occ</span></a><span> </span><a href="#local-6989586621681639519"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-244"></a><span>    </span><a name="local-6989586621681639516"><a href="#local-6989586621681639516"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681639514"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-245"></a><span>    </span><a name="local-6989586621681639517"><a href="#local-6989586621681639517"><span class="hs-identifier">uniq</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameUnique</span><span> </span><a href="#local-6989586621681639516"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621681639518"><a href="#local-6989586621681639518"><span class="hs-identifier">new_occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalOcc</span><span> </span><a href="#local-6989586621681639517"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621681639516"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>    </span><a name="local-6989586621681639519"><a href="#local-6989586621681639519"><span class="hs-identifier">loc</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><a href="#local-6989586621681639516"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">-- We want to conjure up a name that can't clash with any</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-comment">-- existing name.  So we generate</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-comment">--      Mod_$L243foo</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-comment">-- where 243 is the unique.</span><span>
</span><a name="line-252"></a></pre></body></html>