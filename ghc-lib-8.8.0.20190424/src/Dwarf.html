<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Dwarf</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-2"></a><span>  </span><a href="Dwarf.html#dwarfGen"><span class="hs-identifier hs-var">dwarfGen</span></a><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><a href="CmmExpr.html"><span class="hs-identifier">CmmExpr</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Config</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">cProjectName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cProjectVersion</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Tickish</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><a href="Debug.html"><span class="hs-identifier">Debug</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Dwarf.Constants.html"><span class="hs-identifier">Dwarf.Constants</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Dwarf.Types.html"><span class="hs-identifier">Dwarf.Types</span></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mfilter</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">H</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">H</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">-- | Generate DWARF/debug information</span><span>
</span><a name="line-35"></a><span class="hs-identifier">dwarfGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-36"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><a name="dwarfGen"><a href="Dwarf.html#dwarfGen"><span class="hs-identifier">dwarfGen</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span>      </span><a name="local-6989586621684951473"><a href="#local-6989586621684951473"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">empty</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684951473"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-identifier">dwarfGen</span><span> </span><a name="local-6989586621684951474"><a href="#local-6989586621684951474"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621684951475"><a href="#local-6989586621684951475"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684951476"><a href="#local-6989586621684951476"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684951477"><a href="#local-6989586621684951477"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-comment">-- Convert debug data structures to DWARF info records</span><span>
</span><a name="line-41"></a><span>  </span><span class="hs-comment">-- We strip out block information when running with -g0 or -g1.</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951478"><a href="#local-6989586621684951478"><span class="hs-identifier">procs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.html#debugSplitProcs"><span class="hs-identifier hs-var">debugSplitProcs</span></a><span> </span><a href="#local-6989586621684951477"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-43"></a><span>      </span><a name="local-6989586621684951479"><a href="#local-6989586621684951479"><span class="hs-identifier">stripBlocks</span></a></a><span> </span><a name="local-6989586621684951480"><a href="#local-6989586621684951480"><span class="hs-identifier">dbg</span></a></a><span>
</span><a name="line-44"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621684951474"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951480"><span class="hs-identifier hs-var">dbg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dblBlocks</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-45"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951480"><span class="hs-identifier hs-var">dbg</span></a><span>
</span><a name="line-46"></a><span>  </span><a name="local-6989586621684951481"><a href="#local-6989586621684951481"><span class="hs-identifier">compPath</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951482"><a href="#local-6989586621684951482"><span class="hs-identifier">lowLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621684951478"><span class="hs-identifier hs-var">procs</span></a><span>
</span><a name="line-48"></a><span>      </span><a name="local-6989586621684951483"><a href="#local-6989586621684951483"><span class="hs-identifier">highLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkAsmTempEndLabel"><span class="hs-identifier hs-var">mkAsmTempEndLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621684951478"><span class="hs-identifier hs-var">procs</span></a><span>
</span><a name="line-49"></a><span>      </span><a name="local-6989586621684951484"><a href="#local-6989586621684951484"><span class="hs-identifier">dwarfUnit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfCompileUnit"><span class="hs-identifier hs-var">DwarfCompileUnit</span></a><span>
</span><a name="line-50"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dwChildren</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Dwarf.html#procToDwarf"><span class="hs-identifier hs-var">procToDwarf</span></a><span> </span><a href="#local-6989586621684951474"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684951479"><span class="hs-identifier hs-var">stripBlocks</span></a><span> </span><a href="#local-6989586621684951478"><span class="hs-identifier hs-var">procs</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621684951475"><span class="hs-identifier hs-var">modLoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwCompDir</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addTrailingPathSeparator</span><span> </span><a href="#local-6989586621684951481"><span class="hs-identifier hs-var">compPath</span></a><span>
</span><a name="line-53"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwProducer</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cProjectName</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">cProjectVersion</span><span>
</span><a name="line-54"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwLowLabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951482"><span class="hs-identifier hs-var">lowLabel</span></a><span>
</span><a name="line-55"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwHighLabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951483"><span class="hs-identifier hs-var">highLabel</span></a><span>
</span><a name="line-56"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwLineLabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Constants.html#dwarfLineLabel"><span class="hs-identifier hs-var">dwarfLineLabel</span></a><span>
</span><a name="line-57"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>  </span><span class="hs-comment">-- Check whether we have any source code information, so we do not</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-comment">-- end up writing a pointer to an empty .debug_line section</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-comment">-- (dsymutil on Mac Os gets confused by this).</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951485"><a href="#local-6989586621684951485"><span class="hs-identifier">haveSrcIn</span></a></a><span> </span><a name="local-6989586621684951487"><a href="#local-6989586621684951487"><span class="hs-identifier">blk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblSourceTick</span><span> </span><a href="#local-6989586621684951487"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblPosition</span><span> </span><a href="#local-6989586621684951487"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>                      </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621684951485"><span class="hs-identifier hs-var">haveSrcIn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblBlocks</span><span> </span><a href="#local-6989586621684951487"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>      </span><a name="local-6989586621684951486"><a href="#local-6989586621684951486"><span class="hs-identifier">haveSrc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621684951485"><span class="hs-identifier hs-var">haveSrcIn</span></a><span> </span><a href="#local-6989586621684951478"><span class="hs-identifier hs-var">procs</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-comment">-- .debug_abbrev section: Declare the format we're using</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951488"><a href="#local-6989586621684951488"><span class="hs-identifier">abbrevSct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#pprAbbrevDecls"><span class="hs-identifier hs-var">pprAbbrevDecls</span></a><span> </span><a href="#local-6989586621684951486"><span class="hs-identifier hs-var">haveSrc</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-comment">-- .debug_info section: Information records on procedures and blocks</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- unique to identify start and end compilation unit .debug_inf</span><span>
</span><a name="line-71"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621684951489"><a href="#local-6989586621684951489"><span class="hs-identifier">unitU</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684951490"><a href="#local-6989586621684951490"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><a href="#local-6989586621684951476"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-72"></a><span>      </span><a name="local-6989586621684951491"><a href="#local-6989586621684951491"><span class="hs-identifier">infoSct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="Dwarf.Constants.html#dwarfInfoLabel"><span class="hs-identifier hs-var">dwarfInfoLabel</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span>
</span><a name="line-73"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Dwarf.Constants.html#dwarfInfoSection"><span class="hs-identifier hs-var">dwarfInfoSection</span></a><span>
</span><a name="line-74"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Dwarf.html#compileUnitHeader"><span class="hs-identifier hs-var">compileUnitHeader</span></a><span> </span><a href="#local-6989586621684951489"><span class="hs-identifier hs-var">unitU</span></a><span>
</span><a name="line-75"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Dwarf.Types.html#pprDwarfInfo"><span class="hs-identifier hs-var">pprDwarfInfo</span></a><span> </span><a href="#local-6989586621684951486"><span class="hs-identifier hs-var">haveSrc</span></a><span> </span><a href="#local-6989586621684951484"><span class="hs-identifier hs-var">dwarfUnit</span></a><span>
</span><a name="line-76"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="Dwarf.html#compileUnitFooter"><span class="hs-identifier hs-var">compileUnitFooter</span></a><span> </span><a href="#local-6989586621684951489"><span class="hs-identifier hs-var">unitU</span></a><span>
</span><a name="line-77"></a><span>                     </span><span class="hs-special">]</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-comment">-- .debug_line section: Generated mainly by the assembler, but we</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-comment">-- need to label it</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951492"><a href="#local-6989586621684951492"><span class="hs-identifier">lineSct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Constants.html#dwarfLineSection"><span class="hs-identifier hs-var">dwarfLineSection</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-82"></a><span>                </span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="Dwarf.Constants.html#dwarfLineLabel"><span class="hs-identifier hs-var">dwarfLineLabel</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>  </span><span class="hs-comment">-- .debug_frame section: Information about the layout of the GHC stack</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684951493"><a href="#local-6989586621684951493"><span class="hs-identifier">framesU</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684951494"><a href="#local-6989586621684951494"><span class="hs-identifier">us''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><a href="#local-6989586621684951490"><span class="hs-identifier hs-var">us'</span></a><span>
</span><a name="line-86"></a><span>      </span><a name="local-6989586621684951495"><a href="#local-6989586621684951495"><span class="hs-identifier">frameSct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Constants.html#dwarfFrameSection"><span class="hs-identifier hs-var">dwarfFrameSection</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-87"></a><span>                 </span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="Dwarf.Constants.html#dwarfFrameLabel"><span class="hs-identifier hs-var">dwarfFrameLabel</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-88"></a><span>                 </span><a href="Dwarf.Types.html#pprDwarfFrame"><span class="hs-identifier hs-var">pprDwarfFrame</span></a><span> </span><span class="hs-special">(</span><a href="Dwarf.html#debugFrame"><span class="hs-identifier hs-var">debugFrame</span></a><span> </span><a href="#local-6989586621684951493"><span class="hs-identifier hs-var">framesU</span></a><span> </span><a href="#local-6989586621684951478"><span class="hs-identifier hs-var">procs</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>  </span><span class="hs-comment">-- .aranges section: Information about the bounds of compilation units</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951496"><a href="#local-6989586621684951496"><span class="hs-identifier">aranges'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitSections</span><span> </span><a href="#local-6989586621684951474"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Dwarf.html#mkDwarfARange"><span class="hs-identifier hs-var">mkDwarfARange</span></a><span> </span><a href="#local-6989586621684951478"><span class="hs-identifier hs-var">procs</span></a><span>
</span><a name="line-92"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Dwarf.Types.html#DwarfARange"><span class="hs-identifier hs-var">DwarfARange</span></a><span> </span><a href="#local-6989586621684951482"><span class="hs-identifier hs-var">lowLabel</span></a><span> </span><a href="#local-6989586621684951483"><span class="hs-identifier hs-var">highLabel</span></a><span class="hs-special">]</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951497"><a href="#local-6989586621684951497"><span class="hs-identifier">aranges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Constants.html#dwarfARangesSection"><span class="hs-identifier hs-var">dwarfARangesSection</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="Dwarf.Types.html#pprDwarfARanges"><span class="hs-identifier hs-var">pprDwarfARanges</span></a><span> </span><a href="#local-6989586621684951496"><span class="hs-identifier hs-var">aranges'</span></a><span> </span><a href="#local-6989586621684951489"><span class="hs-identifier hs-var">unitU</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684951491"><span class="hs-identifier hs-var">infoSct</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621684951488"><span class="hs-identifier hs-var">abbrevSct</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621684951492"><span class="hs-identifier hs-var">lineSct</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621684951495"><span class="hs-identifier hs-var">frameSct</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621684951497"><span class="hs-identifier hs-var">aranges</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684951494"><span class="hs-identifier hs-var">us''</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- | Build an address range entry for one proc.</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- With split sections, each proc needs its own entry, since they may get</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- scattered in the final binary. Without split sections, we could make a</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- single arange based on the first/last proc.</span><span>
</span><a name="line-101"></a><span class="hs-identifier">mkDwarfARange</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Dwarf.Types.html#DwarfARange"><span class="hs-identifier hs-type">DwarfARange</span></a><span>
</span><a name="line-102"></a><a name="mkDwarfARange"><a href="Dwarf.html#mkDwarfARange"><span class="hs-identifier">mkDwarfARange</span></a></a><span> </span><a name="local-6989586621684951498"><a href="#local-6989586621684951498"><span class="hs-identifier">proc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfARange"><span class="hs-identifier hs-var">DwarfARange</span></a><span> </span><a href="#local-6989586621684951499"><span class="hs-identifier hs-var">start</span></a><span> </span><a href="#local-6989586621684951500"><span class="hs-identifier hs-var">end</span></a><span>
</span><a name="line-103"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-104"></a><span>    </span><a name="local-6989586621684951499"><a href="#local-6989586621684951499"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><a href="#local-6989586621684951498"><span class="hs-identifier hs-var">proc</span></a><span>
</span><a name="line-105"></a><span>    </span><a name="local-6989586621684951500"><a href="#local-6989586621684951500"><span class="hs-identifier">end</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkAsmTempEndLabel"><span class="hs-identifier hs-var">mkAsmTempEndLabel</span></a><span> </span><a href="#local-6989586621684951499"><span class="hs-identifier hs-var">start</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- | Header for a compilation unit, establishing global format</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- parameters</span><span>
</span><a name="line-109"></a><span class="hs-identifier">compileUnitHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-110"></a><a name="compileUnitHeader"><a href="Dwarf.html#compileUnitHeader"><span class="hs-identifier">compileUnitHeader</span></a></a><span> </span><a name="local-6989586621684951501"><a href="#local-6989586621684951501"><span class="hs-identifier">unitU</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sdocWithPlatform</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684951502"><a href="#local-6989586621684951502"><span class="hs-identifier">plat</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951503"><a href="#local-6989586621684951503"><span class="hs-identifier">cuLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkAsmTempLabel"><span class="hs-identifier hs-var">mkAsmTempLabel</span></a><span> </span><a href="#local-6989586621684951501"><span class="hs-identifier hs-var">unitU</span></a><span>  </span><span class="hs-comment">-- sits right before initialLength field</span><span>
</span><a name="line-112"></a><span>      </span><a name="local-6989586621684951504"><a href="#local-6989586621684951504"><span class="hs-identifier">length</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkAsmTempEndLabel"><span class="hs-identifier hs-var">mkAsmTempEndLabel</span></a><span> </span><a href="#local-6989586621684951503"><span class="hs-identifier hs-var">cuLabel</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'-'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684951503"><span class="hs-identifier hs-var">cuLabel</span></a><span>
</span><a name="line-113"></a><span>               </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-4&quot;</span><span>       </span><span class="hs-comment">-- length of initialLength field</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684951503"><span class="hs-identifier hs-var">cuLabel</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span>
</span><a name="line-115"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.long &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621684951504"><span class="hs-identifier hs-var">length</span></a><span>  </span><span class="hs-comment">-- compilation unit size</span><span>
</span><a name="line-116"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Dwarf.Types.html#pprHalf"><span class="hs-identifier hs-var">pprHalf</span></a><span> </span><span class="hs-number">3</span><span>                          </span><span class="hs-comment">-- DWARF version</span><span>
</span><a name="line-117"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Dwarf.Types.html#sectionOffset"><span class="hs-identifier hs-var">sectionOffset</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="Dwarf.Constants.html#dwarfAbbrevLabel"><span class="hs-identifier hs-var">dwarfAbbrevLabel</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="Dwarf.Constants.html#dwarfAbbrevLabel"><span class="hs-identifier hs-var">dwarfAbbrevLabel</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>                                               </span><span class="hs-comment">-- abbrevs offset</span><span>
</span><a name="line-119"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.byte &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformWordSize</span><span> </span><a href="#local-6989586621684951502"><span class="hs-identifier hs-var">plat</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- word size</span><span>
</span><a name="line-120"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-comment">-- | Compilation unit footer, mainly establishing size of debug sections</span><span>
</span><a name="line-123"></a><span class="hs-identifier">compileUnitFooter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-124"></a><a name="compileUnitFooter"><a href="Dwarf.html#compileUnitFooter"><span class="hs-identifier">compileUnitFooter</span></a></a><span> </span><a name="local-6989586621684951505"><a href="#local-6989586621684951505"><span class="hs-identifier">unitU</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-125"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684951506"><a href="#local-6989586621684951506"><span class="hs-identifier">cuEndLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkAsmTempEndLabel"><span class="hs-identifier hs-var">mkAsmTempEndLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CLabel.html#mkAsmTempLabel"><span class="hs-identifier hs-var">mkAsmTempLabel</span></a><span> </span><a href="#local-6989586621684951505"><span class="hs-identifier hs-var">unitU</span></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684951506"><span class="hs-identifier hs-var">cuEndLabel</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">-- | Splits the blocks by procedures. In the result all nested blocks</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- will come from the same procedure as the top-level block. See</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- Note [Splitting DebugBlocks] for details.</span><span>
</span><a name="line-131"></a><span class="hs-identifier">debugSplitProcs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-132"></a><a name="debugSplitProcs"><a href="Dwarf.html#debugSplitProcs"><span class="hs-identifier">debugSplitProcs</span></a></a><span> </span><a name="local-6989586621684951507"><a href="#local-6989586621684951507"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapElems"><span class="hs-identifier hs-var">H.mapElems</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684951508"><span class="hs-identifier hs-var">mergeMaps</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684951509"><span class="hs-identifier hs-var">split</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684951507"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684951508"><a href="#local-6989586621684951508"><span class="hs-identifier">mergeMaps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapUnionWithKey"><span class="hs-identifier hs-var">H.mapUnionWithKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">H.mapEmpty</span></a><span>
</span><a name="line-134"></a><span>        </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">H.LabelMap</span></a><span> </span><span class="hs-special">[</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-135"></a><span>        </span><a name="local-6989586621684951509"><a href="#local-6989586621684951509"><span class="hs-identifier">split</span></a></a><span> </span><a name="local-6989586621684951510"><a href="#local-6989586621684951510"><span class="hs-identifier">parent</span></a></a><span> </span><a name="local-6989586621684951511"><a href="#local-6989586621684951511"><span class="hs-identifier">blk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">H.mapInsert</span></a><span> </span><a href="#local-6989586621684951512"><span class="hs-identifier hs-var">prc</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684951513"><span class="hs-identifier hs-var">blk'</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684951515"><span class="hs-identifier hs-var">nested</span></a><span>
</span><a name="line-136"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684951512"><a href="#local-6989586621684951512"><span class="hs-identifier">prc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblProcedure</span><span> </span><a href="#local-6989586621684951511"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-137"></a><span>                </span><a name="local-6989586621684951513"><a href="#local-6989586621684951513"><span class="hs-identifier">blk'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951511"><span class="hs-identifier hs-var">blk</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dblBlocks</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951514"><span class="hs-identifier hs-var">own_blks</span></a><span>
</span><a name="line-138"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dblParent</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951510"><span class="hs-identifier hs-var">parent</span></a><span>
</span><a name="line-139"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>                </span><a name="local-6989586621684951514"><a href="#local-6989586621684951514"><span class="hs-identifier">own_blks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">H.mapLookup</span></a><span> </span><a href="#local-6989586621684951512"><span class="hs-identifier hs-var">prc</span></a><span> </span><a href="#local-6989586621684951515"><span class="hs-identifier hs-var">nested</span></a><span>
</span><a name="line-141"></a><span>                </span><a name="local-6989586621684951515"><a href="#local-6989586621684951515"><span class="hs-identifier">nested</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951508"><span class="hs-identifier hs-var">mergeMaps</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684951509"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621684951516"><span class="hs-identifier hs-var">parent'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dblBlocks</span><span> </span><a href="#local-6989586621684951511"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-142"></a><span>                </span><span class="hs-comment">-- Figure out who should be the parent of nested blocks.</span><span>
</span><a name="line-143"></a><span>                </span><span class="hs-comment">-- If @blk@ is optimized out then it isn't a good choice</span><span>
</span><a name="line-144"></a><span>                </span><span class="hs-comment">-- and we just use its parent.</span><span>
</span><a name="line-145"></a><span>                </span><a name="local-6989586621684951516"><a href="#local-6989586621684951516"><span class="hs-identifier">parent'</span></a></a><span>
</span><a name="line-146"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">dblPosition</span><span> </span><a href="#local-6989586621684951511"><span class="hs-identifier hs-var">blk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951510"><span class="hs-identifier hs-var">parent</span></a><span>
</span><a name="line-147"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684951511"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">{-
Note [Splitting DebugBlocks]

DWARF requires that we break up the nested DebugBlocks produced from
the C-- AST. For instance, we begin with tick trees containing nested procs.
For example,

    proc A [tick1, tick2]
      block B [tick3]
        proc C [tick4]

when producing DWARF we need to procs (which are represented in DWARF as
TAG_subprogram DIEs) to be top-level DIEs. debugSplitProcs is responsible for
this transform, pulling out the nested procs into top-level procs.

However, in doing this we need to be careful to preserve the parentage of the
nested procs. This is the reason DebugBlocks carry the dblParent field, allowing
us to reorganize the above tree as,

    proc A [tick1, tick2]
      block B [tick3]
    proc C [tick4] parent=B

Here we have annotated the new proc C with an attribute giving its original
parent, B.
-}</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-comment">-- | Generate DWARF info for a procedure debug block</span><span>
</span><a name="line-177"></a><span class="hs-identifier">procToDwarf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Dwarf.Types.html#DwarfInfo"><span class="hs-identifier hs-type">DwarfInfo</span></a><span>
</span><a name="line-178"></a><a name="procToDwarf"><a href="Dwarf.html#procToDwarf"><span class="hs-identifier">procToDwarf</span></a></a><span> </span><a name="local-6989586621684951517"><a href="#local-6989586621684951517"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621684951518"><a href="#local-6989586621684951518"><span class="hs-identifier">prc</span></a></a><span>
</span><a name="line-179"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfSubprogram"><span class="hs-identifier hs-var">DwarfSubprogram</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dwChildren</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Dwarf.html#blockToDwarf"><span class="hs-identifier hs-var">blockToDwarf</span></a><span> </span><a href="#local-6989586621684951517"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblBlocks</span><span> </span><a href="#local-6989586621684951518"><span class="hs-identifier hs-var">prc</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwName</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">dblSourceTick</span><span> </span><a href="#local-6989586621684951518"><span class="hs-identifier hs-var">prc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-181"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684951522"><a href="#local-6989586621684951522"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">SourceNote</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">sourceName</span><span> </span><a href="#local-6989586621684951522"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-182"></a><span>                         </span><a name="local-6989586621684951523"><a href="#local-6989586621684951523"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">showSDocDump</span><span> </span><a href="#local-6989586621684951517"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dblLabel</span><span> </span><a href="#local-6989586621684951518"><span class="hs-identifier hs-var">prc</span></a><span>
</span><a name="line-183"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwLabel</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><a href="#local-6989586621684951518"><span class="hs-identifier hs-var">prc</span></a><span>
</span><a name="line-184"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwParent</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="CLabel.html#mkAsmTempDieLabel"><span class="hs-identifier hs-var">mkAsmTempDieLabel</span></a><span>
</span><a name="line-185"></a><span>                                   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mfilter</span><span> </span><a href="#local-6989586621684951519"><span class="hs-identifier hs-var">goodParent</span></a><span>
</span><a name="line-186"></a><span>                                   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblParent</span><span> </span><a href="#local-6989586621684951518"><span class="hs-identifier hs-var">prc</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-189"></a><span>  </span><a name="local-6989586621684951519"><a href="#local-6989586621684951519"><span class="hs-identifier">goodParent</span></a></a><span> </span><a name="local-6989586621684951520"><a href="#local-6989586621684951520"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684951520"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><a href="#local-6989586621684951518"><span class="hs-identifier hs-var">prc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-190"></a><span>               </span><span class="hs-comment">-- Omit parent if it would be self-referential</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-identifier">goodParent</span><span> </span><a name="local-6989586621684951521"><a href="#local-6989586621684951521"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#externallyVisibleCLabel"><span class="hs-identifier hs-var">externallyVisibleCLabel</span></a><span> </span><a href="#local-6989586621684951521"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621684951517"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-193"></a><span>               </span><span class="hs-comment">-- We strip block information when running -g0 or -g1, don't</span><span>
</span><a name="line-194"></a><span>               </span><span class="hs-comment">-- refer to blocks in that case. Fixes #14894.</span><span>
</span><a name="line-195"></a><span>  </span><span class="hs-identifier">goodParent</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- | Generate DWARF info for a block</span><span>
</span><a name="line-198"></a><span class="hs-identifier">blockToDwarf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Dwarf.Types.html#DwarfInfo"><span class="hs-identifier hs-type">DwarfInfo</span></a><span>
</span><a name="line-199"></a><a name="blockToDwarf"><a href="Dwarf.html#blockToDwarf"><span class="hs-identifier">blockToDwarf</span></a></a><span> </span><a name="local-6989586621684951524"><a href="#local-6989586621684951524"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621684951525"><a href="#local-6989586621684951525"><span class="hs-identifier">blk</span></a></a><span>
</span><a name="line-200"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfBlock"><span class="hs-identifier hs-var">DwarfBlock</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dwChildren</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="Dwarf.html#tickToDwarf"><span class="hs-identifier hs-var">tickToDwarf</span></a><span> </span><a href="#local-6989586621684951524"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblTicks</span><span> </span><a href="#local-6989586621684951525"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Dwarf.html#blockToDwarf"><span class="hs-identifier hs-var">blockToDwarf</span></a><span> </span><a href="#local-6989586621684951524"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dblBlocks</span><span> </span><a href="#local-6989586621684951525"><span class="hs-identifier hs-var">blk</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwLabel</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><a href="#local-6989586621684951525"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-203"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwMarker</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951526"><span class="hs-identifier hs-var">marker</span></a><span>
</span><a name="line-204"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-205"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-6989586621684951526"><a href="#local-6989586621684951526"><span class="hs-identifier">marker</span></a></a><span>
</span><a name="line-207"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">dblPosition</span><span> </span><a href="#local-6989586621684951525"><span class="hs-identifier hs-var">blk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CLabel.html#mkAsmTempLabel"><span class="hs-identifier hs-var">mkAsmTempLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dblLabel</span><span> </span><a href="#local-6989586621684951525"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-208"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-comment">-- block was optimized out</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">tickToDwarf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Dwarf.Types.html#DwarfInfo"><span class="hs-identifier hs-type">DwarfInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-211"></a><a name="tickToDwarf"><a href="Dwarf.html#tickToDwarf"><span class="hs-identifier">tickToDwarf</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SourceNote</span><span> </span><a name="local-6989586621684951527"><a href="#local-6989586621684951527"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Dwarf.Types.html#DwarfSrcNote"><span class="hs-identifier hs-var">DwarfSrcNote</span></a><span> </span><a href="#local-6989586621684951527"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">]</span><span>
</span><a name="line-212"></a><span class="hs-identifier">tickToDwarf</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Generates the data for the debug frame section, which encodes the</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- desired stack unwind behaviour for the debugger</span><span>
</span><a name="line-216"></a><span class="hs-identifier">debugFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Dwarf.Types.html#DwarfFrame"><span class="hs-identifier hs-type">DwarfFrame</span></a><span>
</span><a name="line-217"></a><a name="debugFrame"><a href="Dwarf.html#debugFrame"><span class="hs-identifier">debugFrame</span></a></a><span> </span><a name="local-6989586621684951528"><a href="#local-6989586621684951528"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621684951529"><a href="#local-6989586621684951529"><span class="hs-identifier">procs</span></a></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfFrame"><span class="hs-identifier hs-var">DwarfFrame</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dwCieLabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkAsmTempLabel"><span class="hs-identifier hs-var">mkAsmTempLabel</span></a><span> </span><a href="#local-6989586621684951528"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-219"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwCieInit</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951530"><span class="hs-identifier hs-var">initUws</span></a><span>
</span><a name="line-220"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwCieProcs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Dwarf.html#procToFrame"><span class="hs-identifier hs-var">procToFrame</span></a><span> </span><a href="#local-6989586621684951530"><span class="hs-identifier hs-var">initUws</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684951529"><span class="hs-identifier hs-var">procs</span></a><span>
</span><a name="line-221"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-identifier">initUws</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Debug.html#UnwindTable"><span class="hs-identifier hs-type">UnwindTable</span></a><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621684951530"><a href="#local-6989586621684951530"><span class="hs-identifier">initUws</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#Sp"><span class="hs-identifier hs-var">Sp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Debug.html#UwReg"><span class="hs-identifier hs-var">UwReg</span></a><span> </span><a href="CmmExpr.html#Sp"><span class="hs-identifier hs-var">Sp</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- | Generates unwind information for a procedure debug block</span><span>
</span><a name="line-227"></a><span class="hs-identifier">procToFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Debug.html#UnwindTable"><span class="hs-identifier hs-type">UnwindTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Dwarf.Types.html#DwarfFrameProc"><span class="hs-identifier hs-type">DwarfFrameProc</span></a><span>
</span><a name="line-228"></a><a name="procToFrame"><a href="Dwarf.html#procToFrame"><span class="hs-identifier">procToFrame</span></a></a><span> </span><a name="local-6989586621684951531"><a href="#local-6989586621684951531"><span class="hs-identifier">initUws</span></a></a><span> </span><a name="local-6989586621684951532"><a href="#local-6989586621684951532"><span class="hs-identifier">blk</span></a></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfFrameProc"><span class="hs-identifier hs-var">DwarfFrameProc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dwFdeProc</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblCLabel</span><span> </span><a href="#local-6989586621684951532"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-230"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwFdeHasInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblHasInfoTbl</span><span> </span><a href="#local-6989586621684951532"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-231"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwFdeBlocks</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Dwarf.html#blockToFrame"><span class="hs-identifier hs-var">blockToFrame</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>                                        </span><span class="hs-special">(</span><a href="#local-6989586621684951535"><span class="hs-identifier hs-var">setHasInfo</span></a><span> </span><a href="#local-6989586621684951533"><span class="hs-identifier hs-var">blockUws</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-234"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">blockUws</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-235"></a><span>        </span><a name="local-6989586621684951533"><a href="#local-6989586621684951533"><span class="hs-identifier">blockUws</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684951534"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="#local-6989586621684951532"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>        </span><span class="hs-identifier">flatten</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span>
</span><a name="line-238"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-239"></a><span>        </span><a name="local-6989586621684951534"><a href="#local-6989586621684951534"><span class="hs-identifier">flatten</span></a></a><span> </span><a name="local-6989586621684951536"><a href="#local-6989586621684951536"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-var">DebugBlock</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">dblPosition</span><span class="hs-glyph">=</span><a name="local-6989586621684951537"><a href="#local-6989586621684951537"><span class="hs-identifier">pos</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dblUnwind</span><span class="hs-glyph">=</span><a name="local-6989586621684951538"><a href="#local-6989586621684951538"><span class="hs-identifier">uws</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dblBlocks</span><span class="hs-glyph">=</span><a name="local-6989586621684951539"><a href="#local-6989586621684951539"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-240"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684951542"><a href="#local-6989586621684951542"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684951537"><span class="hs-identifier hs-var">pos</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684951542"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684951536"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684951540"><span class="hs-identifier hs-var">uws'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621684951541"><span class="hs-identifier hs-var">nested</span></a><span>
</span><a name="line-241"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951541"><span class="hs-identifier hs-var">nested</span></a><span> </span><span class="hs-comment">-- block was optimized out</span><span>
</span><a name="line-242"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684951540"><a href="#local-6989586621684951540"><span class="hs-identifier">uws'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.html#addDefaultUnwindings"><span class="hs-identifier hs-var">addDefaultUnwindings</span></a><span> </span><a href="#local-6989586621684951531"><span class="hs-identifier hs-var">initUws</span></a><span> </span><a href="#local-6989586621684951538"><span class="hs-identifier hs-var">uws</span></a><span>
</span><a name="line-243"></a><span>                </span><a name="local-6989586621684951541"><a href="#local-6989586621684951541"><span class="hs-identifier">nested</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684951534"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="#local-6989586621684951539"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">-- | If the current procedure has an info table, then we also say that</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-comment">-- its first block has one to ensure that it gets the necessary -1</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">-- offset applied to its start address.</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">-- See Note [Info Offset] in Dwarf.Types.</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-identifier">setHasInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-250"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-251"></a><span>        </span><a name="local-6989586621684951535"><a href="#local-6989586621684951535"><span class="hs-identifier">setHasInfo</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-identifier">setHasInfo</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684951543"><a href="#local-6989586621684951543"><span class="hs-identifier">c0</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684951544"><a href="#local-6989586621684951544"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><a href="#local-6989586621684951545"><span class="hs-identifier hs-var">setIt</span></a><span> </span><a href="#local-6989586621684951543"><span class="hs-identifier hs-var">c0</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684951544"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-253"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-254"></a><span>            </span><a name="local-6989586621684951545"><a href="#local-6989586621684951545"><span class="hs-identifier">setIt</span></a></a><span> </span><a name="local-6989586621684951546"><a href="#local-6989586621684951546"><span class="hs-identifier">child</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-255"></a><span>              </span><a href="#local-6989586621684951546"><span class="hs-identifier hs-var">child</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dblHasInfoTbl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblHasInfoTbl</span><span> </span><a href="#local-6989586621684951546"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-256"></a><span>                                      </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">dblHasInfoTbl</span><span> </span><a href="#local-6989586621684951532"><span class="hs-identifier hs-var">blk</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-identifier">blockToFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Dwarf.Types.html#DwarfFrameBlock"><span class="hs-identifier hs-type">DwarfFrameBlock</span></a><span>
</span><a name="line-259"></a><a name="blockToFrame"><a href="Dwarf.html#blockToFrame"><span class="hs-identifier">blockToFrame</span></a></a><span> </span><a name="local-6989586621684951547"><a href="#local-6989586621684951547"><span class="hs-identifier">blk</span></a></a><span> </span><a name="local-6989586621684951548"><a href="#local-6989586621684951548"><span class="hs-identifier">uws</span></a></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Dwarf.Types.html#DwarfFrameBlock"><span class="hs-identifier hs-var">DwarfFrameBlock</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dwFdeBlkHasInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dblHasInfoTbl</span><span> </span><a href="#local-6989586621684951547"><span class="hs-identifier hs-var">blk</span></a><span>
</span><a name="line-261"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dwFdeUnwind</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684951548"><span class="hs-identifier hs-var">uws</span></a><span>
</span><a name="line-262"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-identifier">addDefaultUnwindings</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Debug.html#UnwindTable"><span class="hs-identifier hs-type">UnwindTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span>
</span><a name="line-265"></a><a name="addDefaultUnwindings"><a href="Dwarf.html#addDefaultUnwindings"><span class="hs-identifier">addDefaultUnwindings</span></a></a><span> </span><a name="local-6989586621684951549"><a href="#local-6989586621684951549"><span class="hs-identifier">tbl</span></a></a><span> </span><a name="local-6989586621684951550"><a href="#local-6989586621684951550"><span class="hs-identifier">pts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-special">[</span><span> </span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-var">UnwindPoint</span></a><span> </span><a href="#local-6989586621684951551"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684951552"><span class="hs-identifier hs-var">tbl'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684951549"><span class="hs-identifier hs-var">tbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>      </span><span class="hs-comment">-- mappend is left-biased</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-var">UnwindPoint</span></a><span> </span><a name="local-6989586621684951551"><a href="#local-6989586621684951551"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684951552"><a href="#local-6989586621684951552"><span class="hs-identifier">tbl'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684951550"><span class="hs-identifier hs-var">pts</span></a><span>
</span><a name="line-269"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-270"></a></pre></body></html>