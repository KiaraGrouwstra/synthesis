<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
-----------------------------------------------------------------------------
--
-- (c) The University of Glasgow 2001-2003
--
-- Access to system tools: gcc, cp, rm etc
--
-----------------------------------------------------------------------------
-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE CPP, MultiWayIf, ScopedTypeVariables #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SysTools</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>        </span><span class="hs-comment">-- * Initialisation</span><span>
</span><a name="line-15"></a><span>        </span><a href="SysTools.html#initSysTools"><span class="hs-identifier hs-var">initSysTools</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="SysTools.html#initLlvmConfig"><span class="hs-identifier hs-var">initLlvmConfig</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>        </span><span class="hs-comment">-- * Interface to system tools</span><span>
</span><a name="line-19"></a><span>        </span><span class="hs-keyword">module</span><span> </span><a href="SysTools.Tasks.html"><span class="hs-identifier">SysTools.Tasks</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><span class="hs-keyword">module</span><span> </span><a href="SysTools.Info.html"><span class="hs-identifier">SysTools.Info</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>        </span><a href="SysTools.html#linkDynLib"><span class="hs-identifier hs-var">linkDynLib</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>        </span><a href="SysTools.html#copy"><span class="hs-identifier hs-var">copy</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="SysTools.html#copyWithHeader"><span class="hs-identifier hs-var">copyWithHeader</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span>        </span><span class="hs-comment">-- * General utilities</span><span>
</span><a name="line-28"></a><span>        </span><span class="hs-identifier hs-type">Option</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><span class="hs-identifier hs-var">expandTopDir</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span>        </span><span class="hs-comment">-- * Platform-specifics</span><span>
</span><a name="line-32"></a><span>        </span><a href="SysTools.html#libmLinkOpts"><span class="hs-identifier hs-var">libmLinkOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>        </span><span class="hs-comment">-- * Mac OS X frameworks</span><span>
</span><a name="line-35"></a><span>        </span><a href="SysTools.html#getPkgFrameworkOpts"><span class="hs-identifier hs-var">getPkgFrameworkOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="SysTools.html#getFrameworkOpts"><span class="hs-identifier hs-var">getFrameworkOpts</span></a><span>
</span><a name="line-37"></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Config</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.ExtraObj.html"><span class="hs-identifier">SysTools.ExtraObj</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.Info.html"><span class="hs-identifier">SysTools.Info</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.Tasks.html"><span class="hs-identifier">SysTools.Tasks</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SysTools.BaseDir</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">{-
Note [How GHC finds toolchain utilities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

SysTools.initSysProgs figures out exactly where all the auxiliary programs
are, and initialises mutable variables to make it easy to call them.
To do this, it makes use of definitions in Config.hs, which is a Haskell
file containing variables whose value is figured out by the build system.

Config.hs contains two sorts of things

  cGCC,         The *names* of the programs
  cCPP            e.g.  cGCC = gcc
  cUNLIT                cCPP = gcc -E
  etc           They do *not* include paths


  cUNLIT_DIR   The *path* to the directory containing unlit, split etc
  cSPLIT_DIR   *relative* to the root of the build tree,
                   for use when running *in-place* in a build tree (only)


---------------------------------------------
NOTES for an ALTERNATIVE scheme (i.e *not* what is currently implemented):

Another hair-brained scheme for simplifying the current tool location
nightmare in GHC: Simon originally suggested using another
configuration file along the lines of GCC's specs file - which is fine
except that it means adding code to read yet another configuration
file.  What I didn't notice is that the current package.conf is
general enough to do this:

Package
    {name = &quot;tools&quot;,    import_dirs = [],  source_dirs = [],
     library_dirs = [], hs_libraries = [], extra_libraries = [],
     include_dirs = [], c_includes = [],   package_deps = [],
     extra_ghc_opts = [&quot;-pgmc/usr/bin/gcc&quot;,&quot;-pgml${topdir}/bin/unlit&quot;, ... etc.],
     extra_cc_opts = [], extra_ld_opts = []}

Which would have the advantage that we get to collect together in one
place the path-specific package stuff with the path-specific tool
stuff.
                End of NOTES
---------------------------------------------

************************************************************************
*                                                                      *
\subsection{Initialisation}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">initLlvmConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-114"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">LlvmConfig</span><span>
</span><a name="line-115"></a><a name="initLlvmConfig"><a href="SysTools.html#initLlvmConfig"><span class="hs-identifier">initLlvmConfig</span></a></a><span> </span><a name="local-6989586621681255754"><a href="#local-6989586621681255754"><span class="hs-identifier">top_dir</span></a></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-117"></a><span>      </span><a name="local-6989586621681255765"><a href="#local-6989586621681255765"><span class="hs-identifier">targets</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255755"><span class="hs-identifier hs-var">readAndParse</span></a><span> </span><span class="hs-string">&quot;llvm-targets&quot;</span><span> </span><a href="#local-6989586621681255756"><span class="hs-identifier hs-var">mkLlvmTarget</span></a><span>
</span><a name="line-118"></a><span>      </span><a name="local-6989586621681255766"><a href="#local-6989586621681255766"><span class="hs-identifier">passes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255755"><span class="hs-identifier hs-var">readAndParse</span></a><span> </span><span class="hs-string">&quot;llvm-passes&quot;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-119"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255765"><span class="hs-identifier hs-var">targets</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255766"><span class="hs-identifier hs-var">passes</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-121"></a><span>    </span><a name="local-6989586621681255755"><a href="#local-6989586621681255755"><span class="hs-identifier">readAndParse</span></a></a><span> </span><a name="local-6989586621681255757"><a href="#local-6989586621681255757"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621681255758"><a href="#local-6989586621681255758"><span class="hs-identifier">builder</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-122"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255759"><a href="#local-6989586621681255759"><span class="hs-identifier">llvmConfigFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255754"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621681255757"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-123"></a><span>         </span><a name="local-6989586621681255760"><a href="#local-6989586621681255760"><span class="hs-identifier">llvmConfigStr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621681255759"><span class="hs-identifier hs-var">llvmConfigFile</span></a><span>
</span><a name="line-124"></a><span>         </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">maybeReadFuzzy</span><span> </span><a href="#local-6989586621681255760"><span class="hs-identifier hs-var">llvmConfigStr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-125"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255761"><a href="#local-6989586621681255761"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621681255758"><span class="hs-identifier hs-var">builder</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621681255761"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Can't parse &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255759"><span class="hs-identifier hs-var">llvmConfigFile</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span>    </span><span class="hs-identifier">mkLlvmTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LlvmTarget</span><span>
</span><a name="line-129"></a><span>    </span><a name="local-6989586621681255756"><a href="#local-6989586621681255756"><span class="hs-identifier">mkLlvmTarget</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681255762"><a href="#local-6989586621681255762"><span class="hs-identifier">dl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681255763"><a href="#local-6989586621681255763"><span class="hs-identifier">cpu</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681255764"><a href="#local-6989586621681255764"><span class="hs-identifier">attrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LlvmTarget</span><span> </span><a href="#local-6989586621681255762"><span class="hs-identifier hs-var">dl</span></a><span> </span><a href="#local-6989586621681255763"><span class="hs-identifier hs-var">cpu</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621681255764"><span class="hs-identifier hs-var">attrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-identifier">initSysTools</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>          </span><span class="hs-comment">-- TopDir path</span><span>
</span><a name="line-133"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Settings</span><span>     </span><span class="hs-comment">-- Set all the mutable variables above, holding</span><span>
</span><a name="line-134"></a><span>                                </span><span class="hs-comment">--      (a) the system programs</span><span>
</span><a name="line-135"></a><span>                                </span><span class="hs-comment">--      (b) the package-config file</span><span>
</span><a name="line-136"></a><span>                                </span><span class="hs-comment">--      (c) the GHC usage message</span><span>
</span><a name="line-137"></a><a name="initSysTools"><a href="SysTools.html#initSysTools"><span class="hs-identifier">initSysTools</span></a></a><span> </span><a name="local-6989586621681255767"><a href="#local-6989586621681255767"><span class="hs-identifier">top_dir</span></a></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>       </span><span class="hs-comment">-- see Note [topdir: How GHC finds its files]</span><span>
</span><a name="line-139"></a><span>             </span><span class="hs-comment">-- NB: top_dir is assumed to be in standard Unix</span><span>
</span><a name="line-140"></a><span>             </span><span class="hs-comment">-- format, '/' separated</span><span>
</span><a name="line-141"></a><span>       </span><a name="local-6989586621681255768"><a href="#local-6989586621681255768"><span class="hs-identifier">mtool_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">findToolDir</span><span> </span><a href="#local-6989586621681255767"><span class="hs-identifier hs-var">top_dir</span></a><span>
</span><a name="line-142"></a><span>             </span><span class="hs-comment">-- see Note [tooldir: How GHC finds mingw and perl on Windows]</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">installed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-145"></a><span>           </span><a name="local-6989586621681255769"><a href="#local-6989586621681255769"><span class="hs-identifier">installed</span></a></a><span> </span><a name="local-6989586621681255773"><a href="#local-6989586621681255773"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255767"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621681255773"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-146"></a><span>           </span><span class="hs-identifier">libexec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-147"></a><span>           </span><a name="local-6989586621681255770"><a href="#local-6989586621681255770"><span class="hs-identifier">libexec</span></a></a><span> </span><a name="local-6989586621681255774"><a href="#local-6989586621681255774"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255767"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;bin&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621681255774"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-148"></a><span>           </span><a name="local-6989586621681255771"><a href="#local-6989586621681255771"><span class="hs-identifier">settingsFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255769"><span class="hs-identifier hs-var">installed</span></a><span> </span><span class="hs-string">&quot;settings&quot;</span><span>
</span><a name="line-149"></a><span>           </span><a name="local-6989586621681255772"><a href="#local-6989586621681255772"><span class="hs-identifier">platformConstantsFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255769"><span class="hs-identifier hs-var">installed</span></a><span> </span><span class="hs-string">&quot;platformConstants&quot;</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span>       </span><a name="local-6989586621681255775"><a href="#local-6989586621681255775"><span class="hs-identifier">settingsStr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621681255771"><span class="hs-identifier hs-var">settingsFile</span></a><span>
</span><a name="line-152"></a><span>       </span><a name="local-6989586621681255776"><a href="#local-6989586621681255776"><span class="hs-identifier">platformConstantsStr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621681255772"><span class="hs-identifier hs-var">platformConstantsFile</span></a><span>
</span><a name="line-153"></a><span>       </span><a name="local-6989586621681255778"><a href="#local-6989586621681255778"><span class="hs-identifier">mySettings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">maybeReadFuzzy</span><span> </span><a href="#local-6989586621681255775"><span class="hs-identifier hs-var">settingsStr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-154"></a><span>                     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255777"><a href="#local-6989586621681255777"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-155"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681255777"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-156"></a><span>                     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-157"></a><span>                         </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Can't parse &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255771"><span class="hs-identifier hs-var">settingsFile</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>       </span><a name="local-6989586621681255780"><a href="#local-6989586621681255780"><span class="hs-identifier">platformConstants</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">maybeReadFuzzy</span><span> </span><a href="#local-6989586621681255776"><span class="hs-identifier hs-var">platformConstantsStr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-159"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255779"><a href="#local-6989586621681255779"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-160"></a><span>                                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681255779"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-161"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-162"></a><span>                                </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Can't parse &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-163"></a><span>                                          </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255772"><span class="hs-identifier hs-var">platformConstantsFile</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255781"><a href="#local-6989586621681255781"><span class="hs-identifier">getSetting</span></a></a><span> </span><a name="local-6989586621681255785"><a href="#local-6989586621681255785"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621681255785"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621681255778"><span class="hs-identifier hs-var">mySettings</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-165"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255786"><a href="#local-6989586621681255786"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">expandTopDir</span><span> </span><a href="#local-6989586621681255767"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><a href="#local-6989586621681255786"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-166"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;No entry for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255785"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; in &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255771"><span class="hs-identifier hs-var">settingsFile</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>           </span><a name="local-6989586621681255782"><a href="#local-6989586621681255782"><span class="hs-identifier">getToolSetting</span></a></a><span> </span><a name="local-6989586621681255787"><a href="#local-6989586621681255787"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expandToolDir</span><span> </span><a href="#local-6989586621681255768"><span class="hs-identifier hs-var">mtool_dir</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><a href="#local-6989586621681255787"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-168"></a><span>           </span><a name="local-6989586621681255783"><a href="#local-6989586621681255783"><span class="hs-identifier">getBooleanSetting</span></a></a><span> </span><a name="local-6989586621681255788"><a href="#local-6989586621681255788"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621681255788"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621681255778"><span class="hs-identifier hs-var">mySettings</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-169"></a><span>                                   </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;YES&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-170"></a><span>                                   </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-string">&quot;NO&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-171"></a><span>                                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255789"><a href="#local-6989586621681255789"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Bad value for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255788"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255789"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>                                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;No entry for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255788"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; in &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255771"><span class="hs-identifier hs-var">settingsFile</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>           </span><a name="local-6989586621681255784"><a href="#local-6989586621681255784"><span class="hs-identifier">readSetting</span></a></a><span> </span><a name="local-6989586621681255790"><a href="#local-6989586621681255790"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621681255790"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621681255778"><span class="hs-identifier hs-var">mySettings</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-174"></a><span>                             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255791"><a href="#local-6989586621681255791"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-175"></a><span>                                 </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">maybeRead</span><span> </span><a href="#local-6989586621681255791"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-176"></a><span>                                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255792"><a href="#local-6989586621681255792"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681255792"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-177"></a><span>                                 </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Failed to read &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255790"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; value &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255791"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>                             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;No entry for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255790"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; in &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681255771"><span class="hs-identifier hs-var">settingsFile</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>       </span><a name="local-6989586621681255793"><a href="#local-6989586621681255793"><span class="hs-identifier">crossCompiling</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;cross compiling&quot;</span><span>
</span><a name="line-180"></a><span>       </span><a name="local-6989586621681255794"><a href="#local-6989586621681255794"><span class="hs-identifier">targetArch</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255784"><span class="hs-identifier hs-var">readSetting</span></a><span> </span><span class="hs-string">&quot;target arch&quot;</span><span>
</span><a name="line-181"></a><span>       </span><a name="local-6989586621681255795"><a href="#local-6989586621681255795"><span class="hs-identifier">targetOS</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255784"><span class="hs-identifier hs-var">readSetting</span></a><span> </span><span class="hs-string">&quot;target os&quot;</span><span>
</span><a name="line-182"></a><span>       </span><a name="local-6989586621681255796"><a href="#local-6989586621681255796"><span class="hs-identifier">targetWordSize</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255784"><span class="hs-identifier hs-var">readSetting</span></a><span> </span><span class="hs-string">&quot;target word size&quot;</span><span>
</span><a name="line-183"></a><span>       </span><a name="local-6989586621681255797"><a href="#local-6989586621681255797"><span class="hs-identifier">targetUnregisterised</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;Unregisterised&quot;</span><span>
</span><a name="line-184"></a><span>       </span><a name="local-6989586621681255798"><a href="#local-6989586621681255798"><span class="hs-identifier">targetHasGnuNonexecStack</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255784"><span class="hs-identifier hs-var">readSetting</span></a><span> </span><span class="hs-string">&quot;target has GNU nonexec stack&quot;</span><span>
</span><a name="line-185"></a><span>       </span><a name="local-6989586621681255799"><a href="#local-6989586621681255799"><span class="hs-identifier">targetHasIdentDirective</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255784"><span class="hs-identifier hs-var">readSetting</span></a><span> </span><span class="hs-string">&quot;target has .ident directive&quot;</span><span>
</span><a name="line-186"></a><span>       </span><a name="local-6989586621681255800"><a href="#local-6989586621681255800"><span class="hs-identifier">targetHasSubsectionsViaSymbols</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255784"><span class="hs-identifier hs-var">readSetting</span></a><span> </span><span class="hs-string">&quot;target has subsections via symbols&quot;</span><span>
</span><a name="line-187"></a><span>       </span><a name="local-6989586621681255801"><a href="#local-6989586621681255801"><span class="hs-identifier">myExtraGccViaCFlags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;GCC extra via C opts&quot;</span><span>
</span><a name="line-188"></a><span>       </span><span class="hs-comment">-- On Windows, mingw is distributed with GHC,</span><span>
</span><a name="line-189"></a><span>       </span><span class="hs-comment">-- so we look in TopDir/../mingw/bin,</span><span>
</span><a name="line-190"></a><span>       </span><span class="hs-comment">-- as well as TopDir/../../mingw/bin for hadrian.</span><span>
</span><a name="line-191"></a><span>       </span><span class="hs-comment">-- It would perhaps be nice to be able to override this</span><span>
</span><a name="line-192"></a><span>       </span><span class="hs-comment">-- with the settings file, but it would be a little fiddly</span><span>
</span><a name="line-193"></a><span>       </span><span class="hs-comment">-- to make that possible, so for now you can't.</span><span>
</span><a name="line-194"></a><span>       </span><a name="local-6989586621681255802"><a href="#local-6989586621681255802"><span class="hs-identifier">gcc_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;C compiler command&quot;</span><span>
</span><a name="line-195"></a><span>       </span><a name="local-6989586621681255803"><a href="#local-6989586621681255803"><span class="hs-identifier">gcc_args_str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;C compiler flags&quot;</span><span>
</span><a name="line-196"></a><span>       </span><a name="local-6989586621681255804"><a href="#local-6989586621681255804"><span class="hs-identifier">gccSupportsNoPie</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;C compiler supports -no-pie&quot;</span><span>
</span><a name="line-197"></a><span>       </span><a name="local-6989586621681255805"><a href="#local-6989586621681255805"><span class="hs-identifier">cpp_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;Haskell CPP command&quot;</span><span>
</span><a name="line-198"></a><span>       </span><a name="local-6989586621681255806"><a href="#local-6989586621681255806"><span class="hs-identifier">cpp_args_str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;Haskell CPP flags&quot;</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255807"><a href="#local-6989586621681255807"><span class="hs-identifier">unreg_gcc_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681255797"><span class="hs-identifier hs-var">targetUnregisterised</span></a><span>
</span><a name="line-200"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-DNO_REGS&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-DUSE_MINIINTERPRETER&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-201"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-202"></a><span>           </span><span class="hs-comment">-- TABLES_NEXT_TO_CODE affects the info table layout.</span><span>
</span><a name="line-203"></a><span>           </span><a name="local-6989586621681255808"><a href="#local-6989586621681255808"><span class="hs-identifier">tntc_gcc_args</span></a></a><span>
</span><a name="line-204"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">mkTablesNextToCode</span><span> </span><a href="#local-6989586621681255797"><span class="hs-identifier hs-var">targetUnregisterised</span></a><span>
</span><a name="line-205"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-DTABLES_NEXT_TO_CODE&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-206"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>           </span><a name="local-6989586621681255809"><a href="#local-6989586621681255809"><span class="hs-identifier">cpp_args</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621681255806"><span class="hs-identifier hs-var">cpp_args_str</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>           </span><a name="local-6989586621681255810"><a href="#local-6989586621681255810"><span class="hs-identifier">gcc_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621681255803"><span class="hs-identifier hs-var">gcc_args_str</span></a><span>
</span><a name="line-209"></a><span>                               </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255807"><span class="hs-identifier hs-var">unreg_gcc_args</span></a><span>
</span><a name="line-210"></a><span>                               </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255808"><span class="hs-identifier hs-var">tntc_gcc_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>       </span><a name="local-6989586621681255811"><a href="#local-6989586621681255811"><span class="hs-identifier">ldSupportsCompactUnwind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;ld supports compact unwind&quot;</span><span>
</span><a name="line-212"></a><span>       </span><a name="local-6989586621681255812"><a href="#local-6989586621681255812"><span class="hs-identifier">ldSupportsBuildId</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;ld supports build-id&quot;</span><span>
</span><a name="line-213"></a><span>       </span><a name="local-6989586621681255813"><a href="#local-6989586621681255813"><span class="hs-identifier">ldSupportsFilelist</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;ld supports filelist&quot;</span><span>
</span><a name="line-214"></a><span>       </span><a name="local-6989586621681255814"><a href="#local-6989586621681255814"><span class="hs-identifier">ldIsGnuLd</span></a></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255783"><span class="hs-identifier hs-var">getBooleanSetting</span></a><span> </span><span class="hs-string">&quot;ld is GNU ld&quot;</span><span>
</span><a name="line-215"></a><span>       </span><a name="local-6989586621681255815"><a href="#local-6989586621681255815"><span class="hs-identifier">perl_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;perl command&quot;</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255816"><a href="#local-6989586621681255816"><span class="hs-identifier">pkgconfig_path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255769"><span class="hs-identifier hs-var">installed</span></a><span> </span><span class="hs-string">&quot;package.conf.d&quot;</span><span>
</span><a name="line-218"></a><span>           </span><a name="local-6989586621681255817"><a href="#local-6989586621681255817"><span class="hs-identifier">ghc_usage_msg_path</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255769"><span class="hs-identifier hs-var">installed</span></a><span> </span><span class="hs-string">&quot;ghc-usage.txt&quot;</span><span>
</span><a name="line-219"></a><span>           </span><a name="local-6989586621681255818"><a href="#local-6989586621681255818"><span class="hs-identifier">ghci_usage_msg_path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255769"><span class="hs-identifier hs-var">installed</span></a><span> </span><span class="hs-string">&quot;ghci-usage.txt&quot;</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>             </span><span class="hs-comment">-- For all systems, unlit, split, mangle are GHC utilities</span><span>
</span><a name="line-222"></a><span>             </span><span class="hs-comment">-- architecture-specific stuff is done when building Config.hs</span><span>
</span><a name="line-223"></a><span>           </span><a name="local-6989586621681255819"><a href="#local-6989586621681255819"><span class="hs-identifier">unlit_path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255770"><span class="hs-identifier hs-var">libexec</span></a><span> </span><span class="hs-identifier hs-var">cGHC_UNLIT_PGM</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span>             </span><span class="hs-comment">-- split is a Perl script</span><span>
</span><a name="line-226"></a><span>           </span><a name="local-6989586621681255820"><a href="#local-6989586621681255820"><span class="hs-identifier">split_script</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255770"><span class="hs-identifier hs-var">libexec</span></a><span> </span><span class="hs-identifier hs-var">cGHC_SPLIT_PGM</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>       </span><a name="local-6989586621681255821"><a href="#local-6989586621681255821"><span class="hs-identifier">windres_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;windres command&quot;</span><span>
</span><a name="line-229"></a><span>       </span><a name="local-6989586621681255822"><a href="#local-6989586621681255822"><span class="hs-identifier">libtool_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;libtool command&quot;</span><span>
</span><a name="line-230"></a><span>       </span><a name="local-6989586621681255823"><a href="#local-6989586621681255823"><span class="hs-identifier">ar_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;ar command&quot;</span><span>
</span><a name="line-231"></a><span>       </span><a name="local-6989586621681255824"><a href="#local-6989586621681255824"><span class="hs-identifier">ranlib_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;ranlib command&quot;</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span>       </span><a name="local-6989586621681255825"><a href="#local-6989586621681255825"><span class="hs-identifier">tmpdir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getTemporaryDirectory</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span>       </span><a name="local-6989586621681255826"><a href="#local-6989586621681255826"><span class="hs-identifier">touch_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;touch command&quot;</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- On Win32 we don't want to rely on #!/bin/perl, so we prepend</span><span>
</span><a name="line-238"></a><span>           </span><span class="hs-comment">-- a call to Perl to get the invocation of split.</span><span>
</span><a name="line-239"></a><span>           </span><span class="hs-comment">-- On Unix, scripts are invoked using the '#!' method.  Binary</span><span>
</span><a name="line-240"></a><span>           </span><span class="hs-comment">-- installations of GHC on Unix place the correct line on the</span><span>
</span><a name="line-241"></a><span>           </span><span class="hs-comment">-- front of the script at installation time, so we don't want</span><span>
</span><a name="line-242"></a><span>           </span><span class="hs-comment">-- to wire-in our knowledge of $(PERL) on the host system here.</span><span>
</span><a name="line-243"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621681255827"><a href="#local-6989586621681255827"><span class="hs-identifier">split_prog</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621681255828"><a href="#local-6989586621681255828"><span class="hs-identifier">split_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWindowsHost</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255815"><span class="hs-identifier hs-var">perl_path</span></a><span class="hs-special">,</span><span>    </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255820"><span class="hs-identifier hs-var">split_script</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255820"><span class="hs-identifier hs-var">split_script</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>       </span><a name="local-6989586621681255829"><a href="#local-6989586621681255829"><span class="hs-identifier">mkdll_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255782"><span class="hs-identifier hs-var">getToolSetting</span></a><span> </span><span class="hs-string">&quot;dllwrap command&quot;</span><span>
</span><a name="line-247"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255830"><a href="#local-6989586621681255830"><span class="hs-identifier">mkdll_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>       </span><span class="hs-comment">-- cpp is derived from gcc on all platforms</span><span>
</span><a name="line-250"></a><span>       </span><span class="hs-comment">-- HACK, see setPgmP below. We keep 'words' here to remember to fix</span><span>
</span><a name="line-251"></a><span>       </span><span class="hs-comment">-- Config.hs one day.</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span>       </span><span class="hs-comment">-- Other things being equal, as and ld are simply gcc</span><span>
</span><a name="line-255"></a><span>       </span><a name="local-6989586621681255831"><a href="#local-6989586621681255831"><span class="hs-identifier">gcc_link_args_str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;C compiler link flags&quot;</span><span>
</span><a name="line-256"></a><span>       </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621681255832"><a href="#local-6989586621681255832"><span class="hs-identifier">as_prog</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255802"><span class="hs-identifier hs-var">gcc_prog</span></a><span>
</span><a name="line-257"></a><span>             </span><a name="local-6989586621681255833"><a href="#local-6989586621681255833"><span class="hs-identifier">as_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255810"><span class="hs-identifier hs-var">gcc_args</span></a><span>
</span><a name="line-258"></a><span>             </span><a name="local-6989586621681255834"><a href="#local-6989586621681255834"><span class="hs-identifier">ld_prog</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255802"><span class="hs-identifier hs-var">gcc_prog</span></a><span>
</span><a name="line-259"></a><span>             </span><a name="local-6989586621681255835"><a href="#local-6989586621681255835"><span class="hs-identifier">ld_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255810"><span class="hs-identifier hs-var">gcc_args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621681255831"><span class="hs-identifier hs-var">gcc_link_args_str</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>       </span><span class="hs-comment">-- We just assume on command line</span><span>
</span><a name="line-262"></a><span>       </span><a name="local-6989586621681255836"><a href="#local-6989586621681255836"><span class="hs-identifier">lc_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;LLVM llc command&quot;</span><span>
</span><a name="line-263"></a><span>       </span><a name="local-6989586621681255837"><a href="#local-6989586621681255837"><span class="hs-identifier">lo_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;LLVM opt command&quot;</span><span>
</span><a name="line-264"></a><span>       </span><a name="local-6989586621681255838"><a href="#local-6989586621681255838"><span class="hs-identifier">lcc_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255781"><span class="hs-identifier hs-var">getSetting</span></a><span> </span><span class="hs-string">&quot;LLVM clang command&quot;</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255839"><a href="#local-6989586621681255839"><span class="hs-identifier">iserv_prog</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255770"><span class="hs-identifier hs-var">libexec</span></a><span> </span><span class="hs-string">&quot;ghc-iserv&quot;</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255840"><a href="#local-6989586621681255840"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Platform</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-269"></a><span>                          </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255794"><span class="hs-identifier hs-var">targetArch</span></a><span class="hs-special">,</span><span>
</span><a name="line-270"></a><span>                          </span><span class="hs-identifier">platformOS</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255795"><span class="hs-identifier hs-var">targetOS</span></a><span class="hs-special">,</span><span>
</span><a name="line-271"></a><span>                          </span><span class="hs-identifier">platformWordSize</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255796"><span class="hs-identifier hs-var">targetWordSize</span></a><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>                          </span><span class="hs-identifier">platformUnregisterised</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255797"><span class="hs-identifier hs-var">targetUnregisterised</span></a><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>                          </span><span class="hs-identifier">platformHasGnuNonexecStack</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255798"><span class="hs-identifier hs-var">targetHasGnuNonexecStack</span></a><span class="hs-special">,</span><span>
</span><a name="line-274"></a><span>                          </span><span class="hs-identifier">platformHasIdentDirective</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255799"><span class="hs-identifier hs-var">targetHasIdentDirective</span></a><span class="hs-special">,</span><span>
</span><a name="line-275"></a><span>                          </span><span class="hs-identifier">platformHasSubsectionsViaSymbols</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255800"><span class="hs-identifier hs-var">targetHasSubsectionsViaSymbols</span></a><span class="hs-special">,</span><span>
</span><a name="line-276"></a><span>                          </span><span class="hs-identifier">platformIsCrossCompiling</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255793"><span class="hs-identifier hs-var">crossCompiling</span></a><span>
</span><a name="line-277"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Settings</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-280"></a><span>                    </span><span class="hs-identifier">sTargetPlatform</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255840"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">,</span><span>
</span><a name="line-281"></a><span>                    </span><span class="hs-identifier">sTmpDir</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">normalise</span><span> </span><a href="#local-6989586621681255825"><span class="hs-identifier hs-var">tmpdir</span></a><span class="hs-special">,</span><span>
</span><a name="line-282"></a><span>                    </span><span class="hs-identifier">sGhcUsagePath</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255817"><span class="hs-identifier hs-var">ghc_usage_msg_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-283"></a><span>                    </span><span class="hs-identifier">sGhciUsagePath</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255818"><span class="hs-identifier hs-var">ghci_usage_msg_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-284"></a><span>                    </span><span class="hs-identifier">sToolDir</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255768"><span class="hs-identifier hs-var">mtool_dir</span></a><span class="hs-special">,</span><span>
</span><a name="line-285"></a><span>                    </span><span class="hs-identifier">sTopDir</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255767"><span class="hs-identifier hs-var">top_dir</span></a><span class="hs-special">,</span><span>
</span><a name="line-286"></a><span>                    </span><span class="hs-identifier">sRawSettings</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255778"><span class="hs-identifier hs-var">mySettings</span></a><span class="hs-special">,</span><span>
</span><a name="line-287"></a><span>                    </span><span class="hs-identifier">sExtraGccViaCFlags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621681255801"><span class="hs-identifier hs-var">myExtraGccViaCFlags</span></a><span class="hs-special">,</span><span>
</span><a name="line-288"></a><span>                    </span><span class="hs-identifier">sSystemPackageConfig</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255816"><span class="hs-identifier hs-var">pkgconfig_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-289"></a><span>                    </span><span class="hs-identifier">sLdSupportsCompactUnwind</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255811"><span class="hs-identifier hs-var">ldSupportsCompactUnwind</span></a><span class="hs-special">,</span><span>
</span><a name="line-290"></a><span>                    </span><span class="hs-identifier">sLdSupportsBuildId</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255812"><span class="hs-identifier hs-var">ldSupportsBuildId</span></a><span class="hs-special">,</span><span>
</span><a name="line-291"></a><span>                    </span><span class="hs-identifier">sLdSupportsFilelist</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255813"><span class="hs-identifier hs-var">ldSupportsFilelist</span></a><span class="hs-special">,</span><span>
</span><a name="line-292"></a><span>                    </span><span class="hs-identifier">sLdIsGnuLd</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255814"><span class="hs-identifier hs-var">ldIsGnuLd</span></a><span class="hs-special">,</span><span>
</span><a name="line-293"></a><span>                    </span><span class="hs-identifier">sGccSupportsNoPie</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255804"><span class="hs-identifier hs-var">gccSupportsNoPie</span></a><span class="hs-special">,</span><span>
</span><a name="line-294"></a><span>                    </span><span class="hs-identifier">sProgramName</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;ghc&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-295"></a><span>                    </span><span class="hs-identifier">sProjectVersion</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cProjectVersion</span><span class="hs-special">,</span><span>
</span><a name="line-296"></a><span>                    </span><span class="hs-identifier">sPgm_L</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255819"><span class="hs-identifier hs-var">unlit_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-297"></a><span>                    </span><span class="hs-identifier">sPgm_P</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255805"><span class="hs-identifier hs-var">cpp_prog</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255809"><span class="hs-identifier hs-var">cpp_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-298"></a><span>                    </span><span class="hs-identifier">sPgm_F</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-299"></a><span>                    </span><span class="hs-identifier">sPgm_c</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255802"><span class="hs-identifier hs-var">gcc_prog</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255810"><span class="hs-identifier hs-var">gcc_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-300"></a><span>                    </span><span class="hs-identifier">sPgm_s</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255827"><span class="hs-identifier hs-var">split_prog</span></a><span class="hs-special">,</span><a href="#local-6989586621681255828"><span class="hs-identifier hs-var">split_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-301"></a><span>                    </span><span class="hs-identifier">sPgm_a</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255832"><span class="hs-identifier hs-var">as_prog</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255833"><span class="hs-identifier hs-var">as_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-302"></a><span>                    </span><span class="hs-identifier">sPgm_l</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255834"><span class="hs-identifier hs-var">ld_prog</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255835"><span class="hs-identifier hs-var">ld_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-303"></a><span>                    </span><span class="hs-identifier">sPgm_dll</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255829"><span class="hs-identifier hs-var">mkdll_prog</span></a><span class="hs-special">,</span><a href="#local-6989586621681255830"><span class="hs-identifier hs-var">mkdll_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-304"></a><span>                    </span><span class="hs-identifier">sPgm_T</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255826"><span class="hs-identifier hs-var">touch_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-305"></a><span>                    </span><span class="hs-identifier">sPgm_windres</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255821"><span class="hs-identifier hs-var">windres_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-306"></a><span>                    </span><span class="hs-identifier">sPgm_libtool</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255822"><span class="hs-identifier hs-var">libtool_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-307"></a><span>                    </span><span class="hs-identifier">sPgm_ar</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255823"><span class="hs-identifier hs-var">ar_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-308"></a><span>                    </span><span class="hs-identifier">sPgm_ranlib</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255824"><span class="hs-identifier hs-var">ranlib_path</span></a><span class="hs-special">,</span><span>
</span><a name="line-309"></a><span>                    </span><span class="hs-identifier">sPgm_lo</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255837"><span class="hs-identifier hs-var">lo_prog</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-310"></a><span>                    </span><span class="hs-identifier">sPgm_lc</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255836"><span class="hs-identifier hs-var">lc_prog</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-311"></a><span>                    </span><span class="hs-identifier">sPgm_lcc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255838"><span class="hs-identifier hs-var">lcc_prog</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-312"></a><span>                    </span><span class="hs-identifier">sPgm_i</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255839"><span class="hs-identifier hs-var">iserv_prog</span></a><span class="hs-special">,</span><span>
</span><a name="line-313"></a><span>                    </span><span class="hs-identifier">sOpt_L</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-314"></a><span>                    </span><span class="hs-identifier">sOpt_P</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-315"></a><span>                    </span><span class="hs-identifier">sOpt_P_fingerprint</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-316"></a><span>                    </span><span class="hs-identifier">sOpt_F</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-317"></a><span>                    </span><span class="hs-identifier">sOpt_c</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-318"></a><span>                    </span><span class="hs-identifier">sOpt_a</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-319"></a><span>                    </span><span class="hs-identifier">sOpt_l</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-320"></a><span>                    </span><span class="hs-identifier">sOpt_windres</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-321"></a><span>                    </span><span class="hs-identifier">sOpt_lcc</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-322"></a><span>                    </span><span class="hs-identifier">sOpt_lo</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-323"></a><span>                    </span><span class="hs-identifier">sOpt_lc</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-324"></a><span>                    </span><span class="hs-identifier">sOpt_i</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-325"></a><span>                    </span><span class="hs-identifier">sPlatformConstants</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255780"><span class="hs-identifier hs-var">platformConstants</span></a><span>
</span><a name="line-326"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-comment">{- Note [Windows stack usage]

See: Trac #8870 (and #8834 for related info) and #12186

On Windows, occasionally we need to grow the stack. In order to do
this, we would normally just bump the stack pointer - but there's a
catch on Windows.

If the stack pointer is bumped by more than a single page, then the
pages between the initial pointer and the resulting location must be
properly committed by the Windows virtual memory subsystem. This is
only needed in the event we bump by more than one page (i.e 4097 bytes
or more).

Windows compilers solve this by emitting a call to a special function
called _chkstk, which does this committing of the pages for you.

The reason this was causing a segfault was because due to the fact the
new code generator tends to generate larger functions, we needed more
stack space in GHC itself. In the x86 codegen, we needed approximately
~12kb of stack space in one go, which caused the process to segfault,
as the intervening pages were not committed.

GCC can emit such a check for us automatically but only when the flag
-fstack-check is used.

See https://gcc.gnu.org/onlinedocs/gnat_ugn/Stack-Overflow-Checking.html
for more information.

-}</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-identifier">copy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-361"></a><a name="copy"><a href="SysTools.html#copy"><span class="hs-identifier">copy</span></a></a><span> </span><a name="local-6989586621681255841"><a href="#local-6989586621681255841"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681255842"><a href="#local-6989586621681255842"><span class="hs-identifier">purpose</span></a></a><span> </span><a name="local-6989586621681255843"><a href="#local-6989586621681255843"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621681255844"><a href="#local-6989586621681255844"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.html#copyWithHeader"><span class="hs-identifier hs-var">copyWithHeader</span></a><span> </span><a href="#local-6989586621681255841"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255842"><span class="hs-identifier hs-var">purpose</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681255843"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621681255844"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">copyWithHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-364"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-365"></a><a name="copyWithHeader"><a href="SysTools.html#copyWithHeader"><span class="hs-identifier">copyWithHeader</span></a></a><span> </span><a name="local-6989586621681255845"><a href="#local-6989586621681255845"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681255846"><a href="#local-6989586621681255846"><span class="hs-identifier">purpose</span></a></a><span> </span><a name="local-6989586621681255847"><a href="#local-6989586621681255847"><span class="hs-identifier">maybe_header</span></a></a><span> </span><a name="local-6989586621681255848"><a href="#local-6989586621681255848"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621681255849"><a href="#local-6989586621681255849"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-366"></a><span>  </span><span class="hs-identifier hs-var">showPass</span><span> </span><a href="#local-6989586621681255845"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255846"><span class="hs-identifier hs-var">purpose</span></a><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span>  </span><a name="local-6989586621681255853"><a href="#local-6989586621681255853"><span class="hs-identifier">hout</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">openBinaryFile</span><span> </span><a href="#local-6989586621681255849"><span class="hs-identifier hs-var">to</span></a><span>   </span><span class="hs-identifier hs-var">WriteMode</span><span>
</span><a name="line-369"></a><span>  </span><a name="local-6989586621681255854"><a href="#local-6989586621681255854"><span class="hs-identifier">hin</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">openBinaryFile</span><span> </span><a href="#local-6989586621681255848"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-identifier hs-var">ReadMode</span><span>
</span><a name="line-370"></a><span>  </span><a name="local-6989586621681255855"><a href="#local-6989586621681255855"><span class="hs-identifier">ls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hGetContents</span><span> </span><a href="#local-6989586621681255854"><span class="hs-identifier hs-var">hin</span></a><span> </span><span class="hs-comment">-- inefficient, but it'll do for now. ToDo: speed up</span><span>
</span><a name="line-371"></a><span>  </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255850"><span class="hs-identifier hs-var">header</span></a><span> </span><a href="#local-6989586621681255853"><span class="hs-identifier hs-var">hout</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681255847"><span class="hs-identifier hs-var">maybe_header</span></a><span>
</span><a name="line-372"></a><span>  </span><span class="hs-identifier hs-var">hPutStr</span><span> </span><a href="#local-6989586621681255853"><span class="hs-identifier hs-var">hout</span></a><span> </span><a href="#local-6989586621681255855"><span class="hs-identifier hs-var">ls</span></a><span>
</span><a name="line-373"></a><span>  </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621681255853"><span class="hs-identifier hs-var">hout</span></a><span>
</span><a name="line-374"></a><span>  </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621681255854"><span class="hs-identifier hs-var">hin</span></a><span>
</span><a name="line-375"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-376"></a><span>  </span><span class="hs-comment">-- write the header string in UTF-8.  The header is something like</span><span>
</span><a name="line-377"></a><span>  </span><span class="hs-comment">--   {-# LINE &quot;foo.hs&quot; #-}</span><span>
</span><a name="line-378"></a><span>  </span><span class="hs-comment">-- and we want to make sure a Unicode filename isn't mangled.</span><span>
</span><a name="line-379"></a><span>  </span><a name="local-6989586621681255850"><a href="#local-6989586621681255850"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621681255851"><a href="#local-6989586621681255851"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621681255852"><a href="#local-6989586621681255852"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-380"></a><span>   </span><span class="hs-identifier hs-var">hSetEncoding</span><span> </span><a href="#local-6989586621681255851"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-identifier hs-var">utf8</span><span>
</span><a name="line-381"></a><span>   </span><span class="hs-identifier hs-var">hPutStr</span><span> </span><a href="#local-6989586621681255851"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621681255852"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-382"></a><span>   </span><span class="hs-identifier hs-var">hSetBinaryMode</span><span> </span><a href="#local-6989586621681255851"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Support code}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-identifier">linkDynLib</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><a name="linkDynLib"><a href="SysTools.html#linkDynLib"><span class="hs-identifier">linkDynLib</span></a></a><span> </span><a name="local-6989586621681255856"><a href="#local-6989586621681255856"><span class="hs-identifier">dflags0</span></a></a><span> </span><a name="local-6989586621681255857"><a href="#local-6989586621681255857"><span class="hs-identifier">o_files</span></a></a><span> </span><a name="local-6989586621681255858"><a href="#local-6989586621681255858"><span class="hs-identifier">dep_packages</span></a></a><span>
</span><a name="line-394"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- This is a rather ugly hack to fix dynamically linked</span><span>
</span><a name="line-396"></a><span>        </span><span class="hs-comment">-- GHC on Windows. If GHC is linked with -threaded, then</span><span>
</span><a name="line-397"></a><span>        </span><span class="hs-comment">-- it links against libHSrts_thr. But if base is linked</span><span>
</span><a name="line-398"></a><span>        </span><span class="hs-comment">-- against libHSrts, then both end up getting loaded,</span><span>
</span><a name="line-399"></a><span>        </span><span class="hs-comment">-- and things go wrong. We therefore link the libraries</span><span>
</span><a name="line-400"></a><span>        </span><span class="hs-comment">-- with the same RTS flags that we link GHC with.</span><span>
</span><a name="line-401"></a><span>        </span><a name="local-6989586621681255859"><a href="#local-6989586621681255859"><span class="hs-identifier">dflags1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">cGhcThreaded</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">addWay'</span><span> </span><span class="hs-identifier hs-var">WayThreaded</span><span> </span><a href="#local-6989586621681255856"><span class="hs-identifier hs-var">dflags0</span></a><span>
</span><a name="line-402"></a><span>                                  </span><span class="hs-keyword">else</span><span>                     </span><a href="#local-6989586621681255856"><span class="hs-identifier hs-var">dflags0</span></a><span>
</span><a name="line-403"></a><span>        </span><a name="local-6989586621681255860"><a href="#local-6989586621681255860"><span class="hs-identifier">dflags2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">cGhcDebugged</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">addWay'</span><span> </span><span class="hs-identifier hs-var">WayDebug</span><span> </span><a href="#local-6989586621681255859"><span class="hs-identifier hs-var">dflags1</span></a><span>
</span><a name="line-404"></a><span>                                  </span><span class="hs-keyword">else</span><span>                  </span><a href="#local-6989586621681255859"><span class="hs-identifier hs-var">dflags1</span></a><span>
</span><a name="line-405"></a><span>        </span><a name="local-6989586621681255861"><a href="#local-6989586621681255861"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updateWays</span><span> </span><a href="#local-6989586621681255860"><span class="hs-identifier hs-var">dflags2</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>        </span><a name="local-6989586621681255862"><a href="#local-6989586621681255862"><span class="hs-identifier">verbFlags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getVerbFlags</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-408"></a><span>        </span><a name="local-6989586621681255863"><a href="#local-6989586621681255863"><span class="hs-identifier">o_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span>    </span><a name="local-6989586621681255864"><a href="#local-6989586621681255864"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPreloadPackagesAnd</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255858"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255865"><a href="#local-6989586621681255865"><span class="hs-identifier">pkg_lib_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectLibraryPaths</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255864"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-413"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255866"><a href="#local-6989586621681255866"><span class="hs-identifier">pkg_lib_path_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621681255867"><span class="hs-identifier hs-var">get_pkg_lib_path_opts</span></a><span> </span><a href="#local-6989586621681255865"><span class="hs-identifier hs-var">pkg_lib_paths</span></a><span>
</span><a name="line-414"></a><span>        </span><a name="local-6989586621681255867"><a href="#local-6989586621681255867"><span class="hs-identifier">get_pkg_lib_path_opts</span></a></a><span> </span><a name="local-6989586621681255868"><a href="#local-6989586621681255868"><span class="hs-identifier">l</span></a></a><span>
</span><a name="line-415"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-416"></a><span>             </span><span class="hs-identifier hs-var">osMachOTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-417"></a><span>           </span><span class="hs-identifier">dynLibLoader</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">SystemDependent</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-418"></a><span>           </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-419"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255868"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-rpath&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255868"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-420"></a><span>              </span><span class="hs-comment">-- See Note [-Xlinker -rpath vs -Wl,-rpath]</span><span>
</span><a name="line-421"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255868"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255869"><a href="#local-6989586621681255869"><span class="hs-identifier">lib_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">libraryPaths</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-424"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255870"><a href="#local-6989586621681255870"><span class="hs-identifier">lib_path_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-L&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681255869"><span class="hs-identifier hs-var">lib_paths</span></a><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span>    </span><span class="hs-comment">-- We don't want to link our dynamic libs against the RTS package,</span><span>
</span><a name="line-427"></a><span>    </span><span class="hs-comment">-- because the RTS lib comes in several flavours and we want to be</span><span>
</span><a name="line-428"></a><span>    </span><span class="hs-comment">-- able to pick the flavour when a binary is linked.</span><span>
</span><a name="line-429"></a><span>    </span><span class="hs-comment">-- On Windows we need to link the RTS import lib as Windows does</span><span>
</span><a name="line-430"></a><span>    </span><span class="hs-comment">-- not allow undefined symbols.</span><span>
</span><a name="line-431"></a><span>    </span><span class="hs-comment">-- The RTS library path is still added to the library search path</span><span>
</span><a name="line-432"></a><span>    </span><span class="hs-comment">-- above in case the RTS is being explicitly linked in (see #3807).</span><span>
</span><a name="line-433"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255871"><a href="#local-6989586621681255871"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-434"></a><span>        </span><a name="local-6989586621681255872"><a href="#local-6989586621681255872"><span class="hs-identifier">os</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621681255871"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-435"></a><span>        </span><a name="local-6989586621681255873"><a href="#local-6989586621681255873"><span class="hs-identifier">pkgs_no_rts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681255872"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-436"></a><span>                      </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-437"></a><span>                          </span><a href="#local-6989586621681255864"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-438"></a><span>                      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-439"></a><span>                          </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">packageConfigId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681255864"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-440"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255874"><a href="#local-6989586621681255874"><span class="hs-identifier">pkg_link_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681255875"><a href="#local-6989586621681255875"><span class="hs-identifier">package_hs_libs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681255876"><a href="#local-6989586621681255876"><span class="hs-identifier">extra_libs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681255877"><a href="#local-6989586621681255877"><span class="hs-identifier">other_flags</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectLinkOpts</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255873"><span class="hs-identifier hs-var">pkgs_no_rts</span></a><span>
</span><a name="line-441"></a><span>                        </span><span class="hs-keyword">in</span><span>  </span><a href="#local-6989586621681255875"><span class="hs-identifier hs-var">package_hs_libs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255876"><span class="hs-identifier hs-var">extra_libs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255877"><span class="hs-identifier hs-var">other_flags</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>        </span><span class="hs-comment">-- probably _stub.o files</span><span>
</span><a name="line-444"></a><span>        </span><span class="hs-comment">-- and last temporary shared object file</span><span>
</span><a name="line-445"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255878"><a href="#local-6989586621681255878"><span class="hs-identifier">extra_ld_inputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span>    </span><span class="hs-comment">-- frameworks</span><span>
</span><a name="line-448"></a><span>    </span><a name="local-6989586621681255879"><a href="#local-6989586621681255879"><span class="hs-identifier">pkg_framework_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.html#getPkgFrameworkOpts"><span class="hs-identifier hs-var">getPkgFrameworkOpts</span></a><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255871"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-449"></a><span>                                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681255864"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255880"><a href="#local-6989586621681255880"><span class="hs-identifier">framework_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.html#getFrameworkOpts"><span class="hs-identifier hs-var">getFrameworkOpts</span></a><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255871"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681255872"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-453"></a><span>        </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-454"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------</span><span>
</span><a name="line-455"></a><span>            </span><span class="hs-comment">-- Making a DLL</span><span>
</span><a name="line-456"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------</span><span>
</span><a name="line-457"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255881"><a href="#local-6989586621681255881"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681255863"><span class="hs-identifier hs-var">o_file</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-458"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255882"><a href="#local-6989586621681255882"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681255882"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-459"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;HSdll.dll&quot;</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span>            </span><a href="SysTools.Tasks.html#runLink"><span class="hs-identifier hs-var">runLink</span></a><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-462"></a><span>                    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255862"><span class="hs-identifier hs-var">verbFlags</span></a><span>
</span><a name="line-463"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-464"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681255881"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-465"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-shared&quot;</span><span>
</span><a name="line-466"></a><span>                    </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-467"></a><span>                    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;-Wl,--out-implib=&quot;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255881"><span class="hs-identifier hs-var">output_fn</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.a&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SharedImplib</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-469"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-470"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681255857"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span>                 </span><span class="hs-comment">-- Permit the linker to auto link _symbol to _imp_symbol</span><span>
</span><a name="line-473"></a><span>                 </span><span class="hs-comment">-- This lets us link against DLLs without needing an &quot;import library&quot;</span><span>
</span><a name="line-474"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Wl,--enable-auto-import&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255878"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span>
</span><a name="line-477"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-478"></a><span>                    </span><a href="#local-6989586621681255870"><span class="hs-identifier hs-var">lib_path_opts</span></a><span>
</span><a name="line-479"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255866"><span class="hs-identifier hs-var">pkg_lib_path_opts</span></a><span>
</span><a name="line-480"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255874"><span class="hs-identifier hs-var">pkg_link_opts</span></a><span>
</span><a name="line-481"></a><span>                </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681255872"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-483"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><a name="line-484"></a><span>            </span><span class="hs-comment">-- Making a darwin dylib</span><span>
</span><a name="line-485"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><a name="line-486"></a><span>            </span><span class="hs-comment">-- About the options used for Darwin:</span><span>
</span><a name="line-487"></a><span>            </span><span class="hs-comment">-- -dynamiclib</span><span>
</span><a name="line-488"></a><span>            </span><span class="hs-comment">--   Apple's way of saying -shared</span><span>
</span><a name="line-489"></a><span>            </span><span class="hs-comment">-- -undefined dynamic_lookup:</span><span>
</span><a name="line-490"></a><span>            </span><span class="hs-comment">--   Without these options, we'd have to specify the correct</span><span>
</span><a name="line-491"></a><span>            </span><span class="hs-comment">--   dependencies for each of the dylibs. Note that we could</span><span>
</span><a name="line-492"></a><span>            </span><span class="hs-comment">--   (and should) do without this for all libraries except</span><span>
</span><a name="line-493"></a><span>            </span><span class="hs-comment">--   the RTS; all we need to do is to pass the correct</span><span>
</span><a name="line-494"></a><span>            </span><span class="hs-comment">--   HSfoo_dyn.dylib files to the link command.</span><span>
</span><a name="line-495"></a><span>            </span><span class="hs-comment">--   This feature requires Mac OS X 10.3 or later; there is</span><span>
</span><a name="line-496"></a><span>            </span><span class="hs-comment">--   a similar feature, -flat_namespace -undefined suppress,</span><span>
</span><a name="line-497"></a><span>            </span><span class="hs-comment">--   which works on earlier versions, but it has other</span><span>
</span><a name="line-498"></a><span>            </span><span class="hs-comment">--   disadvantages.</span><span>
</span><a name="line-499"></a><span>            </span><span class="hs-comment">-- -single_module</span><span>
</span><a name="line-500"></a><span>            </span><span class="hs-comment">--   Build the dynamic library as a single &quot;module&quot;, i.e. no</span><span>
</span><a name="line-501"></a><span>            </span><span class="hs-comment">--   dynamic binding nonsense when referring to symbols from</span><span>
</span><a name="line-502"></a><span>            </span><span class="hs-comment">--   within the library. The NCG assumes that this option is</span><span>
</span><a name="line-503"></a><span>            </span><span class="hs-comment">--   specified (on i386, at least).</span><span>
</span><a name="line-504"></a><span>            </span><span class="hs-comment">-- -install_name</span><span>
</span><a name="line-505"></a><span>            </span><span class="hs-comment">--   Mac OS/X stores the path where a dynamic library is (to</span><span>
</span><a name="line-506"></a><span>            </span><span class="hs-comment">--   be) installed in the library itself.  It's called the</span><span>
</span><a name="line-507"></a><span>            </span><span class="hs-comment">--   &quot;install name&quot; of the library. Then any library or</span><span>
</span><a name="line-508"></a><span>            </span><span class="hs-comment">--   executable that links against it before it's installed</span><span>
</span><a name="line-509"></a><span>            </span><span class="hs-comment">--   will search for it in its ultimate install location.</span><span>
</span><a name="line-510"></a><span>            </span><span class="hs-comment">--   By default we set the install name to the absolute path</span><span>
</span><a name="line-511"></a><span>            </span><span class="hs-comment">--   at build time, but it can be overridden by the</span><span>
</span><a name="line-512"></a><span>            </span><span class="hs-comment">--   -dylib-install-name option passed to ghc. Cabal does</span><span>
</span><a name="line-513"></a><span>            </span><span class="hs-comment">--   this.</span><span>
</span><a name="line-514"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255883"><a href="#local-6989586621681255883"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681255863"><span class="hs-identifier hs-var">o_file</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255884"><a href="#local-6989586621681255884"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681255884"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;a.out&quot;</span><span class="hs-special">;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span>            </span><a name="local-6989586621681255886"><a href="#local-6989586621681255886"><span class="hs-identifier">instName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">dylibInstallName</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-519"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255885"><a href="#local-6989586621681255885"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681255885"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-520"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;@rpath&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">combine</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeFileName</span><span> </span><a href="#local-6989586621681255883"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>            </span><a href="SysTools.Tasks.html#runLink"><span class="hs-identifier hs-var">runLink</span></a><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-522"></a><span>                    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255862"><span class="hs-identifier hs-var">verbFlags</span></a><span>
</span><a name="line-523"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-dynamiclib&quot;</span><span>
</span><a name="line-524"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-525"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681255883"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-526"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-527"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255857"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-528"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-undefined&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-529"></a><span>                      </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;dynamic_lookup&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-530"></a><span>                      </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-single_module&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-531"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621681255871"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span>
</span><a name="line-532"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-533"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Wl,-read_only_relocs,suppress&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-install_name&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255886"><span class="hs-identifier hs-var">instName</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-535"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255870"><span class="hs-identifier hs-var">lib_path_opts</span></a><span>
</span><a name="line-536"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255878"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span>
</span><a name="line-537"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255880"><span class="hs-identifier hs-var">framework_opts</span></a><span>
</span><a name="line-538"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255866"><span class="hs-identifier hs-var">pkg_lib_path_opts</span></a><span>
</span><a name="line-539"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255874"><span class="hs-identifier hs-var">pkg_link_opts</span></a><span>
</span><a name="line-540"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255879"><span class="hs-identifier hs-var">pkg_framework_opts</span></a><span>
</span><a name="line-541"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Wl,-dead_strip_dylibs&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-542"></a><span>              </span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-544"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><a name="line-545"></a><span>            </span><span class="hs-comment">-- Making a DSO</span><span>
</span><a name="line-546"></a><span>            </span><span class="hs-comment">-------------------------------------------------------------------</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255887"><a href="#local-6989586621681255887"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681255863"><span class="hs-identifier hs-var">o_file</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681255889"><a href="#local-6989586621681255889"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681255889"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;a.out&quot;</span><span class="hs-special">;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-549"></a><span>                </span><a name="local-6989586621681255888"><a href="#local-6989586621681255888"><span class="hs-identifier">unregisterised</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformUnregisterised</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681255890"><a href="#local-6989586621681255890"><span class="hs-identifier">bsymbolicFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- we need symbolic linking to resolve</span><span>
</span><a name="line-551"></a><span>                                </span><span class="hs-comment">-- non-PIC intra-package-relocations for</span><span>
</span><a name="line-552"></a><span>                                </span><span class="hs-comment">-- performance (where symbolic linking works)</span><span>
</span><a name="line-553"></a><span>                                </span><span class="hs-comment">-- See Note [-Bsymbolic assumptions by GHC]</span><span>
</span><a name="line-554"></a><span>                                </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,-Bsymbolic&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681255888"><span class="hs-identifier hs-var">unregisterised</span></a><span class="hs-special">]</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span>            </span><a href="SysTools.Tasks.html#runLink"><span class="hs-identifier hs-var">runLink</span></a><span> </span><a href="#local-6989586621681255861"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-557"></a><span>                    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255862"><span class="hs-identifier hs-var">verbFlags</span></a><span>
</span><a name="line-558"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><a href="SysTools.html#libmLinkOpts"><span class="hs-identifier hs-var">libmLinkOpts</span></a><span>
</span><a name="line-559"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-560"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681255887"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-561"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-562"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255857"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-563"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-shared&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-564"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255890"><span class="hs-identifier hs-var">bsymbolicFlag</span></a><span>
</span><a name="line-565"></a><span>                    </span><span class="hs-comment">-- Set the library soname. We use -h rather than -soname as</span><span>
</span><a name="line-566"></a><span>                    </span><span class="hs-comment">-- Solaris 10 doesn't support the latter:</span><span>
</span><a name="line-567"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-Wl,-h,&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">takeFileName</span><span> </span><a href="#local-6989586621681255887"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-568"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255878"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span>
</span><a name="line-569"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255870"><span class="hs-identifier hs-var">lib_path_opts</span></a><span>
</span><a name="line-570"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255866"><span class="hs-identifier hs-var">pkg_lib_path_opts</span></a><span>
</span><a name="line-571"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681255874"><span class="hs-identifier hs-var">pkg_link_opts</span></a><span>
</span><a name="line-572"></a><span>              </span><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span class="hs-comment">-- | Some platforms require that we explicitly link against @libm@ if any</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- math-y things are used (which we assume to include all programs). See #14022.</span><span>
</span><a name="line-576"></a><span class="hs-identifier">libmLinkOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span>
</span><a name="line-577"></a><a name="libmLinkOpts"><a href="SysTools.html#libmLinkOpts"><span class="hs-identifier">libmLinkOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-578"></a><span class="hs-cpp">#if defined(HAVE_LIBM)
</span><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-lm&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-580"></a><span class="hs-cpp">#else
</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-582"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-584"></a><span class="hs-identifier">getPkgFrameworkOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Platform</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-585"></a><a name="getPkgFrameworkOpts"><a href="SysTools.html#getPkgFrameworkOpts"><span class="hs-identifier">getPkgFrameworkOpts</span></a></a><span> </span><a name="local-6989586621681255891"><a href="#local-6989586621681255891"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681255892"><a href="#local-6989586621681255892"><span class="hs-identifier">platform</span></a></a><span> </span><a name="local-6989586621681255893"><a href="#local-6989586621681255893"><span class="hs-identifier">dep_packages</span></a></a><span>
</span><a name="line-586"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><a href="#local-6989586621681255892"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-587"></a><span>    </span><a name="local-6989586621681255895"><a href="#local-6989586621681255895"><span class="hs-identifier">pkg_framework_path_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-588"></a><span>        </span><a name="local-6989586621681255894"><a href="#local-6989586621681255894"><span class="hs-identifier">pkg_framework_paths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageFrameworkPath</span><span> </span><a href="#local-6989586621681255891"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255893"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-589"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-F&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681255894"><span class="hs-identifier hs-var">pkg_framework_paths</span></a><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span>    </span><a name="local-6989586621681255898"><a href="#local-6989586621681255898"><span class="hs-identifier">pkg_framework_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-592"></a><span>        </span><a name="local-6989586621681255896"><a href="#local-6989586621681255896"><span class="hs-identifier">pkg_frameworks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageFrameworks</span><span> </span><a href="#local-6989586621681255891"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681255893"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-593"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-framework&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255897"><span class="hs-identifier hs-var">fw</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681255897"><a href="#local-6989586621681255897"><span class="hs-identifier">fw</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681255896"><span class="hs-identifier hs-var">pkg_frameworks</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681255895"><span class="hs-identifier hs-var">pkg_framework_path_opts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255898"><span class="hs-identifier hs-var">pkg_framework_opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-identifier">getFrameworkOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Platform</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-600"></a><a name="getFrameworkOpts"><a href="SysTools.html#getFrameworkOpts"><span class="hs-identifier">getFrameworkOpts</span></a></a><span> </span><a name="local-6989586621681255899"><a href="#local-6989586621681255899"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681255900"><a href="#local-6989586621681255900"><span class="hs-identifier">platform</span></a></a><span>
</span><a name="line-601"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><a href="#local-6989586621681255900"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681255902"><span class="hs-identifier hs-var">framework_path_opts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681255904"><span class="hs-identifier hs-var">framework_opts</span></a><span>
</span><a name="line-602"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-603"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-604"></a><span>    </span><a name="local-6989586621681255901"><a href="#local-6989586621681255901"><span class="hs-identifier">framework_paths</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">frameworkPaths</span><span> </span><a href="#local-6989586621681255899"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-605"></a><span>    </span><a name="local-6989586621681255902"><a href="#local-6989586621681255902"><span class="hs-identifier">framework_path_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-F&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681255901"><span class="hs-identifier hs-var">framework_paths</span></a><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>    </span><a name="local-6989586621681255903"><a href="#local-6989586621681255903"><span class="hs-identifier">frameworks</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cmdlineFrameworks</span><span> </span><a href="#local-6989586621681255899"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-608"></a><span>    </span><span class="hs-comment">-- reverse because they're added in reverse order from the cmd line:</span><span>
</span><a name="line-609"></a><span>    </span><a name="local-6989586621681255904"><a href="#local-6989586621681255904"><span class="hs-identifier">framework_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-framework&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681255905"><span class="hs-identifier hs-var">fw</span></a><span class="hs-special">]</span><span>
</span><a name="line-610"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681255905"><a href="#local-6989586621681255905"><span class="hs-identifier">fw</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621681255903"><span class="hs-identifier hs-var">frameworks</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-comment">{-
Note [-Bsymbolic assumptions by GHC]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

GHC has a few assumptions about interaction of relocations in NCG and linker:

1. -Bsymbolic resolves internal references when the shared library is linked,
   which is important for performance.
2. When there is a reference to data in a shared library from the main program,
   the runtime linker relocates the data object into the main program using an
   R_*_COPY relocation.
3. If we used -Bsymbolic, then this results in multiple copies of the data
   object, because some references have already been resolved to point to the
   original instance. This is bad!

We work around [3.] for native compiled code by avoiding the generation of
R_*_COPY relocations.

Unregisterised compiler can't evade R_*_COPY relocations easily thus we disable
-Bsymbolic linking there.

See related Trac tickets: #4210, #15338
-}</span><span>
</span><a name="line-635"></a></pre></body></html>