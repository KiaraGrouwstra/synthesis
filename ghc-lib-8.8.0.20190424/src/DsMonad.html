<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


@DsMonad@: monadery used in desugaring
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances, FlexibleContexts #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>  </span><span class="hs-comment">-- instance MonadThings is necessarily an orphan</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsMonad</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>        </span><span class="hs-identifier hs-type">DsM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="DsMonad.html#initDs"><span class="hs-identifier hs-var">initDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#initDsTc"><span class="hs-identifier hs-var">initDsTc</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#initTcDsForSolver"><span class="hs-identifier hs-var">initTcDsForSolver</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#initDsWithModGuts"><span class="hs-identifier hs-var">initDsWithModGuts</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#fixDs"><span class="hs-identifier hs-var">fixDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><span class="hs-identifier hs-var">foldlM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldrM</span><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#whenGOptM"><span class="hs-identifier hs-var">whenGOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><a href="DsMonad.html#duplicateLocalDs"><span class="hs-identifier hs-var">duplicateLocalDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="DsMonad.html#newSysLocalsDsNoLP"><span class="hs-identifier hs-var">newSysLocalsDsNoLP</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#newSysLocalsDs"><span class="hs-identifier hs-var">newSysLocalsDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#newUniqueId"><span class="hs-identifier hs-var">newUniqueId</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="DsMonad.html#newFailLocalDs"><span class="hs-identifier hs-var">newFailLocalDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#newPredVarDs"><span class="hs-identifier hs-var">newPredVarDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier hs-var">getSrcSpanDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="DsMonad.html#mkPrintUnqualifiedDs"><span class="hs-identifier hs-var">mkPrintUnqualifiedDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="DsMonad.html#getGhcModeDs"><span class="hs-identifier hs-var">getGhcModeDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsGetFamInstEnvs"><span class="hs-identifier hs-var">dsGetFamInstEnvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier hs-var">dsLookupGlobal</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsLookupTyCon"><span class="hs-identifier hs-var">dsLookupTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="DsMonad.html#dsLookupDataCon"><span class="hs-identifier hs-var">dsLookupDataCon</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsLookupConLike"><span class="hs-identifier hs-var">dsLookupConLike</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><span class="hs-identifier hs-type">DsMetaEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DsMetaVal</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsGetMetaEnv"><span class="hs-identifier hs-var">dsGetMetaEnv</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsLookupMetaEnv"><span class="hs-identifier hs-var">dsLookupMetaEnv</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsExtendMetaEnv"><span class="hs-identifier hs-var">dsExtendMetaEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>        </span><span class="hs-comment">-- Getting and setting EvVars and term constraints in local environment</span><span>
</span><a name="line-33"></a><span>        </span><a href="DsMonad.html#getDictsDs"><span class="hs-identifier hs-var">getDictsDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#addDictsDs"><span class="hs-identifier hs-var">addDictsDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#getTmCsDs"><span class="hs-identifier hs-var">getTmCsDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#addTmCsDs"><span class="hs-identifier hs-var">addTmCsDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>        </span><span class="hs-comment">-- Iterations for pm checking</span><span>
</span><a name="line-36"></a><span>        </span><a href="DsMonad.html#incrCheckPmIterDs"><span class="hs-identifier hs-var">incrCheckPmIterDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#resetPmIterDs"><span class="hs-identifier hs-var">resetPmIterDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsGetCompleteMatches"><span class="hs-identifier hs-var">dsGetCompleteMatches</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>        </span><span class="hs-comment">-- Warnings and errors</span><span>
</span><a name="line-39"></a><span>        </span><a href="DsMonad.html#DsWarning"><span class="hs-identifier hs-type">DsWarning</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#warnIfSetDs"><span class="hs-identifier hs-var">warnIfSetDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#errDsCoreExpr"><span class="hs-identifier hs-var">errDsCoreExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="DsMonad.html#failWithDs"><span class="hs-identifier hs-var">failWithDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#failDs"><span class="hs-identifier hs-var">failDs</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#discardWarningsDs"><span class="hs-identifier hs-var">discardWarningsDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="DsMonad.html#askNoErrsDs"><span class="hs-identifier hs-var">askNoErrsDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span>        </span><span class="hs-comment">-- Data types</span><span>
</span><a name="line-44"></a><span>        </span><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier hs-type">DsMatchContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="DsMonad.html#DsWrapper"><span class="hs-identifier hs-type">DsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>        </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="DsMonad.html#orFail"><span class="hs-identifier hs-var">orFail</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>        </span><span class="hs-comment">-- Levity polymorphism</span><span>
</span><a name="line-49"></a><span>        </span><a href="DsMonad.html#dsNoLevPoly"><span class="hs-identifier hs-var">dsNoLevPoly</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsNoLevPolyExpr"><span class="hs-identifier hs-var">dsNoLevPolyExpr</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>        </span><span class="hs-comment">-- Trace injection</span><span>
</span><a name="line-52"></a><span>        </span><a href="DsMonad.html#pprRuntimeTrace"><span class="hs-identifier hs-var">pprRuntimeTrace</span></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unitExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exprType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isExprLevPoly</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcMType.html#checkForLevPolyX"><span class="hs-identifier hs-var">checkForLevPolyX</span></a><span class="hs-special">,</span><span> </span><a href="TcMType.html#formatLevPolyErr"><span class="hs-identifier hs-var">formatLevPolyErr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Origin</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PmExpr</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">lookupWithDefaultUFM</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Literal</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkLitString</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentreState</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Data types for the desugarer
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">data</span><span> </span><a name="DsMatchContext"><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier">DsMatchContext</span></a></a><span>
</span><a name="line-101"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="DsMatchContext"><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier">DsMatchContext</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier hs-type">DsMatchContext</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-105"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier hs-var">DsMatchContext</span></a><span> </span><a name="local-6989586621681748997"><a href="#local-6989586621681748997"><span class="hs-identifier">hs_match</span></a></a><span> </span><a name="local-6989586621681748998"><a href="#local-6989586621681748998"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681748998"><span class="hs-identifier hs-var">ss</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprMatchContext</span><span> </span><a href="#local-6989586621681748997"><span class="hs-identifier hs-var">hs_match</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-keyword">data</span><span> </span><a name="EquationInfo"><a href="DsMonad.html#EquationInfo"><span class="hs-identifier">EquationInfo</span></a></a><span>
</span><a name="line-108"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="EqnInfo"><a href="DsMonad.html#EqnInfo"><span class="hs-identifier">EqnInfo</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="eqn_pats"><a href="DsMonad.html#eqn_pats"><span class="hs-identifier">eqn_pats</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><span>              </span><span class="hs-comment">-- ^ The patterns for an equation</span><span>
</span><a name="line-110"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-111"></a><span>              </span><span class="hs-comment">-- NB: We have /already/ applied 'decideBangHood' to</span><span>
</span><a name="line-112"></a><span>              </span><span class="hs-comment">-- these patterns.  See Note [decideBangHood] in &quot;DsUtils&quot;</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="eqn_orig"><a href="DsMonad.html#eqn_orig"><span class="hs-identifier">eqn_orig</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Origin</span><span>
</span><a name="line-115"></a><span>              </span><span class="hs-comment">-- ^ Was this equation present in the user source?</span><span>
</span><a name="line-116"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-117"></a><span>              </span><span class="hs-comment">-- This helps us avoid warnings on patterns that GHC elaborated.</span><span>
</span><a name="line-118"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-119"></a><span>              </span><span class="hs-comment">-- For instance, the pattern @-1 :: Word@ gets desugared into</span><span>
</span><a name="line-120"></a><span>              </span><span class="hs-comment">-- @W# -1## :: Word@, but we shouldn't warn about an overflowed</span><span>
</span><a name="line-121"></a><span>              </span><span class="hs-comment">-- literal for /both/ of these cases.</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="eqn_rhs"><a href="DsMonad.html#eqn_rhs"><span class="hs-identifier">eqn_rhs</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-124"></a><span>              </span><span class="hs-comment">-- ^ What to do after match</span><span>
</span><a name="line-125"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-128"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><a name="local-6989586621681748996"><a href="#local-6989586621681748996"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681748996"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">type</span><span> </span><a name="DsWrapper"><a href="DsMonad.html#DsWrapper"><span class="hs-identifier">DsWrapper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-131"></a><span class="hs-identifier">idDsWrapper</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#DsWrapper"><span class="hs-identifier hs-type">DsWrapper</span></a><span>
</span><a name="line-132"></a><a name="idDsWrapper"><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier">idDsWrapper</span></a></a><span> </span><a name="local-6989586621681749015"><a href="#local-6989586621681749015"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749015"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">-- The semantics of (match vs (EqnInfo wrap pats rhs)) is the MatchResult</span><span>
</span><a name="line-135"></a><span class="hs-comment">--      \fail. wrap (case vs of { pats -&gt; rhs fail })</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- where vs are not bound by wrap</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- A MatchResult is an expression with a hole in it</span><span>
</span><a name="line-140"></a><span class="hs-keyword">data</span><span> </span><a name="MatchResult"><a href="DsMonad.html#MatchResult"><span class="hs-identifier">MatchResult</span></a></a><span>
</span><a name="line-141"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="MatchResult"><a href="DsMonad.html#MatchResult"><span class="hs-identifier">MatchResult</span></a></a><span>
</span><a name="line-142"></a><span>        </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span>       </span><span class="hs-comment">-- Tells whether the failure expression is used</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>                        </span><span class="hs-comment">-- Takes a expression to plug in at the</span><span>
</span><a name="line-145"></a><span>                        </span><span class="hs-comment">-- failure point(s). The expression should</span><span>
</span><a name="line-146"></a><span>                        </span><span class="hs-comment">-- be duplicatable!</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-keyword">data</span><span> </span><a name="CanItFail"><a href="DsMonad.html#CanItFail"><span class="hs-identifier">CanItFail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CanFail"><a href="DsMonad.html#CanFail"><span class="hs-identifier">CanFail</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="CantFail"><a href="DsMonad.html#CantFail"><span class="hs-identifier">CantFail</span></a></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">orFail</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span>
</span><a name="line-151"></a><a name="orFail"><a href="DsMonad.html#orFail"><span class="hs-identifier">orFail</span></a></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span>
</span><a name="line-152"></a><span class="hs-identifier">orFail</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Monad functions
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- Compatibility functions</span><span>
</span><a name="line-163"></a><span class="hs-identifier">fixDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749014"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749014"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749014"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-164"></a><a name="fixDs"><a href="DsMonad.html#fixDs"><span class="hs-identifier">fixDs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fixM</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-keyword">type</span><span> </span><a name="DsWarning"><a href="DsMonad.html#DsWarning"><span class="hs-identifier">DsWarning</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-comment">-- Not quite the same as a WarnMsg, we have an SDoc here</span><span>
</span><a name="line-168"></a><span>        </span><span class="hs-comment">-- and we'll do the print_unqual stuff later on to turn it</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-comment">-- into a Doc.</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">-- | Run a 'DsM' action inside the 'TcM' monad.</span><span>
</span><a name="line-172"></a><span class="hs-identifier">initDsTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749013"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681749013"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-173"></a><a name="initDsTc"><a href="DsMonad.html#initDsTc"><span class="hs-identifier">initDsTc</span></a></a><span> </span><a name="local-6989586621681749016"><a href="#local-6989586621681749016"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749017"><a href="#local-6989586621681749017"><span class="hs-identifier">tcg_env</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-175"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749018"><a href="#local-6989586621681749018"><span class="hs-identifier">msg_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span>
</span><a name="line-176"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749019"><a href="#local-6989586621681749019"><span class="hs-identifier">hsc_env</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-177"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749020"><a href="#local-6989586621681749020"><span class="hs-identifier">envs</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#mkDsEnvsFromTcGbl"><span class="hs-identifier hs-var">mkDsEnvsFromTcGbl</span></a><span> </span><a href="#local-6989586621681749019"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681749018"><span class="hs-identifier hs-var">msg_var</span></a><span> </span><a href="#local-6989586621681749017"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-178"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-6989586621681749020"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621681749016"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-179"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">-- | Run a 'DsM' action inside the 'IO' monad.</span><span>
</span><a name="line-182"></a><span class="hs-identifier">initDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749012"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681749012"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><a name="initDs"><a href="DsMonad.html#initDs"><span class="hs-identifier">initDs</span></a></a><span> </span><a name="local-6989586621681749021"><a href="#local-6989586621681749021"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681749022"><a href="#local-6989586621681749022"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621681749023"><a href="#local-6989586621681749023"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-184"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749024"><a href="#local-6989586621681749024"><span class="hs-identifier">msg_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyMessages</span><span>
</span><a name="line-185"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749025"><a href="#local-6989586621681749025"><span class="hs-identifier">envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#mkDsEnvsFromTcGbl"><span class="hs-identifier hs-var">mkDsEnvsFromTcGbl</span></a><span> </span><a href="#local-6989586621681749021"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681749024"><span class="hs-identifier hs-var">msg_var</span></a><span> </span><a href="#local-6989586621681749022"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-186"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#runDs"><span class="hs-identifier hs-var">runDs</span></a><span> </span><a href="#local-6989586621681749021"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681749025"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621681749023"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-187"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- | Build a set of desugarer environments derived from a 'TcGblEnv'.</span><span>
</span><a name="line-190"></a><span class="hs-identifier">mkDsEnvsFromTcGbl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621681749011"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-191"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Messages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-192"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681749011"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DsGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DsLclEnv</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><a name="mkDsEnvsFromTcGbl"><a href="DsMonad.html#mkDsEnvsFromTcGbl"><span class="hs-identifier">mkDsEnvsFromTcGbl</span></a></a><span> </span><a name="local-6989586621681749026"><a href="#local-6989586621681749026"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681749027"><a href="#local-6989586621681749027"><span class="hs-identifier">msg_var</span></a></a><span> </span><a name="local-6989586621681749028"><a href="#local-6989586621681749028"><span class="hs-identifier">tcg_env</span></a></a><span>
</span><a name="line-194"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749029"><a href="#local-6989586621681749029"><span class="hs-identifier">pm_iter_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-195"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749030"><a href="#local-6989586621681749030"><span class="hs-identifier">cc_st_var</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">newCostCentreState</span><span>
</span><a name="line-196"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749031"><a href="#local-6989586621681749031"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681749026"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-197"></a><span>             </span><a name="local-6989586621681749032"><a href="#local-6989586621681749032"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><a href="#local-6989586621681749028"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-198"></a><span>             </span><a name="local-6989586621681749033"><a href="#local-6989586621681749033"><span class="hs-identifier">type_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621681749028"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-199"></a><span>             </span><a name="local-6989586621681749034"><a href="#local-6989586621681749034"><span class="hs-identifier">rdr_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621681749028"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-200"></a><span>             </span><a name="local-6989586621681749035"><a href="#local-6989586621681749035"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-6989586621681749028"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-201"></a><span>             </span><a name="local-6989586621681749036"><a href="#local-6989586621681749036"><span class="hs-identifier">complete_matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hptCompleteSigs</span><span> </span><a href="#local-6989586621681749026"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-202"></a><span>                                </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_complete_matches</span><span> </span><a href="#local-6989586621681749028"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-203"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsMonad.html#mkDsEnvs"><span class="hs-identifier hs-var">mkDsEnvs</span></a><span> </span><a href="#local-6989586621681749031"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749032"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681749034"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621681749033"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621681749035"><span class="hs-identifier hs-var">fam_inst_env</span></a><span>
</span><a name="line-204"></a><span>                           </span><a href="#local-6989586621681749027"><span class="hs-identifier hs-var">msg_var</span></a><span> </span><a href="#local-6989586621681749029"><span class="hs-identifier hs-var">pm_iter_var</span></a><span> </span><a href="#local-6989586621681749030"><span class="hs-identifier hs-var">cc_st_var</span></a><span> </span><a href="#local-6989586621681749036"><span class="hs-identifier hs-var">complete_matches</span></a><span>
</span><a name="line-205"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-identifier">runDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DsGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DsLclEnv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749010"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681749010"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="runDs"><a href="DsMonad.html#runDs"><span class="hs-identifier">runDs</span></a></a><span> </span><a name="local-6989586621681749037"><a href="#local-6989586621681749037"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681749038"><a href="#local-6989586621681749038"><span class="hs-identifier">ds_gbl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681749039"><a href="#local-6989586621681749039"><span class="hs-identifier">ds_lcl</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681749040"><a href="#local-6989586621681749040"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-209"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749042"><a href="#local-6989586621681749042"><span class="hs-identifier">res</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier hs-var">initTcRnIf</span></a><span> </span><span class="hs-char">'d'</span><span> </span><a href="#local-6989586621681749037"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681749038"><span class="hs-identifier hs-var">ds_gbl</span></a><span> </span><a href="#local-6989586621681749039"><span class="hs-identifier hs-var">ds_lcl</span></a><span>
</span><a name="line-210"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tryM</span><span> </span><a href="#local-6989586621681749040"><span class="hs-identifier hs-var">thing_inside</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749043"><a href="#local-6989586621681749043"><span class="hs-identifier">msgs</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_msgs</span><span> </span><a href="#local-6989586621681749038"><span class="hs-identifier hs-var">ds_gbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749044"><a href="#local-6989586621681749044"><span class="hs-identifier">final_res</span></a></a><span>
</span><a name="line-213"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">errorsFound</span><span> </span><a href="#local-6989586621681749041"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749043"><span class="hs-identifier hs-var">msgs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-214"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681749045"><a href="#local-6989586621681749045"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681749042"><span class="hs-identifier hs-var">res</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681749045"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-215"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;initDs&quot;</span><span>
</span><a name="line-216"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749043"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749044"><span class="hs-identifier hs-var">final_res</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681749041"><a href="#local-6989586621681749041"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681749037"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-comment">-- | Run a 'DsM' action in the context of an existing 'ModGuts'</span><span>
</span><a name="line-221"></a><span class="hs-identifier">initDsWithModGuts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749009"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681749009"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-222"></a><a name="initDsWithModGuts"><a href="DsMonad.html#initDsWithModGuts"><span class="hs-identifier">initDsWithModGuts</span></a></a><span> </span><a name="local-6989586621681749046"><a href="#local-6989586621681749046"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681749047"><a href="#local-6989586621681749047"><span class="hs-identifier">guts</span></a></a><span> </span><a name="local-6989586621681749048"><a href="#local-6989586621681749048"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749049"><a href="#local-6989586621681749049"><span class="hs-identifier">pm_iter_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-224"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749050"><a href="#local-6989586621681749050"><span class="hs-identifier">cc_st_var</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">newCostCentreState</span><span>
</span><a name="line-225"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749051"><a href="#local-6989586621681749051"><span class="hs-identifier">msg_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyMessages</span><span>
</span><a name="line-226"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749052"><a href="#local-6989586621681749052"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681749046"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-227"></a><span>             </span><a name="local-6989586621681749053"><a href="#local-6989586621681749053"><span class="hs-identifier">type_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeEnvFromEntities</span><span> </span><a href="#local-6989586621681749059"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_tcs</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_fam_insts</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>             </span><a name="local-6989586621681749054"><a href="#local-6989586621681749054"><span class="hs-identifier">rdr_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mg_rdr_env</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-229"></a><span>             </span><a name="local-6989586621681749055"><a href="#local-6989586621681749055"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mg_fam_inst_env</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-230"></a><span>             </span><a name="local-6989586621681749056"><a href="#local-6989586621681749056"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mg_module</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-231"></a><span>             </span><a name="local-6989586621681749057"><a href="#local-6989586621681749057"><span class="hs-identifier">complete_matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hptCompleteSigs</span><span> </span><a href="#local-6989586621681749046"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-232"></a><span>                                </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">mg_complete_sigs</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span>             </span><a name="local-6989586621681749058"><a href="#local-6989586621681749058"><span class="hs-identifier">bindsToIds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621681749061"><a href="#local-6989586621681749061"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681749061"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>
</span><a name="line-235"></a><span>             </span><span class="hs-identifier">bindsToIds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span>    </span><a name="local-6989586621681749062"><a href="#local-6989586621681749062"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621681749062"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-236"></a><span>             </span><a name="local-6989586621681749059"><a href="#local-6989586621681749059"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621681749058"><span class="hs-identifier hs-var">bindsToIds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_binds</span><span> </span><a href="#local-6989586621681749047"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span>             </span><a name="local-6989586621681749060"><a href="#local-6989586621681749060"><span class="hs-identifier">envs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#mkDsEnvs"><span class="hs-identifier hs-var">mkDsEnvs</span></a><span> </span><a href="#local-6989586621681749052"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749056"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681749054"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621681749053"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-239"></a><span>                              </span><a href="#local-6989586621681749055"><span class="hs-identifier hs-var">fam_inst_env</span></a><span> </span><a href="#local-6989586621681749051"><span class="hs-identifier hs-var">msg_var</span></a><span> </span><a href="#local-6989586621681749049"><span class="hs-identifier hs-var">pm_iter_var</span></a><span>
</span><a name="line-240"></a><span>                              </span><a href="#local-6989586621681749050"><span class="hs-identifier hs-var">cc_st_var</span></a><span> </span><a href="#local-6989586621681749057"><span class="hs-identifier hs-var">complete_matches</span></a><span>
</span><a name="line-241"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#runDs"><span class="hs-identifier hs-var">runDs</span></a><span> </span><a href="#local-6989586621681749046"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681749060"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621681749048"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-242"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-identifier">initTcDsForSolver</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681749008"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681749008"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- Spin up a TcM context so that we can run the constraint solver</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- Returns any error messages generated by the constraint solver</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- and (Just res) if no error happened; Nothing if an error happened</span><span>
</span><a name="line-248"></a><span class="hs-comment">--</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- Simon says: I'm not very happy about this.  We spin up a complete TcM monad</span><span>
</span><a name="line-250"></a><span class="hs-comment">--             only to immediately refine it to a TcS monad.</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- Better perhaps to make TcS into its own monad, rather than building on TcS</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- But that may in turn interact with plugins</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><a name="initTcDsForSolver"><a href="DsMonad.html#initTcDsForSolver"><span class="hs-identifier">initTcDsForSolver</span></a></a><span> </span><a name="local-6989586621681749063"><a href="#local-6989586621681749063"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-255"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681749064"><a href="#local-6989586621681749064"><span class="hs-identifier">gbl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681749065"><a href="#local-6989586621681749065"><span class="hs-identifier">lcl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span>
</span><a name="line-256"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749066"><a href="#local-6989586621681749066"><span class="hs-identifier">hsc_env</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">DsGblEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681749067"><a href="#local-6989586621681749067"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-259"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681749068"><a href="#local-6989586621681749068"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749064"><span class="hs-identifier hs-var">gbl</span></a><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>             </span><span class="hs-identifier hs-var">DsLclEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dsl_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681749069"><a href="#local-6989586621681749069"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749065"><span class="hs-identifier hs-var">lcl</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#initTc"><span class="hs-identifier hs-var">initTc</span></a><span> </span><a href="#local-6989586621681749066"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621681749067"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681749069"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-264"></a><span>         </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681749070"><a href="#local-6989586621681749070"><span class="hs-identifier">tc_gbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681749070"><span class="hs-identifier hs-var">tc_gbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749068"><span class="hs-identifier hs-var">fam_inst_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-265"></a><span>         </span><a href="#local-6989586621681749063"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-identifier">mkDsEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnv</span><span>
</span><a name="line-268"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Messages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">CostCentreState</span><span>
</span><a name="line-269"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CompleteMatch</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DsGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DsLclEnv</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><a name="mkDsEnvs"><a href="DsMonad.html#mkDsEnvs"><span class="hs-identifier">mkDsEnvs</span></a></a><span> </span><a name="local-6989586621681749071"><a href="#local-6989586621681749071"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681749072"><a href="#local-6989586621681749072"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681749073"><a href="#local-6989586621681749073"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621681749074"><a href="#local-6989586621681749074"><span class="hs-identifier">type_env</span></a></a><span> </span><a name="local-6989586621681749075"><a href="#local-6989586621681749075"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><a name="local-6989586621681749076"><a href="#local-6989586621681749076"><span class="hs-identifier">msg_var</span></a></a><span> </span><a name="local-6989586621681749077"><a href="#local-6989586621681749077"><span class="hs-identifier">pmvar</span></a></a><span> </span><a name="local-6989586621681749078"><a href="#local-6989586621681749078"><span class="hs-identifier">cc_st_var</span></a></a><span>
</span><a name="line-271"></a><span>         </span><a name="local-6989586621681749079"><a href="#local-6989586621681749079"><span class="hs-identifier">complete_matches</span></a></a><span>
</span><a name="line-272"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749080"><a href="#local-6989586621681749080"><span class="hs-identifier">if_genv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfGblEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">if_doc</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;mkDsEnvs&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>                             </span><span class="hs-identifier">if_rec_types</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749072"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681749074"><span class="hs-identifier hs-var">type_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-274"></a><span>        </span><a name="local-6989586621681749081"><a href="#local-6989586621681749081"><span class="hs-identifier">if_lenv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#mkIfLclEnv"><span class="hs-identifier hs-var">mkIfLclEnv</span></a><span> </span><a href="#local-6989586621681749072"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GHC error in desugarer lookup in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681749072"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>                             </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- not boot!</span><span>
</span><a name="line-276"></a><span>        </span><a name="local-6989586621681749082"><a href="#local-6989586621681749082"><span class="hs-identifier">real_span</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realSrcLocSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">moduleNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621681749072"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-277"></a><span>        </span><a name="local-6989586621681749083"><a href="#local-6989586621681749083"><span class="hs-identifier">completeMatchMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCompleteMatchMap</span><span> </span><a href="#local-6989586621681749079"><span class="hs-identifier hs-var">complete_matches</span></a><span>
</span><a name="line-278"></a><span>        </span><a name="local-6989586621681749084"><a href="#local-6989586621681749084"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DsGblEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_mod</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749072"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-279"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749075"><span class="hs-identifier hs-var">fam_inst_env</span></a><span>
</span><a name="line-280"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_if_env</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749080"><span class="hs-identifier hs-var">if_genv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749081"><span class="hs-identifier hs-var">if_lenv</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_unqual</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrintUnqualified</span><span> </span><a href="#local-6989586621681749071"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749073"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-282"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_msgs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749076"><span class="hs-identifier hs-var">msg_var</span></a><span>
</span><a name="line-283"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_complete_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749083"><span class="hs-identifier hs-var">completeMatchMap</span></a><span>
</span><a name="line-284"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cc_st</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749078"><span class="hs-identifier hs-var">cc_st_var</span></a><span>
</span><a name="line-285"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-286"></a><span>        </span><a name="local-6989586621681749085"><a href="#local-6989586621681749085"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DsLclEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dsl_meta</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-287"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dsl_loc</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749082"><span class="hs-identifier hs-var">real_span</span></a><span>
</span><a name="line-288"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dsl_dicts</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-289"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dsl_tm_cs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-290"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dsl_pm_iter</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749077"><span class="hs-identifier hs-var">pmvar</span></a><span>
</span><a name="line-291"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749084"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749085"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Operations in the monad
*                                                                      *
************************************************************************

And all this mysterious stuff is so we can occasionally reach out and
grab one or more names.  @newLocalDs@ isn't exported---exported
functions are defined with it.  The difference in name-strings makes
it easier to read debugging output.

Note [Levity polymorphism checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
According to the &quot;Levity Polymorphism&quot; paper (PLDI '17), levity
polymorphism is forbidden in precisely two places: in the type of a bound
term-level argument and in the type of an argument to a function. The paper
explains it more fully, but briefly: expressions in these contexts need to be
stored in registers, and it's hard (read, impossible) to store something
that's levity polymorphic.

We cannot check for bad levity polymorphism conveniently in the type checker,
because we can't tell, a priori, which levity metavariables will be solved.
At one point, I (Richard) thought we could check in the zonker, but it's hard
to know where precisely are the abstracted variables and the arguments. So
we check in the desugarer, the only place where we can see the Core code and
still report respectable syntax to the user. This covers the vast majority
of cases; see calls to DsMonad.dsNoLevPoly and friends.

Levity polymorphism is also prohibited in the types of binders, and the
desugarer checks for this in GHC-generated Ids. (The zonker handles
the user-writted ids in zonkIdBndr.) This is done in newSysLocalDsNoLP.
The newSysLocalDs variant is used in the vast majority of cases where
the binder is obviously not levity polymorphic, omitting the check.
It would be nice to ASSERT that there is no levity polymorphism here,
but we can't, because of the fixM in DsArrows. It's all OK, though:
Core Lint will catch an error here.

However, the desugarer is the wrong place for certain checks. In particular,
the desugarer can't report a sensible error message if an HsWrapper is malformed.
After all, GHC itself produced the HsWrapper. So we store some message text
in the appropriate HsWrappers (e.g. WpFun) that we can print out in the
desugarer.

There are a few more checks in places where Core is generated outside the
desugarer. For example, in datatype and class declarations, where levity
polymorphism is checked for during validity checking. It would be nice to
have one central place for all this, but that doesn't seem possible while
still reporting nice error messages.

-}</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-comment">-- Make a new Id with the same print name, but different type, and new unique</span><span>
</span><a name="line-348"></a><span class="hs-identifier">newUniqueId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-349"></a><a name="newUniqueId"><a href="DsMonad.html#newUniqueId"><span class="hs-identifier">newUniqueId</span></a></a><span> </span><a name="local-6989586621681749086"><a href="#local-6989586621681749086"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#mk_local"><span class="hs-identifier hs-var">mk_local</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681749086"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span class="hs-identifier">duplicateLocalDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-352"></a><a name="duplicateLocalDs"><a href="DsMonad.html#duplicateLocalDs"><span class="hs-identifier">duplicateLocalDs</span></a></a><span> </span><a name="local-6989586621681749087"><a href="#local-6989586621681749087"><span class="hs-identifier">old_local</span></a></a><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749088"><a href="#local-6989586621681749088"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-354"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setIdUnique</span><span> </span><a href="#local-6989586621681749087"><span class="hs-identifier hs-var">old_local</span></a><span> </span><a href="#local-6989586621681749088"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">newPredVarDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Var</span><span>
</span><a name="line-357"></a><a name="newPredVarDs"><a href="DsMonad.html#newPredVarDs"><span class="hs-identifier">newPredVarDs</span></a></a><span> </span><a name="local-6989586621681749089"><a href="#local-6989586621681749089"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-358"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621681749089"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-identifier">newSysLocalDsNoLP</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newSysLocalDs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newFailLocalDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-361"></a><a name="newSysLocalDsNoLP"><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier">newSysLocalDsNoLP</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#mk_local"><span class="hs-identifier hs-var">mk_local</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ds&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-comment">-- this variant should be used when the caller can be sure that the variable type</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- is not levity-polymorphic. It is necessary when the type is knot-tied because</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- of the fixM used in DsArrows. See Note [Levity polymorphism checking]</span><span>
</span><a name="line-366"></a><a name="newSysLocalDs"><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier">newSysLocalDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;ds&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-367"></a><a name="newFailLocalDs"><a href="DsMonad.html#newFailLocalDs"><span class="hs-identifier">newFailLocalDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;fail&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>  </span><span class="hs-comment">-- the fail variable is used only in a situation where we can tell that</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-comment">-- levity-polymorphism is impossible.</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-identifier">newSysLocalsDsNoLP</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">newSysLocalsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-372"></a><a name="newSysLocalsDsNoLP"><a href="DsMonad.html#newSysLocalsDsNoLP"><span class="hs-identifier">newSysLocalsDsNoLP</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span>
</span><a name="line-373"></a><a name="newSysLocalsDs"><a href="DsMonad.html#newSysLocalsDs"><span class="hs-identifier">newSysLocalsDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-identifier">mk_local</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-376"></a><a name="mk_local"><a href="DsMonad.html#mk_local"><span class="hs-identifier">mk_local</span></a></a><span> </span><a name="local-6989586621681749090"><a href="#local-6989586621681749090"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621681749091"><a href="#local-6989586621681749091"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#dsNoLevPoly"><span class="hs-identifier hs-var">dsNoLevPoly</span></a><span> </span><a href="#local-6989586621681749091"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When trying to create a variable of type:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-377"></a><span>                                      </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681749091"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- could improve the msg with another</span><span>
</span><a name="line-378"></a><span>                                               </span><span class="hs-comment">-- parameter indicating context</span><span>
</span><a name="line-379"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span><span> </span><a href="#local-6989586621681749090"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621681749091"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span class="hs-comment">{-
We can also reach out and either set/grab location information from
the @SrcSpan@ being carried around.
-}</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-identifier">getGhcModeDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">GhcMode</span><span>
</span><a name="line-387"></a><a name="getGhcModeDs"><a href="DsMonad.html#getGhcModeDs"><span class="hs-identifier">getGhcModeDs</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ghcMode</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-comment">-- | Get in-scope type constraints (pm check)</span><span>
</span><a name="line-390"></a><span class="hs-identifier">getDictsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><a name="getDictsDs"><a href="DsMonad.html#getDictsDs"><span class="hs-identifier">getDictsDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749092"><a href="#local-6989586621681749092"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_dicts</span><span> </span><a href="#local-6989586621681749092"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-comment">-- | Add in-scope type constraints (pm check)</span><span>
</span><a name="line-394"></a><span class="hs-identifier">addDictsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">EvVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749007"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749007"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-395"></a><a name="addDictsDs"><a href="DsMonad.html#addDictsDs"><span class="hs-identifier">addDictsDs</span></a></a><span> </span><a name="local-6989586621681749093"><a href="#local-6989586621681749093"><span class="hs-identifier">ev_vars</span></a></a><span>
</span><a name="line-396"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681749094"><a href="#local-6989586621681749094"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681749094"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dsl_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionBags</span><span> </span><a href="#local-6989586621681749093"><span class="hs-identifier hs-var">ev_vars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_dicts</span><span> </span><a href="#local-6989586621681749094"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-comment">-- | Get in-scope term constraints (pm check)</span><span>
</span><a name="line-399"></a><span class="hs-identifier">getTmCsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">SimpleEq</span><span class="hs-special">)</span><span>
</span><a name="line-400"></a><a name="getTmCsDs"><a href="DsMonad.html#getTmCsDs"><span class="hs-identifier">getTmCsDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749095"><a href="#local-6989586621681749095"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_tm_cs</span><span> </span><a href="#local-6989586621681749095"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">-- | Add in-scope term constraints (pm check)</span><span>
</span><a name="line-403"></a><span class="hs-identifier">addTmCsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">SimpleEq</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749006"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749006"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-404"></a><a name="addTmCsDs"><a href="DsMonad.html#addTmCsDs"><span class="hs-identifier">addTmCsDs</span></a></a><span> </span><a name="local-6989586621681749096"><a href="#local-6989586621681749096"><span class="hs-identifier">tm_cs</span></a></a><span>
</span><a name="line-405"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681749097"><a href="#local-6989586621681749097"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681749097"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dsl_tm_cs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionBags</span><span> </span><a href="#local-6989586621681749096"><span class="hs-identifier hs-var">tm_cs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_tm_cs</span><span> </span><a href="#local-6989586621681749097"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-comment">-- | Increase the counter for elapsed pattern match check iterations.</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- If the current counter is already over the limit, fail</span><span>
</span><a name="line-409"></a><span class="hs-identifier">incrCheckPmIterDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-410"></a><a name="incrCheckPmIterDs"><a href="DsMonad.html#incrCheckPmIterDs"><span class="hs-identifier">incrCheckPmIterDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>  </span><a name="local-6989586621681749098"><a href="#local-6989586621681749098"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-412"></a><span>  </span><a name="local-6989586621681749099"><a href="#local-6989586621681749099"><span class="hs-identifier">cnt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_pm_iter</span><span> </span><a href="#local-6989586621681749098"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>  </span><a name="local-6989586621681749100"><a href="#local-6989586621681749100"><span class="hs-identifier">max_iters</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">maxPmCheckIterations</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-414"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681749099"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621681749100"><span class="hs-identifier hs-var">max_iters</span></a><span>
</span><a name="line-415"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-416"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_pm_iter</span><span> </span><a href="#local-6989586621681749098"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681749099"><span class="hs-identifier hs-var">cnt</span></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- | Reset the counter for pattern match check iterations to zero</span><span>
</span><a name="line-420"></a><span class="hs-identifier">resetPmIterDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-421"></a><a name="resetPmIterDs"><a href="DsMonad.html#resetPmIterDs"><span class="hs-identifier">resetPmIterDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749101"><a href="#local-6989586621681749101"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_pm_iter</span><span> </span><a href="#local-6989586621681749101"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-identifier">getSrcSpanDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-424"></a><a name="getSrcSpanDs"><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier">getSrcSpanDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749102"><a href="#local-6989586621681749102"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-425"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_loc</span><span> </span><a href="#local-6989586621681749102"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-identifier">putSrcSpanDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749005"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749005"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-428"></a><a name="putSrcSpanDs"><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier">putSrcSpanDs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnhelpfulSpan</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681749103"><a href="#local-6989586621681749103"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749103"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-430"></a><span class="hs-identifier">putSrcSpanDs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621681749104"><a href="#local-6989586621681749104"><span class="hs-identifier">real_span</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681749105"><a href="#local-6989586621681749105"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-431"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681749106"><a href="#local-6989586621681749106"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681749106"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">dsl_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749104"><span class="hs-identifier hs-var">real_span</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749105"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-comment">-- | Emit a warning for the current source location</span><span>
</span><a name="line-434"></a><span class="hs-comment">-- NB: Warns whether or not -Wxyz is set</span><span>
</span><a name="line-435"></a><span class="hs-identifier">warnDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-436"></a><a name="warnDs"><a href="DsMonad.html#warnDs"><span class="hs-identifier">warnDs</span></a></a><span> </span><a name="local-6989586621681749107"><a href="#local-6989586621681749107"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681749108"><a href="#local-6989586621681749108"><span class="hs-identifier">warn</span></a></a><span>
</span><a name="line-437"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749109"><a href="#local-6989586621681749109"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-438"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749110"><a href="#local-6989586621681749110"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier hs-var">getSrcSpanDs</span></a><span>
</span><a name="line-439"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749111"><a href="#local-6989586621681749111"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-440"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749112"><a href="#local-6989586621681749112"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">makeIntoWarning</span><span> </span><a href="#local-6989586621681749107"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-441"></a><span>                   </span><span class="hs-identifier hs-var">mkWarnMsg</span><span> </span><a href="#local-6989586621681749111"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749110"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_unqual</span><span> </span><a href="#local-6989586621681749109"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749108"><span class="hs-identifier hs-var">warn</span></a><span>
</span><a name="line-442"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">updMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_msgs</span><span> </span><a href="#local-6989586621681749109"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681749113"><a href="#local-6989586621681749113"><span class="hs-identifier">w</span></a></a><span class="hs-special">,</span><a name="local-6989586621681749114"><a href="#local-6989586621681749114"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749113"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681749112"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749114"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span class="hs-comment">-- | Emit a warning only if the correct WarnReason is set in the DynFlags</span><span>
</span><a name="line-445"></a><span class="hs-identifier">warnIfSetDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-446"></a><a name="warnIfSetDs"><a href="DsMonad.html#warnIfSetDs"><span class="hs-identifier">warnIfSetDs</span></a></a><span> </span><a name="local-6989586621681749115"><a href="#local-6989586621681749115"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681749116"><a href="#local-6989586621681749116"><span class="hs-identifier">warn</span></a></a><span>
</span><a name="line-447"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><a href="#local-6989586621681749115"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-448"></a><span>    </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621681749115"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749116"><span class="hs-identifier hs-var">warn</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">errDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><a name="errDs"><a href="DsMonad.html#errDs"><span class="hs-identifier">errDs</span></a></a><span> </span><a name="local-6989586621681749117"><a href="#local-6989586621681749117"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749118"><a href="#local-6989586621681749118"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-453"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749119"><a href="#local-6989586621681749119"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier hs-var">getSrcSpanDs</span></a><span>
</span><a name="line-454"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749120"><a href="#local-6989586621681749120"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-455"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749121"><a href="#local-6989586621681749121"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkErrMsg</span><span> </span><a href="#local-6989586621681749120"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749119"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_unqual</span><span> </span><a href="#local-6989586621681749118"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749117"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-456"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">updMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_msgs</span><span> </span><a href="#local-6989586621681749118"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681749122"><a href="#local-6989586621681749122"><span class="hs-identifier">w</span></a></a><span class="hs-special">,</span><a name="local-6989586621681749123"><a href="#local-6989586621681749123"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749122"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749123"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681749121"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-comment">-- | Issue an error, but return the expression for (), so that we can continue</span><span>
</span><a name="line-459"></a><span class="hs-comment">-- reporting errors.</span><span>
</span><a name="line-460"></a><span class="hs-identifier">errDsCoreExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-461"></a><a name="errDsCoreExpr"><a href="DsMonad.html#errDsCoreExpr"><span class="hs-identifier">errDsCoreExpr</span></a></a><span> </span><a name="local-6989586621681749124"><a href="#local-6989586621681749124"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-462"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><a href="#local-6989586621681749124"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-463"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">unitExpr</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">failWithDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749004"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-466"></a><a name="failWithDs"><a href="DsMonad.html#failWithDs"><span class="hs-identifier">failWithDs</span></a></a><span> </span><a name="local-6989586621681749125"><a href="#local-6989586621681749125"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-467"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><a href="#local-6989586621681749125"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-468"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">failM</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">failDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749003"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-471"></a><a name="failDs"><a href="DsMonad.html#failDs"><span class="hs-identifier">failDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-comment">-- (askNoErrsDs m) runs m</span><span>
</span><a name="line-474"></a><span class="hs-comment">-- If m fails,</span><span>
</span><a name="line-475"></a><span class="hs-comment">--    then (askNoErrsDs m) fails</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- If m succeeds with result r,</span><span>
</span><a name="line-477"></a><span class="hs-comment">--    then (askNoErrsDs m) succeeds with result (r, b),</span><span>
</span><a name="line-478"></a><span class="hs-comment">--         where b is True iff m generated no errors</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- Regardless of success or failure,</span><span>
</span><a name="line-480"></a><span class="hs-comment">--   propagate any errors/warnings generated by m</span><span>
</span><a name="line-481"></a><span class="hs-comment">--</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- c.f. TcRnMonad.askNoErrs</span><span>
</span><a name="line-483"></a><span class="hs-identifier">askNoErrsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749002"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749002"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><a name="askNoErrsDs"><a href="DsMonad.html#askNoErrsDs"><span class="hs-identifier">askNoErrsDs</span></a></a><span> </span><a name="local-6989586621681749126"><a href="#local-6989586621681749126"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-485"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749127"><a href="#local-6989586621681749127"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMutVar</span><span> </span><span class="hs-identifier hs-var">emptyMessages</span><span>
</span><a name="line-486"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749128"><a href="#local-6989586621681749128"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-487"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749129"><a href="#local-6989586621681749129"><span class="hs-identifier">mb_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Be careful to catch exceptions</span><span>
</span><a name="line-488"></a><span>                          </span><span class="hs-comment">-- so that we propagate errors correctly</span><span>
</span><a name="line-489"></a><span>                          </span><span class="hs-comment">-- (Trac #13642)</span><span>
</span><a name="line-490"></a><span>                  </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749128"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_msgs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749127"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-491"></a><span>                  </span><a href="#local-6989586621681749126"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span>      </span><span class="hs-comment">-- Propagate errors</span><span>
</span><a name="line-494"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749130"><a href="#local-6989586621681749130"><span class="hs-identifier">msgs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621681749131"><a href="#local-6989586621681749131"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681749132"><a href="#local-6989586621681749132"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621681749127"><span class="hs-identifier hs-var">errs_var</span></a><span>
</span><a name="line-495"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">updMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_msgs</span><span> </span><a href="#local-6989586621681749128"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681749133"><a href="#local-6989586621681749133"><span class="hs-identifier">w</span></a></a><span class="hs-special">,</span><a name="local-6989586621681749134"><a href="#local-6989586621681749134"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749133"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681749131"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749134"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681749132"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span>      </span><span class="hs-comment">-- And return</span><span>
</span><a name="line-498"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681749129"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-499"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-500"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681749135"><a href="#local-6989586621681749135"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749136"><a href="#local-6989586621681749136"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-501"></a><span>                           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749137"><a href="#local-6989586621681749137"><span class="hs-identifier">errs_found</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">errorsFound</span><span> </span><a href="#local-6989586621681749136"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681749130"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-502"></a><span>                           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681749135"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681749137"><span class="hs-identifier hs-var">errs_found</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-identifier">mkPrintUnqualifiedDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">PrintUnqualified</span><span>
</span><a name="line-505"></a><a name="mkPrintUnqualifiedDs"><a href="DsMonad.html#mkPrintUnqualifiedDs"><span class="hs-identifier">mkPrintUnqualifiedDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ds_unqual</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadThings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IOEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Env</span><span> </span><span class="hs-identifier hs-type">DsGblEnv</span><span> </span><span class="hs-identifier hs-type">DsLclEnv</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-508"></a><span>    </span><a name="local-8214565720323794786"><span class="hs-identifier">lookupThing</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier hs-var">dsLookupGlobal</span></a><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-identifier">dsLookupGlobal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-511"></a><span class="hs-comment">-- Very like TcEnv.tcLookupGlobal</span><span>
</span><a name="line-512"></a><a name="dsLookupGlobal"><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier">dsLookupGlobal</span></a></a><span> </span><a name="local-6989586621681749138"><a href="#local-6989586621681749138"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749139"><a href="#local-6989586621681749139"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-514"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_if_env</span><span> </span><a href="#local-6989586621681749139"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>                  </span><span class="hs-special">(</span><a href="TcIface.html#tcIfaceGlobal"><span class="hs-identifier hs-var">tcIfaceGlobal</span></a><span> </span><a href="#local-6989586621681749138"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-identifier">dsLookupGlobalId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-518"></a><a name="dsLookupGlobalId"><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier">dsLookupGlobalId</span></a></a><span> </span><a name="local-6989586621681749140"><a href="#local-6989586621681749140"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-519"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyThingId</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier hs-var">dsLookupGlobal</span></a><span> </span><a href="#local-6989586621681749140"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-identifier">dsLookupTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-522"></a><a name="dsLookupTyCon"><a href="DsMonad.html#dsLookupTyCon"><span class="hs-identifier">dsLookupTyCon</span></a></a><span> </span><a name="local-6989586621681749141"><a href="#local-6989586621681749141"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-523"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyThingTyCon</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier hs-var">dsLookupGlobal</span></a><span> </span><a href="#local-6989586621681749141"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span class="hs-identifier">dsLookupDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-526"></a><a name="dsLookupDataCon"><a href="DsMonad.html#dsLookupDataCon"><span class="hs-identifier">dsLookupDataCon</span></a></a><span> </span><a name="local-6989586621681749142"><a href="#local-6989586621681749142"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-527"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyThingDataCon</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier hs-var">dsLookupGlobal</span></a><span> </span><a href="#local-6989586621681749142"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span class="hs-identifier">dsLookupConLike</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span>
</span><a name="line-530"></a><a name="dsLookupConLike"><a href="DsMonad.html#dsLookupConLike"><span class="hs-identifier">dsLookupConLike</span></a></a><span> </span><a name="local-6989586621681749143"><a href="#local-6989586621681749143"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyThingConLike</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsMonad.html#dsLookupGlobal"><span class="hs-identifier hs-var">dsLookupGlobal</span></a><span> </span><a href="#local-6989586621681749143"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-identifier">dsGetFamInstEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- Gets both the external-package inst-env</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- and the home-pkg inst env (includes module being compiled)</span><span>
</span><a name="line-537"></a><a name="dsGetFamInstEnvs"><a href="DsMonad.html#dsGetFamInstEnvs"><span class="hs-identifier">dsGetFamInstEnvs</span></a></a><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749144"><a href="#local-6989586621681749144"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621681749145"><a href="#local-6989586621681749145"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-539"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-6989586621681749144"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_fam_inst_env</span><span> </span><a href="#local-6989586621681749145"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">dsGetMetaEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">DsMetaVal</span><span class="hs-special">)</span><span>
</span><a name="line-542"></a><a name="dsGetMetaEnv"><a href="DsMonad.html#dsGetMetaEnv"><span class="hs-identifier">dsGetMetaEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749146"><a href="#local-6989586621681749146"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_meta</span><span> </span><a href="#local-6989586621681749146"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-comment">-- | The @COMPLETE@ pragmas provided by the user for a given `TyCon`.</span><span>
</span><a name="line-545"></a><span class="hs-identifier">dsGetCompleteMatches</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CompleteMatch</span><span class="hs-special">]</span><span>
</span><a name="line-546"></a><a name="dsGetCompleteMatches"><a href="DsMonad.html#dsGetCompleteMatches"><span class="hs-identifier">dsGetCompleteMatches</span></a></a><span> </span><a name="local-6989586621681749147"><a href="#local-6989586621681749147"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-547"></a><span>  </span><a name="local-6989586621681749148"><a href="#local-6989586621681749148"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-548"></a><span>  </span><a name="local-6989586621681749149"><a href="#local-6989586621681749149"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681749150"><a href="#local-6989586621681749150"><span class="hs-identifier">lookup_completes</span></a></a><span> </span><a name="local-6989586621681749153"><a href="#local-6989586621681749153"><span class="hs-identifier">ufm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupWithDefaultUFM</span><span> </span><a href="#local-6989586621681749153"><span class="hs-identifier hs-var">ufm</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681749147"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-550"></a><span>      </span><a name="local-6989586621681749151"><a href="#local-6989586621681749151"><span class="hs-identifier">eps_matches_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749150"><span class="hs-identifier hs-var">lookup_completes</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">eps_complete_matches</span><span> </span><a href="#local-6989586621681749148"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-551"></a><span>      </span><a name="local-6989586621681749152"><a href="#local-6989586621681749152"><span class="hs-identifier">env_matches_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681749150"><span class="hs-identifier hs-var">lookup_completes</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ds_complete_matches</span><span> </span><a href="#local-6989586621681749149"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-552"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681749151"><span class="hs-identifier hs-var">eps_matches_list</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681749152"><span class="hs-identifier hs-var">env_matches_list</span></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-identifier">dsLookupMetaEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DsMetaVal</span><span class="hs-special">)</span><span>
</span><a name="line-555"></a><a name="dsLookupMetaEnv"><a href="DsMonad.html#dsLookupMetaEnv"><span class="hs-identifier">dsLookupMetaEnv</span></a></a><span> </span><a name="local-6989586621681749154"><a href="#local-6989586621681749154"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749155"><a href="#local-6989586621681749155"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dsl_meta</span><span> </span><a href="#local-6989586621681749155"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749154"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span class="hs-identifier">dsExtendMetaEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsMetaEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749001"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749001"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-558"></a><a name="dsExtendMetaEnv"><a href="DsMonad.html#dsExtendMetaEnv"><span class="hs-identifier">dsExtendMetaEnv</span></a></a><span> </span><a name="local-6989586621681749156"><a href="#local-6989586621681749156"><span class="hs-identifier">menv</span></a></a><span> </span><a name="local-6989586621681749157"><a href="#local-6989586621681749157"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-559"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681749158"><a href="#local-6989586621681749158"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681749158"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dsl_meta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dsl_meta</span><span> </span><a href="#local-6989586621681749158"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681749156"><span class="hs-identifier hs-var">menv</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749157"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span class="hs-identifier">discardWarningsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749000"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681749000"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-562"></a><span class="hs-comment">-- Ignore warnings inside the thing inside;</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- used to ignore inaccessable cases etc. inside generated code</span><span>
</span><a name="line-564"></a><a name="discardWarningsDs"><a href="DsMonad.html#discardWarningsDs"><span class="hs-identifier">discardWarningsDs</span></a></a><span> </span><a name="local-6989586621681749159"><a href="#local-6989586621681749159"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681749160"><a href="#local-6989586621681749160"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-566"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749161"><a href="#local-6989586621681749161"><span class="hs-identifier">old_msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_msgs</span><span> </span><a href="#local-6989586621681749160"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681749162"><a href="#local-6989586621681749162"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681749159"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span>        </span><span class="hs-comment">-- Revert messages to old_msgs</span><span>
</span><a name="line-571"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ds_msgs</span><span> </span><a href="#local-6989586621681749160"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681749161"><span class="hs-identifier hs-var">old_msgs</span></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681749162"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-comment">-- | Fail with an error message if the type is levity polymorphic.</span><span>
</span><a name="line-576"></a><span class="hs-identifier">dsNoLevPoly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span class="hs-comment">-- See Note [Levity polymorphism checking]</span><span>
</span><a name="line-578"></a><a name="dsNoLevPoly"><a href="DsMonad.html#dsNoLevPoly"><span class="hs-identifier">dsNoLevPoly</span></a></a><span> </span><a name="local-6989586621681749163"><a href="#local-6989586621681749163"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681749164"><a href="#local-6989586621681749164"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#checkForLevPolyX"><span class="hs-identifier hs-var">checkForLevPolyX</span></a><span> </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><a href="#local-6989586621681749164"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681749163"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-comment">-- | Check an expression for levity polymorphism, failing if it is</span><span>
</span><a name="line-581"></a><span class="hs-comment">-- levity polymorphic.</span><span>
</span><a name="line-582"></a><span class="hs-identifier">dsNoLevPolyExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span class="hs-comment">-- See Note [Levity polymorphism checking]</span><span>
</span><a name="line-584"></a><a name="dsNoLevPolyExpr"><a href="DsMonad.html#dsNoLevPolyExpr"><span class="hs-identifier">dsNoLevPolyExpr</span></a></a><span> </span><a name="local-6989586621681749165"><a href="#local-6989586621681749165"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681749166"><a href="#local-6989586621681749166"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-585"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isExprLevPoly</span><span> </span><a href="#local-6989586621681749165"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><span class="hs-special">(</span><a href="TcMType.html#formatLevPolyErr"><span class="hs-identifier hs-var">formatLevPolyErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621681749165"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621681749166"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-comment">-- | Runs the thing_inside. If there are no errors, then returns the expr</span><span>
</span><a name="line-589"></a><span class="hs-comment">-- given. Otherwise, returns unitExpr. This is useful for doing a bunch</span><span>
</span><a name="line-590"></a><span class="hs-comment">-- of levity polymorphism checks and then avoiding making a core App.</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- (If we make a core App on a levity polymorphic argument, detecting how</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- to handle the let/app invariant might call isUnliftedType, which panics</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- on a levity polymorphic type.)</span><span>
</span><a name="line-594"></a><span class="hs-comment">-- See #12709 for an example of why this machinery is necessary.</span><span>
</span><a name="line-595"></a><span class="hs-identifier">dsWhenNoErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="#local-6989586621681748999"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681748999"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-596"></a><a name="dsWhenNoErrs"><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier">dsWhenNoErrs</span></a></a><span> </span><a name="local-6989586621681749167"><a href="#local-6989586621681749167"><span class="hs-identifier">thing_inside</span></a></a><span> </span><a name="local-6989586621681749168"><a href="#local-6989586621681749168"><span class="hs-identifier">mk_expr</span></a></a><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681749169"><a href="#local-6989586621681749169"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681749170"><a href="#local-6989586621681749170"><span class="hs-identifier">no_errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#askNoErrsDs"><span class="hs-identifier hs-var">askNoErrsDs</span></a><span> </span><a href="#local-6989586621681749167"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-598"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681749170"><span class="hs-identifier hs-var">no_errs</span></a><span>
</span><a name="line-599"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681749168"><span class="hs-identifier hs-var">mk_expr</span></a><span> </span><a href="#local-6989586621681749169"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-600"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">unitExpr</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-comment">-- | Inject a trace message into the compiled program. Whereas</span><span>
</span><a name="line-603"></a><span class="hs-comment">-- pprTrace prints out information *while compiling*, pprRuntimeTrace</span><span>
</span><a name="line-604"></a><span class="hs-comment">-- captures that information and causes it to be printed *at runtime*</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- using Debug.Trace.trace.</span><span>
</span><a name="line-606"></a><span class="hs-comment">--</span><span>
</span><a name="line-607"></a><span class="hs-comment">--   pprRuntimeTrace hdr doc expr</span><span>
</span><a name="line-608"></a><span class="hs-comment">--</span><span>
</span><a name="line-609"></a><span class="hs-comment">-- will produce an expression that looks like</span><span>
</span><a name="line-610"></a><span class="hs-comment">--</span><span>
</span><a name="line-611"></a><span class="hs-comment">--   trace (hdr + doc) expr</span><span>
</span><a name="line-612"></a><span class="hs-comment">--</span><span>
</span><a name="line-613"></a><span class="hs-comment">-- When using this to debug a module that Debug.Trace depends on,</span><span>
</span><a name="line-614"></a><span class="hs-comment">-- it is necessary to import {-# SOURCE #-} Debug.Trace () in that</span><span>
</span><a name="line-615"></a><span class="hs-comment">-- module. We could avoid this inconvenience by wiring in Debug.Trace.trace,</span><span>
</span><a name="line-616"></a><span class="hs-comment">-- but that doesn't seem worth the effort and maintenance cost.</span><span>
</span><a name="line-617"></a><span class="hs-identifier">pprRuntimeTrace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>   </span><span class="hs-comment">-- ^ header</span><span>
</span><a name="line-618"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>     </span><span class="hs-comment">-- ^ information to output</span><span>
</span><a name="line-619"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-comment">-- ^ expression</span><span>
</span><a name="line-620"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-621"></a><a name="pprRuntimeTrace"><a href="DsMonad.html#pprRuntimeTrace"><span class="hs-identifier">pprRuntimeTrace</span></a></a><span> </span><a name="local-6989586621681749171"><a href="#local-6989586621681749171"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621681749172"><a href="#local-6989586621681749172"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681749173"><a href="#local-6989586621681749173"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-622"></a><span>  </span><a name="local-6989586621681749174"><a href="#local-6989586621681749174"><span class="hs-identifier">traceId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">traceName</span><span>
</span><a name="line-623"></a><span>  </span><a name="local-6989586621681749175"><a href="#local-6989586621681749175"><span class="hs-identifier">unpackCStringId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">unpackCStringName</span><span>
</span><a name="line-624"></a><span>  </span><a name="local-6989586621681749176"><a href="#local-6989586621681749176"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-625"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">message</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-626"></a><span>      </span><a name="local-6989586621681749177"><a href="#local-6989586621681749177"><span class="hs-identifier">message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681749175"><span class="hs-identifier hs-var">unpackCStringId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-627"></a><span>                </span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLitString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621681749176"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681749171"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621681749172"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681749174"><span class="hs-identifier hs-var">traceId</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621681749173"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749177"><span class="hs-identifier hs-var">message</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681749173"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">]</span><span>
</span><a name="line-629"></a></pre></body></html>