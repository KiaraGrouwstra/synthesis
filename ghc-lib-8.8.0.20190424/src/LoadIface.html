<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Loading interface files
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, BangPatterns, RecordWildCards, NondecreasingIndentation #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">LoadIface</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>        </span><span class="hs-comment">-- Importing one thing</span><span>
</span><a name="line-13"></a><span>        </span><a href="LoadIface.html#tcLookupImported_maybe"><span class="hs-identifier hs-var">tcLookupImported_maybe</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#importDecl"><span class="hs-identifier hs-var">importDecl</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier hs-var">checkWiredInTyCon</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#ifCheckWiredInThing"><span class="hs-identifier hs-var">ifCheckWiredInThing</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>        </span><span class="hs-comment">-- RnM/TcM functions</span><span>
</span><a name="line-17"></a><span>        </span><a href="LoadIface.html#loadModuleInterface"><span class="hs-identifier hs-var">loadModuleInterface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadModuleInterfaces"><span class="hs-identifier hs-var">loadModuleInterfaces</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="LoadIface.html#loadSrcInterface"><span class="hs-identifier hs-var">loadSrcInterface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadSrcInterface_maybe"><span class="hs-identifier hs-var">loadSrcInterface_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier hs-var">loadInterfaceForName</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadInterfaceForNameMaybe"><span class="hs-identifier hs-var">loadInterfaceForNameMaybe</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadInterfaceForModule"><span class="hs-identifier hs-var">loadInterfaceForModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>        </span><span class="hs-comment">-- IfM functions</span><span>
</span><a name="line-22"></a><span>        </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadUserInterface"><span class="hs-identifier hs-var">loadUserInterface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadPluginInterface"><span class="hs-identifier hs-var">loadPluginInterface</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="LoadIface.html#findAndReadIface"><span class="hs-identifier hs-var">findAndReadIface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#readIface"><span class="hs-identifier hs-var">readIface</span></a><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Used when reading the module's old interface</span><span>
</span><a name="line-25"></a><span>        </span><a href="LoadIface.html#loadDecls"><span class="hs-identifier hs-var">loadDecls</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Should move to TcIface and be renamed</span><span>
</span><a name="line-26"></a><span>        </span><a href="LoadIface.html#initExternalPackageState"><span class="hs-identifier hs-var">initExternalPackageState</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="LoadIface.html#moduleFreeHolesPrecise"><span class="hs-identifier hs-var">moduleFreeHolesPrecise</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="LoadIface.html#needWiredInHomeIface"><span class="hs-identifier hs-var">needWiredInHomeIface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#loadWiredInHomeIface"><span class="hs-identifier hs-var">loadWiredInHomeIface</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><a href="LoadIface.html#pprModIfaceSimple"><span class="hs-identifier hs-var">pprModIfaceSimple</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="LoadIface.html#ifaceStats"><span class="hs-identifier hs-var">ifaceStats</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#pprModIface"><span class="hs-identifier hs-var">pprModIface</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#showIface"><span class="hs-identifier hs-var">showIface</span></a><span>
</span><a name="line-32"></a><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span class="hs-special">(</span><span> </span><a href="TcIface.html#tcIfaceDecl"><span class="hs-identifier hs-var">tcIfaceDecl</span></a><span class="hs-special">,</span><span> </span><a href="TcIface.html#tcIfaceRules"><span class="hs-identifier hs-var">tcIfaceRules</span></a><span class="hs-special">,</span><span> </span><a href="TcIface.html#tcIfaceInst"><span class="hs-identifier hs-var">tcIfaceInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>                                 </span><a href="TcIface.html#tcIfaceFamInst"><span class="hs-identifier hs-var">tcIfaceFamInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                                 </span><a href="TcIface.html#tcIfaceAnnotations"><span class="hs-identifier hs-var">tcIfaceAnnotations</span></a><span class="hs-special">,</span><span> </span><a href="TcIface.html#tcIfaceCompleteSigs"><span class="hs-identifier hs-var">tcIfaceCompleteSigs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IfaceSyn</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Constants</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="PrelInfo.html"><span class="hs-identifier">PrelInfo</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrimOp</span><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">allThePrimOps</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">primOpFixity</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">primOpOcc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">seqId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">funTyConName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Rules</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Annotations</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Avail</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="BinIface.html"><span class="hs-identifier">BinIface</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Hooks</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FieldLabel</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="RnModIface.html"><span class="hs-identifier">RnModIface</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqDSet</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Plugins</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*      tcImportDecl is the key function for &quot;faulting in&quot;              *
*      imported things
*                                                                      *
************************************************************************

The main idea is this.  We are chugging along type-checking source code, and
find a reference to GHC.Base.map.  We call tcLookupGlobal, which doesn't find
it in the EPS type envt.  So it
        1 loads GHC.Base.hi
        2 gets the decl for GHC.Base.map
        3 typechecks it via tcIfaceDecl
        4 and adds it to the type env in the EPS

Note that DURING STEP 4, we may find that map's type mentions a type
constructor that also

Notice that for imported things we read the current version from the EPS
mutable variable.  This is important in situations like
        ...$(e1)...$(e2)...
where the code that e1 expands to might import some defns that
also turn out to be needed by the code that e2 expands to.
-}</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-identifier">tcLookupImported_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- Returns (Failed err) if we can't find the interface file for the thing</span><span>
</span><a name="line-115"></a><a name="tcLookupImported_maybe"><a href="LoadIface.html#tcLookupImported_maybe"><span class="hs-identifier">tcLookupImported_maybe</span></a></a><span> </span><a name="local-6989586621681662056"><a href="#local-6989586621681662056"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662057"><a href="#local-6989586621681662057"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-117"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662058"><a href="#local-6989586621681662058"><span class="hs-identifier">mb_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupTypeHscEnv</span><span> </span><a href="#local-6989586621681662057"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681662056"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662058"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-119"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662059"><a href="#local-6989586621681662059"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662059"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="LoadIface.html#tcImportDecl_maybe"><span class="hs-identifier hs-var">tcImportDecl_maybe</span></a><span> </span><a href="#local-6989586621681662056"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">tcImportDecl_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- Entry point for *source-code* uses of importDecl</span><span>
</span><a name="line-124"></a><a name="tcImportDecl_maybe"><a href="LoadIface.html#tcImportDecl_maybe"><span class="hs-identifier">tcImportDecl_maybe</span></a></a><span> </span><a name="local-6989586621681662060"><a href="#local-6989586621681662060"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662061"><a href="#local-6989586621681662061"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">wiredInNameTyThing_maybe</span><span> </span><a href="#local-6989586621681662060"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#needWiredInHomeIface"><span class="hs-identifier hs-var">needWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681662061"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>               </span><span class="hs-special">(</span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadWiredInHomeIface"><span class="hs-identifier hs-var">loadWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681662060"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>                </span><span class="hs-comment">-- See Note [Loading instances for wired-in things]</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662061"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-131"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#importDecl"><span class="hs-identifier hs-var">importDecl</span></a><span> </span><a href="#local-6989586621681662060"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-identifier">importDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662055"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- Get the TyThing for this Name from an interface file</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- It's not a wired-in thing -- the caller caught that</span><span>
</span><a name="line-136"></a><a name="importDecl"><a href="LoadIface.html#importDecl"><span class="hs-identifier">importDecl</span></a></a><span> </span><a name="local-6989586621681662062"><a href="#local-6989586621681662062"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isWiredInName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><a href="#local-6989586621681662063"><span class="hs-identifier hs-var">nd_doc</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>        </span><span class="hs-comment">-- Load the interface, which should populate the PTE</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662069"><a href="#local-6989586621681662069"><span class="hs-identifier">mb_iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>                      </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><a href="#local-6989586621681662063"><span class="hs-identifier hs-var">nd_doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">ImportBySystem</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662069"><span class="hs-identifier hs-var">mb_iface</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-144"></a><span>                </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662070"><a href="#local-6989586621681662070"><span class="hs-identifier">err_msg</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662070"><span class="hs-identifier hs-var">err_msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-145"></a><span>                </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>        </span><span class="hs-comment">-- Now look it up again; this time we should find it</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662071"><a href="#local-6989586621681662071"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-149"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupTypeEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PTE</span><span> </span><a href="#local-6989586621681662071"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-150"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662072"><a href="#local-6989586621681662072"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662072"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-151"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662073"><a href="#local-6989586621681662073"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">whenPprDebug</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662065"><span class="hs-identifier hs-var">found_things_msg</span></a><span> </span><a href="#local-6989586621681662071"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>                                    </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621681662064"><span class="hs-identifier hs-var">not_found_msg</span></a><span>
</span><a name="line-153"></a><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662073"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-154"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-156"></a><span>    </span><a name="local-6989586621681662063"><a href="#local-6989586621681662063"><span class="hs-identifier">nd_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Need decl for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-157"></a><span>    </span><a name="local-6989586621681662064"><a href="#local-6989586621681662064"><span class="hs-identifier">not_found_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't find interface-file declaration for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-158"></a><span>                                </span><span class="hs-identifier hs-var">pprNameSpace</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameSpace</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>                       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable cause: bug in .hi-boot file, or inconsistent .hi file&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-160"></a><span>                                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use -ddump-if-trace to get an idea of which file caused the error&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>    </span><a name="local-6989586621681662065"><a href="#local-6989586621681662065"><span class="hs-identifier">found_things_msg</span></a></a><span> </span><a name="local-6989586621681662066"><a href="#local-6989586621681662066"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Found the following declarations in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>           </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681662067"><span class="hs-identifier hs-var">is_interesting</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nameEnvElts</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">eps_PTE</span><span> </span><a href="#local-6989586621681662066"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-165"></a><span>        </span><a name="local-6989586621681662067"><a href="#local-6989586621681662067"><span class="hs-identifier">is_interesting</span></a></a><span> </span><a name="local-6989586621681662068"><a href="#local-6989586621681662068"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662062"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621681662068"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
           Checks for wired-in things
*                                                                      *
************************************************************************

Note [Loading instances for wired-in things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to make sure that we have at least *read* the interface files
for any module with an instance decl or RULE that we might want.

* If the instance decl is an orphan, we have a whole separate mechanism
  (loadOrphanModules)

* If the instance decl is not an orphan, then the act of looking at the
  TyCon or Class will force in the defining module for the
  TyCon/Class, and hence the instance decl

* BUT, if the TyCon is a wired-in TyCon, we don't really need its interface;
  but we must make sure we read its interface in case it has instances or
  rules.  That is what LoadIface.loadWiredInHomeIface does.  It's called
  from TcIface.{tcImportDecl, checkWiredInTyCon, ifCheckWiredInThing}

* HOWEVER, only do this for TyCons.  There are no wired-in Classes.  There
  are some wired-in Ids, but we don't want to load their interfaces. For
  example, Control.Exception.Base.recSelError is wired in, but that module
  is compiled late in the base library, and we don't want to force it to
  load before it's been compiled!

All of this is done by the type checker. The renamer plays no role.
(It used to, but no longer.)
-}</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-identifier">checkWiredInTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- Ensure that the home module of the TyCon (and hence its instances)</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- are loaded. See Note [Loading instances for wired-in things]</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- It might not be a wired-in tycon (see the calls in TcUnify),</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- in which case this is a no-op.</span><span>
</span><a name="line-207"></a><a name="checkWiredInTyCon"><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier">checkWiredInTyCon</span></a></a><span> </span><a name="local-6989586621681662074"><a href="#local-6989586621681662074"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-208"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621681662075"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662076"><a href="#local-6989586621681662076"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;checkWiredInTyCon&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662075"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662076"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">tc_name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662076"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662075"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>               </span><span class="hs-special">(</span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadWiredInHomeIface"><span class="hs-identifier hs-var">loadWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681662075"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>                </span><span class="hs-comment">-- Don't look for (non-existent) Float.hi when</span><span>
</span><a name="line-217"></a><span>                </span><span class="hs-comment">-- compiling Float.hs, which mentions Float of course</span><span>
</span><a name="line-218"></a><span>                </span><span class="hs-comment">-- A bit yukky to call initIfaceTcRn here</span><span>
</span><a name="line-219"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-221"></a><span>    </span><a name="local-6989586621681662075"><a href="#local-6989586621681662075"><span class="hs-identifier">tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621681662074"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-identifier">ifCheckWiredInThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- Even though we are in an interface file, we want to make</span><span>
</span><a name="line-225"></a><span class="hs-comment">-- sure the instances of a wired-in thing are loaded (imagine f :: Double -&gt; Double)</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- Ditto want to ensure that RULES are loaded too</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- See Note [Loading instances for wired-in things]</span><span>
</span><a name="line-228"></a><a name="ifCheckWiredInThing"><a href="LoadIface.html#ifCheckWiredInThing"><span class="hs-identifier">ifCheckWiredInThing</span></a></a><span> </span><a name="local-6989586621681662077"><a href="#local-6989586621681662077"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662078"><a href="#local-6989586621681662078"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getIfModule"><span class="hs-identifier hs-var">getIfModule</span></a><span>
</span><a name="line-230"></a><span>                </span><span class="hs-comment">-- Check whether we are typechecking the interface for this</span><span>
</span><a name="line-231"></a><span>                </span><span class="hs-comment">-- very module.  E.g when compiling the base library in --make mode</span><span>
</span><a name="line-232"></a><span>                </span><span class="hs-comment">-- we may typecheck GHC.Base.hi. At that point, GHC.Base is not in</span><span>
</span><a name="line-233"></a><span>                </span><span class="hs-comment">-- the HPT, so without the test we'll demand-load it into the PIT!</span><span>
</span><a name="line-234"></a><span>                </span><span class="hs-comment">-- C.f. the same test in checkWiredInTyCon above</span><span>
</span><a name="line-235"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662079"><a href="#local-6989586621681662079"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621681662077"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#needWiredInHomeIface"><span class="hs-identifier hs-var">needWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681662077"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681662078"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662079"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>               </span><span class="hs-special">(</span><a href="LoadIface.html#loadWiredInHomeIface"><span class="hs-identifier hs-var">loadWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681662079"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-identifier">needWiredInHomeIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- Only for TyCons; see Note [Loading instances for wired-in things]</span><span>
</span><a name="line-242"></a><a name="needWiredInHomeIface"><a href="LoadIface.html#needWiredInHomeIface"><span class="hs-identifier">needWiredInHomeIface</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-243"></a><span class="hs-identifier">needWiredInHomeIface</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        loadSrcInterface, loadOrphanModules, loadInterfaceForName

                These three are called from TcM-land
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-comment">-- | Load the interface corresponding to an @import@ directive in</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- source code.  On a failure, fail in the monad with an error message.</span><span>
</span><a name="line-258"></a><span class="hs-identifier">loadSrcInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-259"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>
</span><a name="line-260"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span>     </span><span class="hs-comment">-- {-# SOURCE #-} ?</span><span>
</span><a name="line-261"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>    </span><span class="hs-comment">-- &quot;package&quot;, if any</span><span>
</span><a name="line-262"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><a name="loadSrcInterface"><a href="LoadIface.html#loadSrcInterface"><span class="hs-identifier">loadSrcInterface</span></a></a><span> </span><a name="local-6989586621681662080"><a href="#local-6989586621681662080"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662081"><a href="#local-6989586621681662081"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681662082"><a href="#local-6989586621681662082"><span class="hs-identifier">want_boot</span></a></a><span> </span><a name="local-6989586621681662083"><a href="#local-6989586621681662083"><span class="hs-identifier">maybe_pkg</span></a></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662084"><a href="#local-6989586621681662084"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadSrcInterface_maybe"><span class="hs-identifier hs-var">loadSrcInterface_maybe</span></a><span> </span><a href="#local-6989586621681662080"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662081"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662082"><span class="hs-identifier hs-var">want_boot</span></a><span> </span><a href="#local-6989586621681662083"><span class="hs-identifier hs-var">maybe_pkg</span></a><span>
</span><a name="line-266"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662084"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-267"></a><span>           </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662085"><a href="#local-6989586621681662085"><span class="hs-identifier">err</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621681662085"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-268"></a><span>           </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681662086"><a href="#local-6989586621681662086"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681662086"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- | Like 'loadSrcInterface', but returns a 'MaybeErr'.</span><span>
</span><a name="line-271"></a><span class="hs-identifier">loadSrcInterface_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-272"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>
</span><a name="line-273"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span>     </span><span class="hs-comment">-- {-# SOURCE #-} ?</span><span>
</span><a name="line-274"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>    </span><span class="hs-comment">-- &quot;package&quot;, if any</span><span>
</span><a name="line-275"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><a name="loadSrcInterface_maybe"><a href="LoadIface.html#loadSrcInterface_maybe"><span class="hs-identifier">loadSrcInterface_maybe</span></a></a><span> </span><a name="local-6989586621681662087"><a href="#local-6989586621681662087"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662088"><a href="#local-6989586621681662088"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681662089"><a href="#local-6989586621681662089"><span class="hs-identifier">want_boot</span></a></a><span> </span><a name="local-6989586621681662090"><a href="#local-6989586621681662090"><span class="hs-identifier">maybe_pkg</span></a></a><span>
</span><a name="line-278"></a><span>  </span><span class="hs-comment">-- We must first find which Module this import refers to.  This involves</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-comment">-- calling the Finder, which as a side effect will search the filesystem</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-comment">-- and create a ModLocation.  If successful, loadIface will read the</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-comment">-- interface; it will call the Finder again, but the ModLocation will be</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-comment">-- cached from the first search.</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662091"><a href="#local-6989586621681662091"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-284"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662092"><a href="#local-6989586621681662092"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#findImportedModule"><span class="hs-identifier hs-var">findImportedModule</span></a><span> </span><a href="#local-6989586621681662091"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681662088"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662090"><span class="hs-identifier hs-var">maybe_pkg</span></a><span>
</span><a name="line-285"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662092"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-286"></a><span>           </span><span class="hs-identifier hs-var">Found</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681662093"><a href="#local-6989586621681662093"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><a href="#local-6989586621681662087"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662093"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportByUser</span><span> </span><a href="#local-6989586621681662089"><span class="hs-identifier hs-var">want_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>           </span><span class="hs-comment">-- TODO: Make sure this error message is good</span><span>
</span><a name="line-288"></a><span>           </span><a name="local-6989586621681662094"><a href="#local-6989586621681662094"><span class="hs-identifier">err</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><a href="Finder.html#cannotFindModule"><span class="hs-identifier hs-var">cannotFindModule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681662091"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662088"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662094"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-comment">-- | Load interface directly for a fully qualified 'Module'.  (This is a fairly</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- rare operation, but in particular it is used to load orphan modules</span><span>
</span><a name="line-292"></a><span class="hs-comment">-- in order to pull their instances into the global package table and to</span><span>
</span><a name="line-293"></a><span class="hs-comment">-- handle some operations in GHCi).</span><span>
</span><a name="line-294"></a><span class="hs-identifier">loadModuleInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-295"></a><a name="loadModuleInterface"><a href="LoadIface.html#loadModuleInterface"><span class="hs-identifier">loadModuleInterface</span></a></a><span> </span><a name="local-6989586621681662095"><a href="#local-6989586621681662095"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662096"><a href="#local-6989586621681662096"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621681662095"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662096"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- | Load interfaces for a collection of modules.</span><span>
</span><a name="line-298"></a><span class="hs-identifier">loadModuleInterfaces</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-299"></a><a name="loadModuleInterfaces"><a href="LoadIface.html#loadModuleInterfaces"><span class="hs-identifier">loadModuleInterfaces</span></a></a><span> </span><a name="local-6989586621681662097"><a href="#local-6989586621681662097"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662098"><a href="#local-6989586621681662098"><span class="hs-identifier">mods</span></a></a><span>
</span><a name="line-300"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681662098"><span class="hs-identifier hs-var">mods</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621681662099"><span class="hs-identifier hs-var">load</span></a><span> </span><a href="#local-6989586621681662098"><span class="hs-identifier hs-var">mods</span></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-303"></a><span>    </span><a name="local-6989586621681662099"><a href="#local-6989586621681662099"><span class="hs-identifier">load</span></a></a><span> </span><a name="local-6989586621681662100"><a href="#local-6989586621681662100"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662097"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662100"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662100"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-- | Loads the interface for a given Name.</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- Should only be called for an imported name;</span><span>
</span><a name="line-307"></a><span class="hs-comment">-- otherwise loadSysInterface may not find the interface</span><span>
</span><a name="line-308"></a><span class="hs-identifier">loadInterfaceForName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-309"></a><a name="loadInterfaceForName"><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier">loadInterfaceForName</span></a></a><span> </span><a name="local-6989586621681662101"><a href="#local-6989586621681662101"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662102"><a href="#local-6989586621681662102"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-310"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Check pre-condition</span><span>
</span><a name="line-311"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662103"><a href="#local-6989586621681662103"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-312"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nameIsLocalOrFrom</span><span> </span><span class="hs-identifier hs-var">this_mod</span><span> </span><span class="hs-identifier">name</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662103"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">parens</span><span> </span><span class="hs-identifier hs-var">doc</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>        </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621681662101"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662102"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">-- | Only loads the interface for external non-local names.</span><span>
</span><a name="line-317"></a><span class="hs-identifier">loadInterfaceForNameMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><a name="loadInterfaceForNameMaybe"><a href="LoadIface.html#loadInterfaceForNameMaybe"><span class="hs-identifier">loadInterfaceForNameMaybe</span></a></a><span> </span><a name="local-6989586621681662104"><a href="#local-6989586621681662104"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662105"><a href="#local-6989586621681662105"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662106"><a href="#local-6989586621681662106"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-320"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621681662106"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681662105"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621681662105"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-322"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621681662104"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662105"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-comment">-- | Loads the interface for a given Module.</span><span>
</span><a name="line-326"></a><span class="hs-identifier">loadInterfaceForModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-327"></a><a name="loadInterfaceForModule"><a href="LoadIface.html#loadInterfaceForModule"><span class="hs-identifier">loadInterfaceForModule</span></a></a><span> </span><a name="local-6989586621681662107"><a href="#local-6989586621681662107"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662108"><a href="#local-6989586621681662108"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-328"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-comment">-- Should not be called with this module</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-331"></a><span>      </span><a name="local-6989586621681662109"><a href="#local-6989586621681662109"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-332"></a><span>      </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">this_mod</span><span> </span><span class="hs-operator">/=</span><span> </span><a href="#local-6989586621681662109"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662109"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681662109"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">parens</span><span> </span><span class="hs-identifier">doc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>    </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621681662107"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662108"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
                loadInterface

        The main function to load an interface
        for an imported module, and put it in
        the External Package State
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-comment">-- | An 'IfM' function to load the home interface for a wired-in thing,</span><span>
</span><a name="line-348"></a><span class="hs-comment">-- so that we're sure that we see its instance declarations and rules</span><span>
</span><a name="line-349"></a><span class="hs-comment">-- See Note [Loading instances for wired-in things]</span><span>
</span><a name="line-350"></a><span class="hs-identifier">loadWiredInHomeIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662054"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><a name="loadWiredInHomeIface"><a href="LoadIface.html#loadWiredInHomeIface"><span class="hs-identifier">loadWiredInHomeIface</span></a></a><span> </span><a name="local-6989586621681662110"><a href="#local-6989586621681662110"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-352"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isWiredInName</span><span> </span><span class="hs-identifier hs-var">name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621681662111"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621681662110"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-355"></a><span>    </span><a name="local-6989586621681662111"><a href="#local-6989586621681662111"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Need home interface for wired-in thing&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662110"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- | Loads a system interface and throws an exception if it fails</span><span>
</span><a name="line-359"></a><span class="hs-identifier">loadSysInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662053"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-360"></a><a name="loadSysInterface"><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier">loadSysInterface</span></a></a><span> </span><a name="local-6989586621681662112"><a href="#local-6989586621681662112"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662113"><a href="#local-6989586621681662113"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#loadInterfaceWithException"><span class="hs-identifier hs-var">loadInterfaceWithException</span></a><span> </span><a href="#local-6989586621681662112"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662113"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-identifier hs-var">ImportBySystem</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- | Loads a user interface and throws an exception if it fails. The first parameter indicates</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- whether we should import the boot variant of the module</span><span>
</span><a name="line-365"></a><span class="hs-identifier">loadUserInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662052"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-366"></a><a name="loadUserInterface"><a href="LoadIface.html#loadUserInterface"><span class="hs-identifier">loadUserInterface</span></a></a><span> </span><a name="local-6989586621681662114"><a href="#local-6989586621681662114"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621681662115"><a href="#local-6989586621681662115"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662116"><a href="#local-6989586621681662116"><span class="hs-identifier">mod_name</span></a></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#loadInterfaceWithException"><span class="hs-identifier hs-var">loadInterfaceWithException</span></a><span> </span><a href="#local-6989586621681662115"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662116"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportByUser</span><span> </span><a href="#local-6989586621681662114"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-identifier">loadPluginInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662051"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-370"></a><a name="loadPluginInterface"><a href="LoadIface.html#loadPluginInterface"><span class="hs-identifier">loadPluginInterface</span></a></a><span> </span><a name="local-6989586621681662117"><a href="#local-6989586621681662117"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662118"><a href="#local-6989586621681662118"><span class="hs-identifier">mod_name</span></a></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#loadInterfaceWithException"><span class="hs-identifier hs-var">loadInterfaceWithException</span></a><span> </span><a href="#local-6989586621681662117"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662118"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-identifier hs-var">ImportByPlugin</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- | A wrapper for 'loadInterface' that throws an exception if it fails</span><span>
</span><a name="line-375"></a><span class="hs-identifier">loadInterfaceWithException</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WhereFrom</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662050"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-376"></a><a name="loadInterfaceWithException"><a href="LoadIface.html#loadInterfaceWithException"><span class="hs-identifier">loadInterfaceWithException</span></a></a><span> </span><a name="local-6989586621681662119"><a href="#local-6989586621681662119"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681662120"><a href="#local-6989586621681662120"><span class="hs-identifier">mod_name</span></a></a><span> </span><a name="local-6989586621681662121"><a href="#local-6989586621681662121"><span class="hs-identifier">where_from</span></a></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#withException"><span class="hs-identifier hs-var">withException</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><a href="#local-6989586621681662119"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681662120"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621681662121"><span class="hs-identifier hs-var">where_from</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-380"></a><span class="hs-identifier">loadInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WhereFrom</span><span>
</span><a name="line-381"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681662049"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- loadInterface looks in both the HPT and PIT for the required interface</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- If not found, it loads it, and puts it in the PIT (always).</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- If it can't find a suitable interface file, we</span><span>
</span><a name="line-387"></a><span class="hs-comment">--      a) modify the PackageIfaceTable to have an empty entry</span><span>
</span><a name="line-388"></a><span class="hs-comment">--              (to avoid repeated complaints)</span><span>
</span><a name="line-389"></a><span class="hs-comment">--      b) return (Left message)</span><span>
</span><a name="line-390"></a><span class="hs-comment">--</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- It's not necessarily an error for there not to be an interface</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- file -- perhaps the module has changed, and that interface</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- is no longer used</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><a name="loadInterface"><a href="LoadIface.html#loadInterface"><span class="hs-identifier">loadInterface</span></a></a><span> </span><a name="local-6989586621681662122"><a href="#local-6989586621681662122"><span class="hs-identifier">doc_str</span></a></a><span> </span><a name="local-6989586621681662123"><a href="#local-6989586621681662123"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681662124"><a href="#local-6989586621681662124"><span class="hs-identifier">from</span></a></a><span>
</span><a name="line-396"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isHoleModule</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-397"></a><span>  </span><span class="hs-comment">-- Hole modules get special treatment</span><span>
</span><a name="line-398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681662125"><a href="#local-6989586621681662125"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-399"></a><span>       </span><span class="hs-comment">-- Redo search for our local hole module</span><span>
</span><a name="line-400"></a><span>       </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><a href="#local-6989586621681662122"><span class="hs-identifier hs-var">doc_str</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621681662125"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662124"><span class="hs-identifier hs-var">from</span></a><span>
</span><a name="line-401"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-402"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Read the state</span><span>
</span><a name="line-403"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621681662126"><a href="#local-6989586621681662126"><span class="hs-identifier">eps</span></a></a><span class="hs-special">,</span><a name="local-6989586621681662127"><a href="#local-6989586621681662127"><span class="hs-identifier">hpt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEpsAndHpt"><span class="hs-identifier hs-var">getEpsAndHpt</span></a><span>
</span><a name="line-404"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662128"><a href="#local-6989586621681662128"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Considering whether to load&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662124"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>                </span><span class="hs-comment">-- Check whether we have the interface already</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662129"><a href="#local-6989586621681662129"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-410"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621681662129"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662127"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621681662126"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-411"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662130"><a href="#local-6989586621681662130"><span class="hs-identifier">iface</span></a></a><span>
</span><a name="line-412"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662130"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>   </span><span class="hs-comment">-- Already loaded</span><span>
</span><a name="line-413"></a><span>                        </span><span class="hs-comment">-- The (src_imp == mi_boot iface) test checks that the already-loaded</span><span>
</span><a name="line-414"></a><span>                        </span><span class="hs-comment">-- interface isn't a boot iface.  This can conceivably happen,</span><span>
</span><a name="line-415"></a><span>                        </span><span class="hs-comment">-- if an earlier import had a before we got to real imports.   I think.</span><span>
</span><a name="line-416"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>        </span><span class="hs-comment">-- READ THE MODULE IN</span><span>
</span><a name="line-419"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662133"><a href="#local-6989586621681662133"><span class="hs-identifier">read_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#wantHiBootFile"><span class="hs-identifier hs-var">wantHiBootFile</span></a><span> </span><a href="#local-6989586621681662129"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662126"><span class="hs-identifier hs-var">eps</span></a><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662124"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-420"></a><span>                           </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662131"><a href="#local-6989586621681662131"><span class="hs-identifier">err</span></a></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662131"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>                           </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681662132"><a href="#local-6989586621681662132"><span class="hs-identifier">hi_boot_file</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="LoadIface.html#computeInterface"><span class="hs-identifier hs-var">computeInterface</span></a><span> </span><a href="#local-6989586621681662122"><span class="hs-identifier hs-var">doc_str</span></a><span> </span><a href="#local-6989586621681662132"><span class="hs-identifier hs-var">hi_boot_file</span></a><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-422"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662133"><span class="hs-identifier hs-var">read_result</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-423"></a><span>            </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662134"><a href="#local-6989586621681662134"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-424"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662135"><a href="#local-6989586621681662135"><span class="hs-identifier">fake_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyModIface</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681662136"><a href="#local-6989586621681662136"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-427"></a><span>                        </span><a href="#local-6989586621681662136"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eps_PIT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621681662136"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662135"><span class="hs-identifier hs-var">fake_iface</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662135"><span class="hs-identifier hs-var">fake_iface</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-428"></a><span>                        </span><span class="hs-comment">-- Not found, so add an empty iface to</span><span>
</span><a name="line-429"></a><span>                        </span><span class="hs-comment">-- the EPS map so that we don't look again</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662134"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>        </span><span class="hs-comment">-- Found and parsed!</span><span>
</span><a name="line-434"></a><span>        </span><span class="hs-comment">-- We used to have a sanity check here that looked for:</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-comment">--  * System importing ..</span><span>
</span><a name="line-436"></a><span>        </span><span class="hs-comment">--  * a home package module ..</span><span>
</span><a name="line-437"></a><span>        </span><span class="hs-comment">--  * that we know nothing about (mb_dep == Nothing)!</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-comment">-- But this is no longer valid because thNameToGhcName allows users to</span><span>
</span><a name="line-440"></a><span>        </span><span class="hs-comment">-- cause the system to load arbitrary interfaces (by supplying an appropriate</span><span>
</span><a name="line-441"></a><span>        </span><span class="hs-comment">-- Template Haskell original-name).</span><span>
</span><a name="line-442"></a><span>            </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662137"><a href="#local-6989586621681662137"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662138"><a href="#local-6989586621681662138"><span class="hs-identifier">loc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-443"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-444"></a><span>            </span><a name="local-6989586621681662139"><a href="#local-6989586621681662139"><span class="hs-identifier">loc_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681662138"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-445"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-446"></a><span>        </span><a href="TcRnMonad.html#initIfaceLcl"><span class="hs-identifier hs-var">initIfaceLcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_semantic_module</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662139"><span class="hs-identifier hs-var">loc_doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span>        </span><a href="LoadIface.html#dontLeakTheHPT"><span class="hs-identifier hs-var">dontLeakTheHPT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>        </span><span class="hs-comment">--      Load the new ModIface into the External Package State</span><span>
</span><a name="line-451"></a><span>        </span><span class="hs-comment">-- Even home-package interfaces loaded by loadInterface</span><span>
</span><a name="line-452"></a><span>        </span><span class="hs-comment">--      (which only happens in OneShot mode; in Batch/Interactive</span><span>
</span><a name="line-453"></a><span>        </span><span class="hs-comment">--      mode, home-package modules are loaded one by one into the HPT)</span><span>
</span><a name="line-454"></a><span>        </span><span class="hs-comment">-- are put in the EPS.</span><span>
</span><a name="line-455"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-456"></a><span>        </span><span class="hs-comment">-- The main thing is to add the ModIface to the PIT, but</span><span>
</span><a name="line-457"></a><span>        </span><span class="hs-comment">-- we also take the</span><span>
</span><a name="line-458"></a><span>        </span><span class="hs-comment">--      IfaceDecls, IfaceClsInst, IfaceFamInst, IfaceRules,</span><span>
</span><a name="line-459"></a><span>        </span><span class="hs-comment">-- out of the ModIface and put them into the big EPS pools</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span>        </span><span class="hs-comment">-- NB: *first* we do loadDecl, so that the provenance of all the locally-defined</span><span>
</span><a name="line-462"></a><span>        </span><span class="hs-comment">---    names is done correctly (notably, whether this is an .hi file or .hi-boot file).</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-comment">--     If we do loadExport first the wrong info gets into the cache (unless we</span><span>
</span><a name="line-464"></a><span>        </span><span class="hs-comment">--      explicitly tag each export which seems a bit of a bore)</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662140"><a href="#local-6989586621681662140"><span class="hs-identifier">ignore_prags</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_IgnoreInterfacePragmas</span><span>
</span><a name="line-467"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662141"><a href="#local-6989586621681662141"><span class="hs-identifier">new_eps_decls</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadDecls"><span class="hs-identifier hs-var">loadDecls</span></a><span> </span><a href="#local-6989586621681662140"><span class="hs-identifier hs-var">ignore_prags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_decls</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662142"><a href="#local-6989586621681662142"><span class="hs-identifier">new_eps_insts</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcIface.html#tcIfaceInst"><span class="hs-identifier hs-var">tcIfaceInst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_insts</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662143"><a href="#local-6989586621681662143"><span class="hs-identifier">new_eps_fam_insts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcIface.html#tcIfaceFamInst"><span class="hs-identifier hs-var">tcIfaceFamInst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_fam_insts</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662144"><a href="#local-6989586621681662144"><span class="hs-identifier">new_eps_rules</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcIface.html#tcIfaceRules"><span class="hs-identifier hs-var">tcIfaceRules</span></a><span> </span><a href="#local-6989586621681662140"><span class="hs-identifier hs-var">ignore_prags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_rules</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662145"><a href="#local-6989586621681662145"><span class="hs-identifier">new_eps_anns</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcIface.html#tcIfaceAnnotations"><span class="hs-identifier hs-var">tcIfaceAnnotations</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_anns</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662146"><a href="#local-6989586621681662146"><span class="hs-identifier">new_eps_complete_sigs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcIface.html#tcIfaceCompleteSigs"><span class="hs-identifier hs-var">tcIfaceCompleteSigs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_complete_sigs</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662147"><a href="#local-6989586621681662147"><span class="hs-identifier">final_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-475"></a><span>                                </span><span class="hs-identifier">mi_decls</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No mi_decls in PIT&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-476"></a><span>                                </span><span class="hs-identifier">mi_insts</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No mi_insts in PIT&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-477"></a><span>                                </span><span class="hs-identifier">mi_fam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No mi_fam_insts in PIT&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-478"></a><span>                                </span><span class="hs-identifier">mi_rules</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No mi_rules in PIT&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-479"></a><span>                                </span><span class="hs-identifier">mi_anns</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No mi_anns in PIT&quot;</span><span>
</span><a name="line-480"></a><span>                              </span><span class="hs-special">}</span><span>
</span><a name="line-481"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662148"><a href="#local-6989586621681662148"><span class="hs-identifier">bad_boot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">if_rec_types</span><span> </span><a href="#local-6989586621681662128"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-484"></a><span>                            </span><span class="hs-comment">-- Warn warn against an EPS-updating import</span><span>
</span><a name="line-485"></a><span>                            </span><span class="hs-comment">-- of one's own boot file! (one-shot only)</span><span>
</span><a name="line-486"></a><span>                            </span><span class="hs-comment">-- See Note [Loading your own hi-boot file]</span><span>
</span><a name="line-487"></a><span>                            </span><span class="hs-comment">-- in MkIface.</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">bad_boot</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662148"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681662148"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>          </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681662149"><a href="#local-6989586621681662149"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-491"></a><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">elemModuleEnv</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="LoadIface.html#is_external_sig"><span class="hs-identifier hs-var">is_external_sig</span></a><span> </span><a href="#local-6989586621681662129"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662137"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-492"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-493"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681662148"><span class="hs-identifier hs-var">bad_boot</span></a><span>
</span><a name="line-494"></a><span>                </span><span class="hs-comment">-- See Note [Loading your own hi-boot file]</span><span>
</span><a name="line-495"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eps_PTE</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#addDeclsToPTE"><span class="hs-identifier hs-var">addDeclsToPTE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PTE</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662141"><span class="hs-identifier hs-var">new_eps_decls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-496"></a><span>           </span><span class="hs-keyword">else</span><span>
</span><a name="line-497"></a><span>                </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-498"></a><span>                  </span><span class="hs-identifier">eps_PIT</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662147"><span class="hs-identifier hs-var">final_iface</span></a><span class="hs-special">,</span><span>
</span><a name="line-499"></a><span>                  </span><span class="hs-identifier">eps_PTE</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#addDeclsToPTE"><span class="hs-identifier hs-var">addDeclsToPTE</span></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier">eps_PTE</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662141"><span class="hs-identifier hs-var">new_eps_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-500"></a><span>                  </span><span class="hs-identifier">eps_rule_base</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendRuleBaseList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_rule_base</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>                                                        </span><a href="#local-6989586621681662144"><span class="hs-identifier hs-var">new_eps_rules</span></a><span class="hs-special">,</span><span>
</span><a name="line-502"></a><span>                  </span><span class="hs-identifier">eps_complete_matches</span><span>
</span><a name="line-503"></a><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendCompleteMatchMap</span><span>
</span><a name="line-504"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier">eps_complete_matches</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>                                         </span><a href="#local-6989586621681662146"><span class="hs-identifier hs-var">new_eps_complete_sigs</span></a><span class="hs-special">,</span><span>
</span><a name="line-506"></a><span>                  </span><span class="hs-identifier">eps_inst_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_inst_env</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>                                                       </span><a href="#local-6989586621681662142"><span class="hs-identifier hs-var">new_eps_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-508"></a><span>                  </span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>                                                          </span><a href="#local-6989586621681662143"><span class="hs-identifier hs-var">new_eps_fam_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-510"></a><span>                  </span><span class="hs-identifier">eps_ann_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendAnnEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_ann_env</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>                                                      </span><a href="#local-6989586621681662145"><span class="hs-identifier hs-var">new_eps_anns</span></a><span class="hs-special">,</span><span>
</span><a name="line-512"></a><span>                  </span><span class="hs-identifier">eps_mod_fam_inst_env</span><span>
</span><a name="line-513"></a><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-514"></a><span>                                       </span><a name="local-6989586621681662150"><a href="#local-6989586621681662150"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-515"></a><span>                                         </span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span> </span><span class="hs-identifier hs-var">emptyFamInstEnv</span><span>
</span><a name="line-516"></a><span>                                                              </span><a href="#local-6989586621681662143"><span class="hs-identifier hs-var">new_eps_fam_insts</span></a><span>
</span><a name="line-517"></a><span>                                     </span><span class="hs-keyword">in</span><span>
</span><a name="line-518"></a><span>                                     </span><span class="hs-identifier hs-var">extendModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_mod_fam_inst_env</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-519"></a><span>                                                     </span><a href="#local-6989586621681662123"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-520"></a><span>                                                     </span><a href="#local-6989586621681662150"><span class="hs-identifier hs-var">fam_inst_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-521"></a><span>                  </span><span class="hs-identifier">eps_stats</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addEpsInStats</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_stats</span><span> </span><a href="#local-6989586621681662149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681662141"><span class="hs-identifier hs-var">new_eps_decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681662142"><span class="hs-identifier hs-var">new_eps_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681662144"><span class="hs-identifier hs-var">new_eps_rules</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- invoke plugins</span><span>
</span><a name="line-527"></a><span>          </span><a name="local-6989586621681662151"><a href="#local-6989586621681662151"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">withPlugins</span><span> </span><a href="#local-6989586621681662129"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier">interfaceLoadAction</span><span> </span><a href="#local-6989586621681662147"><span class="hs-identifier hs-var">final_iface</span></a><span>
</span><a name="line-528"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662151"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span class="hs-comment">{- Note [Loading your own hi-boot file]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generally speaking, when compiling module M, we should not
load M.hi boot into the EPS.  After all, we are very shortly
going to have full information about M.  Moreover, see
Note [Do not update EPS with your own hi-boot] in MkIface.

But there is a HORRIBLE HACK here.

* At the end of tcRnImports, we call checkFamInstConsistency to
  check consistency of imported type-family instances
  See Note [The type family instance consistency story] in FamInst

* Alas, those instances may refer to data types defined in M,
  if there is a M.hs-boot.

* And that means we end up loading M.hi-boot, because those
  data types are not yet in the type environment.

But in this wierd case, /all/ we need is the types. We don't need
instances, rules etc.  And if we put the instances in the EPS
we get &quot;duplicate instance&quot; warnings when we compile the &quot;real&quot;
instance in M itself.  Hence the strange business of just updateing
the eps_PTE.

This really happens in practice.  The module HsExpr.hs gets
&quot;duplicate instance&quot; errors if this hack is not present.

This is a mess.


Note [HPT space leak] (#15111)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In IfL, we defer some work until it is demanded using forkM, such
as building TyThings from IfaceDecls. These thunks are stored in
the ExternalPackageState, and they might never be poked.  If we're
not careful, these thunks will capture the state of the loaded
program when we read an interface file, and retain all that data
for ever.

Therefore, when loading a package interface file , we use a &quot;clean&quot;
version of the HscEnv with all the data about the currently loaded
program stripped out. Most of the fields can be panics because
we'll never read them, but hsc_HPT needs to be empty because this
interface will cause other interfaces to be loaded recursively, and
when looking up those interfaces we use the HPT in loadInterface.
We know that none of the interfaces below here can refer to
home-package modules however, so it's safe for the HPT to be empty.
-}</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-identifier">dontLeakTheHPT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681662048"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681662048"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-582"></a><a name="dontLeakTheHPT"><a href="LoadIface.html#dontLeakTheHPT"><span class="hs-identifier">dontLeakTheHPT</span></a></a><span> </span><a name="local-6989586621681662152"><a href="#local-6989586621681662152"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-583"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-584"></a><span>    </span><a name="local-6989586621681662153"><a href="#local-6989586621681662153"><span class="hs-identifier">cleanTopEnv</span></a></a><span> </span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-585"></a><span>       </span><span class="hs-keyword">let</span><span>
</span><a name="line-586"></a><span>         </span><span class="hs-comment">-- wrinkle: when we're typechecking in --backpack mode, the</span><span>
</span><a name="line-587"></a><span>         </span><span class="hs-comment">-- instantiation of a signature might reside in the HPT, so</span><span>
</span><a name="line-588"></a><span>         </span><span class="hs-comment">-- this case breaks the assumption that EPS interfaces only</span><span>
</span><a name="line-589"></a><span>         </span><span class="hs-comment">-- refer to other EPS interfaces. We can detect when we're in</span><span>
</span><a name="line-590"></a><span>         </span><span class="hs-comment">-- typechecking-only mode by using hscTarget==HscNothing, and</span><span>
</span><a name="line-591"></a><span>         </span><span class="hs-comment">-- in that case we don't empty the HPT.  (admittedly this is</span><span>
</span><a name="line-592"></a><span>         </span><span class="hs-comment">-- a bit of a hack, better suggestions welcome). A number of</span><span>
</span><a name="line-593"></a><span>         </span><span class="hs-comment">-- tests in testsuite/tests/backpack break without this</span><span>
</span><a name="line-594"></a><span>         </span><span class="hs-comment">-- tweak.</span><span>
</span><a name="line-595"></a><span>         </span><span class="hs-glyph">!</span><a name="local-6989586621681662164"><a href="#local-6989586621681662164"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621681662154"><span class="hs-identifier hs-var">hsc_dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681662158"><span class="hs-identifier hs-var">hsc_HPT</span></a><span>
</span><a name="line-596"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyHomePackageTable</span><span>
</span><a name="line-597"></a><span>       </span><span class="hs-keyword">in</span><span>
</span><a name="line-598"></a><span>       </span><span class="hs-identifier hs-var">HscEnv</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-identifier">hsc_targets</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cleanTopEnv: hsc_targets&quot;</span><span>
</span><a name="line-599"></a><span>              </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_mod_graph</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cleanTopEnv: hsc_mod_graph&quot;</span><span>
</span><a name="line-600"></a><span>              </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_IC</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cleanTopEnv: hsc_IC&quot;</span><span>
</span><a name="line-601"></a><span>              </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_HPT</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681662164"><span class="hs-identifier hs-var">hpt</span></a><span>
</span><a name="line-602"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span>  </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span> </span><a href="#local-6989586621681662153"><span class="hs-identifier hs-var">cleanTopEnv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-605"></a><span>  </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>        </span><span class="hs-comment">-- force the updTopEnv</span><span>
</span><a name="line-606"></a><span>  </span><a href="#local-6989586621681662152"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span class="hs-comment">-- | Returns @True@ if a 'ModIface' comes from an external package.</span><span>
</span><a name="line-610"></a><span class="hs-comment">-- In this case, we should NOT load it into the EPS; the entities</span><span>
</span><a name="line-611"></a><span class="hs-comment">-- should instead come from the local merged signature interface.</span><span>
</span><a name="line-612"></a><span class="hs-identifier">is_external_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-613"></a><a name="is_external_sig"><a href="LoadIface.html#is_external_sig"><span class="hs-identifier">is_external_sig</span></a></a><span> </span><a name="local-6989586621681662165"><a href="#local-6989586621681662165"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681662166"><a href="#local-6989586621681662166"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-614"></a><span>    </span><span class="hs-comment">-- It's a signature iface...</span><span>
</span><a name="line-615"></a><span>    </span><span class="hs-identifier hs-var">mi_semantic_module</span><span> </span><a href="#local-6989586621681662166"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662166"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-616"></a><span>    </span><span class="hs-comment">-- and it's not from the local package</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662166"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621681662165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-comment">-- | This is an improved version of 'findAndReadIface' which can also</span><span>
</span><a name="line-620"></a><span class="hs-comment">-- handle the case when a user requests @p[A=&lt;B&gt;]:M@ but we only</span><span>
</span><a name="line-621"></a><span class="hs-comment">-- have an interface for @p[A=&lt;A&gt;]:M@ (the indefinite interface.</span><span>
</span><a name="line-622"></a><span class="hs-comment">-- If we are not trying to build code, we load the interface we have,</span><span>
</span><a name="line-623"></a><span class="hs-comment">-- *instantiating it* according to how the holes are specified.</span><span>
</span><a name="line-624"></a><span class="hs-comment">-- (Of course, if we're actually building code, this is a hard error.)</span><span>
</span><a name="line-625"></a><span class="hs-comment">--</span><span>
</span><a name="line-626"></a><span class="hs-comment">-- In the presence of holes, 'computeInterface' has an important invariant:</span><span>
</span><a name="line-627"></a><span class="hs-comment">-- to load module M, its set of transitively reachable requirements must</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- have an up-to-date local hi file for that requirement.  Note that if</span><span>
</span><a name="line-629"></a><span class="hs-comment">-- we are loading the interface of a requirement, this does not</span><span>
</span><a name="line-630"></a><span class="hs-comment">-- apply to the requirement itself; e.g., @p[A=&lt;A&gt;]:A@ does not require</span><span>
</span><a name="line-631"></a><span class="hs-comment">-- A.hi to be up-to-date (and indeed, we MUST NOT attempt to read A.hi, unless</span><span>
</span><a name="line-632"></a><span class="hs-comment">-- we are actually typechecking p.)</span><span>
</span><a name="line-633"></a><span class="hs-identifier">computeInterface</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-634"></a><span>       </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-635"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681662046"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681662047"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-636"></a><a name="computeInterface"><a href="LoadIface.html#computeInterface"><span class="hs-identifier">computeInterface</span></a></a><span> </span><a name="local-6989586621681662167"><a href="#local-6989586621681662167"><span class="hs-identifier">doc_str</span></a></a><span> </span><a name="local-6989586621681662168"><a href="#local-6989586621681662168"><span class="hs-identifier">hi_boot_file</span></a></a><span> </span><a name="local-6989586621681662169"><a href="#local-6989586621681662169"><span class="hs-identifier">mod0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-637"></a><span>    </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isHoleModule</span><span> </span><span class="hs-identifier hs-var">mod0</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-638"></a><span>    </span><a name="local-6989586621681662170"><a href="#local-6989586621681662170"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-639"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitModuleInsts</span><span> </span><a href="#local-6989586621681662169"><span class="hs-identifier hs-var">mod0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-640"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681662171"><a href="#local-6989586621681662171"><span class="hs-identifier">imod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662172"><a href="#local-6989586621681662172"><span class="hs-identifier">indef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitIdIsDefinite</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621681662170"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-641"></a><span>            </span><a name="local-6989586621681662173"><a href="#local-6989586621681662173"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#findAndReadIface"><span class="hs-identifier hs-var">findAndReadIface</span></a><span> </span><a href="#local-6989586621681662167"><span class="hs-identifier hs-var">doc_str</span></a><span> </span><a href="#local-6989586621681662171"><span class="hs-identifier hs-var">imod</span></a><span> </span><a href="#local-6989586621681662169"><span class="hs-identifier hs-var">mod0</span></a><span> </span><a href="#local-6989586621681662168"><span class="hs-identifier hs-var">hi_boot_file</span></a><span>
</span><a name="line-642"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662173"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-643"></a><span>                </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662174"><a href="#local-6989586621681662174"><span class="hs-identifier">iface0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662175"><a href="#local-6989586621681662175"><span class="hs-identifier">path</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-644"></a><span>                    </span><a name="local-6989586621681662176"><a href="#local-6989586621681662176"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-645"></a><span>                    </span><a name="local-6989586621681662177"><a href="#local-6989586621681662177"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-646"></a><span>                        </span><a href="RnModIface.html#rnModIface"><span class="hs-identifier hs-var">rnModIface</span></a><span> </span><a href="#local-6989586621681662176"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">indefModuleUnitId</span><span> </span><a href="#local-6989586621681662172"><span class="hs-identifier hs-var">indef</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-647"></a><span>                                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681662174"><span class="hs-identifier hs-var">iface0</span></a><span>
</span><a name="line-648"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662177"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-649"></a><span>                        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681662178"><a href="#local-6989586621681662178"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662178"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662175"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>                        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681662179"><a href="#local-6989586621681662179"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkSrcErr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681662179"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-651"></a><span>                </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662180"><a href="#local-6989586621681662180"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662180"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-652"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681662181"><a href="#local-6989586621681662181"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-653"></a><span>            </span><a href="LoadIface.html#findAndReadIface"><span class="hs-identifier hs-var">findAndReadIface</span></a><span> </span><a href="#local-6989586621681662167"><span class="hs-identifier hs-var">doc_str</span></a><span> </span><a href="#local-6989586621681662181"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662169"><span class="hs-identifier hs-var">mod0</span></a><span> </span><a href="#local-6989586621681662168"><span class="hs-identifier hs-var">hi_boot_file</span></a><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span class="hs-comment">-- | Compute the signatures which must be compiled in order to</span><span>
</span><a name="line-656"></a><span class="hs-comment">-- load the interface for a 'Module'.  The output of this function</span><span>
</span><a name="line-657"></a><span class="hs-comment">-- is always a subset of 'moduleFreeHoles'; it is more precise</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- because in signature @p[A=&lt;A&gt;,B=&lt;B&gt;]:B@, although the free holes</span><span>
</span><a name="line-659"></a><span class="hs-comment">-- are A and B, B might not depend on A at all!</span><span>
</span><a name="line-660"></a><span class="hs-comment">--</span><span>
</span><a name="line-661"></a><span class="hs-comment">-- If this is invoked on a signature, this does NOT include the</span><span>
</span><a name="line-662"></a><span class="hs-comment">-- signature itself; e.g. precise free module holes of</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- @p[A=&lt;A&gt;,B=&lt;B&gt;]:B@ never includes B.</span><span>
</span><a name="line-664"></a><span class="hs-identifier">moduleFreeHolesPrecise</span><span>
</span><a name="line-665"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681662044"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681662045"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UniqDSet</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-667"></a><a name="moduleFreeHolesPrecise"><a href="LoadIface.html#moduleFreeHolesPrecise"><span class="hs-identifier">moduleFreeHolesPrecise</span></a></a><span> </span><a name="local-6989586621681662182"><a href="#local-6989586621681662182"><span class="hs-identifier">doc_str</span></a></a><span> </span><a name="local-6989586621681662183"><a href="#local-6989586621681662183"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-668"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">moduleIsDefinite</span><span> </span><a href="#local-6989586621681662183"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-identifier hs-var">emptyUniqDSet</span><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-670"></a><span>   </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitModuleInsts</span><span> </span><a href="#local-6989586621681662183"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-671"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681662202"><a href="#local-6989586621681662202"><span class="hs-identifier">imod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662203"><a href="#local-6989586621681662203"><span class="hs-identifier">indef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-672"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662204"><a href="#local-6989586621681662204"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">indefModuleUnitId</span><span> </span><a href="#local-6989586621681662203"><span class="hs-identifier hs-var">indef</span></a><span class="hs-special">)</span><span>
</span><a name="line-673"></a><span>        </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Considering whether to load&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662183"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-674"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to compute precise free module holes&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681662205"><a href="#local-6989586621681662205"><span class="hs-identifier">eps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662206"><a href="#local-6989586621681662206"><span class="hs-identifier">hpt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEpsAndHpt"><span class="hs-identifier hs-var">getEpsAndHpt</span></a><span>
</span><a name="line-676"></a><span>        </span><a name="local-6989586621681662207"><a href="#local-6989586621681662207"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-677"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662184"><span class="hs-identifier hs-var">tryEpsAndHpt</span></a><span> </span><a href="#local-6989586621681662207"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662205"><span class="hs-identifier hs-var">eps</span></a><span> </span><a href="#local-6989586621681662206"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">firstJust</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681662185"><span class="hs-identifier hs-var">tryDepsCache</span></a><span> </span><a href="#local-6989586621681662205"><span class="hs-identifier hs-var">eps</span></a><span> </span><a href="#local-6989586621681662202"><span class="hs-identifier hs-var">imod</span></a><span> </span><a href="#local-6989586621681662204"><span class="hs-identifier hs-var">insts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-678"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662208"><a href="#local-6989586621681662208"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662208"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-679"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681662186"><span class="hs-identifier hs-var">readAndCache</span></a><span> </span><a href="#local-6989586621681662202"><span class="hs-identifier hs-var">imod</span></a><span> </span><a href="#local-6989586621681662204"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-680"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-identifier hs-var">emptyUniqDSet</span><span class="hs-special">)</span><span>
</span><a name="line-681"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-682"></a><span>    </span><a name="local-6989586621681662184"><a href="#local-6989586621681662184"><span class="hs-identifier">tryEpsAndHpt</span></a></a><span> </span><a name="local-6989586621681662187"><a href="#local-6989586621681662187"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681662188"><a href="#local-6989586621681662188"><span class="hs-identifier">eps</span></a></a><span> </span><a name="local-6989586621681662189"><a href="#local-6989586621681662189"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-683"></a><span>        </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">mi_free_holes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621681662187"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662189"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621681662188"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662183"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>    </span><a name="local-6989586621681662185"><a href="#local-6989586621681662185"><span class="hs-identifier">tryDepsCache</span></a></a><span> </span><a name="local-6989586621681662190"><a href="#local-6989586621681662190"><span class="hs-identifier">eps</span></a></a><span> </span><a name="local-6989586621681662191"><a href="#local-6989586621681662191"><span class="hs-identifier">imod</span></a></a><span> </span><a name="local-6989586621681662192"><a href="#local-6989586621681662192"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-685"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupInstalledModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_free_holes</span><span> </span><a href="#local-6989586621681662190"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662191"><span class="hs-identifier hs-var">imod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-686"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662193"><a href="#local-6989586621681662193"><span class="hs-identifier">ifhs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">renameFreeHoles</span><span> </span><a href="#local-6989586621681662193"><span class="hs-identifier hs-var">ifhs</span></a><span> </span><a href="#local-6989586621681662192"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>            </span><a name="local-6989586621681662194"><a href="#local-6989586621681662194"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-688"></a><span>    </span><a name="local-6989586621681662186"><a href="#local-6989586621681662186"><span class="hs-identifier">readAndCache</span></a></a><span> </span><a name="local-6989586621681662195"><a href="#local-6989586621681662195"><span class="hs-identifier">imod</span></a></a><span> </span><a name="local-6989586621681662196"><a href="#local-6989586621681662196"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-689"></a><span>        </span><a name="local-6989586621681662197"><a href="#local-6989586621681662197"><span class="hs-identifier">mb_iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#findAndReadIface"><span class="hs-identifier hs-var">findAndReadIface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;moduleFreeHolesPrecise&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681662182"><span class="hs-identifier hs-var">doc_str</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662195"><span class="hs-identifier hs-var">imod</span></a><span> </span><a href="#local-6989586621681662183"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-690"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662197"><span class="hs-identifier hs-var">mb_iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-691"></a><span>            </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662198"><a href="#local-6989586621681662198"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-692"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662199"><a href="#local-6989586621681662199"><span class="hs-identifier">ifhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mi_free_holes</span><span> </span><a href="#local-6989586621681662198"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-693"></a><span>                </span><span class="hs-comment">-- Cache it</span><span>
</span><a name="line-694"></a><span>                </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681662200"><a href="#local-6989586621681662200"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-695"></a><span>                    </span><a href="#local-6989586621681662200"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eps_free_holes</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInstalledModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_free_holes</span><span> </span><a href="#local-6989586621681662200"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662195"><span class="hs-identifier hs-var">imod</span></a><span> </span><a href="#local-6989586621681662199"><span class="hs-identifier hs-var">ifhs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">renameFreeHoles</span><span> </span><a href="#local-6989586621681662199"><span class="hs-identifier hs-var">ifhs</span></a><span> </span><a href="#local-6989586621681662196"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>            </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662201"><a href="#local-6989586621681662201"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662201"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span class="hs-identifier">wantHiBootFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WhereFrom</span><span>
</span><a name="line-700"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span>
</span><a name="line-701"></a><span class="hs-comment">-- Figure out whether we want Foo.hi or Foo.hi-boot</span><span>
</span><a name="line-702"></a><a name="wantHiBootFile"><a href="LoadIface.html#wantHiBootFile"><span class="hs-identifier">wantHiBootFile</span></a></a><span> </span><a name="local-6989586621681662209"><a href="#local-6989586621681662209"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681662210"><a href="#local-6989586621681662210"><span class="hs-identifier">eps</span></a></a><span> </span><a name="local-6989586621681662211"><a href="#local-6989586621681662211"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681662212"><a href="#local-6989586621681662212"><span class="hs-identifier">from</span></a></a><span>
</span><a name="line-703"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662212"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-704"></a><span>       </span><span class="hs-identifier hs-var">ImportByUser</span><span> </span><a name="local-6989586621681662214"><a href="#local-6989586621681662214"><span class="hs-identifier">usr_boot</span></a></a><span>
</span><a name="line-705"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681662214"><span class="hs-identifier hs-var">usr_boot</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681662213"><span class="hs-identifier hs-var">this_package</span></a><span>
</span><a name="line-706"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#badSourceImport"><span class="hs-identifier hs-var">badSourceImport</span></a><span> </span><a href="#local-6989586621681662211"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662214"><span class="hs-identifier hs-var">usr_boot</span></a><span>
</span><a name="line-708"></a><span>
</span><a name="line-709"></a><span>       </span><span class="hs-identifier hs-var">ImportByPlugin</span><span>
</span><a name="line-710"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>       </span><span class="hs-identifier hs-var">ImportBySystem</span><span>
</span><a name="line-713"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681662213"><span class="hs-identifier hs-var">this_package</span></a><span>   </span><span class="hs-comment">-- If the module to be imported is not from this package</span><span>
</span><a name="line-714"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-identifier hs-var">False</span><span>   </span><span class="hs-comment">-- don't look it up in eps_is_boot, because that is keyed</span><span>
</span><a name="line-715"></a><span>                               </span><span class="hs-comment">-- on the ModuleName of *home-package* modules only.</span><span>
</span><a name="line-716"></a><span>                               </span><span class="hs-comment">-- We never import boot modules from other packages!</span><span>
</span><a name="line-717"></a><span>
</span><a name="line-718"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-719"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_is_boot</span><span> </span><a href="#local-6989586621681662210"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621681662211"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-720"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681662215"><a href="#local-6989586621681662215"><span class="hs-identifier">is_boot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662215"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-721"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-722"></a><span>                     </span><span class="hs-comment">-- The boot-ness of the requested interface,</span><span>
</span><a name="line-723"></a><span>                     </span><span class="hs-comment">-- based on the dependencies in directly-imported modules</span><span>
</span><a name="line-724"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-725"></a><span>    </span><a name="local-6989586621681662213"><a href="#local-6989586621681662213"><span class="hs-identifier">this_package</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621681662209"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681662211"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span class="hs-identifier">badSourceImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-728"></a><a name="badSourceImport"><a href="LoadIface.html#badSourceImport"><span class="hs-identifier">badSourceImport</span></a></a><span> </span><a name="local-6989586621681662216"><a href="#local-6989586621681662216"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;You cannot {-# SOURCE #-} import a module from another package&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662216"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;is from package&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681662216"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span class="hs-comment">-----------------------------------------------------</span><span>
</span><a name="line-734"></a><span class="hs-comment">--      Loading type/class/value decls</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- We pass the full Module name here, replete with</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- its package info, so that we can build a Name for</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- each binder with the right package info in it</span><span>
</span><a name="line-738"></a><span class="hs-comment">-- All subsequent lookups, including crucially lookups during typechecking</span><span>
</span><a name="line-739"></a><span class="hs-comment">-- the declaration itself, will find the fully-glorious Name</span><span>
</span><a name="line-740"></a><span class="hs-comment">--</span><span>
</span><a name="line-741"></a><span class="hs-comment">-- We handle ATs specially.  They are not main declarations, but also not</span><span>
</span><a name="line-742"></a><span class="hs-comment">-- implicit things (in particular, adding them to `implicitTyThings' would mess</span><span>
</span><a name="line-743"></a><span class="hs-comment">-- things up in the renaming/type checking of source programs).</span><span>
</span><a name="line-744"></a><span class="hs-comment">-----------------------------------------------------</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-identifier">addDeclsToPTE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PackageTypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PackageTypeEnv</span><span>
</span><a name="line-747"></a><a name="addDeclsToPTE"><a href="LoadIface.html#addDeclsToPTE"><span class="hs-identifier">addDeclsToPTE</span></a></a><span> </span><a name="local-6989586621681662217"><a href="#local-6989586621681662217"><span class="hs-identifier">pte</span></a></a><span> </span><a name="local-6989586621681662218"><a href="#local-6989586621681662218"><span class="hs-identifier">things</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><a href="#local-6989586621681662217"><span class="hs-identifier hs-var">pte</span></a><span> </span><a href="#local-6989586621681662218"><span class="hs-identifier hs-var">things</span></a><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span class="hs-identifier">loadDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-750"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-751"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-752"></a><a name="loadDecls"><a href="LoadIface.html#loadDecls"><span class="hs-identifier">loadDecls</span></a></a><span> </span><a name="local-6989586621681662219"><a href="#local-6989586621681662219"><span class="hs-identifier">ignore_prags</span></a></a><span> </span><a name="local-6989586621681662220"><a href="#local-6989586621681662220"><span class="hs-identifier">ver_decls</span></a></a><span>
</span><a name="line-753"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662221"><a href="#local-6989586621681662221"><span class="hs-identifier">thingss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadDecl"><span class="hs-identifier hs-var">loadDecl</span></a><span> </span><a href="#local-6989586621681662219"><span class="hs-identifier hs-var">ignore_prags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662220"><span class="hs-identifier hs-var">ver_decls</span></a><span>
</span><a name="line-754"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621681662221"><span class="hs-identifier hs-var">thingss</span></a><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-756"></a><span>
</span><a name="line-757"></a><span class="hs-identifier">loadDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                    </span><span class="hs-comment">-- Don't load pragmas into the decl pool</span><span>
</span><a name="line-758"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- The list can be poked eagerly, but the</span><span>
</span><a name="line-760"></a><span>                                    </span><span class="hs-comment">-- TyThings are forkM'd thunks</span><span>
</span><a name="line-761"></a><a name="loadDecl"><a href="LoadIface.html#loadDecl"><span class="hs-identifier">loadDecl</span></a></a><span> </span><a name="local-6989586621681662222"><a href="#local-6989586621681662222"><span class="hs-identifier">ignore_prags</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681662223"><a href="#local-6989586621681662223"><span class="hs-identifier">_version</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662224"><a href="#local-6989586621681662224"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Populate the name cache with final versions of all</span><span>
</span><a name="line-763"></a><span>                </span><span class="hs-comment">-- the names associated with the decl</span><span>
</span><a name="line-764"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662226"><a href="#local-6989586621681662226"><span class="hs-identifier">main_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ifName</span><span> </span><a href="#local-6989586621681662224"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span>        </span><span class="hs-comment">-- Typecheck the thing, lazily</span><span>
</span><a name="line-767"></a><span>        </span><span class="hs-comment">-- NB. Firstly, the laziness is there in case we never need the</span><span>
</span><a name="line-768"></a><span>        </span><span class="hs-comment">-- declaration (in one-shot mode), and secondly it is there so that</span><span>
</span><a name="line-769"></a><span>        </span><span class="hs-comment">-- we don't look up the occurrence of a name before calling mk_new_bndr</span><span>
</span><a name="line-770"></a><span>        </span><span class="hs-comment">-- on the binder.  This is important because we must get the right name</span><span>
</span><a name="line-771"></a><span>        </span><span class="hs-comment">-- which includes its nameParent.</span><span>
</span><a name="line-772"></a><span>
</span><a name="line-773"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662227"><a href="#local-6989586621681662227"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#forkM"><span class="hs-identifier hs-var">forkM</span></a><span> </span><a href="#local-6989586621681662225"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="LoadIface.html#bumpDeclStats"><span class="hs-identifier hs-var">bumpDeclStats</span></a><span> </span><a href="#local-6989586621681662226"><span class="hs-identifier hs-var">main_name</span></a><span>
</span><a name="line-774"></a><span>                                  </span><span class="hs-special">;</span><span> </span><a href="TcIface.html#tcIfaceDecl"><span class="hs-identifier hs-var">tcIfaceDecl</span></a><span> </span><a href="#local-6989586621681662222"><span class="hs-identifier hs-var">ignore_prags</span></a><span> </span><a href="#local-6989586621681662224"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span>        </span><span class="hs-comment">-- Populate the type environment with the implicitTyThings too.</span><span>
</span><a name="line-777"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-778"></a><span>        </span><span class="hs-comment">-- Note [Tricky iface loop]</span><span>
</span><a name="line-779"></a><span>        </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-780"></a><span>        </span><span class="hs-comment">-- Summary: The delicate point here is that 'mini-env' must be</span><span>
</span><a name="line-781"></a><span>        </span><span class="hs-comment">-- buildable from 'thing' without demanding any of the things</span><span>
</span><a name="line-782"></a><span>        </span><span class="hs-comment">-- 'forkM'd by tcIfaceDecl.</span><span>
</span><a name="line-783"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-784"></a><span>        </span><span class="hs-comment">-- In more detail: Consider the example</span><span>
</span><a name="line-785"></a><span>        </span><span class="hs-comment">--      data T a = MkT { x :: T a }</span><span>
</span><a name="line-786"></a><span>        </span><span class="hs-comment">-- The implicitTyThings of T are:  [ &lt;datacon MkT&gt;, &lt;selector x&gt;]</span><span>
</span><a name="line-787"></a><span>        </span><span class="hs-comment">-- (plus their workers, wrappers, coercions etc etc)</span><span>
</span><a name="line-788"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-789"></a><span>        </span><span class="hs-comment">-- We want to return an environment</span><span>
</span><a name="line-790"></a><span>        </span><span class="hs-comment">--      [ &quot;MkT&quot; -&gt; &lt;datacon MkT&gt;, &quot;x&quot; -&gt; &lt;selector x&gt;, ... ]</span><span>
</span><a name="line-791"></a><span>        </span><span class="hs-comment">-- (where the &quot;MkT&quot; is the *Name* associated with MkT, etc.)</span><span>
</span><a name="line-792"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-793"></a><span>        </span><span class="hs-comment">-- We do this by mapping the implicit_names to the associated</span><span>
</span><a name="line-794"></a><span>        </span><span class="hs-comment">-- TyThings.  By the invariant on ifaceDeclImplicitBndrs and</span><span>
</span><a name="line-795"></a><span>        </span><span class="hs-comment">-- implicitTyThings, we can use getOccName on the implicit</span><span>
</span><a name="line-796"></a><span>        </span><span class="hs-comment">-- TyThings to make this association: each Name's OccName should</span><span>
</span><a name="line-797"></a><span>        </span><span class="hs-comment">-- be the OccName of exactly one implicitTyThing.  So the key is</span><span>
</span><a name="line-798"></a><span>        </span><span class="hs-comment">-- to define a &quot;mini-env&quot;</span><span>
</span><a name="line-799"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-800"></a><span>        </span><span class="hs-comment">-- [ 'MkT' -&gt; &lt;datacon MkT&gt;, 'x' -&gt; &lt;selector x&gt;, ... ]</span><span>
</span><a name="line-801"></a><span>        </span><span class="hs-comment">-- where the 'MkT' here is the *OccName* associated with MkT.</span><span>
</span><a name="line-802"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-803"></a><span>        </span><span class="hs-comment">-- However, there is a subtlety: due to how type checking needs</span><span>
</span><a name="line-804"></a><span>        </span><span class="hs-comment">-- to be staged, we can't poke on the forkM'd thunks inside the</span><span>
</span><a name="line-805"></a><span>        </span><span class="hs-comment">-- implicitTyThings while building this mini-env.</span><span>
</span><a name="line-806"></a><span>        </span><span class="hs-comment">-- If we poke these thunks too early, two problems could happen:</span><span>
</span><a name="line-807"></a><span>        </span><span class="hs-comment">--    (1) When processing mutually recursive modules across</span><span>
</span><a name="line-808"></a><span>        </span><span class="hs-comment">--        hs-boot boundaries, poking too early will do the</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-comment">--        type-checking before the recursive knot has been tied,</span><span>
</span><a name="line-810"></a><span>        </span><span class="hs-comment">--        so things will be type-checked in the wrong</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-comment">--        environment, and necessary variables won't be in</span><span>
</span><a name="line-812"></a><span>        </span><span class="hs-comment">--        scope.</span><span>
</span><a name="line-813"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-814"></a><span>        </span><span class="hs-comment">--    (2) Looking up one OccName in the mini_env will cause</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-comment">--        others to be looked up, which might cause that</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-comment">--        original one to be looked up again, and hence loop.</span><span>
</span><a name="line-817"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-818"></a><span>        </span><span class="hs-comment">-- The code below works because of the following invariant:</span><span>
</span><a name="line-819"></a><span>        </span><span class="hs-comment">-- getOccName on a TyThing does not force the suspended type</span><span>
</span><a name="line-820"></a><span>        </span><span class="hs-comment">-- checks in order to extract the name. For example, we don't</span><span>
</span><a name="line-821"></a><span>        </span><span class="hs-comment">-- poke on the &quot;T a&quot; type of &lt;selector x&gt; on the way to</span><span>
</span><a name="line-822"></a><span>        </span><span class="hs-comment">-- extracting &lt;selector x&gt;'s OccName. Of course, there is no</span><span>
</span><a name="line-823"></a><span>        </span><span class="hs-comment">-- reason in principle why getting the OccName should force the</span><span>
</span><a name="line-824"></a><span>        </span><span class="hs-comment">-- thunks, but this means we need to be careful in</span><span>
</span><a name="line-825"></a><span>        </span><span class="hs-comment">-- implicitTyThings and its helper functions.</span><span>
</span><a name="line-826"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-827"></a><span>        </span><span class="hs-comment">-- All a bit too finely-balanced for my liking.</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>        </span><span class="hs-comment">-- This mini-env and lookup function mediates between the</span><span>
</span><a name="line-830"></a><span>        </span><span class="hs-comment">--'Name's n and the map from 'OccName's to the implicit TyThings</span><span>
</span><a name="line-831"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662228"><a href="#local-6989586621681662228"><span class="hs-identifier">mini_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkOccEnv</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621681662230"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662230"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681662230"><a href="#local-6989586621681662230"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">implicitTyThings</span><span> </span><a href="#local-6989586621681662227"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">]</span><span>
</span><a name="line-832"></a><span>              </span><a name="local-6989586621681662229"><a href="#local-6989586621681662229"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621681662231"><a href="#local-6989586621681662231"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621681662228"><span class="hs-identifier hs-var">mini_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621681662231"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-833"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662232"><a href="#local-6989586621681662232"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681662232"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-834"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-835"></a><span>                             </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;loadDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662226"><span class="hs-identifier hs-var">main_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662231"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662224"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662233"><a href="#local-6989586621681662233"><span class="hs-identifier">implicit_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="IfaceEnv.html#lookupIfaceTop"><span class="hs-identifier hs-var">lookupIfaceTop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ifaceDeclImplicitBndrs</span><span> </span><a href="#local-6989586621681662224"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-comment">--         ; traceIf (text &quot;Loading decl for &quot; &lt;&gt; ppr main_name $$ ppr implicit_names)</span><span>
</span><a name="line-840"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662226"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662227"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-841"></a><span>                      </span><span class="hs-comment">-- uses the invariant that implicit_names and</span><span>
</span><a name="line-842"></a><span>                      </span><span class="hs-comment">-- implicitTyThings are bijective</span><span>
</span><a name="line-843"></a><span>                      </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681662234"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662229"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621681662234"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681662234"><a href="#local-6989586621681662234"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681662233"><span class="hs-identifier hs-var">implicit_names</span></a><span class="hs-special">]</span><span>
</span><a name="line-844"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-845"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-846"></a><span>    </span><a name="local-6989586621681662225"><a href="#local-6989586621681662225"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Declaration for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ifName</span><span> </span><a href="#local-6989586621681662224"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-847"></a><span>
</span><a name="line-848"></a><span class="hs-identifier">bumpDeclStats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Record that one more declaration has actually been used</span><span>
</span><a name="line-849"></a><a name="bumpDeclStats"><a href="LoadIface.html#bumpDeclStats"><span class="hs-identifier">bumpDeclStats</span></a></a><span> </span><a name="local-6989586621681662235"><a href="#local-6989586621681662235"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Loading decl for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662235"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681662236"><a href="#local-6989586621681662236"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662237"><a href="#local-6989586621681662237"><span class="hs-identifier">stats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_stats</span><span> </span><a href="#local-6989586621681662236"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-852"></a><span>                              </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621681662236"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eps_stats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681662237"><span class="hs-identifier hs-var">stats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">n_decls_out</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">n_decls_out</span><span> </span><a href="#local-6989586621681662237"><span class="hs-identifier hs-var">stats</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Reading an interface file}
*                                                      *
*********************************************************

Note [Home module load error]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the sought-for interface is in the current package (as determined
by -package-name flag) then it jolly well should already be in the HPT
because we process home-package modules in dependency order.  (Except
in one-shot mode; see notes with hsc_HPT decl in HscTypes).

It is possible (though hard) to get this error through user behaviour.
  * Suppose package P (modules P1, P2) depends on package Q (modules Q1,
    Q2, with Q2 importing Q1)
  * We compile both packages.
  * Now we edit package Q so that it somehow depends on P
  * Now recompile Q with --make (without recompiling P).
  * Then Q1 imports, say, P1, which in turn depends on Q2. So Q2
    is a home-package module which is not yet in the HPT!  Disaster.

This actually happened with P=base, Q=ghc-prim, via the AMP warnings.
See Trac #8320.
-}</span><span>
</span><a name="line-881"></a><span>
</span><a name="line-882"></a><span class="hs-identifier">findAndReadIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-883"></a><span>                 </span><span class="hs-comment">-- The unique identifier of the on-disk module we're</span><span>
</span><a name="line-884"></a><span>                 </span><span class="hs-comment">-- looking for</span><span>
</span><a name="line-885"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InstalledModule</span><span>
</span><a name="line-886"></a><span>                 </span><span class="hs-comment">-- The *actual* module we're looking for.  We use</span><span>
</span><a name="line-887"></a><span>                 </span><span class="hs-comment">-- this to check the consistency of the requirements</span><span>
</span><a name="line-888"></a><span>                 </span><span class="hs-comment">-- of the module we read out.</span><span>
</span><a name="line-889"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-890"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span>     </span><span class="hs-comment">-- True  &lt;=&gt; Look for a .hi-boot file</span><span>
</span><a name="line-891"></a><span>                                        </span><span class="hs-comment">-- False &lt;=&gt; Look for .hi file</span><span>
</span><a name="line-892"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681662042"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681662043"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-893"></a><span>        </span><span class="hs-comment">-- Nothing &lt;=&gt; file not found, or unreadable, or illegible</span><span>
</span><a name="line-894"></a><span>        </span><span class="hs-comment">-- Just x  &lt;=&gt; successfully found and parsed</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span>        </span><span class="hs-comment">-- It *doesn't* add an error to the monad, because</span><span>
</span><a name="line-897"></a><span>        </span><span class="hs-comment">-- sometimes it's ok to fail... see notes with loadInterface</span><span>
</span><a name="line-898"></a><a name="findAndReadIface"><a href="LoadIface.html#findAndReadIface"><span class="hs-identifier">findAndReadIface</span></a></a><span> </span><a name="local-6989586621681662238"><a href="#local-6989586621681662238"><span class="hs-identifier">doc_str</span></a></a><span> </span><a name="local-6989586621681662239"><a href="#local-6989586621681662239"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681662240"><a href="#local-6989586621681662240"><span class="hs-identifier">wanted_mod_with_insts</span></a></a><span> </span><a name="local-6989586621681662241"><a href="#local-6989586621681662241"><span class="hs-identifier">hi_boot_file</span></a></a><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Reading&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-900"></a><span>                           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681662241"><span class="hs-identifier hs-var">hi_boot_file</span></a><span>
</span><a name="line-901"></a><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[boot]&quot;</span><span>
</span><a name="line-902"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">,</span><span>
</span><a name="line-903"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;interface for&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-904"></a><span>                           </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662239"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">semi</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-905"></a><span>                     </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;reason:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681662238"><span class="hs-identifier hs-var">doc_str</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>
</span><a name="line-907"></a><span>       </span><span class="hs-comment">-- Check for GHC.Prim, and return its static interface</span><span>
</span><a name="line-908"></a><span>       </span><span class="hs-comment">-- TODO: make this check a function</span><span>
</span><a name="line-909"></a><span>       </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681662239"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">installedModuleEq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">gHC_PRIM</span><span>
</span><a name="line-910"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-911"></a><span>               </span><a name="local-6989586621681662260"><a href="#local-6989586621681662260"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHooked</span><span> </span><span class="hs-identifier">ghcPrimIfaceHook</span><span> </span><a href="LoadIface.html#ghcPrimIface"><span class="hs-identifier hs-var">ghcPrimIface</span></a><span>
</span><a name="line-912"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662260"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span>
</span><a name="line-913"></a><span>                                   </span><span class="hs-string">&quot;&lt;built in interface for GHC.Prim&gt;&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-914"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-915"></a><span>               </span><a name="local-6989586621681662261"><a href="#local-6989586621681662261"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-916"></a><span>               </span><span class="hs-comment">-- Look for the file</span><span>
</span><a name="line-917"></a><span>               </span><a name="local-6989586621681662262"><a href="#local-6989586621681662262"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-918"></a><span>               </span><a name="local-6989586621681662263"><a href="#local-6989586621681662263"><span class="hs-identifier">mb_found</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="Finder.html#findExactModule"><span class="hs-identifier hs-var">findExactModule</span></a><span> </span><a href="#local-6989586621681662262"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681662239"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>               </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662263"><span class="hs-identifier hs-var">mb_found</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-920"></a><span>                   </span><span class="hs-identifier hs-var">InstalledFound</span><span> </span><a name="local-6989586621681662264"><a href="#local-6989586621681662264"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681662265"><a href="#local-6989586621681662265"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-921"></a><span>                       </span><span class="hs-comment">-- Found file, so read it</span><span>
</span><a name="line-922"></a><span>                       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662266"><a href="#local-6989586621681662266"><span class="hs-identifier">file_path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addBootSuffix_maybe</span><span> </span><a href="#local-6989586621681662241"><span class="hs-identifier hs-var">hi_boot_file</span></a><span>
</span><a name="line-923"></a><span>                                                           </span><span class="hs-special">(</span><span class="hs-identifier">ml_hi_file</span><span> </span><a href="#local-6989586621681662264"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span>                       </span><span class="hs-comment">-- See Note [Home module load error]</span><span>
</span><a name="line-926"></a><span>                       </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">installedModuleUnitId</span><span> </span><a href="#local-6989586621681662265"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">installedUnitIdEq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621681662261"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-927"></a><span>                          </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isOneShot</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcMode</span><span> </span><a href="#local-6989586621681662261"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#homeModError"><span class="hs-identifier hs-var">homeModError</span></a><span> </span><a href="#local-6989586621681662265"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681662264"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681662267"><a href="#local-6989586621681662267"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681662242"><span class="hs-identifier hs-var">read_file</span></a><span> </span><a href="#local-6989586621681662266"><span class="hs-identifier hs-var">file_path</span></a><span>
</span><a name="line-930"></a><span>                                   </span><a href="#local-6989586621681662243"><span class="hs-identifier hs-var">checkBuildDynamicToo</span></a><span> </span><a href="#local-6989586621681662267"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-931"></a><span>                                   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681662267"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-932"></a><span>                   </span><a name="local-6989586621681662268"><a href="#local-6989586621681662268"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-933"></a><span>                       </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;...not found&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-934"></a><span>                       </span><a name="local-6989586621681662269"><a href="#local-6989586621681662269"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-935"></a><span>                       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><a href="Finder.html#cannotFindInterface"><span class="hs-identifier hs-var">cannotFindInterface</span></a><span> </span><a href="#local-6989586621681662269"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-936"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier">installedModuleName</span><span> </span><a href="#local-6989586621681662239"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662268"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-937"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681662242"><a href="#local-6989586621681662242"><span class="hs-identifier">read_file</span></a></a><span> </span><a name="local-6989586621681662244"><a href="#local-6989586621681662244"><span class="hs-identifier">file_path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-938"></a><span>              </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;readIFace&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681662244"><span class="hs-identifier hs-var">file_path</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>              </span><span class="hs-comment">-- Figure out what is recorded in mi_module.  If this is</span><span>
</span><a name="line-940"></a><span>              </span><span class="hs-comment">-- a fully definite interface, it'll match exactly, but</span><span>
</span><a name="line-941"></a><span>              </span><span class="hs-comment">-- if it's indefinite, the inside will be uninstantiated!</span><span>
</span><a name="line-942"></a><span>              </span><a name="local-6989586621681662245"><a href="#local-6989586621681662245"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-943"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662246"><a href="#local-6989586621681662246"><span class="hs-identifier">wanted_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-944"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitModuleInsts</span><span> </span><a href="#local-6989586621681662240"><span class="hs-identifier hs-var">wanted_mod_with_insts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-945"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681662240"><span class="hs-identifier hs-var">wanted_mod_with_insts</span></a><span>
</span><a name="line-946"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662247"><a href="#local-6989586621681662247"><span class="hs-identifier">indef_mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-947"></a><span>                          </span><span class="hs-identifier hs-var">indefModuleToModule</span><span> </span><a href="#local-6989586621681662245"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-948"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">generalizeIndefModule</span><span> </span><a href="#local-6989586621681662247"><span class="hs-identifier hs-var">indef_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-949"></a><span>              </span><a name="local-6989586621681662248"><a href="#local-6989586621681662248"><span class="hs-identifier">read_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#readIface"><span class="hs-identifier hs-var">readIface</span></a><span> </span><a href="#local-6989586621681662246"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><a href="#local-6989586621681662244"><span class="hs-identifier hs-var">file_path</span></a><span>
</span><a name="line-950"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662248"><span class="hs-identifier hs-var">read_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-951"></a><span>                </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662249"><a href="#local-6989586621681662249"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#badIfaceFile"><span class="hs-identifier hs-var">badIfaceFile</span></a><span> </span><a href="#local-6989586621681662244"><span class="hs-identifier hs-var">file_path</span></a><span> </span><a href="#local-6989586621681662249"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-952"></a><span>                </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681662250"><a href="#local-6989586621681662250"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662250"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662244"><span class="hs-identifier hs-var">file_path</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>                            </span><span class="hs-comment">-- Don't forget to fill in the package name...</span><span>
</span><a name="line-954"></a><span>          </span><a name="local-6989586621681662243"><a href="#local-6989586621681662243"><span class="hs-identifier">checkBuildDynamicToo</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662251"><a href="#local-6989586621681662251"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662252"><a href="#local-6989586621681662252"><span class="hs-identifier">filePath</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-955"></a><span>              </span><a name="local-6989586621681662253"><a href="#local-6989586621681662253"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-956"></a><span>              </span><span class="hs-comment">-- Indefinite interfaces are ALWAYS non-dynamic, and</span><span>
</span><a name="line-957"></a><span>              </span><span class="hs-comment">-- that's OK.</span><span>
</span><a name="line-958"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662254"><a href="#local-6989586621681662254"><span class="hs-identifier">is_definite_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleIsDefinite</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662251"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>              </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681662254"><span class="hs-identifier hs-var">is_definite_iface</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-960"></a><span>                </span><span class="hs-identifier hs-var">whenGeneratingDynamicToo</span><span> </span><a href="#local-6989586621681662253"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#withDoDynamicToo"><span class="hs-identifier hs-var">withDoDynamicToo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-961"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662255"><a href="#local-6989586621681662255"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">canGenerateDynamicToo</span><span> </span><a href="#local-6989586621681662253"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-962"></a><span>                      </span><a name="local-6989586621681662256"><a href="#local-6989586621681662256"><span class="hs-identifier">dynFilePath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addBootSuffix_maybe</span><span> </span><a href="#local-6989586621681662241"><span class="hs-identifier hs-var">hi_boot_file</span></a><span>
</span><a name="line-963"></a><span>                                  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">replaceExtension</span><span> </span><a href="#local-6989586621681662252"><span class="hs-identifier hs-var">filePath</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dynHiSuf</span><span> </span><a href="#local-6989586621681662253"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>                  </span><a name="local-6989586621681662257"><a href="#local-6989586621681662257"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681662242"><span class="hs-identifier hs-var">read_file</span></a><span> </span><a href="#local-6989586621681662256"><span class="hs-identifier hs-var">dynFilePath</span></a><span>
</span><a name="line-965"></a><span>                  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662257"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-966"></a><span>                      </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662258"><a href="#local-6989586621681662258"><span class="hs-identifier">dynIface</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-967"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">mi_mod_hash</span><span> </span><a href="#local-6989586621681662251"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">mi_mod_hash</span><span> </span><a href="#local-6989586621681662258"><span class="hs-identifier hs-var">dynIface</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-968"></a><span>                          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-970"></a><span>                          </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Dynamic hash doesn't match&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>                             </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621681662255"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-972"></a><span>                      </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681662259"><a href="#local-6989586621681662259"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-973"></a><span>                          </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Failed to load dynamic interface file:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621681662259"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>                             </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621681662255"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-975"></a><span>          </span><span class="hs-identifier">checkBuildDynamicToo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-comment">-- @readIface@ tries just the one file.</span><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><span class="hs-identifier">readIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-980"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681662040"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681662041"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>        </span><span class="hs-comment">-- Failed err    &lt;=&gt; file not found, or unreadable, or illegible</span><span>
</span><a name="line-982"></a><span>        </span><span class="hs-comment">-- Succeeded iface &lt;=&gt; successfully found and parsed</span><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><a name="readIface"><a href="LoadIface.html#readIface"><span class="hs-identifier">readIface</span></a></a><span> </span><a name="local-6989586621681662270"><a href="#local-6989586621681662270"><span class="hs-identifier">wanted_mod</span></a></a><span> </span><a name="local-6989586621681662271"><a href="#local-6989586621681662271"><span class="hs-identifier">file_path</span></a></a><span>
</span><a name="line-985"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681662272"><a href="#local-6989586621681662272"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryMostM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-986"></a><span>                 </span><a href="BinIface.html#readBinIface"><span class="hs-identifier hs-var">readBinIface</span></a><span> </span><a href="BinIface.html#CheckHiWay"><span class="hs-identifier hs-var">CheckHiWay</span></a><span> </span><a href="BinIface.html#QuietBinIFaceReading"><span class="hs-identifier hs-var">QuietBinIFaceReading</span></a><span> </span><a href="#local-6989586621681662271"><span class="hs-identifier hs-var">file_path</span></a><span>
</span><a name="line-987"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681662273"><a href="#local-6989586621681662273"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-988"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662272"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-989"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681662274"><a href="#local-6989586621681662274"><span class="hs-identifier">iface</span></a></a><span>
</span><a name="line-990"></a><span>                </span><span class="hs-comment">-- NB: This check is NOT just a sanity check, it is</span><span>
</span><a name="line-991"></a><span>                </span><span class="hs-comment">-- critical for correctness of recompilation checking</span><span>
</span><a name="line-992"></a><span>                </span><span class="hs-comment">-- (it lets us tell when -this-unit-id has changed.)</span><span>
</span><a name="line-993"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681662270"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681662275"><span class="hs-identifier hs-var">actual_mod</span></a><span>
</span><a name="line-994"></a><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681662274"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621681662276"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-996"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-997"></a><span>                  </span><a name="local-6989586621681662275"><a href="#local-6989586621681662275"><span class="hs-identifier">actual_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662274"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-998"></a><span>                  </span><a name="local-6989586621681662276"><a href="#local-6989586621681662276"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#hiModuleNameMismatchWarn"><span class="hs-identifier hs-var">hiModuleNameMismatchWarn</span></a><span> </span><a href="#local-6989586621681662273"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662270"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><a href="#local-6989586621681662275"><span class="hs-identifier hs-var">actual_mod</span></a><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681662277"><a href="#local-6989586621681662277"><span class="hs-identifier">exn</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showException</span><span> </span><a href="#local-6989586621681662277"><span class="hs-identifier hs-var">exn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
        Wired-in interface for GHC.Prim
*                                                       *
*********************************************************
-}</span><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-identifier">initExternalPackageState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span>
</span><a name="line-1012"></a><a name="initExternalPackageState"><a href="LoadIface.html#initExternalPackageState"><span class="hs-identifier">initExternalPackageState</span></a></a><span>
</span><a name="line-1013"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EPS</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1014"></a><span>      </span><span class="hs-identifier">eps_is_boot</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span class="hs-special">,</span><span>
</span><a name="line-1015"></a><span>      </span><span class="hs-identifier">eps_PIT</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyPackageIfaceTable</span><span class="hs-special">,</span><span>
</span><a name="line-1016"></a><span>      </span><span class="hs-identifier">eps_free_holes</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyInstalledModuleEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1017"></a><span>      </span><span class="hs-identifier">eps_PTE</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTypeEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1018"></a><span>      </span><span class="hs-identifier">eps_inst_env</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyInstEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1019"></a><span>      </span><span class="hs-identifier">eps_fam_inst_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFamInstEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1020"></a><span>      </span><span class="hs-identifier">eps_rule_base</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRuleBase</span><span> </span><span class="hs-identifier hs-var">builtinRules</span><span class="hs-special">,</span><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-comment">-- Initialise the EPS rule pool with the built-in rules</span><span>
</span><a name="line-1022"></a><span>      </span><span class="hs-identifier">eps_mod_fam_inst_env</span><span>
</span><a name="line-1023"></a><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyModuleEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1024"></a><span>      </span><span class="hs-identifier">eps_complete_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span class="hs-special">,</span><span>
</span><a name="line-1025"></a><span>      </span><span class="hs-identifier">eps_ann_env</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyAnnEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1026"></a><span>      </span><span class="hs-identifier">eps_stats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EpsStats</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">n_ifaces_in</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n_decls_in</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n_decls_out</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1027"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n_insts_in</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n_insts_out</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1028"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n_rules_in</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-identifier hs-var">builtinRules</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">n_rules_out</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1029"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
        Wired-in interface for GHC.Prim
*                                                       *
*********************************************************
-}</span><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><span class="hs-identifier">ghcPrimIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-1040"></a><a name="ghcPrimIface"><a href="LoadIface.html#ghcPrimIface"><span class="hs-identifier">ghcPrimIface</span></a></a><span>
</span><a name="line-1041"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyModIface</span><span> </span><span class="hs-identifier hs-var">gHC_PRIM</span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1042"></a><span>        </span><span class="hs-identifier">mi_exports</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="PrelInfo.html#ghcPrimExports"><span class="hs-identifier hs-var">ghcPrimExports</span></a><span class="hs-special">,</span><span>
</span><a name="line-1043"></a><span>        </span><span class="hs-identifier">mi_decls</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1044"></a><span>        </span><span class="hs-identifier">mi_fixities</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681662307"><span class="hs-identifier hs-var">fixities</span></a><span class="hs-special">,</span><span>
</span><a name="line-1045"></a><span>        </span><span class="hs-identifier">mi_fix_fn</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIfaceFixCache</span><span> </span><a href="#local-6989586621681662307"><span class="hs-identifier hs-var">fixities</span></a><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1047"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1048"></a><span>    </span><span class="hs-comment">-- The fixities listed here for @`seq`@ or @-&gt;@ should match</span><span>
</span><a name="line-1049"></a><span>    </span><span class="hs-comment">-- those in primops.txt.pp (from which Haddock docs are generated).</span><span>
</span><a name="line-1050"></a><span>    </span><a name="local-6989586621681662307"><a href="#local-6989586621681662307"><span class="hs-identifier">fixities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><span class="hs-identifier hs-var">seqId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">InfixR</span><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>             </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occName</span><span> </span><span class="hs-identifier hs-var">funTyConName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">funTyFixity</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- trac #10145</span><span>
</span><a name="line-1052"></a><span>             </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621681662308"><span class="hs-identifier hs-var">mkFixity</span></a><span> </span><span class="hs-identifier hs-var">allThePrimOps</span><span>
</span><a name="line-1053"></a><span>    </span><a name="local-6989586621681662308"><a href="#local-6989586621681662308"><span class="hs-identifier">mkFixity</span></a></a><span> </span><a name="local-6989586621681662309"><a href="#local-6989586621681662309"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">primOpOcc</span><span> </span><a href="#local-6989586621681662309"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">primOpFixity</span><span> </span><a href="#local-6989586621681662309"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-1054"></a><span>
</span><a name="line-1055"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Statistics}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-1062"></a><span>
</span><a name="line-1063"></a><span class="hs-identifier">ifaceStats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1064"></a><a name="ifaceStats"><a href="LoadIface.html#ifaceStats"><span class="hs-identifier">ifaceStats</span></a></a><span> </span><a name="local-6989586621681662310"><a href="#local-6989586621681662310"><span class="hs-identifier">eps</span></a></a><span>
</span><a name="line-1065"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Renamer stats: &quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681662312"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">]</span><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1067"></a><span>    </span><a name="local-6989586621681662311"><a href="#local-6989586621681662311"><span class="hs-identifier">stats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_stats</span><span> </span><a href="#local-6989586621681662310"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-1068"></a><span>    </span><a name="local-6989586621681662312"><a href="#local-6989586621681662312"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-1069"></a><span>        </span><span class="hs-special">[</span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_ifaces_in</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;interfaces read&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1070"></a><span>         </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_decls_out</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type/class/variable imported, out of&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1071"></a><span>                </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_decls_in</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;read&quot;</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1072"></a><span>         </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_insts_out</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;instance decls imported, out of&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1073"></a><span>                </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_insts_in</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;read&quot;</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1074"></a><span>         </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_rules_out</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;rule decls imported, out of&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1075"></a><span>                </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">n_rules_in</span><span> </span><a href="#local-6989586621681662311"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;read&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1076"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Printing interfaces
*                                                                      *
************************************************************************

Note [Name qualification with --show-iface]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In order to disambiguate between identifiers from different modules, we qualify
all names that don't originate in the current module. In order to keep visual
noise as low as possible, we keep local names unqualified.

For some background on this choice see trac #15269.
-}</span><span>
</span><a name="line-1094"></a><span>
</span><a name="line-1095"></a><span class="hs-comment">-- | Read binary interface, and print it out</span><span>
</span><a name="line-1096"></a><span class="hs-identifier">showIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><a name="showIface"><a href="LoadIface.html#showIface"><span class="hs-identifier">showIface</span></a></a><span> </span><a name="local-6989586621681662313"><a href="#local-6989586621681662313"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681662314"><a href="#local-6989586621681662314"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1098"></a><span>   </span><span class="hs-comment">-- skip the hi way check; we don't want to worry about profiled vs.</span><span>
</span><a name="line-1099"></a><span>   </span><span class="hs-comment">-- non-profiled interfaces, for example.</span><span>
</span><a name="line-1100"></a><span>   </span><a name="local-6989586621681662315"><a href="#local-6989586621681662315"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier hs-var">initTcRnIf</span></a><span> </span><span class="hs-char">'s'</span><span> </span><a href="#local-6989586621681662313"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1101"></a><span>       </span><a href="BinIface.html#readBinIface"><span class="hs-identifier hs-var">readBinIface</span></a><span> </span><a href="BinIface.html#IgnoreHiWay"><span class="hs-identifier hs-var">IgnoreHiWay</span></a><span> </span><a href="BinIface.html#TraceBinIFaceReading"><span class="hs-identifier hs-var">TraceBinIFaceReading</span></a><span> </span><a href="#local-6989586621681662314"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-1102"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681662316"><a href="#local-6989586621681662316"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681662313"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1103"></a><span>       </span><span class="hs-comment">-- See Note [Name qualification with --show-iface]</span><span>
</span><a name="line-1104"></a><span>       </span><a name="local-6989586621681662317"><a href="#local-6989586621681662317"><span class="hs-identifier">qualifyImportedNames</span></a></a><span> </span><a name="local-6989586621681662319"><a href="#local-6989586621681662319"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1105"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681662319"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662315"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NameUnqual</span><span>
</span><a name="line-1106"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NameNotInScope1</span><span>
</span><a name="line-1107"></a><span>       </span><a name="local-6989586621681662318"><a href="#local-6989586621681662318"><span class="hs-identifier">print_unqual</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QueryQualify</span><span> </span><a href="#local-6989586621681662317"><span class="hs-identifier hs-var">qualifyImportedNames</span></a><span>
</span><a name="line-1108"></a><span>                                   </span><span class="hs-identifier hs-var">neverQualifyModules</span><span>
</span><a name="line-1109"></a><span>                                   </span><span class="hs-identifier hs-var">neverQualifyPackages</span><span>
</span><a name="line-1110"></a><span>   </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621681662316"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">SevDump</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-1111"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkDumpStyle</span><span> </span><a href="#local-6989586621681662316"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681662318"><span class="hs-identifier hs-var">print_unqual</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#pprModIface"><span class="hs-identifier hs-var">pprModIface</span></a><span> </span><a href="#local-6989586621681662315"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>
</span><a name="line-1113"></a><span class="hs-comment">-- Show a ModIface but don't display details; suitable for ModIfaces stored in</span><span>
</span><a name="line-1114"></a><span class="hs-comment">-- the EPT.</span><span>
</span><a name="line-1115"></a><span class="hs-identifier">pprModIfaceSimple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1116"></a><a name="pprModIfaceSimple"><a href="LoadIface.html#pprModIfaceSimple"><span class="hs-identifier">pprModIfaceSimple</span></a></a><span> </span><a name="local-6989586621681662320"><a href="#local-6989586621681662320"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662320"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="LoadIface.html#pprDeps"><span class="hs-identifier hs-var">pprDeps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621681662320"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="LoadIface.html#pprExport"><span class="hs-identifier hs-var">pprExport</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exports</span><span> </span><a href="#local-6989586621681662320"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span class="hs-identifier">pprModIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1119"></a><span class="hs-comment">-- Show a ModIface</span><span>
</span><a name="line-1120"></a><a name="pprModIface"><a href="LoadIface.html#pprModIface"><span class="hs-identifier">pprModIface</span></a></a><span> </span><a name="local-6989586621681662321"><a href="#local-6989586621681662321"><span class="hs-identifier">iface</span></a></a><span>
</span><a name="line-1121"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;interface&quot;</span><span>
</span><a name="line-1122"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681662322"><span class="hs-identifier hs-var">pp_hsc_src</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_hsc_src</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">mi_orphan</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[orphan module]&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">mi_finsts</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[family instance module]&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-1125"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">mi_hpc</span><span>    </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[hpc]&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-1126"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">integer</span><span> </span><span class="hs-identifier hs-var">hiVersion</span><span>
</span><a name="line-1127"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;interface hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_iface_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1128"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ABI hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_mod_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;export-list hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exp_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1130"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;orphan hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_orphan_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1131"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;flag hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_flag_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1132"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;opt_hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_opt_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1133"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hpc_hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_hpc_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;plugin_hash:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_plugin_hash</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;sig of:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_sig_of</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1136"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;used TH splices:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_used_th</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1137"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;where&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1138"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;exports:&quot;</span><span>
</span><a name="line-1139"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="LoadIface.html#pprExport"><span class="hs-identifier hs-var">pprExport</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exports</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1140"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="LoadIface.html#pprDeps"><span class="hs-identifier hs-var">pprDeps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1141"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="LoadIface.html#pprUsage"><span class="hs-identifier hs-var">pprUsage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_usages</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1142"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="LoadIface.html#pprIfaceAnnotation"><span class="hs-identifier hs-var">pprIfaceAnnotation</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_anns</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1143"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="LoadIface.html#pprFixities"><span class="hs-identifier hs-var">pprFixities</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_fixities</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1144"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662323"><span class="hs-identifier hs-var">ver</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662324"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662323"><a href="#local-6989586621681662323"><span class="hs-identifier">ver</span></a></a><span class="hs-special">,</span><a name="local-6989586621681662324"><a href="#local-6989586621681662324"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mi_decls</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">]</span><span>
</span><a name="line-1145"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_insts</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1146"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_fam_insts</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1147"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_rules</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_warns</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="LoadIface.html#pprTrustInfo"><span class="hs-identifier hs-var">pprTrustInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_trust</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1150"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="LoadIface.html#pprTrustPkg"><span class="hs-identifier hs-var">pprTrustPkg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_trust_pkg</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1151"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_complete_sigs</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1152"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module header:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_doc_hdr</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;declaration docs:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_decl_docs</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;arg docs:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_arg_docs</span><span> </span><a href="#local-6989586621681662321"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1157"></a><span>    </span><a name="local-6989586621681662322"><a href="#local-6989586621681662322"><span class="hs-identifier">pp_hsc_src</span></a></a><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[boot]&quot;</span><span>
</span><a name="line-1158"></a><span>    </span><span class="hs-identifier">pp_hsc_src</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[hsig]&quot;</span><span>
</span><a name="line-1159"></a><span>    </span><span class="hs-identifier">pp_hsc_src</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1160"></a><span>
</span><a name="line-1161"></a><span class="hs-comment">{-
When printing export lists, we print like this:
        Avail   f               f
        AvailTC C [C, x, y]     C(x,y)
        AvailTC C [x, y]        C!(x,y)         -- Exporting x, y but not C
-}</span><span>
</span><a name="line-1167"></a><span>
</span><a name="line-1168"></a><span class="hs-identifier">pprExport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfaceExport</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1169"></a><a name="pprExport"><a href="LoadIface.html#pprExport"><span class="hs-identifier">pprExport</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Avail</span><span> </span><a name="local-6989586621681662325"><a href="#local-6989586621681662325"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662325"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1170"></a><span class="hs-identifier">pprExport</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1171"></a><span class="hs-identifier">pprExport</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621681662326"><a href="#local-6989586621681662326"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621681662327"><a href="#local-6989586621681662327"><span class="hs-identifier">ns0</span></a></a><span> </span><a name="local-6989586621681662328"><a href="#local-6989586621681662328"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1172"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681662327"><span class="hs-identifier hs-var">ns0</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1173"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621681662332"><a href="#local-6989586621681662332"><span class="hs-identifier">n'</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681662333"><a href="#local-6989586621681662333"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681662326"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621681662332"><span class="hs-identifier hs-var">n'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662326"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621681662329"><span class="hs-identifier hs-var">pp_export</span></a><span> </span><a href="#local-6989586621681662333"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-6989586621681662328"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1174"></a><span>      </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662326"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">vbar</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621681662329"><span class="hs-identifier hs-var">pp_export</span></a><span> </span><a href="#local-6989586621681662327"><span class="hs-identifier hs-var">ns0</span></a><span> </span><a href="#local-6989586621681662328"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1175"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1176"></a><span>    </span><a name="local-6989586621681662329"><a href="#local-6989586621681662329"><span class="hs-identifier">pp_export</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1177"></a><span>    </span><span class="hs-identifier">pp_export</span><span> </span><a name="local-6989586621681662330"><a href="#local-6989586621681662330"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621681662331"><a href="#local-6989586621681662331"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662330"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">flLabel</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681662331"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>
</span><a name="line-1179"></a><span class="hs-identifier">pprUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Usage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1180"></a><a name="pprUsage"><a href="LoadIface.html#pprUsage"><span class="hs-identifier">pprUsage</span></a></a><span> </span><a name="local-6989586621681662334"><a href="#local-6989586621681662334"><span class="hs-identifier">usage</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">UsagePackageModule</span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#pprUsageImport"><span class="hs-identifier hs-var">pprUsageImport</span></a><span> </span><a href="#local-6989586621681662334"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-identifier">usg_mod</span><span>
</span><a name="line-1182"></a><span class="hs-identifier">pprUsage</span><span> </span><a name="local-6989586621681662335"><a href="#local-6989586621681662335"><span class="hs-identifier">usage</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">UsageHomeModule</span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#pprUsageImport"><span class="hs-identifier hs-var">pprUsageImport</span></a><span> </span><a href="#local-6989586621681662335"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-identifier">usg_mod_name</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1184"></a><span>    </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1185"></a><span>        </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681662336"><a href="#local-6989586621681662336"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;exports: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662336"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">usg_exports</span><span> </span><a href="#local-6989586621681662335"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1186"></a><span>        </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662337"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662338"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681662337"><a href="#local-6989586621681662337"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621681662338"><a href="#local-6989586621681662338"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">usg_entities</span><span> </span><a href="#local-6989586621681662335"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1187"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span class="hs-identifier">pprUsage</span><span> </span><a name="local-6989586621681662339"><a href="#local-6989586621681662339"><span class="hs-identifier">usage</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">UsageFile</span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1189"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;addDependentFile&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1190"></a><span>          </span><span class="hs-identifier hs-var">doubleQuotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">usg_file_path</span><span> </span><a href="#local-6989586621681662339"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1191"></a><span>          </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">usg_file_hash</span><span> </span><a href="#local-6989586621681662339"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1192"></a><span class="hs-identifier">pprUsage</span><span> </span><a name="local-6989586621681662340"><a href="#local-6989586621681662340"><span class="hs-identifier">usage</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">UsageMergedRequirement</span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1193"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;merged&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">usg_mod</span><span> </span><a href="#local-6989586621681662340"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">usg_mod_hash</span><span> </span><a href="#local-6989586621681662340"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1194"></a><span>
</span><a name="line-1195"></a><span class="hs-identifier">pprUsageImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621681662039"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Usage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Usage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681662039"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1196"></a><a name="pprUsageImport"><a href="LoadIface.html#pprUsageImport"><span class="hs-identifier">pprUsageImport</span></a></a><span> </span><a name="local-6989586621681662341"><a href="#local-6989586621681662341"><span class="hs-identifier">usage</span></a></a><span> </span><a name="local-6989586621681662342"><a href="#local-6989586621681662342"><span class="hs-identifier">usg_mod'</span></a></a><span>
</span><a name="line-1197"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;import&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-keyword">safe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681662342"><span class="hs-identifier hs-var">usg_mod'</span></a><span> </span><a href="#local-6989586621681662341"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1198"></a><span>                       </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">usg_mod_hash</span><span> </span><a href="#local-6989586621681662341"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1199"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1200"></a><span>        </span><span class="hs-keyword">safe</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">usg_safe</span><span> </span><a href="#local-6989586621681662341"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;safe&quot;</span><span>
</span><a name="line-1201"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; -/ &quot;</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span class="hs-identifier">pprDeps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Dependencies</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1204"></a><a name="pprDeps"><a href="LoadIface.html#pprDeps"><span class="hs-identifier">pprDeps</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Deps</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dep_mods</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681662344"><a href="#local-6989586621681662344"><span class="hs-identifier">mods</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681662345"><a href="#local-6989586621681662345"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681662346"><a href="#local-6989586621681662346"><span class="hs-identifier">orphs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1205"></a><span>                </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681662347"><a href="#local-6989586621681662347"><span class="hs-identifier">finsts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module dependencies:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681662348"><span class="hs-identifier hs-var">ppr_mod</span></a><span> </span><a href="#local-6989586621681662344"><span class="hs-identifier hs-var">mods</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1207"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;package dependencies:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681662349"><span class="hs-identifier hs-var">ppr_pkg</span></a><span> </span><a href="#local-6989586621681662345"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1208"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;orphans:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662346"><span class="hs-identifier hs-var">orphs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1209"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;family instance modules:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662347"><span class="hs-identifier hs-var">finsts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1210"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-1211"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1212"></a><span>    </span><a name="local-6989586621681662348"><a href="#local-6989586621681662348"><span class="hs-identifier">ppr_mod</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681662351"><a href="#local-6989586621681662351"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662352"><a href="#local-6989586621681662352"><span class="hs-identifier">boot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662351"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681662350"><span class="hs-identifier hs-var">ppr_boot</span></a><span> </span><a href="#local-6989586621681662352"><span class="hs-identifier hs-var">boot</span></a><span>
</span><a name="line-1213"></a><span>    </span><a name="local-6989586621681662349"><a href="#local-6989586621681662349"><span class="hs-identifier">ppr_pkg</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681662353"><a href="#local-6989586621681662353"><span class="hs-identifier">pkg</span></a></a><span class="hs-special">,</span><a name="local-6989586621681662354"><a href="#local-6989586621681662354"><span class="hs-identifier">trust_req</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662353"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1214"></a><span>                               </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681662354"><span class="hs-identifier hs-var">trust_req</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;*&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>    </span><a name="local-6989586621681662350"><a href="#local-6989586621681662350"><span class="hs-identifier">ppr_boot</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[boot]&quot;</span><span>
</span><a name="line-1216"></a><span>    </span><span class="hs-identifier">ppr_boot</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span class="hs-identifier">pprFixities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1219"></a><a name="pprFixities"><a href="LoadIface.html#pprFixities"><span class="hs-identifier">pprFixities</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1220"></a><span class="hs-identifier">pprFixities</span><span> </span><a name="local-6989586621681662355"><a href="#local-6989586621681662355"><span class="hs-identifier">fixes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;fixities&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><a href="#local-6989586621681662356"><span class="hs-identifier hs-var">pprFix</span></a><span> </span><a href="#local-6989586621681662355"><span class="hs-identifier hs-var">fixes</span></a><span>
</span><a name="line-1221"></a><span>                  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1222"></a><span>                    </span><a name="local-6989586621681662356"><a href="#local-6989586621681662356"><span class="hs-identifier">pprFix</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681662357"><a href="#local-6989586621681662357"><span class="hs-identifier">occ</span></a></a><span class="hs-special">,</span><a name="local-6989586621681662358"><a href="#local-6989586621681662358"><span class="hs-identifier">fix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662358"><span class="hs-identifier hs-var">fix</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662357"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span class="hs-identifier">pprTrustInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfaceTrustInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1225"></a><a name="pprTrustInfo"><a href="LoadIface.html#pprTrustInfo"><span class="hs-identifier">pprTrustInfo</span></a></a><span> </span><a name="local-6989586621681662359"><a href="#local-6989586621681662359"><span class="hs-identifier">trust</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;trusted:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662359"><span class="hs-identifier hs-var">trust</span></a><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span class="hs-identifier">pprTrustPkg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1228"></a><a name="pprTrustPkg"><a href="LoadIface.html#pprTrustPkg"><span class="hs-identifier">pprTrustPkg</span></a></a><span> </span><a name="local-6989586621681662360"><a href="#local-6989586621681662360"><span class="hs-identifier">tpkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;require own pkg trusted:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662360"><span class="hs-identifier hs-var">tpkg</span></a><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-identifier hs-type">Warnings</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1231"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#pprWarns"><span class="hs-identifier hs-var">pprWarns</span></a><span>
</span><a name="line-1232"></a><span>
</span><a name="line-1233"></a><span class="hs-identifier">pprWarns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Warnings</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1234"></a><a name="pprWarns"><a href="LoadIface.html#pprWarns"><span class="hs-identifier">pprWarns</span></a></a><span> </span><span class="hs-identifier hs-var">NoWarnings</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1235"></a><span class="hs-identifier">pprWarns</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WarnAll</span><span> </span><a name="local-6989586621681662361"><a href="#local-6989586621681662361"><span class="hs-identifier">txt</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warn all&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662361"><span class="hs-identifier hs-var">txt</span></a><span>
</span><a name="line-1236"></a><span class="hs-identifier">pprWarns</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WarnSome</span><span> </span><a name="local-6989586621681662362"><a href="#local-6989586621681662362"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warnings&quot;</span><span>
</span><a name="line-1237"></a><span>                        </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681662363"><span class="hs-identifier hs-var">pprWarning</span></a><span> </span><a href="#local-6989586621681662362"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1238"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681662363"><a href="#local-6989586621681662363"><span class="hs-identifier">pprWarning</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681662364"><a href="#local-6989586621681662364"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681662365"><a href="#local-6989586621681662365"><span class="hs-identifier">txt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662364"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662365"><span class="hs-identifier hs-var">txt</span></a><span>
</span><a name="line-1239"></a><span>
</span><a name="line-1240"></a><span class="hs-identifier">pprIfaceAnnotation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfaceAnnotation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1241"></a><a name="pprIfaceAnnotation"><a href="LoadIface.html#pprIfaceAnnotation"><span class="hs-identifier">pprIfaceAnnotation</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IfaceAnnotation</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifAnnotatedTarget</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681662367"><a href="#local-6989586621681662367"><span class="hs-identifier">target</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifAnnotatedValue</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681662368"><a href="#local-6989586621681662368"><span class="hs-identifier">serialized</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1242"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662367"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;annotated by&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662368"><span class="hs-identifier hs-var">serialized</span></a><span>
</span><a name="line-1243"></a><span>
</span><a name="line-1244"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
\subsection{Errors}
*                                                       *
*********************************************************
-}</span><span>
</span><a name="line-1251"></a><span>
</span><a name="line-1252"></a><span class="hs-identifier">badIfaceFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1253"></a><a name="badIfaceFile"><a href="LoadIface.html#badIfaceFile"><span class="hs-identifier">badIfaceFile</span></a></a><span> </span><a name="local-6989586621681662369"><a href="#local-6989586621681662369"><span class="hs-identifier">file</span></a></a><span> </span><a name="local-6989586621681662370"><a href="#local-6989586621681662370"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-1254"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Bad interface file:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681662369"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">,</span><span>
</span><a name="line-1255"></a><span>          </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621681662370"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">]</span><span>
</span><a name="line-1256"></a><span>
</span><a name="line-1257"></a><span class="hs-identifier">hiModuleNameMismatchWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span>
</span><a name="line-1258"></a><a name="hiModuleNameMismatchWarn"><a href="LoadIface.html#hiModuleNameMismatchWarn"><span class="hs-identifier">hiModuleNameMismatchWarn</span></a></a><span> </span><a name="local-6989586621681662371"><a href="#local-6989586621681662371"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681662372"><a href="#local-6989586621681662372"><span class="hs-identifier">requested_mod</span></a></a><span> </span><a name="local-6989586621681662373"><a href="#local-6989586621681662373"><span class="hs-identifier">read_mod</span></a></a><span>
</span><a name="line-1259"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681662372"><span class="hs-identifier hs-var">requested_mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681662373"><span class="hs-identifier hs-var">read_mod</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1260"></a><span>    </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Interface file contains module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662373"><span class="hs-identifier hs-var">read_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">comma</span><span class="hs-special">,</span><span>
</span><a name="line-1261"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but we were expecting module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662372"><span class="hs-identifier hs-var">requested_mod</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1262"></a><span>         </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable cause: the source code which generated interface file&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1263"></a><span>             </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has an incompatible module name&quot;</span><span>
</span><a name="line-1264"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-1265"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-1266"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1267"></a><span>  </span><span class="hs-comment">-- ToDo: This will fail to have enough qualification when the package IDs</span><span>
</span><a name="line-1268"></a><span>  </span><span class="hs-comment">-- are the same</span><span>
</span><a name="line-1269"></a><span>  </span><span class="hs-identifier hs-var">withPprStyle</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUserStyle</span><span> </span><a href="#local-6989586621681662371"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">alwaysQualify</span><span> </span><span class="hs-identifier hs-var">AllTheWay</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1270"></a><span>    </span><span class="hs-comment">-- we want the Modules below to be qualified with package names,</span><span>
</span><a name="line-1271"></a><span>    </span><span class="hs-comment">-- so reset the PrintUnqualified setting.</span><span>
</span><a name="line-1272"></a><span>    </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Something is amiss; requested module &quot;</span><span>
</span><a name="line-1273"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662372"><span class="hs-identifier hs-var">requested_mod</span></a><span>
</span><a name="line-1274"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;differs from name found in the interface file&quot;</span><span>
</span><a name="line-1275"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662373"><span class="hs-identifier hs-var">read_mod</span></a><span>
</span><a name="line-1276"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;if these names look the same, try again with -dppr-debug&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-1278"></a><span>
</span><a name="line-1279"></a><span class="hs-identifier">homeModError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InstalledModule</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1280"></a><span class="hs-comment">-- See Note [Home module load error]</span><span>
</span><a name="line-1281"></a><a name="homeModError"><a href="LoadIface.html#homeModError"><span class="hs-identifier">homeModError</span></a></a><span> </span><a name="local-6989586621681662374"><a href="#local-6989586621681662374"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681662375"><a href="#local-6989586621681662375"><span class="hs-identifier">location</span></a></a><span>
</span><a name="line-1282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;attempting to use module &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681662374"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1283"></a><span>    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621681662375"><span class="hs-identifier hs-var">location</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1284"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681662376"><a href="#local-6989586621681662376"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">space</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681662376"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span>
</span><a name="line-1285"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-1286"></a><span>    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;which is not loaded&quot;</span><span>
</span><a name="line-1287"></a></pre></body></html>