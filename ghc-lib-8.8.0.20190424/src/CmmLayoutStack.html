<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, RecordWildCards, GADTs #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CmmLayoutStack</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-3"></a><span>       </span><a href="CmmLayoutStack.html#cmmLayoutStack"><span class="hs-identifier hs-var">cmmLayoutStack</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#setInfoTableStackMap"><span class="hs-identifier hs-var">setInfoTableStackMap</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="StgCmmUtils.html#callerSaveVolatileRegs"><span class="hs-identifier hs-var">callerSaveVolatileRegs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- XXX layering violation</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmForeign.html"><span class="hs-identifier">StgCmmForeign</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="StgCmmForeign.html#saveThreadState"><span class="hs-identifier hs-var">saveThreadState</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmForeign.html#loadThreadState"><span class="hs-identifier hs-var">loadThreadState</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- XXX layering violation</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="CmmInfo.html"><span class="hs-identifier">CmmInfo</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ForeignCall</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="CmmLive.html"><span class="hs-identifier">CmmLive</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="CmmProcPoint.html"><span class="hs-identifier">CmmProcPoint</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Dataflow.html"><span class="hs-identifier">Hoopl.Dataflow</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl.Graph</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isEmpty</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Fix</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Array</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bits</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">{- Note [Stack Layout]

The job of this pass is to

 - replace references to abstract stack Areas with fixed offsets from Sp.

 - replace the CmmHighStackMark constant used in the stack check with
   the maximum stack usage of the proc.

 - save any variables that are live across a call, and reload them as
   necessary.

Before stack allocation, local variables remain live across native
calls (CmmCall{ cmm_cont = Just _ }), and after stack allocation local
variables are clobbered by native calls.

We want to do stack allocation so that as far as possible
 - stack use is minimized, and
 - unnecessary stack saves and loads are avoided.

The algorithm we use is a variant of linear-scan register allocation,
where the stack is our register file.

We proceed in two passes, see Note [Two pass approach] for why they are not easy
to merge into one.

Pass 1:

 - First, we do a liveness analysis, which annotates every block with
   the variables live on entry to the block.

 - We traverse blocks in reverse postorder DFS; that is, we visit at
   least one predecessor of a block before the block itself.  The
   stack layout flowing from the predecessor of the block will
   determine the stack layout on entry to the block.

 - We maintain a data structure

     Map Label StackMap

   which describes the contents of the stack and the stack pointer on
   entry to each block that is a successor of a block that we have
   visited.

 - For each block we visit:

    - Look up the StackMap for this block.

    - If this block is a proc point (or a call continuation, if we aren't
      splitting proc points), we need to reload all the live variables from the
      stack - but this is done in Pass 2, which calculates more precise liveness
      information (see description of Pass 2).

    - Walk forwards through the instructions:
      - At an assignment  x = Sp[loc]
        - Record the fact that Sp[loc] contains x, so that we won't
          need to save x if it ever needs to be spilled.
      - At an assignment  x = E
        - If x was previously on the stack, it isn't any more
      - At the last node, if it is a call or a jump to a proc point
        - Lay out the stack frame for the call (see setupStackFrame)
        - emit instructions to save all the live variables
        - Remember the StackMaps for all the successors
        - emit an instruction to adjust Sp
      - If the last node is a branch, then the current StackMap is the
        StackMap for the successors.

    - Manifest Sp: replace references to stack areas in this block
      with real Sp offsets. We cannot do this until we have laid out
      the stack area for the successors above.

      In this phase we also eliminate redundant stores to the stack;
      see elimStackStores.

  - There is one important gotcha: sometimes we'll encounter a control
    transfer to a block that we've already processed (a join point),
    and in that case we might need to rearrange the stack to match
    what the block is expecting. (exactly the same as in linear-scan
    register allocation, except here we have the luxury of an infinite
    supply of temporary variables).

  - Finally, we update the magic CmmHighStackMark constant with the
    stack usage of the function, and eliminate the whole stack check
    if there was no stack use. (in fact this is done as part of the
    main traversal, by feeding the high-water-mark output back in as
    an input. I hate cyclic programming, but it's just too convenient
    sometimes.)

  There are plenty of tricky details: update frames, proc points, return
  addresses, foreign calls, and some ad-hoc optimisations that are
  convenient to do here and effective in common cases.  Comments in the
  code below explain these.

Pass 2:

- Calculate live registers, but taking into account that nothing is live at the
  entry to a proc point.

- At each proc point and call continuation insert reloads of live registers from
  the stack (they were saved by Pass 1).


Note [Two pass approach]

The main reason for Pass 2 is being able to insert only the reloads that are
needed and the fact that the two passes need different liveness information.
Let's consider an example:

  .....
   \ /
    D   &lt;- proc point
   / \
  E   F
   \ /
    G   &lt;- proc point
    |
    X

Pass 1 needs liveness assuming that local variables are preserved across calls.
This is important because it needs to save any local registers to the stack
(e.g., if register a is used in block X, it must be saved before any native
call).
However, for Pass 2, where we want to reload registers from stack (in a proc
point), this is overly conservative and would lead us to generate reloads in D
for things used in X, even though we're going to generate reloads in G anyway
(since it's also a proc point).
So Pass 2 calculates liveness knowing that nothing is live at the entry to a
proc point. This means that in D we only need to reload things used in E or F.
This can be quite important, for an extreme example see testcase for #3294.

Merging the two passes is not trivial - Pass 2 is a backward rewrite and Pass 1
is a forward one. Furthermore, Pass 1 is creating code that uses local registers
(saving them before a call), which the liveness analysis for Pass 2 must see to
be correct.

-}</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- All stack locations are expressed as positive byte offsets from the</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- &quot;base&quot;, which is defined to be the address above the return address</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- on the stack on entry to this CmmProc.</span><span>
</span><a name="line-183"></a><span class="hs-comment">--</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- Lower addresses have higher StackLocs.</span><span>
</span><a name="line-185"></a><span class="hs-comment">--</span><span>
</span><a name="line-186"></a><span class="hs-keyword">type</span><span> </span><a name="StackLoc"><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier">StackLoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">{-
 A StackMap describes the stack at any given point.  At a continuation
 it has a particular layout, like this:

         |             | &lt;- base
         |-------------|
         |     ret0    | &lt;- base + 8
         |-------------|
         .  upd frame  . &lt;- base + sm_ret_off
         |-------------|
         |             |
         .    vars     .
         . (live/dead) .
         |             | &lt;- base + sm_sp - sm_args
         |-------------|
         |    ret1     |
         .  ret vals   . &lt;- base + sm_sp    (&lt;--- Sp points here)
         |-------------|

Why do we include the final return address (ret0) in our stack map?  I
have absolutely no idea, but it seems to be done that way consistently
in the rest of the code generator, so I played along here. --SDM

Note that we will be constructing an info table for the continuation
(ret1), which needs to describe the stack down to, but not including,
the update frame (or ret0, if there is no update frame).
-}</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-keyword">data</span><span> </span><a name="StackMap"><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier">StackMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="StackMap"><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier">StackMap</span></a></a><span>
</span><a name="line-217"></a><span> </span><span class="hs-special">{</span><span>  </span><a name="sm_sp"><a href="CmmLayoutStack.html#sm_sp"><span class="hs-identifier">sm_sp</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier hs-type">StackLoc</span></a><span>
</span><a name="line-218"></a><span>       </span><span class="hs-comment">-- ^ the offset of Sp relative to the base on entry</span><span>
</span><a name="line-219"></a><span>       </span><span class="hs-comment">-- to this block.</span><span>
</span><a name="line-220"></a><span> </span><span class="hs-special">,</span><span>  </span><a name="sm_args"><a href="CmmLayoutStack.html#sm_args"><span class="hs-identifier">sm_args</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-221"></a><span>       </span><span class="hs-comment">-- ^ the number of bytes of arguments in the area for this block</span><span>
</span><a name="line-222"></a><span>       </span><span class="hs-comment">-- Defn: the offset of young(L) relative to the base is given by</span><span>
</span><a name="line-223"></a><span>       </span><span class="hs-comment">-- (sm_sp - sm_args) of the StackMap for block L.</span><span>
</span><a name="line-224"></a><span> </span><span class="hs-special">,</span><span>  </span><a name="sm_ret_off"><a href="CmmLayoutStack.html#sm_ret_off"><span class="hs-identifier">sm_ret_off</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-225"></a><span>       </span><span class="hs-comment">-- ^ Number of words of stack that we do not describe with an info</span><span>
</span><a name="line-226"></a><span>       </span><span class="hs-comment">-- table, because it contains an update frame.</span><span>
</span><a name="line-227"></a><span> </span><span class="hs-special">,</span><span>  </span><a name="sm_regs"><a href="CmmLayoutStack.html#sm_regs"><span class="hs-identifier">sm_regs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqFM</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">,</span><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier hs-type">StackLoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>       </span><span class="hs-comment">-- ^ regs on the stack</span><span>
</span><a name="line-229"></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-232"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-var">StackMap</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-233"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Sp = &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621681193074"><span class="hs-identifier hs-var">sm_sp</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-234"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;sm_args = &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621681193075"><span class="hs-identifier hs-var">sm_args</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-235"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;sm_ret_off = &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621681193076"><span class="hs-identifier hs-var">sm_ret_off</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-236"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;sm_regs = &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">pprUFM</span><span> </span><a href="#local-6989586621681193077"><span class="hs-identifier hs-var">sm_regs</span></a><span> </span><span class="hs-identifier hs-var">ppr</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-identifier">cmmLayoutStack</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmProcPoint.html#ProcPointSet"><span class="hs-identifier hs-type">ProcPointSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span>
</span><a name="line-240"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><a name="cmmLayoutStack"><a href="CmmLayoutStack.html#cmmLayoutStack"><span class="hs-identifier">cmmLayoutStack</span></a></a><span> </span><a name="local-6989586621681193080"><a href="#local-6989586621681193080"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193081"><a href="#local-6989586621681193081"><span class="hs-identifier">procpoints</span></a></a><span> </span><a name="local-6989586621681193082"><a href="#local-6989586621681193082"><span class="hs-identifier">entry_args</span></a></a><span>
</span><a name="line-242"></a><span>               </span><a name="local-6989586621681193083"><a href="#local-6989586621681193083"><span class="hs-identifier">graph</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-var">CmmGraph</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">g_entry</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681193084"><a href="#local-6989586621681193084"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>    </span><span class="hs-comment">-- We need liveness info. Dead assignments are removed later</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-comment">-- by the sinking pass.</span><span>
</span><a name="line-246"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193085"><a href="#local-6989586621681193085"><span class="hs-identifier">liveness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLive.html#cmmLocalLiveness"><span class="hs-identifier hs-var">cmmLocalLiveness</span></a><span> </span><a href="#local-6989586621681193080"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193083"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-247"></a><span>        </span><a name="local-6989586621681193086"><a href="#local-6989586621681193086"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#revPostorder"><span class="hs-identifier hs-var">revPostorder</span></a><span> </span><a href="#local-6989586621681193083"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681193090"><a href="#local-6989586621681193090"><span class="hs-identifier">final_stackmaps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193091"><a href="#local-6989586621681193091"><span class="hs-identifier">_final_high_sp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193092"><a href="#local-6989586621681193092"><span class="hs-identifier">new_blocks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-250"></a><span>          </span><span class="hs-identifier hs-var">mfix</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><a name="local-6989586621681193087"><a href="#local-6989586621681193087"><span class="hs-identifier">rec_stackmaps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193088"><a href="#local-6989586621681193088"><span class="hs-identifier">rec_high_sp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193089"><a href="#local-6989586621681193089"><span class="hs-identifier">_new_blocks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-251"></a><span>            </span><a href="CmmLayoutStack.html#layout"><span class="hs-identifier hs-var">layout</span></a><span> </span><a href="#local-6989586621681193080"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193081"><span class="hs-identifier hs-var">procpoints</span></a><span> </span><a href="#local-6989586621681193085"><span class="hs-identifier hs-var">liveness</span></a><span> </span><a href="#local-6989586621681193084"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621681193082"><span class="hs-identifier hs-var">entry_args</span></a><span>
</span><a name="line-252"></a><span>                   </span><a href="#local-6989586621681193087"><span class="hs-identifier hs-var">rec_stackmaps</span></a><span> </span><a href="#local-6989586621681193088"><span class="hs-identifier hs-var">rec_high_sp</span></a><span> </span><a href="#local-6989586621681193086"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span>    </span><a name="local-6989586621681193093"><a href="#local-6989586621681193093"><span class="hs-identifier">blocks_with_reloads</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-255"></a><span>        </span><a href="CmmLayoutStack.html#insertReloadsAsNeeded"><span class="hs-identifier hs-var">insertReloadsAsNeeded</span></a><span> </span><a href="#local-6989586621681193080"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193081"><span class="hs-identifier hs-var">procpoints</span></a><span> </span><a href="#local-6989586621681193090"><span class="hs-identifier hs-var">final_stackmaps</span></a><span> </span><a href="#local-6989586621681193084"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621681193092"><span class="hs-identifier hs-var">new_blocks</span></a><span>
</span><a name="line-256"></a><span>    </span><a name="local-6989586621681193094"><a href="#local-6989586621681193094"><span class="hs-identifier">new_blocks'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#lowerSafeForeignCall"><span class="hs-identifier hs-var">lowerSafeForeignCall</span></a><span> </span><a href="#local-6989586621681193080"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193093"><span class="hs-identifier hs-var">blocks_with_reloads</span></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#ofBlockList"><span class="hs-identifier hs-var">ofBlockList</span></a><span> </span><a href="#local-6989586621681193084"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621681193094"><span class="hs-identifier hs-var">new_blocks'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193090"><span class="hs-identifier hs-var">final_stackmaps</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- Pass 1</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">layout</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-264"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>                      </span><span class="hs-comment">-- proc points</span><span>
</span><a name="line-265"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLive.html#CmmLocalLive"><span class="hs-identifier hs-type">CmmLocalLive</span></a><span>         </span><span class="hs-comment">-- liveness</span><span>
</span><a name="line-266"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>                       </span><span class="hs-comment">-- entry</span><span>
</span><a name="line-267"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>                       </span><span class="hs-comment">-- stack args on entry</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>             </span><span class="hs-comment">-- [final] stack maps</span><span>
</span><a name="line-270"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>                       </span><span class="hs-comment">-- [final] Sp high water mark</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- [in] blocks</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span>
</span><a name="line-275"></a><span>          </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>           </span><span class="hs-comment">-- [out] stack maps</span><span>
</span><a name="line-276"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>                     </span><span class="hs-comment">-- [out] Sp high water mark</span><span>
</span><a name="line-277"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- [out] new blocks</span><span>
</span><a name="line-278"></a><span>          </span><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><a name="layout"><a href="CmmLayoutStack.html#layout"><span class="hs-identifier">layout</span></a></a><span> </span><a name="local-6989586621681193095"><a href="#local-6989586621681193095"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193096"><a href="#local-6989586621681193096"><span class="hs-identifier">procpoints</span></a></a><span> </span><a name="local-6989586621681193097"><a href="#local-6989586621681193097"><span class="hs-identifier">liveness</span></a></a><span> </span><a name="local-6989586621681193098"><a href="#local-6989586621681193098"><span class="hs-identifier">entry</span></a></a><span> </span><a name="local-6989586621681193099"><a href="#local-6989586621681193099"><span class="hs-identifier">entry_args</span></a></a><span> </span><a name="local-6989586621681193100"><a href="#local-6989586621681193100"><span class="hs-identifier">final_stackmaps</span></a></a><span> </span><a name="local-6989586621681193101"><a href="#local-6989586621681193101"><span class="hs-identifier">final_sp_high</span></a></a><span> </span><a name="local-6989586621681193102"><a href="#local-6989586621681193102"><span class="hs-identifier">blocks</span></a></a><span>
</span><a name="line-281"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193106"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681193102"><span class="hs-identifier hs-var">blocks</span></a><span> </span><a href="#local-6989586621681193105"><span class="hs-identifier hs-var">init_stackmap</span></a><span> </span><a href="#local-6989586621681193099"><span class="hs-identifier hs-var">entry_args</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-283"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681193103"><a href="#local-6989586621681193103"><span class="hs-identifier">updfr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193104"><a href="#local-6989586621681193104"><span class="hs-identifier">cont_info</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#collectContInfo"><span class="hs-identifier hs-var">collectContInfo</span></a><span> </span><a href="#local-6989586621681193102"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>    </span><a name="local-6989586621681193105"><a href="#local-6989586621681193105"><span class="hs-identifier">init_stackmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><a href="#local-6989586621681193098"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-var">StackMap</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_sp</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193099"><span class="hs-identifier hs-var">entry_args</span></a><span>
</span><a name="line-286"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193099"><span class="hs-identifier hs-var">entry_args</span></a><span>
</span><a name="line-287"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_ret_off</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193103"><span class="hs-identifier hs-var">updfr</span></a><span>
</span><a name="line-288"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span>
</span><a name="line-289"></a><span>                                               </span><span class="hs-special">}</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span>    </span><a name="local-6989586621681193106"><a href="#local-6989586621681193106"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681193107"><a href="#local-6989586621681193107"><span class="hs-identifier">acc_stackmaps</span></a></a><span> </span><a name="local-6989586621681193108"><a href="#local-6989586621681193108"><span class="hs-identifier">acc_hwm</span></a></a><span> </span><a name="local-6989586621681193109"><a href="#local-6989586621681193109"><span class="hs-identifier">acc_blocks</span></a></a><span>
</span><a name="line-292"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193107"><span class="hs-identifier hs-var">acc_stackmaps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193108"><span class="hs-identifier hs-var">acc_hwm</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193109"><span class="hs-identifier hs-var">acc_blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193110"><a href="#local-6989586621681193110"><span class="hs-identifier">b0</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681193111"><a href="#local-6989586621681193111"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681193112"><a href="#local-6989586621681193112"><span class="hs-identifier">acc_stackmaps</span></a></a><span> </span><a name="local-6989586621681193113"><a href="#local-6989586621681193113"><span class="hs-identifier">acc_hwm</span></a></a><span> </span><a name="local-6989586621681193114"><a href="#local-6989586621681193114"><span class="hs-identifier">acc_blocks</span></a></a><span>
</span><a name="line-295"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-296"></a><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193115"><a href="#local-6989586621681193115"><span class="hs-identifier">entry0</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><a name="local-6989586621681193116"><a href="#local-6989586621681193116"><span class="hs-identifier">entry_lbl</span></a></a><span> </span><a name="local-6989586621681193117"><a href="#local-6989586621681193117"><span class="hs-identifier">tscope</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681193118"><a href="#local-6989586621681193118"><span class="hs-identifier">middle0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193119"><a href="#local-6989586621681193119"><span class="hs-identifier">last0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockSplit"><span class="hs-identifier hs-var">blockSplit</span></a><span> </span><a href="#local-6989586621681193110"><span class="hs-identifier hs-var">b0</span></a><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193120"><a href="#local-6989586621681193120"><span class="hs-identifier">stack0</span></a></a><span class="hs-glyph">@</span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-var">StackMap</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681193121"><a href="#local-6989586621681193121"><span class="hs-identifier">sp0</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-299"></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span>
</span><a name="line-300"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;no stack map for&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193116"><span class="hs-identifier hs-var">entry_lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>                     </span><a href="#local-6989586621681193116"><span class="hs-identifier hs-var">entry_lbl</span></a><span> </span><a href="#local-6989586621681193112"><span class="hs-identifier hs-var">acc_stackmaps</span></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>       </span><span class="hs-comment">-- (a) Update the stack map to include the effects of</span><span>
</span><a name="line-304"></a><span>       </span><span class="hs-comment">--     assignments in this block</span><span>
</span><a name="line-305"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193122"><a href="#local-6989586621681193122"><span class="hs-identifier">stack1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#foldBlockNodesF"><span class="hs-identifier hs-var">foldBlockNodesF</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#procMiddle"><span class="hs-identifier hs-var">procMiddle</span></a><span> </span><a href="#local-6989586621681193112"><span class="hs-identifier hs-var">acc_stackmaps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193118"><span class="hs-identifier hs-var">middle0</span></a><span> </span><a href="#local-6989586621681193120"><span class="hs-identifier hs-var">stack0</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>       </span><span class="hs-comment">-- (b) Look at the last node and if we are making a call or</span><span>
</span><a name="line-308"></a><span>       </span><span class="hs-comment">--     jumping to a proc point, we must save the live</span><span>
</span><a name="line-309"></a><span>       </span><span class="hs-comment">--     variables, adjust Sp, and construct the StackMaps for</span><span>
</span><a name="line-310"></a><span>       </span><span class="hs-comment">--     each of the successor blocks.  See handleLastNode for</span><span>
</span><a name="line-311"></a><span>       </span><span class="hs-comment">--     details.</span><span>
</span><a name="line-312"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621681193123"><a href="#local-6989586621681193123"><span class="hs-identifier">middle1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193124"><a href="#local-6989586621681193124"><span class="hs-identifier">sp_off</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193125"><a href="#local-6989586621681193125"><span class="hs-identifier">last1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193126"><a href="#local-6989586621681193126"><span class="hs-identifier">fixup_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193127"><a href="#local-6989586621681193127"><span class="hs-identifier">out</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmLayoutStack.html#handleLastNode"><span class="hs-identifier hs-var">handleLastNode</span></a><span> </span><a href="#local-6989586621681193095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193096"><span class="hs-identifier hs-var">procpoints</span></a><span> </span><a href="#local-6989586621681193097"><span class="hs-identifier hs-var">liveness</span></a><span> </span><a href="#local-6989586621681193104"><span class="hs-identifier hs-var">cont_info</span></a><span>
</span><a name="line-314"></a><span>                             </span><a href="#local-6989586621681193112"><span class="hs-identifier hs-var">acc_stackmaps</span></a><span> </span><a href="#local-6989586621681193122"><span class="hs-identifier hs-var">stack1</span></a><span> </span><a href="#local-6989586621681193117"><span class="hs-identifier hs-var">tscope</span></a><span> </span><a href="#local-6989586621681193118"><span class="hs-identifier hs-var">middle0</span></a><span> </span><a href="#local-6989586621681193119"><span class="hs-identifier hs-var">last0</span></a><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>       </span><span class="hs-comment">-- (c) Manifest Sp: run over the nodes in the block and replace</span><span>
</span><a name="line-317"></a><span>       </span><span class="hs-comment">--     CmmStackSlot with CmmLoad from Sp with a concrete offset.</span><span>
</span><a name="line-318"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-319"></a><span>       </span><span class="hs-comment">-- our block:</span><span>
</span><a name="line-320"></a><span>       </span><span class="hs-comment">--    middle0          -- the original middle nodes</span><span>
</span><a name="line-321"></a><span>       </span><span class="hs-comment">--    middle1          -- live variable saves from handleLastNode</span><span>
</span><a name="line-322"></a><span>       </span><span class="hs-comment">--    Sp = Sp + sp_off -- Sp adjustment goes here</span><span>
</span><a name="line-323"></a><span>       </span><span class="hs-comment">--    last1            -- the last node</span><span>
</span><a name="line-324"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-325"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193128"><a href="#local-6989586621681193128"><span class="hs-identifier">middle_pre</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockToList"><span class="hs-identifier hs-var">blockToList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="Hoopl.Block.html#blockSnoc"><span class="hs-identifier hs-var">blockSnoc</span></a><span> </span><a href="#local-6989586621681193118"><span class="hs-identifier hs-var">middle0</span></a><span> </span><a href="#local-6989586621681193123"><span class="hs-identifier hs-var">middle1</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193129"><a href="#local-6989586621681193129"><span class="hs-identifier">final_blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-328"></a><span>               </span><a href="CmmLayoutStack.html#manifestSp"><span class="hs-identifier hs-var">manifestSp</span></a><span> </span><a href="#local-6989586621681193095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193100"><span class="hs-identifier hs-var">final_stackmaps</span></a><span> </span><a href="#local-6989586621681193120"><span class="hs-identifier hs-var">stack0</span></a><span> </span><a href="#local-6989586621681193121"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193101"><span class="hs-identifier hs-var">final_sp_high</span></a><span>
</span><a name="line-329"></a><span>                          </span><a href="#local-6989586621681193115"><span class="hs-identifier hs-var">entry0</span></a><span> </span><a href="#local-6989586621681193128"><span class="hs-identifier hs-var">middle_pre</span></a><span> </span><a href="#local-6989586621681193124"><span class="hs-identifier hs-var">sp_off</span></a><span> </span><a href="#local-6989586621681193125"><span class="hs-identifier hs-var">last1</span></a><span> </span><a href="#local-6989586621681193126"><span class="hs-identifier hs-var">fixup_blocks</span></a><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193130"><a href="#local-6989586621681193130"><span class="hs-identifier">acc_stackmaps'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapUnion"><span class="hs-identifier hs-var">mapUnion</span></a><span> </span><a href="#local-6989586621681193112"><span class="hs-identifier hs-var">acc_stackmaps</span></a><span> </span><a href="#local-6989586621681193127"><span class="hs-identifier hs-var">out</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span>           </span><span class="hs-comment">-- If this block jumps to the GC, then we do not take its</span><span>
</span><a name="line-334"></a><span>           </span><span class="hs-comment">-- stack usage into account for the high-water mark.</span><span>
</span><a name="line-335"></a><span>           </span><span class="hs-comment">-- Otherwise, if the only stack usage is in the stack-check</span><span>
</span><a name="line-336"></a><span>           </span><span class="hs-comment">-- failure block itself, we will do a redundant stack</span><span>
</span><a name="line-337"></a><span>           </span><span class="hs-comment">-- check.  The stack has a buffer designed to accommodate</span><span>
</span><a name="line-338"></a><span>           </span><span class="hs-comment">-- the largest amount of stack needed for calling the GC.</span><span>
</span><a name="line-339"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-340"></a><span>           </span><a name="local-6989586621681193131"><a href="#local-6989586621681193131"><span class="hs-identifier">this_sp_hwm</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CmmLayoutStack.html#isGcJump"><span class="hs-identifier hs-var">isGcJump</span></a><span> </span><a href="#local-6989586621681193119"><span class="hs-identifier hs-var">last0</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-341"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193121"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193124"><span class="hs-identifier hs-var">sp_off</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>           </span><a name="local-6989586621681193132"><a href="#local-6989586621681193132"><span class="hs-identifier">hwm'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maximum</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193113"><span class="hs-identifier hs-var">acc_hwm</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681193131"><span class="hs-identifier hs-var">this_sp_hwm</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapElems"><span class="hs-identifier hs-var">mapElems</span></a><span> </span><a href="#local-6989586621681193127"><span class="hs-identifier hs-var">out</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>       </span><a href="#local-6989586621681193106"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681193111"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621681193130"><span class="hs-identifier hs-var">acc_stackmaps'</span></a><span> </span><a href="#local-6989586621681193132"><span class="hs-identifier hs-var">hwm'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193129"><span class="hs-identifier hs-var">final_blocks</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681193114"><span class="hs-identifier hs-var">acc_blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-comment">-- Not foolproof, but GCFun is the culprit we most want to catch</span><span>
</span><a name="line-351"></a><span class="hs-identifier">isGcJump</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-352"></a><a name="isGcJump"><a href="CmmLayoutStack.html#isGcJump"><span class="hs-identifier">isGcJump</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_target</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a name="local-6989586621681193133"><a href="#local-6989586621681193133"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193133"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CmmExpr.html#GCFun"><span class="hs-identifier hs-var">GCFun</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681193133"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CmmExpr.html#GCEnter1"><span class="hs-identifier hs-var">GCEnter1</span></a><span>
</span><a name="line-354"></a><span class="hs-identifier">isGcJump</span><span> </span><a name="local-6989586621681193134"><a href="#local-6989586621681193134"><span class="hs-identifier">_something_else</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-comment">-- This doesn't seem right somehow.  We need to find out whether this</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- proc will push some update frame material at some point, so that we</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- can avoid using that area of the stack for spilling.  The</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- updfr_space field of the CmmProc *should* tell us, but it doesn't</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- (I think maybe it gets filled in later when we do proc-point</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- splitting).</span><span>
</span><a name="line-364"></a><span class="hs-comment">--</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- So we'll just take the max of all the cml_ret_offs.  This could be</span><span>
</span><a name="line-366"></a><span class="hs-comment">-- unnecessarily pessimistic, but probably not in the code we</span><span>
</span><a name="line-367"></a><span class="hs-comment">-- generate.</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-identifier">collectContInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><a name="collectContInfo"><a href="CmmLayoutStack.html#collectContInfo"><span class="hs-identifier">collectContInfo</span></a></a><span> </span><a name="local-6989586621681193135"><a href="#local-6989586621681193135"><span class="hs-identifier">blocks</span></a></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maximum</span><span> </span><a href="#local-6989586621681193137"><span class="hs-identifier hs-var">ret_offs</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621681193136"><span class="hs-identifier hs-var">mb_argss</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681193136"><a href="#local-6989586621681193136"><span class="hs-identifier">mb_argss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193137"><a href="#local-6989586621681193137"><span class="hs-identifier">ret_offs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAndUnzip</span><span> </span><a href="#local-6989586621681193138"><span class="hs-identifier hs-var">get_cont</span></a><span> </span><a href="#local-6989586621681193135"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>  </span><span class="hs-identifier">get_cont</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Block.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621681193139"><span class="hs-identifier hs-type">x</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>  </span><a name="local-6989586621681193138"><a href="#local-6989586621681193138"><span class="hs-identifier">get_cont</span></a></a><span> </span><a name="local-6989586621681193140"><a href="#local-6989586621681193140"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-377"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Block.html#lastNode"><span class="hs-identifier hs-var">lastNode</span></a><span> </span><a href="#local-6989586621681193140"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-378"></a><span>        </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193141"><a href="#local-6989586621681193141"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-379"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193141"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193145"><span class="hs-identifier hs-var">cml_ret_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193146"><span class="hs-identifier hs-var">cml_ret_off</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>        </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-381"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193150"><span class="hs-identifier hs-var">succ</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193151"><span class="hs-identifier hs-var">ret_args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193152"><span class="hs-identifier hs-var">ret_off</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>        </span><a name="local-6989586621681193154"><a href="#local-6989586621681193154"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- Updating the StackMap from middle nodes</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span class="hs-comment">-- Look for loads from stack slots, and update the StackMap.  This is</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- purely for optimisation reasons, so that we can avoid saving a</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- variable back to a different stack slot if it is already on the</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- stack.</span><span>
</span><a name="line-392"></a><span class="hs-comment">--</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- This happens a lot: for example when function arguments are passed</span><span>
</span><a name="line-394"></a><span class="hs-comment">-- on the stack and need to be immediately saved across a call, we</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- want to just leave them where they are on the stack.</span><span>
</span><a name="line-396"></a><span class="hs-comment">--</span><span>
</span><a name="line-397"></a><span class="hs-identifier">procMiddle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621681193078"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621681193079"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-398"></a><a name="procMiddle"><a href="CmmLayoutStack.html#procMiddle"><span class="hs-identifier">procMiddle</span></a></a><span> </span><a name="local-6989586621681193155"><a href="#local-6989586621681193155"><span class="hs-identifier">stackmaps</span></a></a><span> </span><a name="local-6989586621681193156"><a href="#local-6989586621681193156"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621681193157"><a href="#local-6989586621681193157"><span class="hs-identifier">sm</span></a></a><span>
</span><a name="line-399"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681193156"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-400"></a><span>     </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a name="local-6989586621681193158"><a href="#local-6989586621681193158"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a name="local-6989586621681193159"><a href="#local-6989586621681193159"><span class="hs-identifier">area</span></a></a><span> </span><a name="local-6989586621681193160"><a href="#local-6989586621681193160"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193157"><span class="hs-identifier hs-var">sm</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_regs</span><span> </span><a href="#local-6989586621681193157"><span class="hs-identifier hs-var">sm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193158"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193158"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><a href="#local-6989586621681193161"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-402"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193161"><a href="#local-6989586621681193161"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#getStackLoc"><span class="hs-identifier hs-var">getStackLoc</span></a><span> </span><a href="#local-6989586621681193159"><span class="hs-identifier hs-var">area</span></a><span> </span><a href="#local-6989586621681193160"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621681193155"><span class="hs-identifier hs-var">stackmaps</span></a><span>
</span><a name="line-403"></a><span>     </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a name="local-6989586621681193162"><a href="#local-6989586621681193162"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681193163"><a href="#local-6989586621681193163"><span class="hs-identifier">_other</span></a></a><span>
</span><a name="line-404"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193157"><span class="hs-identifier hs-var">sm</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_regs</span><span> </span><a href="#local-6989586621681193157"><span class="hs-identifier hs-var">sm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193162"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-405"></a><span>     </span><a name="local-6989586621681193164"><a href="#local-6989586621681193164"><span class="hs-identifier">_other</span></a></a><span>
</span><a name="line-406"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193157"><span class="hs-identifier hs-var">sm</span></a><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">getStackLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#Area"><span class="hs-identifier hs-type">Area</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier hs-type">StackLoc</span></a><span>
</span><a name="line-409"></a><a name="getStackLoc"><a href="CmmLayoutStack.html#getStackLoc"><span class="hs-identifier">getStackLoc</span></a></a><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span>       </span><a name="local-6989586621681193165"><a href="#local-6989586621681193165"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193165"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-410"></a><span class="hs-identifier">getStackLoc</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a name="local-6989586621681193166"><a href="#local-6989586621681193166"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681193167"><a href="#local-6989586621681193167"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621681193168"><a href="#local-6989586621681193168"><span class="hs-identifier">stackmaps</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-411"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621681193166"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193168"><span class="hs-identifier hs-var">stackmaps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-412"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;getStackLoc&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193166"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193169"><a href="#local-6989586621681193169"><span class="hs-identifier">sm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193169"><span class="hs-identifier hs-var">sm</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">sm_args</span><span> </span><a href="#local-6989586621681193169"><span class="hs-identifier hs-var">sm</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681193167"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- Handling stack allocation for a last node</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- We take a single last node and turn it into:</span><span>
</span><a name="line-420"></a><span class="hs-comment">--</span><span>
</span><a name="line-421"></a><span class="hs-comment">--    C1 (some statements)</span><span>
</span><a name="line-422"></a><span class="hs-comment">--    Sp = Sp + N</span><span>
</span><a name="line-423"></a><span class="hs-comment">--    C2 (some more statements)</span><span>
</span><a name="line-424"></a><span class="hs-comment">--    call f()          -- the actual last node</span><span>
</span><a name="line-425"></a><span class="hs-comment">--</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- plus possibly some more blocks (we may have to add some fixup code</span><span>
</span><a name="line-427"></a><span class="hs-comment">-- between the last node and the continuation).</span><span>
</span><a name="line-428"></a><span class="hs-comment">--</span><span>
</span><a name="line-429"></a><span class="hs-comment">-- C1: is the code for saving the variables across this last node onto</span><span>
</span><a name="line-430"></a><span class="hs-comment">-- the stack, if the continuation is a call or jumps to a proc point.</span><span>
</span><a name="line-431"></a><span class="hs-comment">--</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- C2: if the last node is a safe foreign call, we have to inject some</span><span>
</span><a name="line-433"></a><span class="hs-comment">-- extra code that goes *after* the Sp adjustment.</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-identifier">handleLastNode</span><span>
</span><a name="line-436"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmProcPoint.html#ProcPointSet"><span class="hs-identifier hs-type">ProcPointSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLive.html#CmmLocalLive"><span class="hs-identifier hs-type">CmmLocalLive</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-437"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span>
</span><a name="line-438"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Block.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-439"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-440"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span>
</span><a name="line-441"></a><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- nodes to go *before* the Sp adjustment</span><span>
</span><a name="line-442"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>            </span><span class="hs-comment">-- amount to adjust Sp</span><span>
</span><a name="line-443"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>        </span><span class="hs-comment">-- new last node</span><span>
</span><a name="line-444"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- new blocks</span><span>
</span><a name="line-445"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>  </span><span class="hs-comment">-- stackmaps for the continuations</span><span>
</span><a name="line-446"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><a name="handleLastNode"><a href="CmmLayoutStack.html#handleLastNode"><span class="hs-identifier">handleLastNode</span></a></a><span> </span><a name="local-6989586621681193170"><a href="#local-6989586621681193170"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193171"><a href="#local-6989586621681193171"><span class="hs-identifier">procpoints</span></a></a><span> </span><a name="local-6989586621681193172"><a href="#local-6989586621681193172"><span class="hs-identifier">liveness</span></a></a><span> </span><a name="local-6989586621681193173"><a href="#local-6989586621681193173"><span class="hs-identifier">cont_info</span></a></a><span> </span><a name="local-6989586621681193174"><a href="#local-6989586621681193174"><span class="hs-identifier">stackmaps</span></a></a><span>
</span><a name="line-449"></a><span>               </span><a name="local-6989586621681193175"><a href="#local-6989586621681193175"><span class="hs-identifier">stack0</span></a></a><span class="hs-glyph">@</span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-var">StackMap</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681193176"><a href="#local-6989586621681193176"><span class="hs-identifier">sp0</span></a></a><span> </span><span class="hs-special">}</span><span> </span><a name="local-6989586621681193177"><a href="#local-6989586621681193177"><span class="hs-identifier">tscp</span></a></a><span> </span><a name="local-6989586621681193178"><a href="#local-6989586621681193178"><span class="hs-identifier">middle</span></a></a><span> </span><a name="local-6989586621681193179"><a href="#local-6989586621681193179"><span class="hs-identifier">last</span></a></a><span>
</span><a name="line-450"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-451"></a><span>    </span><span class="hs-comment">--  At each return / tail call,</span><span>
</span><a name="line-452"></a><span>    </span><span class="hs-comment">--  adjust Sp to point to the last argument pushed, which</span><span>
</span><a name="line-453"></a><span>    </span><span class="hs-comment">--  is cml_args, after popping any other junk from the stack.</span><span>
</span><a name="line-454"></a><span>    </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-455"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193230"><a href="#local-6989586621681193230"><span class="hs-identifier">sp_off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193176"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193227"><span class="hs-identifier hs-var">cml_args</span></a><span>
</span><a name="line-456"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193230"><span class="hs-identifier hs-var">sp_off</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>    </span><span class="hs-comment">--  At each CmmCall with a continuation:</span><span>
</span><a name="line-459"></a><span>    </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193231"><a href="#local-6989586621681193231"><span class="hs-identifier">cont_lbl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-460"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681193180"><span class="hs-identifier hs-var">lastCall</span></a><span> </span><a href="#local-6989586621681193231"><span class="hs-identifier hs-var">cont_lbl</span></a><span> </span><a href="#local-6989586621681193234"><span class="hs-identifier hs-var">cml_args</span></a><span> </span><a href="#local-6989586621681193235"><span class="hs-identifier hs-var">cml_ret_args</span></a><span> </span><a href="#local-6989586621681193236"><span class="hs-identifier hs-var">cml_ret_off</span></a><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>    </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">succ</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681193237"><a href="#local-6989586621681193237"><span class="hs-identifier">cont_lbl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-463"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681193180"><span class="hs-identifier hs-var">lastCall</span></a><span> </span><a href="#local-6989586621681193237"><span class="hs-identifier hs-var">cont_lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193170"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193241"><span class="hs-identifier hs-var">ret_args</span></a><span> </span><a href="#local-6989586621681193242"><span class="hs-identifier hs-var">ret_off</span></a><span>
</span><a name="line-464"></a><span>            </span><span class="hs-comment">-- one word of args: the return address</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span>    </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="#local-6989586621681193182"><span class="hs-identifier hs-var">handleBranches</span></a><span>
</span><a name="line-467"></a><span>    </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="#local-6989586621681193182"><span class="hs-identifier hs-var">handleBranches</span></a><span>
</span><a name="line-468"></a><span>    </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="#local-6989586621681193182"><span class="hs-identifier hs-var">handleBranches</span></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-471"></a><span>     </span><span class="hs-comment">-- Calls and ForeignCalls are handled the same way:</span><span>
</span><a name="line-472"></a><span>     </span><span class="hs-identifier">lastCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-473"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-474"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-475"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-476"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-477"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-478"></a><span>                 </span><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>     </span><a name="local-6989586621681193180"><a href="#local-6989586621681193180"><span class="hs-identifier">lastCall</span></a></a><span> </span><a name="local-6989586621681193184"><a href="#local-6989586621681193184"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681193185"><a href="#local-6989586621681193185"><span class="hs-identifier">cml_args</span></a></a><span> </span><a name="local-6989586621681193186"><a href="#local-6989586621681193186"><span class="hs-identifier">cml_ret_args</span></a></a><span> </span><a name="local-6989586621681193187"><a href="#local-6989586621681193187"><span class="hs-identifier">cml_ret_off</span></a></a><span>
</span><a name="line-480"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621681193188"><span class="hs-identifier hs-var">assignments</span></a><span>
</span><a name="line-481"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#spOffsetForCall"><span class="hs-identifier hs-var">spOffsetForCall</span></a><span> </span><a href="#local-6989586621681193176"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193189"><span class="hs-identifier hs-var">cont_stack</span></a><span> </span><a href="#local-6989586621681193185"><span class="hs-identifier hs-var">cml_args</span></a><span>
</span><a name="line-482"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-483"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- no new blocks</span><span>
</span><a name="line-484"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><a href="#local-6989586621681193184"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681193189"><span class="hs-identifier hs-var">cont_stack</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-486"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681193188"><a href="#local-6989586621681193188"><span class="hs-identifier">assignments</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193189"><a href="#local-6989586621681193189"><span class="hs-identifier">cont_stack</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193181"><span class="hs-identifier hs-var">prepareStack</span></a><span> </span><a href="#local-6989586621681193184"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681193186"><span class="hs-identifier hs-var">cml_ret_args</span></a><span> </span><a href="#local-6989586621681193187"><span class="hs-identifier hs-var">cml_ret_off</span></a><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span>     </span><a name="local-6989586621681193181"><a href="#local-6989586621681193181"><span class="hs-identifier">prepareStack</span></a></a><span> </span><a name="local-6989586621681193190"><a href="#local-6989586621681193190"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681193191"><a href="#local-6989586621681193191"><span class="hs-identifier">cml_ret_args</span></a></a><span> </span><a name="local-6989586621681193192"><a href="#local-6989586621681193192"><span class="hs-identifier">cml_ret_off</span></a></a><span>
</span><a name="line-490"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193195"><a href="#local-6989586621681193195"><span class="hs-identifier">cont_stack</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621681193190"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681193174"><span class="hs-identifier hs-var">stackmaps</span></a><span>
</span><a name="line-491"></a><span>             </span><span class="hs-comment">-- If we have already seen this continuation before, then</span><span>
</span><a name="line-492"></a><span>             </span><span class="hs-comment">-- we just have to make the stack look the same:</span><span>
</span><a name="line-493"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#fixupStack"><span class="hs-identifier hs-var">fixupStack</span></a><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span> </span><a href="#local-6989586621681193195"><span class="hs-identifier hs-var">cont_stack</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193195"><span class="hs-identifier hs-var">cont_stack</span></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>             </span><span class="hs-comment">-- Otherwise, we have to allocate the stack frame</span><span>
</span><a name="line-495"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-496"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193194"><span class="hs-identifier hs-var">save_assignments</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193193"><span class="hs-identifier hs-var">new_cont_stack</span></a><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-498"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681193193"><a href="#local-6989586621681193193"><span class="hs-identifier">new_cont_stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193194"><a href="#local-6989586621681193194"><span class="hs-identifier">save_assignments</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#setupStackFrame"><span class="hs-identifier hs-var">setupStackFrame</span></a><span> </span><a href="#local-6989586621681193170"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193190"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681193172"><span class="hs-identifier hs-var">liveness</span></a><span> </span><a href="#local-6989586621681193192"><span class="hs-identifier hs-var">cml_ret_off</span></a><span> </span><a href="#local-6989586621681193191"><span class="hs-identifier hs-var">cml_ret_args</span></a><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span>     </span><span class="hs-comment">-- For other last nodes (branches), if any of the targets is a</span><span>
</span><a name="line-503"></a><span>     </span><span class="hs-comment">-- proc point, we have to set up the stack to match what the proc</span><span>
</span><a name="line-504"></a><span>     </span><span class="hs-comment">-- point is expecting.</span><span>
</span><a name="line-505"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-506"></a><span>     </span><span class="hs-identifier">handleBranches</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-507"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-508"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-509"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-510"></a><span>                                </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>     </span><a name="local-6989586621681193182"><a href="#local-6989586621681193182"><span class="hs-identifier">handleBranches</span></a></a><span>
</span><a name="line-513"></a><span>         </span><span class="hs-comment">-- Note [diamond proc point]</span><span>
</span><a name="line-514"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193196"><a href="#local-6989586621681193196"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmLayoutStack.html#futureContinuation"><span class="hs-identifier hs-var">futureContinuation</span></a><span> </span><a href="#local-6989586621681193178"><span class="hs-identifier hs-var">middle</span></a><span>
</span><a name="line-515"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193171"><span class="hs-identifier hs-var">procpoints</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681193196"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-516"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-517"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193197"><a href="#local-6989586621681193197"><span class="hs-identifier">cont_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681193196"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193173"><span class="hs-identifier hs-var">cont_info</span></a><span>
</span><a name="line-518"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621681193198"><a href="#local-6989586621681193198"><span class="hs-identifier">assigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193199"><a href="#local-6989586621681193199"><span class="hs-identifier">cont_stack</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193181"><span class="hs-identifier hs-var">prepareStack</span></a><span> </span><a href="#local-6989586621681193196"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193197"><span class="hs-identifier hs-var">cont_args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_ret_off</span><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span class="hs-special">)</span><span>
</span><a name="line-519"></a><span>             </span><a name="local-6989586621681193200"><a href="#local-6989586621681193200"><span class="hs-identifier">out</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193201"><span class="hs-identifier hs-var">l'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193199"><span class="hs-identifier hs-var">cont_stack</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681193201"><a href="#local-6989586621681193201"><span class="hs-identifier">l'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-521"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621681193198"><span class="hs-identifier hs-var">assigs</span></a><span>
</span><a name="line-522"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#spOffsetForCall"><span class="hs-identifier hs-var">spOffsetForCall</span></a><span> </span><a href="#local-6989586621681193176"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193199"><span class="hs-identifier hs-var">cont_stack</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193170"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-524"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-525"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193200"><span class="hs-identifier hs-var">out</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-528"></a><span>          </span><a name="local-6989586621681193202"><a href="#local-6989586621681193202"><span class="hs-identifier">pps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621681193183"><span class="hs-identifier hs-var">handleBranch</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">lbl_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span>
</span><a name="line-530"></a><span>              </span><a name="local-6989586621681193203"><a href="#local-6989586621681193203"><span class="hs-identifier">lbl_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193205"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621681193206"><span class="hs-identifier hs-var">tmp</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193205"><a href="#local-6989586621681193205"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><a name="local-6989586621681193206"><a href="#local-6989586621681193206"><span class="hs-identifier">tmp</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681193202"><span class="hs-identifier hs-var">pps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-531"></a><span>              </span><a name="local-6989586621681193204"><a href="#local-6989586621681193204"><span class="hs-identifier">fix_lbl</span></a></a><span> </span><a name="local-6989586621681193207"><a href="#local-6989586621681193207"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><a href="#local-6989586621681193207"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193207"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193203"><span class="hs-identifier hs-var">lbl_map</span></a><span>
</span><a name="line-532"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-533"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-534"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#mapSuccessors"><span class="hs-identifier hs-var">mapSuccessors</span></a><span> </span><a href="#local-6989586621681193204"><span class="hs-identifier hs-var">fix_lbl</span></a><span> </span><a href="#local-6989586621681193179"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-535"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681193208"><span class="hs-identifier hs-var">blk</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681193208"><a href="#local-6989586621681193208"><span class="hs-identifier">blk</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681193202"><span class="hs-identifier hs-var">pps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-536"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193209"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193210"><span class="hs-identifier hs-var">sm</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193209"><a href="#local-6989586621681193209"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681193210"><a href="#local-6989586621681193210"><span class="hs-identifier">sm</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681193202"><span class="hs-identifier hs-var">pps</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span>     </span><span class="hs-comment">-- For each successor of this block</span><span>
</span><a name="line-539"></a><span>     </span><span class="hs-identifier">handleBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>     </span><a name="local-6989586621681193183"><a href="#local-6989586621681193183"><span class="hs-identifier">handleBranch</span></a></a><span> </span><a name="local-6989586621681193211"><a href="#local-6989586621681193211"><span class="hs-identifier">l</span></a></a><span>
</span><a name="line-541"></a><span>        </span><span class="hs-comment">--   (a) if the successor already has a stackmap, we need to</span><span>
</span><a name="line-542"></a><span>        </span><span class="hs-comment">--       shuffle the current stack to make it look the same.</span><span>
</span><a name="line-543"></a><span>        </span><span class="hs-comment">--       We have to insert a new block to make this happen.</span><span>
</span><a name="line-544"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193216"><a href="#local-6989586621681193216"><span class="hs-identifier">stack2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193174"><span class="hs-identifier hs-var">stackmaps</span></a><span>
</span><a name="line-545"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-546"></a><span>             </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193217"><a href="#local-6989586621681193217"><span class="hs-identifier">assigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#fixupStack"><span class="hs-identifier hs-var">fixupStack</span></a><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span> </span><a href="#local-6989586621681193216"><span class="hs-identifier hs-var">stack2</span></a><span>
</span><a name="line-547"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621681193218"><a href="#local-6989586621681193218"><span class="hs-identifier">tmp_lbl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193219"><a href="#local-6989586621681193219"><span class="hs-identifier">block</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmLayoutStack.html#makeFixupBlock"><span class="hs-identifier hs-var">makeFixupBlock</span></a><span> </span><a href="#local-6989586621681193170"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193176"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193216"><span class="hs-identifier hs-var">stack2</span></a><span> </span><a href="#local-6989586621681193177"><span class="hs-identifier hs-var">tscp</span></a><span> </span><a href="#local-6989586621681193217"><span class="hs-identifier hs-var">assigs</span></a><span>
</span><a name="line-548"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193218"><span class="hs-identifier hs-var">tmp_lbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193216"><span class="hs-identifier hs-var">stack2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193219"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>        </span><span class="hs-comment">--   (b) if the successor is a proc point, save everything</span><span>
</span><a name="line-551"></a><span>        </span><span class="hs-comment">--       on the stack.</span><span>
</span><a name="line-552"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193171"><span class="hs-identifier hs-var">procpoints</span></a><span>
</span><a name="line-553"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-554"></a><span>             </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193220"><a href="#local-6989586621681193220"><span class="hs-identifier">cont_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193173"><span class="hs-identifier hs-var">cont_info</span></a><span>
</span><a name="line-555"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621681193221"><a href="#local-6989586621681193221"><span class="hs-identifier">stack2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193222"><a href="#local-6989586621681193222"><span class="hs-identifier">assigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-556"></a><span>                      </span><a href="CmmLayoutStack.html#setupStackFrame"><span class="hs-identifier hs-var">setupStackFrame</span></a><span> </span><a href="#local-6989586621681193170"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193172"><span class="hs-identifier hs-var">liveness</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_ret_off</span><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>                                                        </span><a href="#local-6989586621681193220"><span class="hs-identifier hs-var">cont_args</span></a><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span>
</span><a name="line-558"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621681193223"><a href="#local-6989586621681193223"><span class="hs-identifier">tmp_lbl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193224"><a href="#local-6989586621681193224"><span class="hs-identifier">block</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmLayoutStack.html#makeFixupBlock"><span class="hs-identifier hs-var">makeFixupBlock</span></a><span> </span><a href="#local-6989586621681193170"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193176"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193221"><span class="hs-identifier hs-var">stack2</span></a><span> </span><a href="#local-6989586621681193177"><span class="hs-identifier hs-var">tscp</span></a><span> </span><a href="#local-6989586621681193222"><span class="hs-identifier hs-var">assigs</span></a><span>
</span><a name="line-559"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193223"><span class="hs-identifier hs-var">tmp_lbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193221"><span class="hs-identifier hs-var">stack2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193224"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>        </span><span class="hs-comment">--   (c) otherwise, the current StackMap is the StackMap for</span><span>
</span><a name="line-562"></a><span>        </span><span class="hs-comment">--       the continuation.  But we must remember to remove any</span><span>
</span><a name="line-563"></a><span>        </span><span class="hs-comment">--       variables from the StackMap that are *not* live at</span><span>
</span><a name="line-564"></a><span>        </span><span class="hs-comment">--       the destination, because this StackMap might be used</span><span>
</span><a name="line-565"></a><span>        </span><span class="hs-comment">--       by fixupStack if this is a join point.</span><span>
</span><a name="line-566"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193213"><span class="hs-identifier hs-var">stack1</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193212"><a href="#local-6989586621681193212"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;handleBranch&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193211"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193172"><span class="hs-identifier hs-var">liveness</span></a><span>
</span><a name="line-568"></a><span>              </span><a name="local-6989586621681193213"><a href="#local-6989586621681193213"><span class="hs-identifier">stack1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterUFM</span><span> </span><a href="#local-6989586621681193214"><span class="hs-identifier hs-var">is_live</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_regs</span><span> </span><a href="#local-6989586621681193175"><span class="hs-identifier hs-var">stack0</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-569"></a><span>              </span><a name="local-6989586621681193214"><a href="#local-6989586621681193214"><span class="hs-identifier">is_live</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681193215"><a href="#local-6989586621681193215"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193215"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><a href="CmmExpr.html#elemRegSet"><span class="hs-identifier hs-var">elemRegSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193212"><span class="hs-identifier hs-var">live</span></a><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span class="hs-identifier">makeFixupBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-573"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-574"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-575"></a><a name="makeFixupBlock"><a href="CmmLayoutStack.html#makeFixupBlock"><span class="hs-identifier">makeFixupBlock</span></a></a><span> </span><a name="local-6989586621681193244"><a href="#local-6989586621681193244"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193245"><a href="#local-6989586621681193245"><span class="hs-identifier">sp0</span></a></a><span> </span><a name="local-6989586621681193246"><a href="#local-6989586621681193246"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621681193247"><a href="#local-6989586621681193247"><span class="hs-identifier">stack</span></a></a><span> </span><a name="local-6989586621681193248"><a href="#local-6989586621681193248"><span class="hs-identifier">tscope</span></a></a><span> </span><a name="local-6989586621681193249"><a href="#local-6989586621681193249"><span class="hs-identifier">assigs</span></a></a><span>
</span><a name="line-576"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681193249"><span class="hs-identifier hs-var">assigs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681193245"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193247"><span class="hs-identifier hs-var">stack</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193246"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-578"></a><span>    </span><a name="local-6989586621681193250"><a href="#local-6989586621681193250"><span class="hs-identifier">tmp_lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-579"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193251"><a href="#local-6989586621681193251"><span class="hs-identifier">sp_off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193245"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193247"><span class="hs-identifier hs-var">stack</span></a><span>
</span><a name="line-580"></a><span>        </span><a name="local-6989586621681193252"><a href="#local-6989586621681193252"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockJoin"><span class="hs-identifier hs-var">blockJoin</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><a href="#local-6989586621681193250"><span class="hs-identifier hs-var">tmp_lbl</span></a><span> </span><a href="#local-6989586621681193248"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>                          </span><span class="hs-special">(</span><span> </span><a href="CmmLayoutStack.html#maybeAddSpAdj"><span class="hs-identifier hs-var">maybeAddSpAdj</span></a><span> </span><a href="#local-6989586621681193244"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193245"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193251"><span class="hs-identifier hs-var">sp_off</span></a><span>
</span><a name="line-582"></a><span>                           </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Block.html#blockFromList"><span class="hs-identifier hs-var">blockFromList</span></a><span> </span><a href="#local-6989586621681193249"><span class="hs-identifier hs-var">assigs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>                          </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621681193246"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193250"><span class="hs-identifier hs-var">tmp_lbl</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681193252"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-comment">-- Sp is currently pointing to current_sp,</span><span>
</span><a name="line-588"></a><span class="hs-comment">-- we want it to point to</span><span>
</span><a name="line-589"></a><span class="hs-comment">--    (sm_sp cont_stack - sm_args cont_stack + args)</span><span>
</span><a name="line-590"></a><span class="hs-comment">-- so the difference is</span><span>
</span><a name="line-591"></a><span class="hs-comment">--    sp0 - (sm_sp cont_stack - sm_args cont_stack + args)</span><span>
</span><a name="line-592"></a><span class="hs-identifier">spOffsetForCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-593"></a><a name="spOffsetForCall"><a href="CmmLayoutStack.html#spOffsetForCall"><span class="hs-identifier">spOffsetForCall</span></a></a><span> </span><a name="local-6989586621681193253"><a href="#local-6989586621681193253"><span class="hs-identifier">current_sp</span></a></a><span> </span><a name="local-6989586621681193254"><a href="#local-6989586621681193254"><span class="hs-identifier">cont_stack</span></a></a><span> </span><a name="local-6989586621681193255"><a href="#local-6989586621681193255"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-594"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193253"><span class="hs-identifier hs-var">current_sp</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193254"><span class="hs-identifier hs-var">cont_stack</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">sm_args</span><span> </span><a href="#local-6989586621681193254"><span class="hs-identifier hs-var">cont_stack</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681193255"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span class="hs-comment">-- | create a sequence of assignments to establish the new StackMap,</span><span>
</span><a name="line-598"></a><span class="hs-comment">-- given the old StackMap.</span><span>
</span><a name="line-599"></a><span class="hs-identifier">fixupStack</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-600"></a><a name="fixupStack"><a href="CmmLayoutStack.html#fixupStack"><span class="hs-identifier">fixupStack</span></a></a><span> </span><a name="local-6989586621681193256"><a href="#local-6989586621681193256"><span class="hs-identifier">old_stack</span></a></a><span> </span><a name="local-6989586621681193257"><a href="#local-6989586621681193257"><span class="hs-identifier">new_stack</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621681193260"><span class="hs-identifier hs-var">move</span></a><span> </span><a href="#local-6989586621681193259"><span class="hs-identifier hs-var">new_locs</span></a><span>
</span><a name="line-601"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-602"></a><span>     </span><a name="local-6989586621681193258"><a href="#local-6989586621681193258"><span class="hs-identifier">old_map</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><a href="#local-6989586621681193256"><span class="hs-identifier hs-var">old_stack</span></a><span>
</span><a name="line-603"></a><span>     </span><a name="local-6989586621681193259"><a href="#local-6989586621681193259"><span class="hs-identifier">new_locs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#stackSlotRegs"><span class="hs-identifier hs-var">stackSlotRegs</span></a><span> </span><a href="#local-6989586621681193257"><span class="hs-identifier hs-var">new_stack</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>     </span><a name="local-6989586621681193260"><a href="#local-6989586621681193260"><span class="hs-identifier">move</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681193261"><a href="#local-6989586621681193261"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621681193262"><a href="#local-6989586621681193262"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681193263"><a href="#local-6989586621681193263"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621681193258"><span class="hs-identifier hs-var">old_map</span></a><span> </span><a href="#local-6989586621681193261"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193262"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681193263"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-607"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span> </span><a href="#local-6989586621681193262"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>                               </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681193261"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-identifier">setupStackFrame</span><span>
</span><a name="line-613"></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-614"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>                 </span><span class="hs-comment">-- label of continuation</span><span>
</span><a name="line-615"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLive.html#CmmLocalLive"><span class="hs-identifier hs-type">CmmLocalLive</span></a><span>   </span><span class="hs-comment">-- liveness</span><span>
</span><a name="line-616"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>      </span><span class="hs-comment">-- updfr</span><span>
</span><a name="line-617"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>      </span><span class="hs-comment">-- bytes of return values on stack</span><span>
</span><a name="line-618"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>     </span><span class="hs-comment">-- current StackMap</span><span>
</span><a name="line-619"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>
</span><a name="line-621"></a><a name="setupStackFrame"><a href="CmmLayoutStack.html#setupStackFrame"><span class="hs-identifier">setupStackFrame</span></a></a><span> </span><a name="local-6989586621681193264"><a href="#local-6989586621681193264"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193265"><a href="#local-6989586621681193265"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681193266"><a href="#local-6989586621681193266"><span class="hs-identifier">liveness</span></a></a><span> </span><a name="local-6989586621681193267"><a href="#local-6989586621681193267"><span class="hs-identifier">updfr_off</span></a></a><span> </span><a name="local-6989586621681193268"><a href="#local-6989586621681193268"><span class="hs-identifier">ret_args</span></a></a><span> </span><a name="local-6989586621681193269"><a href="#local-6989586621681193269"><span class="hs-identifier">stack0</span></a></a><span>
</span><a name="line-622"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193273"><span class="hs-identifier hs-var">cont_stack</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193272"><span class="hs-identifier hs-var">assignments</span></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-624"></a><span>      </span><span class="hs-comment">-- get the set of LocalRegs live in the continuation</span><span>
</span><a name="line-625"></a><span>      </span><a name="local-6989586621681193270"><a href="#local-6989586621681193270"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span> </span><a href="#local-6989586621681193265"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681193266"><span class="hs-identifier hs-var">liveness</span></a><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span>      </span><span class="hs-comment">-- the stack from the base to updfr_off is off-limits.</span><span>
</span><a name="line-628"></a><span>      </span><span class="hs-comment">-- our new stack frame contains:</span><span>
</span><a name="line-629"></a><span>      </span><span class="hs-comment">--   * saved live variables</span><span>
</span><a name="line-630"></a><span>      </span><span class="hs-comment">--   * the return address [young(C) + 8]</span><span>
</span><a name="line-631"></a><span>      </span><span class="hs-comment">--   * the args for the call,</span><span>
</span><a name="line-632"></a><span>      </span><span class="hs-comment">--     which are replaced by the return values at the return</span><span>
</span><a name="line-633"></a><span>      </span><span class="hs-comment">--     point.</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span>      </span><span class="hs-comment">-- everything up to updfr_off is off-limits</span><span>
</span><a name="line-636"></a><span>      </span><span class="hs-comment">-- stack1 contains updfr_off, plus everything we need to save</span><span>
</span><a name="line-637"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621681193271"><a href="#local-6989586621681193271"><span class="hs-identifier">stack1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193272"><a href="#local-6989586621681193272"><span class="hs-identifier">assignments</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#allocate"><span class="hs-identifier hs-var">allocate</span></a><span> </span><a href="#local-6989586621681193264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193267"><span class="hs-identifier hs-var">updfr_off</span></a><span> </span><a href="#local-6989586621681193270"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621681193269"><span class="hs-identifier hs-var">stack0</span></a><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span>      </span><span class="hs-comment">-- And the Sp at the continuation is:</span><span>
</span><a name="line-640"></a><span>      </span><span class="hs-comment">--   sm_sp stack1 + ret_args</span><span>
</span><a name="line-641"></a><span>      </span><a name="local-6989586621681193273"><a href="#local-6989586621681193273"><span class="hs-identifier">cont_stack</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193271"><span class="hs-identifier hs-var">stack1</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193271"><span class="hs-identifier hs-var">stack1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681193268"><span class="hs-identifier hs-var">ret_args</span></a><span>
</span><a name="line-642"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193268"><span class="hs-identifier hs-var">ret_args</span></a><span>
</span><a name="line-643"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_ret_off</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193267"><span class="hs-identifier hs-var">updfr_off</span></a><span>
</span><a name="line-644"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- Note [diamond proc point]</span><span>
</span><a name="line-649"></a><span class="hs-comment">--</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- This special case looks for the pattern we get from a typical</span><span>
</span><a name="line-651"></a><span class="hs-comment">-- tagged case expression:</span><span>
</span><a name="line-652"></a><span class="hs-comment">--</span><span>
</span><a name="line-653"></a><span class="hs-comment">--    Sp[young(L1)] = L1</span><span>
</span><a name="line-654"></a><span class="hs-comment">--    if (R1 &amp; 7) != 0 goto L1 else goto L2</span><span>
</span><a name="line-655"></a><span class="hs-comment">--  L2:</span><span>
</span><a name="line-656"></a><span class="hs-comment">--    call [R1] returns to L1</span><span>
</span><a name="line-657"></a><span class="hs-comment">--  L1: live: {y}</span><span>
</span><a name="line-658"></a><span class="hs-comment">--    x = R1</span><span>
</span><a name="line-659"></a><span class="hs-comment">--</span><span>
</span><a name="line-660"></a><span class="hs-comment">-- If we let the generic case handle this, we get</span><span>
</span><a name="line-661"></a><span class="hs-comment">--</span><span>
</span><a name="line-662"></a><span class="hs-comment">--    Sp[-16] = L1</span><span>
</span><a name="line-663"></a><span class="hs-comment">--    if (R1 &amp; 7) != 0 goto L1a else goto L2</span><span>
</span><a name="line-664"></a><span class="hs-comment">--  L2:</span><span>
</span><a name="line-665"></a><span class="hs-comment">--    Sp[-8] = y</span><span>
</span><a name="line-666"></a><span class="hs-comment">--    Sp = Sp - 16</span><span>
</span><a name="line-667"></a><span class="hs-comment">--    call [R1] returns to L1</span><span>
</span><a name="line-668"></a><span class="hs-comment">--  L1a:</span><span>
</span><a name="line-669"></a><span class="hs-comment">--    Sp[-8] = y</span><span>
</span><a name="line-670"></a><span class="hs-comment">--    Sp = Sp - 16</span><span>
</span><a name="line-671"></a><span class="hs-comment">--    goto L1</span><span>
</span><a name="line-672"></a><span class="hs-comment">--  L1:</span><span>
</span><a name="line-673"></a><span class="hs-comment">--    x = R1</span><span>
</span><a name="line-674"></a><span class="hs-comment">--</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- The code for saving the live vars is duplicated in each branch, and</span><span>
</span><a name="line-676"></a><span class="hs-comment">-- furthermore there is an extra jump in the fast path (assuming L1 is</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- a proc point, which it probably is if there is a heap check).</span><span>
</span><a name="line-678"></a><span class="hs-comment">--</span><span>
</span><a name="line-679"></a><span class="hs-comment">-- So to fix this we want to set up the stack frame before the</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- conditional jump.  How do we know when to do this, and when it is</span><span>
</span><a name="line-681"></a><span class="hs-comment">-- safe?  The basic idea is, when we see the assignment</span><span>
</span><a name="line-682"></a><span class="hs-comment">--</span><span>
</span><a name="line-683"></a><span class="hs-comment">--   Sp[young(L)] = L</span><span>
</span><a name="line-684"></a><span class="hs-comment">--</span><span>
</span><a name="line-685"></a><span class="hs-comment">-- we know that</span><span>
</span><a name="line-686"></a><span class="hs-comment">--   * we are definitely heading for L</span><span>
</span><a name="line-687"></a><span class="hs-comment">--   * there can be no more reads from another stack area, because young(L)</span><span>
</span><a name="line-688"></a><span class="hs-comment">--     overlaps with it.</span><span>
</span><a name="line-689"></a><span class="hs-comment">--</span><span>
</span><a name="line-690"></a><span class="hs-comment">-- We don't necessarily know that everything live at L is live now</span><span>
</span><a name="line-691"></a><span class="hs-comment">-- (some might be assigned between here and the jump to L).  So we</span><span>
</span><a name="line-692"></a><span class="hs-comment">-- simplify and only do the optimisation when we see</span><span>
</span><a name="line-693"></a><span class="hs-comment">--</span><span>
</span><a name="line-694"></a><span class="hs-comment">--   (1) a block containing an assignment of a return address L</span><span>
</span><a name="line-695"></a><span class="hs-comment">--   (2) ending in a branch where one (and only) continuation goes to L,</span><span>
</span><a name="line-696"></a><span class="hs-comment">--       and no other continuations go to proc points.</span><span>
</span><a name="line-697"></a><span class="hs-comment">--</span><span>
</span><a name="line-698"></a><span class="hs-comment">-- then we allocate the stack frame for L at the end of the block,</span><span>
</span><a name="line-699"></a><span class="hs-comment">-- before the branch.</span><span>
</span><a name="line-700"></a><span class="hs-comment">--</span><span>
</span><a name="line-701"></a><span class="hs-comment">-- We could generalise (2), but that would make it a bit more</span><span>
</span><a name="line-702"></a><span class="hs-comment">-- complicated to handle, and this currently catches the common case.</span><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-identifier">futureContinuation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Block.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-705"></a><a name="futureContinuation"><a href="CmmLayoutStack.html#futureContinuation"><span class="hs-identifier">futureContinuation</span></a></a><span> </span><a name="local-6989586621681193274"><a href="#local-6989586621681193274"><span class="hs-identifier">middle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#foldBlockNodesB"><span class="hs-identifier hs-var">foldBlockNodesB</span></a><span> </span><a href="#local-6989586621681193275"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681193274"><span class="hs-identifier hs-var">middle</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-706"></a><span>   </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621681193276"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621681193277"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-707"></a><span>         </span><a name="local-6989586621681193275"><a href="#local-6989586621681193275"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a name="local-6989586621681193278"><a href="#local-6989586621681193278"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmBlock"><span class="hs-identifier hs-var">CmmBlock</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-708"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681193278"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-709"></a><span>         </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193279"><a href="#local-6989586621681193279"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193279"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-712"></a><span class="hs-comment">-- Saving live registers</span><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span class="hs-comment">-- | Given a set of live registers and a StackMap, save all the registers</span><span>
</span><a name="line-715"></a><span class="hs-comment">-- on the stack and return the new StackMap and the assignments to do</span><span>
</span><a name="line-716"></a><span class="hs-comment">-- the saving.</span><span>
</span><a name="line-717"></a><span class="hs-comment">--</span><span>
</span><a name="line-718"></a><span class="hs-identifier">allocate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalRegSet"><span class="hs-identifier hs-type">LocalRegSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-719"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-720"></a><a name="allocate"><a href="CmmLayoutStack.html#allocate"><span class="hs-identifier">allocate</span></a></a><span> </span><a name="local-6989586621681193280"><a href="#local-6989586621681193280"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193281"><a href="#local-6989586621681193281"><span class="hs-identifier">ret_off</span></a></a><span> </span><a name="local-6989586621681193282"><a href="#local-6989586621681193282"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621681193283"><a href="#local-6989586621681193283"><span class="hs-identifier">stackmap</span></a></a><span class="hs-glyph">@</span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-var">StackMap</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681193284"><a href="#local-6989586621681193284"><span class="hs-identifier">sp0</span></a></a><span>
</span><a name="line-721"></a><span>                                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681193285"><a href="#local-6989586621681193285"><span class="hs-identifier">regs0</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-722"></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-723"></a><span>   </span><span class="hs-comment">-- we only have to save regs that are not already in a slot</span><span>
</span><a name="line-724"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193286"><a href="#local-6989586621681193286"><span class="hs-identifier">to_save</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemUFM</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193285"><span class="hs-identifier hs-var">regs0</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.elems</span><span> </span><a href="#local-6989586621681193282"><span class="hs-identifier hs-var">live</span></a><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>       </span><a name="local-6989586621681193287"><a href="#local-6989586621681193287"><span class="hs-identifier">regs1</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterUFM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681193288"><a href="#local-6989586621681193288"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#elemRegSet"><span class="hs-identifier hs-var">elemRegSet</span></a><span> </span><a href="#local-6989586621681193288"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621681193282"><span class="hs-identifier hs-var">live</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193285"><span class="hs-identifier hs-var">regs0</span></a><span>
</span><a name="line-726"></a><span>   </span><span class="hs-keyword">in</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span>   </span><span class="hs-comment">-- make a map of the stack</span><span>
</span><a name="line-729"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193289"><a href="#local-6989586621681193289"><span class="hs-identifier">stack</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Array.elems</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-730"></a><span>               </span><span class="hs-identifier hs-var">accumArray</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193297"><a href="#local-6989586621681193297"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193297"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="CmmLayoutStack.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-6989586621681193284"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193281"><span class="hs-identifier hs-var">ret_off</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-731"></a><span>                 </span><a href="#local-6989586621681193290"><span class="hs-identifier hs-var">ret_words</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681193291"><span class="hs-identifier hs-var">live_words</span></a><span>
</span><a name="line-732"></a><span>            </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193290"><a href="#local-6989586621681193290"><span class="hs-identifier">ret_words</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-733"></a><span>                   </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193292"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier hs-var">Occupied</span></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681193292"><a href="#local-6989586621681193292"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">..</span><span> </span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193281"><span class="hs-identifier hs-var">ret_off</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-735"></a><span>                  </span><a name="local-6989586621681193291"><a href="#local-6989586621681193291"><span class="hs-identifier">live_words</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-736"></a><span>                   </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193296"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier hs-var">Occupied</span></a><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193293"><a href="#local-6989586621681193293"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621681193294"><a href="#local-6989586621681193294"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUFM</span><span> </span><a href="#local-6989586621681193287"><span class="hs-identifier hs-var">regs1</span></a><span class="hs-special">,</span><span>
</span><a name="line-738"></a><span>                   </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-739"></a><span>                     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193295"><a href="#local-6989586621681193295"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#localRegBytes"><span class="hs-identifier hs-var">localRegBytes</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193293"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span>
</span><a name="line-740"></a><span>                     </span><a name="local-6989586621681193296"><a href="#local-6989586621681193296"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681193294"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193294"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621681193294"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193295"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-741"></a><span>   </span><span class="hs-keyword">in</span><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span>   </span><span class="hs-comment">-- Pass over the stack: find slots to save all the new live variables,</span><span>
</span><a name="line-744"></a><span>   </span><span class="hs-comment">-- choosing the oldest slots first (hence a foldr).</span><span>
</span><a name="line-745"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-746"></a><span>       </span><a name="local-6989586621681193298"><a href="#local-6989586621681193298"><span class="hs-identifier">save</span></a></a><span> </span><a name="local-6989586621681193310"><a href="#local-6989586621681193310"><span class="hs-identifier">slot</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681193311"><a href="#local-6989586621681193311"><span class="hs-identifier">stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193312"><a href="#local-6989586621681193312"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193313"><a href="#local-6989586621681193313"><span class="hs-identifier">assigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193314"><a href="#local-6989586621681193314"><span class="hs-identifier">regs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- no more regs to save</span><span>
</span><a name="line-747"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193310"><span class="hs-identifier hs-var">slot</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681193311"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#plusW"><span class="hs-identifier hs-var">plusW</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193312"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193313"><span class="hs-identifier hs-var">assigs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193314"><span class="hs-identifier hs-var">regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>       </span><span class="hs-identifier">save</span><span> </span><a name="local-6989586621681193315"><a href="#local-6989586621681193315"><span class="hs-identifier">slot</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681193316"><a href="#local-6989586621681193316"><span class="hs-identifier">to_save</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193317"><a href="#local-6989586621681193317"><span class="hs-identifier">stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193318"><a href="#local-6989586621681193318"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193319"><a href="#local-6989586621681193319"><span class="hs-identifier">assigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193320"><a href="#local-6989586621681193320"><span class="hs-identifier">regs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681193315"><span class="hs-identifier hs-var">slot</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-750"></a><span>               </span><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier hs-var">Occupied</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621681193316"><span class="hs-identifier hs-var">to_save</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier hs-var">Occupied</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681193317"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#plusW"><span class="hs-identifier hs-var">plusW</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193318"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193319"><span class="hs-identifier hs-var">assigs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193320"><span class="hs-identifier hs-var">regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>               </span><a href="CmmLayoutStack.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span>
</span><a name="line-752"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193321"><a href="#local-6989586621681193321"><span class="hs-identifier">stack'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193322"><a href="#local-6989586621681193322"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193323"><a href="#local-6989586621681193323"><span class="hs-identifier">to_save'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-753"></a><span>                       </span><a href="#local-6989586621681193299"><span class="hs-identifier hs-var">select_save</span></a><span> </span><a href="#local-6989586621681193316"><span class="hs-identifier hs-var">to_save</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193315"><span class="hs-identifier hs-var">slot</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681193317"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193324"><a href="#local-6989586621681193324"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span> </span><a href="#local-6989586621681193325"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span>                                         </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681193322"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>                        </span><a name="local-6989586621681193325"><a href="#local-6989586621681193325"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#plusW"><span class="hs-identifier hs-var">plusW</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193318"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-757"></a><span>                   </span><span class="hs-keyword">in</span><span>
</span><a name="line-758"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621681193323"><span class="hs-identifier hs-var">to_save'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193321"><span class="hs-identifier hs-var">stack'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193325"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193324"><span class="hs-identifier hs-var">assig</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681193319"><span class="hs-identifier hs-var">assigs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193322"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="#local-6989586621681193322"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><a href="#local-6989586621681193325"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621681193320"><span class="hs-identifier hs-var">regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-761"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193316"><span class="hs-identifier hs-var">to_save</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193315"><span class="hs-identifier hs-var">slot</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681193317"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#plusW"><span class="hs-identifier hs-var">plusW</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193318"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193319"><span class="hs-identifier hs-var">assigs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193320"><span class="hs-identifier hs-var">regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span>       </span><span class="hs-comment">-- we should do better here: right now we'll fit the smallest first,</span><span>
</span><a name="line-764"></a><span>       </span><span class="hs-comment">-- but it would make more sense to fit the biggest first.</span><span>
</span><a name="line-765"></a><span>       </span><span class="hs-identifier">select_save</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span class="hs-special">]</span><span>
</span><a name="line-766"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>       </span><a name="local-6989586621681193299"><a href="#local-6989586621681193299"><span class="hs-identifier">select_save</span></a></a><span> </span><a name="local-6989586621681193326"><a href="#local-6989586621681193326"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621681193327"><a href="#local-6989586621681193327"><span class="hs-identifier">stack</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193328"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681193326"><span class="hs-identifier hs-var">regs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-768"></a><span>         </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193328"><a href="#local-6989586621681193328"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><a name="local-6989586621681193329"><a href="#local-6989586621681193329"><span class="hs-identifier">_no_fit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-769"></a><span>               </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193330"><a href="#local-6989586621681193330"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681193331"><a href="#local-6989586621681193331"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681193332"><a href="#local-6989586621681193332"><span class="hs-identifier">no_fit</span></a></a><span>
</span><a name="line-770"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193334"><a href="#local-6989586621681193334"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmLayoutStack.html#dropEmpty"><span class="hs-identifier hs-var">dropEmpty</span></a><span> </span><a href="#local-6989586621681193333"><span class="hs-identifier hs-var">words</span></a><span> </span><a href="#local-6989586621681193327"><span class="hs-identifier hs-var">stack</span></a><span>
</span><a name="line-771"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621681193333"><span class="hs-identifier hs-var">words</span></a><span> </span><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier hs-var">Occupied</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681193334"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193330"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193331"><span class="hs-identifier hs-var">rs</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621681193332"><span class="hs-identifier hs-var">no_fit</span></a><span class="hs-special">)</span><span>
</span><a name="line-772"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-773"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193328"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681193331"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193330"><span class="hs-identifier hs-var">r</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681193332"><span class="hs-identifier hs-var">no_fit</span></a><span class="hs-special">)</span><span>
</span><a name="line-774"></a><span>                 </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193333"><a href="#local-6989586621681193333"><span class="hs-identifier">words</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#localRegWords"><span class="hs-identifier hs-var">localRegWords</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193330"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span>       </span><span class="hs-comment">-- fill in empty slots as much as possible</span><span>
</span><a name="line-777"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621681193300"><a href="#local-6989586621681193300"><span class="hs-identifier">still_to_save</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193301"><a href="#local-6989586621681193301"><span class="hs-identifier">save_stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193302"><a href="#local-6989586621681193302"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193303"><a href="#local-6989586621681193303"><span class="hs-identifier">save_assigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193304"><a href="#local-6989586621681193304"><span class="hs-identifier">save_regs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621681193298"><span class="hs-identifier hs-var">save</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193286"><span class="hs-identifier hs-var">to_save</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193289"><span class="hs-identifier hs-var">stack</span></a><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>       </span><span class="hs-comment">-- push any remaining live vars on the stack</span><span>
</span><a name="line-781"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621681193305"><a href="#local-6989586621681193305"><span class="hs-identifier">push_sp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193306"><a href="#local-6989586621681193306"><span class="hs-identifier">push_assigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193307"><a href="#local-6989586621681193307"><span class="hs-identifier">push_regs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621681193335"><span class="hs-identifier hs-var">push</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193302"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193300"><span class="hs-identifier hs-var">still_to_save</span></a><span>
</span><a name="line-783"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-784"></a><span>              </span><a name="local-6989586621681193335"><a href="#local-6989586621681193335"><span class="hs-identifier">push</span></a></a><span> </span><a name="local-6989586621681193336"><a href="#local-6989586621681193336"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681193337"><a href="#local-6989586621681193337"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193338"><a href="#local-6989586621681193338"><span class="hs-identifier">assigs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193339"><a href="#local-6989586621681193339"><span class="hs-identifier">regs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193340"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193341"><span class="hs-identifier hs-var">assig</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681193338"><span class="hs-identifier hs-var">assigs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193336"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="#local-6989586621681193336"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><a href="#local-6989586621681193340"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681193339"><span class="hs-identifier hs-var">regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-786"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-787"></a><span>                  </span><a name="local-6989586621681193340"><a href="#local-6989586621681193340"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193337"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="CmmLayoutStack.html#localRegBytes"><span class="hs-identifier hs-var">localRegBytes</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193336"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-788"></a><span>                  </span><a name="local-6989586621681193341"><a href="#local-6989586621681193341"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span> </span><a href="#local-6989586621681193340"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">)</span><span>
</span><a name="line-789"></a><span>                                   </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681193336"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-790"></a><span>
</span><a name="line-791"></a><span>       </span><a name="local-6989586621681193308"><a href="#local-6989586621681193308"><span class="hs-identifier">trim_sp</span></a></a><span>
</span><a name="line-792"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681193307"><span class="hs-identifier hs-var">push_regs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193305"><span class="hs-identifier hs-var">push_sp</span></a><span>
</span><a name="line-793"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-794"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#plusW"><span class="hs-identifier hs-var">plusW</span></a><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193302"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><a href="CmmLayoutStack.html#isEmpty"><span class="hs-identifier hs-var">isEmpty</span></a><span> </span><a href="#local-6989586621681193301"><span class="hs-identifier hs-var">save_stack</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span>       </span><a name="local-6989586621681193309"><a href="#local-6989586621681193309"><span class="hs-identifier">final_regs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193287"><span class="hs-identifier hs-var">regs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addListToUFM</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193307"><span class="hs-identifier hs-var">push_regs</span></a><span>
</span><a name="line-797"></a><span>                          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addListToUFM</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193304"><span class="hs-identifier hs-var">save_regs</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span>   </span><span class="hs-keyword">in</span><span>
</span><a name="line-800"></a><span>  </span><span class="hs-comment">-- XXX should be an assert</span><span>
</span><a name="line-801"></a><span>   </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621681193302"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-6989586621681193284"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193281"><span class="hs-identifier hs-var">ret_off</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;allocate&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193302"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193284"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193281"><span class="hs-identifier hs-var">ret_off</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-802"></a><span>
</span><a name="line-803"></a><span>   </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193308"><span class="hs-identifier hs-var">trim_sp</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;allocate2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193308"><span class="hs-identifier hs-var">trim_sp</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193309"><span class="hs-identifier hs-var">final_regs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193305"><span class="hs-identifier hs-var">push_sp</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-804"></a><span>
</span><a name="line-805"></a><span>   </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621681193283"><span class="hs-identifier hs-var">stackmap</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193309"><span class="hs-identifier hs-var">final_regs</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193308"><span class="hs-identifier hs-var">trim_sp</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-806"></a><span>   </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193306"><span class="hs-identifier hs-var">push_assigs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681193303"><span class="hs-identifier hs-var">save_assigs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-810"></a><span class="hs-comment">-- Manifesting Sp</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span class="hs-comment">-- | Manifest Sp: turn all the CmmStackSlots into CmmLoads from Sp.  The</span><span>
</span><a name="line-813"></a><span class="hs-comment">-- block looks like this:</span><span>
</span><a name="line-814"></a><span class="hs-comment">--</span><span>
</span><a name="line-815"></a><span class="hs-comment">--    middle_pre       -- the middle nodes</span><span>
</span><a name="line-816"></a><span class="hs-comment">--    Sp = Sp + sp_off -- Sp adjustment goes here</span><span>
</span><a name="line-817"></a><span class="hs-comment">--    last             -- the last node</span><span>
</span><a name="line-818"></a><span class="hs-comment">--</span><span>
</span><a name="line-819"></a><span class="hs-comment">-- And we have some extra blocks too (that don't contain Sp adjustments)</span><span>
</span><a name="line-820"></a><span class="hs-comment">--</span><span>
</span><a name="line-821"></a><span class="hs-comment">-- The adjustment for middle_pre will be different from that for</span><span>
</span><a name="line-822"></a><span class="hs-comment">-- middle_post, because the Sp adjustment intervenes.</span><span>
</span><a name="line-823"></a><span class="hs-comment">--</span><span>
</span><a name="line-824"></a><span class="hs-identifier">manifestSp</span><span>
</span><a name="line-825"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-826"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>  </span><span class="hs-comment">-- StackMaps for other blocks</span><span>
</span><a name="line-827"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>           </span><span class="hs-comment">-- StackMap for this block</span><span>
</span><a name="line-828"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>            </span><span class="hs-comment">-- Sp on entry to the block</span><span>
</span><a name="line-829"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>            </span><span class="hs-comment">-- SpHigh</span><span>
</span><a name="line-830"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>        </span><span class="hs-comment">-- first node</span><span>
</span><a name="line-831"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- middle</span><span>
</span><a name="line-832"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>            </span><span class="hs-comment">-- sp_off</span><span>
</span><a name="line-833"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>        </span><span class="hs-comment">-- last node</span><span>
</span><a name="line-834"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- new blocks</span><span>
</span><a name="line-835"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- final blocks with Sp manifest</span><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><a name="manifestSp"><a href="CmmLayoutStack.html#manifestSp"><span class="hs-identifier">manifestSp</span></a></a><span> </span><a name="local-6989586621681193342"><a href="#local-6989586621681193342"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193343"><a href="#local-6989586621681193343"><span class="hs-identifier">stackmaps</span></a></a><span> </span><a name="local-6989586621681193344"><a href="#local-6989586621681193344"><span class="hs-identifier">stack0</span></a></a><span> </span><a name="local-6989586621681193345"><a href="#local-6989586621681193345"><span class="hs-identifier">sp0</span></a></a><span> </span><a name="local-6989586621681193346"><a href="#local-6989586621681193346"><span class="hs-identifier">sp_high</span></a></a><span>
</span><a name="line-838"></a><span>           </span><a name="local-6989586621681193347"><a href="#local-6989586621681193347"><span class="hs-identifier">first</span></a></a><span> </span><a name="local-6989586621681193348"><a href="#local-6989586621681193348"><span class="hs-identifier">middle_pre</span></a></a><span> </span><a name="local-6989586621681193349"><a href="#local-6989586621681193349"><span class="hs-identifier">sp_off</span></a></a><span> </span><a name="local-6989586621681193350"><a href="#local-6989586621681193350"><span class="hs-identifier">last</span></a></a><span> </span><a name="local-6989586621681193351"><a href="#local-6989586621681193351"><span class="hs-identifier">fixup_blocks</span></a></a><span>
</span><a name="line-839"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193357"><span class="hs-identifier hs-var">final_block</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681193358"><span class="hs-identifier hs-var">fixup_blocks'</span></a><span>
</span><a name="line-840"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-841"></a><span>    </span><a name="local-6989586621681193352"><a href="#local-6989586621681193352"><span class="hs-identifier">area_off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#getAreaOff"><span class="hs-identifier hs-var">getAreaOff</span></a><span> </span><a href="#local-6989586621681193343"><span class="hs-identifier hs-var">stackmaps</span></a><span>
</span><a name="line-842"></a><span>
</span><a name="line-843"></a><span>    </span><span class="hs-identifier">adj_pre_sp</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">adj_post_sp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621681193359"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621681193360"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621681193359"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621681193360"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-844"></a><span>    </span><a name="local-6989586621681193353"><a href="#local-6989586621681193353"><span class="hs-identifier">adj_pre_sp</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapExpDeep"><span class="hs-identifier hs-var">mapExpDeep</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#areaToSp"><span class="hs-identifier hs-var">areaToSp</span></a><span> </span><a href="#local-6989586621681193342"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193345"><span class="hs-identifier hs-var">sp0</span></a><span>            </span><a href="#local-6989586621681193346"><span class="hs-identifier hs-var">sp_high</span></a><span> </span><a href="#local-6989586621681193352"><span class="hs-identifier hs-var">area_off</span></a><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>    </span><a name="local-6989586621681193354"><a href="#local-6989586621681193354"><span class="hs-identifier">adj_post_sp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapExpDeep"><span class="hs-identifier hs-var">mapExpDeep</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#areaToSp"><span class="hs-identifier hs-var">areaToSp</span></a><span> </span><a href="#local-6989586621681193342"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193345"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193349"><span class="hs-identifier hs-var">sp_off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193346"><span class="hs-identifier hs-var">sp_high</span></a><span> </span><a href="#local-6989586621681193352"><span class="hs-identifier hs-var">area_off</span></a><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span>    </span><a name="local-6989586621681193355"><a href="#local-6989586621681193355"><span class="hs-identifier">final_middle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#maybeAddSpAdj"><span class="hs-identifier hs-var">maybeAddSpAdj</span></a><span> </span><a href="#local-6989586621681193342"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193345"><span class="hs-identifier hs-var">sp0</span></a><span> </span><a href="#local-6989586621681193349"><span class="hs-identifier hs-var">sp_off</span></a><span>
</span><a name="line-848"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><a href="Hoopl.Block.html#blockFromList"><span class="hs-identifier hs-var">blockFromList</span></a><span>
</span><a name="line-849"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681193353"><span class="hs-identifier hs-var">adj_pre_sp</span></a><span>
</span><a name="line-850"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmLayoutStack.html#elimStackStores"><span class="hs-identifier hs-var">elimStackStores</span></a><span> </span><a href="#local-6989586621681193344"><span class="hs-identifier hs-var">stack0</span></a><span> </span><a href="#local-6989586621681193343"><span class="hs-identifier hs-var">stackmaps</span></a><span> </span><a href="#local-6989586621681193352"><span class="hs-identifier hs-var">area_off</span></a><span>
</span><a name="line-851"></a><span>                 </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681193348"><span class="hs-identifier hs-var">middle_pre</span></a><span>
</span><a name="line-852"></a><span>    </span><a name="local-6989586621681193356"><a href="#local-6989586621681193356"><span class="hs-identifier">final_last</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#optStackCheck"><span class="hs-identifier hs-var">optStackCheck</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193354"><span class="hs-identifier hs-var">adj_post_sp</span></a><span> </span><a href="#local-6989586621681193350"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span>    </span><a name="local-6989586621681193357"><a href="#local-6989586621681193357"><span class="hs-identifier">final_block</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockJoin"><span class="hs-identifier hs-var">blockJoin</span></a><span> </span><a href="#local-6989586621681193347"><span class="hs-identifier hs-var">first</span></a><span> </span><a href="#local-6989586621681193355"><span class="hs-identifier hs-var">final_middle</span></a><span> </span><a href="#local-6989586621681193356"><span class="hs-identifier hs-var">final_last</span></a><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span>    </span><a name="local-6989586621681193358"><a href="#local-6989586621681193358"><span class="hs-identifier">fixup_blocks'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#mapBlock3%27"><span class="hs-identifier hs-var">mapBlock3'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">id</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193354"><span class="hs-identifier hs-var">adj_post_sp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193351"><span class="hs-identifier hs-var">fixup_blocks</span></a><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span class="hs-identifier">getAreaOff</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Area"><span class="hs-identifier hs-type">Area</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier hs-type">StackLoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-859"></a><a name="getAreaOff"><a href="CmmLayoutStack.html#getAreaOff"><span class="hs-identifier">getAreaOff</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-860"></a><span class="hs-identifier">getAreaOff</span><span> </span><a name="local-6989586621681193361"><a href="#local-6989586621681193361"><span class="hs-identifier">stackmaps</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a name="local-6989586621681193362"><a href="#local-6989586621681193362"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-861"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621681193362"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193361"><span class="hs-identifier hs-var">stackmaps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-862"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193363"><a href="#local-6989586621681193363"><span class="hs-identifier">sm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193363"><span class="hs-identifier hs-var">sm</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">sm_args</span><span> </span><a href="#local-6989586621681193363"><span class="hs-identifier hs-var">sm</span></a><span>
</span><a name="line-863"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;getAreaOff&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193362"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span class="hs-identifier">maybeAddSpAdj</span><span>
</span><a name="line-867"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Block.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Block.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-868"></a><a name="maybeAddSpAdj"><a href="CmmLayoutStack.html#maybeAddSpAdj"><span class="hs-identifier">maybeAddSpAdj</span></a></a><span> </span><a name="local-6989586621681193364"><a href="#local-6989586621681193364"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193365"><a href="#local-6989586621681193365"><span class="hs-identifier">sp0</span></a></a><span> </span><a name="local-6989586621681193366"><a href="#local-6989586621681193366"><span class="hs-identifier">sp_off</span></a></a><span> </span><a name="local-6989586621681193367"><a href="#local-6989586621681193367"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-869"></a><span>  </span><a href="#local-6989586621681193369"><span class="hs-identifier hs-var">add_initial_unwind</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681193370"><span class="hs-identifier hs-var">add_adj_unwind</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681193368"><span class="hs-identifier hs-var">adj</span></a><span> </span><a href="#local-6989586621681193367"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-870"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-871"></a><span>    </span><a name="local-6989586621681193368"><a href="#local-6989586621681193368"><span class="hs-identifier">adj</span></a></a><span> </span><a name="local-6989586621681193371"><a href="#local-6989586621681193371"><span class="hs-identifier">block</span></a></a><span>
</span><a name="line-872"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681193366"><span class="hs-identifier hs-var">sp_off</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-873"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193371"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Block.html#blockSnoc"><span class="hs-identifier hs-var">blockSnoc</span></a><span class="hs-special">`</span><span> </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a href="CmmExpr.html#spReg"><span class="hs-identifier hs-var">spReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621681193364"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmUtils.html#spExpr"><span class="hs-identifier hs-var">spExpr</span></a><span> </span><a href="#local-6989586621681193366"><span class="hs-identifier hs-var">sp_off</span></a><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193371"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-875"></a><span>    </span><span class="hs-comment">-- Add unwind pseudo-instruction at the beginning of each block to</span><span>
</span><a name="line-876"></a><span>    </span><span class="hs-comment">-- document Sp level for debugging</span><span>
</span><a name="line-877"></a><span>    </span><a name="local-6989586621681193369"><a href="#local-6989586621681193369"><span class="hs-identifier">add_initial_unwind</span></a></a><span> </span><a name="local-6989586621681193372"><a href="#local-6989586621681193372"><span class="hs-identifier">block</span></a></a><span>
</span><a name="line-878"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621681193364"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-879"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#Sp"><span class="hs-identifier hs-var">Sp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681193373"><span class="hs-identifier hs-var">sp_unwind</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">`</span><a href="Hoopl.Block.html#blockCons"><span class="hs-identifier hs-var">blockCons</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193372"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-880"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-881"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193372"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-882"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193373"><a href="#local-6989586621681193373"><span class="hs-identifier">sp_unwind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmRegOff"><span class="hs-identifier hs-var">CmmRegOff</span></a><span> </span><a href="CmmExpr.html#spReg"><span class="hs-identifier hs-var">spReg</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193365"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193364"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>
</span><a name="line-884"></a><span>    </span><span class="hs-comment">-- Add unwind pseudo-instruction right after the Sp adjustment</span><span>
</span><a name="line-885"></a><span>    </span><span class="hs-comment">-- if there is one.</span><span>
</span><a name="line-886"></a><span>    </span><a name="local-6989586621681193370"><a href="#local-6989586621681193370"><span class="hs-identifier">add_adj_unwind</span></a></a><span> </span><a name="local-6989586621681193374"><a href="#local-6989586621681193374"><span class="hs-identifier">block</span></a></a><span>
</span><a name="line-887"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621681193364"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-888"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193366"><span class="hs-identifier hs-var">sp_off</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-889"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193374"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Block.html#blockSnoc"><span class="hs-identifier hs-var">blockSnoc</span></a><span class="hs-special">`</span><span> </span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#Sp"><span class="hs-identifier hs-var">Sp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681193375"><span class="hs-identifier hs-var">sp_unwind</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-890"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-891"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193374"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-892"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681193375"><a href="#local-6989586621681193375"><span class="hs-identifier">sp_unwind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmRegOff"><span class="hs-identifier hs-var">CmmRegOff</span></a><span> </span><a href="CmmExpr.html#spReg"><span class="hs-identifier hs-var">spReg</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193365"><span class="hs-identifier hs-var">sp0</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193364"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193366"><span class="hs-identifier hs-var">sp_off</span></a><span class="hs-special">)</span><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span class="hs-comment">{- Note [SP old/young offsets]

Sp(L) is the Sp offset on entry to block L relative to the base of the
OLD area.

SpArgs(L) is the size of the young area for L, i.e. the number of
arguments.

 - in block L, each reference to [old + N] turns into
   [Sp + Sp(L) - N]

 - in block L, each reference to [young(L') + N] turns into
   [Sp + Sp(L) - Sp(L') + SpArgs(L') - N]

 - be careful with the last node of each block: Sp has already been adjusted
   to be Sp + Sp(L) - Sp(L')
-}</span><span>
</span><a name="line-911"></a><span>
</span><a name="line-912"></a><span class="hs-identifier">areaToSp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Area"><span class="hs-identifier hs-type">Area</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier hs-type">StackLoc</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><a name="areaToSp"><a href="CmmLayoutStack.html#areaToSp"><span class="hs-identifier">areaToSp</span></a></a><span> </span><a name="local-6989586621681193376"><a href="#local-6989586621681193376"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193377"><a href="#local-6989586621681193377"><span class="hs-identifier">sp_old</span></a></a><span> </span><a name="local-6989586621681193378"><a href="#local-6989586621681193378"><span class="hs-identifier">_sp_hwm</span></a></a><span> </span><a name="local-6989586621681193379"><a href="#local-6989586621681193379"><span class="hs-identifier">area_off</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a name="local-6989586621681193380"><a href="#local-6989586621681193380"><span class="hs-identifier">area</span></a></a><span> </span><a name="local-6989586621681193381"><a href="#local-6989586621681193381"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621681193376"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmUtils.html#spExpr"><span class="hs-identifier hs-var">spExpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193377"><span class="hs-identifier hs-var">sp_old</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193379"><span class="hs-identifier hs-var">area_off</span></a><span> </span><a href="#local-6989586621681193380"><span class="hs-identifier hs-var">area</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193381"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-916"></a><span>    </span><span class="hs-comment">-- Replace (CmmStackSlot area n) with an offset from Sp</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-identifier">areaToSp</span><span> </span><a name="local-6989586621681193382"><a href="#local-6989586621681193382"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193383"><a href="#local-6989586621681193383"><span class="hs-identifier">sp_hwm</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><a href="CmmExpr.html#CmmHighStackMark"><span class="hs-identifier hs-var">CmmHighStackMark</span></a><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621681193382"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193383"><span class="hs-identifier hs-var">sp_hwm</span></a><span>
</span><a name="line-920"></a><span>    </span><span class="hs-comment">-- Replace CmmHighStackMark with the number of bytes of stack used,</span><span>
</span><a name="line-921"></a><span>    </span><span class="hs-comment">-- the sp_hwm.   See Note [Stack usage] in StgCmmHeap</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span class="hs-identifier">areaToSp</span><span> </span><a name="local-6989586621681193384"><a href="#local-6989586621681193384"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_U_Lt"><span class="hs-identifier hs-var">MO_U_Lt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681193385"><a href="#local-6989586621681193385"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CmmLayoutStack.html#falseStackCheck"><span class="hs-identifier hs-var">falseStackCheck</span></a><span> </span><a href="#local-6989586621681193385"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-925"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#zeroExpr"><span class="hs-identifier hs-var">zeroExpr</span></a><span> </span><a href="#local-6989586621681193384"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-926"></a><span class="hs-identifier">areaToSp</span><span> </span><a name="local-6989586621681193386"><a href="#local-6989586621681193386"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_U_Ge"><span class="hs-identifier hs-var">MO_U_Ge</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681193387"><a href="#local-6989586621681193387"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CmmLayoutStack.html#falseStackCheck"><span class="hs-identifier hs-var">falseStackCheck</span></a><span> </span><a href="#local-6989586621681193387"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621681193386"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-929"></a><span>    </span><span class="hs-comment">-- Replace a stack-overflow test that cannot fail with a no-op</span><span>
</span><a name="line-930"></a><span>    </span><span class="hs-comment">-- See Note [Always false stack check]</span><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span class="hs-identifier">areaToSp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193388"><a href="#local-6989586621681193388"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193388"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-933"></a><span>
</span><a name="line-934"></a><span class="hs-comment">-- | Determine whether a stack check cannot fail.</span><span>
</span><a name="line-935"></a><span class="hs-identifier">falseStackCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-936"></a><a name="falseStackCheck"><a href="CmmLayoutStack.html#falseStackCheck"><span class="hs-identifier">falseStackCheck</span></a></a><span> </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Sub"><span class="hs-identifier hs-var">MO_Sub</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-937"></a><span>                      </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmRegOff"><span class="hs-identifier hs-var">CmmRegOff</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#Sp"><span class="hs-identifier hs-var">Sp</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681193389"><a href="#local-6989586621681193389"><span class="hs-identifier">x_off</span></a></a><span>
</span><a name="line-938"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><a name="local-6989586621681193390"><a href="#local-6989586621681193390"><span class="hs-identifier">y_lit</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-939"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#SpLim"><span class="hs-identifier hs-var">SpLim</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-940"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621681193389"><span class="hs-identifier hs-var">x_off</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621681193390"><span class="hs-identifier hs-var">y_lit</span></a><span>
</span><a name="line-941"></a><span class="hs-identifier">falseStackCheck</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span class="hs-comment">-- Note [Always false stack check]</span><span>
</span><a name="line-944"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-945"></a><span class="hs-comment">-- We can optimise stack checks of the form</span><span>
</span><a name="line-946"></a><span class="hs-comment">--</span><span>
</span><a name="line-947"></a><span class="hs-comment">--   if ((Sp + x) - y &lt; SpLim) then .. else ..</span><span>
</span><a name="line-948"></a><span class="hs-comment">--</span><span>
</span><a name="line-949"></a><span class="hs-comment">-- where are non-negative integer byte offsets.  Since we know that</span><span>
</span><a name="line-950"></a><span class="hs-comment">-- SpLim &lt;= Sp (remember the stack grows downwards), this test must</span><span>
</span><a name="line-951"></a><span class="hs-comment">-- yield False if (x &gt;= y), so we can rewrite the comparison to False.</span><span>
</span><a name="line-952"></a><span class="hs-comment">-- A subsequent sinking pass will later drop the dead code.</span><span>
</span><a name="line-953"></a><span class="hs-comment">-- Optimising this away depends on knowing that SpLim &lt;= Sp, so it is</span><span>
</span><a name="line-954"></a><span class="hs-comment">-- really the job of the stack layout algorithm, hence we do it now.</span><span>
</span><a name="line-955"></a><span class="hs-comment">--</span><span>
</span><a name="line-956"></a><span class="hs-comment">-- The control flow optimiser may negate a conditional to increase</span><span>
</span><a name="line-957"></a><span class="hs-comment">-- the likelihood of a fallthrough if the branch is not taken.  But</span><span>
</span><a name="line-958"></a><span class="hs-comment">-- not every conditional is inverted as the control flow optimiser</span><span>
</span><a name="line-959"></a><span class="hs-comment">-- places some requirements on the predecessors of both branch targets.</span><span>
</span><a name="line-960"></a><span class="hs-comment">-- So we better look for the inverted comparison too.</span><span>
</span><a name="line-961"></a><span>
</span><a name="line-962"></a><span class="hs-identifier">optStackCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-963"></a><a name="optStackCheck"><a href="CmmLayoutStack.html#optStackCheck"><span class="hs-identifier">optStackCheck</span></a></a><span> </span><a name="local-6989586621681193391"><a href="#local-6989586621681193391"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Note [Always false stack check]</span><span>
</span><a name="line-964"></a><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681193391"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-965"></a><span>   </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681193392"><a href="#local-6989586621681193392"><span class="hs-identifier">_true</span></a></a><span> </span><a name="local-6989586621681193393"><a href="#local-6989586621681193393"><span class="hs-identifier">false</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621681193393"><span class="hs-identifier hs-var">false</span></a><span>
</span><a name="line-966"></a><span>   </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681193394"><a href="#local-6989586621681193394"><span class="hs-identifier">true</span></a></a><span> </span><a name="local-6989586621681193395"><a href="#local-6989586621681193395"><span class="hs-identifier">_false</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621681193394"><span class="hs-identifier hs-var">true</span></a><span>
</span><a name="line-967"></a><span>   </span><a name="local-6989586621681193396"><a href="#local-6989586621681193396"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193396"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-968"></a><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-971"></a><span>
</span><a name="line-972"></a><span class="hs-comment">-- | Eliminate stores of the form</span><span>
</span><a name="line-973"></a><span class="hs-comment">--</span><span>
</span><a name="line-974"></a><span class="hs-comment">--    Sp[area+n] = r</span><span>
</span><a name="line-975"></a><span class="hs-comment">--</span><span>
</span><a name="line-976"></a><span class="hs-comment">-- when we know that r is already in the same slot as Sp[area+n].  We</span><span>
</span><a name="line-977"></a><span class="hs-comment">-- could do this in a later optimisation pass, but that would involve</span><span>
</span><a name="line-978"></a><span class="hs-comment">-- a separate analysis and we already have the information to hand</span><span>
</span><a name="line-979"></a><span class="hs-comment">-- here.  It helps clean up some extra stack stores in common cases.</span><span>
</span><a name="line-980"></a><span class="hs-comment">--</span><span>
</span><a name="line-981"></a><span class="hs-comment">-- Note that we may have to modify the StackMap as we walk through the</span><span>
</span><a name="line-982"></a><span class="hs-comment">-- code using procMiddle, since an assignment to a variable in the</span><span>
</span><a name="line-983"></a><span class="hs-comment">-- StackMap will invalidate its mapping there.</span><span>
</span><a name="line-984"></a><span class="hs-comment">--</span><span>
</span><a name="line-985"></a><span class="hs-identifier">elimStackStores</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-986"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-987"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Area"><span class="hs-identifier hs-type">Area</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-989"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-990"></a><a name="elimStackStores"><a href="CmmLayoutStack.html#elimStackStores"><span class="hs-identifier">elimStackStores</span></a></a><span> </span><a name="local-6989586621681193397"><a href="#local-6989586621681193397"><span class="hs-identifier">stackmap</span></a></a><span> </span><a name="local-6989586621681193398"><a href="#local-6989586621681193398"><span class="hs-identifier">stackmaps</span></a></a><span> </span><a name="local-6989586621681193399"><a href="#local-6989586621681193399"><span class="hs-identifier">area_off</span></a></a><span> </span><a name="local-6989586621681193400"><a href="#local-6989586621681193400"><span class="hs-identifier">nodes</span></a></a><span>
</span><a name="line-991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193401"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681193397"><span class="hs-identifier hs-var">stackmap</span></a><span> </span><a href="#local-6989586621681193400"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-992"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-993"></a><span>    </span><a name="local-6989586621681193401"><a href="#local-6989586621681193401"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681193402"><a href="#local-6989586621681193402"><span class="hs-identifier">_stackmap</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-994"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621681193403"><a href="#local-6989586621681193403"><span class="hs-identifier">stackmap</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681193404"><a href="#local-6989586621681193404"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681193405"><a href="#local-6989586621681193405"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681193404"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-996"></a><span>         </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a name="local-6989586621681193406"><a href="#local-6989586621681193406"><span class="hs-identifier">area</span></a></a><span> </span><a name="local-6989586621681193407"><a href="#local-6989586621681193407"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a name="local-6989586621681193408"><a href="#local-6989586621681193408"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681193409"><a href="#local-6989586621681193409"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_regs</span><span> </span><a href="#local-6989586621681193403"><span class="hs-identifier hs-var">stackmap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193408"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-998"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193399"><span class="hs-identifier hs-var">area_off</span></a><span> </span><a href="#local-6989586621681193406"><span class="hs-identifier hs-var">area</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681193407"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681193409"><span class="hs-identifier hs-var">off</span></a><span>
</span><a name="line-999"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193401"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681193403"><span class="hs-identifier hs-var">stackmap</span></a><span> </span><a href="#local-6989586621681193405"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-1000"></a><span>         </span><a name="local-6989586621681193410"><a href="#local-6989586621681193410"><span class="hs-identifier">_otherwise</span></a></a><span>
</span><a name="line-1001"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193404"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681193401"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#procMiddle"><span class="hs-identifier hs-var">procMiddle</span></a><span> </span><a href="#local-6989586621681193398"><span class="hs-identifier hs-var">stackmaps</span></a><span> </span><a href="#local-6989586621681193404"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681193403"><span class="hs-identifier hs-var">stackmap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193405"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1005"></a><span class="hs-comment">-- Update info tables to include stack liveness</span><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><span>
</span><a name="line-1008"></a><span class="hs-identifier">setInfoTableStackMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span>
</span><a name="line-1009"></a><a name="setInfoTableStackMap"><a href="CmmLayoutStack.html#setInfoTableStackMap"><span class="hs-identifier">setInfoTableStackMap</span></a></a><span> </span><a name="local-6989586621681193411"><a href="#local-6989586621681193411"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193412"><a href="#local-6989586621681193412"><span class="hs-identifier">stackmaps</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621681193413"><a href="#local-6989586621681193413"><span class="hs-identifier">top_info</span></a></a><span class="hs-glyph">@</span><a href="Cmm.html#TopInfo"><span class="hs-identifier hs-var">TopInfo</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621681193416"><a href="#local-6989586621681193416"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621681193417"><a href="#local-6989586621681193417"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621681193418"><a href="#local-6989586621681193418"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621681193413"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">info_tbls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapMapWithKey"><span class="hs-identifier hs-var">mapMapWithKey</span></a><span> </span><a href="#local-6989586621681193419"><span class="hs-identifier hs-var">fix_info</span></a><span> </span><a href="#local-6989586621681193414"><span class="hs-identifier hs-var">info_tbls</span></a><span> </span><span class="hs-special">}</span><span> </span><a href="#local-6989586621681193416"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621681193417"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621681193418"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-1011"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1012"></a><span>    </span><a name="local-6989586621681193419"><a href="#local-6989586621681193419"><span class="hs-identifier">fix_info</span></a></a><span> </span><a name="local-6989586621681193421"><a href="#local-6989586621681193421"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681193422"><a href="#local-6989586621681193422"><span class="hs-identifier">info_tbl</span></a></a><span class="hs-glyph">@</span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#StackRep"><span class="hs-identifier hs-var">StackRep</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1013"></a><span>       </span><a href="#local-6989586621681193422"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#StackRep"><span class="hs-identifier hs-var">StackRep</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193420"><span class="hs-identifier hs-var">get_liveness</span></a><span> </span><a href="#local-6989586621681193421"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1014"></a><span>    </span><span class="hs-identifier">fix_info</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193423"><a href="#local-6989586621681193423"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193423"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span>    </span><span class="hs-identifier">get_liveness</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#Liveness"><span class="hs-identifier hs-type">Liveness</span></a><span>
</span><a name="line-1017"></a><span>    </span><a name="local-6989586621681193420"><a href="#local-6989586621681193420"><span class="hs-identifier">get_liveness</span></a></a><span> </span><a name="local-6989586621681193424"><a href="#local-6989586621681193424"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-1018"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621681193424"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681193412"><span class="hs-identifier hs-var">stackmaps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1019"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;setInfoTableStackMap&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193424"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681193414"><span class="hs-identifier hs-var">info_tbls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193425"><a href="#local-6989586621681193425"><span class="hs-identifier">sm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#stackMapToLiveness"><span class="hs-identifier hs-var">stackMapToLiveness</span></a><span> </span><a href="#local-6989586621681193411"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193425"><span class="hs-identifier hs-var">sm</span></a><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><span class="hs-identifier">setInfoTableStackMap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193426"><a href="#local-6989586621681193426"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193426"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-1023"></a><span>
</span><a name="line-1024"></a><span>
</span><a name="line-1025"></a><span class="hs-identifier">stackMapToLiveness</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#Liveness"><span class="hs-identifier hs-type">Liveness</span></a><span>
</span><a name="line-1026"></a><a name="stackMapToLiveness"><a href="CmmLayoutStack.html#stackMapToLiveness"><span class="hs-identifier">stackMapToLiveness</span></a></a><span> </span><a name="local-6989586621681193427"><a href="#local-6989586621681193427"><span class="hs-identifier">dflags</span></a></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-var">StackMap</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1027"></a><span>   </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Array.elems</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1028"></a><span>        </span><span class="hs-identifier hs-var">accumArray</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193435"><a href="#local-6989586621681193435"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193435"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193427"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193430"><span class="hs-identifier hs-var">sm_ret_off</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span>
</span><a name="line-1029"></a><span>                                     </span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193427"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193428"><span class="hs-identifier hs-var">sm_sp</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193429"><span class="hs-identifier hs-var">sm_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193432"><span class="hs-identifier hs-var">live_words</span></a><span>
</span><a name="line-1030"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1031"></a><span>     </span><a name="local-6989586621681193432"><a href="#local-6989586621681193432"><span class="hs-identifier">live_words</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193427"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193434"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193433"><a href="#local-6989586621681193433"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621681193434"><a href="#local-6989586621681193434"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUFM</span><span> </span><a href="#local-6989586621681193431"><span class="hs-identifier hs-var">sm_regs</span></a><span>
</span><a name="line-1033"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#localRegType"><span class="hs-identifier hs-var">localRegType</span></a><span> </span><a href="#local-6989586621681193433"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1034"></a><span>                   </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1037"></a><span class="hs-comment">-- Pass 2</span><span>
</span><a name="line-1038"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1039"></a><span>
</span><a name="line-1040"></a><span class="hs-identifier">insertReloadsAsNeeded</span><span>
</span><a name="line-1041"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1042"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmProcPoint.html#ProcPointSet"><span class="hs-identifier hs-type">ProcPointSet</span></a><span>
</span><a name="line-1043"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span>
</span><a name="line-1044"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-1045"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-1047"></a><a name="insertReloadsAsNeeded"><a href="CmmLayoutStack.html#insertReloadsAsNeeded"><span class="hs-identifier">insertReloadsAsNeeded</span></a></a><span> </span><a name="local-6989586621681193436"><a href="#local-6989586621681193436"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193437"><a href="#local-6989586621681193437"><span class="hs-identifier">procpoints</span></a></a><span> </span><a name="local-6989586621681193438"><a href="#local-6989586621681193438"><span class="hs-identifier">final_stackmaps</span></a></a><span> </span><a name="local-6989586621681193439"><a href="#local-6989586621681193439"><span class="hs-identifier">entry</span></a></a><span> </span><a name="local-6989586621681193440"><a href="#local-6989586621681193440"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1048"></a><span>    </span><a href="CmmUtils.html#toBlockList"><span class="hs-identifier hs-var">toBlockList</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-1049"></a><span>        </span><a href="Hoopl.Dataflow.html#rewriteCmmBwd"><span class="hs-identifier hs-var">rewriteCmmBwd</span></a><span> </span><a href="CmmLive.html#liveLattice"><span class="hs-identifier hs-var">liveLattice</span></a><span> </span><a href="#local-6989586621681193441"><span class="hs-identifier hs-var">rewriteCC</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#ofBlockList"><span class="hs-identifier hs-var">ofBlockList</span></a><span> </span><a href="#local-6989586621681193439"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621681193440"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-1050"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1051"></a><span>    </span><span class="hs-identifier">rewriteCC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Dataflow.html#RewriteFun"><span class="hs-identifier hs-type">RewriteFun</span></a><span> </span><a href="CmmLive.html#CmmLocalLive"><span class="hs-identifier hs-type">CmmLocalLive</span></a><span>
</span><a name="line-1052"></a><span>    </span><a name="local-6989586621681193441"><a href="#local-6989586621681193441"><span class="hs-identifier">rewriteCC</span></a></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#BlockCC"><span class="hs-identifier hs-var">BlockCC</span></a><span> </span><a name="local-6989586621681193442"><a href="#local-6989586621681193442"><span class="hs-identifier">e_node</span></a></a><span> </span><a name="local-6989586621681193443"><a href="#local-6989586621681193443"><span class="hs-identifier">middle0</span></a></a><span> </span><a name="local-6989586621681193444"><a href="#local-6989586621681193444"><span class="hs-identifier">x_node</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681193445"><a href="#local-6989586621681193445"><span class="hs-identifier">fact_base0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1053"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193446"><a href="#local-6989586621681193446"><span class="hs-identifier">entry_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">entryLabel</span></a><span> </span><a href="#local-6989586621681193442"><span class="hs-identifier hs-var">e_node</span></a><span>
</span><a name="line-1054"></a><span>            </span><a name="local-6989586621681193447"><a href="#local-6989586621681193447"><span class="hs-identifier">stackmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621681193446"><span class="hs-identifier hs-var">entry_label</span></a><span> </span><a href="#local-6989586621681193438"><span class="hs-identifier hs-var">final_stackmaps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1055"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681193453"><a href="#local-6989586621681193453"><span class="hs-identifier">sm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681193453"><span class="hs-identifier hs-var">sm</span></a><span>
</span><a name="line-1056"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;insertReloadsAsNeeded: rewriteCC: stackmap&quot;</span><span>
</span><a name="line-1057"></a><span>
</span><a name="line-1058"></a><span>            </span><span class="hs-comment">-- Merge the liveness from successor blocks and analyse the last</span><span>
</span><a name="line-1059"></a><span>            </span><span class="hs-comment">-- node.</span><span>
</span><a name="line-1060"></a><span>            </span><a name="local-6989586621681193448"><a href="#local-6989586621681193448"><span class="hs-identifier">joined</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLive.html#gen_kill"><span class="hs-identifier hs-var">gen_kill</span></a><span> </span><a href="#local-6989586621681193436"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193444"><span class="hs-identifier hs-var">x_node</span></a><span> </span><span class="hs-operator hs-var">$!</span><span>
</span><a name="line-1061"></a><span>                         </span><a href="Hoopl.Dataflow.html#joinOutFacts"><span class="hs-identifier hs-var">joinOutFacts</span></a><span> </span><a href="CmmLive.html#liveLattice"><span class="hs-identifier hs-var">liveLattice</span></a><span> </span><a href="#local-6989586621681193444"><span class="hs-identifier hs-var">x_node</span></a><span> </span><a href="#local-6989586621681193445"><span class="hs-identifier hs-var">fact_base0</span></a><span>
</span><a name="line-1062"></a><span>            </span><span class="hs-comment">-- What is live at the start of middle0.</span><span>
</span><a name="line-1063"></a><span>            </span><a name="local-6989586621681193449"><a href="#local-6989586621681193449"><span class="hs-identifier">live_at_middle0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#foldNodesBwdOO"><span class="hs-identifier hs-var">foldNodesBwdOO</span></a><span> </span><span class="hs-special">(</span><a href="CmmLive.html#gen_kill"><span class="hs-identifier hs-var">gen_kill</span></a><span> </span><a href="#local-6989586621681193436"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193443"><span class="hs-identifier hs-var">middle0</span></a><span> </span><a href="#local-6989586621681193448"><span class="hs-identifier hs-var">joined</span></a><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span>            </span><span class="hs-comment">-- If this is a procpoint we need to add the reloads, but only if</span><span>
</span><a name="line-1066"></a><span>            </span><span class="hs-comment">-- they're actually live. Furthermore, nothing is live at the entry</span><span>
</span><a name="line-1067"></a><span>            </span><span class="hs-comment">-- to a proc point.</span><span>
</span><a name="line-1068"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621681193450"><a href="#local-6989586621681193450"><span class="hs-identifier">middle1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193451"><a href="#local-6989586621681193451"><span class="hs-identifier">live_with_reloads</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1069"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681193446"><span class="hs-identifier hs-var">entry_label</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193437"><span class="hs-identifier hs-var">procpoints</span></a><span>
</span><a name="line-1070"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193454"><a href="#local-6989586621681193454"><span class="hs-identifier">reloads</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#insertReloads"><span class="hs-identifier hs-var">insertReloads</span></a><span> </span><a href="#local-6989586621681193436"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193447"><span class="hs-identifier hs-var">stackmap</span></a><span> </span><a href="#local-6989586621681193449"><span class="hs-identifier hs-var">live_at_middle0</span></a><span>
</span><a name="line-1071"></a><span>                  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="Hoopl.Block.html#blockCons"><span class="hs-identifier hs-var">blockCons</span></a><span> </span><a href="#local-6989586621681193443"><span class="hs-identifier hs-var">middle0</span></a><span> </span><a href="#local-6989586621681193454"><span class="hs-identifier hs-var">reloads</span></a><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#emptyRegSet"><span class="hs-identifier hs-var">emptyRegSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-1072"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1073"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193443"><span class="hs-identifier hs-var">middle0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193449"><span class="hs-identifier hs-var">live_at_middle0</span></a><span class="hs-special">)</span><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span>            </span><span class="hs-comment">-- Final liveness for this block.</span><span>
</span><a name="line-1076"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621681193452"><a href="#local-6989586621681193452"><span class="hs-identifier">fact_base2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><a href="#local-6989586621681193446"><span class="hs-identifier hs-var">entry_label</span></a><span> </span><a href="#local-6989586621681193451"><span class="hs-identifier hs-var">live_with_reloads</span></a><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#BlockCC"><span class="hs-identifier hs-var">BlockCC</span></a><span> </span><a href="#local-6989586621681193442"><span class="hs-identifier hs-var">e_node</span></a><span> </span><a href="#local-6989586621681193450"><span class="hs-identifier hs-var">middle1</span></a><span> </span><a href="#local-6989586621681193444"><span class="hs-identifier hs-var">x_node</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193452"><span class="hs-identifier hs-var">fact_base2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1079"></a><span>
</span><a name="line-1080"></a><span class="hs-identifier">insertReloads</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmLive.html#CmmLocalLive"><span class="hs-identifier hs-type">CmmLocalLive</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span class="hs-special">]</span><span>
</span><a name="line-1081"></a><a name="insertReloads"><a href="CmmLayoutStack.html#insertReloads"><span class="hs-identifier">insertReloads</span></a></a><span> </span><a name="local-6989586621681193455"><a href="#local-6989586621681193455"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193456"><a href="#local-6989586621681193456"><span class="hs-identifier">stackmap</span></a></a><span> </span><a name="local-6989586621681193457"><a href="#local-6989586621681193457"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1082"></a><span>     </span><span class="hs-special">[</span><span> </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681193459"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1083"></a><span>                 </span><span class="hs-comment">-- This cmmOffset basically corresponds to manifesting</span><span>
</span><a name="line-1084"></a><span>                 </span><span class="hs-comment">-- @CmmStackSlot Old sp_off@, see Note [SP old/young offsets]</span><span>
</span><a name="line-1085"></a><span>                 </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621681193455"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmUtils.html#spExpr"><span class="hs-identifier hs-var">spExpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193458"><span class="hs-identifier hs-var">sp_off</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621681193460"><span class="hs-identifier hs-var">reg_off</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1086"></a><span>                          </span><span class="hs-special">(</span><a href="CmmExpr.html#localRegType"><span class="hs-identifier hs-var">localRegType</span></a><span> </span><a href="#local-6989586621681193459"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193459"><a href="#local-6989586621681193459"><span class="hs-identifier">reg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193460"><a href="#local-6989586621681193460"><span class="hs-identifier">reg_off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmLayoutStack.html#stackSlotRegs"><span class="hs-identifier hs-var">stackSlotRegs</span></a><span> </span><a href="#local-6989586621681193456"><span class="hs-identifier hs-var">stackmap</span></a><span>
</span><a name="line-1088"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193459"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-special">`</span><a href="CmmExpr.html#elemRegSet"><span class="hs-identifier hs-var">elemRegSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193457"><span class="hs-identifier hs-var">live</span></a><span>
</span><a name="line-1089"></a><span>     </span><span class="hs-special">]</span><span>
</span><a name="line-1090"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1091"></a><span>     </span><a name="local-6989586621681193458"><a href="#local-6989586621681193458"><span class="hs-identifier">sp_off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sm_sp</span><span> </span><a href="#local-6989586621681193456"><span class="hs-identifier hs-var">stackmap</span></a><span>
</span><a name="line-1092"></a><span>
</span><a name="line-1093"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1094"></a><span class="hs-comment">-- Lowering safe foreign calls</span><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span class="hs-comment">{-
Note [Lower safe foreign calls]

We start with

   Sp[young(L1)] = L1
 ,-----------------------
 | r1 = foo(x,y,z) returns to L1
 '-----------------------
 L1:
   R1 = r1 -- copyIn, inserted by mkSafeCall
   ...

the stack layout algorithm will arrange to save and reload everything
live across the call.  Our job now is to expand the call so we get

   Sp[young(L1)] = L1
 ,-----------------------
 | SAVE_THREAD_STATE()
 | token = suspendThread(BaseReg, interruptible)
 | r = foo(x,y,z)
 | BaseReg = resumeThread(token)
 | LOAD_THREAD_STATE()
 | R1 = r  -- copyOut
 | jump Sp[0]
 '-----------------------
 L1:
   r = R1 -- copyIn, inserted by mkSafeCall
   ...

Note the copyOut, which saves the results in the places that L1 is
expecting them (see Note [safe foreign call convention]). Note also
that safe foreign call is replace by an unsafe one in the Cmm graph.
-}</span><span>
</span><a name="line-1130"></a><span>
</span><a name="line-1131"></a><span class="hs-identifier">lowerSafeForeignCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span>
</span><a name="line-1132"></a><a name="lowerSafeForeignCall"><a href="CmmLayoutStack.html#lowerSafeForeignCall"><span class="hs-identifier">lowerSafeForeignCall</span></a></a><span> </span><a name="local-6989586621681193461"><a href="#local-6989586621681193461"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193462"><a href="#local-6989586621681193462"><span class="hs-identifier">block</span></a></a><span>
</span><a name="line-1133"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193463"><a href="#local-6989586621681193463"><span class="hs-identifier">entry</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681193464"><a href="#local-6989586621681193464"><span class="hs-identifier">tscp</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681193465"><a href="#local-6989586621681193465"><span class="hs-identifier">middle</span></a></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Block.html#blockSplit"><span class="hs-identifier hs-var">blockSplit</span></a><span> </span><a href="#local-6989586621681193462"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-1134"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1135"></a><span>    </span><span class="hs-comment">-- Both 'id' and 'new_base' are KindNonPtr because they're</span><span>
</span><a name="line-1136"></a><span>    </span><span class="hs-comment">-- RTS-only objects and are not subject to garbage collection</span><span>
</span><a name="line-1137"></a><span>    </span><a name="local-6989586621681193473"><a href="#local-6989586621681193473"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1138"></a><span>    </span><a name="local-6989586621681193474"><a href="#local-6989586621681193474"><span class="hs-identifier">new_base</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#cmmRegType"><span class="hs-identifier hs-var">cmmRegType</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmExpr.html#baseReg"><span class="hs-identifier hs-var">baseReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681193475"><a href="#local-6989586621681193475"><span class="hs-identifier">caller_save</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193476"><a href="#local-6989586621681193476"><span class="hs-identifier">caller_load</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmUtils.html#callerSaveVolatileRegs"><span class="hs-identifier hs-var">callerSaveVolatileRegs</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1140"></a><span>    </span><a name="local-6989586621681193477"><a href="#local-6989586621681193477"><span class="hs-identifier">save_state_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#saveThreadState"><span class="hs-identifier hs-var">saveThreadState</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1141"></a><span>    </span><a name="local-6989586621681193478"><a href="#local-6989586621681193478"><span class="hs-identifier">load_state_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#loadThreadState"><span class="hs-identifier hs-var">loadThreadState</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681193479"><a href="#local-6989586621681193479"><span class="hs-identifier">suspend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193477"><span class="hs-identifier hs-var">save_state_code</span></a><span>  </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1143"></a><span>                  </span><a href="#local-6989586621681193475"><span class="hs-identifier hs-var">caller_save</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1144"></a><span>                  </span><a href="MkGraph.html#mkMiddle"><span class="hs-identifier hs-var">mkMiddle</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#callSuspendThread"><span class="hs-identifier hs-var">callSuspendThread</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681193473"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681193472"><span class="hs-identifier hs-var">intrbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>        </span><a name="local-6989586621681193480"><a href="#local-6989586621681193480"><span class="hs-identifier">midCall</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkUnsafeCall"><span class="hs-identifier hs-var">mkUnsafeCall</span></a><span> </span><a href="#local-6989586621681193466"><span class="hs-identifier hs-var">tgt</span></a><span> </span><a href="#local-6989586621681193467"><span class="hs-identifier hs-var">res</span></a><span> </span><a href="#local-6989586621681193468"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1146"></a><span>        </span><a name="local-6989586621681193481"><a href="#local-6989586621681193481"><span class="hs-identifier">resume</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkMiddle"><span class="hs-identifier hs-var">mkMiddle</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#callResumeThread"><span class="hs-identifier hs-var">callResumeThread</span></a><span> </span><a href="#local-6989586621681193474"><span class="hs-identifier hs-var">new_base</span></a><span> </span><a href="#local-6989586621681193473"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1147"></a><span>                  </span><span class="hs-comment">-- Assign the result to BaseReg: we</span><span>
</span><a name="line-1148"></a><span>                  </span><span class="hs-comment">-- might now have a different Capability!</span><span>
</span><a name="line-1149"></a><span>                  </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#baseReg"><span class="hs-identifier hs-var">baseReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681193474"><span class="hs-identifier hs-var">new_base</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1150"></a><span>                  </span><a href="#local-6989586621681193476"><span class="hs-identifier hs-var">caller_load</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1151"></a><span>                  </span><a href="#local-6989586621681193478"><span class="hs-identifier hs-var">load_state_code</span></a><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681193482"><a href="#local-6989586621681193482"><span class="hs-identifier">regs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193483"><a href="#local-6989586621681193483"><span class="hs-identifier">copyout</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1154"></a><span>             </span><a href="MkGraph.html#copyOutOflow"><span class="hs-identifier hs-var">copyOutOflow</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span> </span><a href="MkGraph.html#Jump"><span class="hs-identifier hs-var">Jump</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621681193469"><span class="hs-identifier hs-var">succ</span></a><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193467"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>                            </span><a href="#local-6989586621681193471"><span class="hs-identifier hs-var">ret_off</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span>        </span><span class="hs-comment">-- NB. after resumeThread returns, the top-of-stack probably contains</span><span>
</span><a name="line-1159"></a><span>        </span><span class="hs-comment">-- the stack frame for succ, but it might not: if the current thread</span><span>
</span><a name="line-1160"></a><span>        </span><span class="hs-comment">-- received an exception during the call, then the stack might be</span><span>
</span><a name="line-1161"></a><span>        </span><span class="hs-comment">-- different.  Hence we continue by jumping to the top stack frame,</span><span>
</span><a name="line-1162"></a><span>        </span><span class="hs-comment">-- not by jumping to succ.</span><span>
</span><a name="line-1163"></a><span>        </span><a name="local-6989586621681193484"><a href="#local-6989586621681193484"><span class="hs-identifier">jump</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_target</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CmmInfo.html#entryCode"><span class="hs-identifier hs-var">entryCode</span></a><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1164"></a><span>                                         </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a href="CmmUtils.html#spExpr"><span class="hs-identifier hs-var">spExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1165"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_cont</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681193469"><span class="hs-identifier hs-var">succ</span></a><span>
</span><a name="line-1166"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_args_regs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193482"><span class="hs-identifier hs-var">regs</span></a><span>
</span><a name="line-1167"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_args</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">widthInBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621681193461"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1168"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_ret_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193470"><span class="hs-identifier hs-var">ret_args</span></a><span>
</span><a name="line-1169"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_ret_off</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193471"><span class="hs-identifier hs-var">ret_off</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1170"></a><span>
</span><a name="line-1171"></a><span>    </span><a name="local-6989586621681193485"><a href="#local-6989586621681193485"><span class="hs-identifier">graph'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkGraph.html#lgraphOfAGraph"><span class="hs-identifier hs-var">lgraphOfAGraph</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621681193479"><span class="hs-identifier hs-var">suspend</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1172"></a><span>                               </span><a href="#local-6989586621681193480"><span class="hs-identifier hs-var">midCall</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1173"></a><span>                               </span><a href="#local-6989586621681193481"><span class="hs-identifier hs-var">resume</span></a><span>  </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1174"></a><span>                               </span><a href="#local-6989586621681193483"><span class="hs-identifier hs-var">copyout</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-1175"></a><span>                               </span><a href="MkGraph.html#mkLast"><span class="hs-identifier hs-var">mkLast</span></a><span> </span><a href="#local-6989586621681193484"><span class="hs-identifier hs-var">jump</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681193464"><span class="hs-identifier hs-var">tscp</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>
</span><a name="line-1177"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="CmmUtils.html#toBlockList"><span class="hs-identifier hs-var">toBlockList</span></a><span> </span><a href="#local-6989586621681193485"><span class="hs-identifier hs-var">graph'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1178"></a><span>      </span><span class="hs-special">[</span><a name="local-6989586621681193486"><a href="#local-6989586621681193486"><span class="hs-identifier">one</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681193487"><a href="#local-6989586621681193487"><span class="hs-identifier">middle'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681193488"><a href="#local-6989586621681193488"><span class="hs-identifier">last</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockSplit"><span class="hs-identifier hs-var">blockSplit</span></a><span> </span><a href="#local-6989586621681193486"><span class="hs-identifier hs-var">one</span></a><span>
</span><a name="line-1179"></a><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#blockJoin"><span class="hs-identifier hs-var">blockJoin</span></a><span> </span><a href="#local-6989586621681193463"><span class="hs-identifier hs-var">entry</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193465"><span class="hs-identifier hs-var">middle</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Block.html#blockAppend"><span class="hs-identifier hs-var">blockAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681193487"><span class="hs-identifier hs-var">middle'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193488"><span class="hs-identifier hs-var">last</span></a><span class="hs-special">)</span><span>
</span><a name="line-1180"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;lowerSafeForeignCall0&quot;</span><span>
</span><a name="line-1181"></a><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-comment">-- Block doesn't end in a safe foreign call:</span><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681193462"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span>
</span><a name="line-1186"></a><span class="hs-identifier">foreignLbl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-1187"></a><a name="foreignLbl"><a href="CmmLayoutStack.html#foreignLbl"><span class="hs-identifier">foreignLbl</span></a></a><span> </span><a name="local-6989586621681193489"><a href="#local-6989586621681193489"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkForeignLabel"><span class="hs-identifier hs-var">mkForeignLabel</span></a><span> </span><a href="#local-6989586621681193489"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="CLabel.html#ForeignLabelInExternalPackage"><span class="hs-identifier hs-var">ForeignLabelInExternalPackage</span></a><span> </span><span class="hs-identifier hs-var">IsFunction</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span class="hs-identifier">callSuspendThread</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-1190"></a><a name="callSuspendThread"><a href="CmmLayoutStack.html#callSuspendThread"><span class="hs-identifier">callSuspendThread</span></a></a><span> </span><a name="local-6989586621681193490"><a href="#local-6989586621681193490"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193491"><a href="#local-6989586621681193491"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621681193492"><a href="#local-6989586621681193492"><span class="hs-identifier">intrbl</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1191"></a><span>  </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span>
</span><a name="line-1192"></a><span>       </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#foreignLbl"><span class="hs-identifier hs-var">foreignLbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;suspendThread&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1193"></a><span>        </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-var">ForeignConvention</span></a><span> </span><span class="hs-identifier hs-var">CCallConv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NoHint</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">]</span><span> </span><a href="CmmNode.html#CmmMayReturn"><span class="hs-identifier hs-var">CmmMayReturn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1194"></a><span>       </span><span class="hs-special">[</span><a href="#local-6989586621681193491"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="CmmUtils.html#baseExpr"><span class="hs-identifier hs-var">baseExpr</span></a><span class="hs-special">,</span><span> </span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621681193490"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromEnum</span><span> </span><a href="#local-6989586621681193492"><span class="hs-identifier hs-var">intrbl</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1195"></a><span>
</span><a name="line-1196"></a><span class="hs-identifier">callResumeThread</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-1197"></a><a name="callResumeThread"><a href="CmmLayoutStack.html#callResumeThread"><span class="hs-identifier">callResumeThread</span></a></a><span> </span><a name="local-6989586621681193493"><a href="#local-6989586621681193493"><span class="hs-identifier">new_base</span></a></a><span> </span><a name="local-6989586621681193494"><a href="#local-6989586621681193494"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1198"></a><span>  </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span>
</span><a name="line-1199"></a><span>       </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#foreignLbl"><span class="hs-identifier hs-var">foreignLbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;resumeThread&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1200"></a><span>            </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-var">ForeignConvention</span></a><span> </span><span class="hs-identifier hs-var">CCallConv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">]</span><span> </span><a href="CmmNode.html#CmmMayReturn"><span class="hs-identifier hs-var">CmmMayReturn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1201"></a><span>       </span><span class="hs-special">[</span><a href="#local-6989586621681193493"><span class="hs-identifier hs-var">new_base</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681193494"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span class="hs-identifier">plusW</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-1206"></a><a name="plusW"><a href="CmmLayoutStack.html#plusW"><span class="hs-identifier">plusW</span></a></a><span> </span><a name="local-6989586621681193495"><a href="#local-6989586621681193495"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193496"><a href="#local-6989586621681193496"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621681193497"><a href="#local-6989586621681193497"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193496"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681193497"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193495"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1207"></a><span>
</span><a name="line-1208"></a><span class="hs-keyword">data</span><span> </span><a name="StackSlot"><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier">StackSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Occupied"><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier">Occupied</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Empty"><a href="CmmLayoutStack.html#Empty"><span class="hs-identifier">Empty</span></a></a><span>
</span><a name="line-1209"></a><span>     </span><span class="hs-comment">-- Occupied: a return address or part of an update frame</span><span>
</span><a name="line-1210"></a><span>
</span><a name="line-1211"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1212"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="CmmLayoutStack.html#Occupied"><span class="hs-identifier hs-var">Occupied</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;XXX&quot;</span><span>
</span><a name="line-1213"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="CmmLayoutStack.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;---&quot;</span><span>
</span><a name="line-1214"></a><span>
</span><a name="line-1215"></a><span class="hs-identifier">dropEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span class="hs-special">]</span><span>
</span><a name="line-1216"></a><a name="dropEmpty"><a href="CmmLayoutStack.html#dropEmpty"><span class="hs-identifier">dropEmpty</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621681193498"><a href="#local-6989586621681193498"><span class="hs-identifier">ss</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681193498"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1217"></a><span class="hs-identifier">dropEmpty</span><span> </span><a name="local-6989586621681193499"><a href="#local-6989586621681193499"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmLayoutStack.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681193500"><a href="#local-6989586621681193500"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#dropEmpty"><span class="hs-identifier hs-var">dropEmpty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681193499"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681193500"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1218"></a><span class="hs-identifier">dropEmpty</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1219"></a><span>
</span><a name="line-1220"></a><span class="hs-identifier">isEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmLayoutStack.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1221"></a><a name="isEmpty"><a href="CmmLayoutStack.html#isEmpty"><span class="hs-identifier">isEmpty</span></a></a><span> </span><a href="CmmLayoutStack.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1222"></a><span class="hs-identifier">isEmpty</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span class="hs-identifier">localRegBytes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-1225"></a><a name="localRegBytes"><a href="CmmLayoutStack.html#localRegBytes"><span class="hs-identifier">localRegBytes</span></a></a><span> </span><a name="local-6989586621681193501"><a href="#local-6989586621681193501"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193502"><a href="#local-6989586621681193502"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-1226"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#roundUpToWords"><span class="hs-identifier hs-var">roundUpToWords</span></a><span> </span><a href="#local-6989586621681193501"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">widthInBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeWidth</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#localRegType"><span class="hs-identifier hs-var">localRegType</span></a><span> </span><a href="#local-6989586621681193502"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1227"></a><span>
</span><a name="line-1228"></a><span class="hs-identifier">localRegWords</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-1229"></a><a name="localRegWords"><a href="CmmLayoutStack.html#localRegWords"><span class="hs-identifier">localRegWords</span></a></a><span> </span><a name="local-6989586621681193503"><a href="#local-6989586621681193503"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier hs-var">toWords</span></a><span> </span><a href="#local-6989586621681193503"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmLayoutStack.html#localRegBytes"><span class="hs-identifier hs-var">localRegBytes</span></a><span> </span><a href="#local-6989586621681193503"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1230"></a><span>
</span><a name="line-1231"></a><span class="hs-identifier">toWords</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-1232"></a><a name="toWords"><a href="CmmLayoutStack.html#toWords"><span class="hs-identifier">toWords</span></a></a><span> </span><a name="local-6989586621681193504"><a href="#local-6989586621681193504"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681193505"><a href="#local-6989586621681193505"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681193505"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quot</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621681193504"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1233"></a><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span class="hs-identifier">stackSlotRegs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmLayoutStack.html#StackMap"><span class="hs-identifier hs-type">StackMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">,</span><span> </span><a href="CmmLayoutStack.html#StackLoc"><span class="hs-identifier hs-type">StackLoc</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1236"></a><a name="stackSlotRegs"><a href="CmmLayoutStack.html#stackSlotRegs"><span class="hs-identifier">stackSlotRegs</span></a></a><span> </span><a name="local-6989586621681193506"><a href="#local-6989586621681193506"><span class="hs-identifier">sm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_regs</span><span> </span><a href="#local-6989586621681193506"><span class="hs-identifier hs-var">sm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1237"></a><span>  </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-1238"></a></pre></body></html>