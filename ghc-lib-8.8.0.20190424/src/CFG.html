<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">--</span><span>
</span><a name="line-2"></a><span class="hs-comment">-- Copyright (c) 2018 Andreas Klebinger</span><span>
</span><a name="line-3"></a><span class="hs-comment">--</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies, ScopedTypeVariables #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CFG</span><span>
</span><a name="line-11"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#TransitionSource"><span class="hs-identifier hs-type">TransitionSource</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-comment">--Modify the CFG</span><span>
</span><a name="line-15"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#addWeightEdge"><span class="hs-identifier hs-var">addWeightEdge</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#delEdge"><span class="hs-identifier hs-var">delEdge</span></a><span>
</span><a name="line-16"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#addNodesBetween"><span class="hs-identifier hs-var">addNodesBetween</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#shortcutWeightMap"><span class="hs-identifier hs-var">shortcutWeightMap</span></a><span>
</span><a name="line-17"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#reverseEdges"><span class="hs-identifier hs-var">reverseEdges</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#filterEdges"><span class="hs-identifier hs-var">filterEdges</span></a><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#addImmediateSuccessor"><span class="hs-identifier hs-var">addImmediateSuccessor</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#mkWeightInfo"><span class="hs-identifier hs-var">mkWeightInfo</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-var">adjustEdgeWeight</span></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>    </span><span class="hs-comment">--Query the CFG</span><span>
</span><a name="line-22"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#infoEdgeList"><span class="hs-identifier hs-var">infoEdgeList</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#edgeList"><span class="hs-identifier hs-var">edgeList</span></a><span>
</span><a name="line-23"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#getSuccEdgesSorted"><span class="hs-identifier hs-var">getSuccEdgesSorted</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#weightedEdgeList"><span class="hs-identifier hs-var">weightedEdgeList</span></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#hasNode"><span class="hs-identifier hs-var">hasNode</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#loopMembers"><span class="hs-identifier hs-var">loopMembers</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>    </span><span class="hs-comment">--Construction/Misc</span><span>
</span><a name="line-30"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#getCfg"><span class="hs-identifier hs-var">getCfg</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#getCfgProc"><span class="hs-identifier hs-var">getCfgProc</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#sanityCheckCfg"><span class="hs-identifier hs-var">sanityCheckCfg</span></a><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-comment">--Find backedges and update their weight</span><span>
</span><a name="line-33"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#optimizeCFG"><span class="hs-identifier hs-var">optimizeCFG</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">where</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#GenCmmDecl"><span class="hs-identifier hs-type">GenCmmDecl</span></a><span class="hs-special">(</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#succ"><span class="hs-identifier hs-var">succ</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#g_entry"><span class="hs-identifier hs-var">g_entry</span></a><span>
</span><a name="line-42"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="CmmNode.html"><span class="hs-identifier">CmmNode</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="CmmSwitch.html"><span class="hs-identifier">CmmSwitch</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl.Graph</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">G</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- DEBUGGING ONLY</span><span>
</span><a name="line-56"></a><span class="hs-comment">--import Debug</span><span>
</span><a name="line-57"></a><span class="hs-comment">--import OrdList</span><span>
</span><a name="line-58"></a><span class="hs-comment">--import Debug.Trace</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmm.html"><span class="hs-identifier">PprCmm</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">DynFlags</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">D</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- import qualified Data.IntMap.Strict as M --TODO: LabelMap</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-keyword">type</span><span> </span><a name="Edge"><a href="CFG.html#Edge"><span class="hs-identifier">Edge</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">type</span><span> </span><a name="Edges"><a href="CFG.html#Edges"><span class="hs-identifier">Edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a><span class="hs-special">]</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">newtype</span><span> </span><a name="EdgeWeight"><a href="CFG.html#EdgeWeight"><span class="hs-identifier">EdgeWeight</span></a></a><span>
</span><a name="line-70"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="EdgeWeight"><a href="CFG.html#EdgeWeight"><span class="hs-identifier">EdgeWeight</span></a></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Num</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Real</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Integral</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-74"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-var">EdgeWeight</span></a><span> </span><a name="local-6989586621680326282"><a href="#local-6989586621680326282"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326282"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-keyword">type</span><span> </span><a name="EdgeInfoMap"><a href="CFG.html#EdgeInfoMap"><span class="hs-identifier">EdgeInfoMap</span></a></a><span> </span><a name="local-6989586621680326267"><a href="#local-6989586621680326267"><span class="hs-identifier">edgeInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621680326267"><span class="hs-identifier hs-type">edgeInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | A control flow graph where edges have been annotated with a weight.</span><span>
</span><a name="line-79"></a><span class="hs-keyword">type</span><span> </span><a name="CFG"><a href="CFG.html#CFG"><span class="hs-identifier">CFG</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#EdgeInfoMap"><span class="hs-identifier hs-type">EdgeInfoMap</span></a><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-keyword">data</span><span> </span><a name="CfgEdge"><a href="CFG.html#CfgEdge"><span class="hs-identifier">CfgEdge</span></a></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CfgEdge"><a href="CFG.html#CfgEdge"><span class="hs-identifier">CfgEdge</span></a></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="edgeFrom"><a href="CFG.html#edgeFrom"><span class="hs-identifier">edgeFrom</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-84"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="edgeTo"><a href="CFG.html#edgeTo"><span class="hs-identifier">edgeTo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="edgeInfo"><a href="CFG.html#edgeInfo"><span class="hs-identifier">edgeInfo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span>
</span><a name="line-86"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">-- | Careful! Since we assume there is at most one edge from A to B</span><span>
</span><a name="line-89"></a><span class="hs-comment">--   the Eq instance does not consider weight.</span><span>
</span><a name="line-90"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a name="local-6989586621680326278"><a href="#local-6989586621680326278"><span class="hs-identifier">from1</span></a></a><span> </span><a name="local-6989586621680326279"><a href="#local-6989586621680326279"><span class="hs-identifier">to1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a name="local-6989586621680326280"><a href="#local-6989586621680326280"><span class="hs-identifier">from2</span></a></a><span> </span><a name="local-6989586621680326281"><a href="#local-6989586621680326281"><span class="hs-identifier">to2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326278"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326280"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680326279"><span class="hs-identifier hs-var">to1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326281"><span class="hs-identifier hs-var">to2</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">-- | Edges are sorted ascending pointwise by weight, source and destination</span><span>
</span><a name="line-95"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-96"></a><span>  </span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a name="local-6989586621680326272"><a href="#local-6989586621680326272"><span class="hs-identifier">from1</span></a></a><span> </span><a name="local-6989586621680326273"><a href="#local-6989586621680326273"><span class="hs-identifier">to1</span></a></a><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">edgeWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326274"><a href="#local-6989586621680326274"><span class="hs-identifier">weight1</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-special">(</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a name="local-6989586621680326275"><a href="#local-6989586621680326275"><span class="hs-identifier">from2</span></a></a><span> </span><a name="local-6989586621680326276"><a href="#local-6989586621680326276"><span class="hs-identifier">to2</span></a></a><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">edgeWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326277"><a href="#local-6989586621680326277"><span class="hs-identifier">weight2</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326274"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621680326277"><span class="hs-identifier hs-var">weight2</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680326274"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326277"><span class="hs-identifier hs-var">weight2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680326272"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621680326275"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-99"></a><span>      </span><a href="#local-6989586621680326274"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326277"><span class="hs-identifier hs-var">weight2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680326272"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326275"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680326273"><span class="hs-identifier hs-var">to1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621680326276"><span class="hs-identifier hs-var">to2</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326272"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326275"><span class="hs-identifier hs-var">from2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680326273"><span class="hs-identifier hs-var">to1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326276"><span class="hs-identifier hs-var">to2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680326274"><span class="hs-identifier hs-var">weight1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326277"><span class="hs-identifier hs-var">weight2</span></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-107"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a name="local-6989586621680326269"><a href="#local-6989586621680326269"><span class="hs-identifier">from1</span></a></a><span> </span><a name="local-6989586621680326270"><a href="#local-6989586621680326270"><span class="hs-identifier">to1</span></a></a><span> </span><a name="local-6989586621680326271"><a href="#local-6989586621680326271"><span class="hs-identifier">edgeInfo</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326269"><span class="hs-identifier hs-var">from1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-(&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326271"><span class="hs-identifier hs-var">edgeInfo</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;)-&gt;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326270"><span class="hs-identifier hs-var">to1</span></a><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | Can we trace back a edge to a specific Cmm Node</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- or has it been introduced for codegen. We use this to maintain</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- some information which would otherwise be lost during the</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- Cmm &lt;-&gt; asm transition.</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- See also Note [Inverting Conditional Branches]</span><span>
</span><a name="line-115"></a><span class="hs-keyword">data</span><span> </span><a name="TransitionSource"><a href="CFG.html#TransitionSource"><span class="hs-identifier">TransitionSource</span></a></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CmmSource"><a href="CFG.html#CmmSource"><span class="hs-identifier">CmmSource</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AsmCodeGen"><a href="CFG.html#AsmCodeGen"><span class="hs-identifier">AsmCodeGen</span></a></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- | Information about edges</span><span>
</span><a name="line-121"></a><span class="hs-keyword">data</span><span> </span><a name="EdgeInfo"><a href="CFG.html#EdgeInfo"><span class="hs-identifier">EdgeInfo</span></a></a><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="EdgeInfo"><a href="CFG.html#EdgeInfo"><span class="hs-identifier">EdgeInfo</span></a></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="transitionSource"><a href="CFG.html#transitionSource"><span class="hs-identifier">transitionSource</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CFG.html#TransitionSource"><span class="hs-identifier hs-type">TransitionSource</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="edgeWeight"><a href="CFG.html#edgeWeight"><span class="hs-identifier">edgeWeight</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-128"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a name="local-6989586621680326268"><a href="#local-6989586621680326268"><span class="hs-identifier">edgeInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;weight:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326268"><span class="hs-identifier hs-var">edgeInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-comment">-- Allow specialization</span><span>
</span><a name="line-131"></a><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="hs-pragma">mkWeightInfo</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- | Convenience function, generate edge info based</span><span>
</span><a name="line-133"></a><span class="hs-comment">--   on weight not originating from cmm.</span><span>
</span><a name="line-134"></a><span class="hs-identifier">mkWeightInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621680326283"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680326283"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span>
</span><a name="line-135"></a><a name="mkWeightInfo"><a href="CFG.html#mkWeightInfo"><span class="hs-identifier">mkWeightInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a><span> </span><a href="CFG.html#AsmCodeGen"><span class="hs-identifier hs-var">AsmCodeGen</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">-- | Adjust the weight between the blocks using the given function.</span><span>
</span><a name="line-138"></a><span class="hs-comment">--   If there is no such edge returns the original map.</span><span>
</span><a name="line-139"></a><span class="hs-identifier">adjustEdgeWeight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-141"></a><a name="adjustEdgeWeight"><a href="CFG.html#adjustEdgeWeight"><span class="hs-identifier">adjustEdgeWeight</span></a></a><span> </span><a name="local-6989586621680326284"><a href="#local-6989586621680326284"><span class="hs-identifier">cfg</span></a></a><span> </span><a name="local-6989586621680326285"><a href="#local-6989586621680326285"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680326286"><a href="#local-6989586621680326286"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326287"><a href="#local-6989586621680326287"><span class="hs-identifier">to</span></a></a><span>
</span><a name="line-142"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326288"><a href="#local-6989586621680326288"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a><span> </span><a href="#local-6989586621680326286"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326287"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326284"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-143"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621680326289"><a href="#local-6989586621680326289"><span class="hs-identifier">weight</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326288"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-144"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326286"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326287"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326288"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326285"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326289"><span class="hs-identifier hs-var">weight</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326284"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-145"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326284"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-identifier">getCfgNodes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-148"></a><a name="getCfgNodes"><a href="CFG.html#getCfgNodes"><span class="hs-identifier">getCfgNodes</span></a></a><span> </span><a name="local-6989586621680326290"><a href="#local-6989586621680326290"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFoldMapWithKey"><span class="hs-identifier hs-var">mapFoldMapWithKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326291"><a href="#local-6989586621680326291"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621680326292"><a href="#local-6989586621680326292"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326291"><span class="hs-identifier hs-var">k</span></a><span class="hs-glyph">:</span><a href="Hoopl.Collections.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a><span> </span><a href="#local-6989586621680326292"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326290"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">hasNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-151"></a><a name="hasNode"><a href="CFG.html#hasNode"><span class="hs-identifier">hasNode</span></a></a><span> </span><a name="local-6989586621680326293"><a href="#local-6989586621680326293"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326294"><a href="#local-6989586621680326294"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621680326294"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680326293"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621680326294"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326293"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | Check if the nodes in the cfg and the set of blocks are the same.</span><span>
</span><a name="line-154"></a><span class="hs-comment">--   In a case of a missmatch we panic and show the difference.</span><span>
</span><a name="line-155"></a><span class="hs-identifier">sanityCheckCfg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-156"></a><a name="sanityCheckCfg"><a href="CFG.html#sanityCheckCfg"><span class="hs-identifier">sanityCheckCfg</span></a></a><span> </span><a name="local-6989586621680326295"><a href="#local-6989586621680326295"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326296"><a href="#local-6989586621680326296"><span class="hs-identifier">blockSet</span></a></a><span> </span><a name="local-6989586621680326297"><a href="#local-6989586621680326297"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-157"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326296"><span class="hs-identifier hs-var">blockSet</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326298"><span class="hs-identifier hs-var">cfgNodes</span></a><span>
</span><a name="line-158"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;Block list and cfg nodes don't match&quot;</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-161"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;difference:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326299"><span class="hs-identifier hs-var">diff</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-162"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;blocks:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326296"><span class="hs-identifier hs-var">blockSet</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-163"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cfg:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326295"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-164"></a><span>            </span><a href="#local-6989586621680326297"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>            </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-167"></a><span>      </span><a name="local-6989586621680326298"><a href="#local-6989586621680326298"><span class="hs-identifier">cfgNodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a><span> </span><a href="#local-6989586621680326295"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-168"></a><span>      </span><a name="local-6989586621680326299"><a href="#local-6989586621680326299"><span class="hs-identifier">diff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setUnion"><span class="hs-identifier hs-var">setUnion</span></a><span> </span><a href="#local-6989586621680326298"><span class="hs-identifier hs-var">cfgNodes</span></a><span> </span><a href="#local-6989586621680326296"><span class="hs-identifier hs-var">blockSet</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#setDifference"><span class="hs-identifier hs-var">setDifference</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setIntersection"><span class="hs-identifier hs-var">setIntersection</span></a><span> </span><a href="#local-6989586621680326298"><span class="hs-identifier hs-var">cfgNodes</span></a><span> </span><a href="#local-6989586621680326296"><span class="hs-identifier hs-var">blockSet</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">-- | Filter the CFG with a custom function f.</span><span>
</span><a name="line-171"></a><span class="hs-comment">--   Paramaeters are `f from to edgeInfo`</span><span>
</span><a name="line-172"></a><span class="hs-identifier">filterEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-173"></a><a name="filterEdges"><a href="CFG.html#filterEdges"><span class="hs-identifier">filterEdges</span></a></a><span> </span><a name="local-6989586621680326300"><a href="#local-6989586621680326300"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680326301"><a href="#local-6989586621680326301"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-174"></a><span>    </span><a href="Hoopl.Collections.html#mapMapWithKey"><span class="hs-identifier hs-var">mapMapWithKey</span></a><span> </span><a href="#local-6989586621680326302"><span class="hs-identifier hs-var">filterSources</span></a><span> </span><a href="#local-6989586621680326301"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-175"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-176"></a><span>      </span><a name="local-6989586621680326302"><a href="#local-6989586621680326302"><span class="hs-identifier">filterSources</span></a></a><span> </span><a name="local-6989586621680326303"><a href="#local-6989586621680326303"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326304"><a href="#local-6989586621680326304"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-177"></a><span>        </span><a href="Hoopl.Collections.html#mapFilterWithKey"><span class="hs-identifier hs-var">mapFilterWithKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326305"><a href="#local-6989586621680326305"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326306"><a href="#local-6989586621680326306"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680326300"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326303"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326305"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326306"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326304"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">{- Note [Updating the CFG during shortcutting]

See Note [What is shortcutting] in the control flow optimization
code (CmmContFlowOpt.hs) for a slightly more in depth explanation on shortcutting.

In the native backend we shortcut jumps at the assembly level. (AsmCodeGen.hs)
This means we remove blocks containing only one jump from the code
and instead redirecting all jumps targeting this block to the deleted
blocks jump target.

However we want to have an accurate representation of control
flow in the CFG. So we add/remove edges accordingly to account
for the eliminated blocks and new edges.

If we shortcut A -&gt; B -&gt; C to A -&gt; C:
* We delete edges A -&gt; B and B -&gt; C
* Replacing them with the edge A -&gt; C

We also try to preserve jump weights while doing so.

Note that:
* The edge B -&gt; C can't have interesting weights since
  the block B consists of a single unconditional jump without branching.
* We delete the edge A -&gt; B and add the edge A -&gt; C.
* The edge A -&gt; B can be one of many edges originating from A so likely
  has edge weights we want to preserve.

For this reason we simply store the edge info from the original A -&gt; B
edge and apply this information to the new edge A -&gt; C.

Sometimes we have a scenario where jump target C is not represented by an
BlockId but an immediate value. I'm only aware of this happening without
tables next to code currently.

Then we go from A ---&gt; B - -&gt; IMM   to   A - -&gt; IMM where the dashed arrows
are not stored in the CFG.

In that case we simply delete the edge A -&gt; B.

In terms of implementation the native backend first builds a mapping
from blocks suitable for shortcutting to their jump targets.
Then it redirects all jump instructions to these blocks using the
built up mapping.
This function (shortcutWeightMap) takes the same mapping and
applies the mapping to the CFG in the way layed out above.

-}</span><span>
</span><a name="line-227"></a><span class="hs-identifier">shortcutWeightMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-228"></a><a name="shortcutWeightMap"><a href="CFG.html#shortcutWeightMap"><span class="hs-identifier">shortcutWeightMap</span></a></a><span> </span><a name="local-6989586621680326307"><a href="#local-6989586621680326307"><span class="hs-identifier">cfg</span></a></a><span> </span><a name="local-6989586621680326308"><a href="#local-6989586621680326308"><span class="hs-identifier">cuts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-229"></a><span>  </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621680326309"><span class="hs-identifier hs-var">applyMapping</span></a><span> </span><a href="#local-6989586621680326307"><span class="hs-identifier hs-var">cfg</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><a href="#local-6989586621680326308"><span class="hs-identifier hs-var">cuts</span></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- takes the tuple (B,C) from the notation in [Updating the CFG during shortcutting]</span><span>
</span><a name="line-232"></a><span>      </span><span class="hs-identifier">applyMapping</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-233"></a><span>      </span><span class="hs-comment">--Shortcut immediate</span><span>
</span><a name="line-234"></a><span>      </span><a name="local-6989586621680326309"><a href="#local-6989586621680326309"><span class="hs-identifier">applyMapping</span></a></a><span> </span><a name="local-6989586621680326311"><a href="#local-6989586621680326311"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326312"><a href="#local-6989586621680326312"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-235"></a><span>        </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680326312"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-236"></a><span>        </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680326312"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680326311"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-237"></a><span>      </span><span class="hs-comment">--Regular shortcut</span><span>
</span><a name="line-238"></a><span>      </span><span class="hs-identifier">applyMapping</span><span> </span><a name="local-6989586621680326313"><a href="#local-6989586621680326313"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326314"><a href="#local-6989586621680326314"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326315"><a href="#local-6989586621680326315"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">updatedMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-240"></a><span>            </span><a name="local-6989586621680326316"><a href="#local-6989586621680326316"><span class="hs-identifier">updatedMap</span></a></a><span>
</span><a name="line-241"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326310"><span class="hs-identifier hs-var">shortcutEdge</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326314"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621680326315"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-242"></a><span>                </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680326314"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326313"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-comment">--Sometimes we can shortcut multiple blocks like so:</span><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- A -&gt; B -&gt; C -&gt; D -&gt; E =&gt; A -&gt; E</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">-- so we check for such chains.</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680326315"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326308"><span class="hs-identifier hs-var">cuts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-247"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680326316"><span class="hs-identifier hs-var">updatedMap</span></a><span>
</span><a name="line-248"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326317"><a href="#local-6989586621680326317"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680326309"><span class="hs-identifier hs-var">applyMapping</span></a><span> </span><a href="#local-6989586621680326316"><span class="hs-identifier hs-var">updatedMap</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326315"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680326317"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>      </span><span class="hs-comment">--Redirect edge from B to C</span><span>
</span><a name="line-250"></a><span>      </span><span class="hs-identifier">shortcutEdge</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span>
</span><a name="line-251"></a><span>      </span><a name="local-6989586621680326310"><a href="#local-6989586621680326310"><span class="hs-identifier">shortcutEdge</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326318"><a href="#local-6989586621680326318"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680326319"><a href="#local-6989586621680326319"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680326320"><a href="#local-6989586621680326320"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680326318"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326320"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-253"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326321"><a href="#local-6989586621680326321"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680326319"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326321"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680326318"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326320"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-254"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680326320"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-comment">-- | Sometimes we insert a block which should unconditionally be executed</span><span>
</span><a name="line-257"></a><span class="hs-comment">--   after a given block. This function updates the CFG for these cases.</span><span>
</span><a name="line-258"></a><span class="hs-comment">--  So we get A -&gt; B    =&gt; A -&gt; A' -&gt; B</span><span>
</span><a name="line-259"></a><span class="hs-comment">--             \                  \</span><span>
</span><a name="line-260"></a><span class="hs-comment">--              -&gt; C    =&gt;         -&gt; C</span><span>
</span><a name="line-261"></a><span class="hs-comment">--</span><span>
</span><a name="line-262"></a><span class="hs-identifier">addImmediateSuccessor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-263"></a><a name="addImmediateSuccessor"><a href="CFG.html#addImmediateSuccessor"><span class="hs-identifier">addImmediateSuccessor</span></a></a><span> </span><a name="local-6989586621680326322"><a href="#local-6989586621680326322"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621680326323"><a href="#local-6989586621680326323"><span class="hs-identifier">follower</span></a></a><span> </span><a name="local-6989586621680326324"><a href="#local-6989586621680326324"><span class="hs-identifier">cfg</span></a></a><span>
</span><a name="line-264"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326328"><span class="hs-identifier hs-var">updateEdges</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CFG.html#addWeightEdge"><span class="hs-identifier hs-var">addWeightEdge</span></a><span> </span><a href="#local-6989586621680326322"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680326323"><span class="hs-identifier hs-var">follower</span></a><span> </span><a href="#local-6989586621680326325"><span class="hs-identifier hs-var">uncondWeight</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680326324"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-265"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-266"></a><span>        </span><a name="local-6989586621680326325"><a href="#local-6989586621680326325"><span class="hs-identifier">uncondWeight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">D.uncondWeight</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-267"></a><span>                       </span><span class="hs-identifier">D.cfgWeightInfo</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">D.unsafeGlobalDynFlags</span><span>
</span><a name="line-268"></a><span>        </span><a name="local-6989586621680326326"><a href="#local-6989586621680326326"><span class="hs-identifier">targets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a><span> </span><a href="#local-6989586621680326324"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621680326322"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-269"></a><span>        </span><a name="local-6989586621680326327"><a href="#local-6989586621680326327"><span class="hs-identifier">successors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621680326326"><span class="hs-identifier hs-var">targets</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-270"></a><span>        </span><a name="local-6989586621680326328"><a href="#local-6989586621680326328"><span class="hs-identifier">updateEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326330"><span class="hs-identifier hs-var">addNewSuccs</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621680326329"><span class="hs-identifier hs-var">remOldSuccs</span></a><span>
</span><a name="line-271"></a><span>        </span><a name="local-6989586621680326329"><a href="#local-6989586621680326329"><span class="hs-identifier">remOldSuccs</span></a></a><span> </span><a name="local-6989586621680326331"><a href="#local-6989586621680326331"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><a href="CFG.html#delEdge"><span class="hs-identifier hs-var">delEdge</span></a><span> </span><a href="#local-6989586621680326322"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326331"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621680326327"><span class="hs-identifier hs-var">successors</span></a><span>
</span><a name="line-272"></a><span>        </span><a name="local-6989586621680326330"><a href="#local-6989586621680326330"><span class="hs-identifier">addNewSuccs</span></a></a><span> </span><a name="local-6989586621680326332"><a href="#local-6989586621680326332"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-273"></a><span>          </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326333"><a href="#local-6989586621680326333"><span class="hs-identifier">m'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326334"><a href="#local-6989586621680326334"><span class="hs-identifier">t</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326335"><a href="#local-6989586621680326335"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326323"><span class="hs-identifier hs-var">follower</span></a><span> </span><a href="#local-6989586621680326334"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680326335"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621680326333"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326332"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621680326326"><span class="hs-identifier hs-var">targets</span></a><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-comment">-- | Adds a new edge, overwrites existing edges if present</span><span>
</span><a name="line-276"></a><span class="hs-identifier">addEdge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-277"></a><a name="addEdge"><a href="CFG.html#addEdge"><span class="hs-identifier">addEdge</span></a></a><span> </span><a name="local-6989586621680326336"><a href="#local-6989586621680326336"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326337"><a href="#local-6989586621680326337"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326338"><a href="#local-6989586621680326338"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621680326339"><a href="#local-6989586621680326339"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-278"></a><span>    </span><a href="Hoopl.Collections.html#mapAlter"><span class="hs-identifier hs-var">mapAlter</span></a><span> </span><a href="#local-6989586621680326340"><span class="hs-identifier hs-var">addDest</span></a><span> </span><a href="#local-6989586621680326336"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326339"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-279"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-280"></a><span>        </span><a name="local-6989586621680326340"><a href="#local-6989586621680326340"><span class="hs-identifier">addDest</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><a href="#local-6989586621680326337"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326338"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-281"></a><span>        </span><span class="hs-identifier">addDest</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326341"><a href="#local-6989586621680326341"><span class="hs-identifier">wm</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680326337"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326338"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621680326341"><span class="hs-identifier hs-var">wm</span></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-comment">-- | Adds a edge with the given weight to the cfg</span><span>
</span><a name="line-284"></a><span class="hs-comment">--   If there already existed an edge it is overwritten.</span><span>
</span><a name="line-285"></a><span class="hs-comment">--   `addWeightEdge from to weight cfg`</span><span>
</span><a name="line-286"></a><span class="hs-identifier">addWeightEdge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-287"></a><a name="addWeightEdge"><a href="CFG.html#addWeightEdge"><span class="hs-identifier">addWeightEdge</span></a></a><span> </span><a name="local-6989586621680326342"><a href="#local-6989586621680326342"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326343"><a href="#local-6989586621680326343"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326344"><a href="#local-6989586621680326344"><span class="hs-identifier">weight</span></a></a><span> </span><a name="local-6989586621680326345"><a href="#local-6989586621680326345"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-288"></a><span>    </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326342"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326343"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#mkWeightInfo"><span class="hs-identifier hs-var">mkWeightInfo</span></a><span> </span><a href="#local-6989586621680326344"><span class="hs-identifier hs-var">weight</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326345"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-identifier">delEdge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-291"></a><a name="delEdge"><a href="CFG.html#delEdge"><span class="hs-identifier">delEdge</span></a></a><span> </span><a name="local-6989586621680326346"><a href="#local-6989586621680326346"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326347"><a href="#local-6989586621680326347"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326348"><a href="#local-6989586621680326348"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-292"></a><span>    </span><a href="Hoopl.Collections.html#mapAlter"><span class="hs-identifier hs-var">mapAlter</span></a><span> </span><a href="#local-6989586621680326349"><span class="hs-identifier hs-var">remDest</span></a><span> </span><a href="#local-6989586621680326346"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326348"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-293"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-294"></a><span>        </span><a name="local-6989586621680326349"><a href="#local-6989586621680326349"><span class="hs-identifier">remDest</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-295"></a><span>        </span><span class="hs-identifier">remDest</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326350"><a href="#local-6989586621680326350"><span class="hs-identifier">wm</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680326347"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326350"><span class="hs-identifier hs-var">wm</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- | Destinations from bid ordered by weight (descending)</span><span>
</span><a name="line-298"></a><span class="hs-identifier">getSuccEdgesSorted</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-299"></a><a name="getSuccEdgesSorted"><a href="CFG.html#getSuccEdgesSorted"><span class="hs-identifier">getSuccEdgesSorted</span></a></a><span> </span><a name="local-6989586621680326351"><a href="#local-6989586621680326351"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326352"><a href="#local-6989586621680326352"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-300"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680326353"><a href="#local-6989586621680326353"><span class="hs-identifier">destMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621680326352"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680326351"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-301"></a><span>        </span><a name="local-6989586621680326354"><a href="#local-6989586621680326354"><span class="hs-identifier">cfgEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><a href="#local-6989586621680326353"><span class="hs-identifier hs-var">destMap</span></a><span>
</span><a name="line-302"></a><span>        </span><a name="local-6989586621680326355"><a href="#local-6989586621680326355"><span class="hs-identifier">sortedEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">negate</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326354"><span class="hs-identifier hs-var">cfgEdges</span></a><span>
</span><a name="line-303"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-comment">--pprTrace &quot;getSuccEdgesSorted&quot; (ppr bid &lt;+&gt; text &quot;map:&quot; &lt;+&gt; ppr m)</span><span>
</span><a name="line-304"></a><span>        </span><a href="#local-6989586621680326355"><span class="hs-identifier hs-var">sortedEdges</span></a><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-comment">-- | Get successors of a given node with edge weights.</span><span>
</span><a name="line-307"></a><span class="hs-identifier">getSuccessorEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-308"></a><a name="getSuccessorEdges"><a href="CFG.html#getSuccessorEdges"><span class="hs-identifier">getSuccessorEdges</span></a></a><span> </span><a name="local-6989586621680326356"><a href="#local-6989586621680326356"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326357"><a href="#local-6989586621680326357"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680326357"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680326356"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-identifier">getEdgeInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span>
</span><a name="line-311"></a><a name="getEdgeInfo"><a href="CFG.html#getEdgeInfo"><span class="hs-identifier">getEdgeInfo</span></a></a><span> </span><a name="local-6989586621680326358"><a href="#local-6989586621680326358"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326359"><a href="#local-6989586621680326359"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326360"><a href="#local-6989586621680326360"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-312"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326361"><a href="#local-6989586621680326361"><span class="hs-identifier">wm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680326358"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326360"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-313"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326362"><a href="#local-6989586621680326362"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680326359"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326361"><span class="hs-identifier hs-var">wm</span></a><span>
</span><a name="line-314"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621680326362"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-315"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-316"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-identifier">reverseEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-319"></a><a name="reverseEdges"><a href="CFG.html#reverseEdges"><span class="hs-identifier">reverseEdges</span></a></a><span> </span><a name="local-6989586621680326363"><a href="#local-6989586621680326363"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680326366"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621680326365"><span class="hs-identifier hs-var">flatElems</span></a><span>
</span><a name="line-320"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-321"></a><span>    </span><a name="local-6989586621680326364"><a href="#local-6989586621680326364"><span class="hs-identifier">elems</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><a href="#local-6989586621680326363"><span class="hs-identifier hs-var">cfg</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-322"></a><span>    </span><a name="local-6989586621680326365"><a href="#local-6989586621680326365"><span class="hs-identifier">flatElems</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-323"></a><span>        </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680326367"><a href="#local-6989586621680326367"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326368"><a href="#local-6989586621680326368"><span class="hs-identifier">ws</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680326369"><a href="#local-6989586621680326369"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326370"><a href="#local-6989586621680326370"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326369"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">,</span><a href="#local-6989586621680326367"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621680326370"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326368"><span class="hs-identifier hs-var">ws</span></a><span> </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326364"><span class="hs-identifier hs-var">elems</span></a><span>
</span><a name="line-324"></a><span>    </span><a name="local-6989586621680326366"><a href="#local-6989586621680326366"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326371"><a href="#local-6989586621680326371"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326372"><a href="#local-6989586621680326372"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326373"><a href="#local-6989586621680326373"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680326374"><a href="#local-6989586621680326374"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326371"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326372"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326373"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621680326374"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-comment">-- | Returns a unordered list of all edges with info</span><span>
</span><a name="line-327"></a><span class="hs-identifier">infoEdgeList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-type">CfgEdge</span></a><span class="hs-special">]</span><span>
</span><a name="line-328"></a><a name="infoEdgeList"><a href="CFG.html#infoEdgeList"><span class="hs-identifier">infoEdgeList</span></a></a><span> </span><a name="local-6989586621680326375"><a href="#local-6989586621680326375"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-329"></a><span>  </span><a href="Hoopl.Collections.html#mapFoldMapWithKey"><span class="hs-identifier hs-var">mapFoldMapWithKey</span></a><span>
</span><a name="line-330"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326376"><a href="#local-6989586621680326376"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326377"><a href="#local-6989586621680326377"><span class="hs-identifier">toMap</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-331"></a><span>      </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680326378"><a href="#local-6989586621680326378"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326379"><a href="#local-6989586621680326379"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a href="#local-6989586621680326376"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326378"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326379"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><a href="#local-6989586621680326377"><span class="hs-identifier hs-var">toMap</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>    </span><a href="#local-6989586621680326375"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-comment">-- | Unordered list of edges with weight as Tuple (from,to,weight)</span><span>
</span><a name="line-335"></a><span class="hs-identifier">weightedEdgeList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-336"></a><a name="weightedEdgeList"><a href="CFG.html#weightedEdgeList"><span class="hs-identifier">weightedEdgeList</span></a></a><span> </span><a name="local-6989586621680326380"><a href="#local-6989586621680326380"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-337"></a><span>  </span><a href="Hoopl.Collections.html#mapFoldMapWithKey"><span class="hs-identifier hs-var">mapFoldMapWithKey</span></a><span>
</span><a name="line-338"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326381"><a href="#local-6989586621680326381"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326382"><a href="#local-6989586621680326382"><span class="hs-identifier">toMap</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-339"></a><span>      </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680326383"><a href="#local-6989586621680326383"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326384"><a href="#local-6989586621680326384"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621680326381"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621680326383"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326384"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><a href="#local-6989586621680326382"><span class="hs-identifier hs-var">toMap</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>    </span><a href="#local-6989586621680326380"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-342"></a><span>      </span><span class="hs-comment">--  (\(from, tos) -&gt; map (\(to,info) -&gt; (from,to, edgeWeight info)) tos )</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-comment">-- | Returns a unordered list of all edges without weights</span><span>
</span><a name="line-345"></a><span class="hs-identifier">edgeList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a><span class="hs-special">]</span><span>
</span><a name="line-346"></a><a name="edgeList"><a href="CFG.html#edgeList"><span class="hs-identifier">edgeList</span></a></a><span> </span><a name="local-6989586621680326385"><a href="#local-6989586621680326385"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-347"></a><span>        </span><a href="Hoopl.Collections.html#mapFoldMapWithKey"><span class="hs-identifier hs-var">mapFoldMapWithKey</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326386"><a href="#local-6989586621680326386"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326387"><a href="#local-6989586621680326387"><span class="hs-identifier">toMap</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326386"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a><span> </span><a href="#local-6989586621680326387"><span class="hs-identifier hs-var">toMap</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326385"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-comment">-- | Get successors of a given node without edge weights.</span><span>
</span><a name="line-350"></a><span class="hs-identifier">getSuccessors</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-351"></a><a name="getSuccessors"><a href="CFG.html#getSuccessors"><span class="hs-identifier">getSuccessors</span></a></a><span> </span><a name="local-6989586621680326388"><a href="#local-6989586621680326388"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326389"><a href="#local-6989586621680326389"><span class="hs-identifier">bid</span></a></a><span>
</span><a name="line-352"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326390"><a href="#local-6989586621680326390"><span class="hs-identifier">wm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680326389"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680326388"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a><span> </span><a href="#local-6989586621680326390"><span class="hs-identifier hs-var">wm</span></a><span>
</span><a name="line-354"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">pprEdgeWeights</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-357"></a><a name="pprEdgeWeights"><a href="CFG.html#pprEdgeWeights"><span class="hs-identifier">pprEdgeWeights</span></a></a><span> </span><a name="local-6989586621680326391"><a href="#local-6989586621680326391"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-358"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680326392"><a href="#local-6989586621680326392"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CFG.html#weightedEdgeList"><span class="hs-identifier hs-var">weightedEdgeList</span></a><span> </span><a href="#local-6989586621680326391"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-359"></a><span>        </span><a name="local-6989586621680326393"><a href="#local-6989586621680326393"><span class="hs-identifier">printEdge</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326398"><a href="#local-6989586621680326398"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680326399"><a href="#local-6989586621680326399"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680326400"><a href="#local-6989586621680326400"><span class="hs-identifier">weight</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326398"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-&gt;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326399"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-361"></a><span>              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[label=\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326400"><span class="hs-identifier hs-var">weight</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\&quot;,weight=\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-362"></a><span>              </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326400"><span class="hs-identifier hs-var">weight</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\&quot;];\n&quot;</span><span>
</span><a name="line-363"></a><span>        </span><span class="hs-comment">--for the case that there are no edges from/to this node.</span><span>
</span><a name="line-364"></a><span>        </span><span class="hs-comment">--This should rarely happen but it can save a lot of time</span><span>
</span><a name="line-365"></a><span>        </span><span class="hs-comment">--to immediately see it when it does.</span><span>
</span><a name="line-366"></a><span>        </span><a name="local-6989586621680326394"><a href="#local-6989586621680326394"><span class="hs-identifier">printNode</span></a></a><span> </span><a name="local-6989586621680326401"><a href="#local-6989586621680326401"><span class="hs-identifier">node</span></a></a><span>
</span><a name="line-367"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326401"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;;\n&quot;</span><span>
</span><a name="line-368"></a><span>        </span><a name="local-6989586621680326395"><a href="#local-6989586621680326395"><span class="hs-identifier">getEdgeNodes</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326402"><a href="#local-6989586621680326402"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680326403"><a href="#local-6989586621680326403"><span class="hs-identifier">to</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680326404"><a href="#local-6989586621680326404"><span class="hs-identifier">_weight</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680326402"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621680326403"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">]</span><span>
</span><a name="line-369"></a><span>        </span><a name="local-6989586621680326396"><a href="#local-6989586621680326396"><span class="hs-identifier">edgeNodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621680326395"><span class="hs-identifier hs-var">getEdgeNodes</span></a><span> </span><a href="#local-6989586621680326392"><span class="hs-identifier hs-var">edges</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-370"></a><span>        </span><a name="local-6989586621680326397"><a href="#local-6989586621680326397"><span class="hs-identifier">nodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326405"><a href="#local-6989586621680326405"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><a href="#local-6989586621680326405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326396"><span class="hs-identifier hs-var">edgeNodes</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Hoopl.Collections.html#mapKeys"><span class="hs-identifier hs-var">mapKeys</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapFilter"><span class="hs-identifier hs-var">mapFilter</span></a><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680326391"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-371"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-372"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;digraph {\n&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680326393"><span class="hs-identifier hs-var">printEdge</span></a><span> </span><a href="#local-6989586621680326392"><span class="hs-identifier hs-var">edges</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680326394"><span class="hs-identifier hs-var">printNode</span></a><span> </span><a href="#local-6989586621680326397"><span class="hs-identifier hs-var">nodes</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;}\n&quot;</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">updateEdgeWeight</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-comment">--Allows eliminating the tuple when possible</span><span>
</span><a name="line-378"></a><span class="hs-identifier">updateEdgeWeight</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#Edge"><span class="hs-identifier hs-type">Edge</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-379"></a><a name="updateEdgeWeight"><a href="CFG.html#updateEdgeWeight"><span class="hs-identifier">updateEdgeWeight</span></a></a><span> </span><a name="local-6989586621680326406"><a href="#local-6989586621680326406"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326407"><a href="#local-6989586621680326407"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680326408"><a href="#local-6989586621680326408"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680326409"><a href="#local-6989586621680326409"><span class="hs-identifier">cfg</span></a></a><span>
</span><a name="line-380"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326410"><a href="#local-6989586621680326410"><span class="hs-identifier">oldInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a><span> </span><a href="#local-6989586621680326407"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326408"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326409"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-381"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680326411"><a href="#local-6989586621680326411"><span class="hs-identifier">oldWeight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326410"><span class="hs-identifier hs-var">oldInfo</span></a><span>
</span><a name="line-382"></a><span>          </span><a name="local-6989586621680326412"><a href="#local-6989586621680326412"><span class="hs-identifier">newWeight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326406"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326411"><span class="hs-identifier hs-var">oldWeight</span></a><span>
</span><a name="line-383"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326407"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326408"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326410"><span class="hs-identifier hs-var">oldInfo</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">edgeWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326412"><span class="hs-identifier hs-var">newWeight</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326409"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-384"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-385"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Trying to update invalid edge&quot;</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-- from to oldWeight =&gt; newWeight</span><span>
</span><a name="line-388"></a><span class="hs-identifier">mapWeights</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-389"></a><a name="mapWeights"><a href="CFG.html#mapWeights"><span class="hs-identifier">mapWeights</span></a></a><span> </span><a name="local-6989586621680326413"><a href="#local-6989586621680326413"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680326414"><a href="#local-6989586621680326414"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-390"></a><span>  </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326415"><a href="#local-6989586621680326415"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-special">(</span><a href="CFG.html#CfgEdge"><span class="hs-identifier hs-var">CfgEdge</span></a><span> </span><a name="local-6989586621680326416"><a href="#local-6989586621680326416"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680326417"><a href="#local-6989586621680326417"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326418"><a href="#local-6989586621680326418"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-391"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680326419"><a href="#local-6989586621680326419"><span class="hs-identifier">oldWeight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326418"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-392"></a><span>                </span><a name="local-6989586621680326420"><a href="#local-6989586621680326420"><span class="hs-identifier">newWeight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326413"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326416"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326417"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326419"><span class="hs-identifier hs-var">oldWeight</span></a><span>
</span><a name="line-393"></a><span>            </span><span class="hs-keyword">in</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326416"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326417"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326418"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">edgeWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326420"><span class="hs-identifier hs-var">newWeight</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326415"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>          </span><a href="#local-6989586621680326414"><span class="hs-identifier hs-var">cfg</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#infoEdgeList"><span class="hs-identifier hs-var">infoEdgeList</span></a><span> </span><a href="#local-6989586621680326414"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-comment">-- | Insert a block in the control flow between two other blocks.</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- We pass a list of tuples (A,B,C) where</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- * A -&gt; C: Old edge</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- * A -&gt; B -&gt; C : New Arc, where B is the new block.</span><span>
</span><a name="line-401"></a><span class="hs-comment">-- It's possible that a block has two jumps to the same block</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- in the assembly code. However we still only store a single edge for</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- these cases.</span><span>
</span><a name="line-404"></a><span class="hs-comment">-- We assign the old edge info to the edge A -&gt; B and assign B -&gt; C the</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- weight of an unconditional jump.</span><span>
</span><a name="line-406"></a><span class="hs-identifier">addNodesBetween</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-407"></a><a name="addNodesBetween"><a href="CFG.html#addNodesBetween"><span class="hs-identifier">addNodesBetween</span></a></a><span> </span><a name="local-6989586621680326421"><a href="#local-6989586621680326421"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326422"><a href="#local-6989586621680326422"><span class="hs-identifier">updates</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-408"></a><span>  </span><span class="hs-identifier hs-var">foldl'</span><span>  </span><a href="#local-6989586621680326426"><span class="hs-identifier hs-var">updateWeight</span></a><span> </span><a href="#local-6989586621680326421"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-409"></a><span>          </span><a href="#local-6989586621680326424"><span class="hs-identifier hs-var">weightUpdates</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680326422"><span class="hs-identifier hs-var">updates</span></a><span>
</span><a name="line-410"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-411"></a><span>      </span><a name="local-6989586621680326423"><a href="#local-6989586621680326423"><span class="hs-identifier">weight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">D.uncondWeight</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-412"></a><span>                </span><span class="hs-identifier">D.cfgWeightInfo</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">D.unsafeGlobalDynFlags</span><span>
</span><a name="line-413"></a><span>      </span><span class="hs-comment">-- We might add two blocks for different jumps along a single</span><span>
</span><a name="line-414"></a><span>      </span><span class="hs-comment">-- edge. So we end up with edges:   A -&gt; B -&gt; C   ,   A -&gt; D -&gt; C</span><span>
</span><a name="line-415"></a><span>      </span><span class="hs-comment">-- in this case after applying the first update the weight for A -&gt; C</span><span>
</span><a name="line-416"></a><span>      </span><span class="hs-comment">-- is no longer available. So we calculate future weights before updates.</span><span>
</span><a name="line-417"></a><span>      </span><a name="local-6989586621680326424"><a href="#local-6989586621680326424"><span class="hs-identifier">weightUpdates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680326425"><span class="hs-identifier hs-var">getWeight</span></a><span>
</span><a name="line-418"></a><span>      </span><span class="hs-identifier">getWeight</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>      </span><a name="local-6989586621680326425"><a href="#local-6989586621680326425"><span class="hs-identifier">getWeight</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326427"><a href="#local-6989586621680326427"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326428"><a href="#local-6989586621680326428"><span class="hs-identifier">between</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326429"><a href="#local-6989586621680326429"><span class="hs-identifier">old</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326430"><a href="#local-6989586621680326430"><span class="hs-identifier">edgeInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CFG.html#getEdgeInfo"><span class="hs-identifier hs-var">getEdgeInfo</span></a><span> </span><a href="#local-6989586621680326427"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326429"><span class="hs-identifier hs-var">old</span></a><span> </span><a href="#local-6989586621680326421"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-421"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326427"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621680326428"><span class="hs-identifier hs-var">between</span></a><span class="hs-special">,</span><a href="#local-6989586621680326429"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">,</span><a href="#local-6989586621680326430"><span class="hs-identifier hs-var">edgeInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-422"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-423"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;Can't find weight for edge that should have one&quot;</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-424"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;triple&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326427"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><a href="#local-6989586621680326428"><span class="hs-identifier hs-var">between</span></a><span class="hs-special">,</span><a href="#local-6989586621680326429"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-425"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;updates&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680326422"><span class="hs-identifier hs-var">updates</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>      </span><span class="hs-identifier">updateWeight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-427"></a><span>      </span><a name="local-6989586621680326426"><a href="#local-6989586621680326426"><span class="hs-identifier">updateWeight</span></a></a><span> </span><a name="local-6989586621680326431"><a href="#local-6989586621680326431"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680326432"><a href="#local-6989586621680326432"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326433"><a href="#local-6989586621680326433"><span class="hs-identifier">between</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326434"><a href="#local-6989586621680326434"><span class="hs-identifier">old</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326435"><a href="#local-6989586621680326435"><span class="hs-identifier">edgeInfo</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#addEdge"><span class="hs-identifier hs-var">addEdge</span></a><span> </span><a href="#local-6989586621680326432"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326433"><span class="hs-identifier hs-var">between</span></a><span> </span><a href="#local-6989586621680326435"><span class="hs-identifier hs-var">edgeInfo</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-429"></a><span>          </span><a href="CFG.html#addWeightEdge"><span class="hs-identifier hs-var">addWeightEdge</span></a><span> </span><a href="#local-6989586621680326433"><span class="hs-identifier hs-var">between</span></a><span> </span><a href="#local-6989586621680326434"><span class="hs-identifier hs-var">old</span></a><span> </span><a href="#local-6989586621680326423"><span class="hs-identifier hs-var">weight</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-430"></a><span>          </span><a href="CFG.html#delEdge"><span class="hs-identifier hs-var">delEdge</span></a><span> </span><a href="#local-6989586621680326432"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326434"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680326431"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-comment">{-
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~~~       Note [CFG Edge Weights]    ~~~
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  Edge weights assigned do not currently represent a specific
  cost model and rather just a ranking of which blocks should
  be placed next to each other given their connection type in
  the CFG.
  This is especially relevant if we whenever two blocks will
  jump to the same target.

                     A   B
                      \ /
                       C

  Should A or B be placed in front of C? The block layout algorithm
  decides this based on which edge (A,C)/(B,C) is heavier. So we
  make a educated guess how often execution will transer control
  along each edge as well as how much we gain by placing eg A before
  C.

  We rank edges in this order:
  * Unconditional Control Transfer - They will always
    transfer control to their target. Unless there is a info table
    we can turn the jump into a fallthrough as well.
    We use 20k as default, so it's easy to spot if values have been
    modified but unlikely that we run into issues with overflow.
  * If branches (likely) - We assume branches marked as likely
    are taken more than 80% of the time.
    By ranking them below unconditional jumps we make sure we
    prefer the unconditional if there is a conditional and
    unconditional edge towards a block.
  * If branches (regular) - The false branch can potentially be turned
    into a fallthrough so we prefer it slightly over the true branch.
  * Unlikely branches - These can be assumed to be taken less than 20%
    of the time. So we given them one of the lowest priorities.
  * Switches - Switches at this level are implemented as jump tables
    so have a larger number of successors. So without more information
    we can only say that each individual successor is unlikely to be
    jumped to and we rank them accordingly.
  * Calls - We currently ignore calls completly:
        * By the time we return from a call there is a good chance
          that the address we return to has already been evicted from
          cache eliminating a main advantage sequential placement brings.
        * Calls always require a info table in front of their return
          address. This reduces the chance that we return to the same
          cache line further.


-}</span><span>
</span><a name="line-483"></a><span class="hs-comment">-- | Generate weights for a Cmm proc based on some simple heuristics.</span><span>
</span><a name="line-484"></a><span class="hs-identifier">getCfgProc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">D.CfgWeights</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-485"></a><a name="getCfgProc"><a href="CFG.html#getCfgProc"><span class="hs-identifier">getCfgProc</span></a></a><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-486"></a><span class="hs-comment">-- Sometimes GHC generates dummy procs which don't actually contain code.</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- But they might contain bottoms in some fields so we check for an empty</span><span>
</span><a name="line-488"></a><span class="hs-comment">-- body first. In particular this happens with SplitObjs enabled.</span><span>
</span><a name="line-489"></a><span class="hs-identifier">getCfgProc</span><span> </span><a name="local-6989586621680326436"><a href="#local-6989586621680326436"><span class="hs-identifier">weights</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680326437"><a href="#local-6989586621680326437"><span class="hs-identifier">_info</span></a></a><span> </span><a name="local-6989586621680326438"><a href="#local-6989586621680326438"><span class="hs-identifier">_lab</span></a></a><span> </span><a name="local-6989586621680326439"><a href="#local-6989586621680326439"><span class="hs-identifier">_live</span></a></a><span> </span><a name="local-6989586621680326440"><a href="#local-6989586621680326440"><span class="hs-identifier">graph</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#toBlockList"><span class="hs-identifier hs-var">toBlockList</span></a><span> </span><a href="#local-6989586621680326440"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-491"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#getCfg"><span class="hs-identifier hs-var">getCfg</span></a><span> </span><a href="#local-6989586621680326436"><span class="hs-identifier hs-var">weights</span></a><span> </span><a href="#local-6989586621680326440"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-identifier">getCfg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">D.CfgWeights</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-494"></a><a name="getCfg"><a href="CFG.html#getCfg"><span class="hs-identifier">getCfg</span></a></a><span> </span><a name="local-6989586621680326441"><a href="#local-6989586621680326441"><span class="hs-identifier">weights</span></a></a><span> </span><a name="local-6989586621680326442"><a href="#local-6989586621680326442"><span class="hs-identifier">graph</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621680326450"><span class="hs-identifier hs-var">insertEdge</span></a><span> </span><a href="#local-6989586621680326449"><span class="hs-identifier hs-var">edgelessCfg</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621680326451"><span class="hs-identifier hs-var">getBlockEdges</span></a><span> </span><a href="#local-6989586621680326452"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-497"></a><span>    </span><span class="hs-identifier hs-var">D.CFGWeights</span><span>
</span><a name="line-498"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">D.uncondWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326443"><a href="#local-6989586621680326443"><span class="hs-identifier">uncondWeight</span></a></a><span>
</span><a name="line-499"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">D.condBranchWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326444"><a href="#local-6989586621680326444"><span class="hs-identifier">condBranchWeight</span></a></a><span>
</span><a name="line-500"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">D.switchWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326445"><a href="#local-6989586621680326445"><span class="hs-identifier">switchWeight</span></a></a><span>
</span><a name="line-501"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">D.callWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326446"><a href="#local-6989586621680326446"><span class="hs-identifier">callWeight</span></a></a><span>
</span><a name="line-502"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">D.likelyCondWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326447"><a href="#local-6989586621680326447"><span class="hs-identifier">likelyCondWeight</span></a></a><span>
</span><a name="line-503"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">D.unlikelyCondWeight</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326448"><a href="#local-6989586621680326448"><span class="hs-identifier">unlikelyCondWeight</span></a></a><span>
</span><a name="line-504"></a><span>            </span><span class="hs-comment">--  Last two are used in other places</span><span>
</span><a name="line-505"></a><span>            </span><span class="hs-comment">--, D.infoTablePenalty = infoTablePenalty</span><span>
</span><a name="line-506"></a><span>            </span><span class="hs-comment">--, D.backEdgeBonus = backEdgeBonus</span><span>
</span><a name="line-507"></a><span>            </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326441"><span class="hs-identifier hs-var">weights</span></a><span>
</span><a name="line-508"></a><span>    </span><span class="hs-comment">-- Explicitly add all nodes to the cfg to ensure they are part of the</span><span>
</span><a name="line-509"></a><span>    </span><span class="hs-comment">-- CFG.</span><span>
</span><a name="line-510"></a><span>    </span><a name="local-6989586621680326449"><a href="#local-6989586621680326449"><span class="hs-identifier">edgelessCfg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">G.entryLabel</span></a><span> </span><a href="#local-6989586621680326452"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>    </span><span class="hs-identifier">insertEdge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-512"></a><span>    </span><a name="local-6989586621680326450"><a href="#local-6989586621680326450"><span class="hs-identifier">insertEdge</span></a></a><span> </span><a name="local-6989586621680326453"><a href="#local-6989586621680326453"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680326454"><a href="#local-6989586621680326454"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326455"><a href="#local-6989586621680326455"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><a name="local-6989586621680326456"><a href="#local-6989586621680326456"><span class="hs-identifier">weight</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-513"></a><span>      </span><a href="Hoopl.Collections.html#mapAlter"><span class="hs-identifier hs-var">mapAlter</span></a><span> </span><a href="#local-6989586621680326457"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326454"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680326453"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-514"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-515"></a><span>          </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>          </span><a name="local-6989586621680326457"><a href="#local-6989586621680326457"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><a href="#local-6989586621680326455"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326456"><span class="hs-identifier hs-var">weight</span></a><span>
</span><a name="line-517"></a><span>          </span><span class="hs-identifier">f</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326458"><a href="#local-6989586621680326458"><span class="hs-identifier">destMap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680326455"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326456"><span class="hs-identifier hs-var">weight</span></a><span> </span><a href="#local-6989586621680326458"><span class="hs-identifier hs-var">destMap</span></a><span>
</span><a name="line-518"></a><span>    </span><span class="hs-identifier">getBlockEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">,</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621680326451"><a href="#local-6989586621680326451"><span class="hs-identifier">getBlockEdges</span></a></a><span> </span><a name="local-6989586621680326459"><a href="#local-6989586621680326459"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-520"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680326463"><span class="hs-identifier hs-var">branch</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-521"></a><span>        </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680326466"><a href="#local-6989586621680326466"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326466"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621680326443"><span class="hs-identifier hs-var">uncondWeight</span></a><span class="hs-special">]</span><span>
</span><a name="line-522"></a><span>        </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680326467"><a href="#local-6989586621680326467"><span class="hs-identifier">_c</span></a></a><span> </span><a name="local-6989586621680326468"><a href="#local-6989586621680326468"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680326469"><a href="#local-6989586621680326469"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680326470"><a href="#local-6989586621680326470"><span class="hs-identifier">l</span></a></a><span>
</span><a name="line-523"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326470"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-524"></a><span>              </span><span class="hs-special">[</span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326469"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326444"><span class="hs-identifier hs-var">condBranchWeight</span></a><span class="hs-special">,</span><span>   </span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326468"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680326444"><span class="hs-identifier hs-var">condBranchWeight</span></a><span class="hs-special">]</span><span>
</span><a name="line-525"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326470"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-526"></a><span>              </span><span class="hs-special">[</span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326469"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326448"><span class="hs-identifier hs-var">unlikelyCondWeight</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326468"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680326447"><span class="hs-identifier hs-var">likelyCondWeight</span></a><span class="hs-special">]</span><span>
</span><a name="line-527"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326470"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-528"></a><span>              </span><span class="hs-special">[</span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326469"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680326447"><span class="hs-identifier hs-var">likelyCondWeight</span></a><span class="hs-special">,</span><span>   </span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326468"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680326448"><span class="hs-identifier hs-var">unlikelyCondWeight</span></a><span class="hs-special">]</span><span>
</span><a name="line-529"></a><span>        </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680326471"><a href="#local-6989586621680326471"><span class="hs-identifier">_e</span></a></a><span> </span><a name="local-6989586621680326472"><a href="#local-6989586621680326472"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-530"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680326473"><a href="#local-6989586621680326473"><span class="hs-identifier">switchTargets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmSwitch.html#switchTargetsToList"><span class="hs-identifier hs-var">switchTargetsToList</span></a><span> </span><a href="#local-6989586621680326472"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-531"></a><span>              </span><span class="hs-comment">--Compiler performance hack - for very wide switches don't</span><span>
</span><a name="line-532"></a><span>              </span><span class="hs-comment">--consider targets for layout.</span><span>
</span><a name="line-533"></a><span>              </span><a name="local-6989586621680326474"><a href="#local-6989586621680326474"><span class="hs-identifier">adjustedWeight</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-534"></a><span>                </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680326473"><span class="hs-identifier hs-var">switchTargets</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">10</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621680326445"><span class="hs-identifier hs-var">switchWeight</span></a><span>
</span><a name="line-535"></a><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326475"><a href="#local-6989586621680326475"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326475"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680326474"><span class="hs-identifier hs-var">adjustedWeight</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326473"><span class="hs-identifier hs-var">switchTargets</span></a><span>
</span><a name="line-536"></a><span>        </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680326476"><a href="#local-6989586621680326476"><span class="hs-identifier">cont</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326476"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621680326446"><span class="hs-identifier hs-var">callWeight</span></a><span class="hs-special">]</span><span>
</span><a name="line-537"></a><span>        </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">Cmm.succ</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680326477"><a href="#local-6989586621680326477"><span class="hs-identifier">cont</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680326462"><span class="hs-identifier hs-var">mkEdge</span></a><span> </span><a href="#local-6989586621680326477"><span class="hs-identifier hs-var">cont</span></a><span> </span><a href="#local-6989586621680326446"><span class="hs-identifier hs-var">callWeight</span></a><span class="hs-special">]</span><span>
</span><a name="line-538"></a><span>        </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-539"></a><span>        </span><a name="local-6989586621680326478"><a href="#local-6989586621680326478"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-540"></a><span>            </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Foo&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-541"></a><span>            </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span class="hs-identifier">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-string">&quot;Unkown successor cause:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-542"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">branch</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;=&gt;&quot;</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">G.successors</span><span> </span><span class="hs-identifier">other</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>            </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326479"><a href="#local-6989586621680326479"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621680326460"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">,</span><a href="#local-6989586621680326479"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">,</span><a href="#local-6989586621680326461"><span class="hs-identifier hs-var">mkEdgeInfo</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">G.successors</span></a><span> </span><a href="#local-6989586621680326478"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-544"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-545"></a><span>        </span><a name="local-6989586621680326460"><a href="#local-6989586621680326460"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">G.entryLabel</span></a><span> </span><a href="#local-6989586621680326459"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-546"></a><span>        </span><a name="local-6989586621680326461"><a href="#local-6989586621680326461"><span class="hs-identifier">mkEdgeInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#CmmSource"><span class="hs-identifier hs-var">CmmSource</span></a><span> </span><a href="#local-6989586621680326463"><span class="hs-identifier hs-var">branch</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-547"></a><span>        </span><a name="local-6989586621680326462"><a href="#local-6989586621680326462"><span class="hs-identifier">mkEdge</span></a></a><span> </span><a name="local-6989586621680326464"><a href="#local-6989586621680326464"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621680326465"><a href="#local-6989586621680326465"><span class="hs-identifier">weight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621680326460"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">,</span><a href="#local-6989586621680326464"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680326461"><span class="hs-identifier hs-var">mkEdgeInfo</span></a><span> </span><a href="#local-6989586621680326465"><span class="hs-identifier hs-var">weight</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>        </span><a name="local-6989586621680326463"><a href="#local-6989586621680326463"><span class="hs-identifier">branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#lastNode"><span class="hs-identifier hs-var">lastNode</span></a><span> </span><a href="#local-6989586621680326459"><span class="hs-identifier hs-var">block</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>    </span><a name="local-6989586621680326452"><a href="#local-6989586621680326452"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#revPostorder"><span class="hs-identifier hs-var">revPostorder</span></a><span> </span><a href="#local-6989586621680326442"><span class="hs-identifier hs-var">graph</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span class="hs-comment">--Find back edges by BFS</span><span>
</span><a name="line-553"></a><span class="hs-identifier">findBackEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#Edges"><span class="hs-identifier hs-type">Edges</span></a><span>
</span><a name="line-554"></a><a name="findBackEdges"><a href="CFG.html#findBackEdges"><span class="hs-identifier">findBackEdges</span></a></a><span> </span><a name="local-6989586621680326480"><a href="#local-6989586621680326480"><span class="hs-identifier">root</span></a></a><span> </span><a name="local-6989586621680326481"><a href="#local-6989586621680326481"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-555"></a><span>    </span><span class="hs-comment">--pprTraceIt &quot;Backedges:&quot; $</span><span>
</span><a name="line-556"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-557"></a><span>    </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326485"><a href="#local-6989586621680326485"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621680326485"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Backward</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680326484"><span class="hs-identifier hs-var">typedEdges</span></a><span>
</span><a name="line-558"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621680326482"><a href="#local-6989586621680326482"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#edgeList"><span class="hs-identifier hs-var">edgeList</span></a><span> </span><a href="#local-6989586621680326481"><span class="hs-identifier hs-var">cfg</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-560"></a><span>    </span><a name="local-6989586621680326483"><a href="#local-6989586621680326483"><span class="hs-identifier">getSuccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a><span> </span><a href="#local-6989586621680326481"><span class="hs-identifier hs-var">cfg</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-561"></a><span>    </span><a name="local-6989586621680326484"><a href="#local-6989586621680326484"><span class="hs-identifier">typedEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-562"></a><span>      </span><span class="hs-identifier hs-var">classifyEdges</span><span> </span><a href="#local-6989586621680326480"><span class="hs-identifier hs-var">root</span></a><span> </span><a href="#local-6989586621680326483"><span class="hs-identifier hs-var">getSuccs</span></a><span> </span><a href="#local-6989586621680326482"><span class="hs-identifier hs-var">edges</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier hs-type">EdgeType</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-identifier">optimizeCFG</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">D.CfgWeights</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-566"></a><a name="optimizeCFG"><a href="CFG.html#optimizeCFG"><span class="hs-identifier">optimizeCFG</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680326486"><a href="#local-6989586621680326486"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326486"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-567"></a><span class="hs-identifier">optimizeCFG</span><span> </span><a name="local-6989586621680326487"><a href="#local-6989586621680326487"><span class="hs-identifier">weights</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680326488"><a href="#local-6989586621680326488"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621680326489"><a href="#local-6989586621680326489"><span class="hs-identifier">_lab</span></a></a><span> </span><a name="local-6989586621680326490"><a href="#local-6989586621680326490"><span class="hs-identifier">_live</span></a></a><span> </span><a name="local-6989586621680326491"><a href="#local-6989586621680326491"><span class="hs-identifier">graph</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680326492"><a href="#local-6989586621680326492"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-568"></a><span>    </span><a href="#local-6989586621680326495"><span class="hs-identifier hs-var">favourFewerPreds</span></a><span>  </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-569"></a><span>    </span><a href="#local-6989586621680326494"><span class="hs-identifier hs-var">penalizeInfoTables</span></a><span> </span><a href="#local-6989586621680326488"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-570"></a><span>    </span><a href="#local-6989586621680326493"><span class="hs-identifier hs-var">increaseBackEdgeWeight</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680326491"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680326492"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-571"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>    </span><span class="hs-comment">-- | Increase the weight of all backedges in the CFG</span><span>
</span><a name="line-574"></a><span>    </span><span class="hs-comment">-- this helps to make loop jumpbacks the heaviest edges</span><span>
</span><a name="line-575"></a><span>    </span><span class="hs-identifier">increaseBackEdgeWeight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-576"></a><span>    </span><a name="local-6989586621680326493"><a href="#local-6989586621680326493"><span class="hs-identifier">increaseBackEdgeWeight</span></a></a><span> </span><a name="local-6989586621680326497"><a href="#local-6989586621680326497"><span class="hs-identifier">root</span></a></a><span> </span><a name="local-6989586621680326498"><a href="#local-6989586621680326498"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-577"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680326499"><a href="#local-6989586621680326499"><span class="hs-identifier">backedges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#findBackEdges"><span class="hs-identifier hs-var">findBackEdges</span></a><span> </span><a href="#local-6989586621680326497"><span class="hs-identifier hs-var">root</span></a><span> </span><a href="#local-6989586621680326498"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-578"></a><span>            </span><a name="local-6989586621680326500"><a href="#local-6989586621680326500"><span class="hs-identifier">update</span></a></a><span> </span><a name="local-6989586621680326501"><a href="#local-6989586621680326501"><span class="hs-identifier">weight</span></a></a><span>
</span><a name="line-579"></a><span>              </span><span class="hs-comment">--Keep irrelevant edges irrelevant</span><span>
</span><a name="line-580"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326501"><span class="hs-identifier hs-var">weight</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-581"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-582"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326501"><span class="hs-identifier hs-var">weight</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">D.backEdgeBonus</span><span> </span><a href="#local-6989586621680326487"><span class="hs-identifier hs-var">weights</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">foldl'</span><span>  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326502"><a href="#local-6989586621680326502"><span class="hs-identifier">cfg</span></a></a><span> </span><a name="local-6989586621680326503"><a href="#local-6989586621680326503"><span class="hs-identifier">edge</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#updateEdgeWeight"><span class="hs-identifier hs-var">updateEdgeWeight</span></a><span> </span><a href="#local-6989586621680326500"><span class="hs-identifier hs-var">update</span></a><span> </span><a href="#local-6989586621680326503"><span class="hs-identifier hs-var">edge</span></a><span> </span><a href="#local-6989586621680326502"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span>                    </span><a href="#local-6989586621680326498"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621680326499"><span class="hs-identifier hs-var">backedges</span></a><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>    </span><span class="hs-comment">-- | Since we cant fall through info tables we penalize these.</span><span>
</span><a name="line-587"></a><span>    </span><span class="hs-identifier">penalizeInfoTables</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621680326496"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-588"></a><span>    </span><a name="local-6989586621680326494"><a href="#local-6989586621680326494"><span class="hs-identifier">penalizeInfoTables</span></a></a><span> </span><a name="local-6989586621680326504"><a href="#local-6989586621680326504"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621680326505"><a href="#local-6989586621680326505"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-589"></a><span>        </span><a href="CFG.html#mapWeights"><span class="hs-identifier hs-var">mapWeights</span></a><span> </span><a href="#local-6989586621680326506"><span class="hs-identifier hs-var">fupdate</span></a><span> </span><a href="#local-6989586621680326505"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-590"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-591"></a><span>        </span><span class="hs-identifier">fupdate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span>
</span><a name="line-592"></a><span>        </span><a name="local-6989586621680326506"><a href="#local-6989586621680326506"><span class="hs-identifier">fupdate</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680326507"><a href="#local-6989586621680326507"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680326508"><a href="#local-6989586621680326508"><span class="hs-identifier">weight</span></a></a><span>
</span><a name="line-593"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621680326507"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326504"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-594"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326508"><span class="hs-identifier hs-var">weight</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">D.infoTablePenalty</span><span> </span><a href="#local-6989586621680326487"><span class="hs-identifier hs-var">weights</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326508"><span class="hs-identifier hs-var">weight</span></a><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-comment">{- Note [Optimize for Fallthrough]

-}</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-comment">-- | If a block has two successors, favour the one with fewer</span><span>
</span><a name="line-602"></a><span>    </span><span class="hs-comment">-- predecessors. (As that one is more likely to become a fallthrough)</span><span>
</span><a name="line-603"></a><span>    </span><span class="hs-identifier">favourFewerPreds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-604"></a><span>    </span><a name="local-6989586621680326495"><a href="#local-6989586621680326495"><span class="hs-identifier">favourFewerPreds</span></a></a><span> </span><a name="local-6989586621680326509"><a href="#local-6989586621680326509"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-605"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-606"></a><span>            </span><a name="local-6989586621680326514"><a href="#local-6989586621680326514"><span class="hs-identifier">revCfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-607"></a><span>              </span><a href="CFG.html#reverseEdges"><span class="hs-identifier hs-var">reverseEdges</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CFG.html#filterEdges"><span class="hs-identifier hs-var">filterEdges</span></a><span>
</span><a name="line-608"></a><span>                              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326519"><a href="#local-6989586621680326519"><span class="hs-identifier">_from</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680326510"><span class="hs-identifier hs-var">fallthroughTarget</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621680326509"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span>            </span><a name="local-6989586621680326515"><a href="#local-6989586621680326515"><span class="hs-identifier">predCount</span></a></a><span> </span><a name="local-6989586621680326520"><a href="#local-6989586621680326520"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a><span> </span><a href="#local-6989586621680326514"><span class="hs-identifier hs-var">revCfg</span></a><span> </span><a href="#local-6989586621680326520"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-611"></a><span>            </span><a name="local-6989586621680326516"><a href="#local-6989586621680326516"><span class="hs-identifier">nodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a><span> </span><a href="#local-6989586621680326509"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span>            </span><span class="hs-identifier">modifiers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">,</span><span> </span><a href="CFG.html#EdgeWeight"><span class="hs-identifier hs-type">EdgeWeight</span></a><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>            </span><a name="local-6989586621680326517"><a href="#local-6989586621680326517"><span class="hs-identifier">modifiers</span></a></a><span> </span><a name="local-6989586621680326521"><a href="#local-6989586621680326521"><span class="hs-identifier">preds1</span></a></a><span> </span><a name="local-6989586621680326522"><a href="#local-6989586621680326522"><span class="hs-identifier">preds2</span></a></a><span>
</span><a name="line-615"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326521"><span class="hs-identifier hs-var">preds1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span>  </span><a href="#local-6989586621680326522"><span class="hs-identifier hs-var">preds2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680326521"><span class="hs-identifier hs-var">preds1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326522"><span class="hs-identifier hs-var">preds2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span>            </span><a name="local-6989586621680326518"><a href="#local-6989586621680326518"><span class="hs-identifier">update</span></a></a><span> </span><a name="local-6989586621680326523"><a href="#local-6989586621680326523"><span class="hs-identifier">cfg</span></a></a><span> </span><a name="local-6989586621680326524"><a href="#local-6989586621680326524"><span class="hs-identifier">node</span></a></a><span>
</span><a name="line-620"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-6989586621680326525"><a href="#local-6989586621680326525"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326526"><a href="#local-6989586621680326526"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><a name="local-6989586621680326527"><a href="#local-6989586621680326527"><span class="hs-identifier">s2</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326528"><a href="#local-6989586621680326528"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CFG.html#getSuccessorEdges"><span class="hs-identifier hs-var">getSuccessorEdges</span></a><span> </span><a href="#local-6989586621680326523"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621680326524"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-621"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="local-6989586621680326529"><a href="#local-6989586621680326529"><span class="hs-identifier">w1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326526"><span class="hs-identifier hs-var">e1</span></a><span>
</span><a name="line-622"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="local-6989586621680326530"><a href="#local-6989586621680326530"><span class="hs-identifier">w2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">edgeWeight</span><span> </span><a href="#local-6989586621680326528"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-623"></a><span>              </span><span class="hs-comment">--Only change the weights if there isn't already a ordering.</span><span>
</span><a name="line-624"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680326529"><span class="hs-identifier hs-var">w1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680326530"><span class="hs-identifier hs-var">w2</span></a><span>
</span><a name="line-625"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680326531"><a href="#local-6989586621680326531"><span class="hs-identifier">mod1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680326532"><a href="#local-6989586621680326532"><span class="hs-identifier">mod2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680326517"><span class="hs-identifier hs-var">modifiers</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326515"><span class="hs-identifier hs-var">predCount</span></a><span> </span><a href="#local-6989586621680326525"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680326515"><span class="hs-identifier hs-var">predCount</span></a><span> </span><a href="#local-6989586621680326527"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326533"><a href="#local-6989586621680326533"><span class="hs-identifier">cfg'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-627"></a><span>                  </span><span class="hs-special">(</span><a href="CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-var">adjustEdgeWeight</span></a><span> </span><a href="#local-6989586621680326533"><span class="hs-identifier hs-var">cfg'</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621680326532"><span class="hs-identifier hs-var">mod2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326524"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680326527"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>                  </span><span class="hs-special">(</span><a href="CFG.html#adjustEdgeWeight"><span class="hs-identifier hs-var">adjustEdgeWeight</span></a><span> </span><a href="#local-6989586621680326523"><span class="hs-identifier hs-var">cfg</span></a><span>  </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621680326531"><span class="hs-identifier hs-var">mod1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326524"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680326525"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-630"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680326523"><span class="hs-identifier hs-var">cfg</span></a><span>
</span><a name="line-631"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="Hoopl.Collections.html#setFoldl"><span class="hs-identifier hs-var">setFoldl</span></a><span> </span><a href="#local-6989586621680326518"><span class="hs-identifier hs-var">update</span></a><span> </span><a href="#local-6989586621680326509"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621680326516"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-632"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-identifier">fallthroughTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-type">EdgeInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-634"></a><span>        </span><a name="local-6989586621680326510"><a href="#local-6989586621680326510"><span class="hs-identifier">fallthroughTarget</span></a></a><span> </span><a name="local-6989586621680326511"><a href="#local-6989586621680326511"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-special">(</span><a href="CFG.html#EdgeInfo"><span class="hs-identifier hs-var">EdgeInfo</span></a><span> </span><a name="local-6989586621680326512"><a href="#local-6989586621680326512"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621680326513"><a href="#local-6989586621680326513"><span class="hs-identifier">_weight</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621680326511"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621680326488"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-636"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="CFG.html#AsmCodeGen"><span class="hs-identifier hs-var">AsmCodeGen</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680326512"><span class="hs-identifier hs-var">source</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-637"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="CFG.html#CmmSource"><span class="hs-identifier hs-var">CmmSource</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680326512"><span class="hs-identifier hs-var">source</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-638"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="CFG.html#CmmSource"><span class="hs-identifier hs-var">CmmSource</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680326512"><span class="hs-identifier hs-var">source</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-639"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-comment">-- | Determine loop membership of blocks based on SCC analysis</span><span>
</span><a name="line-642"></a><span class="hs-comment">--   Ideally we would replace this with a variant giving us loop</span><span>
</span><a name="line-643"></a><span class="hs-comment">--   levels instead but the SCC code will do for now.</span><span>
</span><a name="line-644"></a><span class="hs-identifier">loopMembers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-645"></a><a name="loopMembers"><a href="CFG.html#loopMembers"><span class="hs-identifier">loopMembers</span></a></a><span> </span><a name="local-6989586621680326534"><a href="#local-6989586621680326534"><span class="hs-identifier">cfg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="#local-6989586621680326538"><span class="hs-identifier hs-var">setLevel</span></a><span class="hs-special">)</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621680326537"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-647"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-648"></a><span>    </span><span class="hs-identifier">mkNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-649"></a><span>    </span><a name="local-6989586621680326535"><a href="#local-6989586621680326535"><span class="hs-identifier">mkNode</span></a></a><span> </span><a name="local-6989586621680326539"><a href="#local-6989586621680326539"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621680326539"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680326539"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">(</span><a href="CFG.html#getSuccessors"><span class="hs-identifier hs-var">getSuccessors</span></a><span> </span><a href="#local-6989586621680326534"><span class="hs-identifier hs-var">cfg</span></a><span> </span><a href="#local-6989586621680326539"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>    </span><a name="local-6989586621680326536"><a href="#local-6989586621680326536"><span class="hs-identifier">nodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680326535"><span class="hs-identifier hs-var">mkNode</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setElems"><span class="hs-identifier hs-var">setElems</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CFG.html#getCfgNodes"><span class="hs-identifier hs-var">getCfgNodes</span></a><span> </span><a href="#local-6989586621680326534"><span class="hs-identifier hs-var">cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span>    </span><a name="local-6989586621680326537"><a href="#local-6989586621680326537"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesOrd</span><span> </span><a href="#local-6989586621680326536"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span>    </span><span class="hs-identifier">setLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-655"></a><span>    </span><a name="local-6989586621680326538"><a href="#local-6989586621680326538"><span class="hs-identifier">setLevel</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621680326540"><a href="#local-6989586621680326540"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680326541"><a href="#local-6989586621680326541"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680326540"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680326541"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-656"></a><span>    </span><span class="hs-identifier">setLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621680326542"><a href="#local-6989586621680326542"><span class="hs-identifier">bids</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680326543"><a href="#local-6989586621680326543"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680326544"><a href="#local-6989586621680326544"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621680326545"><a href="#local-6989586621680326545"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680326545"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680326544"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680326543"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621680326542"><span class="hs-identifier hs-var">bids</span></a><span>
</span><a name="line-657"></a></pre></body></html>