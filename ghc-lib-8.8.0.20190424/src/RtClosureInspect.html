<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, ScopedTypeVariables, MagicHash, UnboxedTuples #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- GHC Interactive support for inspecting arbitrary closures at runtime</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Pepe Iborra (supported by Google SoC) 2006</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RtClosureInspect</span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>     </span><span class="hs-comment">-- * Entry points and types</span><span>
</span><a name="line-12"></a><span>     </span><a href="RtClosureInspect.html#cvObtainTerm"><span class="hs-identifier hs-var">cvObtainTerm</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>     </span><a href="RtClosureInspect.html#cvReconstructType"><span class="hs-identifier hs-var">cvReconstructType</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>     </span><a href="RtClosureInspect.html#improveRTTIType"><span class="hs-identifier hs-var">improveRTTIType</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>     </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>     </span><span class="hs-comment">-- * Utils</span><span>
</span><a name="line-18"></a><span>     </span><a href="RtClosureInspect.html#isFullyEvaluatedTerm"><span class="hs-identifier hs-var">isFullyEvaluatedTerm</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>     </span><a href="RtClosureInspect.html#termType"><span class="hs-identifier hs-var">termType</span></a><span class="hs-special">,</span><span> </span><a href="RtClosureInspect.html#mapTermType"><span class="hs-identifier hs-var">mapTermType</span></a><span class="hs-special">,</span><span> </span><a href="RtClosureInspect.html#termTyCoVars"><span class="hs-identifier hs-var">termTyCoVars</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>     </span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span class="hs-special">,</span><span> </span><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier hs-type">TermFold</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>     </span><a href="RtClosureInspect.html#cPprTerm"><span class="hs-identifier hs-var">cPprTerm</span></a><span class="hs-special">,</span><span> </span><a href="RtClosureInspect.html#cPprTermBase"><span class="hs-identifier hs-var">cPprTermBase</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>     </span><a href="RtClosureInspect.html#constrClosToName"><span class="hs-identifier hs-var">constrClosToName</span></a><span> </span><span class="hs-comment">-- exported to use in test T4891</span><span>
</span><a name="line-24"></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.html"><span class="hs-identifier">GHCi</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Unify</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">U</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypeX"><span class="hs-identifier hs-var">zonkTcTypeToTypeX</span></a><span class="hs-special">,</span><span> </span><a href="TcHsSyn.html#mkEmptyZonkEnv"><span class="hs-identifier hs-var">mkEmptyZonkEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcHsSyn.html#ZonkFlexi"><span class="hs-identifier hs-type">ZonkFlexi</span></a><span class="hs-special">(</span><span> </span><a href="TcHsSyn.html#RuntimeUnkFlexi"><span class="hs-identifier hs-var">RuntimeUnkFlexi</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OccName</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Boxity</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Ppr</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Char</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts.Heap</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="SMRep.html#roundUpTo"><span class="hs-identifier hs-var">roundUpTo</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-66"></a><span class="hs-cpp">#if defined(INTEGER_GMP)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array.Base</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Integer.GMP.Internals</span><span>
</span><a name="line-70"></a><span class="hs-cpp">#elif defined(INTEGER_SIMPLE)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Integer.Simple.Internals</span><span>
</span><a name="line-73"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Seq</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Sequence</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">viewl</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ViewL</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Unsafe</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">---------------------------------------------</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- * A representation of semi evaluated Terms</span><span>
</span><a name="line-82"></a><span class="hs-comment">---------------------------------------------</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-keyword">data</span><span> </span><a name="Term"><a href="RtClosureInspect.html#Term"><span class="hs-identifier">Term</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Term"><a href="RtClosureInspect.html#Term"><span class="hs-identifier">Term</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ty"><a href="RtClosureInspect.html#ty"><span class="hs-identifier">ty</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span>
</span><a name="line-85"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="dc"><a href="RtClosureInspect.html#dc"><span class="hs-identifier">dc</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-86"></a><span>                               </span><span class="hs-comment">-- Carries a text representation if the datacon is</span><span>
</span><a name="line-87"></a><span>                               </span><span class="hs-comment">-- not exported by the .hi file, which is the case</span><span>
</span><a name="line-88"></a><span>                               </span><span class="hs-comment">-- for private constructors in -O0 compiled libraries</span><span>
</span><a name="line-89"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="val"><a href="RtClosureInspect.html#val"><span class="hs-identifier">val</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-90"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="subTerms"><a href="RtClosureInspect.html#subTerms"><span class="hs-identifier">subTerms</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="Prim"><a href="RtClosureInspect.html#Prim"><span class="hs-identifier">Prim</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ty"><a href="RtClosureInspect.html#ty"><span class="hs-identifier">ty</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span>
</span><a name="line-93"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="valRaw"><a href="RtClosureInspect.html#valRaw"><span class="hs-identifier">valRaw</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="Suspension"><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier">Suspension</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ctype"><a href="RtClosureInspect.html#ctype"><span class="hs-identifier">ctype</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClosureType</span><span>
</span><a name="line-96"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="ty"><a href="RtClosureInspect.html#ty"><span class="hs-identifier">ty</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span>
</span><a name="line-97"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="val"><a href="RtClosureInspect.html#val"><span class="hs-identifier">val</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-98"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="bound_to"><a href="RtClosureInspect.html#bound_to"><span class="hs-identifier">bound_to</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span>   </span><span class="hs-comment">-- Useful for printing</span><span>
</span><a name="line-99"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-100"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="NewtypeWrap"><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier">NewtypeWrap</span></a></a><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- At runtime there are no newtypes, and hence no</span><span>
</span><a name="line-101"></a><span>                               </span><span class="hs-comment">-- newtype constructors. A NewtypeWrap is just a</span><span>
</span><a name="line-102"></a><span>                               </span><span class="hs-comment">-- made-up tag saying &quot;heads up, there used to be</span><span>
</span><a name="line-103"></a><span>                               </span><span class="hs-comment">-- a newtype constructor here&quot;.</span><span>
</span><a name="line-104"></a><span>                         </span><a name="ty"><a href="RtClosureInspect.html#ty"><span class="hs-identifier">ty</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span>
</span><a name="line-105"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="dc"><a href="RtClosureInspect.html#dc"><span class="hs-identifier">dc</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-106"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="wrapped_term"><a href="RtClosureInspect.html#wrapped_term"><span class="hs-identifier">wrapped_term</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-107"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="RefWrap"><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier">RefWrap</span></a></a><span>    </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- The contents of a reference</span><span>
</span><a name="line-108"></a><span>                         </span><a name="ty"><a href="RtClosureInspect.html#ty"><span class="hs-identifier">ty</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span>
</span><a name="line-109"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="wrapped_term"><a href="RtClosureInspect.html#wrapped_term"><span class="hs-identifier">wrapped_term</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-identifier">termType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span>
</span><a name="line-112"></a><a name="termType"><a href="RtClosureInspect.html#termType"><span class="hs-identifier">termType</span></a></a><span> </span><a name="local-6989586621683032469"><a href="#local-6989586621683032469"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ty</span><span> </span><a href="#local-6989586621683032469"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">isFullyEvaluatedTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-115"></a><a name="isFullyEvaluatedTerm"><a href="RtClosureInspect.html#isFullyEvaluatedTerm"><span class="hs-identifier">isFullyEvaluatedTerm</span></a></a><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><a name="local-6989586621683032470"><a href="#local-6989586621683032470"><span class="hs-identifier">tt</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="RtClosureInspect.html#isFullyEvaluatedTerm"><span class="hs-identifier hs-var">isFullyEvaluatedTerm</span></a><span> </span><a href="#local-6989586621683032470"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-116"></a><span class="hs-identifier">isFullyEvaluatedTerm</span><span> </span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-117"></a><span class="hs-identifier">isFullyEvaluatedTerm</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span class="hs-special">{</span><span class="hs-identifier">wrapped_term</span><span class="hs-glyph">=</span><a name="local-6989586621683032471"><a href="#local-6989586621683032471"><span class="hs-identifier">t</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#isFullyEvaluatedTerm"><span class="hs-identifier hs-var">isFullyEvaluatedTerm</span></a><span> </span><a href="#local-6989586621683032471"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-118"></a><span class="hs-identifier">isFullyEvaluatedTerm</span><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span class="hs-special">{</span><span class="hs-identifier">wrapped_term</span><span class="hs-glyph">=</span><a name="local-6989586621683032472"><a href="#local-6989586621683032472"><span class="hs-identifier">t</span></a></a><span class="hs-special">}</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#isFullyEvaluatedTerm"><span class="hs-identifier hs-var">isFullyEvaluatedTerm</span></a><span> </span><a href="#local-6989586621683032472"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-119"></a><span class="hs-identifier">isFullyEvaluatedTerm</span><span> </span><span class="hs-identifier">_</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-122"></a><span> </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a name="local-6989586621683032452"><a href="#local-6989586621683032452"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032453"><a href="#local-6989586621683032453"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#cPprTerm"><span class="hs-identifier hs-var">cPprTerm</span></a><span> </span><a href="RtClosureInspect.html#cPprTermBase"><span class="hs-identifier hs-var">cPprTermBase</span></a><span> </span><a href="#local-6989586621683032452"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032453"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-123"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Outputable Term instance&quot;</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- Runtime Closure information functions</span><span>
</span><a name="line-127"></a><span class="hs-comment">----------------------------------------</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-identifier">isThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GenClosure</span><span> </span><a href="#local-6989586621683032468"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-130"></a><a name="isThunk"><a href="RtClosureInspect.html#isThunk"><span class="hs-identifier">isThunk</span></a></a><span> </span><span class="hs-identifier hs-var">ThunkClosure</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-131"></a><span class="hs-identifier">isThunk</span><span> </span><span class="hs-identifier hs-var">APClosure</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-132"></a><span class="hs-identifier">isThunk</span><span> </span><span class="hs-identifier hs-var">APStackClosure</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-133"></a><span class="hs-identifier">isThunk</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-comment">-- Lookup the name in a constructor closure</span><span>
</span><a name="line-136"></a><span class="hs-identifier">constrClosToName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenClosure</span><span> </span><a href="#local-6989586621683032467"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><a name="constrClosToName"><a href="RtClosureInspect.html#constrClosToName"><span class="hs-identifier">constrClosToName</span></a></a><span> </span><a name="local-6989586621683032473"><a href="#local-6989586621683032473"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-identifier hs-var">ConstrClosure</span><span class="hs-special">{</span><span class="hs-identifier">pkg</span><span class="hs-glyph">=</span><a name="local-6989586621683032474"><a href="#local-6989586621683032474"><span class="hs-identifier">pkg</span></a></a><span class="hs-special">,</span><span class="hs-identifier">modl</span><span class="hs-glyph">=</span><a name="local-6989586621683032475"><a href="#local-6989586621683032475"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span class="hs-identifier">name</span><span class="hs-glyph">=</span><a name="local-6989586621683032476"><a href="#local-6989586621683032476"><span class="hs-identifier">occ</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-138"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032477"><a href="#local-6989586621683032477"><span class="hs-identifier">occName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkOccName</span><span> </span><span class="hs-identifier hs-var">OccName.dataName</span><span> </span><a href="#local-6989586621683032476"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-139"></a><span>       </span><a name="local-6989586621683032478"><a href="#local-6989586621683032478"><span class="hs-identifier">modName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stringToUnitId</span><span> </span><a href="#local-6989586621683032474"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><a href="#local-6989586621683032475"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>   </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="IfaceEnv.html#lookupOrigIO"><span class="hs-identifier hs-var">lookupOrigIO</span></a><span> </span><a href="#local-6989586621683032473"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032478"><span class="hs-identifier hs-var">modName</span></a><span> </span><a href="#local-6989586621683032477"><span class="hs-identifier hs-var">occName</span></a><span>
</span><a name="line-141"></a><span class="hs-identifier">constrClosToName</span><span> </span><a name="local-6989586621683032479"><a href="#local-6989586621683032479"><span class="hs-identifier">_hsc_env</span></a></a><span> </span><a name="local-6989586621683032480"><a href="#local-6989586621683032480"><span class="hs-identifier">clos</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-142"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;conClosToName: Expected ConstrClosure, got &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032480"><span class="hs-identifier hs-var">clos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- * Traversals for Terms</span><span>
</span><a name="line-146"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-147"></a><span class="hs-keyword">type</span><span> </span><a name="TermProcessor"><a href="RtClosureInspect.html#TermProcessor"><span class="hs-identifier">TermProcessor</span></a></a><span> </span><a name="local-6989586621683032450"><a href="#local-6989586621683032450"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683032451"><a href="#local-6989586621683032451"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032450"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032451"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-keyword">data</span><span> </span><a name="TermFold"><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier">TermFold</span></a></a><span> </span><a name="local-6989586621683032449"><a href="#local-6989586621683032449"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TermFold"><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier">TermFold</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="fTerm"><a href="RtClosureInspect.html#fTerm"><span class="hs-identifier">fTerm</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#TermProcessor"><span class="hs-identifier hs-type">TermProcessor</span></a><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-150"></a><span>                           </span><span class="hs-special">,</span><span> </span><a name="fPrim"><a href="RtClosureInspect.html#fPrim"><span class="hs-identifier">fPrim</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-151"></a><span>                           </span><span class="hs-special">,</span><span> </span><a name="fSuspension"><a href="RtClosureInspect.html#fSuspension"><span class="hs-identifier">fSuspension</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClosureType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-152"></a><span>                                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-153"></a><span>                           </span><span class="hs-special">,</span><span> </span><a name="fNewtypeWrap"><a href="RtClosureInspect.html#fNewtypeWrap"><span class="hs-identifier">fNewtypeWrap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-154"></a><span>                                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-155"></a><span>                           </span><span class="hs-special">,</span><span> </span><a name="fRefWrap"><a href="RtClosureInspect.html#fRefWrap"><span class="hs-identifier">fRefWrap</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032449"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-156"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-keyword">data</span><span> </span><a name="TermFoldM"><a href="RtClosureInspect.html#TermFoldM"><span class="hs-identifier">TermFoldM</span></a></a><span> </span><a name="local-6989586621683032447"><a href="#local-6989586621683032447"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621683032448"><a href="#local-6989586621683032448"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-160"></a><span>                   </span><a name="TermFoldM"><a href="RtClosureInspect.html#TermFoldM"><span class="hs-identifier">TermFoldM</span></a></a><span> </span><span class="hs-special">{</span><a name="fTermM"><a href="RtClosureInspect.html#fTermM"><span class="hs-identifier">fTermM</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#TermProcessor"><span class="hs-identifier hs-type">TermProcessor</span></a><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032447"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>                            </span><span class="hs-special">,</span><span> </span><a name="fPrimM"><a href="RtClosureInspect.html#fPrimM"><span class="hs-identifier">fPrimM</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032447"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-162"></a><span>                            </span><span class="hs-special">,</span><span> </span><a name="fSuspensionM"><a href="RtClosureInspect.html#fSuspensionM"><span class="hs-identifier">fSuspensionM</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClosureType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-163"></a><span>                                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032447"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-164"></a><span>                            </span><span class="hs-special">,</span><span> </span><a name="fNewtypeWrapM"><a href="RtClosureInspect.html#fNewtypeWrapM"><span class="hs-identifier">fNewtypeWrapM</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-165"></a><span>                                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032447"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-166"></a><span>                            </span><span class="hs-special">,</span><span> </span><a name="fRefWrapM"><a href="RtClosureInspect.html#fRefWrapM"><span class="hs-identifier">fRefWrapM</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032447"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032448"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-167"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">foldTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier hs-type">TermFold</span></a><span> </span><a href="#local-6989586621683032466"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032466"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-170"></a><a name="foldTerm"><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier">foldTerm</span></a></a><span> </span><a name="local-6989586621683032481"><a href="#local-6989586621683032481"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a name="local-6989586621683032482"><a href="#local-6989586621683032482"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032483"><a href="#local-6989586621683032483"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032484"><a href="#local-6989586621683032484"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683032485"><a href="#local-6989586621683032485"><span class="hs-identifier">tt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fTerm</span><span> </span><a href="#local-6989586621683032481"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032482"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032483"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032484"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="#local-6989586621683032481"><span class="hs-identifier hs-var">tf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032485"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span class="hs-identifier">foldTerm</span><span> </span><a name="local-6989586621683032486"><a href="#local-6989586621683032486"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span> </span><a name="local-6989586621683032487"><a href="#local-6989586621683032487"><span class="hs-identifier">ty</span></a></a><span>    </span><a name="local-6989586621683032488"><a href="#local-6989586621683032488"><span class="hs-identifier">v</span></a></a><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fPrim</span><span> </span><a href="#local-6989586621683032486"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032487"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032488"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-172"></a><span class="hs-identifier">foldTerm</span><span> </span><a name="local-6989586621683032489"><a href="#local-6989586621683032489"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a name="local-6989586621683032490"><a href="#local-6989586621683032490"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621683032491"><a href="#local-6989586621683032491"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032492"><a href="#local-6989586621683032492"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683032493"><a href="#local-6989586621683032493"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fSuspension</span><span> </span><a href="#local-6989586621683032489"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032490"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621683032491"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032492"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621683032493"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-173"></a><span class="hs-identifier">foldTerm</span><span> </span><a name="local-6989586621683032494"><a href="#local-6989586621683032494"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span> </span><a name="local-6989586621683032495"><a href="#local-6989586621683032495"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032496"><a href="#local-6989586621683032496"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032497"><a href="#local-6989586621683032497"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fNewtypeWrap</span><span> </span><a href="#local-6989586621683032494"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032495"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032496"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="#local-6989586621683032494"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032497"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span class="hs-identifier">foldTerm</span><span> </span><a name="local-6989586621683032498"><a href="#local-6989586621683032498"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span> </span><a name="local-6989586621683032499"><a href="#local-6989586621683032499"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032500"><a href="#local-6989586621683032500"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fRefWrap</span><span> </span><a href="#local-6989586621683032498"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032499"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="#local-6989586621683032498"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032500"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-identifier">foldTermM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621683032464"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RtClosureInspect.html#TermFoldM"><span class="hs-identifier hs-type">TermFoldM</span></a><span> </span><a href="#local-6989586621683032464"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032465"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032464"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621683032465"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-178"></a><a name="foldTermM"><a href="RtClosureInspect.html#foldTermM"><span class="hs-identifier">foldTermM</span></a></a><span> </span><a name="local-6989586621683032501"><a href="#local-6989586621683032501"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a name="local-6989586621683032502"><a href="#local-6989586621683032502"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032503"><a href="#local-6989586621683032503"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032504"><a href="#local-6989586621683032504"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683032505"><a href="#local-6989586621683032505"><span class="hs-identifier">tt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#foldTermM"><span class="hs-identifier hs-var">foldTermM</span></a><span> </span><a href="#local-6989586621683032501"><span class="hs-identifier hs-var">tf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032505"><span class="hs-identifier hs-var">tt</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier">fTermM</span><span> </span><a href="#local-6989586621683032501"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032502"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032503"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032504"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-179"></a><span class="hs-identifier">foldTermM</span><span> </span><a name="local-6989586621683032506"><a href="#local-6989586621683032506"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span> </span><a name="local-6989586621683032507"><a href="#local-6989586621683032507"><span class="hs-identifier">ty</span></a></a><span>    </span><a name="local-6989586621683032508"><a href="#local-6989586621683032508"><span class="hs-identifier">v</span></a></a><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fPrimM</span><span> </span><a href="#local-6989586621683032506"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032507"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032508"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-180"></a><span class="hs-identifier">foldTermM</span><span> </span><a name="local-6989586621683032509"><a href="#local-6989586621683032509"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a name="local-6989586621683032510"><a href="#local-6989586621683032510"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621683032511"><a href="#local-6989586621683032511"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032512"><a href="#local-6989586621683032512"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683032513"><a href="#local-6989586621683032513"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fSuspensionM</span><span> </span><a href="#local-6989586621683032509"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032510"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621683032511"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032512"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621683032513"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-181"></a><span class="hs-identifier">foldTermM</span><span> </span><a name="local-6989586621683032514"><a href="#local-6989586621683032514"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span> </span><a name="local-6989586621683032515"><a href="#local-6989586621683032515"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032516"><a href="#local-6989586621683032516"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032517"><a href="#local-6989586621683032517"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTermM"><span class="hs-identifier hs-var">foldTermM</span></a><span> </span><a href="#local-6989586621683032514"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032517"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span>  </span><span class="hs-identifier">fNewtypeWrapM</span><span> </span><a href="#local-6989586621683032514"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032515"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032516"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-182"></a><span class="hs-identifier">foldTermM</span><span> </span><a name="local-6989586621683032518"><a href="#local-6989586621683032518"><span class="hs-identifier">tf</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span> </span><a name="local-6989586621683032519"><a href="#local-6989586621683032519"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032520"><a href="#local-6989586621683032520"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTermM"><span class="hs-identifier hs-var">foldTermM</span></a><span> </span><a href="#local-6989586621683032518"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032520"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier">fRefWrapM</span><span> </span><a href="#local-6989586621683032518"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621683032519"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">idTermFold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier hs-type">TermFold</span></a><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-185"></a><a name="idTermFold"><a href="RtClosureInspect.html#idTermFold"><span class="hs-identifier">idTermFold</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier hs-var">TermFold</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-186"></a><span>              </span><span class="hs-identifier">fTerm</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">,</span><span>
</span><a name="line-187"></a><span>              </span><span class="hs-identifier">fPrim</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">,</span><span>
</span><a name="line-188"></a><span>              </span><span class="hs-identifier">fSuspension</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span class="hs-special">,</span><span>
</span><a name="line-189"></a><span>              </span><span class="hs-identifier">fNewtypeWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span class="hs-special">,</span><span>
</span><a name="line-190"></a><span>              </span><span class="hs-identifier">fRefWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span>
</span><a name="line-191"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">mapTermType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-194"></a><a name="mapTermType"><a href="RtClosureInspect.html#mapTermType"><span class="hs-identifier">mapTermType</span></a></a><span> </span><a name="local-6989586621683032521"><a href="#local-6989586621683032521"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="RtClosureInspect.html#idTermFold"><span class="hs-identifier hs-var">idTermFold</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-195"></a><span>          </span><span class="hs-identifier">fTerm</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032522"><a href="#local-6989586621683032522"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032523"><a href="#local-6989586621683032523"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032524"><a href="#local-6989586621683032524"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621683032525"><a href="#local-6989586621683032525"><span class="hs-identifier">tt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032521"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032522"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032523"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032524"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032525"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">,</span><span>
</span><a name="line-196"></a><span>          </span><span class="hs-identifier">fSuspension</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032526"><a href="#local-6989586621683032526"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621683032527"><a href="#local-6989586621683032527"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032528"><a href="#local-6989586621683032528"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621683032529"><a href="#local-6989586621683032529"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-197"></a><span>                          </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a href="#local-6989586621683032526"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032521"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032527"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032528"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032529"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span>
</span><a name="line-198"></a><span>          </span><span class="hs-identifier">fNewtypeWrap</span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032530"><a href="#local-6989586621683032530"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032531"><a href="#local-6989586621683032531"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032532"><a href="#local-6989586621683032532"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032521"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032530"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032531"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032532"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span>
</span><a name="line-199"></a><span>          </span><span class="hs-identifier">fRefWrap</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032533"><a href="#local-6989586621683032533"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032534"><a href="#local-6989586621683032534"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032521"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032533"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032534"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">}</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-identifier">mapTermTypeM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621683032463"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>  </span><span class="hs-special">(</span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032463"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032463"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-202"></a><a name="mapTermTypeM"><a href="RtClosureInspect.html#mapTermTypeM"><span class="hs-identifier">mapTermTypeM</span></a></a><span> </span><a name="local-6989586621683032535"><a href="#local-6989586621683032535"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTermM"><span class="hs-identifier hs-var">foldTermM</span></a><span> </span><a href="RtClosureInspect.html#TermFoldM"><span class="hs-identifier hs-var">TermFoldM</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-identifier">fTermM</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032536"><a href="#local-6989586621683032536"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032537"><a href="#local-6989586621683032537"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032538"><a href="#local-6989586621683032538"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621683032539"><a href="#local-6989586621683032539"><span class="hs-identifier">tt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032535"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032536"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032540"><a href="#local-6989586621683032540"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032540"><span class="hs-identifier hs-var">ty'</span></a><span>  </span><a href="#local-6989586621683032537"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032538"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032539"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">,</span><span>
</span><a name="line-204"></a><span>          </span><span class="hs-identifier">fPrimM</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">,</span><span>
</span><a name="line-205"></a><span>          </span><span class="hs-identifier">fSuspensionM</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032541"><a href="#local-6989586621683032541"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621683032542"><a href="#local-6989586621683032542"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032543"><a href="#local-6989586621683032543"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621683032544"><a href="#local-6989586621683032544"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-206"></a><span>                          </span><a href="#local-6989586621683032535"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032542"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032545"><a href="#local-6989586621683032545"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a href="#local-6989586621683032541"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621683032545"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683032543"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032544"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span>
</span><a name="line-207"></a><span>          </span><span class="hs-identifier">fNewtypeWrapM</span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032546"><a href="#local-6989586621683032546"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032547"><a href="#local-6989586621683032547"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032548"><a href="#local-6989586621683032548"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032535"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032546"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032549"><a href="#local-6989586621683032549"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span> </span><a href="#local-6989586621683032549"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683032547"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032548"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span>
</span><a name="line-208"></a><span>          </span><span class="hs-identifier">fRefWrapM</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032550"><a href="#local-6989586621683032550"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032551"><a href="#local-6989586621683032551"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032535"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032550"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032552"><a href="#local-6989586621683032552"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span> </span><a href="#local-6989586621683032552"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683032551"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">}</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">termTyCoVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCoVarSet</span><span>
</span><a name="line-211"></a><a name="termTyCoVars"><a href="RtClosureInspect.html#termTyCoVars"><span class="hs-identifier">termTyCoVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="RtClosureInspect.html#TermFold"><span class="hs-identifier hs-var">TermFold</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-212"></a><span>            </span><span class="hs-identifier">fTerm</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032554"><a href="#local-6989586621683032554"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683032555"><a href="#local-6989586621683032555"><span class="hs-identifier">tt</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-213"></a><span>                          </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683032554"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032553"><span class="hs-identifier hs-var">concatVarEnv</span></a><span> </span><a href="#local-6989586621683032555"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">,</span><span>
</span><a name="line-214"></a><span>            </span><span class="hs-identifier">fSuspension</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683032556"><a href="#local-6989586621683032556"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683032556"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-215"></a><span>            </span><span class="hs-identifier">fPrim</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span class="hs-special">,</span><span>
</span><a name="line-216"></a><span>            </span><span class="hs-identifier">fNewtypeWrap</span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032557"><a href="#local-6989586621683032557"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683032558"><a href="#local-6989586621683032558"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683032557"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032558"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span>
</span><a name="line-217"></a><span>            </span><span class="hs-identifier">fRefWrap</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032559"><a href="#local-6989586621683032559"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032560"><a href="#local-6989586621683032560"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683032559"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032560"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">}</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683032553"><a href="#local-6989586621683032553"><span class="hs-identifier">concatVarEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">unionVarSet</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-comment">----------------------------------</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- Pretty printing of terms</span><span>
</span><a name="line-222"></a><span class="hs-comment">----------------------------------</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-keyword">type</span><span> </span><a name="Precedence"><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier">Precedence</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-225"></a><span class="hs-keyword">type</span><span> </span><a name="TermPrinterM"><a href="RtClosureInspect.html#TermPrinterM"><span class="hs-identifier">TermPrinterM</span></a></a><span> </span><a name="local-6989586621683032446"><a href="#local-6989586621683032446"><span class="hs-identifier">m</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032446"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">app_prec</span><span class="hs-special">,</span><span class="hs-identifier">cons_prec</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">max_prec</span><span> </span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-228"></a><a name="max_prec"><a href="RtClosureInspect.html#max_prec"><span class="hs-identifier">max_prec</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">10</span><span>
</span><a name="line-229"></a><a name="app_prec"><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier">app_prec</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#max_prec"><span class="hs-identifier hs-var">max_prec</span></a><span>
</span><a name="line-230"></a><a name="cons_prec"><a href="RtClosureInspect.html#cons_prec"><span class="hs-identifier">cons_prec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-comment">-- TODO Extract this info from GHC itself</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-identifier">pprTermM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr_termM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pprNewtypeWrap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621683032462"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RtClosureInspect.html#TermPrinterM"><span class="hs-identifier hs-type">TermPrinterM</span></a><span> </span><a href="#local-6989586621683032462"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TermPrinterM"><span class="hs-identifier hs-type">TermPrinterM</span></a><span> </span><a href="#local-6989586621683032462"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-233"></a><a name="pprTermM"><a href="RtClosureInspect.html#pprTermM"><span class="hs-identifier">pprTermM</span></a></a><span> </span><a name="local-6989586621683032561"><a href="#local-6989586621683032561"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621683032562"><a href="#local-6989586621683032562"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621683032563"><a href="#local-6989586621683032563"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprDeeper</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="RtClosureInspect.html#ppr_termM"><span class="hs-identifier hs-var">ppr_termM</span></a><span> </span><a href="#local-6989586621683032561"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621683032562"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683032563"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><a name="ppr_termM"><a href="RtClosureInspect.html#ppr_termM"><span class="hs-identifier">ppr_termM</span></a></a><span> </span><a name="local-6989586621683032564"><a href="#local-6989586621683032564"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621683032565"><a href="#local-6989586621683032565"><span class="hs-identifier">p</span></a></a><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">dc</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621683032566"><a href="#local-6989586621683032566"><span class="hs-identifier">dc_tag</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><a name="local-6989586621683032567"><a href="#local-6989586621683032567"><span class="hs-identifier">tt</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-236"></a><span>  </span><a name="local-6989586621683032568"><a href="#local-6989586621683032568"><span class="hs-identifier">tt_docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032564"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032567"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-237"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cparen</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683032567"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683032565"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683032566"><span class="hs-identifier hs-var">dc_tag</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprDeeperList</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><a href="#local-6989586621683032568"><span class="hs-identifier hs-var">tt_docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-identifier">ppr_termM</span><span> </span><a name="local-6989586621683032569"><a href="#local-6989586621683032569"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621683032570"><a href="#local-6989586621683032570"><span class="hs-identifier">p</span></a></a><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">dc</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621683032571"><a href="#local-6989586621683032571"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><a name="local-6989586621683032572"><a href="#local-6989586621683032572"><span class="hs-identifier">tt</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-241"></a><span class="hs-comment">{-  | dataConIsInfix dc, (t1:t2:tt') &lt;- tt  --TODO fixity
  = parens (ppr_term1 True t1 &lt;+&gt; ppr dc &lt;+&gt; ppr_term1 True ppr t2)
    &lt;+&gt; hsep (map (ppr_term1 True) tt)
-}</span><span> </span><span class="hs-comment">-- TODO Printing infix constructors properly</span><span>
</span><a name="line-245"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683032575"><a href="#local-6989586621683032575"><span class="hs-identifier">tt_docs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032569"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032572"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-246"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ifPprDebug</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032573"><span class="hs-identifier hs-var">show_tm</span></a><span> </span><a href="#local-6989586621683032575"><span class="hs-identifier hs-var">tt_docs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>                             </span><span class="hs-special">(</span><a href="#local-6989586621683032573"><span class="hs-identifier hs-var">show_tm</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dropList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTheta</span><span> </span><a href="#local-6989586621683032571"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032575"><span class="hs-identifier hs-var">tt_docs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>                  </span><span class="hs-comment">-- Don't show the dictionary arguments to</span><span>
</span><a name="line-249"></a><span>                  </span><span class="hs-comment">-- constructors unless -dppr-debug is on</span><span>
</span><a name="line-250"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-251"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-252"></a><span>    </span><a name="local-6989586621683032573"><a href="#local-6989586621683032573"><span class="hs-identifier">show_tm</span></a></a><span> </span><a name="local-6989586621683032574"><a href="#local-6989586621683032574"><span class="hs-identifier">tt_docs</span></a></a><span>
</span><a name="line-253"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683032574"><span class="hs-identifier hs-var">tt_docs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032571"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-254"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cparen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032570"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-255"></a><span>                       </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032571"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprDeeperList</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><a href="#local-6989586621683032574"><span class="hs-identifier hs-var">tt_docs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span class="hs-identifier">ppr_termM</span><span> </span><a name="local-6989586621683032576"><a href="#local-6989586621683032576"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621683032577"><a href="#local-6989586621683032577"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621683032578"><a href="#local-6989586621683032578"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#pprNewtypeWrap"><span class="hs-identifier hs-var">pprNewtypeWrap</span></a><span> </span><a href="#local-6989586621683032576"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621683032577"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683032578"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-258"></a><span class="hs-identifier">ppr_termM</span><span> </span><a name="local-6989586621683032579"><a href="#local-6989586621683032579"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621683032580"><a href="#local-6989586621683032580"><span class="hs-identifier">p</span></a></a><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span class="hs-special">{</span><span class="hs-identifier">wrapped_term</span><span class="hs-glyph">=</span><a name="local-6989586621683032581"><a href="#local-6989586621683032581"><span class="hs-identifier">t</span></a></a><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-259"></a><span>  </span><a name="local-6989586621683032582"><a href="#local-6989586621683032582"><span class="hs-identifier">contents</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032579"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span> </span><a href="#local-6989586621683032581"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cparen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032580"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GHC.Prim.MutVar#&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683032582"><span class="hs-identifier hs-var">contents</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-comment">-- The constructor name is wired in here ^^^ for the sake of simplicity.</span><span>
</span><a name="line-262"></a><span>  </span><span class="hs-comment">-- I don't think mutvars are going to change in a near future.</span><span>
</span><a name="line-263"></a><span>  </span><span class="hs-comment">-- In any case this is solely a presentation matter: MutVar# is</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-comment">-- a datatype with no constructors, implemented by the RTS</span><span>
</span><a name="line-265"></a><span>  </span><span class="hs-comment">-- (hence there is no way to obtain a datacon and print it).</span><span>
</span><a name="line-266"></a><span class="hs-identifier">ppr_termM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683032583"><a href="#local-6989586621683032583"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#ppr_termM1"><span class="hs-identifier hs-var">ppr_termM1</span></a><span> </span><a href="#local-6989586621683032583"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">ppr_termM1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621683032461"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032461"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-270"></a><a name="ppr_termM1"><a href="RtClosureInspect.html#ppr_termM1"><span class="hs-identifier">ppr_termM1</span></a></a><span> </span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><a name="local-6989586621683032584"><a href="#local-6989586621683032584"><span class="hs-identifier">words</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ty</span><span class="hs-glyph">=</span><a name="local-6989586621683032585"><a href="#local-6989586621683032585"><span class="hs-identifier">ty</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-271"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#repPrim"><span class="hs-identifier hs-var">repPrim</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConAppTyCon</span><span> </span><a href="#local-6989586621683032585"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032584"><span class="hs-identifier hs-var">words</span></a><span>
</span><a name="line-272"></a><span class="hs-identifier">ppr_termM1</span><span> </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span class="hs-special">{</span><span class="hs-identifier">ty</span><span class="hs-glyph">=</span><a name="local-6989586621683032586"><a href="#local-6989586621683032586"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">bound_to</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-273"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'_'</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">whenPprDebug</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032586"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span class="hs-identifier">ppr_termM1</span><span> </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span class="hs-special">{</span><span class="hs-identifier">ty</span><span class="hs-glyph">=</span><a name="local-6989586621683032587"><a href="#local-6989586621683032587"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">bound_to</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032588"><a href="#local-6989586621683032588"><span class="hs-identifier">n</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-275"></a><span class="hs-comment">--  | Just _ &lt;- splitFunTy_maybe ty = return$ ptext (sLit(&quot;&lt;function&gt;&quot;)</span><span>
</span><a name="line-276"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">parens</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032588"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032587"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-277"></a><span class="hs-identifier">ppr_termM1</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ppr_termM1 - Term&quot;</span><span>
</span><a name="line-278"></a><span class="hs-identifier">ppr_termM1</span><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ppr_termM1 - RefWrap&quot;</span><span>
</span><a name="line-279"></a><span class="hs-identifier">ppr_termM1</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ppr_termM1 - NewtypeWrap&quot;</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><a name="pprNewtypeWrap"><a href="RtClosureInspect.html#pprNewtypeWrap"><span class="hs-identifier">pprNewtypeWrap</span></a></a><span> </span><a name="local-6989586621683032589"><a href="#local-6989586621683032589"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621683032590"><a href="#local-6989586621683032590"><span class="hs-identifier">p</span></a></a><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span class="hs-special">{</span><span class="hs-identifier">ty</span><span class="hs-glyph">=</span><a name="local-6989586621683032591"><a href="#local-6989586621683032591"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wrapped_term</span><span class="hs-glyph">=</span><a name="local-6989586621683032592"><a href="#local-6989586621683032592"><span class="hs-identifier">t</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032593"><a href="#local-6989586621683032593"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032591"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-283"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isNewTyCon</span><span> </span><span class="hs-identifier">tc</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-284"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032594"><a href="#local-6989586621683032594"><span class="hs-identifier">new_dc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConSingleDataCon_maybe</span><span> </span><a href="#local-6989586621683032593"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-285"></a><span>             </span><a name="local-6989586621683032595"><a href="#local-6989586621683032595"><span class="hs-identifier">real_term</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032589"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="RtClosureInspect.html#max_prec"><span class="hs-identifier hs-var">max_prec</span></a><span> </span><a href="#local-6989586621683032592"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-286"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cparen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032590"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032594"><span class="hs-identifier hs-var">new_dc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683032595"><span class="hs-identifier hs-var">real_term</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span class="hs-identifier">pprNewtypeWrap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;pprNewtypeWrap&quot;</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-comment">-------------------------------------------------------</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- Custom Term Pretty Printers</span><span>
</span><a name="line-291"></a><span class="hs-comment">-------------------------------------------------------</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">-- We can want to customize the representation of a</span><span>
</span><a name="line-294"></a><span class="hs-comment">--  term depending on its type.</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- However, note that custom printers have to work with</span><span>
</span><a name="line-296"></a><span class="hs-comment">--  type representations, instead of directly with types.</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- We cannot use type classes here, unless we employ some</span><span>
</span><a name="line-298"></a><span class="hs-comment">--  typerep trickery (e.g. Weirich's RepLib tricks),</span><span>
</span><a name="line-299"></a><span class="hs-comment">--  which I didn't. Therefore, this code replicates a lot</span><span>
</span><a name="line-300"></a><span class="hs-comment">--  of what type classes provide for free.</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-keyword">type</span><span> </span><a name="CustomTermPrinter"><a href="RtClosureInspect.html#CustomTermPrinter"><span class="hs-identifier">CustomTermPrinter</span></a></a><span> </span><a name="local-6989586621683032445"><a href="#local-6989586621683032445"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#TermPrinterM"><span class="hs-identifier hs-type">TermPrinterM</span></a><span> </span><a href="#local-6989586621683032445"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-303"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032445"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-- | Takes a list of custom printers with a explicit recursion knot and a term,</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- and returns the output of the first successful printer, or the default printer</span><span>
</span><a name="line-307"></a><span class="hs-identifier">cPprTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621683032460"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RtClosureInspect.html#CustomTermPrinter"><span class="hs-identifier hs-type">CustomTermPrinter</span></a><span> </span><a href="#local-6989586621683032460"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032460"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-308"></a><a name="cPprTerm"><a href="RtClosureInspect.html#cPprTerm"><span class="hs-identifier">cPprTerm</span></a></a><span> </span><a name="local-6989586621683032596"><a href="#local-6989586621683032596"><span class="hs-identifier">printers_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032598"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-309"></a><span>  </span><a name="local-6989586621683032597"><a href="#local-6989586621683032597"><span class="hs-identifier">printers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032596"><span class="hs-identifier hs-var">printers_</span></a><span> </span><a href="#local-6989586621683032598"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-310"></a><span>  </span><a name="local-6989586621683032598"><a href="#local-6989586621683032598"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683032600"><a href="#local-6989586621683032600"><span class="hs-identifier">prec</span></a></a><span> </span><a name="local-6989586621683032601"><a href="#local-6989586621683032601"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-311"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032602"><a href="#local-6989586621683032602"><span class="hs-identifier">default_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">`</span><span> </span><a href="RtClosureInspect.html#pprTermM"><span class="hs-identifier hs-var">pprTermM</span></a><span> </span><a href="#local-6989586621683032598"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032600"><span class="hs-identifier hs-var">prec</span></a><span> </span><a href="#local-6989586621683032601"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-312"></a><span>        </span><a name="local-6989586621683032603"><a href="#local-6989586621683032603"><span class="hs-identifier">mb_customDocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032604"><span class="hs-identifier hs-var">pp</span></a><span> </span><a href="#local-6989586621683032600"><span class="hs-identifier hs-var">prec</span></a><span> </span><a href="#local-6989586621683032601"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683032604"><a href="#local-6989586621683032604"><span class="hs-identifier">pp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032597"><span class="hs-identifier hs-var">printers</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032602"><span class="hs-identifier hs-var">default_</span></a><span class="hs-special">]</span><span>
</span><a name="line-313"></a><span>    </span><a name="local-6989586621683032605"><a href="#local-6989586621683032605"><span class="hs-identifier">mdoc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032599"><span class="hs-identifier hs-var">firstJustM</span></a><span> </span><a href="#local-6989586621683032603"><span class="hs-identifier hs-var">mb_customDocs</span></a><span>
</span><a name="line-314"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032605"><span class="hs-identifier hs-var">mdoc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-315"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cPprTerm&quot;</span><span>
</span><a name="line-316"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032606"><a href="#local-6989586621683032606"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cparen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032600"><span class="hs-identifier hs-var">prec</span></a><span class="hs-operator hs-var">&gt;</span><a href="RtClosureInspect.html#app_prec"><span class="hs-identifier hs-var">app_prec</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032606"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span>  </span><a name="local-6989586621683032599"><a href="#local-6989586621683032599"><span class="hs-identifier">firstJustM</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032607"><a href="#local-6989586621683032607"><span class="hs-identifier">mb</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683032608"><a href="#local-6989586621683032608"><span class="hs-identifier">mbs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032607"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032599"><span class="hs-identifier hs-var">firstJustM</span></a><span> </span><a href="#local-6989586621683032608"><span class="hs-identifier hs-var">mbs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>  </span><span class="hs-identifier">firstJustM</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-comment">-- Default set of custom printers. Note that the recursion knot is explicit</span><span>
</span><a name="line-322"></a><span class="hs-identifier">cPprTermBase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683032459"><a href="#local-6989586621683032459"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RtClosureInspect.html#CustomTermPrinter"><span class="hs-identifier hs-type">CustomTermPrinter</span></a><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-323"></a><a name="cPprTermBase"><a href="RtClosureInspect.html#cPprTermBase"><span class="hs-identifier">cPprTermBase</span></a></a><span> </span><a name="local-6989586621683032609"><a href="#local-6989586621683032609"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-324"></a><span>  </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683032610"><span class="hs-identifier hs-var">ifTerm</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032612"><span class="hs-identifier hs-var">isTupleTy</span></a><span class="hs-operator hs-var">.</span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683032662"><a href="#local-6989586621683032662"><span class="hs-identifier">_p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>                                      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032609"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>                                      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">subTerms</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032610"><span class="hs-identifier hs-var">ifTerm</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683032663"><a href="#local-6989586621683032663"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032613"><span class="hs-identifier hs-var">isTyCon</span></a><span> </span><span class="hs-identifier hs-var">listTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ty</span><span> </span><a href="#local-6989586621683032663"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">subTerms</span><span> </span><a href="#local-6989586621683032663"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>           </span><a href="#local-6989586621683032620"><span class="hs-identifier hs-var">ppr_list</span></a><span>
</span><a name="line-329"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032611"><span class="hs-identifier hs-var">ifTerm'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032613"><span class="hs-identifier hs-var">isTyCon</span></a><span> </span><span class="hs-identifier hs-var">intTyCon</span><span>    </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032615"><span class="hs-identifier hs-var">ppr_int</span></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032611"><span class="hs-identifier hs-var">ifTerm'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032613"><span class="hs-identifier hs-var">isTyCon</span></a><span> </span><span class="hs-identifier hs-var">charTyCon</span><span>   </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032616"><span class="hs-identifier hs-var">ppr_char</span></a><span>
</span><a name="line-331"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032611"><span class="hs-identifier hs-var">ifTerm'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032613"><span class="hs-identifier hs-var">isTyCon</span></a><span> </span><span class="hs-identifier hs-var">floatTyCon</span><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032617"><span class="hs-identifier hs-var">ppr_float</span></a><span>
</span><a name="line-332"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032611"><span class="hs-identifier hs-var">ifTerm'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032613"><span class="hs-identifier hs-var">isTyCon</span></a><span> </span><span class="hs-identifier hs-var">doubleTyCon</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032618"><span class="hs-identifier hs-var">ppr_double</span></a><span>
</span><a name="line-333"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032611"><span class="hs-identifier hs-var">ifTerm'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032614"><span class="hs-identifier hs-var">isIntegerTy</span></a><span>         </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032619"><span class="hs-identifier hs-var">ppr_integer</span></a><span>
</span><a name="line-334"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-335"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-336"></a><span>   </span><span class="hs-identifier">ifTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>   </span><a name="local-6989586621683032610"><a href="#local-6989586621683032610"><span class="hs-identifier">ifTerm</span></a></a><span> </span><a name="local-6989586621683032621"><a href="#local-6989586621683032621"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621683032622"><a href="#local-6989586621683032622"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032611"><span class="hs-identifier hs-var">ifTerm'</span></a><span> </span><a href="#local-6989586621683032621"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683032623"><a href="#local-6989586621683032623"><span class="hs-identifier">prec</span></a></a><span> </span><a name="local-6989586621683032624"><a href="#local-6989586621683032624"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683032622"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032623"><span class="hs-identifier hs-var">prec</span></a><span> </span><a href="#local-6989586621683032624"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span>   </span><span class="hs-identifier">ifTerm'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>   </span><a name="local-6989586621683032611"><a href="#local-6989586621683032611"><span class="hs-identifier">ifTerm'</span></a></a><span> </span><a name="local-6989586621683032625"><a href="#local-6989586621683032625"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621683032626"><a href="#local-6989586621683032626"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621683032627"><a href="#local-6989586621683032627"><span class="hs-identifier">prec</span></a></a><span> </span><a name="local-6989586621683032628"><a href="#local-6989586621683032628"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-345"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032625"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621683032628"><span class="hs-identifier hs-var">t</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032626"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683032627"><span class="hs-identifier hs-var">prec</span></a><span> </span><a href="#local-6989586621683032628"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-346"></a><span>   </span><span class="hs-identifier">ifTerm'</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>   </span><a name="local-6989586621683032612"><a href="#local-6989586621683032612"><span class="hs-identifier">isTupleTy</span></a></a><span> </span><a name="local-6989586621683032629"><a href="#local-6989586621683032629"><span class="hs-identifier">ty</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-349"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621683032630"><a href="#local-6989586621683032630"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032629"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-350"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBoxedTupleTyCon</span><span> </span><a href="#local-6989586621683032630"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>   </span><a name="local-6989586621683032613"><a href="#local-6989586621683032613"><span class="hs-identifier">isTyCon</span></a></a><span> </span><a name="local-6989586621683032631"><a href="#local-6989586621683032631"><span class="hs-identifier">a_tc</span></a></a><span> </span><a name="local-6989586621683032632"><a href="#local-6989586621683032632"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621683032633"><a href="#local-6989586621683032633"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032632"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-354"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032631"><span class="hs-identifier hs-var">a_tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683032633"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span>   </span><a name="local-6989586621683032614"><a href="#local-6989586621683032614"><span class="hs-identifier">isIntegerTy</span></a></a><span> </span><a name="local-6989586621683032634"><a href="#local-6989586621683032634"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-357"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621683032635"><a href="#local-6989586621683032635"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032634"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-358"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683032635"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">integerTyConName</span><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>   </span><span class="hs-identifier">ppr_int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr_char</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr_float</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr_double</span><span>
</span><a name="line-361"></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>   </span><a name="local-6989586621683032615"><a href="#local-6989586621683032615"><span class="hs-identifier">ppr_int</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032636"><a href="#local-6989586621683032636"><span class="hs-identifier">w</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-363"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683032636"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>   </span><span class="hs-identifier">ppr_int</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>   </span><a name="local-6989586621683032616"><a href="#local-6989586621683032616"><span class="hs-identifier">ppr_char</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032637"><a href="#local-6989586621683032637"><span class="hs-identifier">w</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-367"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.pprHsChar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">chr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683032637"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>   </span><span class="hs-identifier">ppr_char</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span>   </span><a name="local-6989586621683032617"><a href="#local-6989586621683032617"><span class="hs-identifier">ppr_float</span></a></a><span>   </span><span class="hs-identifier">_</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032638"><a href="#local-6989586621683032638"><span class="hs-identifier">w</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-371"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032639"><a href="#local-6989586621683032639"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeDupablePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-372"></a><span>                </span><span class="hs-identifier hs-var">alloca</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032640"><a href="#local-6989586621683032640"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-6989586621683032640"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683032638"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621683032640"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.float</span><span> </span><a href="#local-6989586621683032639"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>   </span><span class="hs-identifier">ppr_float</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>   </span><a name="local-6989586621683032618"><a href="#local-6989586621683032618"><span class="hs-identifier">ppr_double</span></a></a><span>  </span><span class="hs-identifier">_</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032641"><a href="#local-6989586621683032641"><span class="hs-identifier">w</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-377"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032642"><a href="#local-6989586621683032642"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeDupablePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-378"></a><span>                </span><span class="hs-identifier hs-var">alloca</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032643"><a href="#local-6989586621683032643"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-6989586621683032643"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683032641"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">peek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621683032643"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.double</span><span> </span><a href="#local-6989586621683032642"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>   </span><span class="hs-comment">-- let's assume that if we get two words, we're on a 32-bit</span><span>
</span><a name="line-381"></a><span>   </span><span class="hs-comment">-- machine. There's no good way to get a DynFlags to check the word</span><span>
</span><a name="line-382"></a><span>   </span><span class="hs-comment">-- size here.</span><span>
</span><a name="line-383"></a><span>   </span><span class="hs-identifier">ppr_double</span><span>  </span><span class="hs-identifier">_</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032644"><a href="#local-6989586621683032644"><span class="hs-identifier">w1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032645"><a href="#local-6989586621683032645"><span class="hs-identifier">w2</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-384"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032646"><a href="#local-6989586621683032646"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafeDupablePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-385"></a><span>                </span><span class="hs-identifier hs-var">alloca</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032647"><a href="#local-6989586621683032647"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-386"></a><span>                  </span><span class="hs-identifier hs-var">poke</span><span> </span><a href="#local-6989586621683032647"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683032644"><span class="hs-identifier hs-var">w1</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>                  </span><span class="hs-identifier hs-var">poke</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032647"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683032645"><span class="hs-identifier hs-var">w2</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>                  </span><span class="hs-identifier hs-var">peek</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621683032647"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.double</span><span> </span><a href="#local-6989586621683032646"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>   </span><span class="hs-identifier">ppr_double</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>   </span><span class="hs-identifier">ppr_integer</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span class="hs-cpp">#if defined(INTEGER_GMP)
</span><span>   </span><span class="hs-comment">-- Reconstructing Integers is a bit of a pain. This depends deeply</span><span>
</span><a name="line-395"></a><span>   </span><span class="hs-comment">-- on the integer-gmp representation, so it'll break if that</span><span>
</span><a name="line-396"></a><span>   </span><span class="hs-comment">-- changes (but there are several tests in</span><span>
</span><a name="line-397"></a><span>   </span><span class="hs-comment">-- tests/ghci.debugger/scripts that will tell us if this is wrong).</span><span>
</span><a name="line-398"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-399"></a><span>   </span><span class="hs-comment">--   data Integer</span><span>
</span><a name="line-400"></a><span>   </span><span class="hs-comment">--     = S# Int#</span><span>
</span><a name="line-401"></a><span>   </span><span class="hs-comment">--     | Jp# {-# UNPACK #-} !BigNat</span><span>
</span><a name="line-402"></a><span>   </span><span class="hs-comment">--     | Jn# {-# UNPACK #-} !BigNat</span><span>
</span><a name="line-403"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-404"></a><span>   </span><span class="hs-comment">--   data BigNat = BN# ByteArray#</span><span>
</span><a name="line-405"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-406"></a><span>   </span><span class="hs-identifier">ppr_integer</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">Prim</span><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">W#</span><span> </span><span class="hs-identifier">w</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-407"></a><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ppr.integer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">word2Int#</span><span> </span><span class="hs-identifier">w</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>   </span><span class="hs-identifier">ppr_integer</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">dc</span><span class="hs-glyph">=</span><span class="hs-identifier">Right</span><span> </span><span class="hs-identifier">con</span><span class="hs-special">,</span><span>
</span><a name="line-409"></a><span>                      </span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">Prim</span><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-identifier">ws</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-410"></a><span>      </span><span class="hs-comment">-- We don't need to worry about sizes that are not an integral</span><span>
</span><a name="line-411"></a><span>      </span><span class="hs-comment">-- number of words, because luckily GMP uses arrays of words</span><span>
</span><a name="line-412"></a><span>      </span><span class="hs-comment">-- (see GMP_LIMB_SHIFT).</span><span>
</span><a name="line-413"></a><span>      </span><span class="hs-keyword">let</span><span>
</span><a name="line-414"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier">UArray</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">arr#</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">listArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-identifier">length</span><span> </span><span class="hs-identifier">ws</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ws</span><span>
</span><a name="line-415"></a><span>        </span><span class="hs-identifier">constr</span><span>
</span><a name="line-416"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;Jp#&quot;</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getOccString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dataConName</span><span> </span><span class="hs-identifier">con</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Jp#</span><span>
</span><a name="line-417"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Jn#</span><span>
</span><a name="line-418"></a><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ppr.integer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">constr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">BN#</span><span> </span><span class="hs-identifier">arr#</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span class="hs-cpp">#elif defined(INTEGER_SIMPLE)
</span><span>   </span><span class="hs-comment">-- As with the GMP case, this depends deeply on the integer-simple</span><span>
</span><a name="line-421"></a><span>   </span><span class="hs-comment">-- representation.</span><span>
</span><a name="line-422"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-423"></a><span>   </span><span class="hs-comment">-- @</span><span>
</span><a name="line-424"></a><span>   </span><span class="hs-comment">-- data Integer = Positive !Digits | Negative !Digits | Naught</span><span>
</span><a name="line-425"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-426"></a><span>   </span><span class="hs-comment">-- data Digits = Some !Word# !Digits</span><span>
</span><a name="line-427"></a><span>   </span><span class="hs-comment">--             | None</span><span>
</span><a name="line-428"></a><span>   </span><span class="hs-comment">-- @</span><span>
</span><a name="line-429"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-430"></a><span>   </span><span class="hs-comment">-- NB: the above has some type synonyms expanded out for the sake of brevity</span><span>
</span><a name="line-431"></a><span>   </span><span class="hs-identifier">ppr_integer</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-432"></a><span>      </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ppr.integer</span><span> </span><span class="hs-identifier">Naught</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>   </span><span class="hs-identifier">ppr_integer</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">dc</span><span class="hs-glyph">=</span><span class="hs-identifier">Right</span><span> </span><span class="hs-identifier">con</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">digitTerm</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-434"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">digits</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">get_digits</span><span> </span><span class="hs-identifier">digitTerm</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ppr.integer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">constr</span><span> </span><span class="hs-identifier">digits</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-437"></a><span>        </span><span class="hs-identifier">get_digits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Term</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">Digits</span><span>
</span><a name="line-438"></a><span>        </span><span class="hs-identifier">get_digits</span><span> </span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">None</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-identifier">get_digits</span><span> </span><span class="hs-identifier">Term</span><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">Prim</span><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-identifier">W#</span><span> </span><span class="hs-identifier">w</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">,</span><span class="hs-identifier">t</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><a name="line-440"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Some</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">get_digits</span><span> </span><span class="hs-identifier">t</span><span>
</span><a name="line-441"></a><span>        </span><span class="hs-identifier">get_digits</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>        </span><span class="hs-identifier">constr</span><span>
</span><a name="line-444"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;Positive&quot;</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getOccString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dataConName</span><span> </span><span class="hs-identifier">con</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Positive</span><span>
</span><a name="line-445"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Negative</span><span>
</span><a name="line-446"></a><span class="hs-cpp">#endif
</span><span>   </span><a name="local-6989586621683032619"><a href="#local-6989586621683032619"><span class="hs-identifier">ppr_integer</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span>   </span><span class="hs-comment">--Note pprinting of list terms is not lazy</span><span>
</span><a name="line-450"></a><span>   </span><span class="hs-identifier">ppr_list</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Precedence"><span class="hs-identifier hs-type">Precedence</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032459"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-451"></a><span>   </span><a name="local-6989586621683032620"><a href="#local-6989586621683032620"><span class="hs-identifier">ppr_list</span></a></a><span> </span><a name="local-6989586621683032648"><a href="#local-6989586621683032648"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032649"><a href="#local-6989586621683032649"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032650"><a href="#local-6989586621683032650"><span class="hs-identifier">t</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-452"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032656"><a href="#local-6989586621683032656"><span class="hs-identifier">elems</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032649"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032651"><span class="hs-identifier hs-var">getListTerms</span></a><span> </span><a href="#local-6989586621683032650"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-453"></a><span>           </span><a name="local-6989586621683032657"><a href="#local-6989586621683032657"><span class="hs-identifier">isConsLast</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#termType"><span class="hs-identifier hs-var">termType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621683032656"><span class="hs-identifier hs-var">elems</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="RtClosureInspect.html#termType"><span class="hs-identifier hs-var">termType</span></a><span> </span><a href="#local-6989586621683032649"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>           </span><a name="local-6989586621683032658"><a href="#local-6989586621683032658"><span class="hs-identifier">is_string</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCharTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032656"><span class="hs-identifier hs-var">elems</span></a><span>
</span><a name="line-455"></a><span>           </span><a name="local-6989586621683032659"><a href="#local-6989586621683032659"><span class="hs-identifier">chars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">chr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683032660"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span class="hs-special">{</span><span class="hs-identifier">valRaw</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032660"><a href="#local-6989586621683032660"><span class="hs-identifier">w</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032656"><span class="hs-identifier hs-var">elems</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>       </span><a name="local-6989586621683032661"><a href="#local-6989586621683032661"><span class="hs-identifier">print_elems</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032609"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="RtClosureInspect.html#cons_prec"><span class="hs-identifier hs-var">cons_prec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032656"><span class="hs-identifier hs-var">elems</span></a><span>
</span><a name="line-459"></a><span>       </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683032658"><span class="hs-identifier hs-var">is_string</span></a><span>
</span><a name="line-460"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.doubleQuotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ppr.text</span><span> </span><a href="#local-6989586621683032659"><span class="hs-identifier hs-var">chars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683032657"><span class="hs-identifier hs-var">isConsLast</span></a><span>
</span><a name="line-462"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cparen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032648"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="RtClosureInspect.html#cons_prec"><span class="hs-identifier hs-var">cons_prec</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pprDeeperList</span><span> </span><span class="hs-identifier hs-var">fsep</span><span>
</span><a name="line-464"></a><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">space</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032661"><span class="hs-identifier hs-var">print_elems</span></a><span>
</span><a name="line-465"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">brackets</span><span>
</span><a name="line-466"></a><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pprDeeperList</span><span> </span><span class="hs-identifier hs-var">fcat</span><span>
</span><a name="line-467"></a><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><a href="#local-6989586621683032661"><span class="hs-identifier hs-var">print_elems</span></a><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683032651"><a href="#local-6989586621683032651"><span class="hs-identifier">getListTerms</span></a></a><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><a name="local-6989586621683032652"><a href="#local-6989586621683032652"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032653"><a href="#local-6989586621683032653"><span class="hs-identifier">t</span></a></a><span class="hs-special">]</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032652"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032651"><span class="hs-identifier hs-var">getListTerms</span></a><span> </span><a href="#local-6989586621683032653"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-470"></a><span>              </span><span class="hs-identifier">getListTerms</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span class="hs-special">{</span><span class="hs-identifier">subTerms</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-471"></a><span>              </span><span class="hs-identifier">getListTerms</span><span> </span><a name="local-6989586621683032654"><a href="#local-6989586621683032654"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032654"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">]</span><span>
</span><a name="line-472"></a><span>              </span><span class="hs-identifier">getListTerms</span><span> </span><a name="local-6989586621683032655"><a href="#local-6989586621683032655"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;getListTerms&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032655"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>   </span><span class="hs-identifier">ppr_list</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;doList&quot;</span><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-identifier">repPrim</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-477"></a><a name="repPrim"><a href="RtClosureInspect.html#repPrim"><span class="hs-identifier">repPrim</span></a></a><span> </span><a name="local-6989586621683032664"><a href="#local-6989586621683032664"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032665"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-478"></a><span>   </span><a name="local-6989586621683032665"><a href="#local-6989586621683032665"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-6989586621683032666"><a href="#local-6989586621683032666"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-479"></a><span>    </span><span class="hs-comment">-- Char# uses native machine words, whereas Char's Storable instance uses</span><span>
</span><a name="line-480"></a><span>    </span><span class="hs-comment">-- Int32, so we have to read it as an Int.</span><span>
</span><a name="line-481"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">charPrimTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">chr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">intPrimTyCon</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">wordPrimTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">floatPrimTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">doublePrimTyCon</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">int32PrimTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">word32PrimTyCon</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">int64PrimTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int64</span><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">word64PrimTyCon</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">addrPrimTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nullPtr</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032667"><span class="hs-identifier hs-var">build</span></a><span> </span><a href="#local-6989586621683032666"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">stablePtrPrimTyCon</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;stablePtr&gt;&quot;</span><span>
</span><a name="line-492"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">stableNamePrimTyCon</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;stableName&gt;&quot;</span><span>
</span><a name="line-493"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">statePrimTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;statethread&gt;&quot;</span><span>
</span><a name="line-494"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">proxyPrimTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;proxy&gt;&quot;</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">realWorldTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;realworld&gt;&quot;</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">threadIdPrimTyCon</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;ThreadId&gt;&quot;</span><span>
</span><a name="line-497"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">weakPrimTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;Weak&gt;&quot;</span><span>
</span><a name="line-498"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">arrayPrimTyCon</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;array&gt;&quot;</span><span>
</span><a name="line-499"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">smallArrayPrimTyCon</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;smallArray&gt;&quot;</span><span>
</span><a name="line-500"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">byteArrayPrimTyCon</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;bytearray&gt;&quot;</span><span>
</span><a name="line-501"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutableArrayPrimTyCon</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;mutableArray&gt;&quot;</span><span>
</span><a name="line-502"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">smallMutableArrayPrimTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;smallMutableArray&gt;&quot;</span><span>
</span><a name="line-503"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutableByteArrayPrimTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;mutableByteArray&gt;&quot;</span><span>
</span><a name="line-504"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutVarPrimTyCon</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;mutVar&gt;&quot;</span><span>
</span><a name="line-505"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mVarPrimTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;mVar&gt;&quot;</span><span>
</span><a name="line-506"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">tVarPrimTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;tVar&gt;&quot;</span><span>
</span><a name="line-507"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'&lt;'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032664"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'&gt;'</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683032667"><a href="#local-6989586621683032667"><span class="hs-identifier">build</span></a></a><span> </span><a name="local-6989586621683032668"><a href="#local-6989586621683032668"><span class="hs-identifier">ww</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">withArray</span><span> </span><a href="#local-6989586621683032668"><span class="hs-identifier hs-var">ww</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">peek</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">castPtr</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span class="hs-comment">--   This ^^^ relies on the representation of Haskell heap values being</span><span>
</span><a name="line-510"></a><span class="hs-comment">--   the same as in a C array.</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- Type Reconstruction</span><span>
</span><a name="line-514"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-515"></a><span class="hs-comment">{-
Type Reconstruction is type inference done on heap closures.
The algorithm walks the heap generating a set of equations, which
are solved with syntactic unification.
A type reconstruction equation looks like:

  &lt;datacon reptype&gt;  =  &lt;actual heap contents&gt;

The full equation set is generated by traversing all the subterms, starting
from a given term.

The only difficult part is that newtypes are only found in the lhs of equations.
Right hand sides are missing them. We can either (a) drop them from the lhs, or
(b) reconstruct them in the rhs when possible.

The function congruenceNewtypes takes a shot at (b)
-}</span><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-comment">-- A (non-mutable) tau type containing</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- existentially quantified tyvars.</span><span>
</span><a name="line-536"></a><span class="hs-comment">--    (since GHC type language currently does not support</span><span>
</span><a name="line-537"></a><span class="hs-comment">--     existentials, we leave these variables unquantified)</span><span>
</span><a name="line-538"></a><span class="hs-keyword">type</span><span> </span><a name="RttiType"><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier">RttiType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-comment">-- An incomplete type as stored in GHCi:</span><span>
</span><a name="line-541"></a><span class="hs-comment">--  no polymorphism: no quantifiers &amp; all tyvars are skolem.</span><span>
</span><a name="line-542"></a><span class="hs-keyword">type</span><span> </span><a name="GhciType"><a href="RtClosureInspect.html#GhciType"><span class="hs-identifier">GhciType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span class="hs-comment">-- The Type Reconstruction monad</span><span>
</span><a name="line-546"></a><span class="hs-comment">--------------------------------</span><span>
</span><a name="line-547"></a><span class="hs-keyword">type</span><span> </span><a name="TR"><a href="RtClosureInspect.html#TR"><span class="hs-identifier">TR</span></a></a><span> </span><a name="local-6989586621683032444"><a href="#local-6989586621683032444"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683032444"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span class="hs-identifier">runTR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032458"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621683032458"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-550"></a><a name="runTR"><a href="RtClosureInspect.html#runTR"><span class="hs-identifier">runTR</span></a></a><span> </span><a name="local-6989586621683032669"><a href="#local-6989586621683032669"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683032670"><a href="#local-6989586621683032670"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-551"></a><span>  </span><a name="local-6989586621683032671"><a href="#local-6989586621683032671"><span class="hs-identifier">mb_val</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#runTR_maybe"><span class="hs-identifier hs-var">runTR_maybe</span></a><span> </span><a href="#local-6989586621683032669"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032670"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-552"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032671"><span class="hs-identifier hs-var">mb_val</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;unable to :print the term&quot;</span><span>
</span><a name="line-554"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032672"><a href="#local-6989586621683032672"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032672"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span class="hs-identifier">runTR_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032457"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621683032457"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><a name="runTR_maybe"><a href="RtClosureInspect.html#runTR_maybe"><span class="hs-identifier">runTR_maybe</span></a></a><span> </span><a name="local-6989586621683032673"><a href="#local-6989586621683032673"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683032674"><a href="#local-6989586621683032674"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-558"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032675"><a href="#local-6989586621683032675"><span class="hs-identifier">_errs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032676"><a href="#local-6989586621683032676"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initTcInteractive"><span class="hs-identifier hs-var">initTcInteractive</span></a><span> </span><a href="#local-6989586621683032673"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032674"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-559"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032676"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span class="hs-comment">-- | Term Reconstruction trace</span><span>
</span><a name="line-562"></a><span class="hs-identifier">traceTR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-563"></a><a name="traceTR"><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier">traceTR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rtti</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span class="hs-comment">-- Semantically different to recoverM in TcRnMonad</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- recoverM retains the errors in the first action,</span><span>
</span><a name="line-568"></a><span class="hs-comment">--  whereas recoverTc here does not</span><span>
</span><a name="line-569"></a><span class="hs-identifier">recoverTR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032456"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032456"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032456"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-570"></a><a name="recoverTR"><a href="RtClosureInspect.html#recoverTR"><span class="hs-identifier">recoverTR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#tryTcDiscardingErrs"><span class="hs-identifier hs-var">tryTcDiscardingErrs</span></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span class="hs-identifier">trIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621683032455"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032455"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-573"></a><a name="trIO"><a href="RtClosureInspect.html#trIO"><span class="hs-identifier">trIO</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-identifier">liftTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683032454"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><a href="#local-6989586621683032454"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-576"></a><a name="liftTcM"><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier">liftTcM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-identifier">newVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-579"></a><a name="newVar"><a href="RtClosureInspect.html#newVar"><span class="hs-identifier">newVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-identifier">newOpenVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-582"></a><a name="newOpenVar"><a href="RtClosureInspect.html#newOpenVar"><span class="hs-identifier">newOpenVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span class="hs-identifier">instTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TCvSubst</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span class="hs-comment">-- Instantiate fresh mutable type variables from some TyVars</span><span>
</span><a name="line-586"></a><span class="hs-comment">-- This function preserves the print-name, which helps error messages</span><span>
</span><a name="line-587"></a><a name="instTyVars"><a href="RtClosureInspect.html#instTyVars"><span class="hs-identifier">instTyVars</span></a></a><span> </span><a name="local-6989586621683032677"><a href="#local-6989586621683032677"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-588"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-special">(</span><a href="TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a><span> </span><a href="#local-6989586621683032677"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span class="hs-keyword">type</span><span> </span><a name="RttiInstantiation"><a href="RtClosureInspect.html#RttiInstantiation"><span class="hs-identifier">RttiInstantiation</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-591"></a><span>   </span><span class="hs-comment">-- Associates the typechecker-world meta type variables</span><span>
</span><a name="line-592"></a><span>   </span><span class="hs-comment">-- (which are mutable and may be refined), to their</span><span>
</span><a name="line-593"></a><span>   </span><span class="hs-comment">-- debugger-world RuntimeUnk counterparts.</span><span>
</span><a name="line-594"></a><span>   </span><span class="hs-comment">-- If the TcTyVar has not been refined by the runtime type</span><span>
</span><a name="line-595"></a><span>   </span><span class="hs-comment">-- elaboration, then we want to turn it back into the</span><span>
</span><a name="line-596"></a><span>   </span><span class="hs-comment">-- original RuntimeUnk</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-comment">-- | Returns the instantiated type scheme ty', and the</span><span>
</span><a name="line-599"></a><span class="hs-comment">--   mapping from new (instantiated) -to- old (skolem) type variables</span><span>
</span><a name="line-600"></a><span class="hs-identifier">instScheme</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#QuantifiedType"><span class="hs-identifier hs-type">QuantifiedType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><a href="RtClosureInspect.html#RttiInstantiation"><span class="hs-identifier hs-type">RttiInstantiation</span></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><a name="instScheme"><a href="RtClosureInspect.html#instScheme"><span class="hs-identifier">instScheme</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032678"><a href="#local-6989586621683032678"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032679"><a href="#local-6989586621683032679"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032680"><a href="#local-6989586621683032680"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032681"><a href="#local-6989586621683032681"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#instTyVars"><span class="hs-identifier hs-var">instTyVars</span></a><span> </span><a href="#local-6989586621683032678"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-603"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032682"><a href="#local-6989586621683032682"><span class="hs-identifier">rtti_inst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683032683"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">,</span><a href="#local-6989586621683032684"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032683"><a href="#local-6989586621683032683"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032684"><a href="#local-6989586621683032684"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032681"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032678"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">]</span><span>
</span><a name="line-604"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683032680"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683032679"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032682"><span class="hs-identifier hs-var">rtti_inst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-identifier">applyRevSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiInstantiation"><span class="hs-identifier hs-type">RttiInstantiation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- Apply the *reverse* substitution in-place to any un-filled-in</span><span>
</span><a name="line-608"></a><span class="hs-comment">-- meta tyvars.  This recovers the original debugger-world variable</span><span>
</span><a name="line-609"></a><span class="hs-comment">-- unless it has been refined by new information from the heap</span><span>
</span><a name="line-610"></a><a name="applyRevSubst"><a href="RtClosureInspect.html#applyRevSubst"><span class="hs-identifier">applyRevSubst</span></a></a><span> </span><a name="local-6989586621683032685"><a href="#local-6989586621683032685"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683032686"><span class="hs-identifier hs-var">do_pair</span></a><span> </span><a href="#local-6989586621683032685"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-612"></a><span>    </span><a name="local-6989586621683032686"><a href="#local-6989586621683032686"><span class="hs-identifier">do_pair</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032687"><a href="#local-6989586621683032687"><span class="hs-identifier">tc_tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032688"><a href="#local-6989586621683032688"><span class="hs-identifier">rtti_tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683032689"><a href="#local-6989586621683032689"><span class="hs-identifier">tc_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTyVar"><span class="hs-identifier hs-var">zonkTcTyVar</span></a><span> </span><a href="#local-6989586621683032687"><span class="hs-identifier hs-var">tc_tv</span></a><span>
</span><a name="line-614"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcGetTyVar_maybe</span><span> </span><a href="#local-6989586621683032689"><span class="hs-identifier hs-var">tc_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-615"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032690"><a href="#local-6989586621683032690"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isMetaTyVar</span><span> </span><a href="#local-6989586621683032690"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#writeMetaTyVar"><span class="hs-identifier hs-var">writeMetaTyVar</span></a><span> </span><a href="#local-6989586621683032690"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683032688"><span class="hs-identifier hs-var">rtti_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>               </span><span class="hs-identifier">_</span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span class="hs-comment">-- Adds a constraint of the form t1 == t2</span><span>
</span><a name="line-619"></a><span class="hs-comment">-- t1 is expected to come from walking the heap</span><span>
</span><a name="line-620"></a><span class="hs-comment">-- t2 is expected to come from a datacon signature</span><span>
</span><a name="line-621"></a><span class="hs-comment">-- Before unification, congruenceNewtypes needs to</span><span>
</span><a name="line-622"></a><span class="hs-comment">-- do its magic.</span><span>
</span><a name="line-623"></a><span class="hs-identifier">addConstraint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-624"></a><a name="addConstraint"><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier">addConstraint</span></a></a><span> </span><a name="local-6989586621683032691"><a href="#local-6989586621683032691"><span class="hs-identifier">actual</span></a></a><span> </span><a name="local-6989586621683032692"><a href="#local-6989586621683032692"><span class="hs-identifier">expected</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-625"></a><span>    </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;add constraint:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032691"><span class="hs-identifier hs-var">actual</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">equals</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032692"><span class="hs-identifier hs-var">expected</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>    </span><a href="RtClosureInspect.html#recoverTR"><span class="hs-identifier hs-var">recoverTR</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Failed to unify&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032691"><span class="hs-identifier hs-var">actual</span></a><span class="hs-special">,</span><span>
</span><a name="line-627"></a><span>                                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032692"><span class="hs-identifier hs-var">expected</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-628"></a><span>      </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-629"></a><span>      </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-630"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032693"><a href="#local-6989586621683032693"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032694"><a href="#local-6989586621683032694"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#congruenceNewtypes"><span class="hs-identifier hs-var">congruenceNewtypes</span></a><span> </span><a href="#local-6989586621683032691"><span class="hs-identifier hs-var">actual</span></a><span> </span><a href="#local-6989586621683032692"><span class="hs-identifier hs-var">expected</span></a><span>
</span><a name="line-631"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683032693"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683032694"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-632"></a><span>     </span><span class="hs-comment">-- TOMDO: what about the coercion?</span><span>
</span><a name="line-633"></a><span>     </span><span class="hs-comment">-- we should consider family instances</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span class="hs-comment">-- | Term reconstruction</span><span>
</span><a name="line-637"></a><span class="hs-comment">--</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- Given a pointer to a heap object (`HValue`) and its type, build a `Term`</span><span>
</span><a name="line-639"></a><span class="hs-comment">-- representation of the object. Subterms (objects in the payload) are also</span><span>
</span><a name="line-640"></a><span class="hs-comment">-- built up to the given `max_depth`. After `max_depth` any subterms will appear</span><span>
</span><a name="line-641"></a><span class="hs-comment">-- as `Suspension`s. Any thunks found while traversing the object will be forced</span><span>
</span><a name="line-642"></a><span class="hs-comment">-- based on `force` parameter.</span><span>
</span><a name="line-643"></a><span class="hs-comment">--</span><span>
</span><a name="line-644"></a><span class="hs-comment">-- Types of terms will be refined based on constructors we find during term</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- reconstruction. See `cvReconstructType` for an overview of how type</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- reconstruction works.</span><span>
</span><a name="line-647"></a><span class="hs-comment">--</span><span>
</span><a name="line-648"></a><span class="hs-identifier">cvObtainTerm</span><span>
</span><a name="line-649"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-650"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>      </span><span class="hs-comment">-- ^ How many times to recurse for subterms</span><span>
</span><a name="line-651"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>     </span><span class="hs-comment">-- ^ Force thunks</span><span>
</span><a name="line-652"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-comment">-- ^ Type of the object to reconstruct</span><span>
</span><a name="line-653"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>   </span><span class="hs-comment">-- ^ Object to reconstruct</span><span>
</span><a name="line-654"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-655"></a><a name="cvObtainTerm"><a href="RtClosureInspect.html#cvObtainTerm"><span class="hs-identifier">cvObtainTerm</span></a></a><span> </span><a name="local-6989586621683032695"><a href="#local-6989586621683032695"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683032696"><a href="#local-6989586621683032696"><span class="hs-identifier">max_depth</span></a></a><span> </span><a name="local-6989586621683032697"><a href="#local-6989586621683032697"><span class="hs-identifier">force</span></a></a><span> </span><a name="local-6989586621683032698"><a href="#local-6989586621683032698"><span class="hs-identifier">old_ty</span></a></a><span> </span><a name="local-6989586621683032699"><a href="#local-6989586621683032699"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#runTR"><span class="hs-identifier hs-var">runTR</span></a><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-656"></a><span>  </span><span class="hs-comment">-- we quantify existential tyvars as universal,</span><span>
</span><a name="line-657"></a><span>  </span><span class="hs-comment">-- as this is needed to be able to manipulate</span><span>
</span><a name="line-658"></a><span>  </span><span class="hs-comment">-- them properly</span><span>
</span><a name="line-659"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032758"><a href="#local-6989586621683032758"><span class="hs-identifier">quant_old_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683032759"><a href="#local-6989586621683032759"><span class="hs-identifier">old_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032760"><a href="#local-6989586621683032760"><span class="hs-identifier">old_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><a href="#local-6989586621683032698"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-660"></a><span>       </span><a name="local-6989586621683032761"><a href="#local-6989586621683032761"><span class="hs-identifier">sigma_old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621683032759"><span class="hs-identifier hs-var">old_tvs</span></a><span> </span><a href="#local-6989586621683032760"><span class="hs-identifier hs-var">old_tau</span></a><span>
</span><a name="line-661"></a><span>   </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Term reconstruction started with initial type &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032698"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-662"></a><span>   </span><a name="local-6989586621683032773"><a href="#local-6989586621683032773"><span class="hs-identifier">term</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-663"></a><span>     </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683032759"><span class="hs-identifier hs-var">old_tvs</span></a><span>
</span><a name="line-664"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-665"></a><span>        </span><a name="local-6989586621683032762"><a href="#local-6989586621683032762"><span class="hs-identifier">term</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032696"><span class="hs-identifier hs-var">max_depth</span></a><span> </span><a href="#local-6989586621683032761"><span class="hs-identifier hs-var">sigma_old_ty</span></a><span> </span><a href="#local-6989586621683032761"><span class="hs-identifier hs-var">sigma_old_ty</span></a><span> </span><a href="#local-6989586621683032699"><span class="hs-identifier hs-var">hval</span></a><span>
</span><a name="line-666"></a><span>        </span><a name="local-6989586621683032763"><a href="#local-6989586621683032763"><span class="hs-identifier">term'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#zonkTerm"><span class="hs-identifier hs-var">zonkTerm</span></a><span> </span><a href="#local-6989586621683032762"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-667"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683032702"><span class="hs-identifier hs-var">fixFunDictionaries</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683032701"><span class="hs-identifier hs-var">expandNewtypes</span></a><span> </span><a href="#local-6989586621683032763"><span class="hs-identifier hs-var">term'</span></a><span>
</span><a name="line-668"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-669"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683032764"><a href="#local-6989586621683032764"><span class="hs-identifier">old_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032765"><a href="#local-6989586621683032765"><span class="hs-identifier">rev_subst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#instScheme"><span class="hs-identifier hs-var">instScheme</span></a><span> </span><a href="#local-6989586621683032758"><span class="hs-identifier hs-var">quant_old_ty</span></a><span>
</span><a name="line-670"></a><span>              </span><a name="local-6989586621683032766"><a href="#local-6989586621683032766"><span class="hs-identifier">my_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newOpenVar"><span class="hs-identifier hs-var">newOpenVar</span></a><span>
</span><a name="line-671"></a><span>              </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#check1"><span class="hs-identifier hs-var">check1</span></a><span> </span><a href="#local-6989586621683032758"><span class="hs-identifier hs-var">quant_old_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;check1 passed&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-672"></a><span>                                          </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><a href="#local-6989586621683032766"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032764"><span class="hs-identifier hs-var">old_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-673"></a><span>              </span><a name="local-6989586621683032767"><a href="#local-6989586621683032767"><span class="hs-identifier">term</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032696"><span class="hs-identifier hs-var">max_depth</span></a><span> </span><a href="#local-6989586621683032766"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032761"><span class="hs-identifier hs-var">sigma_old_ty</span></a><span> </span><a href="#local-6989586621683032699"><span class="hs-identifier hs-var">hval</span></a><span>
</span><a name="line-674"></a><span>              </span><a name="local-6989586621683032768"><a href="#local-6989586621683032768"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#termType"><span class="hs-identifier hs-var">termType</span></a><span> </span><a href="#local-6989586621683032767"><span class="hs-identifier hs-var">term</span></a><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>              </span><span class="hs-keyword">if</span><span> </span><a href="RtClosureInspect.html#isMonomorphic"><span class="hs-identifier hs-var">isMonomorphic</span></a><span> </span><a href="#local-6989586621683032768"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="RtClosureInspect.html#check2"><span class="hs-identifier hs-var">check2</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><a href="#local-6989586621683032768"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032758"><span class="hs-identifier hs-var">quant_old_ty</span></a><span>
</span><a name="line-676"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-677"></a><span>                      </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;check2 passed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>                      </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><a href="#local-6989586621683032768"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><a href="#local-6989586621683032764"><span class="hs-identifier hs-var">old_ty'</span></a><span>
</span><a name="line-679"></a><span>                      </span><a href="RtClosureInspect.html#applyRevSubst"><span class="hs-identifier hs-var">applyRevSubst</span></a><span> </span><a href="#local-6989586621683032765"><span class="hs-identifier hs-var">rev_subst</span></a><span>
</span><a name="line-680"></a><span>                      </span><a name="local-6989586621683032769"><a href="#local-6989586621683032769"><span class="hs-identifier">zterm'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#zonkTerm"><span class="hs-identifier hs-var">zonkTerm</span></a><span> </span><a href="#local-6989586621683032767"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-681"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621683032702"><span class="hs-identifier hs-var">fixFunDictionaries</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683032701"><span class="hs-identifier hs-var">expandNewtypes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032769"><span class="hs-identifier hs-var">zterm'</span></a><span class="hs-special">)</span><span>
</span><a name="line-682"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-683"></a><span>                      </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;check2 failed&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span>
</span><a name="line-684"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032767"><span class="hs-identifier hs-var">term</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;::&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032768"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>                      </span><span class="hs-comment">-- we have unsound types. Replace constructor types in</span><span>
</span><a name="line-686"></a><span>                      </span><span class="hs-comment">-- subterms with tyvars</span><span>
</span><a name="line-687"></a><span>                      </span><a name="local-6989586621683032772"><a href="#local-6989586621683032772"><span class="hs-identifier">zterm'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#mapTermTypeM"><span class="hs-identifier hs-var">mapTermTypeM</span></a><span>
</span><a name="line-688"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683032770"><a href="#local-6989586621683032770"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032770"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-689"></a><span>                                           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032771"><a href="#local-6989586621683032771"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032771"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">funTyCon</span><span>
</span><a name="line-690"></a><span>                                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#newOpenVar"><span class="hs-identifier hs-var">newOpenVar</span></a><span>
</span><a name="line-691"></a><span>                                           </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032770"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-692"></a><span>                                 </span><a href="#local-6989586621683032767"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-693"></a><span>                      </span><a href="RtClosureInspect.html#zonkTerm"><span class="hs-identifier hs-var">zonkTerm</span></a><span> </span><a href="#local-6989586621683032772"><span class="hs-identifier hs-var">zterm'</span></a><span>
</span><a name="line-694"></a><span>   </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Term reconstruction completed.&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-695"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Term obtained: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032773"><span class="hs-identifier hs-var">term</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-696"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type obtained: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#termType"><span class="hs-identifier hs-var">termType</span></a><span> </span><a href="#local-6989586621683032773"><span class="hs-identifier hs-var">term</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032773"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-698"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-699"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-700"></a><span>   </span><span class="hs-comment">-- I believe that my_ty should not have any enclosing</span><span>
</span><a name="line-701"></a><span>   </span><span class="hs-comment">-- foralls, nor any free RuntimeUnk skolems;</span><span>
</span><a name="line-702"></a><span>   </span><span class="hs-comment">-- that is partly what the quantifyType stuff achieved</span><span>
</span><a name="line-703"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-704"></a><span>   </span><span class="hs-comment">-- [SPJ May 11] I don't understand the difference between my_ty and old_ty</span><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span>  </span><a name="local-6989586621683032700"><a href="#local-6989586621683032700"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621683032703"><a href="#local-6989586621683032703"><span class="hs-identifier">my_ty</span></a></a><span> </span><a name="local-6989586621683032704"><a href="#local-6989586621683032704"><span class="hs-identifier">_old_ty</span></a></a><span> </span><a name="local-6989586621683032705"><a href="#local-6989586621683032705"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-707"></a><span>    </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Gave up reconstructing a term after&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-708"></a><span>                  </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621683032696"><span class="hs-identifier hs-var">max_depth</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; steps&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-709"></a><span>    </span><a name="local-6989586621683032706"><a href="#local-6989586621683032706"><span class="hs-identifier">clos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#trIO"><span class="hs-identifier hs-var">trIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#getClosure"><span class="hs-identifier hs-var">GHCi.getClosure</span></a><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032705"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-710"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tipe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">info</span><span> </span><a href="#local-6989586621683032706"><span class="hs-identifier hs-var">clos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032703"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032705"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621683032707"><a href="#local-6989586621683032707"><span class="hs-identifier">max_depth</span></a></a><span> </span><a name="local-6989586621683032708"><a href="#local-6989586621683032708"><span class="hs-identifier">my_ty</span></a></a><span> </span><a name="local-6989586621683032709"><a href="#local-6989586621683032709"><span class="hs-identifier">old_ty</span></a></a><span> </span><a name="local-6989586621683032710"><a href="#local-6989586621683032710"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-712"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032711"><a href="#local-6989586621683032711"><span class="hs-identifier">monomorphic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTyVarTy</span><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>    </span><span class="hs-comment">-- This ^^^ is a convention. The ancestor tests for</span><span>
</span><a name="line-714"></a><span>    </span><span class="hs-comment">-- monomorphism and passes a type instead of a tv</span><span>
</span><a name="line-715"></a><span>    </span><a name="local-6989586621683032712"><a href="#local-6989586621683032712"><span class="hs-identifier">clos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#trIO"><span class="hs-identifier hs-var">trIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#getClosure"><span class="hs-identifier hs-var">GHCi.getClosure</span></a><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-716"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032712"><span class="hs-identifier hs-var">clos</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-717"></a><span class="hs-comment">-- Thunks we may want to force</span><span>
</span><a name="line-718"></a><span>      </span><a name="local-6989586621683032713"><a href="#local-6989586621683032713"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="RtClosureInspect.html#isThunk"><span class="hs-identifier hs-var">isThunk</span></a><span> </span><a href="#local-6989586621683032713"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683032697"><span class="hs-identifier hs-var">force</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-719"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Forcing a &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032713"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-720"></a><span>         </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#seqHValue"><span class="hs-identifier hs-var">GHCi.seqHValue</span></a><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-721"></a><span>         </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pred</span><span> </span><a href="#local-6989586621683032707"><span class="hs-identifier hs-var">max_depth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032709"><span class="hs-identifier hs-var">old_ty</span></a><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-722"></a><span class="hs-comment">-- Blackholes are indirections iff the payload is not TSO or BLOCKING_QUEUE. If</span><span>
</span><a name="line-723"></a><span class="hs-comment">-- the indirection is a TSO or BLOCKING_QUEUE, we return the BLACKHOLE itself as</span><span>
</span><a name="line-724"></a><span class="hs-comment">-- the suspension so that entering it in GHCi will enter the BLACKHOLE instead</span><span>
</span><a name="line-725"></a><span class="hs-comment">-- of entering the TSO or BLOCKING_QUEUE (which leads to runtime panic).</span><span>
</span><a name="line-726"></a><span>      </span><span class="hs-identifier hs-var">BlackholeClosure</span><span class="hs-special">{</span><span class="hs-identifier">indirectee</span><span class="hs-glyph">=</span><a name="local-6989586621683032714"><a href="#local-6989586621683032714"><span class="hs-identifier">ind</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-727"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Following a BLACKHOLE&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-728"></a><span>         </span><a name="local-6989586621683032715"><a href="#local-6989586621683032715"><span class="hs-identifier">ind_clos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#trIO"><span class="hs-identifier hs-var">trIO</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.html#getClosure"><span class="hs-identifier hs-var">GHCi.getClosure</span></a><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032714"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">)</span><span>
</span><a name="line-729"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032716"><a href="#local-6989586621683032716"><span class="hs-identifier">return_bh_value</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><span class="hs-identifier hs-var">BLACKHOLE</span><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032715"><span class="hs-identifier hs-var">ind_clos</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-731"></a><span>           </span><span class="hs-comment">-- TSO and BLOCKING_QUEUE cases</span><span>
</span><a name="line-732"></a><span>           </span><span class="hs-identifier hs-var">BlockingQueueClosure</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032716"><span class="hs-identifier hs-var">return_bh_value</span></a><span>
</span><a name="line-733"></a><span>           </span><span class="hs-identifier hs-var">OtherClosure</span><span> </span><a name="local-6989586621683032717"><a href="#local-6989586621683032717"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-734"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">tipe</span><span> </span><a href="#local-6989586621683032717"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">TSO</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032716"><span class="hs-identifier hs-var">return_bh_value</span></a><span>
</span><a name="line-735"></a><span>           </span><span class="hs-identifier hs-var">UnsupportedClosure</span><span> </span><a name="local-6989586621683032718"><a href="#local-6989586621683032718"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-736"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">tipe</span><span> </span><a href="#local-6989586621683032718"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">TSO</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032716"><span class="hs-identifier hs-var">return_bh_value</span></a><span>
</span><a name="line-737"></a><span>           </span><span class="hs-comment">-- Otherwise follow the indirectee</span><span>
</span><a name="line-738"></a><span>           </span><span class="hs-comment">-- (NOTE: This code will break if we support TSO in ghc-heap one day)</span><span>
</span><a name="line-739"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032707"><span class="hs-identifier hs-var">max_depth</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032709"><span class="hs-identifier hs-var">old_ty</span></a><span> </span><a href="#local-6989586621683032714"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-740"></a><span class="hs-comment">-- We always follow indirections</span><span>
</span><a name="line-741"></a><span>      </span><span class="hs-identifier hs-var">IndClosure</span><span class="hs-special">{</span><span class="hs-identifier">indirectee</span><span class="hs-glyph">=</span><a name="local-6989586621683032719"><a href="#local-6989586621683032719"><span class="hs-identifier">ind</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-742"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Following an indirection&quot;</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>         </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032707"><span class="hs-identifier hs-var">max_depth</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032709"><span class="hs-identifier hs-var">old_ty</span></a><span> </span><a href="#local-6989586621683032719"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-744"></a><span class="hs-comment">-- We also follow references</span><span>
</span><a name="line-745"></a><span>      </span><span class="hs-identifier hs-var">MutVarClosure</span><span class="hs-special">{</span><span class="hs-identifier">var</span><span class="hs-glyph">=</span><a name="local-6989586621683032720"><a href="#local-6989586621683032720"><span class="hs-identifier">contents</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-746"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032721"><a href="#local-6989586621683032721"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span class="hs-special">[</span><a name="local-6989586621683032722"><a href="#local-6989586621683032722"><span class="hs-identifier">world</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032723"><a href="#local-6989586621683032723"><span class="hs-identifier">contents_ty</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032709"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-747"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-748"></a><span>                  </span><span class="hs-comment">-- Deal with the MutVar# primitive</span><span>
</span><a name="line-749"></a><span>                  </span><span class="hs-comment">-- It does not have a constructor at all,</span><span>
</span><a name="line-750"></a><span>                  </span><span class="hs-comment">-- so we simulate the following one</span><span>
</span><a name="line-751"></a><span>                  </span><span class="hs-comment">-- MutVar# :: contents_ty -&gt; MutVar# s contents_ty</span><span>
</span><a name="line-752"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Following a MutVar&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>         </span><a name="local-6989586621683032724"><a href="#local-6989586621683032724"><span class="hs-identifier">contents_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-754"></a><span>         </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isUnliftedType</span><span> </span><span class="hs-identifier hs-var">my_ty</span><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621683032725"><a href="#local-6989586621683032725"><span class="hs-identifier">mutvar_ty</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#instScheme"><span class="hs-identifier hs-var">instScheme</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFunTy</span><span>
</span><a name="line-756"></a><span>                            </span><a href="#local-6989586621683032723"><span class="hs-identifier hs-var">contents_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683032721"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032722"><span class="hs-identifier hs-var">world</span></a><span class="hs-special">,</span><a href="#local-6989586621683032723"><span class="hs-identifier hs-var">contents_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>         </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683032724"><span class="hs-identifier hs-var">contents_tv</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032725"><span class="hs-identifier hs-var">mutvar_ty</span></a><span>
</span><a name="line-758"></a><span>         </span><a name="local-6989586621683032726"><a href="#local-6989586621683032726"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pred</span><span> </span><a href="#local-6989586621683032707"><span class="hs-identifier hs-var">max_depth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032724"><span class="hs-identifier hs-var">contents_tv</span></a><span> </span><a href="#local-6989586621683032723"><span class="hs-identifier hs-var">contents_ty</span></a><span> </span><a href="#local-6989586621683032720"><span class="hs-identifier hs-var">contents</span></a><span>
</span><a name="line-759"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032726"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span>
</span><a name="line-761"></a><span> </span><span class="hs-comment">-- The interesting case</span><span>
</span><a name="line-762"></a><span>      </span><span class="hs-identifier hs-var">ConstrClosure</span><span class="hs-special">{</span><span class="hs-identifier">ptrArgs</span><span class="hs-glyph">=</span><a name="local-6989586621683032727"><a href="#local-6989586621683032727"><span class="hs-identifier">pArgs</span></a></a><span class="hs-special">,</span><span class="hs-identifier">dataArgs</span><span class="hs-glyph">=</span><a name="local-6989586621683032728"><a href="#local-6989586621683032728"><span class="hs-identifier">dArgs</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-763"></a><span>        </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;entering a constructor &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032728"><span class="hs-identifier hs-var">dArgs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-764"></a><span>                      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683032711"><span class="hs-identifier hs-var">monomorphic</span></a><span>
</span><a name="line-765"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;already monomorphic: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Ppr.empty</span><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621683032729"><a href="#local-6989586621683032729"><span class="hs-identifier">dcname</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#constrClosToName"><span class="hs-identifier hs-var">constrClosToName</span></a><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032712"><span class="hs-identifier hs-var">clos</span></a><span>
</span><a name="line-768"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683032730"><a href="#local-6989586621683032730"><span class="hs-identifier">mb_dc</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tryTc"><span class="hs-identifier hs-var">tryTc</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><a href="#local-6989586621683032729"><span class="hs-identifier hs-var">dcname</span></a><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032730"><span class="hs-identifier hs-var">mb_dc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-770"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- This can happen for private constructors compiled -O0</span><span>
</span><a name="line-771"></a><span>                        </span><span class="hs-comment">-- where the .hi descriptor does not export them</span><span>
</span><a name="line-772"></a><span>                        </span><span class="hs-comment">-- In such case, we return a best approximation:</span><span>
</span><a name="line-773"></a><span>                        </span><span class="hs-comment">--  ignore the unpointed args, and recover the pointeds</span><span>
</span><a name="line-774"></a><span>                        </span><span class="hs-comment">-- This preserves laziness, and should be safe.</span><span>
</span><a name="line-775"></a><span>                       </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Not constructor&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032729"><span class="hs-identifier hs-var">dcname</span></a><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span>                       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032731"><a href="#local-6989586621683032731"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683032695"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-777"></a><span>                           </span><a name="local-6989586621683032732"><a href="#local-6989586621683032732"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">showPpr</span><span> </span><a href="#local-6989586621683032731"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683032729"><span class="hs-identifier hs-var">dcname</span></a><span>
</span><a name="line-778"></a><span>                       </span><a name="local-6989586621683032733"><a href="#local-6989586621683032733"><span class="hs-identifier">vars</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683032727"><span class="hs-identifier hs-var">pArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-779"></a><span>                                              </span><span class="hs-special">(</span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span>                       </span><a name="local-6989586621683032736"><a href="#local-6989586621683032736"><span class="hs-identifier">subTerms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683032734"><a href="#local-6989586621683032734"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683032735"><a href="#local-6989586621683032735"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-781"></a><span>                           </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pred</span><span> </span><a href="#local-6989586621683032707"><span class="hs-identifier hs-var">max_depth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032735"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621683032735"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621683032734"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032727"><span class="hs-identifier hs-var">pArgs</span></a><span> </span><a href="#local-6989586621683032733"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-782"></a><span>                       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-char">'&lt;'</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032732"><span class="hs-identifier hs-var">tag</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;&gt;&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621683032736"><span class="hs-identifier hs-var">subTerms</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032737"><a href="#local-6989586621683032737"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-784"></a><span>            </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Is constructor&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032737"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>            </span><a name="local-6989586621683032738"><a href="#local-6989586621683032738"><span class="hs-identifier">subTtypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#getDataConArgTys"><span class="hs-identifier hs-var">getDataConArgTys</span></a><span> </span><a href="#local-6989586621683032737"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span>
</span><a name="line-786"></a><span>            </span><a name="local-6989586621683032740"><a href="#local-6989586621683032740"><span class="hs-identifier">subTerms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#extractSubTerms"><span class="hs-identifier hs-var">extractSubTerms</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683032739"><a href="#local-6989586621683032739"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032700"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pred</span><span> </span><a href="#local-6989586621683032707"><span class="hs-identifier hs-var">max_depth</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032739"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032739"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032712"><span class="hs-identifier hs-var">clos</span></a><span> </span><a href="#local-6989586621683032738"><span class="hs-identifier hs-var">subTtypes</span></a><span>
</span><a name="line-787"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621683032737"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621683032740"><span class="hs-identifier hs-var">subTerms</span></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span>      </span><span class="hs-comment">-- This is to support printing of Integers. It's not a general</span><span>
</span><a name="line-790"></a><span>      </span><span class="hs-comment">-- mechanism by any means; in particular we lose the size in</span><span>
</span><a name="line-791"></a><span>      </span><span class="hs-comment">-- bytes of the array.</span><span>
</span><a name="line-792"></a><span>      </span><span class="hs-identifier hs-var">ArrWordsClosure</span><span class="hs-special">{</span><span class="hs-identifier">bytes</span><span class="hs-glyph">=</span><a name="local-6989586621683032741"><a href="#local-6989586621683032741"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">arrWords</span><span class="hs-glyph">=</span><a name="local-6989586621683032742"><a href="#local-6989586621683032742"><span class="hs-identifier">ws</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-793"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ByteArray# closure, size &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032741"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-794"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;ByteArray#&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">[</span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032742"><span class="hs-identifier hs-var">ws</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span class="hs-comment">-- The otherwise case: can be a Thunk,AP,PAP,etc.</span><span>
</span><a name="line-797"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-798"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unknown closure:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-799"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032712"><span class="hs-identifier hs-var">clos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-800"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tipe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">info</span><span> </span><a href="#local-6989586621683032712"><span class="hs-identifier hs-var">clos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032708"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032710"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span>  </span><span class="hs-comment">-- insert NewtypeWraps around newtypes</span><span>
</span><a name="line-803"></a><span>  </span><a name="local-6989586621683032701"><a href="#local-6989586621683032701"><span class="hs-identifier">expandNewtypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="RtClosureInspect.html#idTermFold"><span class="hs-identifier hs-var">idTermFold</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fTerm</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032743"><span class="hs-identifier hs-var">worker</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-804"></a><span>   </span><a name="local-6989586621683032743"><a href="#local-6989586621683032743"><span class="hs-identifier">worker</span></a></a><span> </span><a name="local-6989586621683032744"><a href="#local-6989586621683032744"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032745"><a href="#local-6989586621683032745"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032746"><a href="#local-6989586621683032746"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621683032747"><a href="#local-6989586621683032747"><span class="hs-identifier">tt</span></a></a><span>
</span><a name="line-805"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032748"><a href="#local-6989586621683032748"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032749"><a href="#local-6989586621683032749"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032744"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-806"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><a href="#local-6989586621683032748"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-807"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032750"><a href="#local-6989586621683032750"><span class="hs-identifier">wrapped_type</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTyConInstRhs</span><span> </span><a href="#local-6989586621683032748"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683032749"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-808"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032751"><a href="#local-6989586621683032751"><span class="hs-identifier">dc'</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConSingleDataCon_maybe</span><span> </span><a href="#local-6989586621683032748"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-809"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032752"><a href="#local-6989586621683032752"><span class="hs-identifier">t'</span></a></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032743"><span class="hs-identifier hs-var">worker</span></a><span> </span><a href="#local-6989586621683032750"><span class="hs-identifier hs-var">wrapped_type</span></a><span> </span><a href="#local-6989586621683032745"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032746"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032747"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-810"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span> </span><a href="#local-6989586621683032744"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621683032751"><span class="hs-identifier hs-var">dc'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032752"><span class="hs-identifier hs-var">t'</span></a><span>
</span><a name="line-811"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032744"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032745"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032746"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032747"><span class="hs-identifier hs-var">tt</span></a><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span>   </span><span class="hs-comment">-- Avoid returning types where predicates have been expanded to dictionaries.</span><span>
</span><a name="line-815"></a><span>  </span><a name="local-6989586621683032702"><a href="#local-6989586621683032702"><span class="hs-identifier">fixFunDictionaries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTerm"><span class="hs-identifier hs-var">foldTerm</span></a><span> </span><a href="RtClosureInspect.html#idTermFold"><span class="hs-identifier hs-var">idTermFold</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">fSuspension</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032753"><span class="hs-identifier hs-var">worker</span></a><span class="hs-special">}</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-816"></a><span>      </span><a name="local-6989586621683032753"><a href="#local-6989586621683032753"><span class="hs-identifier">worker</span></a></a><span> </span><a name="local-6989586621683032754"><a href="#local-6989586621683032754"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621683032755"><a href="#local-6989586621683032755"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032756"><a href="#local-6989586621683032756"><span class="hs-identifier">hval</span></a></a><span> </span><a name="local-6989586621683032757"><a href="#local-6989586621683032757"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFunTy</span><span> </span><a href="#local-6989586621683032755"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a href="#local-6989586621683032754"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#dictsView"><span class="hs-identifier hs-var">dictsView</span></a><span> </span><a href="#local-6989586621683032755"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032756"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032757"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-817"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a href="#local-6989586621683032754"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621683032755"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032756"><span class="hs-identifier hs-var">hval</span></a><span> </span><a href="#local-6989586621683032757"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">extractSubTerms</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GenClosure</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span class="hs-special">]</span><span>
</span><a name="line-821"></a><a name="extractSubTerms"><a href="RtClosureInspect.html#extractSubTerms"><span class="hs-identifier">extractSubTerms</span></a></a><span> </span><a name="local-6989586621683032774"><a href="#local-6989586621683032774"><span class="hs-identifier">recurse</span></a></a><span> </span><a name="local-6989586621683032775"><a href="#local-6989586621683032775"><span class="hs-identifier">clos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">thdOf3</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683032777"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-822"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-823"></a><span>    </span><a name="local-6989586621683032776"><a href="#local-6989586621683032776"><span class="hs-identifier">array</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dataArgs</span><span> </span><a href="#local-6989586621683032775"><span class="hs-identifier hs-var">clos</span></a><span>
</span><a name="line-824"></a><span>
</span><a name="line-825"></a><span>    </span><a name="local-6989586621683032777"><a href="#local-6989586621683032777"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683032782"><a href="#local-6989586621683032782"><span class="hs-identifier">ptr_i</span></a></a><span> </span><a name="local-6989586621683032783"><a href="#local-6989586621683032783"><span class="hs-identifier">arr_i</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032782"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032783"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683032784"><a href="#local-6989586621683032784"><span class="hs-identifier">ptr_i</span></a></a><span> </span><a name="local-6989586621683032785"><a href="#local-6989586621683032785"><span class="hs-identifier">arr_i</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032786"><a href="#local-6989586621683032786"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683032787"><a href="#local-6989586621683032787"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032788"><a href="#local-6989586621683032788"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032789"><a href="#local-6989586621683032789"><span class="hs-identifier">elem_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032786"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-828"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span><span> </span><a href="#local-6989586621683032788"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-829"></a><span>                </span><span class="hs-comment">-- See Note [Unboxed tuple RuntimeRep vars] in TyCon</span><span>
</span><a name="line-830"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032790"><a href="#local-6989586621683032790"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032791"><a href="#local-6989586621683032791"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032792"><a href="#local-6989586621683032792"><span class="hs-identifier">terms0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-831"></a><span>               </span><a href="#local-6989586621683032777"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032784"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032785"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dropRuntimeRepArgs</span><span> </span><a href="#local-6989586621683032789"><span class="hs-identifier hs-var">elem_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683032793"><a href="#local-6989586621683032793"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032794"><a href="#local-6989586621683032794"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032795"><a href="#local-6989586621683032795"><span class="hs-identifier">terms1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032777"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032790"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032791"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032787"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-833"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032793"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032794"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032780"><span class="hs-identifier hs-var">unboxedTupleTerm</span></a><span> </span><a href="#local-6989586621683032786"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032792"><span class="hs-identifier hs-var">terms0</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032795"><span class="hs-identifier hs-var">terms1</span></a><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-835"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">typePrimRepArgs</span><span> </span><a href="#local-6989586621683032786"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-836"></a><span>          </span><span class="hs-special">[</span><a name="local-6989586621683032796"><a href="#local-6989586621683032796"><span class="hs-identifier">rep_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span>
</span><a name="line-837"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621683032797"><a href="#local-6989586621683032797"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032798"><a href="#local-6989586621683032798"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032799"><a href="#local-6989586621683032799"><span class="hs-identifier">term0</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032779"><span class="hs-identifier hs-var">go_rep</span></a><span> </span><a href="#local-6989586621683032784"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032785"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032786"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032796"><span class="hs-identifier hs-var">rep_ty</span></a><span>
</span><a name="line-838"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621683032800"><a href="#local-6989586621683032800"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032801"><a href="#local-6989586621683032801"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032802"><a href="#local-6989586621683032802"><span class="hs-identifier">terms1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032777"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032797"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032798"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032787"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-839"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032800"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032801"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032799"><span class="hs-identifier hs-var">term0</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032802"><span class="hs-identifier hs-var">terms1</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span>          </span><a name="local-6989586621683032803"><a href="#local-6989586621683032803"><span class="hs-identifier">rep_tys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-841"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683032804"><a href="#local-6989586621683032804"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032805"><a href="#local-6989586621683032805"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032806"><a href="#local-6989586621683032806"><span class="hs-identifier">terms0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032778"><span class="hs-identifier hs-var">go_unary_types</span></a><span> </span><a href="#local-6989586621683032784"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032785"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032803"><span class="hs-identifier hs-var">rep_tys</span></a><span>
</span><a name="line-842"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683032807"><a href="#local-6989586621683032807"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032808"><a href="#local-6989586621683032808"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032809"><a href="#local-6989586621683032809"><span class="hs-identifier">terms1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032777"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032804"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032805"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032787"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-843"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032807"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032808"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032780"><span class="hs-identifier hs-var">unboxedTupleTerm</span></a><span> </span><a href="#local-6989586621683032786"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032806"><span class="hs-identifier hs-var">terms0</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032809"><span class="hs-identifier hs-var">terms1</span></a><span class="hs-special">)</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>    </span><a name="local-6989586621683032778"><a href="#local-6989586621683032778"><span class="hs-identifier">go_unary_types</span></a></a><span> </span><a name="local-6989586621683032810"><a href="#local-6989586621683032810"><span class="hs-identifier">ptr_i</span></a></a><span> </span><a name="local-6989586621683032811"><a href="#local-6989586621683032811"><span class="hs-identifier">arr_i</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032810"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032811"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>    </span><span class="hs-identifier">go_unary_types</span><span> </span><a name="local-6989586621683032812"><a href="#local-6989586621683032812"><span class="hs-identifier">ptr_i</span></a></a><span> </span><a name="local-6989586621683032813"><a href="#local-6989586621683032813"><span class="hs-identifier">arr_i</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032814"><a href="#local-6989586621683032814"><span class="hs-identifier">rep_ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683032815"><a href="#local-6989586621683032815"><span class="hs-identifier">rep_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-847"></a><span>      </span><a name="local-6989586621683032816"><a href="#local-6989586621683032816"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-848"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621683032817"><a href="#local-6989586621683032817"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032818"><a href="#local-6989586621683032818"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032819"><a href="#local-6989586621683032819"><span class="hs-identifier">term0</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032779"><span class="hs-identifier hs-var">go_rep</span></a><span> </span><a href="#local-6989586621683032812"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032813"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032816"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621683032814"><span class="hs-identifier hs-var">rep_ty</span></a><span>
</span><a name="line-849"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621683032820"><a href="#local-6989586621683032820"><span class="hs-identifier">ptr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032821"><a href="#local-6989586621683032821"><span class="hs-identifier">arr_i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032822"><a href="#local-6989586621683032822"><span class="hs-identifier">terms1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032778"><span class="hs-identifier hs-var">go_unary_types</span></a><span> </span><a href="#local-6989586621683032817"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><a href="#local-6989586621683032818"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><a href="#local-6989586621683032815"><span class="hs-identifier hs-var">rep_tys</span></a><span>
</span><a name="line-850"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032820"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032821"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032819"><span class="hs-identifier hs-var">term0</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683032822"><span class="hs-identifier hs-var">terms1</span></a><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>    </span><a name="local-6989586621683032779"><a href="#local-6989586621683032779"><span class="hs-identifier">go_rep</span></a></a><span> </span><a name="local-6989586621683032823"><a href="#local-6989586621683032823"><span class="hs-identifier">ptr_i</span></a></a><span> </span><a name="local-6989586621683032824"><a href="#local-6989586621683032824"><span class="hs-identifier">arr_i</span></a></a><span> </span><a name="local-6989586621683032825"><a href="#local-6989586621683032825"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032826"><a href="#local-6989586621683032826"><span class="hs-identifier">rep</span></a></a><span>
</span><a name="line-853"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGcPtrRep</span><span> </span><a href="#local-6989586621683032826"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-854"></a><span>          </span><a name="local-6989586621683032827"><a href="#local-6989586621683032827"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032774"><span class="hs-identifier hs-var">recurse</span></a><span> </span><a href="#local-6989586621683032825"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptrArgs</span><span> </span><a href="#local-6989586621683032775"><span class="hs-identifier hs-var">clos</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">!!</span><a href="#local-6989586621683032823"><span class="hs-identifier hs-var">ptr_i</span></a><span>
</span><a name="line-855"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032823"><span class="hs-identifier hs-var">ptr_i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032824"><span class="hs-identifier hs-var">arr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032827"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-857"></a><span>          </span><span class="hs-comment">-- This is a bit involved since we allow packing multiple fields</span><span>
</span><a name="line-858"></a><span>          </span><span class="hs-comment">-- within a single word. See also</span><span>
</span><a name="line-859"></a><span>          </span><span class="hs-comment">-- StgCmmLayout.mkVirtHeapOffsetsWithPadding</span><span>
</span><a name="line-860"></a><span>          </span><a name="local-6989586621683032828"><a href="#local-6989586621683032828"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-861"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032829"><a href="#local-6989586621683032829"><span class="hs-identifier">word_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621683032828"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-862"></a><span>              </span><a name="local-6989586621683032830"><a href="#local-6989586621683032830"><span class="hs-identifier">big_endian</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">wORDS_BIGENDIAN</span><span> </span><a href="#local-6989586621683032828"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-863"></a><span>              </span><a name="local-6989586621683032831"><a href="#local-6989586621683032831"><span class="hs-identifier">size_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">primRepSizeB</span><span> </span><a href="#local-6989586621683032828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683032826"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-864"></a><span>              </span><span class="hs-comment">-- Align the start offset (eg, 2-byte value should be 2-byte</span><span>
</span><a name="line-865"></a><span>              </span><span class="hs-comment">-- aligned). But not more than to a word. The offset calculation</span><span>
</span><a name="line-866"></a><span>              </span><span class="hs-comment">-- should be the same with the offset calculation in</span><span>
</span><a name="line-867"></a><span>              </span><span class="hs-comment">-- StgCmmLayout.mkVirtHeapOffsetsWithPadding.</span><span>
</span><a name="line-868"></a><span>              </span><span class="hs-glyph">!</span><a name="local-6989586621683032832"><a href="#local-6989586621683032832"><span class="hs-identifier">aligned_idx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#roundUpTo"><span class="hs-identifier hs-var">roundUpTo</span></a><span> </span><a href="#local-6989586621683032824"><span class="hs-identifier hs-var">arr_i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">min</span><span> </span><a href="#local-6989586621683032829"><span class="hs-identifier hs-var">word_size</span></a><span> </span><a href="#local-6989586621683032831"><span class="hs-identifier hs-var">size_b</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>              </span><span class="hs-glyph">!</span><a name="local-6989586621683032833"><a href="#local-6989586621683032833"><span class="hs-identifier">new_arr_i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032832"><span class="hs-identifier hs-var">aligned_idx</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621683032831"><span class="hs-identifier hs-var">size_b</span></a><span>
</span><a name="line-870"></a><span>              </span><a name="local-6989586621683032834"><a href="#local-6989586621683032834"><span class="hs-identifier">ws</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683032831"><span class="hs-identifier hs-var">size_b</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621683032829"><span class="hs-identifier hs-var">word_size</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-871"></a><span>                     </span><span class="hs-special">[</span><a href="#local-6989586621683032781"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621683032831"><span class="hs-identifier hs-var">size_b</span></a><span> </span><a href="#local-6989586621683032832"><span class="hs-identifier hs-var">aligned_idx</span></a><span> </span><a href="#local-6989586621683032829"><span class="hs-identifier hs-var">word_size</span></a><span> </span><a href="#local-6989586621683032830"><span class="hs-identifier hs-var">big_endian</span></a><span class="hs-special">]</span><span>
</span><a name="line-872"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-873"></a><span>                     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032835"><a href="#local-6989586621683032835"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032836"><a href="#local-6989586621683032836"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032831"><span class="hs-identifier hs-var">size_b</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032829"><span class="hs-identifier hs-var">word_size</span></a><span>
</span><a name="line-874"></a><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">r</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span>                        </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683032776"><span class="hs-identifier hs-var">array</span></a><span class="hs-operator hs-var">!!</span><a href="#local-6989586621683032838"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-876"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683032837"><a href="#local-6989586621683032837"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621683032835"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span>
</span><a name="line-877"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032838"><a href="#local-6989586621683032838"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032832"><span class="hs-identifier hs-var">aligned_idx</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quot</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032829"><span class="hs-identifier hs-var">word_size</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621683032837"><span class="hs-identifier hs-var">o</span></a><span>
</span><a name="line-878"></a><span>                        </span><span class="hs-special">]</span><span>
</span><a name="line-879"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032823"><span class="hs-identifier hs-var">ptr_i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032833"><span class="hs-identifier hs-var">new_arr_i</span></a><span class="hs-special">,</span><span> </span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span> </span><a href="#local-6989586621683032825"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032834"><span class="hs-identifier hs-var">ws</span></a><span class="hs-special">)</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span>    </span><a name="local-6989586621683032780"><a href="#local-6989586621683032780"><span class="hs-identifier">unboxedTupleTerm</span></a></a><span> </span><a name="local-6989586621683032839"><a href="#local-6989586621683032839"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032840"><a href="#local-6989586621683032840"><span class="hs-identifier">terms</span></a></a><span>
</span><a name="line-882"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032839"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683032840"><span class="hs-identifier hs-var">terms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;unboxedTupleTerm: no HValue for unboxed tuple&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032840"><span class="hs-identifier hs-var">terms</span></a><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span>    </span><span class="hs-comment">-- Extract a sub-word sized field from a word</span><span>
</span><a name="line-886"></a><span>    </span><a name="local-6989586621683032781"><a href="#local-6989586621683032781"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621683032841"><a href="#local-6989586621683032841"><span class="hs-identifier">item_size_b</span></a></a><span> </span><a name="local-6989586621683032842"><a href="#local-6989586621683032842"><span class="hs-identifier">index_b</span></a></a><span> </span><a name="local-6989586621683032843"><a href="#local-6989586621683032843"><span class="hs-identifier">word_size</span></a></a><span> </span><a name="local-6989586621683032844"><a href="#local-6989586621683032844"><span class="hs-identifier">big_endian</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-887"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621683032848"><span class="hs-identifier hs-var">word</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032845"><span class="hs-identifier hs-var">mask</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032849"><span class="hs-identifier hs-var">moveBytes</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032849"><span class="hs-identifier hs-var">moveBytes</span></a><span>
</span><a name="line-888"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-889"></a><span>        </span><span class="hs-identifier">mask</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-890"></a><span>        </span><a name="local-6989586621683032845"><a href="#local-6989586621683032845"><span class="hs-identifier">mask</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032841"><span class="hs-identifier hs-var">item_size_b</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-891"></a><span>            </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0xFF</span><span>
</span><a name="line-892"></a><span>            </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0xFFFF</span><span>
</span><a name="line-893"></a><span>            </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0xFFFFFFFF</span><span>
</span><a name="line-894"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Weird byte-index: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621683032842"><span class="hs-identifier hs-var">index_b</span></a><span class="hs-special">)</span><span>
</span><a name="line-895"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683032846"><a href="#local-6989586621683032846"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032847"><a href="#local-6989586621683032847"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032842"><span class="hs-identifier hs-var">index_b</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032843"><span class="hs-identifier hs-var">word_size</span></a><span>
</span><a name="line-896"></a><span>        </span><a name="local-6989586621683032848"><a href="#local-6989586621683032848"><span class="hs-identifier">word</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032776"><span class="hs-identifier hs-var">array</span></a><span class="hs-operator hs-var">!!</span><a href="#local-6989586621683032846"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-897"></a><span>        </span><a name="local-6989586621683032849"><a href="#local-6989586621683032849"><span class="hs-identifier">moveBytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683032844"><span class="hs-identifier hs-var">big_endian</span></a><span>
</span><a name="line-898"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683032843"><span class="hs-identifier hs-var">word_size</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032847"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621683032841"><span class="hs-identifier hs-var">item_size_b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-899"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683032847"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-900"></a><span>
</span><a name="line-901"></a><span>
</span><a name="line-902"></a><span class="hs-comment">-- | Fast, breadth-first Type reconstruction</span><span>
</span><a name="line-903"></a><span class="hs-comment">--</span><span>
</span><a name="line-904"></a><span class="hs-comment">-- Given a heap object (`HValue`) and its (possibly polymorphic) type (usually</span><span>
</span><a name="line-905"></a><span class="hs-comment">-- obtained in GHCi), try to reconstruct a more monomorphic type of the object.</span><span>
</span><a name="line-906"></a><span class="hs-comment">-- This is used for improving type information in debugger. For example, if we</span><span>
</span><a name="line-907"></a><span class="hs-comment">-- have a polymorphic function:</span><span>
</span><a name="line-908"></a><span class="hs-comment">--</span><span>
</span><a name="line-909"></a><span class="hs-comment">--     sumNumList :: Num a =&gt; [a] -&gt; a</span><span>
</span><a name="line-910"></a><span class="hs-comment">--     sumNumList [] = 0</span><span>
</span><a name="line-911"></a><span class="hs-comment">--     sumNumList (x : xs) = x + sumList xs</span><span>
</span><a name="line-912"></a><span class="hs-comment">--</span><span>
</span><a name="line-913"></a><span class="hs-comment">-- and add a breakpoint to it:</span><span>
</span><a name="line-914"></a><span class="hs-comment">--</span><span>
</span><a name="line-915"></a><span class="hs-comment">--     ghci&gt; break sumNumList</span><span>
</span><a name="line-916"></a><span class="hs-comment">--     ghci&gt; sumNumList ([0 .. 9] :: [Int])</span><span>
</span><a name="line-917"></a><span class="hs-comment">--</span><span>
</span><a name="line-918"></a><span class="hs-comment">-- ghci shows us more precise types than just `a`s:</span><span>
</span><a name="line-919"></a><span class="hs-comment">--</span><span>
</span><a name="line-920"></a><span class="hs-comment">--     Stopped in Main.sumNumList, debugger.hs:3:23-39</span><span>
</span><a name="line-921"></a><span class="hs-comment">--     _result :: Int = _</span><span>
</span><a name="line-922"></a><span class="hs-comment">--     x :: Int = 0</span><span>
</span><a name="line-923"></a><span class="hs-comment">--     xs :: [Int] = _</span><span>
</span><a name="line-924"></a><span class="hs-comment">--</span><span>
</span><a name="line-925"></a><span class="hs-identifier">cvReconstructType</span><span>
</span><a name="line-926"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-927"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>       </span><span class="hs-comment">-- ^ How many times to recurse for subterms</span><span>
</span><a name="line-928"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#GhciType"><span class="hs-identifier hs-type">GhciType</span></a><span>  </span><span class="hs-comment">-- ^ Type to refine</span><span>
</span><a name="line-929"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>  </span><span class="hs-comment">-- ^ Refine the type using this value</span><span>
</span><a name="line-930"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-931"></a><a name="cvReconstructType"><a href="RtClosureInspect.html#cvReconstructType"><span class="hs-identifier">cvReconstructType</span></a></a><span> </span><a name="local-6989586621683032850"><a href="#local-6989586621683032850"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683032851"><a href="#local-6989586621683032851"><span class="hs-identifier">max_depth</span></a></a><span> </span><a name="local-6989586621683032852"><a href="#local-6989586621683032852"><span class="hs-identifier">old_ty</span></a></a><span> </span><a name="local-6989586621683032853"><a href="#local-6989586621683032853"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#runTR_maybe"><span class="hs-identifier hs-var">runTR_maybe</span></a><span> </span><a href="#local-6989586621683032850"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-932"></a><span>   </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RTTI started with initial type &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032852"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032881"><a href="#local-6989586621683032881"><span class="hs-identifier">sigma_old_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683032882"><a href="#local-6989586621683032882"><span class="hs-identifier">old_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><a href="#local-6989586621683032852"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-934"></a><span>   </span><a name="local-6989586621683032889"><a href="#local-6989586621683032889"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-935"></a><span>       </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683032882"><span class="hs-identifier hs-var">old_tvs</span></a><span>
</span><a name="line-936"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032852"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-937"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-938"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621683032883"><a href="#local-6989586621683032883"><span class="hs-identifier">old_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032884"><a href="#local-6989586621683032884"><span class="hs-identifier">rev_subst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#instScheme"><span class="hs-identifier hs-var">instScheme</span></a><span> </span><a href="#local-6989586621683032881"><span class="hs-identifier hs-var">sigma_old_ty</span></a><span>
</span><a name="line-939"></a><span>          </span><a name="local-6989586621683032885"><a href="#local-6989586621683032885"><span class="hs-identifier">my_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newOpenVar"><span class="hs-identifier hs-var">newOpenVar</span></a><span>
</span><a name="line-940"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#check1"><span class="hs-identifier hs-var">check1</span></a><span> </span><a href="#local-6989586621683032881"><span class="hs-identifier hs-var">sigma_old_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;check1 passed&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-941"></a><span>                                      </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><a href="#local-6989586621683032885"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032883"><span class="hs-identifier hs-var">old_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>          </span><a href="#local-6989586621683032854"><span class="hs-identifier hs-var">search</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#isMonomorphic"><span class="hs-identifier hs-var">isMonomorphic</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683032885"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-943"></a><span>                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621683032886"><a href="#local-6989586621683032886"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032887"><a href="#local-6989586621683032887"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032855"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032886"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032887"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-944"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Seq.singleton</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032885"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032853"><span class="hs-identifier hs-var">hval</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-945"></a><span>                 </span><a href="#local-6989586621683032851"><span class="hs-identifier hs-var">max_depth</span></a><span>
</span><a name="line-946"></a><span>          </span><a name="local-6989586621683032888"><a href="#local-6989586621683032888"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683032885"><span class="hs-identifier hs-var">my_ty</span></a><span>
</span><a name="line-947"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="RtClosureInspect.html#isMonomorphic"><span class="hs-identifier hs-var">isMonomorphic</span></a><span> </span><a href="#local-6989586621683032888"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="RtClosureInspect.html#check2"><span class="hs-identifier hs-var">check2</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><a href="#local-6989586621683032888"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032881"><span class="hs-identifier hs-var">sigma_old_ty</span></a><span>
</span><a name="line-948"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-949"></a><span>                 </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;check2 passed&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032852"><span class="hs-identifier hs-var">old_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032888"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-950"></a><span>                 </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><a href="#local-6989586621683032885"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032883"><span class="hs-identifier hs-var">old_ty'</span></a><span>
</span><a name="line-951"></a><span>                 </span><a href="RtClosureInspect.html#applyRevSubst"><span class="hs-identifier hs-var">applyRevSubst</span></a><span> </span><a href="#local-6989586621683032884"><span class="hs-identifier hs-var">rev_subst</span></a><span>
</span><a name="line-952"></a><span>                 </span><a href="RtClosureInspect.html#zonkRttiType"><span class="hs-identifier hs-var">zonkRttiType</span></a><span> </span><a href="#local-6989586621683032888"><span class="hs-identifier hs-var">new_ty</span></a><span>
</span><a name="line-953"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;check2 failed&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032888"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-954"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032852"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-955"></a><span>   </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RTTI completed. Type obtained:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032889"><span class="hs-identifier hs-var">new_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032889"><span class="hs-identifier hs-var">new_ty</span></a><span>
</span><a name="line-957"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-958"></a><span class="hs-comment">--  search :: m Bool -&gt; ([a] -&gt; [a] -&gt; [a]) -&gt; [a] -&gt; m ()</span><span>
</span><a name="line-959"></a><span>  </span><a name="local-6989586621683032854"><a href="#local-6989586621683032854"><span class="hs-identifier">search</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Failed to reconstruct a type after &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-960"></a><span>                                </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621683032851"><span class="hs-identifier hs-var">max_depth</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; steps&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-961"></a><span>  </span><span class="hs-identifier">search</span><span> </span><a name="local-6989586621683032856"><a href="#local-6989586621683032856"><span class="hs-identifier">stop</span></a></a><span> </span><a name="local-6989586621683032857"><a href="#local-6989586621683032857"><span class="hs-identifier">expand</span></a></a><span> </span><a name="local-6989586621683032858"><a href="#local-6989586621683032858"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683032859"><a href="#local-6989586621683032859"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-962"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">viewl</span><span> </span><a href="#local-6989586621683032858"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-963"></a><span>      </span><span class="hs-identifier hs-var">EmptyL</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>      </span><a name="local-6989586621683032860"><a href="#local-6989586621683032860"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><a name="local-6989586621683032861"><a href="#local-6989586621683032861"><span class="hs-identifier">xx</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">unlessM</span><span> </span><a href="#local-6989586621683032856"><span class="hs-identifier hs-var">stop</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-965"></a><span>                  </span><a name="local-6989586621683032862"><a href="#local-6989586621683032862"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032857"><span class="hs-identifier hs-var">expand</span></a><span> </span><a href="#local-6989586621683032860"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-966"></a><span>                  </span><a href="#local-6989586621683032854"><span class="hs-identifier hs-var">search</span></a><span> </span><a href="#local-6989586621683032856"><span class="hs-identifier hs-var">stop</span></a><span> </span><a href="#local-6989586621683032857"><span class="hs-identifier hs-var">expand</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032861"><span class="hs-identifier hs-var">xx</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Seq.fromList</span><span> </span><a href="#local-6989586621683032862"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pred</span><span> </span><a href="#local-6989586621683032859"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span>   </span><span class="hs-comment">-- returns unification tasks,since we are going to want a breadth-first search</span><span>
</span><a name="line-969"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-970"></a><span>  </span><a name="local-6989586621683032855"><a href="#local-6989586621683032855"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683032863"><a href="#local-6989586621683032863"><span class="hs-identifier">my_ty</span></a></a><span> </span><a name="local-6989586621683032864"><a href="#local-6989586621683032864"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-971"></a><span>    </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;go&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032863"><span class="hs-identifier hs-var">my_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>    </span><a name="local-6989586621683032865"><a href="#local-6989586621683032865"><span class="hs-identifier">clos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#trIO"><span class="hs-identifier hs-var">trIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#getClosure"><span class="hs-identifier hs-var">GHCi.getClosure</span></a><span> </span><a href="#local-6989586621683032850"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032864"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-973"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032865"><span class="hs-identifier hs-var">clos</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-974"></a><span>      </span><span class="hs-identifier hs-var">BlackholeClosure</span><span class="hs-special">{</span><span class="hs-identifier">indirectee</span><span class="hs-glyph">=</span><a name="local-6989586621683032866"><a href="#local-6989586621683032866"><span class="hs-identifier">ind</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032855"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032863"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032866"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-975"></a><span>      </span><span class="hs-identifier hs-var">IndClosure</span><span class="hs-special">{</span><span class="hs-identifier">indirectee</span><span class="hs-glyph">=</span><a name="local-6989586621683032867"><a href="#local-6989586621683032867"><span class="hs-identifier">ind</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683032855"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032863"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><a href="#local-6989586621683032867"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-976"></a><span>      </span><span class="hs-identifier hs-var">MutVarClosure</span><span class="hs-special">{</span><span class="hs-identifier">var</span><span class="hs-glyph">=</span><a name="local-6989586621683032868"><a href="#local-6989586621683032868"><span class="hs-identifier">contents</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-977"></a><span>         </span><a name="local-6989586621683032869"><a href="#local-6989586621683032869"><span class="hs-identifier">tv'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-978"></a><span>         </span><a name="local-6989586621683032870"><a href="#local-6989586621683032870"><span class="hs-identifier">world</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-979"></a><span>         </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><a href="#local-6989586621683032863"><span class="hs-identifier hs-var">my_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-identifier hs-var">mutVarPrimTyCon</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032870"><span class="hs-identifier hs-var">world</span></a><span class="hs-special">,</span><a href="#local-6989586621683032869"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-980"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683032869"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032868"><span class="hs-identifier hs-var">contents</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-981"></a><span>      </span><span class="hs-identifier hs-var">ConstrClosure</span><span class="hs-special">{</span><span class="hs-identifier">ptrArgs</span><span class="hs-glyph">=</span><a name="local-6989586621683032871"><a href="#local-6989586621683032871"><span class="hs-identifier">pArgs</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-982"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621683032872"><a href="#local-6989586621683032872"><span class="hs-identifier">dcname</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#constrClosToName"><span class="hs-identifier hs-var">constrClosToName</span></a><span> </span><a href="#local-6989586621683032850"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683032865"><span class="hs-identifier hs-var">clos</span></a><span>
</span><a name="line-983"></a><span>        </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constr1&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032872"><span class="hs-identifier hs-var">dcname</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683032873"><a href="#local-6989586621683032873"><span class="hs-identifier">mb_dc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tryTc"><span class="hs-identifier hs-var">tryTc</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><a href="#local-6989586621683032872"><span class="hs-identifier hs-var">dcname</span></a><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683032873"><span class="hs-identifier hs-var">mb_dc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-986"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-987"></a><span>            </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621683032871"><span class="hs-identifier hs-var">pArgs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032874"><a href="#local-6989586621683032874"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-988"></a><span>              </span><a name="local-6989586621683032875"><a href="#local-6989586621683032875"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-989"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032875"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032874"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032876"><a href="#local-6989586621683032876"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-992"></a><span>            </span><a name="local-6989586621683032877"><a href="#local-6989586621683032877"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#getDataConArgTys"><span class="hs-identifier hs-var">getDataConArgTys</span></a><span> </span><a href="#local-6989586621683032876"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032863"><span class="hs-identifier hs-var">my_ty</span></a><span>
</span><a name="line-993"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032878"><a href="#local-6989586621683032878"><span class="hs-identifier">itys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#findPtrTyss"><span class="hs-identifier hs-var">findPtrTyss</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621683032877"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-994"></a><span>            </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constr2&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032872"><span class="hs-identifier hs-var">dcname</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032877"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683032879"><a href="#local-6989586621683032879"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683032880"><a href="#local-6989586621683032880"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032879"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032880"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032878"><span class="hs-identifier hs-var">itys</span></a><span> </span><a href="#local-6989586621683032871"><span class="hs-identifier hs-var">pArgs</span></a><span>
</span><a name="line-996"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-997"></a><span>
</span><a name="line-998"></a><span class="hs-identifier">findPtrTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- Current pointer index</span><span>
</span><a name="line-999"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-comment">-- Type</span><span>
</span><a name="line-1000"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><a name="findPtrTys"><a href="RtClosureInspect.html#findPtrTys"><span class="hs-identifier">findPtrTys</span></a></a><span> </span><a name="local-6989586621683032890"><a href="#local-6989586621683032890"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621683032891"><a href="#local-6989586621683032891"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1002"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032892"><a href="#local-6989586621683032892"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032893"><a href="#local-6989586621683032893"><span class="hs-identifier">elem_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032891"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1003"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span><span> </span><a href="#local-6989586621683032892"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1004"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#findPtrTyss"><span class="hs-identifier hs-var">findPtrTyss</span></a><span> </span><a href="#local-6989586621683032890"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621683032893"><span class="hs-identifier hs-var">elem_tys</span></a><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><a href="#local-6989586621683032891"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1008"></a><span>      </span><span class="hs-special">[</span><a name="local-6989586621683032894"><a href="#local-6989586621683032894"><span class="hs-identifier">rep</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGcPtrRep</span><span> </span><a href="#local-6989586621683032894"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032890"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683032890"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032891"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032890"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>      </span><a name="local-6989586621683032895"><a href="#local-6989586621683032895"><span class="hs-identifier">prim_reps</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1011"></a><span>        </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621683032896"><a href="#local-6989586621683032896"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032897"><a href="#local-6989586621683032897"><span class="hs-identifier">extras</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683032898"><a href="#local-6989586621683032898"><span class="hs-identifier">prim_rep</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1012"></a><span>                </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isGcPtrRep</span><span> </span><a href="#local-6989586621683032898"><span class="hs-identifier hs-var">prim_rep</span></a><span>
</span><a name="line-1013"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="RtClosureInspect.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032899"><a href="#local-6989586621683032899"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032896"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032897"><span class="hs-identifier hs-var">extras</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683032896"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032899"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1014"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032896"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032897"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>              </span><span class="hs-special">(</span><a href="#local-6989586621683032890"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032895"><span class="hs-identifier hs-var">prim_reps</span></a><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span class="hs-identifier">findPtrTyss</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1018"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-1019"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><a name="findPtrTyss"><a href="RtClosureInspect.html#findPtrTyss"><span class="hs-identifier">findPtrTyss</span></a></a><span> </span><a name="local-6989586621683032900"><a href="#local-6989586621683032900"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621683032901"><a href="#local-6989586621683032901"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621683032902"><span class="hs-identifier hs-var">step</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032900"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683032901"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1021"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683032902"><a href="#local-6989586621683032902"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032903"><a href="#local-6989586621683032903"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032904"><a href="#local-6989586621683032904"><span class="hs-identifier">discovered</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683032905"><a href="#local-6989586621683032905"><span class="hs-identifier">elem_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1022"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621683032906"><a href="#local-6989586621683032906"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032907"><a href="#local-6989586621683032907"><span class="hs-identifier">extras</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#findPtrTys"><span class="hs-identifier hs-var">findPtrTys</span></a><span> </span><a href="#local-6989586621683032903"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621683032905"><span class="hs-identifier hs-var">elem_ty</span></a><span>
</span><a name="line-1023"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032906"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032904"><span class="hs-identifier hs-var">discovered</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683032907"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span class="hs-comment">-- Compute the difference between a base type and the type found by RTTI</span><span>
</span><a name="line-1027"></a><span class="hs-comment">-- improveType &lt;base_type&gt; &lt;rtti_type&gt;</span><span>
</span><a name="line-1028"></a><span class="hs-comment">-- The types can contain skolem type variables, which need to be treated as normal vars.</span><span>
</span><a name="line-1029"></a><span class="hs-comment">-- In particular, we want them to unify with things.</span><span>
</span><a name="line-1030"></a><span class="hs-identifier">improveRTTIType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span>
</span><a name="line-1031"></a><a name="improveRTTIType"><a href="RtClosureInspect.html#improveRTTIType"><span class="hs-identifier">improveRTTIType</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683032908"><a href="#local-6989586621683032908"><span class="hs-identifier">base_ty</span></a></a><span> </span><a name="local-6989586621683032909"><a href="#local-6989586621683032909"><span class="hs-identifier">new_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">U.tcUnifyTyKi</span><span> </span><a href="#local-6989586621683032908"><span class="hs-identifier hs-var">base_ty</span></a><span> </span><a href="#local-6989586621683032909"><span class="hs-identifier hs-var">new_ty</span></a><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span class="hs-identifier">getDataConArgTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-1034"></a><span class="hs-comment">-- Given the result type ty of a constructor application (D a b c :: ty)</span><span>
</span><a name="line-1035"></a><span class="hs-comment">-- return the types of the arguments.  This is RTTI-land, so 'ty' might</span><span>
</span><a name="line-1036"></a><span class="hs-comment">-- not be fully known.  Moreover, the arg types might involve existentials;</span><span>
</span><a name="line-1037"></a><span class="hs-comment">-- if so, make up fresh RTTI type variables for them</span><span>
</span><a name="line-1038"></a><span class="hs-comment">--</span><span>
</span><a name="line-1039"></a><span class="hs-comment">-- I believe that con_app_ty should not have any enclosing foralls</span><span>
</span><a name="line-1040"></a><a name="getDataConArgTys"><a href="RtClosureInspect.html#getDataConArgTys"><span class="hs-identifier">getDataConArgTys</span></a></a><span> </span><a name="local-6989586621683032910"><a href="#local-6989586621683032910"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032911"><a href="#local-6989586621683032911"><span class="hs-identifier">con_app_ty</span></a></a><span>
</span><a name="line-1041"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032914"><a href="#local-6989586621683032914"><span class="hs-identifier">rep_con_app_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unwrapType</span><span> </span><a href="#local-6989586621683032911"><span class="hs-identifier hs-var">con_app_ty</span></a><span>
</span><a name="line-1042"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;getDataConArgTys 1&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032911"><span class="hs-identifier hs-var">con_app_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032914"><span class="hs-identifier hs-var">rep_con_app_ty</span></a><span>
</span><a name="line-1043"></a><span>                   </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032914"><span class="hs-identifier hs-var">rep_con_app_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1044"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">ex_tvs</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1045"></a><span>                 </span><span class="hs-comment">-- ex_tvs can only be tyvars as data types in source</span><span>
</span><a name="line-1046"></a><span>                 </span><span class="hs-comment">-- Haskell cannot mention covar yet (Aug 2018)</span><span>
</span><a name="line-1047"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032915"><a href="#local-6989586621683032915"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#instTyVars"><span class="hs-identifier hs-var">instTyVars</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032912"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683032913"><span class="hs-identifier hs-var">ex_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1048"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RtClosureInspect.html#addConstraint"><span class="hs-identifier hs-var">addConstraint</span></a><span> </span><a href="#local-6989586621683032914"><span class="hs-identifier hs-var">rep_con_app_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683032915"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConOrigResTy</span><span> </span><a href="#local-6989586621683032910"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1049"></a><span>              </span><span class="hs-comment">-- See Note [Constructor arg types]</span><span>
</span><a name="line-1050"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032916"><a href="#local-6989586621683032916"><span class="hs-identifier">con_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621683032915"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConRepArgTys</span><span> </span><a href="#local-6989586621683032910"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;getDataConArgTys 2&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032914"><span class="hs-identifier hs-var">rep_con_app_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032916"><span class="hs-identifier hs-var">con_arg_tys</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032915"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032916"><span class="hs-identifier hs-var">con_arg_tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1053"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1054"></a><span>    </span><a name="local-6989586621683032912"><a href="#local-6989586621683032912"><span class="hs-identifier">univ_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConUnivTyVars</span><span> </span><a href="#local-6989586621683032910"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1055"></a><span>    </span><a name="local-6989586621683032913"><a href="#local-6989586621683032913"><span class="hs-identifier">ex_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConExTyCoVars</span><span> </span><a href="#local-6989586621683032910"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1056"></a><span>
</span><a name="line-1057"></a><span class="hs-comment">{- Note [Constructor arg types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a GADT (cf Trac #7386)
   data family D a b
   data instance D [a] a where
     MkT :: a -&gt; D [a] (Maybe a)
     ...

In getDataConArgTys
* con_app_ty is the known type (from outside) of the constructor application,
  say D [Int] Int

* The data constructor MkT has a (representation) dataConTyCon = DList,
  say where
    data DList a where
      MkT :: a -&gt; DList a (Maybe a)
      ...

So the dataConTyCon of the data constructor, DList, differs from
the &quot;outside&quot; type, D. So we can't straightforwardly decompose the
&quot;outside&quot; type, and we end up in the &quot;_&quot; branch of the case.

Then we match the dataConOrigResTy of the data constructor against the
outside type, hoping to get a substitution that tells how to instantiate
the *representation* type constructor.   This looks a bit delicate to
me, but it seems to work.
-}</span><span>
</span><a name="line-1084"></a><span>
</span><a name="line-1085"></a><span class="hs-comment">-- Soundness checks</span><span>
</span><a name="line-1086"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-1087"></a><span class="hs-comment">{-
This is not formalized anywhere, so hold to your seats!
RTTI in the presence of newtypes can be a tricky and unsound business.

Example:
~~~~~~~~~
Suppose we are doing RTTI for a partially evaluated
closure t, the real type of which is t :: MkT Int, for

   newtype MkT a = MkT [Maybe a]

The table below shows the results of RTTI and the improvement
calculated for different combinations of evaluatedness and :type t.
Regard the two first columns as input and the next two as output.

  # |     t     |  :type t  | rtti(t)  | improv.    | result
    ------------------------------------------------------------
  1 |     _     |    t b    |    a     | none       | OK
  2 |     _     |   MkT b   |    a     | none       | OK
  3 |     _     |   t Int   |    a     | none       | OK

  If t is not evaluated at *all*, we are safe.

  4 |  (_ : _)  |    t b    |   [a]    | t = []     | UNSOUND
  5 |  (_ : _)  |   MkT b   |  MkT a   | none       | OK (compensating for the missing newtype)
  6 |  (_ : _)  |   t Int   |  [Int]   | t = []     | UNSOUND

  If a is a minimal whnf, we run into trouble. Note that
  row 5 above does newtype enrichment on the ty_rtty parameter.

  7 | (Just _:_)|    t b    |[Maybe a] | t = [],    | UNSOUND
    |                       |          | b = Maybe a|

  8 | (Just _:_)|   MkT b   |  MkT a   |  none      | OK
  9 | (Just _:_)|   t Int   |   FAIL   |  none      | OK

  And if t is any more evaluated than whnf, we are still in trouble.
  Because constraints are solved in top-down order, when we reach the
  Maybe subterm what we got is already unsound. This explains why the
  row 9 fails to complete.

  10 | (Just _:_)|  t Int  | [Maybe a]   |  FAIL    | OK
  11 | (Just 1:_)|  t Int  | [Maybe Int] |  FAIL    | OK

  We can undo the failure in row 9 by leaving out the constraint
  coming from the type signature of t (i.e., the 2nd column).
  Note that this type information is still used
  to calculate the improvement. But we fail
  when trying to calculate the improvement, as there is no unifier for
  t Int = [Maybe a] or t Int = [Maybe Int].


  Another set of examples with t :: [MkT (Maybe Int)]  \equiv  [[Maybe (Maybe Int)]]

  # |     t     |    :type t    |  rtti(t)    | improvement | result
    ---------------------------------------------------------------------
  1 |(Just _:_) | [t (Maybe a)] | [[Maybe b]] | t = []      |
    |           |               |             | b = Maybe a |

The checks:
~~~~~~~~~~~
Consider a function obtainType that takes a value and a type and produces
the Term representation and a substitution (the improvement).
Assume an auxiliar rtti' function which does the actual job if recovering
the type, but which may produce a false type.

In pseudocode:

  rtti' :: a -&gt; IO Type  -- Does not use the static type information

  obtainType :: a -&gt; Type -&gt; IO (Maybe (Term, Improvement))
  obtainType v old_ty = do
       rtti_ty &lt;- rtti' v
       if monomorphic rtti_ty || (check rtti_ty old_ty)
        then ...
         else return Nothing
  where check rtti_ty old_ty = check1 rtti_ty &amp;&amp;
                              check2 rtti_ty old_ty

  check1 :: Type -&gt; Bool
  check2 :: Type -&gt; Type -&gt; Bool

Now, if rtti' returns a monomorphic type, we are safe.
If that is not the case, then we consider two conditions.


1. To prevent the class of unsoundness displayed by
   rows 4 and 7 in the example: no higher kind tyvars
   accepted.

  check1 (t a)   = NO
  check1 (t Int) = NO
  check1 ([] a)  = YES

2. To prevent the class of unsoundness shown by row 6,
   the rtti type should be structurally more
   defined than the old type we are comparing it to.
  check2 :: NewType -&gt; OldType -&gt; Bool
  check2 a  _        = True
  check2 [a] a       = True
  check2 [a] (t Int) = False
  check2 [a] (t a)   = False  -- By check1 we never reach this equation
  check2 [Int] a     = True
  check2 [Int] (t Int) = True
  check2 [Maybe a]   (t Int) = False
  check2 [Maybe Int] (t Int) = True
  check2 (Maybe [a])   (m [Int]) = False
  check2 (Maybe [Int]) (m [Int]) = True

-}</span><span>
</span><a name="line-1197"></a><span>
</span><a name="line-1198"></a><span class="hs-identifier">check1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#QuantifiedType"><span class="hs-identifier hs-type">QuantifiedType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1199"></a><a name="check1"><a href="RtClosureInspect.html#check1"><span class="hs-identifier">check1</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683032917"><a href="#local-6989586621683032917"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621683032918"><span class="hs-identifier hs-var">isHigherKind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683032917"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1200"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1201"></a><span>   </span><a name="local-6989586621683032918"><a href="#local-6989586621683032918"><span class="hs-identifier">isHigherKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">splitPiTys</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span class="hs-identifier">check2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#QuantifiedType"><span class="hs-identifier hs-type">QuantifiedType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#QuantifiedType"><span class="hs-identifier hs-type">QuantifiedType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1204"></a><a name="check2"><a href="RtClosureInspect.html#check2"><span class="hs-identifier">check2</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032919"><a href="#local-6989586621683032919"><span class="hs-identifier">rtti_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032920"><a href="#local-6989586621683032920"><span class="hs-identifier">old_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1205"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032921"><a href="#local-6989586621683032921"><span class="hs-identifier">rttis</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032919"><span class="hs-identifier hs-var">rtti_ty</span></a><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1207"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683032922"><a href="#local-6989586621683032922"><span class="hs-identifier">olds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032920"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-1208"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">and</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="RtClosureInspect.html#check2"><span class="hs-identifier hs-var">check2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><a href="#local-6989586621683032921"><span class="hs-identifier hs-var">rttis</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier hs-var">quantifyType</span></a><span> </span><a href="#local-6989586621683032922"><span class="hs-identifier hs-var">olds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1209"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitAppTy_maybe</span><span> </span><a href="#local-6989586621683032920"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-1210"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#isMonomorphicOnNonPhantomArgs"><span class="hs-identifier hs-var">isMonomorphicOnNonPhantomArgs</span></a><span> </span><a href="#local-6989586621683032919"><span class="hs-identifier hs-var">rtti_ty</span></a><span>
</span><a name="line-1211"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1212"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1213"></a><span>
</span><a name="line-1214"></a><span class="hs-comment">-- Dealing with newtypes</span><span>
</span><a name="line-1215"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1216"></a><span class="hs-comment">{-
 congruenceNewtypes does a parallel fold over two Type values,
 compensating for missing newtypes on both sides.
 This is necessary because newtypes are not present
 in runtime, but sometimes there is evidence available.
   Evidence can come from DataCon signatures or
 from compile-time type inference.
 What we are doing here is an approximation
 of unification modulo a set of equations derived
 from newtype definitions. These equations should be the
 same as the equality coercions generated for newtypes
 in System Fc. The idea is to perform a sort of rewriting,
 taking those equations as rules, before launching unification.

 The caller must ensure the following.
 The 1st type (lhs) comes from the heap structure of ptrs,nptrs.
 The 2nd type (rhs) comes from a DataCon type signature.
 Rewriting (i.e. adding/removing a newtype wrapper) can happen
 in both types, but in the rhs it is restricted to the result type.

   Note that it is very tricky to make this 'rewriting'
 work with the unification implemented by TcM, where
 substitutions are operationally inlined. The order in which
 constraints are unified is vital as we cannot modify
 anything that has been touched by a previous unification step.
Therefore, congruenceNewtypes is sound only if the types
recovered by the RTTI mechanism are unified Top-Down.
-}</span><span>
</span><a name="line-1244"></a><span class="hs-identifier">congruenceNewtypes</span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-1245"></a><a name="congruenceNewtypes"><a href="RtClosureInspect.html#congruenceNewtypes"><span class="hs-identifier">congruenceNewtypes</span></a></a><span> </span><a name="local-6989586621683032923"><a href="#local-6989586621683032923"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621683032924"><a href="#local-6989586621683032924"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032925"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032923"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621683032924"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032944"><a href="#local-6989586621683032944"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683032923"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">,</span><a href="#local-6989586621683032944"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1246"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1247"></a><span>   </span><a name="local-6989586621683032925"><a href="#local-6989586621683032925"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683032926"><a href="#local-6989586621683032926"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683032927"><a href="#local-6989586621683032927"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-1248"></a><span> </span><span class="hs-comment">-- TyVar lhs inductive case</span><span>
</span><a name="line-1249"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032934"><a href="#local-6989586621683032934"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getTyVar_maybe</span><span> </span><a href="#local-6989586621683032926"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1250"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTcTyVar</span><span> </span><a href="#local-6989586621683032934"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1251"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isMetaTyVar</span><span> </span><a href="#local-6989586621683032934"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1252"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#recoverTR"><span class="hs-identifier hs-var">recoverTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032927"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1253"></a><span>         </span><span class="hs-identifier hs-var">Indirect</span><span> </span><a name="local-6989586621683032935"><a href="#local-6989586621683032935"><span class="hs-identifier">ty_v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-6989586621683032934"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1254"></a><span>         </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(congruence) Following indirect tyvar:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1255"></a><span>                          </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032934"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">equals</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032935"><span class="hs-identifier hs-var">ty_v</span></a><span class="hs-special">]</span><span>
</span><a name="line-1256"></a><span>         </span><a href="#local-6989586621683032925"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032935"><span class="hs-identifier hs-var">ty_v</span></a><span> </span><a href="#local-6989586621683032927"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1257"></a><span class="hs-comment">-- FunTy inductive case</span><span>
</span><a name="line-1258"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032936"><a href="#local-6989586621683032936"><span class="hs-identifier">l1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032937"><a href="#local-6989586621683032937"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621683032926"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1259"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032938"><a href="#local-6989586621683032938"><span class="hs-identifier">r1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032939"><a href="#local-6989586621683032939"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621683032927"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1260"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683032940"><a href="#local-6989586621683032940"><span class="hs-identifier">r2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032925"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032937"><span class="hs-identifier hs-var">l2</span></a><span> </span><a href="#local-6989586621683032939"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-1261"></a><span>         </span><a name="local-6989586621683032941"><a href="#local-6989586621683032941"><span class="hs-identifier">r1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683032925"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683032936"><span class="hs-identifier hs-var">l1</span></a><span> </span><a href="#local-6989586621683032938"><span class="hs-identifier hs-var">r1</span></a><span>
</span><a name="line-1262"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683032941"><span class="hs-identifier hs-var">r1'</span></a><span> </span><a href="#local-6989586621683032940"><span class="hs-identifier hs-var">r2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1263"></a><span class="hs-comment">-- TyconApp Inductive case; this is the interesting bit.</span><span>
</span><a name="line-1264"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032942"><a href="#local-6989586621683032942"><span class="hs-identifier">tycon_l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032923"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1265"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032943"><a href="#local-6989586621683032943"><span class="hs-identifier">tycon_r</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683032924"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1266"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032942"><span class="hs-identifier hs-var">tycon_l</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621683032943"><span class="hs-identifier hs-var">tycon_r</span></a><span>
</span><a name="line-1267"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032928"><span class="hs-identifier hs-var">upgrade</span></a><span> </span><a href="#local-6989586621683032942"><span class="hs-identifier hs-var">tycon_l</span></a><span> </span><a href="#local-6989586621683032927"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1268"></a><span>
</span><a name="line-1269"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032927"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1270"></a><span>
</span><a name="line-1271"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">upgrade</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#TR"><span class="hs-identifier hs-type">TR</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-1272"></a><span>          </span><a name="local-6989586621683032928"><a href="#local-6989586621683032928"><span class="hs-identifier">upgrade</span></a></a><span> </span><a name="local-6989586621683032929"><a href="#local-6989586621683032929"><span class="hs-identifier">new_tycon</span></a></a><span> </span><a name="local-6989586621683032930"><a href="#local-6989586621683032930"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1273"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><a href="#local-6989586621683032929"><span class="hs-identifier hs-var">new_tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1274"></a><span>              </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(Upgrade) Not matching newtype evidence: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1275"></a><span>                       </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032929"><span class="hs-identifier hs-var">new_tycon</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; for &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032930"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1276"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032930"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1277"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1278"></a><span>               </span><a href="RtClosureInspect.html#traceTR"><span class="hs-identifier hs-var">traceTR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(Upgrade) upgraded &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032930"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1279"></a><span>                        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; in presence of newtype evidence &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683032929"><span class="hs-identifier hs-var">new_tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1280"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032931"><a href="#local-6989586621683032931"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#instTyVars"><span class="hs-identifier hs-var">instTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683032929"><span class="hs-identifier hs-var">new_tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1281"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683032932"><a href="#local-6989586621683032932"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683032929"><span class="hs-identifier hs-var">new_tycon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683032931"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1282"></a><span>                   </span><a name="local-6989586621683032933"><a href="#local-6989586621683032933"><span class="hs-identifier">rep_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unwrapType</span><span> </span><a href="#local-6989586621683032932"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1283"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#liftTcM"><span class="hs-identifier hs-var">liftTcM</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683032930"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032933"><span class="hs-identifier hs-var">rep_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>        </span><span class="hs-comment">-- assumes that reptype doesn't ^^^^ touch tyconApp args</span><span>
</span><a name="line-1285"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032932"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1286"></a><span>
</span><a name="line-1287"></a><span>
</span><a name="line-1288"></a><span class="hs-identifier">zonkTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-type">Term</span></a><span>
</span><a name="line-1289"></a><a name="zonkTerm"><a href="RtClosureInspect.html#zonkTerm"><span class="hs-identifier">zonkTerm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#foldTermM"><span class="hs-identifier hs-var">foldTermM</span></a><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#TermFoldM"><span class="hs-identifier hs-var">TermFoldM</span></a><span>
</span><a name="line-1290"></a><span>             </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fTermM</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032945"><a href="#local-6989586621683032945"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032946"><a href="#local-6989586621683032946"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032947"><a href="#local-6989586621683032947"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683032948"><a href="#local-6989586621683032948"><span class="hs-identifier">tt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#zonkRttiType"><span class="hs-identifier hs-var">zonkRttiType</span></a><span> </span><a href="#local-6989586621683032945"><span class="hs-identifier hs-var">ty</span></a><span>    </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032949"><a href="#local-6989586621683032949"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1291"></a><span>                                       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Term"><span class="hs-identifier hs-var">Term</span></a><span> </span><a href="#local-6989586621683032949"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683032946"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032947"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621683032948"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fSuspensionM</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032950"><a href="#local-6989586621683032950"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621683032951"><a href="#local-6989586621683032951"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032952"><a href="#local-6989586621683032952"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683032953"><a href="#local-6989586621683032953"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#zonkRttiType"><span class="hs-identifier hs-var">zonkRttiType</span></a><span> </span><a href="#local-6989586621683032951"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032954"><a href="#local-6989586621683032954"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1293"></a><span>                                             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="RtClosureInspect.html#Suspension"><span class="hs-identifier hs-var">Suspension</span></a><span> </span><a href="#local-6989586621683032950"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621683032954"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683032952"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621683032953"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1294"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fNewtypeWrapM</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032955"><a href="#local-6989586621683032955"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032956"><a href="#local-6989586621683032956"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621683032957"><a href="#local-6989586621683032957"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#zonkRttiType"><span class="hs-identifier hs-var">zonkRttiType</span></a><span> </span><a href="#local-6989586621683032955"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032958"><a href="#local-6989586621683032958"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1295"></a><span>                                           </span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">$</span><span> </span><a href="RtClosureInspect.html#NewtypeWrap"><span class="hs-identifier hs-var">NewtypeWrap</span></a><span> </span><a href="#local-6989586621683032958"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683032956"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621683032957"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1296"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fRefWrapM</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683032959"><a href="#local-6989586621683032959"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683032960"><a href="#local-6989586621683032960"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="RtClosureInspect.html#RefWrap"><span class="hs-identifier hs-var">RefWrap</span></a><span>  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">ap</span><span class="hs-special">`</span><span>
</span><a name="line-1297"></a><span>                                        </span><a href="RtClosureInspect.html#zonkRttiType"><span class="hs-identifier hs-var">zonkRttiType</span></a><span> </span><a href="#local-6989586621683032959"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">ap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683032960"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1298"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fPrimM</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="RtClosureInspect.html#Prim"><span class="hs-identifier hs-var">Prim</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span>
</span><a name="line-1300"></a><span class="hs-identifier">zonkRttiType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-1301"></a><span class="hs-comment">-- Zonk the type, replacing any unbound Meta tyvars</span><span>
</span><a name="line-1302"></a><span class="hs-comment">-- by RuntimeUnk skolems, safely out of Meta-tyvar-land</span><span>
</span><a name="line-1303"></a><a name="zonkRttiType"><a href="RtClosureInspect.html#zonkRttiType"><span class="hs-identifier">zonkRttiType</span></a></a><span> </span><a name="local-6989586621683032961"><a href="#local-6989586621683032961"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683032962"><a href="#local-6989586621683032962"><span class="hs-identifier">ze</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#mkEmptyZonkEnv"><span class="hs-identifier hs-var">mkEmptyZonkEnv</span></a><span> </span><a href="TcHsSyn.html#RuntimeUnkFlexi"><span class="hs-identifier hs-var">RuntimeUnkFlexi</span></a><span>
</span><a name="line-1304"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypeX"><span class="hs-identifier hs-var">zonkTcTypeToTypeX</span></a><span> </span><a href="#local-6989586621683032962"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621683032961"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-1307"></a><span class="hs-comment">-- Restore Class predicates out of a representation type</span><span>
</span><a name="line-1308"></a><span class="hs-identifier">dictsView</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-1309"></a><a name="dictsView"><a href="RtClosureInspect.html#dictsView"><span class="hs-identifier">dictsView</span></a></a><span> </span><a name="local-6989586621683032963"><a href="#local-6989586621683032963"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032963"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1310"></a><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span class="hs-comment">-- Use only for RTTI types</span><span>
</span><a name="line-1313"></a><span class="hs-identifier">isMonomorphic</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1314"></a><a name="isMonomorphic"><a href="RtClosureInspect.html#isMonomorphic"><span class="hs-identifier">isMonomorphic</span></a></a><span> </span><a name="local-6989586621683032964"><a href="#local-6989586621683032964"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683032967"><span class="hs-identifier hs-var">noExistentials</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683032968"><span class="hs-identifier hs-var">noUniversals</span></a><span>
</span><a name="line-1315"></a><span> </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032965"><a href="#local-6989586621683032965"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032966"><a href="#local-6989586621683032966"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621683032964"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1316"></a><span>       </span><a name="local-6989586621683032967"><a href="#local-6989586621683032967"><span class="hs-identifier">noExistentials</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noFreeVarsOfType</span><span> </span><a href="#local-6989586621683032966"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1317"></a><span>       </span><a name="local-6989586621683032968"><a href="#local-6989586621683032968"><span class="hs-identifier">noUniversals</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683032965"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1318"></a><span>
</span><a name="line-1319"></a><span class="hs-comment">-- Use only for RTTI types</span><span>
</span><a name="line-1320"></a><span class="hs-identifier">isMonomorphicOnNonPhantomArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RtClosureInspect.html#RttiType"><span class="hs-identifier hs-type">RttiType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1321"></a><a name="isMonomorphicOnNonPhantomArgs"><a href="RtClosureInspect.html#isMonomorphicOnNonPhantomArgs"><span class="hs-identifier">isMonomorphicOnNonPhantomArgs</span></a></a><span> </span><a name="local-6989586621683032969"><a href="#local-6989586621683032969"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1322"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032970"><a href="#local-6989586621683032970"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032971"><a href="#local-6989586621683032971"><span class="hs-identifier">all_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unwrapType</span><span> </span><a href="#local-6989586621683032969"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1323"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032972"><a href="#local-6989586621683032972"><span class="hs-identifier">phantom_vars</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RtClosureInspect.html#tyConPhantomTyVars"><span class="hs-identifier hs-var">tyConPhantomTyVars</span></a><span> </span><a href="#local-6989586621683032970"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1324"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032975"><a href="#local-6989586621683032975"><span class="hs-identifier">concrete_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683032974"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032973"><a href="#local-6989586621683032973"><span class="hs-identifier">tyv</span></a></a><span class="hs-special">,</span><a name="local-6989586621683032974"><a href="#local-6989586621683032974"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683032970"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032971"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-1325"></a><span>                           </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032973"><span class="hs-identifier hs-var">tyv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683032972"><span class="hs-identifier hs-var">phantom_vars</span></a><span class="hs-special">]</span><span>
</span><a name="line-1326"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="RtClosureInspect.html#isMonomorphicOnNonPhantomArgs"><span class="hs-identifier hs-var">isMonomorphicOnNonPhantomArgs</span></a><span> </span><a href="#local-6989586621683032975"><span class="hs-identifier hs-var">concrete_args</span></a><span>
</span><a name="line-1327"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683032976"><a href="#local-6989586621683032976"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032977"><a href="#local-6989586621683032977"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621683032969"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1328"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="RtClosureInspect.html#isMonomorphicOnNonPhantomArgs"><span class="hs-identifier hs-var">isMonomorphicOnNonPhantomArgs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683032976"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><a href="#local-6989586621683032977"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">]</span><span>
</span><a name="line-1329"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RtClosureInspect.html#isMonomorphic"><span class="hs-identifier hs-var">isMonomorphic</span></a><span> </span><a href="#local-6989586621683032969"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span class="hs-identifier">tyConPhantomTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>
</span><a name="line-1332"></a><a name="tyConPhantomTyVars"><a href="RtClosureInspect.html#tyConPhantomTyVars"><span class="hs-identifier">tyConPhantomTyVars</span></a></a><span> </span><a name="local-6989586621683032978"><a href="#local-6989586621683032978"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-1333"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683032978"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1334"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683032979"><a href="#local-6989586621683032979"><span class="hs-identifier">dcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConDataCons_maybe</span><span> </span><a href="#local-6989586621683032978"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1335"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683032980"><a href="#local-6989586621683032980"><span class="hs-identifier">dc_vars</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">dataConUnivTyVars</span><span> </span><a href="#local-6989586621683032979"><span class="hs-identifier hs-var">dcs</span></a><span>
</span><a name="line-1336"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683032978"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-6989586621683032980"><span class="hs-identifier hs-var">dc_vars</span></a><span>
</span><a name="line-1337"></a><span class="hs-identifier">tyConPhantomTyVars</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1338"></a><span>
</span><a name="line-1339"></a><span class="hs-keyword">type</span><span> </span><a name="QuantifiedType"><a href="RtClosureInspect.html#QuantifiedType"><span class="hs-identifier">QuantifiedType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>   </span><span class="hs-comment">-- Make the free type variables explicit</span><span>
</span><a name="line-1341"></a><span>   </span><span class="hs-comment">-- The returned Type should have no top-level foralls (I believe)</span><span>
</span><a name="line-1342"></a><span>
</span><a name="line-1343"></a><span class="hs-identifier">quantifyType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RtClosureInspect.html#QuantifiedType"><span class="hs-identifier hs-type">QuantifiedType</span></a><span>
</span><a name="line-1344"></a><span class="hs-comment">-- Generalize the type: find all free and forall'd tyvars</span><span>
</span><a name="line-1345"></a><span class="hs-comment">-- and return them, together with the type inside, which</span><span>
</span><a name="line-1346"></a><span class="hs-comment">-- should not be a forall type.</span><span>
</span><a name="line-1347"></a><span class="hs-comment">--</span><span>
</span><a name="line-1348"></a><span class="hs-comment">-- Thus (quantifyType (forall a. a-&gt;[b]))</span><span>
</span><a name="line-1349"></a><span class="hs-comment">-- returns ([a,b], a -&gt; [b])</span><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><a name="quantifyType"><a href="RtClosureInspect.html#quantifyType"><span class="hs-identifier">quantifyType</span></a></a><span> </span><a name="local-6989586621683032981"><a href="#local-6989586621683032981"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1352"></a><span>                    </span><span class="hs-identifier hs-var">tyCoVarsOfTypeWellScoped</span><span> </span><a href="#local-6989586621683032983"><span class="hs-identifier hs-var">rho</span></a><span>
</span><a name="line-1353"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683032983"><span class="hs-identifier hs-var">rho</span></a><span class="hs-special">)</span><span>
</span><a name="line-1354"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1355"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683032982"><a href="#local-6989586621683032982"><span class="hs-identifier">_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683032983"><a href="#local-6989586621683032983"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitForAllTys</span><span> </span><a href="#local-6989586621683032981"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1356"></a></pre></body></html>