<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- | Provides the heuristics for when it's beneficial to lambda lift bindings.</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Most significantly, this employs a cost model to estimate impact on heap</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- allocations, by looking at an STG expression's 'Skeleton'.</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgLiftLams.Analysis</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-9"></a><span>    </span><span class="hs-comment">-- * #when# When to lift</span><span>
</span><a name="line-10"></a><span>    </span><span class="hs-comment">-- $when</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>    </span><span class="hs-comment">-- * #clogro# Estimating closure growth</span><span>
</span><a name="line-13"></a><span>    </span><span class="hs-comment">-- $clogro</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-comment">-- * AST annotation</span><span>
</span><a name="line-16"></a><span>    </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><a href="StgSyn.html#LlStgBinding"><span class="hs-identifier hs-type">LlStgBinding</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgExpr"><span class="hs-identifier hs-type">LlStgExpr</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgRhs"><span class="hs-identifier hs-type">LlStgRhs</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgAlt"><span class="hs-identifier hs-type">LlStgAlt</span></a><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonTopBind"><span class="hs-identifier hs-var">tagSkeletonTopBind</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><span class="hs-comment">-- * Lifting decision</span><span>
</span><a name="line-19"></a><span>    </span><a href="StgLiftLams.Analysis.html#goodToLift"><span class="hs-identifier hs-var">goodToLift</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><a href="StgLiftLams.Analysis.html#closureGrowth"><span class="hs-identifier hs-var">closureGrowth</span></a><span> </span><span class="hs-comment">-- Exported just for the docs</span><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Demand</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="StgCmmArgRep.html"><span class="hs-identifier">StgCmmArgRep</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">-- Note [When to lift]</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- $when</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- The analysis proceeds in two steps:</span><span>
</span><a name="line-44"></a><span class="hs-comment">--</span><span>
</span><a name="line-45"></a><span class="hs-comment">--   1. It tags the syntax tree with analysis information in the form of</span><span>
</span><a name="line-46"></a><span class="hs-comment">--      'BinderInfo' at each binder and 'Skeleton's at each let-binding</span><span>
</span><a name="line-47"></a><span class="hs-comment">--      by 'tagSkeletonTopBind' and friends.</span><span>
</span><a name="line-48"></a><span class="hs-comment">--   2. The resulting syntax tree is treated by the &quot;StgLiftLams.Transformation&quot;</span><span>
</span><a name="line-49"></a><span class="hs-comment">--      module, calling out to 'goodToLift' to decide if a binding is worthwhile</span><span>
</span><a name="line-50"></a><span class="hs-comment">--      to lift.</span><span>
</span><a name="line-51"></a><span class="hs-comment">--      'goodToLift' consults argument occurrence information in 'BinderInfo'</span><span>
</span><a name="line-52"></a><span class="hs-comment">--      and estimates 'closureGrowth', for which it needs the 'Skeleton'.</span><span>
</span><a name="line-53"></a><span class="hs-comment">--</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- So the annotations from 'tagSkeletonTopBind' ultimately fuel 'goodToLift',</span><span>
</span><a name="line-55"></a><span class="hs-comment">-- which employs a number of heuristics to identify and exclude lambda lifting</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- opportunities deemed non-beneficial:</span><span>
</span><a name="line-57"></a><span class="hs-comment">--</span><span>
</span><a name="line-58"></a><span class="hs-comment">--  [Top-level bindings] can't be lifted.</span><span>
</span><a name="line-59"></a><span class="hs-comment">--  [Thunks] and data constructors shouldn't be lifted in order not to destroy</span><span>
</span><a name="line-60"></a><span class="hs-comment">--    sharing.</span><span>
</span><a name="line-61"></a><span class="hs-comment">--  [Argument occurrences] #arg_occs# of binders prohibit them to be lifted.</span><span>
</span><a name="line-62"></a><span class="hs-comment">--    Doing the lift would re-introduce the very allocation at call sites that</span><span>
</span><a name="line-63"></a><span class="hs-comment">--    we tried to get rid off in the first place. We capture analysis</span><span>
</span><a name="line-64"></a><span class="hs-comment">--    information in 'BinderInfo'. Note that we also consider a nullary</span><span>
</span><a name="line-65"></a><span class="hs-comment">--    application as argument occurrence, because it would turn into an n-ary</span><span>
</span><a name="line-66"></a><span class="hs-comment">--    partial application created by a generic apply function. This occurs in</span><span>
</span><a name="line-67"></a><span class="hs-comment">--    CPS-heavy code like the CS benchmark.</span><span>
</span><a name="line-68"></a><span class="hs-comment">--  [Join points] should not be lifted, simply because there's no reduction in</span><span>
</span><a name="line-69"></a><span class="hs-comment">--    allocation to be had.</span><span>
</span><a name="line-70"></a><span class="hs-comment">--  [Abstracting over join points] destroys join points, because they end up as</span><span>
</span><a name="line-71"></a><span class="hs-comment">--    arguments to the lifted function.</span><span>
</span><a name="line-72"></a><span class="hs-comment">--  [Abstracting over known local functions] turns a known call into an unknown</span><span>
</span><a name="line-73"></a><span class="hs-comment">--    call (e.g. some @stg_ap_*@), which is generally slower. Can be turned off</span><span>
</span><a name="line-74"></a><span class="hs-comment">--    with @-fstg-lift-lams-known@.</span><span>
</span><a name="line-75"></a><span class="hs-comment">--  [Calling convention] Don't lift when the resulting function would have a</span><span>
</span><a name="line-76"></a><span class="hs-comment">--    higher arity than available argument registers for the calling convention.</span><span>
</span><a name="line-77"></a><span class="hs-comment">--    Can be influenced with @-fstg-lift-(non)rec-args(-any)@.</span><span>
</span><a name="line-78"></a><span class="hs-comment">--  [Closure growth] introduced when former free variables have to be available</span><span>
</span><a name="line-79"></a><span class="hs-comment">--    at call sites may actually lead to an increase in overall allocations</span><span>
</span><a name="line-80"></a><span class="hs-comment">--  resulting from a lift. Estimating closure growth is described in</span><span>
</span><a name="line-81"></a><span class="hs-comment">--  &quot;StgLiftLams.Analysis#clogro&quot; and is what most of this module is ultimately</span><span>
</span><a name="line-82"></a><span class="hs-comment">--  concerned with.</span><span>
</span><a name="line-83"></a><span class="hs-comment">--</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- There's a &lt;https://ghc.haskell.org/trac/ghc/wiki/LateLamLift wiki page&gt; with</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- some more background and history.</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- Note [Estimating closure growth]</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- $clogro</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- We estimate closure growth by abstracting the syntax tree into a 'Skeleton',</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- capturing only syntactic details relevant to 'closureGrowth', such as</span><span>
</span><a name="line-92"></a><span class="hs-comment">--</span><span>
</span><a name="line-93"></a><span class="hs-comment">--   * 'ClosureSk', representing closure allocation.</span><span>
</span><a name="line-94"></a><span class="hs-comment">--   * 'RhsSk', representing a RHS of a binding and how many times it's called</span><span>
</span><a name="line-95"></a><span class="hs-comment">--     by an appropriate 'DmdShell'.</span><span>
</span><a name="line-96"></a><span class="hs-comment">--   * 'AltSk', 'BothSk' and 'NilSk' for choice, sequence and empty element.</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- This abstraction is mostly so that the main analysis function 'closureGrowth'</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- can stay simple and focused. Also, skeletons tend to be much smaller than</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- the syntax tree they abstract, so it makes sense to construct them once and</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- and operate on them instead of the actual syntax tree.</span><span>
</span><a name="line-102"></a><span class="hs-comment">--</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- A more detailed treatment of computing closure growth, including examples,</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- can be found in the paper referenced from the</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- &lt;https://ghc.haskell.org/trac/ghc/wiki/LateLamLift wiki page&gt;.</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-identifier">llTrace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680919566"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680919566"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-108"></a><a name="llTrace"><a href="StgLiftLams.Analysis.html#llTrace"><span class="hs-identifier">llTrace</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919567"><a href="#local-6989586621680919567"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919567"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-109"></a><span class="hs-comment">-- llTrace a b c = pprTrace a b c</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="StgSyn.html#BinderP"><span class="hs-identifier hs-type">BinderP</span></a><span>      </span><span class="hs-special">'</span><a href="StgSyn.html#LiftLams"><span class="hs-identifier hs-type">LiftLams</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span>
</span><a name="line-112"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="StgSyn.html#XRhsClosure"><span class="hs-identifier hs-type">XRhsClosure</span></a><span>  </span><span class="hs-special">'</span><a href="StgSyn.html#LiftLams"><span class="hs-identifier hs-type">LiftLams</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span>
</span><a name="line-113"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="StgSyn.html#XLet"><span class="hs-identifier hs-type">XLet</span></a><span>         </span><span class="hs-special">'</span><a href="StgSyn.html#LiftLams"><span class="hs-identifier hs-type">LiftLams</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-114"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><a href="StgSyn.html#XLetNoEscape"><span class="hs-identifier hs-type">XLetNoEscape</span></a><span> </span><span class="hs-special">'</span><a href="StgSyn.html#LiftLams"><span class="hs-identifier hs-type">LiftLams</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-identifier">freeVarsOfRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">XRhsClosure</span><span> </span><a href="#local-6989586621680919565"><span class="hs-identifier hs-type">pass</span></a><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="StgSyn.html#GenStgRhs"><span class="hs-identifier hs-type">GenStgRhs</span></a><span> </span><a href="#local-6989586621680919565"><span class="hs-identifier hs-type">pass</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span>
</span><a name="line-117"></a><a name="freeVarsOfRhs"><a href="StgLiftLams.Analysis.html#freeVarsOfRhs"><span class="hs-identifier">freeVarsOfRhs</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919568"><a href="#local-6989586621680919568"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkDVarSet</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680919569"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621680919569"><a href="#local-6989586621680919569"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680919568"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-118"></a><span class="hs-identifier">freeVarsOfRhs</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621680919570"><a href="#local-6989586621680919570"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919570"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- | Captures details of the syntax tree relevant to the cost model, such as</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- closures, multi-shot lambdas and case expressions.</span><span>
</span><a name="line-122"></a><span class="hs-keyword">data</span><span> </span><a name="Skeleton"><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier">Skeleton</span></a></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ClosureSk"><a href="StgLiftLams.Analysis.html#ClosureSk"><span class="hs-identifier">ClosureSk</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DIdSet</span><span> </span><span class="hs-comment">{- ^ free vars -}</span><span> </span><span class="hs-glyph">!</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="RhsSk"><a href="StgLiftLams.Analysis.html#RhsSk"><span class="hs-identifier">RhsSk</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">DmdShell</span><span> </span><span class="hs-comment">{- ^ how often the RHS was entered -}</span><span> </span><span class="hs-glyph">!</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AltSk"><a href="StgLiftLams.Analysis.html#AltSk"><span class="hs-identifier">AltSk</span></a></a><span> </span><span class="hs-glyph">!</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">!</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="BothSk"><a href="StgLiftLams.Analysis.html#BothSk"><span class="hs-identifier">BothSk</span></a></a><span> </span><span class="hs-glyph">!</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">!</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-127"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NilSk"><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier">NilSk</span></a></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-identifier">bothSk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-130"></a><a name="bothSk"><a href="StgLiftLams.Analysis.html#bothSk"><span class="hs-identifier">bothSk</span></a></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><a name="local-6989586621680919571"><a href="#local-6989586621680919571"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919571"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-131"></a><span class="hs-identifier">bothSk</span><span> </span><a name="local-6989586621680919572"><a href="#local-6989586621680919572"><span class="hs-identifier">a</span></a></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919572"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-132"></a><span class="hs-identifier">bothSk</span><span> </span><a name="local-6989586621680919573"><a href="#local-6989586621680919573"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680919574"><a href="#local-6989586621680919574"><span class="hs-identifier">b</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#BothSk"><span class="hs-identifier hs-var">BothSk</span></a><span> </span><a href="#local-6989586621680919573"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680919574"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">altSk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-135"></a><a name="altSk"><a href="StgLiftLams.Analysis.html#altSk"><span class="hs-identifier">altSk</span></a></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><a name="local-6989586621680919575"><a href="#local-6989586621680919575"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919575"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-136"></a><span class="hs-identifier">altSk</span><span> </span><a name="local-6989586621680919576"><a href="#local-6989586621680919576"><span class="hs-identifier">a</span></a></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919576"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-137"></a><span class="hs-identifier">altSk</span><span> </span><a name="local-6989586621680919577"><a href="#local-6989586621680919577"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680919578"><a href="#local-6989586621680919578"><span class="hs-identifier">b</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#AltSk"><span class="hs-identifier hs-var">AltSk</span></a><span> </span><a href="#local-6989586621680919577"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680919578"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-identifier">rhsSk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DmdShell</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-140"></a><a name="rhsSk"><a href="StgLiftLams.Analysis.html#rhsSk"><span class="hs-identifier">rhsSk</span></a></a><span> </span><span class="hs-identifier">_</span><span>        </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span>
</span><a name="line-141"></a><span class="hs-identifier">rhsSk</span><span> </span><a name="local-6989586621680919579"><a href="#local-6989586621680919579"><span class="hs-identifier">body_dmd</span></a></a><span> </span><a name="local-6989586621680919580"><a href="#local-6989586621680919580"><span class="hs-identifier">skel</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#RhsSk"><span class="hs-identifier hs-var">RhsSk</span></a><span> </span><a href="#local-6989586621680919579"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><a href="#local-6989586621680919580"><span class="hs-identifier hs-var">skel</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | The type used in binder positions in 'GenStgExpr's.</span><span>
</span><a name="line-144"></a><span class="hs-keyword">data</span><span> </span><a name="BinderInfo"><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier">BinderInfo</span></a></a><span>
</span><a name="line-145"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="BindsClosure"><a href="StgLiftLams.Analysis.html#BindsClosure"><span class="hs-identifier">BindsClosure</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ Let(-no-escape)-bound thing with a flag</span><span>
</span><a name="line-146"></a><span>                           </span><span class="hs-comment">--   indicating whether it occurs as an argument</span><span>
</span><a name="line-147"></a><span>                           </span><span class="hs-comment">--   or in a nullary application</span><span>
</span><a name="line-148"></a><span>                           </span><span class="hs-comment">--   (see &quot;StgLiftLams.Analysis#arg_occs&quot;).</span><span>
</span><a name="line-149"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="BoringBinder"><a href="StgLiftLams.Analysis.html#BoringBinder"><span class="hs-identifier">BoringBinder</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Id</span><span>       </span><span class="hs-comment">-- ^ Every other kind of binder</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- | Gets the bound 'Id' out a 'BinderInfo'.</span><span>
</span><a name="line-152"></a><span class="hs-identifier">binderInfoBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-153"></a><a name="binderInfoBndr"><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier">binderInfoBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BoringBinder"><span class="hs-identifier hs-var">BoringBinder</span></a><span> </span><a name="local-6989586621680919581"><a href="#local-6989586621680919581"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919581"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-154"></a><span class="hs-identifier">binderInfoBndr</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BindsClosure"><span class="hs-identifier hs-var">BindsClosure</span></a><span> </span><a name="local-6989586621680919582"><a href="#local-6989586621680919582"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919582"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- | Returns 'Nothing' for 'BoringBinder's and 'Just' the flag indicating</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- occurrences as argument or in a nullary applications otherwise.</span><span>
</span><a name="line-158"></a><span class="hs-identifier">binderInfoOccursAsArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-159"></a><a name="binderInfoOccursAsArg"><a href="StgLiftLams.Analysis.html#binderInfoOccursAsArg"><span class="hs-identifier">binderInfoOccursAsArg</span></a></a><span> </span><a href="StgLiftLams.Analysis.html#BoringBinder"><span class="hs-identifier hs-var">BoringBinder</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-160"></a><span class="hs-identifier">binderInfoOccursAsArg</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BindsClosure"><span class="hs-identifier hs-var">BindsClosure</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919583"><a href="#local-6989586621680919583"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680919583"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-163"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#AltSk"><span class="hs-identifier hs-var">AltSk</span></a><span> </span><a name="local-6989586621680919554"><a href="#local-6989586621680919554"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680919555"><a href="#local-6989586621680919555"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;{ &quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919554"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-166"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ALT&quot;</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  &quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919555"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-168"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;}&quot;</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BothSk"><span class="hs-identifier hs-var">BothSk</span></a><span> </span><a name="local-6989586621680919556"><a href="#local-6989586621680919556"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680919557"><a href="#local-6989586621680919557"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919556"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919557"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-171"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#ClosureSk"><span class="hs-identifier hs-var">ClosureSk</span></a><span> </span><a name="local-6989586621680919558"><a href="#local-6989586621680919558"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680919559"><a href="#local-6989586621680919559"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621680919560"><a href="#local-6989586621680919560"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919558"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919559"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919560"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#RhsSk"><span class="hs-identifier hs-var">RhsSk</span></a><span> </span><a name="local-6989586621680919561"><a href="#local-6989586621680919561"><span class="hs-identifier">body_dmd</span></a></a><span> </span><a name="local-6989586621680919562"><a href="#local-6989586621680919562"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hcat</span><span>
</span><a name="line-173"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&#955;[&quot;</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919563"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-175"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, &quot;</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919564"><span class="hs-identifier hs-var">use</span></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;]. &quot;</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919562"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-179"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-181"></a><span>      </span><a name="local-6989586621680919563"><a href="#local-6989586621680919563"><span class="hs-identifier">str</span></a></a><span>
</span><a name="line-182"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><a href="#local-6989586621680919561"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'1'</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'0'</span><span>
</span><a name="line-184"></a><span>      </span><a name="local-6989586621680919564"><a href="#local-6989586621680919564"><span class="hs-identifier">use</span></a></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAbsDmd</span><span> </span><a href="#local-6989586621680919561"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'0'</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUsedOnce</span><span> </span><a href="#local-6989586621680919561"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'1'</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'&#969;'</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-190"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">OutputableBndr</span><span> </span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-193"></a><span>  </span><a name="local-8214565720323806227"><span class="hs-identifier">pprBndr</span></a><span> </span><a name="local-6989586621680919553"><a href="#local-6989586621680919553"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprBndr</span><span> </span><a href="#local-6989586621680919553"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span>
</span><a name="line-194"></a><span>  </span><a name="local-8214565720323806226"><span class="hs-identifier">pprPrefixOcc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPrefixOcc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span>
</span><a name="line-195"></a><span>  </span><a name="local-8214565720323806225"><span class="hs-identifier">pprInfixOcc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprInfixOcc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span>
</span><a name="line-196"></a><span>  </span><a name="local-8214565720323806224"><span class="hs-identifier">bndrIsJoin_maybe</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bndrIsJoin_maybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">mkArgOccs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span>
</span><a name="line-199"></a><a name="mkArgOccs"><a href="StgLiftLams.Analysis.html#mkArgOccs"><span class="hs-identifier">mkArgOccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621680919584"><span class="hs-identifier hs-var">stg_arg_var</span></a><span>
</span><a name="line-200"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-201"></a><span>    </span><a name="local-6989586621680919584"><a href="#local-6989586621680919584"><span class="hs-identifier">stg_arg_var</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621680919585"><a href="#local-6989586621680919585"><span class="hs-identifier">occ</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680919585"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-202"></a><span>    </span><span class="hs-identifier">stg_arg_var</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- | Tags every binder with its 'BinderInfo' and let bindings with their</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- 'Skeleton's.</span><span>
</span><a name="line-206"></a><span class="hs-identifier">tagSkeletonTopBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgBinding"><span class="hs-identifier hs-type">CgStgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#LlStgBinding"><span class="hs-identifier hs-type">LlStgBinding</span></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- NilSk is OK when tagging top-level bindings. Also, top-level things are never</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- lambda-lifted, so no need to track their argument occurrences. They can also</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- never be let-no-escapes (thus we pass False).</span><span>
</span><a name="line-210"></a><a name="tagSkeletonTopBind"><a href="StgLiftLams.Analysis.html#tagSkeletonTopBind"><span class="hs-identifier">tagSkeletonTopBind</span></a></a><span> </span><a name="local-6989586621680919586"><a href="#local-6989586621680919586"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919587"><span class="hs-identifier hs-var">bind'</span></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680919587"><a href="#local-6989586621680919587"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonBinding"><span class="hs-identifier hs-var">tagSkeletonBinding</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621680919586"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Tags binders of an 'StgExpr' with its 'BinderInfo' and let bindings with</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- their 'Skeleton's. Additionally, returns its 'Skeleton' and the set of binder</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- occurrences in argument and nullary application position</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- (cf. &quot;StgLiftLams.Analysis#arg_occs&quot;).</span><span>
</span><a name="line-218"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgExpr"><span class="hs-identifier hs-type">LlStgExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><a name="tagSkeletonExpr"><a href="StgLiftLams.Analysis.html#tagSkeletonExpr"><span class="hs-identifier">tagSkeletonExpr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a name="local-6989586621680919588"><a href="#local-6989586621680919588"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a href="#local-6989586621680919588"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a name="local-6989586621680919589"><a href="#local-6989586621680919589"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621680919590"><a href="#local-6989586621680919590"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680919591"><a href="#local-6989586621680919591"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#mkArgOccs"><span class="hs-identifier hs-var">mkArgOccs</span></a><span> </span><a href="#local-6989586621680919590"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a href="#local-6989586621680919589"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680919590"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680919591"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a name="local-6989586621680919592"><a href="#local-6989586621680919592"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621680919593"><a href="#local-6989586621680919593"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680919594"><a href="#local-6989586621680919594"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#mkArgOccs"><span class="hs-identifier hs-var">mkArgOccs</span></a><span> </span><a href="#local-6989586621680919593"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a href="#local-6989586621680919592"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621680919593"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680919594"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621680919595"><a href="#local-6989586621680919595"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680919596"><a href="#local-6989586621680919596"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919597"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621680919595"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680919596"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621680919597"><a href="#local-6989586621680919597"><span class="hs-identifier">arg_occs</span></a></a><span>
</span><a name="line-229"></a><span>      </span><span class="hs-comment">-- This checks for nullary applications, which we treat the same as</span><span>
</span><a name="line-230"></a><span>      </span><span class="hs-comment">-- argument occurrences, see &quot;StgLiftLams.Analysis#arg_occs&quot;.</span><span>
</span><a name="line-231"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680919596"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitVarSet</span><span> </span><a href="#local-6989586621680919595"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-232"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#mkArgOccs"><span class="hs-identifier hs-var">mkArgOccs</span></a><span> </span><a href="#local-6989586621680919596"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-233"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLam"><span class="hs-identifier hs-var">StgLam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;stgLiftLams&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StgLam&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a name="local-6989586621680919598"><a href="#local-6989586621680919598"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680919599"><a href="#local-6989586621680919599"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680919600"><a href="#local-6989586621680919600"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680919601"><a href="#local-6989586621680919601"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919608"><span class="hs-identifier hs-var">skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919609"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a href="#local-6989586621680919604"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621680919610"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621680919600"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680919607"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919602"><a href="#local-6989586621680919602"><span class="hs-identifier">scrut_skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919603"><a href="#local-6989586621680919603"><span class="hs-identifier">scrut_arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919604"><a href="#local-6989586621680919604"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonExpr"><span class="hs-identifier hs-var">tagSkeletonExpr</span></a><span> </span><a href="#local-6989586621680919598"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-238"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919605"><a href="#local-6989586621680919605"><span class="hs-identifier">alt_skels</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919606"><a href="#local-6989586621680919606"><span class="hs-identifier">alt_arg_occss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919607"><a href="#local-6989586621680919607"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAndUnzip3</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonAlt"><span class="hs-identifier hs-var">tagSkeletonAlt</span></a><span> </span><a href="#local-6989586621680919601"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621680919608"><a href="#local-6989586621680919608"><span class="hs-identifier">skel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#bothSk"><span class="hs-identifier hs-var">bothSk</span></a><span> </span><a href="#local-6989586621680919602"><span class="hs-identifier hs-var">scrut_skel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="StgLiftLams.Analysis.html#altSk"><span class="hs-identifier hs-var">altSk</span></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><a href="#local-6989586621680919605"><span class="hs-identifier hs-var">alt_skels</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>    </span><a name="local-6989586621680919609"><a href="#local-6989586621680919609"><span class="hs-identifier">arg_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionVarSets</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919603"><span class="hs-identifier hs-var">scrut_arg_occs</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680919606"><span class="hs-identifier hs-var">alt_arg_occss</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">delVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919599"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-241"></a><span>    </span><a name="local-6989586621680919610"><a href="#local-6989586621680919610"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#BoringBinder"><span class="hs-identifier hs-var">BoringBinder</span></a><span> </span><a href="#local-6989586621680919599"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-242"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a name="local-6989586621680919611"><a href="#local-6989586621680919611"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680919612"><a href="#local-6989586621680919612"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919613"><span class="hs-identifier hs-var">skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919614"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a href="#local-6989586621680919611"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680919615"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-245"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919613"><a href="#local-6989586621680919613"><span class="hs-identifier">skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919614"><a href="#local-6989586621680919614"><span class="hs-identifier">arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919615"><a href="#local-6989586621680919615"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonExpr"><span class="hs-identifier hs-var">tagSkeletonExpr</span></a><span> </span><a href="#local-6989586621680919612"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-246"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919616"><a href="#local-6989586621680919616"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621680919617"><a href="#local-6989586621680919617"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonLet"><span class="hs-identifier hs-var">tagSkeletonLet</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680919617"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621680919616"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-247"></a><span class="hs-identifier">tagSkeletonExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919618"><a href="#local-6989586621680919618"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621680919619"><a href="#local-6989586621680919619"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonLet"><span class="hs-identifier hs-var">tagSkeletonLet</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680919619"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621680919618"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-identifier">mkLet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#LlStgBinding"><span class="hs-identifier hs-type">LlStgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#LlStgExpr"><span class="hs-identifier hs-type">LlStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#LlStgExpr"><span class="hs-identifier hs-type">LlStgExpr</span></a><span>
</span><a name="line-250"></a><a name="mkLet"><a href="StgLiftLams.Analysis.html#mkLet"><span class="hs-identifier">mkLet</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span>
</span><a name="line-251"></a><span class="hs-identifier">mkLet</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span class="hs-identifier">tagSkeletonLet</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-255"></a><span>  </span><span class="hs-comment">-- ^ Is the binding a let-no-escape?</span><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span>
</span><a name="line-257"></a><span>  </span><span class="hs-comment">-- ^ Let body</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgBinding"><span class="hs-identifier hs-type">CgStgBinding</span></a><span>
</span><a name="line-259"></a><span>  </span><span class="hs-comment">-- ^ Binding group</span><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgExpr"><span class="hs-identifier hs-type">LlStgExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-comment">-- ^ RHS skeletons, argument occurrences and annotated binding</span><span>
</span><a name="line-262"></a><a name="tagSkeletonLet"><a href="StgLiftLams.Analysis.html#tagSkeletonLet"><span class="hs-identifier">tagSkeletonLet</span></a></a><span> </span><a name="local-6989586621680919620"><a href="#local-6989586621680919620"><span class="hs-identifier">is_lne</span></a></a><span> </span><a name="local-6989586621680919621"><a href="#local-6989586621680919621"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621680919622"><a href="#local-6989586621680919622"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919626"><span class="hs-identifier hs-var">let_skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919627"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a><span> </span><a href="#local-6989586621680919620"><span class="hs-identifier hs-var">is_lne</span></a><span> </span><a href="#local-6989586621680919628"><span class="hs-identifier hs-var">scope</span></a><span> </span><a href="#local-6989586621680919629"><span class="hs-identifier hs-var">bind'</span></a><span> </span><a href="#local-6989586621680919625"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919623"><a href="#local-6989586621680919623"><span class="hs-identifier">body_skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919624"><a href="#local-6989586621680919624"><span class="hs-identifier">body_arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919625"><a href="#local-6989586621680919625"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonExpr"><span class="hs-identifier hs-var">tagSkeletonExpr</span></a><span> </span><a href="#local-6989586621680919621"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-266"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919626"><a href="#local-6989586621680919626"><span class="hs-identifier">let_skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919627"><a href="#local-6989586621680919627"><span class="hs-identifier">arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919628"><a href="#local-6989586621680919628"><span class="hs-identifier">scope</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919629"><a href="#local-6989586621680919629"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonBinding"><span class="hs-identifier hs-var">tagSkeletonBinding</span></a><span> </span><a href="#local-6989586621680919620"><span class="hs-identifier hs-var">is_lne</span></a><span> </span><a href="#local-6989586621680919623"><span class="hs-identifier hs-var">body_skel</span></a><span> </span><a href="#local-6989586621680919624"><span class="hs-identifier hs-var">body_arg_occs</span></a><span> </span><a href="#local-6989586621680919622"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">tagSkeletonBinding</span><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-comment">-- ^ Is the binding a let-no-escape?</span><span>
</span><a name="line-272"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-273"></a><span>  </span><span class="hs-comment">-- ^ Let body skeleton</span><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span>
</span><a name="line-275"></a><span>  </span><span class="hs-comment">-- ^ Argument occurrences in the body</span><span>
</span><a name="line-276"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgBinding"><span class="hs-identifier hs-type">CgStgBinding</span></a><span>
</span><a name="line-277"></a><span>  </span><span class="hs-comment">-- ^ Binding group</span><span>
</span><a name="line-278"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgBinding"><span class="hs-identifier hs-type">LlStgBinding</span></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-comment">-- ^ Let skeleton, argument occurrences, scope skeleton of binding and</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-comment">--   the annotated binding</span><span>
</span><a name="line-281"></a><a name="tagSkeletonBinding"><a href="StgLiftLams.Analysis.html#tagSkeletonBinding"><span class="hs-identifier">tagSkeletonBinding</span></a></a><span> </span><a name="local-6989586621680919630"><a href="#local-6989586621680919630"><span class="hs-identifier">is_lne</span></a></a><span> </span><a name="local-6989586621680919631"><a href="#local-6989586621680919631"><span class="hs-identifier">body_skel</span></a></a><span> </span><a name="local-6989586621680919632"><a href="#local-6989586621680919632"><span class="hs-identifier">body_arg_occs</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621680919633"><a href="#local-6989586621680919633"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680919634"><a href="#local-6989586621680919634"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919640"><span class="hs-identifier hs-var">let_skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919638"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919642"><span class="hs-identifier hs-var">scope</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919643"><span class="hs-identifier hs-var">bind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919635"><a href="#local-6989586621680919635"><span class="hs-identifier">rhs_skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919636"><a href="#local-6989586621680919636"><span class="hs-identifier">rhs_arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919637"><a href="#local-6989586621680919637"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonRhs"><span class="hs-identifier hs-var">tagSkeletonRhs</span></a><span> </span><a href="#local-6989586621680919633"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680919634"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-285"></a><span>    </span><a name="local-6989586621680919638"><a href="#local-6989586621680919638"><span class="hs-identifier">arg_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919632"><span class="hs-identifier hs-var">body_arg_occs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919636"><span class="hs-identifier hs-var">rhs_arg_occs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">delVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919633"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-286"></a><span>    </span><a name="local-6989586621680919639"><a href="#local-6989586621680919639"><span class="hs-identifier">bind_skel</span></a></a><span>
</span><a name="line-287"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680919630"><span class="hs-identifier hs-var">is_lne</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919635"><span class="hs-identifier hs-var">rhs_skel</span></a><span> </span><span class="hs-comment">-- no closure is allocated for let-no-escapes</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#ClosureSk"><span class="hs-identifier hs-var">ClosureSk</span></a><span> </span><a href="#local-6989586621680919633"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#freeVarsOfRhs"><span class="hs-identifier hs-var">freeVarsOfRhs</span></a><span> </span><a href="#local-6989586621680919634"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919635"><span class="hs-identifier hs-var">rhs_skel</span></a><span>
</span><a name="line-289"></a><span>    </span><a name="local-6989586621680919640"><a href="#local-6989586621680919640"><span class="hs-identifier">let_skel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#bothSk"><span class="hs-identifier hs-var">bothSk</span></a><span> </span><a href="#local-6989586621680919631"><span class="hs-identifier hs-var">body_skel</span></a><span> </span><a href="#local-6989586621680919639"><span class="hs-identifier hs-var">bind_skel</span></a><span>
</span><a name="line-290"></a><span>    </span><a name="local-6989586621680919641"><a href="#local-6989586621680919641"><span class="hs-identifier">occurs_as_arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919633"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919632"><span class="hs-identifier hs-var">body_arg_occs</span></a><span>
</span><a name="line-291"></a><span>    </span><span class="hs-comment">-- Compared to the recursive case, this exploits the fact that @bndr@ is</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-comment">-- never free in @rhs@.</span><span>
</span><a name="line-293"></a><span>    </span><a name="local-6989586621680919642"><a href="#local-6989586621680919642"><span class="hs-identifier">scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919631"><span class="hs-identifier hs-var">body_skel</span></a><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621680919643"><a href="#local-6989586621680919643"><span class="hs-identifier">bind'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BindsClosure"><span class="hs-identifier hs-var">BindsClosure</span></a><span> </span><a href="#local-6989586621680919633"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680919641"><span class="hs-identifier hs-var">occurs_as_arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919637"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-295"></a><span class="hs-identifier">tagSkeletonBinding</span><span> </span><a name="local-6989586621680919644"><a href="#local-6989586621680919644"><span class="hs-identifier">is_lne</span></a></a><span> </span><a name="local-6989586621680919645"><a href="#local-6989586621680919645"><span class="hs-identifier">body_skel</span></a></a><span> </span><a name="local-6989586621680919646"><a href="#local-6989586621680919646"><span class="hs-identifier">body_arg_occs</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621680919647"><a href="#local-6989586621680919647"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919656"><span class="hs-identifier hs-var">let_skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919652"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919653"><span class="hs-identifier hs-var">scope</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a href="#local-6989586621680919655"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-298"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919648"><a href="#local-6989586621680919648"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680919647"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-299"></a><span>    </span><span class="hs-comment">-- Local recursive STG bindings also regard the defined binders as free</span><span>
</span><a name="line-300"></a><span>    </span><span class="hs-comment">-- vars. We want to delete those for our cost model, as these are known</span><span>
</span><a name="line-301"></a><span>    </span><span class="hs-comment">-- calls anyway when we add them to the same top-level recursive group as</span><span>
</span><a name="line-302"></a><span>    </span><span class="hs-comment">-- the top-level binding currently being analysed.</span><span>
</span><a name="line-303"></a><span>    </span><a name="local-6989586621680919649"><a href="#local-6989586621680919649"><span class="hs-identifier">skel_occs_rhss'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonRhs"><span class="hs-identifier hs-var">tagSkeletonRhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919647"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-304"></a><span>    </span><a name="local-6989586621680919650"><a href="#local-6989586621680919650"><span class="hs-identifier">rhss_arg_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">sndOf3</span><span> </span><a href="#local-6989586621680919649"><span class="hs-identifier hs-var">skel_occs_rhss'</span></a><span>
</span><a name="line-305"></a><span>    </span><a name="local-6989586621680919651"><a href="#local-6989586621680919651"><span class="hs-identifier">scope_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionVarSets</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919646"><span class="hs-identifier hs-var">body_arg_occs</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680919650"><span class="hs-identifier hs-var">rhss_arg_occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>    </span><a name="local-6989586621680919652"><a href="#local-6989586621680919652"><span class="hs-identifier">arg_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919651"><span class="hs-identifier hs-var">scope_occs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">delVarSetList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919648"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-307"></a><span>    </span><span class="hs-comment">-- @skel_rhss@ aren't yet wrapped in closures. We'll do that in a moment,</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-comment">-- but we also need the un-wrapped skeletons for calculating the @scope@</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-comment">-- of the group, as the outer closures don't contribute to closure growth</span><span>
</span><a name="line-310"></a><span>    </span><span class="hs-comment">-- when we lift this specific binding.</span><span>
</span><a name="line-311"></a><span>    </span><a name="local-6989586621680919653"><a href="#local-6989586621680919653"><span class="hs-identifier">scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#bothSk"><span class="hs-identifier hs-var">bothSk</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fstOf3</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919645"><span class="hs-identifier hs-var">body_skel</span></a><span> </span><a href="#local-6989586621680919649"><span class="hs-identifier hs-var">skel_occs_rhss'</span></a><span>
</span><a name="line-312"></a><span>    </span><span class="hs-comment">-- Now we can build the actual Skeleton for the expression just by</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-comment">-- iterating over each bind pair.</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919654"><a href="#local-6989586621680919654"><span class="hs-identifier">bind_skels</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919655"><a href="#local-6989586621680919655"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621680919657"><span class="hs-identifier hs-var">single_bind</span></a><span> </span><a href="#local-6989586621680919648"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680919649"><span class="hs-identifier hs-var">skel_occs_rhss'</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>    </span><a name="local-6989586621680919656"><a href="#local-6989586621680919656"><span class="hs-identifier">let_skel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="StgLiftLams.Analysis.html#bothSk"><span class="hs-identifier hs-var">bothSk</span></a><span> </span><a href="#local-6989586621680919645"><span class="hs-identifier hs-var">body_skel</span></a><span> </span><a href="#local-6989586621680919654"><span class="hs-identifier hs-var">bind_skels</span></a><span>
</span><a name="line-316"></a><span>    </span><a name="local-6989586621680919657"><a href="#local-6989586621680919657"><span class="hs-identifier">single_bind</span></a></a><span> </span><a name="local-6989586621680919658"><a href="#local-6989586621680919658"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680919659"><a href="#local-6989586621680919659"><span class="hs-identifier">skel_rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680919660"><a href="#local-6989586621680919660"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919661"><span class="hs-identifier hs-var">bind_skel</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919663"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919660"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-318"></a><span>        </span><span class="hs-comment">-- Here, we finally add the closure around each @skel_rhs@.</span><span>
</span><a name="line-319"></a><span>        </span><a name="local-6989586621680919661"><a href="#local-6989586621680919661"><span class="hs-identifier">bind_skel</span></a></a><span>
</span><a name="line-320"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680919644"><span class="hs-identifier hs-var">is_lne</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919659"><span class="hs-identifier hs-var">skel_rhs</span></a><span> </span><span class="hs-comment">-- no closure is allocated for let-no-escapes</span><span>
</span><a name="line-321"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#ClosureSk"><span class="hs-identifier hs-var">ClosureSk</span></a><span> </span><a href="#local-6989586621680919658"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680919662"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621680919659"><span class="hs-identifier hs-var">skel_rhs</span></a><span>
</span><a name="line-322"></a><span>        </span><a name="local-6989586621680919662"><a href="#local-6989586621680919662"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#freeVarsOfRhs"><span class="hs-identifier hs-var">freeVarsOfRhs</span></a><span> </span><a href="#local-6989586621680919660"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">dVarSetMinusVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621680919648"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-323"></a><span>        </span><a name="local-6989586621680919663"><a href="#local-6989586621680919663"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#BindsClosure"><span class="hs-identifier hs-var">BindsClosure</span></a><span> </span><a href="#local-6989586621680919658"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919658"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919651"><span class="hs-identifier hs-var">scope_occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-identifier">tagSkeletonRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgRhs"><span class="hs-identifier hs-type">CgStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgRhs"><span class="hs-identifier hs-type">LlStgRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><a name="tagSkeletonRhs"><a href="StgLiftLams.Analysis.html#tagSkeletonRhs"><span class="hs-identifier">tagSkeletonRhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621680919664"><a href="#local-6989586621680919664"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680919665"><a href="#local-6989586621680919665"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621680919666"><a href="#local-6989586621680919666"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span class="hs-special">,</span><span> </span><a href="StgLiftLams.Analysis.html#mkArgOccs"><span class="hs-identifier hs-var">mkArgOccs</span></a><span> </span><a href="#local-6989586621680919666"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a href="#local-6989586621680919664"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680919665"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621680919666"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span class="hs-identifier">tagSkeletonRhs</span><span> </span><a name="local-6989586621680919667"><a href="#local-6989586621680919667"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621680919668"><a href="#local-6989586621680919668"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621680919669"><a href="#local-6989586621680919669"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680919670"><a href="#local-6989586621680919670"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621680919671"><a href="#local-6989586621680919671"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621680919672"><a href="#local-6989586621680919672"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919677"><span class="hs-identifier hs-var">rhs_skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919675"><span class="hs-identifier hs-var">body_arg_occs</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a href="#local-6989586621680919668"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621680919669"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680919670"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621680919673"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621680919676"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-331"></a><span>    </span><a name="local-6989586621680919673"><a href="#local-6989586621680919673"><span class="hs-identifier">bndrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgLiftLams.Analysis.html#BoringBinder"><span class="hs-identifier hs-var">BoringBinder</span></a><span> </span><a href="#local-6989586621680919671"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919674"><a href="#local-6989586621680919674"><span class="hs-identifier">body_skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919675"><a href="#local-6989586621680919675"><span class="hs-identifier">body_arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919676"><a href="#local-6989586621680919676"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonExpr"><span class="hs-identifier hs-var">tagSkeletonExpr</span></a><span> </span><a href="#local-6989586621680919672"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-333"></a><span>    </span><a name="local-6989586621680919677"><a href="#local-6989586621680919677"><span class="hs-identifier">rhs_skel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#rhsSk"><span class="hs-identifier hs-var">rhsSk</span></a><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#rhsDmdShell"><span class="hs-identifier hs-var">rhsDmdShell</span></a><span> </span><a href="#local-6989586621680919667"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919674"><span class="hs-identifier hs-var">body_skel</span></a><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-comment">-- | How many times will the lambda body of the RHS bound to the given</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- identifier be evaluated, relative to its defining context? This function</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- computes the answer in form of a 'DmdShell'.</span><span>
</span><a name="line-338"></a><span class="hs-identifier">rhsDmdShell</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdShell</span><span>
</span><a name="line-339"></a><a name="rhsDmdShell"><a href="StgLiftLams.Analysis.html#rhsDmdShell"><span class="hs-identifier">rhsDmdShell</span></a></a><span> </span><a name="local-6989586621680919678"><a href="#local-6989586621680919678"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-340"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680919679"><span class="hs-identifier hs-var">is_thunk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">oneifyDmd</span><span> </span><a href="#local-6989586621680919680"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-341"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">peelManyCalls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680919678"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919681"><span class="hs-identifier hs-var">cd</span></a><span>
</span><a name="line-342"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-343"></a><span>    </span><a name="local-6989586621680919679"><a href="#local-6989586621680919679"><span class="hs-identifier">is_thunk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680919678"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-344"></a><span>    </span><span class="hs-comment">-- Let's pray idDemandInfo is still OK after unarise...</span><span>
</span><a name="line-345"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919680"><a href="#local-6989586621680919680"><span class="hs-identifier">ds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919681"><a href="#local-6989586621680919681"><span class="hs-identifier">cd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toCleanDmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idDemandInfo</span><span> </span><a href="#local-6989586621680919678"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-identifier">tagSkeletonAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgAlt"><span class="hs-identifier hs-type">LlStgAlt</span></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><a name="tagSkeletonAlt"><a href="StgLiftLams.Analysis.html#tagSkeletonAlt"><span class="hs-identifier">tagSkeletonAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680919682"><a href="#local-6989586621680919682"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919683"><a href="#local-6989586621680919683"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919684"><a href="#local-6989586621680919684"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919685"><span class="hs-identifier hs-var">alt_skel</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919688"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919682"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgLiftLams.Analysis.html#BoringBinder"><span class="hs-identifier hs-var">BoringBinder</span></a><span> </span><a href="#local-6989586621680919683"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919687"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-351"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919685"><a href="#local-6989586621680919685"><span class="hs-identifier">alt_skel</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919686"><a href="#local-6989586621680919686"><span class="hs-identifier">alt_arg_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680919687"><a href="#local-6989586621680919687"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#tagSkeletonExpr"><span class="hs-identifier hs-var">tagSkeletonExpr</span></a><span> </span><a href="#local-6989586621680919684"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-352"></a><span>    </span><a name="local-6989586621680919688"><a href="#local-6989586621680919688"><span class="hs-identifier">arg_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919686"><span class="hs-identifier hs-var">alt_arg_occs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">delVarSetList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919683"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span class="hs-comment">-- | Combines several heuristics to decide whether to lambda-lift a given</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- @let@-binding to top-level. See &quot;StgLiftLams.Analysis#when&quot; for details.</span><span>
</span><a name="line-356"></a><span class="hs-identifier">goodToLift</span><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-358"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>
</span><a name="line-359"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>
</span><a name="line-360"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DIdSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ An expander function, turning 'InId's into</span><span>
</span><a name="line-361"></a><span>                        </span><span class="hs-comment">-- 'OutId's. See 'StgLiftLams.LiftM.liftedIdsExpander'.</span><span>
</span><a name="line-362"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BinderInfo"><span class="hs-identifier hs-type">BinderInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#LlStgRhs"><span class="hs-identifier hs-type">LlStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-363"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-364"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span>       </span><span class="hs-comment">-- ^ @Just abs_ids@ &lt;=&gt; This binding is beneficial to</span><span>
</span><a name="line-365"></a><span>                        </span><span class="hs-comment">-- lift and @abs_ids@ are the variables it would</span><span>
</span><a name="line-366"></a><span>                        </span><span class="hs-comment">-- abstract over</span><span>
</span><a name="line-367"></a><a name="goodToLift"><a href="StgLiftLams.Analysis.html#goodToLift"><span class="hs-identifier">goodToLift</span></a></a><span> </span><a name="local-6989586621680919689"><a href="#local-6989586621680919689"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680919690"><a href="#local-6989586621680919690"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621680919691"><a href="#local-6989586621680919691"><span class="hs-identifier">rec_flag</span></a></a><span> </span><a name="local-6989586621680919692"><a href="#local-6989586621680919692"><span class="hs-identifier">expander</span></a></a><span> </span><a name="local-6989586621680919693"><a href="#local-6989586621680919693"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621680919694"><a href="#local-6989586621680919694"><span class="hs-identifier">scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919695"><span class="hs-identifier hs-var">decide</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;top-level&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621680919690"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- keep in sync with Note [When to lift]</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;memoized&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919703"><span class="hs-identifier hs-var">any_memoized</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;argument occurrences&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919705"><span class="hs-identifier hs-var">arg_occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;join point&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919706"><span class="hs-identifier hs-var">is_join_point</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;abstracts join points&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919707"><span class="hs-identifier hs-var">abstracts_join_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;abstracts known local function&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919709"><span class="hs-identifier hs-var">abstracts_known_local_fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;args spill on stack&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919712"><span class="hs-identifier hs-var">args_spill_on_stack</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;increases allocation&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680919713"><span class="hs-identifier hs-var">inc_allocs</span></a><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>  </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-377"></a><span>      </span><a name="local-6989586621680919695"><a href="#local-6989586621680919695"><span class="hs-identifier">decide</span></a></a><span> </span><a name="local-6989586621680919717"><a href="#local-6989586621680919717"><span class="hs-identifier">deciders</span></a></a><span>
</span><a name="line-378"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919697"><span class="hs-identifier hs-var">fancy_or</span></a><span> </span><a href="#local-6989586621680919717"><span class="hs-identifier hs-var">deciders</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#llTrace"><span class="hs-identifier hs-var">llTrace</span></a><span> </span><span class="hs-string">&quot;stgLiftLams:lifting&quot;</span><span>
</span><a name="line-380"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919698"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919702"><span class="hs-identifier hs-var">abs_ids</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-381"></a><span>                   </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919714"><span class="hs-identifier hs-var">allocs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-382"></a><span>                   </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919694"><span class="hs-identifier hs-var">scope</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-383"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680919702"><span class="hs-identifier hs-var">abs_ids</span></a><span>
</span><a name="line-384"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-385"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-386"></a><span>      </span><a name="local-6989586621680919696"><a href="#local-6989586621680919696"><span class="hs-identifier">ppr_deciders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">snd</span><span>
</span><a name="line-387"></a><span>      </span><a name="local-6989586621680919697"><a href="#local-6989586621680919697"><span class="hs-identifier">fancy_or</span></a></a><span> </span><a name="local-6989586621680919718"><a href="#local-6989586621680919718"><span class="hs-identifier">deciders</span></a></a><span>
</span><a name="line-388"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#llTrace"><span class="hs-identifier hs-var">llTrace</span></a><span> </span><span class="hs-string">&quot;stgLiftLams:goodToLift&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680919698"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621680919696"><span class="hs-identifier hs-var">ppr_deciders</span></a><span> </span><a href="#local-6989586621680919718"><span class="hs-identifier hs-var">deciders</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-389"></a><span>          </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621680919718"><span class="hs-identifier hs-var">deciders</span></a><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span>      </span><a name="local-6989586621680919698"><a href="#local-6989586621680919698"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919693"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-392"></a><span>      </span><a name="local-6989586621680919699"><a href="#local-6989586621680919699"><span class="hs-identifier">bndrs_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621680919698"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-393"></a><span>      </span><a name="local-6989586621680919700"><a href="#local-6989586621680919700"><span class="hs-identifier">rhss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621680919693"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span>      </span><span class="hs-comment">-- First objective: Calculate @abs_ids@, e.g. the former free variables</span><span>
</span><a name="line-396"></a><span>      </span><span class="hs-comment">-- the lifted binding would abstract over. We have to merge the free</span><span>
</span><a name="line-397"></a><span>      </span><span class="hs-comment">-- variables of all RHS to get the set of variables that will have to be</span><span>
</span><a name="line-398"></a><span>      </span><span class="hs-comment">-- passed through parameters.</span><span>
</span><a name="line-399"></a><span>      </span><a name="local-6989586621680919701"><a href="#local-6989586621680919701"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionDVarSets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgLiftLams.Analysis.html#freeVarsOfRhs"><span class="hs-identifier hs-var">freeVarsOfRhs</span></a><span> </span><a href="#local-6989586621680919700"><span class="hs-identifier hs-var">rhss</span></a><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>      </span><span class="hs-comment">-- To lift the binding to top-level, we want to delete the lifted binders</span><span>
</span><a name="line-401"></a><span>      </span><span class="hs-comment">-- themselves from the free var set. Local let bindings track recursive</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-comment">-- occurrences in their free variable set. We neither want to apply our</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-comment">-- cost model to them (see 'tagSkeletonRhs'), nor pass them as parameters</span><span>
</span><a name="line-404"></a><span>      </span><span class="hs-comment">-- when lifted, as these are known calls. We call the resulting set the</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-comment">-- identifiers we abstract over, thus @abs_ids@. These are all 'OutId's.</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-comment">-- We will save the set in 'LiftM.e_expansions' for each of the variables</span><span>
</span><a name="line-407"></a><span>      </span><span class="hs-comment">-- if we perform the lift.</span><span>
</span><a name="line-408"></a><span>      </span><a name="local-6989586621680919702"><a href="#local-6989586621680919702"><span class="hs-identifier">abs_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919692"><span class="hs-identifier hs-var">expander</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delDVarSetList</span><span> </span><a href="#local-6989586621680919701"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621680919698"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span>      </span><span class="hs-comment">-- We don't lift updatable thunks or constructors</span><span>
</span><a name="line-411"></a><span>      </span><a name="local-6989586621680919703"><a href="#local-6989586621680919703"><span class="hs-identifier">any_memoized</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621680919704"><span class="hs-identifier hs-var">is_memoized_rhs</span></a><span> </span><a href="#local-6989586621680919700"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-412"></a><span>      </span><a name="local-6989586621680919704"><a href="#local-6989586621680919704"><span class="hs-identifier">is_memoized_rhs</span></a></a><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-413"></a><span>      </span><span class="hs-identifier">is_memoized_rhs</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919719"><a href="#local-6989586621680919719"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#isUpdatable"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><a href="#local-6989586621680919719"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>      </span><span class="hs-comment">-- Don't lift binders occuring as arguments. This would result in complex</span><span>
</span><a name="line-416"></a><span>      </span><span class="hs-comment">-- argument expressions which would have to be given a name, reintroducing</span><span>
</span><a name="line-417"></a><span>      </span><span class="hs-comment">-- the very allocation at each call site that we wanted to get rid off in</span><span>
</span><a name="line-418"></a><span>      </span><span class="hs-comment">-- the first place.</span><span>
</span><a name="line-419"></a><span>      </span><a name="local-6989586621680919705"><a href="#local-6989586621680919705"><span class="hs-identifier">arg_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">or</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#binderInfoOccursAsArg"><span class="hs-identifier hs-var">binderInfoOccursAsArg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919693"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>      </span><span class="hs-comment">-- These don't allocate anyway.</span><span>
</span><a name="line-422"></a><span>      </span><a name="local-6989586621680919706"><a href="#local-6989586621680919706"><span class="hs-identifier">is_join_point</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621680919698"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>      </span><span class="hs-comment">-- Abstracting over join points/let-no-escapes spoils them.</span><span>
</span><a name="line-425"></a><span>      </span><a name="local-6989586621680919707"><a href="#local-6989586621680919707"><span class="hs-identifier">abstracts_join_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dVarSetElems</span><span> </span><a href="#local-6989586621680919702"><span class="hs-identifier hs-var">abs_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>      </span><span class="hs-comment">-- Abstracting over known local functions that aren't floated themselves</span><span>
</span><a name="line-428"></a><span>      </span><span class="hs-comment">-- turns a known, fast call into an unknown, slow call:</span><span>
</span><a name="line-429"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-430"></a><span>      </span><span class="hs-comment">--    let f x = ...</span><span>
</span><a name="line-431"></a><span>      </span><span class="hs-comment">--        g y = ... f x ... -- this was a known call</span><span>
</span><a name="line-432"></a><span>      </span><span class="hs-comment">--    in g 4</span><span>
</span><a name="line-433"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-434"></a><span>      </span><span class="hs-comment">-- After lifting @g@, but not @f@:</span><span>
</span><a name="line-435"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-436"></a><span>      </span><span class="hs-comment">--    l_g f y = ... f y ... -- this is now an unknown call</span><span>
</span><a name="line-437"></a><span>      </span><span class="hs-comment">--    let f x = ...</span><span>
</span><a name="line-438"></a><span>      </span><span class="hs-comment">--    in l_g f 4</span><span>
</span><a name="line-439"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-440"></a><span>      </span><span class="hs-comment">-- We can abuse the results of arity analysis for this:</span><span>
</span><a name="line-441"></a><span>      </span><span class="hs-comment">-- idArity f &gt; 0 ==&gt; known</span><span>
</span><a name="line-442"></a><span>      </span><a name="local-6989586621680919708"><a href="#local-6989586621680919708"><span class="hs-identifier">known_fun</span></a></a><span> </span><a name="local-6989586621680919720"><a href="#local-6989586621680919720"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680919720"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-443"></a><span>      </span><a name="local-6989586621680919709"><a href="#local-6989586621680919709"><span class="hs-identifier">abstracts_known_local_fun</span></a></a><span>
</span><a name="line-444"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">liftLamsKnown</span><span> </span><a href="#local-6989586621680919689"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621680919708"><span class="hs-identifier hs-var">known_fun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dVarSetElems</span><span> </span><a href="#local-6989586621680919702"><span class="hs-identifier hs-var">abs_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span>      </span><span class="hs-comment">-- Number of arguments of a RHS in the current binding group if we decide</span><span>
</span><a name="line-447"></a><span>      </span><span class="hs-comment">-- to lift it</span><span>
</span><a name="line-448"></a><span>      </span><a name="local-6989586621680919710"><a href="#local-6989586621680919710"><span class="hs-identifier">n_args</span></a></a><span>
</span><a name="line-449"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span>
</span><a name="line-450"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">StgCmmClosure.nonVoidIds</span></a><span> </span><span class="hs-comment">-- void parameters don't appear in Cmm</span><span>
</span><a name="line-451"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dVarSetElems</span><span> </span><a href="#local-6989586621680919702"><span class="hs-identifier hs-var">abs_ids</span></a><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgLiftLams.Analysis.html#rhsLambdaBndrs"><span class="hs-identifier hs-var">rhsLambdaBndrs</span></a><span>
</span><a name="line-453"></a><span>      </span><a name="local-6989586621680919711"><a href="#local-6989586621680919711"><span class="hs-identifier">max_n_args</span></a></a><span>
</span><a name="line-454"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isRec</span><span> </span><a href="#local-6989586621680919691"><span class="hs-identifier hs-var">rec_flag</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">liftLamsRecArgs</span><span> </span><a href="#local-6989586621680919689"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-455"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">liftLamsNonRecArgs</span><span> </span><a href="#local-6989586621680919689"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-456"></a><span>      </span><span class="hs-comment">-- We have 5 hardware registers on x86_64 to pass arguments in. Any excess</span><span>
</span><a name="line-457"></a><span>      </span><span class="hs-comment">-- args are passed on the stack, which means slow memory accesses</span><span>
</span><a name="line-458"></a><span>      </span><a name="local-6989586621680919712"><a href="#local-6989586621680919712"><span class="hs-identifier">args_spill_on_stack</span></a></a><span>
</span><a name="line-459"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680919721"><a href="#local-6989586621680919721"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680919711"><span class="hs-identifier hs-var">max_n_args</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maximum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680919710"><span class="hs-identifier hs-var">n_args</span></a><span> </span><a href="#local-6989586621680919700"><span class="hs-identifier hs-var">rhss</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621680919721"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-460"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>      </span><span class="hs-comment">-- We only perform the lift if allocations didn't increase.</span><span>
</span><a name="line-463"></a><span>      </span><span class="hs-comment">-- Note that @clo_growth@ will be 'infinity' if there was positive growth</span><span>
</span><a name="line-464"></a><span>      </span><span class="hs-comment">-- under a multi-shot lambda.</span><span>
</span><a name="line-465"></a><span>      </span><span class="hs-comment">-- Also, abstracting over LNEs is unacceptable. LNEs might return</span><span>
</span><a name="line-466"></a><span>      </span><span class="hs-comment">-- unlifted tuples, which idClosureFootprint can't cope with.</span><span>
</span><a name="line-467"></a><span>      </span><a name="local-6989586621680919713"><a href="#local-6989586621680919713"><span class="hs-identifier">inc_allocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919707"><span class="hs-identifier hs-var">abstracts_join_ids</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680919714"><span class="hs-identifier hs-var">allocs</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-468"></a><span>      </span><a name="local-6989586621680919714"><a href="#local-6989586621680919714"><span class="hs-identifier">allocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919716"><span class="hs-identifier hs-var">clo_growth</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">mkIntWithInf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">negate</span><span> </span><a href="#local-6989586621680919715"><span class="hs-identifier hs-var">closuresSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>      </span><span class="hs-comment">-- We calculate and then add up the size of each binding's closure.</span><span>
</span><a name="line-470"></a><span>      </span><span class="hs-comment">-- GHC does not currently share closure environments, and we either lift</span><span>
</span><a name="line-471"></a><span>      </span><span class="hs-comment">-- the entire recursive binding group or none of it.</span><span>
</span><a name="line-472"></a><span>      </span><a name="local-6989586621680919715"><a href="#local-6989586621680919715"><span class="hs-identifier">closuresSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680919700"><span class="hs-identifier hs-var">rhss</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680919722"><a href="#local-6989586621680919722"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-473"></a><span>        </span><a href="StgLiftLams.Analysis.html#closureSize"><span class="hs-identifier hs-var">closureSize</span></a><span> </span><a href="#local-6989586621680919689"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">dVarSetElems</span><span>
</span><a name="line-475"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621680919692"><span class="hs-identifier hs-var">expander</span></a><span>
</span><a name="line-476"></a><span>        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">dVarSetMinusVarSet</span><span> </span><a href="#local-6989586621680919699"><span class="hs-identifier hs-var">bndrs_set</span></a><span>
</span><a name="line-477"></a><span>        </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgLiftLams.Analysis.html#freeVarsOfRhs"><span class="hs-identifier hs-var">freeVarsOfRhs</span></a><span> </span><a href="#local-6989586621680919722"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-478"></a><span>      </span><a name="local-6989586621680919716"><a href="#local-6989586621680919716"><span class="hs-identifier">clo_growth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgLiftLams.Analysis.html#closureGrowth"><span class="hs-identifier hs-var">closureGrowth</span></a><span> </span><a href="#local-6989586621680919692"><span class="hs-identifier hs-var">expander</span></a><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#idClosureFootprint"><span class="hs-identifier hs-var">idClosureFootprint</span></a><span> </span><a href="#local-6989586621680919689"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680919699"><span class="hs-identifier hs-var">bndrs_set</span></a><span> </span><a href="#local-6989586621680919702"><span class="hs-identifier hs-var">abs_ids</span></a><span> </span><a href="#local-6989586621680919694"><span class="hs-identifier hs-var">scope</span></a><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-identifier">rhsLambdaBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#LlStgRhs"><span class="hs-identifier hs-type">LlStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-481"></a><a name="rhsLambdaBndrs"><a href="StgLiftLams.Analysis.html#rhsLambdaBndrs"><span class="hs-identifier">rhsLambdaBndrs</span></a></a><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-482"></a><span class="hs-identifier">rhsLambdaBndrs</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919723"><a href="#local-6989586621680919723"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgLiftLams.Analysis.html#binderInfoBndr"><span class="hs-identifier hs-var">binderInfoBndr</span></a><span> </span><a href="#local-6989586621680919723"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-comment">-- | The size in words of a function closure closing over the given 'Id's,</span><span>
</span><a name="line-485"></a><span class="hs-comment">-- including the header.</span><span>
</span><a name="line-486"></a><span class="hs-identifier">closureSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-487"></a><a name="closureSize"><a href="StgLiftLams.Analysis.html#closureSize"><span class="hs-identifier">closureSize</span></a></a><span> </span><a name="local-6989586621680919724"><a href="#local-6989586621680919724"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680919725"><a href="#local-6989586621680919725"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919726"><span class="hs-identifier hs-var">words</span></a><span>
</span><a name="line-488"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680919726"><a href="#local-6989586621680919726"><span class="hs-identifier">words</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>      </span><span class="hs-comment">-- Functions have a StdHeader (as opposed to ThunkHeader).</span><span>
</span><a name="line-491"></a><span>      </span><span class="hs-comment">-- Note that mkVirtHeadOffsets will account for profiling headers, so</span><span>
</span><a name="line-492"></a><span>      </span><span class="hs-comment">-- lifting decisions vary if we begin to profile stuff. Maybe we shouldn't</span><span>
</span><a name="line-493"></a><span>      </span><span class="hs-comment">-- do this or deactivate profiling in @dflags@?</span><span>
</span><a name="line-494"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmLayout.html#mkVirtHeapOffsets"><span class="hs-identifier hs-var">StgCmmLayout.mkVirtHeapOffsets</span></a><span> </span><a href="#local-6989586621680919724"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="StgCmmLayout.html#StdHeader"><span class="hs-identifier hs-var">StgCmmLayout.StdHeader</span></a><span>
</span><a name="line-495"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#addIdReps"><span class="hs-identifier hs-var">StgCmmClosure.addIdReps</span></a><span>
</span><a name="line-496"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">StgCmmClosure.nonVoidIds</span></a><span>
</span><a name="line-497"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680919725"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-comment">-- | The number of words a single 'Id' adds to a closure's size.</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- Note that this can't handle unboxed tuples (which may still be present in</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- let-no-escapes, even after Unarise), in which case</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- @'StgCmmClosure.idPrimRep'@ will crash.</span><span>
</span><a name="line-503"></a><span class="hs-identifier">idClosureFootprint</span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-504"></a><a name="idClosureFootprint"><a href="StgLiftLams.Analysis.html#idClosureFootprint"><span class="hs-identifier">idClosureFootprint</span></a></a><span> </span><a name="local-6989586621680919727"><a href="#local-6989586621680919727"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-505"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmArgRep.html#argRepSizeW"><span class="hs-identifier hs-var">StgCmmArgRep.argRepSizeW</span></a><span> </span><a href="#local-6989586621680919727"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-506"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmArgRep.html#idArgRep"><span class="hs-identifier hs-var">StgCmmArgRep.idArgRep</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- | @closureGrowth expander sizer f fvs@ computes the closure growth in words</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- as a result of lifting @f@ to top-level. If there was any growing closure</span><span>
</span><a name="line-510"></a><span class="hs-comment">-- under a multi-shot lambda, the result will be 'infinity'.</span><span>
</span><a name="line-511"></a><span class="hs-comment">-- Also see &quot;StgLiftLams.Analysis#clogro&quot;.</span><span>
</span><a name="line-512"></a><span class="hs-identifier">closureGrowth</span><span>
</span><a name="line-513"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DIdSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>  </span><span class="hs-comment">-- ^ Expands outer free ids that were lifted to their free vars</span><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>  </span><span class="hs-comment">-- ^ Computes the closure footprint of an identifier</span><span>
</span><a name="line-517"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-comment">-- ^ Binding group for which lifting is to be decided</span><span>
</span><a name="line-519"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DIdSet</span><span>
</span><a name="line-520"></a><span>  </span><span class="hs-comment">-- ^ Free vars of the whole binding group prior to lifting it. These must be</span><span>
</span><a name="line-521"></a><span>  </span><span class="hs-comment">--   available at call sites if we decide to lift the binding group.</span><span>
</span><a name="line-522"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgLiftLams.Analysis.html#Skeleton"><span class="hs-identifier hs-type">Skeleton</span></a><span>
</span><a name="line-523"></a><span>  </span><span class="hs-comment">-- ^ Abstraction of the scope of the function</span><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IntWithInf</span><span>
</span><a name="line-525"></a><span>  </span><span class="hs-comment">-- ^ Closure growth. 'infinity' indicates there was growth under a</span><span>
</span><a name="line-526"></a><span>  </span><span class="hs-comment">--   (multi-shot) lambda.</span><span>
</span><a name="line-527"></a><a name="closureGrowth"><a href="StgLiftLams.Analysis.html#closureGrowth"><span class="hs-identifier">closureGrowth</span></a></a><span> </span><a name="local-6989586621680919728"><a href="#local-6989586621680919728"><span class="hs-identifier">expander</span></a></a><span> </span><a name="local-6989586621680919729"><a href="#local-6989586621680919729"><span class="hs-identifier">sizer</span></a></a><span> </span><a name="local-6989586621680919730"><a href="#local-6989586621680919730"><span class="hs-identifier">group</span></a></a><span> </span><a name="local-6989586621680919731"><a href="#local-6989586621680919731"><span class="hs-identifier">abs_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-528"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-529"></a><span>    </span><a name="local-6989586621680919732"><a href="#local-6989586621680919732"><span class="hs-identifier">go</span></a></a><span> </span><a href="StgLiftLams.Analysis.html#NilSk"><span class="hs-identifier hs-var">NilSk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#BothSk"><span class="hs-identifier hs-var">BothSk</span></a><span> </span><a name="local-6989586621680919733"><a href="#local-6989586621680919733"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680919734"><a href="#local-6989586621680919734"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680919733"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680919734"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-531"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#AltSk"><span class="hs-identifier hs-var">AltSk</span></a><span> </span><a name="local-6989586621680919735"><a href="#local-6989586621680919735"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680919736"><a href="#local-6989586621680919736"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680919735"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680919736"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#ClosureSk"><span class="hs-identifier hs-var">ClosureSk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680919737"><a href="#local-6989586621680919737"><span class="hs-identifier">clo_fvs</span></a></a><span> </span><a name="local-6989586621680919738"><a href="#local-6989586621680919738"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>      </span><span class="hs-comment">-- If no binder of the @group@ occurs free in the closure, the lifting</span><span>
</span><a name="line-534"></a><span>      </span><span class="hs-comment">-- won't have any effect on it and we can omit the recursive call.</span><span>
</span><a name="line-535"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680919739"><span class="hs-identifier hs-var">n_occs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-536"></a><span>      </span><span class="hs-comment">-- Otherwise, we account the cost of allocating the closure and add it to</span><span>
</span><a name="line-537"></a><span>      </span><span class="hs-comment">-- the closure growth of its RHS.</span><span>
</span><a name="line-538"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIntWithInf</span><span> </span><a href="#local-6989586621680919742"><span class="hs-identifier hs-var">cost</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680919738"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-539"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-540"></a><span>        </span><a name="local-6989586621680919739"><a href="#local-6989586621680919739"><span class="hs-identifier">n_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeDVarSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680919740"><span class="hs-identifier hs-var">clo_fvs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">dVarSetIntersectVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919730"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>        </span><span class="hs-comment">-- What we close over considering prior lifting decisions</span><span>
</span><a name="line-542"></a><span>        </span><a name="local-6989586621680919740"><a href="#local-6989586621680919740"><span class="hs-identifier">clo_fvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919728"><span class="hs-identifier hs-var">expander</span></a><span> </span><a href="#local-6989586621680919737"><span class="hs-identifier hs-var">clo_fvs</span></a><span>
</span><a name="line-543"></a><span>        </span><span class="hs-comment">-- Variables that would additionally occur free in the closure body if</span><span>
</span><a name="line-544"></a><span>        </span><span class="hs-comment">-- we lift @f@</span><span>
</span><a name="line-545"></a><span>        </span><a name="local-6989586621680919741"><a href="#local-6989586621680919741"><span class="hs-identifier">newbies</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919731"><span class="hs-identifier hs-var">abs_ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusDVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680919740"><span class="hs-identifier hs-var">clo_fvs'</span></a><span>
</span><a name="line-546"></a><span>        </span><span class="hs-comment">-- Lifting @f@ removes @f@ from the closure but adds all @newbies@</span><span>
</span><a name="line-547"></a><span>        </span><a name="local-6989586621680919742"><a href="#local-6989586621680919742"><span class="hs-identifier">cost</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldDVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680919743"><a href="#local-6989586621680919743"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680919744"><a href="#local-6989586621680919744"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680919729"><span class="hs-identifier hs-var">sizer</span></a><span> </span><a href="#local-6989586621680919743"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621680919744"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680919741"><span class="hs-identifier hs-var">newbies</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621680919739"><span class="hs-identifier hs-var">n_occs</span></a><span>
</span><a name="line-548"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="StgLiftLams.Analysis.html#RhsSk"><span class="hs-identifier hs-var">RhsSk</span></a><span> </span><a name="local-6989586621680919745"><a href="#local-6989586621680919745"><span class="hs-identifier">body_dmd</span></a></a><span> </span><a name="local-6989586621680919746"><a href="#local-6989586621680919746"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>      </span><span class="hs-comment">-- The conservative assumption would be that</span><span>
</span><a name="line-550"></a><span>      </span><span class="hs-comment">--   1. Every RHS with positive growth would be called multiple times,</span><span>
</span><a name="line-551"></a><span>      </span><span class="hs-comment">--      modulo thunks.</span><span>
</span><a name="line-552"></a><span>      </span><span class="hs-comment">--   2. Every RHS with negative growth wouldn't be called at all.</span><span>
</span><a name="line-553"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-554"></a><span>      </span><span class="hs-comment">-- In the first case, we'd have to return 'infinity', while in the</span><span>
</span><a name="line-555"></a><span>      </span><span class="hs-comment">-- second case, we'd have to return 0. But we can do far better</span><span>
</span><a name="line-556"></a><span>      </span><span class="hs-comment">-- considering information from the demand analyser, which provides us</span><span>
</span><a name="line-557"></a><span>      </span><span class="hs-comment">-- with conservative estimates on minimum and maximum evaluation</span><span>
</span><a name="line-558"></a><span>      </span><span class="hs-comment">-- cardinality. The @body_dmd@ part of 'RhsSk' is the result of</span><span>
</span><a name="line-559"></a><span>      </span><span class="hs-comment">-- 'rhsDmdShell' and accurately captures the cardinality of the RHSs body</span><span>
</span><a name="line-560"></a><span>      </span><span class="hs-comment">-- relative to its defining context.</span><span>
</span><a name="line-561"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAbsDmd</span><span> </span><a href="#local-6989586621680919745"><span class="hs-identifier hs-var">body_dmd</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-562"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680919747"><span class="hs-identifier hs-var">cg</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><a href="#local-6989586621680919745"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680919747"><span class="hs-identifier hs-var">cg</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-563"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUsedOnce</span><span> </span><a href="#local-6989586621680919745"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919747"><span class="hs-identifier hs-var">cg</span></a><span>
</span><a name="line-564"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">infinity</span><span>
</span><a name="line-565"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-566"></a><span>        </span><a name="local-6989586621680919747"><a href="#local-6989586621680919747"><span class="hs-identifier">cg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680919732"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680919746"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-567"></a></pre></body></html>