<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs, UnboxedTuples #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Monad for Stg to C-- code generation</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmMonad</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>        </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- type</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>        </span><a href="StgCmmMonad.html#initC"><span class="hs-identifier hs-var">initC</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#runC"><span class="hs-identifier hs-var">runC</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#fixC"><span class="hs-identifier hs-var">fixC</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="StgCmmMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>        </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitDecl"><span class="hs-identifier hs-var">emitDecl</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitProc"><span class="hs-identifier hs-var">emitProc</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="StgCmmMonad.html#emitProcWithConvention"><span class="hs-identifier hs-var">emitProcWithConvention</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitProcWithStackFrame"><span class="hs-identifier hs-var">emitProcWithStackFrame</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="StgCmmMonad.html#emitOutOfLine"><span class="hs-identifier hs-var">emitOutOfLine</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitAssign"><span class="hs-identifier hs-var">emitAssign</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier hs-var">emitStore</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="StgCmmMonad.html#emitComment"><span class="hs-identifier hs-var">emitComment</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitTick"><span class="hs-identifier hs-var">emitTick</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#emitUnwind"><span class="hs-identifier hs-var">emitUnwind</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>        </span><a href="StgCmmMonad.html#getCmm"><span class="hs-identifier hs-var">getCmm</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#aGraphToGraph"><span class="hs-identifier hs-var">aGraphToGraph</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="StgCmmMonad.html#getCodeR"><span class="hs-identifier hs-var">getCodeR</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getCode"><span class="hs-identifier hs-var">getCode</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getCodeScoped"><span class="hs-identifier hs-var">getCodeScoped</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getHeapUsage"><span class="hs-identifier hs-var">getHeapUsage</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span>        </span><a href="StgCmmMonad.html#mkCmmIfThenElse"><span class="hs-identifier hs-var">mkCmmIfThenElse</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThen"><span class="hs-identifier hs-var">mkCmmIfThen</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#mkCmmIfGoto"><span class="hs-identifier hs-var">mkCmmIfGoto</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="StgCmmMonad.html#mkCmmIfThenElse%27"><span class="hs-identifier hs-var">mkCmmIfThenElse'</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThen%27"><span class="hs-identifier hs-var">mkCmmIfThen'</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#mkCmmIfGoto%27"><span class="hs-identifier hs-var">mkCmmIfGoto'</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><a href="StgCmmMonad.html#mkCall"><span class="hs-identifier hs-var">mkCall</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#mkCmmCall"><span class="hs-identifier hs-var">mkCmmCall</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>        </span><a href="StgCmmMonad.html#forkClosureBody"><span class="hs-identifier hs-var">forkClosureBody</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#forkLneBody"><span class="hs-identifier hs-var">forkLneBody</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#forkAlts"><span class="hs-identifier hs-var">forkAlts</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#forkAltPair"><span class="hs-identifier hs-var">forkAltPair</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#codeOnly"><span class="hs-identifier hs-var">codeOnly</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>        </span><span class="hs-identifier hs-type">ConTagZ</span><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span>        </span><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="StgCmmMonad.html#withSequel"><span class="hs-identifier hs-var">withSequel</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getSequel"><span class="hs-identifier hs-var">getSequel</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span>        </span><a href="StgCmmMonad.html#setTickyCtrLabel"><span class="hs-identifier hs-var">setTickyCtrLabel</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier hs-var">getTickyCtrLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="StgCmmMonad.html#tickScope"><span class="hs-identifier hs-var">tickScope</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span>        </span><a href="StgCmmMonad.html#withUpdFrameOff"><span class="hs-identifier hs-var">withUpdFrameOff</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#initUpdFrameOff"><span class="hs-identifier hs-var">initUpdFrameOff</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>        </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span class="hs-special">,</span><span>        </span><a href="StgCmmMonad.html#initHpUsage"><span class="hs-identifier hs-var">initHpUsage</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="StgCmmMonad.html#getHpUsage"><span class="hs-identifier hs-var">getHpUsage</span></a><span class="hs-special">,</span><span>  </span><a href="StgCmmMonad.html#setHpUsage"><span class="hs-identifier hs-var">setHpUsage</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#heapHWM"><span class="hs-identifier hs-var">heapHWM</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>        </span><a href="StgCmmMonad.html#setVirtHp"><span class="hs-identifier hs-var">setVirtHp</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getVirtHp"><span class="hs-identifier hs-var">getVirtHp</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#setRealHp"><span class="hs-identifier hs-var">setRealHp</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>        </span><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier hs-var">getModuleName</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span>        </span><span class="hs-comment">-- ideally we wouldn't export these, but some other modules access internal state</span><span>
</span><a name="line-51"></a><span>        </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getSelfLoop"><span class="hs-identifier hs-var">getSelfLoop</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#withSelfLoop"><span class="hs-identifier hs-var">withSelfLoop</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#getThisPackage"><span class="hs-identifier hs-var">getThisPackage</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>        </span><span class="hs-comment">-- more localised access to monad state</span><span>
</span><a name="line-54"></a><span>        </span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>        </span><a href="StgCmmMonad.html#getBinds"><span class="hs-identifier hs-var">getBinds</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#setBinds"><span class="hs-identifier hs-var">setBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span>        </span><span class="hs-comment">-- out of general friendliness, we also export ...</span><span>
</span><a name="line-58"></a><span>        </span><a href="StgCmmMonad.html#CgInfoDownwards"><span class="hs-identifier hs-type">CgInfoDownwards</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- non-abstract</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sequence</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">succ</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ConTagZ</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- The FCode monad and its types</span><span>
</span><a name="line-89"></a><span class="hs-comment">--</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- FCode is the monad plumbed through the Stg-&gt;Cmm code generator, and</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- the Cmm parser.  It contains the following things:</span><span>
</span><a name="line-92"></a><span class="hs-comment">--</span><span>
</span><a name="line-93"></a><span class="hs-comment">--  - A writer monad, collecting:</span><span>
</span><a name="line-94"></a><span class="hs-comment">--    - code for the current function, in the form of a CmmAGraph.</span><span>
</span><a name="line-95"></a><span class="hs-comment">--      The function &quot;emit&quot; appends more code to this.</span><span>
</span><a name="line-96"></a><span class="hs-comment">--    - the top-level CmmDecls accumulated so far</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-comment">--  - A state monad with:</span><span>
</span><a name="line-99"></a><span class="hs-comment">--    - the local bindings in scope</span><span>
</span><a name="line-100"></a><span class="hs-comment">--    - the current heap usage</span><span>
</span><a name="line-101"></a><span class="hs-comment">--    - a UniqSupply</span><span>
</span><a name="line-102"></a><span class="hs-comment">--</span><span>
</span><a name="line-103"></a><span class="hs-comment">--  - A reader monad, for CgInfoDownwards, containing</span><span>
</span><a name="line-104"></a><span class="hs-comment">--    - DynFlags,</span><span>
</span><a name="line-105"></a><span class="hs-comment">--    - the current Module</span><span>
</span><a name="line-106"></a><span class="hs-comment">--    - the update-frame offset</span><span>
</span><a name="line-107"></a><span class="hs-comment">--    - the ticky counter label</span><span>
</span><a name="line-108"></a><span class="hs-comment">--    - the Sequel (the continuation to return to)</span><span>
</span><a name="line-109"></a><span class="hs-comment">--    - the self-recursive tail call information</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-keyword">newtype</span><span> </span><a name="FCode"><a href="StgCmmMonad.html#FCode"><span class="hs-identifier">FCode</span></a></a><span> </span><a name="local-6989586621680699429"><a href="#local-6989586621680699429"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FCode"><a href="StgCmmMonad.html#FCode"><span class="hs-identifier">FCode</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="doFCode"><a href="StgCmmMonad.html#doFCode"><span class="hs-identifier">doFCode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#CgInfoDownwards"><span class="hs-identifier hs-type">CgInfoDownwards</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699429"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-116"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621680699447"><a href="#local-6989586621680699447"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><a name="local-6989586621680699448"><a href="#local-6989586621680699448"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680699449"><a href="#local-6989586621680699449"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621680699450"><a href="#local-6989586621680699450"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680699448"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621680699449"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621680699450"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699451"><a href="#local-6989586621680699451"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699452"><a href="#local-6989586621680699452"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699447"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680699451"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699452"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621680699444"><a href="#local-6989586621680699444"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680699445"><a href="#local-6989586621680699445"><span class="hs-identifier">_info_down</span></a></a><span> </span><a name="local-6989586621680699446"><a href="#local-6989586621680699446"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699444"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699446"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">pure</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-121"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-124"></a><span>    </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><a name="local-6989586621680699437"><a href="#local-6989586621680699437"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621680699438"><a href="#local-6989586621680699438"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-glyph">\</span><a name="local-6989586621680699439"><a href="#local-6989586621680699439"><span class="hs-identifier">info_down</span></a></a><span> </span><a name="local-6989586621680699440"><a href="#local-6989586621680699440"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-126"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680699437"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621680699439"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699440"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-127"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621680699441"><a href="#local-6989586621680699441"><span class="hs-identifier">m_result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699442"><a href="#local-6989586621680699442"><span class="hs-identifier">new_state</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-128"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680699438"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680699441"><span class="hs-identifier hs-var">m_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-129"></a><span>                   </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><a name="local-6989586621680699443"><a href="#local-6989586621680699443"><span class="hs-identifier">kcode</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680699443"><span class="hs-identifier hs-var">kcode</span></a><span> </span><a href="#local-6989586621680699439"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699442"><span class="hs-identifier hs-var">new_state</span></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;=</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-133"></a><span>  </span><a name="local-8214565720323805401"><span class="hs-identifier">getUniqueSupplyM</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_uniqs</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-134"></a><span>  </span><a name="local-8214565720323805400"><span class="hs-identifier">getUniqueM</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680699434"><a href="#local-6989586621680699434"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699435"><a href="#local-6989586621680699435"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699436"><a href="#local-6989586621680699436"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgs_uniqs</span><span> </span><a href="#local-6989586621680699434"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699435"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699434"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_uniqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699436"><span class="hs-identifier hs-var">us'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">initC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span>
</span><a name="line-139"></a><a name="initC"><a href="StgCmmMonad.html#initC"><span class="hs-identifier">initC</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699469"><a href="#local-6989586621680699469"><span class="hs-identifier">uniqs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'c'</span><span>
</span><a name="line-140"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initCgState"><span class="hs-identifier hs-var">initCgState</span></a><span> </span><a href="#local-6989586621680699469"><span class="hs-identifier hs-var">uniqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-identifier">runC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699468"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699468"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><a name="runC"><a href="StgCmmMonad.html#runC"><span class="hs-identifier">runC</span></a></a><span> </span><a name="local-6989586621680699470"><a href="#local-6989586621680699470"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680699471"><a href="#local-6989586621680699471"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621680699472"><a href="#local-6989586621680699472"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621680699473"><a href="#local-6989586621680699473"><span class="hs-identifier">fcode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><a href="#local-6989586621680699473"><span class="hs-identifier hs-var">fcode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initCgInfoDown"><span class="hs-identifier hs-var">initCgInfoDown</span></a><span> </span><a href="#local-6989586621680699470"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680699471"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680699472"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">fixC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699467"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699467"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699467"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-146"></a><a name="fixC"><a href="StgCmmMonad.html#fixC"><span class="hs-identifier">fixC</span></a></a><span> </span><a name="local-6989586621680699474"><a href="#local-6989586621680699474"><span class="hs-identifier">fcode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-glyph">\</span><a name="local-6989586621680699475"><a href="#local-6989586621680699475"><span class="hs-identifier">info_down</span></a></a><span> </span><a name="local-6989586621680699476"><a href="#local-6989586621680699476"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699477"><a href="#local-6989586621680699477"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699478"><a href="#local-6989586621680699478"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699474"><span class="hs-identifier hs-var">fcode</span></a><span> </span><a href="#local-6989586621680699477"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680699475"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699476"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-148"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699477"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699478"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-151"></a><span class="hs-comment">--        The code generator environment</span><span>
</span><a name="line-152"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- This monadery has some information that it only passes</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- *downwards*, as well as some ``state'' which is modified</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- as we go along.</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-keyword">data</span><span> </span><a name="CgInfoDownwards"><a href="StgCmmMonad.html#CgInfoDownwards"><span class="hs-identifier">CgInfoDownwards</span></a></a><span>        </span><span class="hs-comment">-- information only passed *downwards* by the monad</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="MkCgInfoDown"><a href="StgCmmMonad.html#MkCgInfoDown"><span class="hs-identifier">MkCgInfoDown</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-160"></a><span>        </span><a name="cgd_dflags"><a href="StgCmmMonad.html#cgd_dflags"><span class="hs-identifier">cgd_dflags</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span>
</span><a name="line-161"></a><span>        </span><a name="cgd_mod"><a href="StgCmmMonad.html#cgd_mod"><span class="hs-identifier">cgd_mod</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- Module being compiled</span><span>
</span><a name="line-162"></a><span>        </span><a name="cgd_updfr_off"><a href="StgCmmMonad.html#cgd_updfr_off"><span class="hs-identifier">cgd_updfr_off</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Size of current update frame</span><span>
</span><a name="line-163"></a><span>        </span><a name="cgd_ticky"><a href="StgCmmMonad.html#cgd_ticky"><span class="hs-identifier">cgd_ticky</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- Current destination for ticky counts</span><span>
</span><a name="line-164"></a><span>        </span><a name="cgd_sequel"><a href="StgCmmMonad.html#cgd_sequel"><span class="hs-identifier">cgd_sequel</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- What to do at end of basic block</span><span>
</span><a name="line-165"></a><span>        </span><a name="cgd_self_loop"><a href="StgCmmMonad.html#cgd_self_loop"><span class="hs-identifier">cgd_self_loop</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="StgCmmClosure.html#SelfLoopInfo"><span class="hs-identifier hs-type">SelfLoopInfo</span></a><span class="hs-special">,</span><span class="hs-comment">-- Which tail calls can be compiled</span><span>
</span><a name="line-166"></a><span>                                            </span><span class="hs-comment">-- as local jumps? See Note</span><span>
</span><a name="line-167"></a><span>                                            </span><span class="hs-comment">-- [Self-recursive tail calls] in</span><span>
</span><a name="line-168"></a><span>                                            </span><span class="hs-comment">-- StgCmmExpr</span><span>
</span><a name="line-169"></a><span>        </span><a name="cgd_tick_scope"><a href="StgCmmMonad.html#cgd_tick_scope"><span class="hs-identifier">cgd_tick_scope</span></a></a><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span>       </span><span class="hs-comment">-- Tick scope for new blocks &amp; ticks</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-keyword">type</span><span> </span><a name="CgBindings"><a href="StgCmmMonad.html#CgBindings"><span class="hs-identifier">CgBindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-keyword">data</span><span> </span><a name="CgIdInfo"><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier">CgIdInfo</span></a></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CgIdInfo"><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier">CgIdInfo</span></a></a><span>
</span><a name="line-176"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="cg_id"><a href="StgCmmMonad.html#cg_id"><span class="hs-identifier">cg_id</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>   </span><span class="hs-comment">-- Id that this is the info for</span><span>
</span><a name="line-177"></a><span>                        </span><span class="hs-comment">-- Can differ from the Id at occurrence sites by</span><span>
</span><a name="line-178"></a><span>                        </span><span class="hs-comment">-- virtue of being externalised, for splittable C</span><span>
</span><a name="line-179"></a><span>                        </span><span class="hs-comment">-- See Note [Externalise when splitting]</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cg_lf"><a href="StgCmmMonad.html#cg_lf"><span class="hs-identifier">cg_lf</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-181"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cg_loc"><a href="StgCmmMonad.html#cg_loc"><span class="hs-identifier">cg_loc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#CgLoc"><span class="hs-identifier hs-type">CgLoc</span></a><span>                     </span><span class="hs-comment">-- CmmExpr for the *tagged* value</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-comment">-- Note [Externalise when splitting]</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- If we're splitting the object with -fsplit-objs, we need to</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- externalise *all* the top-level names, and then make sure we only</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- use the externalised one in any C label we use which refers to this</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- name.</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-192"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-var">CgIdInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cg_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680699432"><a href="#local-6989586621680699432"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cg_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680699433"><a href="#local-6989586621680699433"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680699432"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;--&gt;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680699433"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-comment">-- Sequel tells what to do with the result of this expression</span><span>
</span><a name="line-196"></a><span class="hs-keyword">data</span><span> </span><a name="Sequel"><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier">Sequel</span></a></a><span>
</span><a name="line-197"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Return"><a href="StgCmmMonad.html#Return"><span class="hs-identifier">Return</span></a></a><span>              </span><span class="hs-comment">-- Return result(s) to continuation found on the stack.</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AssignTo"><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier">AssignTo</span></a></a><span>
</span><a name="line-200"></a><span>        </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Put result(s) in these regs and fall through</span><span>
</span><a name="line-201"></a><span>                        </span><span class="hs-comment">-- NB: no void arguments here</span><span>
</span><a name="line-202"></a><span>                        </span><span class="hs-comment">--</span><span>
</span><a name="line-203"></a><span>        </span><span class="hs-identifier hs-type">Bool</span><span>            </span><span class="hs-comment">-- Should we adjust the heap pointer back to</span><span>
</span><a name="line-204"></a><span>                        </span><span class="hs-comment">-- recover space that's unused on this path?</span><span>
</span><a name="line-205"></a><span>                        </span><span class="hs-comment">-- We need to do this only if the expression</span><span>
</span><a name="line-206"></a><span>                        </span><span class="hs-comment">-- may allocate (e.g. it's a foreign call or</span><span>
</span><a name="line-207"></a><span>                        </span><span class="hs-comment">-- allocating primOp)</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="StgCmmMonad.html#Return"><span class="hs-identifier hs-var">Return</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Return&quot;</span><span>
</span><a name="line-211"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier hs-var">AssignTo</span></a><span> </span><a name="local-6989586621680699430"><a href="#local-6989586621680699430"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621680699431"><a href="#local-6989586621680699431"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;AssignTo&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680699430"><span class="hs-identifier hs-var">regs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680699431"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- See Note [sharing continuations] below</span><span>
</span><a name="line-214"></a><span class="hs-keyword">data</span><span> </span><a name="ReturnKind"><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier">ReturnKind</span></a></a><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="AssignedDirectly"><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier">AssignedDirectly</span></a></a><span>
</span><a name="line-216"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ReturnedTo"><a href="StgCmmMonad.html#ReturnedTo"><span class="hs-identifier">ReturnedTo</span></a></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- Note [sharing continuations]</span><span>
</span><a name="line-219"></a><span class="hs-comment">--</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- ReturnKind says how the expression being compiled returned its</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- results: either by assigning directly to the registers specified</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- by the Sequel, or by returning to a continuation that does the</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- assignments.  The point of this is we might be able to re-use the</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- continuation in a subsequent heap-check.  Consider:</span><span>
</span><a name="line-225"></a><span class="hs-comment">--</span><span>
</span><a name="line-226"></a><span class="hs-comment">--    case f x of z</span><span>
</span><a name="line-227"></a><span class="hs-comment">--      True  -&gt; &lt;True code&gt;</span><span>
</span><a name="line-228"></a><span class="hs-comment">--      False -&gt; &lt;False code&gt;</span><span>
</span><a name="line-229"></a><span class="hs-comment">--</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- Naively we would generate</span><span>
</span><a name="line-231"></a><span class="hs-comment">--</span><span>
</span><a name="line-232"></a><span class="hs-comment">--    R2 = x   -- argument to f</span><span>
</span><a name="line-233"></a><span class="hs-comment">--    Sp[young(L1)] = L1</span><span>
</span><a name="line-234"></a><span class="hs-comment">--    call f returns to L1</span><span>
</span><a name="line-235"></a><span class="hs-comment">--  L1:</span><span>
</span><a name="line-236"></a><span class="hs-comment">--    z = R1</span><span>
</span><a name="line-237"></a><span class="hs-comment">--    if (z &amp; 1) then Ltrue else Lfalse</span><span>
</span><a name="line-238"></a><span class="hs-comment">--  Ltrue:</span><span>
</span><a name="line-239"></a><span class="hs-comment">--    Hp = Hp + 24</span><span>
</span><a name="line-240"></a><span class="hs-comment">--    if (Hp &gt; HpLim) then L4 else L7</span><span>
</span><a name="line-241"></a><span class="hs-comment">--  L4:</span><span>
</span><a name="line-242"></a><span class="hs-comment">--    HpAlloc = 24</span><span>
</span><a name="line-243"></a><span class="hs-comment">--    goto L5</span><span>
</span><a name="line-244"></a><span class="hs-comment">--  L5:</span><span>
</span><a name="line-245"></a><span class="hs-comment">--    R1 = z</span><span>
</span><a name="line-246"></a><span class="hs-comment">--    Sp[young(L6)] = L6</span><span>
</span><a name="line-247"></a><span class="hs-comment">--    call stg_gc_unpt_r1 returns to L6</span><span>
</span><a name="line-248"></a><span class="hs-comment">--  L6:</span><span>
</span><a name="line-249"></a><span class="hs-comment">--    z = R1</span><span>
</span><a name="line-250"></a><span class="hs-comment">--    goto L1</span><span>
</span><a name="line-251"></a><span class="hs-comment">--  L7:</span><span>
</span><a name="line-252"></a><span class="hs-comment">--    &lt;True code&gt;</span><span>
</span><a name="line-253"></a><span class="hs-comment">--  Lfalse:</span><span>
</span><a name="line-254"></a><span class="hs-comment">--    &lt;False code&gt;</span><span>
</span><a name="line-255"></a><span class="hs-comment">--</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- We want the gc call in L4 to return to L1, and discard L6.  Note</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- that not only can we share L1 and L6, but the assignment of the</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- return address in L4 is unnecessary because the return address for</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- L1 is already on the stack.  We used to catch the sharing of L1 and</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- L6 in the common-block-eliminator, but not the unnecessary return</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- address assignment.</span><span>
</span><a name="line-262"></a><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- Since this case is so common I decided to make it more explicit and</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- robust by programming the sharing directly, rather than relying on</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- the common-block eliminator to catch it.  This makes</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- common-block-elimination an optional optimisation, and furthermore</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- generates less code in the first place that we have to subsequently</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- clean up.</span><span>
</span><a name="line-269"></a><span class="hs-comment">--</span><span>
</span><a name="line-270"></a><span class="hs-comment">-- There are some rarer cases of common blocks that we don't catch</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- this way, but that's ok.  Common-block-elimination is still available</span><span>
</span><a name="line-272"></a><span class="hs-comment">-- to catch them when optimisation is enabled.  Some examples are:</span><span>
</span><a name="line-273"></a><span class="hs-comment">--</span><span>
</span><a name="line-274"></a><span class="hs-comment">--   - when both the True and False branches do a heap check, we</span><span>
</span><a name="line-275"></a><span class="hs-comment">--     can share the heap-check failure code L4a and maybe L4</span><span>
</span><a name="line-276"></a><span class="hs-comment">--</span><span>
</span><a name="line-277"></a><span class="hs-comment">--   - in a case-of-case, there might be multiple continuations that</span><span>
</span><a name="line-278"></a><span class="hs-comment">--     we can common up.</span><span>
</span><a name="line-279"></a><span class="hs-comment">--</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- It is always safe to use AssignedDirectly.  Expressions that jump</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- to the continuation from multiple places (e.g. case expressions)</span><span>
</span><a name="line-282"></a><span class="hs-comment">-- fall back to AssignedDirectly.</span><span>
</span><a name="line-283"></a><span class="hs-comment">--</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span class="hs-identifier">initCgInfoDown</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgInfoDownwards"><span class="hs-identifier hs-type">CgInfoDownwards</span></a><span>
</span><a name="line-287"></a><a name="initCgInfoDown"><a href="StgCmmMonad.html#initCgInfoDown"><span class="hs-identifier">initCgInfoDown</span></a></a><span> </span><a name="local-6989586621680699479"><a href="#local-6989586621680699479"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680699480"><a href="#local-6989586621680699480"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-288"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#MkCgInfoDown"><span class="hs-identifier hs-var">MkCgInfoDown</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgd_dflags</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699479"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-289"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_mod</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699480"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-290"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_updfr_off</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#initUpdFrameOff"><span class="hs-identifier hs-var">initUpdFrameOff</span></a><span> </span><a href="#local-6989586621680699479"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-291"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_ticky</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkTopTickyCtrLabel"><span class="hs-identifier hs-var">mkTopTickyCtrLabel</span></a><span>
</span><a name="line-292"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_sequel</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#initSequel"><span class="hs-identifier hs-var">initSequel</span></a><span>
</span><a name="line-293"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_self_loop</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-294"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_tick_scope</span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-identifier">initSequel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-297"></a><a name="initSequel"><a href="StgCmmMonad.html#initSequel"><span class="hs-identifier">initSequel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#Return"><span class="hs-identifier hs-var">Return</span></a><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-identifier">initUpdFrameOff</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span>
</span><a name="line-300"></a><a name="initUpdFrameOff"><a href="StgCmmMonad.html#initUpdFrameOff"><span class="hs-identifier">initUpdFrameOff</span></a></a><span> </span><a name="local-6989586621680699481"><a href="#local-6989586621680699481"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">widthInBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680699481"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- space for the RA</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-304"></a><span class="hs-comment">--        The code generator state</span><span>
</span><a name="line-305"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-keyword">data</span><span> </span><a name="CgState"><a href="StgCmmMonad.html#CgState"><span class="hs-identifier">CgState</span></a></a><span>
</span><a name="line-308"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="MkCgState"><a href="StgCmmMonad.html#MkCgState"><span class="hs-identifier">MkCgState</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-309"></a><span>     </span><a name="cgs_stmts"><a href="StgCmmMonad.html#cgs_stmts"><span class="hs-identifier">cgs_stmts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- Current procedure</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span>     </span><a name="cgs_tops"><a href="StgCmmMonad.html#cgs_tops"><span class="hs-identifier">cgs_tops</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">,</span><span>
</span><a name="line-312"></a><span>        </span><span class="hs-comment">-- Other procedures and data blocks in this compilation unit</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-comment">-- Both are ordered only so that we can</span><span>
</span><a name="line-314"></a><span>        </span><span class="hs-comment">-- reduce forward references, when it's easy to do so</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>     </span><a name="cgs_binds"><a href="StgCmmMonad.html#cgs_binds"><span class="hs-identifier">cgs_binds</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#CgBindings"><span class="hs-identifier hs-type">CgBindings</span></a><span class="hs-special">,</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span>     </span><a name="cgs_hp_usg"><a href="StgCmmMonad.html#cgs_hp_usg"><span class="hs-identifier">cgs_hp_usg</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span class="hs-special">,</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>     </span><a name="cgs_uniqs"><a href="StgCmmMonad.html#cgs_uniqs"><span class="hs-identifier">cgs_uniqs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-keyword">data</span><span> </span><a name="HeapUsage"><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier">HeapUsage</span></a></a><span>   </span><span class="hs-comment">-- See Note [Virtual and real heap pointers]</span><span>
</span><a name="line-323"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="HeapUsage"><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier">HeapUsage</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-324"></a><span>        </span><a name="virtHp"><a href="StgCmmMonad.html#virtHp"><span class="hs-identifier">virtHp</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- Virtual offset of highest-allocated word</span><span>
</span><a name="line-325"></a><span>                                         </span><span class="hs-comment">--   Incremented whenever we allocate</span><span>
</span><a name="line-326"></a><span>        </span><a name="realHp"><a href="StgCmmMonad.html#realHp"><span class="hs-identifier">realHp</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span>        </span><span class="hs-comment">-- realHp: Virtual offset of real heap ptr</span><span>
</span><a name="line-327"></a><span>                                         </span><span class="hs-comment">--   Used in instruction addressing modes</span><span>
</span><a name="line-328"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span class="hs-keyword">type</span><span> </span><a name="VirtualHpOffset"><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier">VirtualHpOffset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-comment">{- Note [Virtual and real heap pointers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The code generator can allocate one or more objects contiguously, performing
one heap check to cover allocation of all the objects at once.  Let's call
this little chunk of heap space an &quot;allocation chunk&quot;.  The code generator
will emit code to
  * Perform a heap-exhaustion check
  * Move the heap pointer to the end of the allocation chunk
  * Allocate multiple objects within the chunk

The code generator uses VirtualHpOffsets to address words within a
single allocation chunk; these start at one and increase positively.
The first word of the chunk has VirtualHpOffset=1, the second has
VirtualHpOffset=2, and so on.

 * The field realHp tracks (the VirtualHpOffset) where the real Hp
   register is pointing.  Typically it'll be pointing to the end of the
   allocation chunk.

 * The field virtHp gives the VirtualHpOffset of the highest-allocated
   word so far.  It starts at zero (meaning no word has been allocated),
   and increases whenever an object is allocated.

The difference between realHp and virtHp gives the offset from the
real Hp register of a particular word in the allocation chunk. This
is what getHpRelOffset does.  Since the returned offset is relative
to the real Hp register, it is valid only until you change the real
Hp register.  (Changing virtHp doesn't matter.)
-}</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span class="hs-identifier">initCgState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span>
</span><a name="line-365"></a><a name="initCgState"><a href="StgCmmMonad.html#initCgState"><span class="hs-identifier">initCgState</span></a></a><span> </span><a name="local-6989586621680699482"><a href="#local-6989586621680699482"><span class="hs-identifier">uniqs</span></a></a><span>
</span><a name="line-366"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#MkCgState"><span class="hs-identifier hs-var">MkCgState</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span>
</span><a name="line-367"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_tops</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-368"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_binds</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span>
</span><a name="line-369"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#initHpUsage"><span class="hs-identifier hs-var">initHpUsage</span></a><span>
</span><a name="line-370"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_uniqs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699482"><span class="hs-identifier hs-var">uniqs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-identifier">stateIncUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span>
</span><a name="line-373"></a><span class="hs-comment">-- stateIncUsage@ e1 e2 incorporates in e1</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- the heap high water mark found in e2.</span><span>
</span><a name="line-375"></a><a name="stateIncUsage"><a href="StgCmmMonad.html#stateIncUsage"><span class="hs-identifier">stateIncUsage</span></a></a><span> </span><a name="local-6989586621680699483"><a href="#local-6989586621680699483"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621680699484"><a href="#local-6989586621680699484"><span class="hs-identifier">s2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgCmmMonad.html#MkCgState"><span class="hs-identifier hs-var">MkCgState</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680699485"><a href="#local-6989586621680699485"><span class="hs-identifier">hp_usg</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699483"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span>  </span><a href="#local-6989586621680699483"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="StgCmmMonad.html#maxHpHw"><span class="hs-identifier hs-var">maxHpHw</span></a><span class="hs-special">`</span><span>  </span><span class="hs-identifier">virtHp</span><span> </span><a href="#local-6989586621680699485"><span class="hs-identifier hs-var">hp_usg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-377"></a><span>       </span><span class="hs-special">`</span><a href="StgCmmMonad.html#addCodeBlocksFrom"><span class="hs-identifier hs-var">addCodeBlocksFrom</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699484"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-identifier">addCodeBlocksFrom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span>
</span><a name="line-380"></a><span class="hs-comment">-- Add code blocks from the latter to the former</span><span>
</span><a name="line-381"></a><span class="hs-comment">-- (The cgs_stmts will often be empty, but not always; see codeOnly)</span><span>
</span><a name="line-382"></a><a name="local-6989586621680699486"><a href="#local-6989586621680699486"><span class="hs-identifier">s1</span></a></a><span> </span><span class="hs-special">`</span><a name="addCodeBlocksFrom"><a href="StgCmmMonad.html#addCodeBlocksFrom"><span class="hs-identifier">addCodeBlocksFrom</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621680699487"><a href="#local-6989586621680699487"><span class="hs-identifier">s2</span></a></a><span>
</span><a name="line-383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699486"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699486"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">MkGraph.&lt;*&gt;</span></a><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699487"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span>
</span><a name="line-384"></a><span>         </span><span class="hs-identifier">cgs_tops</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_tops</span><span>  </span><a href="#local-6989586621680699486"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">cgs_tops</span><span>  </span><a href="#local-6989586621680699487"><span class="hs-identifier hs-var">s2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-- The heap high water mark is the larger of virtHp and hwHp.  The latter is</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- only records the high water marks of forked-off branches, so to find the</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- heap high water mark you have to take the max of virtHp and hwHp.  Remember,</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- virtHp never retreats!</span><span>
</span><a name="line-391"></a><span class="hs-comment">--</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- Note Jan 04: ok, so why do we only look at the virtual Hp??</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span class="hs-identifier">heapHWM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span>
</span><a name="line-395"></a><a name="heapHWM"><a href="StgCmmMonad.html#heapHWM"><span class="hs-identifier">heapHWM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">virtHp</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-identifier">initHpUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span>
</span><a name="line-398"></a><a name="initHpUsage"><a href="StgCmmMonad.html#initHpUsage"><span class="hs-identifier">initHpUsage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-var">HeapUsage</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">virtHp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">realHp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span class="hs-identifier">maxHpHw</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span>
</span><a name="line-401"></a><a name="local-6989586621680699488"><a href="#local-6989586621680699488"><span class="hs-identifier">hp_usg</span></a></a><span> </span><span class="hs-special">`</span><a name="maxHpHw"><a href="StgCmmMonad.html#maxHpHw"><span class="hs-identifier">maxHpHw</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621680699489"><a href="#local-6989586621680699489"><span class="hs-identifier">hw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699488"><span class="hs-identifier hs-var">hp_usg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">virtHp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">virtHp</span><span> </span><a href="#local-6989586621680699488"><span class="hs-identifier hs-var">hp_usg</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699489"><span class="hs-identifier hs-var">hw</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-404"></a><span class="hs-comment">-- Operators for getting and setting the state and &quot;info_down&quot;.</span><span>
</span><a name="line-405"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-identifier">getState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span>
</span><a name="line-408"></a><a name="getState"><a href="StgCmmMonad.html#getState"><span class="hs-identifier">getState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680699490"><a href="#local-6989586621680699490"><span class="hs-identifier">_info_down</span></a></a><span> </span><a name="local-6989586621680699491"><a href="#local-6989586621680699491"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699491"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699491"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">setState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><a name="setState"><a href="StgCmmMonad.html#setState"><span class="hs-identifier">setState</span></a></a><span> </span><a name="local-6989586621680699492"><a href="#local-6989586621680699492"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680699493"><a href="#local-6989586621680699493"><span class="hs-identifier">_info_down</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699492"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-identifier">getHpUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span>
</span><a name="line-414"></a><a name="getHpUsage"><a href="StgCmmMonad.html#getHpUsage"><span class="hs-identifier">getHpUsage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-415"></a><span>        </span><a name="local-6989586621680699494"><a href="#local-6989586621680699494"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-416"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><a href="#local-6989586621680699494"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-identifier">setHpUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#HeapUsage"><span class="hs-identifier hs-type">HeapUsage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-419"></a><a name="setHpUsage"><a href="StgCmmMonad.html#setHpUsage"><span class="hs-identifier">setHpUsage</span></a></a><span> </span><a name="local-6989586621680699495"><a href="#local-6989586621680699495"><span class="hs-identifier">new_hp_usg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-420"></a><span>        </span><a name="local-6989586621680699496"><a href="#local-6989586621680699496"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-421"></a><span>        </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699496"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cgs_hp_usg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699495"><span class="hs-identifier hs-var">new_hp_usg</span></a><span class="hs-special">}</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-identifier">setVirtHp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-424"></a><a name="setVirtHp"><a href="StgCmmMonad.html#setVirtHp"><span class="hs-identifier">setVirtHp</span></a></a><span> </span><a name="local-6989586621680699497"><a href="#local-6989586621680699497"><span class="hs-identifier">new_virtHp</span></a></a><span>
</span><a name="line-425"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699498"><a href="#local-6989586621680699498"><span class="hs-identifier">hp_usage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getHpUsage"><span class="hs-identifier hs-var">getHpUsage</span></a><span>
</span><a name="line-426"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setHpUsage"><span class="hs-identifier hs-var">setHpUsage</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699498"><span class="hs-identifier hs-var">hp_usage</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">virtHp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699497"><span class="hs-identifier hs-var">new_virtHp</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span class="hs-identifier">getVirtHp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span>
</span><a name="line-429"></a><a name="getVirtHp"><a href="StgCmmMonad.html#getVirtHp"><span class="hs-identifier">getVirtHp</span></a></a><span>
</span><a name="line-430"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699499"><a href="#local-6989586621680699499"><span class="hs-identifier">hp_usage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getHpUsage"><span class="hs-identifier hs-var">getHpUsage</span></a><span>
</span><a name="line-431"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">virtHp</span><span> </span><a href="#local-6989586621680699499"><span class="hs-identifier hs-var">hp_usage</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-identifier">setRealHp</span><span> </span><span class="hs-glyph">::</span><span>  </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><a name="setRealHp"><a href="StgCmmMonad.html#setRealHp"><span class="hs-identifier">setRealHp</span></a></a><span> </span><a name="local-6989586621680699500"><a href="#local-6989586621680699500"><span class="hs-identifier">new_realHp</span></a></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699501"><a href="#local-6989586621680699501"><span class="hs-identifier">hp_usage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getHpUsage"><span class="hs-identifier hs-var">getHpUsage</span></a><span>
</span><a name="line-436"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setHpUsage"><span class="hs-identifier hs-var">setHpUsage</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699501"><span class="hs-identifier hs-var">hp_usage</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">realHp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699500"><span class="hs-identifier hs-var">new_realHp</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-identifier">getBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#CgBindings"><span class="hs-identifier hs-type">CgBindings</span></a><span>
</span><a name="line-439"></a><a name="getBinds"><a href="StgCmmMonad.html#getBinds"><span class="hs-identifier">getBinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-440"></a><span>        </span><a name="local-6989586621680699502"><a href="#local-6989586621680699502"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-441"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><a href="#local-6989586621680699502"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-identifier">setBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#CgBindings"><span class="hs-identifier hs-type">CgBindings</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-444"></a><a name="setBinds"><a href="StgCmmMonad.html#setBinds"><span class="hs-identifier">setBinds</span></a></a><span> </span><a name="local-6989586621680699503"><a href="#local-6989586621680699503"><span class="hs-identifier">new_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-445"></a><span>        </span><a name="local-6989586621680699504"><a href="#local-6989586621680699504"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-446"></a><span>        </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699504"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cgs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699503"><span class="hs-identifier hs-var">new_binds</span></a><span class="hs-special">}</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">withState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699466"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699466"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#CgState"><span class="hs-identifier hs-type">CgState</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><a name="withState"><a href="StgCmmMonad.html#withState"><span class="hs-identifier">withState</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><a name="local-6989586621680699505"><a href="#local-6989586621680699505"><span class="hs-identifier">fcode</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680699506"><a href="#local-6989586621680699506"><span class="hs-identifier">newstate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680699507"><a href="#local-6989586621680699507"><span class="hs-identifier">info_down</span></a></a><span> </span><a name="local-6989586621680699508"><a href="#local-6989586621680699508"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-450"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680699505"><span class="hs-identifier hs-var">fcode</span></a><span> </span><a href="#local-6989586621680699507"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699506"><span class="hs-identifier hs-var">newstate</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-451"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680699509"><a href="#local-6989586621680699509"><span class="hs-identifier">retval</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699510"><a href="#local-6989586621680699510"><span class="hs-identifier">state2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621680699509"><span class="hs-identifier hs-var">retval</span></a><span class="hs-special">,</span><a href="#local-6989586621680699510"><span class="hs-identifier hs-var">state2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699508"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-identifier">newUniqSupply</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-454"></a><a name="newUniqSupply"><a href="StgCmmMonad.html#newUniqSupply"><span class="hs-identifier">newUniqSupply</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-455"></a><span>        </span><a name="local-6989586621680699511"><a href="#local-6989586621680699511"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-456"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699512"><a href="#local-6989586621680699512"><span class="hs-identifier">us1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699513"><a href="#local-6989586621680699513"><span class="hs-identifier">us2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitUniqSupply</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgs_uniqs</span><span> </span><a href="#local-6989586621680699511"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>        </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699511"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_uniqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699512"><span class="hs-identifier hs-var">us1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-458"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680699513"><span class="hs-identifier hs-var">us2</span></a><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span class="hs-identifier">newUnique</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Unique</span><span>
</span><a name="line-461"></a><a name="newUnique"><a href="StgCmmMonad.html#newUnique"><span class="hs-identifier">newUnique</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-462"></a><span>        </span><a name="local-6989586621680699514"><a href="#local-6989586621680699514"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-463"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699515"><a href="#local-6989586621680699515"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><a name="local-6989586621680699516"><a href="#local-6989586621680699516"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgs_uniqs</span><span> </span><a href="#local-6989586621680699514"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>        </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699514"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_uniqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699516"><span class="hs-identifier hs-var">us'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-465"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680699515"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-468"></a><span class="hs-identifier">getInfoDown</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#CgInfoDownwards"><span class="hs-identifier hs-type">CgInfoDownwards</span></a><span>
</span><a name="line-469"></a><a name="getInfoDown"><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier">getInfoDown</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680699517"><a href="#local-6989586621680699517"><span class="hs-identifier">info_down</span></a></a><span> </span><a name="local-6989586621680699518"><a href="#local-6989586621680699518"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699517"><span class="hs-identifier hs-var">info_down</span></a><span class="hs-special">,</span><a href="#local-6989586621680699518"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span class="hs-identifier">getSelfLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="StgCmmClosure.html#SelfLoopInfo"><span class="hs-identifier hs-type">SelfLoopInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><a name="getSelfLoop"><a href="StgCmmMonad.html#getSelfLoop"><span class="hs-identifier">getSelfLoop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-473"></a><span>        </span><a name="local-6989586621680699519"><a href="#local-6989586621680699519"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">cgd_self_loop</span><span> </span><a href="#local-6989586621680699519"><span class="hs-identifier hs-var">info_down</span></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-identifier">withSelfLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#SelfLoopInfo"><span class="hs-identifier hs-type">SelfLoopInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699465"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699465"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-477"></a><a name="withSelfLoop"><a href="StgCmmMonad.html#withSelfLoop"><span class="hs-identifier">withSelfLoop</span></a></a><span> </span><a name="local-6989586621680699520"><a href="#local-6989586621680699520"><span class="hs-identifier">self_loop</span></a></a><span> </span><a name="local-6989586621680699521"><a href="#local-6989586621680699521"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-478"></a><span>        </span><a name="local-6989586621680699522"><a href="#local-6989586621680699522"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-479"></a><span>        </span><a href="StgCmmMonad.html#withInfoDown"><span class="hs-identifier hs-var">withInfoDown</span></a><span> </span><a href="#local-6989586621680699521"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699522"><span class="hs-identifier hs-var">info_down</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cgd_self_loop</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680699520"><span class="hs-identifier hs-var">self_loop</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasDynFlags</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-482"></a><span>    </span><a name="local-8214565720323804398"><span class="hs-identifier">getDynFlags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier">cgd_dflags</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-identifier">getThisPackage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">UnitId</span><span>
</span><a name="line-485"></a><a name="getThisPackage"><a href="StgCmmMonad.html#getThisPackage"><span class="hs-identifier">getThisPackage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-identifier">withInfoDown</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699464"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#CgInfoDownwards"><span class="hs-identifier hs-type">CgInfoDownwards</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699464"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-488"></a><a name="withInfoDown"><a href="StgCmmMonad.html#withInfoDown"><span class="hs-identifier">withInfoDown</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><a name="local-6989586621680699523"><a href="#local-6989586621680699523"><span class="hs-identifier">fcode</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680699524"><a href="#local-6989586621680699524"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-var">FCode</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680699525"><a href="#local-6989586621680699525"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680699523"><span class="hs-identifier hs-var">fcode</span></a><span> </span><a href="#local-6989586621680699524"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699525"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- Get the current module name</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-identifier">getModuleName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-494"></a><a name="getModuleName"><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier">getModuleName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699526"><a href="#local-6989586621680699526"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgd_mod</span><span> </span><a href="#local-6989586621680699526"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- Get/set the end-of-block info</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-identifier">withSequel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699463"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699463"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-500"></a><a name="withSequel"><a href="StgCmmMonad.html#withSequel"><span class="hs-identifier">withSequel</span></a></a><span> </span><a name="local-6989586621680699527"><a href="#local-6989586621680699527"><span class="hs-identifier">sequel</span></a></a><span> </span><a name="local-6989586621680699528"><a href="#local-6989586621680699528"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-501"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699529"><a href="#local-6989586621680699529"><span class="hs-identifier">info</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-502"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#withInfoDown"><span class="hs-identifier hs-var">withInfoDown</span></a><span> </span><a href="#local-6989586621680699528"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699529"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cgd_sequel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699527"><span class="hs-identifier hs-var">sequel</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_self_loop</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-identifier">getSequel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#Sequel"><span class="hs-identifier hs-type">Sequel</span></a><span>
</span><a name="line-505"></a><a name="getSequel"><a href="StgCmmMonad.html#getSequel"><span class="hs-identifier">getSequel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699530"><a href="#local-6989586621680699530"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-506"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgd_sequel</span><span> </span><a href="#local-6989586621680699530"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- Get/set the size of the update frame</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-comment">-- We keep track of the size of the update frame so that we</span><span>
</span><a name="line-512"></a><span class="hs-comment">-- can set the stack pointer to the proper address on return</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- (or tail call) from the closure.</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- There should be at most one update frame for each closure.</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- Note: I'm including the size of the original return address</span><span>
</span><a name="line-516"></a><span class="hs-comment">-- in the size of the update frame -- hence the default case on `get'.</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-identifier">withUpdFrameOff</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699462"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699462"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-519"></a><a name="withUpdFrameOff"><a href="StgCmmMonad.html#withUpdFrameOff"><span class="hs-identifier">withUpdFrameOff</span></a></a><span> </span><a name="local-6989586621680699531"><a href="#local-6989586621680699531"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621680699532"><a href="#local-6989586621680699532"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699533"><a href="#local-6989586621680699533"><span class="hs-identifier">info</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-521"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#withInfoDown"><span class="hs-identifier hs-var">withInfoDown</span></a><span> </span><a href="#local-6989586621680699532"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699533"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cgd_updfr_off</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699531"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">getUpdFrameOff</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span>
</span><a name="line-524"></a><a name="getUpdFrameOff"><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier">getUpdFrameOff</span></a></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699534"><a href="#local-6989586621680699534"><span class="hs-identifier">info</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-526"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">cgd_updfr_off</span><span> </span><a href="#local-6989586621680699534"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- Get/set the current ticky counter label</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span class="hs-identifier">getTickyCtrLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-532"></a><a name="getTickyCtrLabel"><a href="StgCmmMonad.html#getTickyCtrLabel"><span class="hs-identifier">getTickyCtrLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-533"></a><span>        </span><a name="local-6989586621680699535"><a href="#local-6989586621680699535"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-534"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgd_ticky</span><span> </span><a href="#local-6989586621680699535"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span class="hs-identifier">setTickyCtrLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699461"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699461"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-537"></a><a name="setTickyCtrLabel"><a href="StgCmmMonad.html#setTickyCtrLabel"><span class="hs-identifier">setTickyCtrLabel</span></a></a><span> </span><a name="local-6989586621680699536"><a href="#local-6989586621680699536"><span class="hs-identifier">ticky</span></a></a><span> </span><a name="local-6989586621680699537"><a href="#local-6989586621680699537"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-538"></a><span>        </span><a name="local-6989586621680699538"><a href="#local-6989586621680699538"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-539"></a><span>        </span><a href="StgCmmMonad.html#withInfoDown"><span class="hs-identifier hs-var">withInfoDown</span></a><span> </span><a href="#local-6989586621680699537"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699538"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cgd_ticky</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699536"><span class="hs-identifier hs-var">ticky</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-542"></a><span class="hs-comment">-- Manage tick scopes</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-comment">-- | The current tick scope. We will assign this to generated blocks.</span><span>
</span><a name="line-545"></a><span class="hs-identifier">getTickScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span>
</span><a name="line-546"></a><a name="getTickScope"><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier">getTickScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-547"></a><span>        </span><a name="local-6989586621680699539"><a href="#local-6989586621680699539"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-548"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgd_tick_scope</span><span> </span><a href="#local-6989586621680699539"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span class="hs-comment">-- | Places blocks generated by the given code into a fresh</span><span>
</span><a name="line-551"></a><span class="hs-comment">-- (sub-)scope. This will make sure that Cmm annotations in our scope</span><span>
</span><a name="line-552"></a><span class="hs-comment">-- will apply to the Cmm blocks generated therein - but not the other</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- way around.</span><span>
</span><a name="line-554"></a><span class="hs-identifier">tickScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699460"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699460"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-555"></a><a name="tickScope"><a href="StgCmmMonad.html#tickScope"><span class="hs-identifier">tickScope</span></a></a><span> </span><a name="local-6989586621680699540"><a href="#local-6989586621680699540"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-556"></a><span>        </span><a name="local-6989586621680699541"><a href="#local-6989586621680699541"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-557"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgd_dflags</span><span> </span><a href="#local-6989586621680699541"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680699540"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-558"></a><span>          </span><a name="local-6989586621680699542"><a href="#local-6989586621680699542"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-559"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680699543"><a href="#local-6989586621680699543"><span class="hs-identifier">scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a href="#local-6989586621680699542"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgd_tick_scope</span><span> </span><a href="#local-6989586621680699541"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>          </span><a href="StgCmmMonad.html#withInfoDown"><span class="hs-identifier hs-var">withInfoDown</span></a><span> </span><a href="#local-6989586621680699540"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="#local-6989586621680699541"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgd_tick_scope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699543"><span class="hs-identifier hs-var">scope'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-564"></a><span class="hs-comment">--                 Forking</span><span>
</span><a name="line-565"></a><span class="hs-comment">--------------------------------------------------------</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-identifier">forkClosureBody</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span class="hs-comment">-- forkClosureBody compiles body_code in environment where:</span><span>
</span><a name="line-569"></a><span class="hs-comment">--   - sequel, update stack frame and self loop info are</span><span>
</span><a name="line-570"></a><span class="hs-comment">--     set to fresh values</span><span>
</span><a name="line-571"></a><span class="hs-comment">--   - state is set to a fresh value, except for local bindings</span><span>
</span><a name="line-572"></a><span class="hs-comment">--     that are passed in unchanged. It's up to the enclosed code to</span><span>
</span><a name="line-573"></a><span class="hs-comment">--     re-bind the free variables to a field of the closure.</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><a name="forkClosureBody"><a href="StgCmmMonad.html#forkClosureBody"><span class="hs-identifier">forkClosureBody</span></a></a><span> </span><a name="local-6989586621680699544"><a href="#local-6989586621680699544"><span class="hs-identifier">body_code</span></a></a><span>
</span><a name="line-576"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699545"><a href="#local-6989586621680699545"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-577"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699546"><a href="#local-6989586621680699546"><span class="hs-identifier">info</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-578"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699547"><a href="#local-6989586621680699547"><span class="hs-identifier">us</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#newUniqSupply"><span class="hs-identifier hs-var">newUniqSupply</span></a><span>
</span><a name="line-579"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699548"><a href="#local-6989586621680699548"><span class="hs-identifier">state</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-580"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680699549"><a href="#local-6989586621680699549"><span class="hs-identifier">body_info_down</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699546"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgd_sequel</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#initSequel"><span class="hs-identifier hs-var">initSequel</span></a><span>
</span><a name="line-581"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_updfr_off</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#initUpdFrameOff"><span class="hs-identifier hs-var">initUpdFrameOff</span></a><span> </span><a href="#local-6989586621680699545"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-582"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgd_self_loop</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-583"></a><span>              </span><a name="local-6989586621680699550"><a href="#local-6989586621680699550"><span class="hs-identifier">fork_state_in</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initCgState"><span class="hs-identifier hs-var">initCgState</span></a><span> </span><a href="#local-6989586621680699547"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><a href="#local-6989586621680699548"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-584"></a><span>              </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><a name="local-6989586621680699551"><a href="#local-6989586621680699551"><span class="hs-identifier">fork_state_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><a href="#local-6989586621680699544"><span class="hs-identifier hs-var">body_code</span></a><span> </span><a href="#local-6989586621680699549"><span class="hs-identifier hs-var">body_info_down</span></a><span> </span><a href="#local-6989586621680699550"><span class="hs-identifier hs-var">fork_state_in</span></a><span>
</span><a name="line-585"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699548"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><a href="StgCmmMonad.html#addCodeBlocksFrom"><span class="hs-identifier hs-var">addCodeBlocksFrom</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699551"><span class="hs-identifier hs-var">fork_state_out</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-identifier">forkLneBody</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699459"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699459"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-588"></a><span class="hs-comment">-- 'forkLneBody' takes a body of let-no-escape binding and compiles</span><span>
</span><a name="line-589"></a><span class="hs-comment">-- it in the *current* environment, returning the graph thus constructed.</span><span>
</span><a name="line-590"></a><span class="hs-comment">--</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- The current environment is passed on completely unchanged to</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- the successor.  In particular, any heap usage from the enclosed</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- code is discarded; it should deal with its own heap consumption.</span><span>
</span><a name="line-594"></a><a name="forkLneBody"><a href="StgCmmMonad.html#forkLneBody"><span class="hs-identifier">forkLneBody</span></a></a><span> </span><a name="local-6989586621680699552"><a href="#local-6989586621680699552"><span class="hs-identifier">body_code</span></a></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699553"><a href="#local-6989586621680699553"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-596"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699554"><a href="#local-6989586621680699554"><span class="hs-identifier">us</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#newUniqSupply"><span class="hs-identifier hs-var">newUniqSupply</span></a><span>
</span><a name="line-597"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699555"><a href="#local-6989586621680699555"><span class="hs-identifier">state</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-598"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680699556"><a href="#local-6989586621680699556"><span class="hs-identifier">fork_state_in</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initCgState"><span class="hs-identifier hs-var">initCgState</span></a><span> </span><a href="#local-6989586621680699554"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><a href="#local-6989586621680699555"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-599"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621680699557"><a href="#local-6989586621680699557"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699558"><a href="#local-6989586621680699558"><span class="hs-identifier">fork_state_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><a href="#local-6989586621680699552"><span class="hs-identifier hs-var">body_code</span></a><span> </span><a href="#local-6989586621680699553"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699556"><span class="hs-identifier hs-var">fork_state_in</span></a><span>
</span><a name="line-600"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699555"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><a href="StgCmmMonad.html#addCodeBlocksFrom"><span class="hs-identifier hs-var">addCodeBlocksFrom</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699558"><span class="hs-identifier hs-var">fork_state_out</span></a><span>
</span><a name="line-601"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680699557"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-identifier">codeOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span class="hs-comment">-- Emit any code from the inner thing into the outer thing</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- Do not affect anything else in the outer state</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- Used in almost-circular code to prevent false loop dependencies</span><span>
</span><a name="line-607"></a><a name="codeOnly"><a href="StgCmmMonad.html#codeOnly"><span class="hs-identifier">codeOnly</span></a></a><span> </span><a name="local-6989586621680699559"><a href="#local-6989586621680699559"><span class="hs-identifier">body_code</span></a></a><span>
</span><a name="line-608"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699560"><a href="#local-6989586621680699560"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-609"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699561"><a href="#local-6989586621680699561"><span class="hs-identifier">us</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#newUniqSupply"><span class="hs-identifier hs-var">newUniqSupply</span></a><span>
</span><a name="line-610"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699562"><a href="#local-6989586621680699562"><span class="hs-identifier">state</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-611"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621680699563"><a href="#local-6989586621680699563"><span class="hs-identifier">fork_state_in</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initCgState"><span class="hs-identifier hs-var">initCgState</span></a><span> </span><a href="#local-6989586621680699561"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_binds</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><a href="#local-6989586621680699562"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-612"></a><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><a href="#local-6989586621680699562"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-613"></a><span>                </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680699564"><a href="#local-6989586621680699564"><span class="hs-identifier">fork_state_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><a href="#local-6989586621680699559"><span class="hs-identifier hs-var">body_code</span></a><span> </span><a href="#local-6989586621680699560"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699563"><span class="hs-identifier hs-var">fork_state_in</span></a><span>
</span><a name="line-614"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699562"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><a href="StgCmmMonad.html#addCodeBlocksFrom"><span class="hs-identifier hs-var">addCodeBlocksFrom</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699564"><span class="hs-identifier hs-var">fork_state_out</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-identifier">forkAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699458"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680699458"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-617"></a><span class="hs-comment">-- (forkAlts' bs d) takes fcodes 'bs' for the branches of a 'case', and</span><span>
</span><a name="line-618"></a><span class="hs-comment">-- an fcode for the default case 'd', and compiles each in the current</span><span>
</span><a name="line-619"></a><span class="hs-comment">-- environment.  The current environment is passed on unmodified, except</span><span>
</span><a name="line-620"></a><span class="hs-comment">-- that the virtual Hp is moved on to the worst virtual Hp for the branches</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><a name="forkAlts"><a href="StgCmmMonad.html#forkAlts"><span class="hs-identifier">forkAlts</span></a></a><span> </span><a name="local-6989586621680699565"><a href="#local-6989586621680699565"><span class="hs-identifier">branch_fcodes</span></a></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699566"><a href="#local-6989586621680699566"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-624"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699567"><a href="#local-6989586621680699567"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#newUniqSupply"><span class="hs-identifier hs-var">newUniqSupply</span></a><span>
</span><a name="line-625"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699568"><a href="#local-6989586621680699568"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-626"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680699569"><a href="#local-6989586621680699569"><span class="hs-identifier">compile</span></a></a><span> </span><a name="local-6989586621680699574"><a href="#local-6989586621680699574"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621680699575"><a href="#local-6989586621680699575"><span class="hs-identifier">branch</span></a></a><span>
</span><a name="line-627"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699577"><span class="hs-identifier hs-var">us2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><a href="#local-6989586621680699575"><span class="hs-identifier hs-var">branch</span></a><span> </span><a href="#local-6989586621680699566"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699578"><span class="hs-identifier hs-var">branch_state</span></a><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-629"></a><span>                  </span><span class="hs-special">(</span><a name="local-6989586621680699576"><a href="#local-6989586621680699576"><span class="hs-identifier">us1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680699577"><a href="#local-6989586621680699577"><span class="hs-identifier">us2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitUniqSupply</span><span> </span><a href="#local-6989586621680699574"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-630"></a><span>                  </span><a name="local-6989586621680699578"><a href="#local-6989586621680699578"><span class="hs-identifier">branch_state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initCgState"><span class="hs-identifier hs-var">initCgState</span></a><span> </span><a href="#local-6989586621680699576"><span class="hs-identifier hs-var">us1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-631"></a><span>                                        </span><span class="hs-identifier">cgs_binds</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_binds</span><span> </span><a href="#local-6989586621680699568"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-632"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><a href="#local-6989586621680699568"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-633"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621680699570"><a href="#local-6989586621680699570"><span class="hs-identifier">_us</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699571"><a href="#local-6989586621680699571"><span class="hs-identifier">results</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621680699569"><span class="hs-identifier hs-var">compile</span></a><span> </span><a href="#local-6989586621680699567"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621680699565"><span class="hs-identifier hs-var">branch_fcodes</span></a><span>
</span><a name="line-634"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621680699572"><a href="#local-6989586621680699572"><span class="hs-identifier">branch_results</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699573"><a href="#local-6989586621680699573"><span class="hs-identifier">branch_out_states</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680699571"><span class="hs-identifier hs-var">results</span></a><span>
</span><a name="line-635"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="StgCmmMonad.html#stateIncUsage"><span class="hs-identifier hs-var">stateIncUsage</span></a><span> </span><a href="#local-6989586621680699568"><span class="hs-identifier hs-var">state</span></a><span> </span><a href="#local-6989586621680699573"><span class="hs-identifier hs-var">branch_out_states</span></a><span>
</span><a name="line-636"></a><span>                </span><span class="hs-comment">-- NB foldl.  state is the *left* argument to stateIncUsage</span><span>
</span><a name="line-637"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680699572"><span class="hs-identifier hs-var">branch_results</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span class="hs-identifier">forkAltPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699457"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699457"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699457"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621680699457"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span class="hs-comment">-- Most common use of 'forkAlts'; having this helper function avoids</span><span>
</span><a name="line-641"></a><span class="hs-comment">-- accidental use of failible pattern-matches in @do@-notation</span><span>
</span><a name="line-642"></a><a name="forkAltPair"><a href="StgCmmMonad.html#forkAltPair"><span class="hs-identifier">forkAltPair</span></a></a><span> </span><a name="local-6989586621680699579"><a href="#local-6989586621680699579"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621680699580"><a href="#local-6989586621680699580"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-643"></a><span>  </span><a name="local-6989586621680699581"><a href="#local-6989586621680699581"><span class="hs-identifier">xy'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#forkAlts"><span class="hs-identifier hs-var">forkAlts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680699579"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621680699580"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">]</span><span>
</span><a name="line-644"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680699581"><span class="hs-identifier hs-var">xy'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-645"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621680699582"><a href="#local-6989586621680699582"><span class="hs-identifier">x'</span></a></a><span class="hs-special">,</span><a name="local-6989586621680699583"><a href="#local-6989586621680699583"><span class="hs-identifier">y'</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699582"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><a href="#local-6989586621680699583"><span class="hs-identifier hs-var">y'</span></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;forkAltPair&quot;</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span class="hs-comment">-- collect the code emitted by an FCode computation</span><span>
</span><a name="line-649"></a><span class="hs-identifier">getCodeR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699456"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699456"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span class="hs-special">)</span><span>
</span><a name="line-650"></a><a name="getCodeR"><a href="StgCmmMonad.html#getCodeR"><span class="hs-identifier">getCodeR</span></a></a><span> </span><a name="local-6989586621680699584"><a href="#local-6989586621680699584"><span class="hs-identifier">fcode</span></a></a><span>
</span><a name="line-651"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699585"><a href="#local-6989586621680699585"><span class="hs-identifier">state1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-652"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699586"><a href="#local-6989586621680699586"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699587"><a href="#local-6989586621680699587"><span class="hs-identifier">state2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#withState"><span class="hs-identifier hs-var">withState</span></a><span> </span><a href="#local-6989586621680699584"><span class="hs-identifier hs-var">fcode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699585"><span class="hs-identifier hs-var">state1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699587"><span class="hs-identifier hs-var">state2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699585"><span class="hs-identifier hs-var">state1</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-654"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699586"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699587"><span class="hs-identifier hs-var">state2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-identifier">getCode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699455"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-657"></a><a name="getCode"><a href="StgCmmMonad.html#getCode"><span class="hs-identifier">getCode</span></a></a><span> </span><a name="local-6989586621680699588"><a href="#local-6989586621680699588"><span class="hs-identifier">fcode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680699589"><a href="#local-6989586621680699589"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getCodeR"><span class="hs-identifier hs-var">getCodeR</span></a><span> </span><a href="#local-6989586621680699588"><span class="hs-identifier hs-var">fcode</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680699589"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-658"></a><span>
</span><a name="line-659"></a><span class="hs-comment">-- | Generate code into a fresh tick (sub-)scope and gather generated code</span><span>
</span><a name="line-660"></a><span class="hs-identifier">getCodeScoped</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699454"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699454"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span class="hs-special">)</span><span>
</span><a name="line-661"></a><a name="getCodeScoped"><a href="StgCmmMonad.html#getCodeScoped"><span class="hs-identifier">getCodeScoped</span></a></a><span> </span><a name="local-6989586621680699590"><a href="#local-6989586621680699590"><span class="hs-identifier">fcode</span></a></a><span>
</span><a name="line-662"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699591"><a href="#local-6989586621680699591"><span class="hs-identifier">state1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-663"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680699594"><a href="#local-6989586621680699594"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699595"><a href="#local-6989586621680699595"><span class="hs-identifier">tscope</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680699596"><a href="#local-6989586621680699596"><span class="hs-identifier">state2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-664"></a><span>            </span><a href="StgCmmMonad.html#tickScope"><span class="hs-identifier hs-var">tickScope</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-665"></a><span>            </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="StgCmmMonad.html#withState"><span class="hs-identifier hs-var">withState</span></a><span> </span><a href="#local-6989586621680699591"><span class="hs-identifier hs-var">state1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-666"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699592"><a href="#local-6989586621680699592"><span class="hs-identifier">a</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680699590"><span class="hs-identifier hs-var">fcode</span></a><span>
</span><a name="line-667"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699593"><a href="#local-6989586621680699593"><span class="hs-identifier">scp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-668"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699592"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699593"><span class="hs-identifier hs-var">scp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-669"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699596"><span class="hs-identifier hs-var">state2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699591"><span class="hs-identifier hs-var">state1</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-670"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699594"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699596"><span class="hs-identifier hs-var">state2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699595"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-comment">-- 'getHeapUsage' applies a function to the amount of heap that it uses.</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- It initialises the heap usage to zeros, and passes on an unchanged</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- heap usage.</span><span>
</span><a name="line-676"></a><span class="hs-comment">--</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- It is usually a prelude to performing a GC check, so everything must</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- be in a tidy and consistent state.</span><span>
</span><a name="line-679"></a><span class="hs-comment">--</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- Note the slightly subtle fixed point behaviour needed here</span><span>
</span><a name="line-681"></a><span>
</span><a name="line-682"></a><span class="hs-identifier">getHeapUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699453"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680699453"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-683"></a><a name="getHeapUsage"><a href="StgCmmMonad.html#getHeapUsage"><span class="hs-identifier">getHeapUsage</span></a></a><span> </span><a name="local-6989586621680699597"><a href="#local-6989586621680699597"><span class="hs-identifier">fcode</span></a></a><span>
</span><a name="line-684"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699598"><a href="#local-6989586621680699598"><span class="hs-identifier">info_down</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getInfoDown"><span class="hs-identifier hs-var">getInfoDown</span></a><span>
</span><a name="line-685"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699599"><a href="#local-6989586621680699599"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-686"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621680699600"><a href="#local-6989586621680699600"><span class="hs-identifier">fstate_in</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699599"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#initHpUsage"><span class="hs-identifier hs-var">initHpUsage</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-687"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621680699601"><a href="#local-6989586621680699601"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699602"><a href="#local-6989586621680699602"><span class="hs-identifier">fstate_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">doFCode</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699597"><span class="hs-identifier hs-var">fcode</span></a><span> </span><a href="#local-6989586621680699603"><span class="hs-identifier hs-var">hp_hw</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680699598"><span class="hs-identifier hs-var">info_down</span></a><span> </span><a href="#local-6989586621680699600"><span class="hs-identifier hs-var">fstate_in</span></a><span>
</span><a name="line-688"></a><span>                </span><a name="local-6989586621680699603"><a href="#local-6989586621680699603"><span class="hs-identifier">hp_hw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#heapHWM"><span class="hs-identifier hs-var">heapHWM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgs_hp_usg</span><span> </span><a href="#local-6989586621680699602"><span class="hs-identifier hs-var">fstate_out</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Loop here!</span><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699602"><span class="hs-identifier hs-var">fstate_out</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_hp_usg</span><span> </span><a href="#local-6989586621680699599"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-691"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680699601"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-694"></a><span class="hs-comment">-- Combinators for emitting code</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span class="hs-identifier">emitCgStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkGraph.html#CgStmt"><span class="hs-identifier hs-type">CgStmt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-697"></a><a name="emitCgStmt"><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier">emitCgStmt</span></a></a><span> </span><a name="local-6989586621680699604"><a href="#local-6989586621680699604"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699605"><a href="#local-6989586621680699605"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-699"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699605"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699605"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699604"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-700"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span class="hs-identifier">emitLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-703"></a><a name="emitLabel"><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier">emitLabel</span></a></a><span> </span><a name="local-6989586621680699606"><a href="#local-6989586621680699606"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680699607"><a href="#local-6989586621680699607"><span class="hs-identifier">tscope</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-704"></a><span>                  </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#CgLabel"><span class="hs-identifier hs-var">CgLabel</span></a><span> </span><a href="#local-6989586621680699606"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680699607"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-identifier">emitComment</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-707"></a><a name="emitComment"><a href="StgCmmMonad.html#emitComment"><span class="hs-identifier">emitComment</span></a></a><span> </span><a name="local-6989586621680699608"><a href="#local-6989586621680699608"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-708"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#CgStmt"><span class="hs-identifier hs-var">CgStmt</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmComment"><span class="hs-identifier hs-var">CmmComment</span></a><span> </span><a href="#local-6989586621680699608"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-709"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span class="hs-identifier">emitTick</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmTickish"><span class="hs-identifier hs-type">CmmTickish</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-712"></a><a name="emitTick"><a href="StgCmmMonad.html#emitTick"><span class="hs-identifier">emitTick</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="MkGraph.html#CgStmt"><span class="hs-identifier hs-var">CgStmt</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmNode.html#CmmTick"><span class="hs-identifier hs-var">CmmTick</span></a><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span class="hs-identifier">emitUnwind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-715"></a><a name="emitUnwind"><a href="StgCmmMonad.html#emitUnwind"><span class="hs-identifier">emitUnwind</span></a></a><span> </span><a name="local-6989586621680699609"><a href="#local-6989586621680699609"><span class="hs-identifier">regs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-716"></a><span>  </span><a name="local-6989586621680699610"><a href="#local-6989586621680699610"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-717"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621680699610"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-718"></a><span>     </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#CgStmt"><span class="hs-identifier hs-var">CgStmt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><a href="#local-6989586621680699609"><span class="hs-identifier hs-var">regs</span></a><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-identifier">emitAssign</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-type">CmmReg</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-721"></a><a name="emitAssign"><a href="StgCmmMonad.html#emitAssign"><span class="hs-identifier">emitAssign</span></a></a><span> </span><a name="local-6989586621680699611"><a href="#local-6989586621680699611"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680699612"><a href="#local-6989586621680699612"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#CgStmt"><span class="hs-identifier hs-var">CgStmt</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a href="#local-6989586621680699611"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680699612"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-identifier">emitStore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-724"></a><a name="emitStore"><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier">emitStore</span></a></a><span> </span><a name="local-6989586621680699613"><a href="#local-6989586621680699613"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680699614"><a href="#local-6989586621680699614"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#CgStmt"><span class="hs-identifier hs-var">CgStmt</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a href="#local-6989586621680699613"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680699614"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-identifier">emit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-727"></a><a name="emit"><a href="StgCmmMonad.html#emit"><span class="hs-identifier">emit</span></a></a><span> </span><a name="local-6989586621680699615"><a href="#local-6989586621680699615"><span class="hs-identifier">ag</span></a></a><span>
</span><a name="line-728"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699616"><a href="#local-6989586621680699616"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-729"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699616"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_stmts</span><span> </span><a href="#local-6989586621680699616"><span class="hs-identifier hs-var">state</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">MkGraph.&lt;*&gt;</span></a><span> </span><a href="#local-6989586621680699615"><span class="hs-identifier hs-var">ag</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-identifier">emitDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><a name="emitDecl"><a href="StgCmmMonad.html#emitDecl"><span class="hs-identifier">emitDecl</span></a></a><span> </span><a name="local-6989586621680699617"><a href="#local-6989586621680699617"><span class="hs-identifier">decl</span></a></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699618"><a href="#local-6989586621680699618"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-734"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699618"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><a href="#local-6989586621680699618"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699617"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span class="hs-identifier">emitOutOfLine</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-737"></a><a name="emitOutOfLine"><a href="StgCmmMonad.html#emitOutOfLine"><span class="hs-identifier">emitOutOfLine</span></a></a><span> </span><a name="local-6989586621680699619"><a href="#local-6989586621680699619"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680699620"><a href="#local-6989586621680699620"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699621"><a href="#local-6989586621680699621"><span class="hs-identifier">tscope</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitCgStmt"><span class="hs-identifier hs-var">emitCgStmt</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#CgFork"><span class="hs-identifier hs-var">CgFork</span></a><span> </span><a href="#local-6989586621680699619"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680699620"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621680699621"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span class="hs-identifier">emitProcWithStackFrame</span><span>
</span><a name="line-740"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#Convention"><span class="hs-identifier hs-type">Convention</span></a><span>                        </span><span class="hs-comment">-- entry convention</span><span>
</span><a name="line-741"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>                </span><span class="hs-comment">-- info table?</span><span>
</span><a name="line-742"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>                            </span><span class="hs-comment">-- label for the proc</span><span>
</span><a name="line-743"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span>                       </span><span class="hs-comment">-- stack frame</span><span>
</span><a name="line-744"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span>                       </span><span class="hs-comment">-- arguments</span><span>
</span><a name="line-745"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span>                   </span><span class="hs-comment">-- code</span><span>
</span><a name="line-746"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                              </span><span class="hs-comment">-- do stack layout?</span><span>
</span><a name="line-747"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><a name="emitProcWithStackFrame"><a href="StgCmmMonad.html#emitProcWithStackFrame"><span class="hs-identifier">emitProcWithStackFrame</span></a></a><span> </span><a name="local-6989586621680699622"><a href="#local-6989586621680699622"><span class="hs-identifier">_conv</span></a></a><span> </span><a name="local-6989586621680699623"><a href="#local-6989586621680699623"><span class="hs-identifier">mb_info</span></a></a><span> </span><a name="local-6989586621680699624"><a href="#local-6989586621680699624"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680699625"><a href="#local-6989586621680699625"><span class="hs-identifier">_stk_args</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621680699626"><a href="#local-6989586621680699626"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-750"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699627"><a href="#local-6989586621680699627"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-751"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitProc_"><span class="hs-identifier hs-var">emitProc_</span></a><span> </span><a href="#local-6989586621680699623"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><a href="#local-6989586621680699624"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680699626"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">widthInBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680699627"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-752"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-753"></a><span class="hs-identifier">emitProcWithStackFrame</span><span> </span><a name="local-6989586621680699628"><a href="#local-6989586621680699628"><span class="hs-identifier">conv</span></a></a><span> </span><a name="local-6989586621680699629"><a href="#local-6989586621680699629"><span class="hs-identifier">mb_info</span></a></a><span> </span><a name="local-6989586621680699630"><a href="#local-6989586621680699630"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680699631"><a href="#local-6989586621680699631"><span class="hs-identifier">stk_args</span></a></a><span> </span><a name="local-6989586621680699632"><a href="#local-6989586621680699632"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680699633"><a href="#local-6989586621680699633"><span class="hs-identifier">graph</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699634"><a href="#local-6989586621680699634"><span class="hs-identifier">tscope</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-754"></a><span>        </span><span class="hs-comment">-- do layout</span><span>
</span><a name="line-755"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699635"><a href="#local-6989586621680699635"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-756"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680699636"><a href="#local-6989586621680699636"><span class="hs-identifier">offset</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699637"><a href="#local-6989586621680699637"><span class="hs-identifier">live</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699638"><a href="#local-6989586621680699638"><span class="hs-identifier">entry</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkCallEntry"><span class="hs-identifier hs-var">mkCallEntry</span></a><span> </span><a href="#local-6989586621680699635"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680699628"><span class="hs-identifier hs-var">conv</span></a><span> </span><a href="#local-6989586621680699632"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680699631"><span class="hs-identifier hs-var">stk_args</span></a><span>
</span><a name="line-757"></a><span>              </span><a name="local-6989586621680699639"><a href="#local-6989586621680699639"><span class="hs-identifier">graph'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699638"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">MkGraph.&lt;*&gt;</span></a><span> </span><a href="#local-6989586621680699633"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-758"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitProc_"><span class="hs-identifier hs-var">emitProc_</span></a><span> </span><a href="#local-6989586621680699629"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><a href="#local-6989586621680699630"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680699637"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699639"><span class="hs-identifier hs-var">graph'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699634"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680699636"><span class="hs-identifier hs-var">offset</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-760"></a><span class="hs-identifier">emitProcWithStackFrame</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;emitProcWithStackFrame&quot;</span><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span class="hs-identifier">emitProcWithConvention</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#Convention"><span class="hs-identifier hs-type">Convention</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-763"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span>
</span><a name="line-764"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span>
</span><a name="line-765"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-766"></a><a name="emitProcWithConvention"><a href="StgCmmMonad.html#emitProcWithConvention"><span class="hs-identifier">emitProcWithConvention</span></a></a><span> </span><a name="local-6989586621680699640"><a href="#local-6989586621680699640"><span class="hs-identifier">conv</span></a></a><span> </span><a name="local-6989586621680699641"><a href="#local-6989586621680699641"><span class="hs-identifier">mb_info</span></a></a><span> </span><a name="local-6989586621680699642"><a href="#local-6989586621680699642"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680699643"><a href="#local-6989586621680699643"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680699644"><a href="#local-6989586621680699644"><span class="hs-identifier">blocks</span></a></a><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitProcWithStackFrame"><span class="hs-identifier hs-var">emitProcWithStackFrame</span></a><span> </span><a href="#local-6989586621680699640"><span class="hs-identifier hs-var">conv</span></a><span> </span><a href="#local-6989586621680699641"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><a href="#local-6989586621680699642"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680699643"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680699644"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><span class="hs-identifier">emitProc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span>
</span><a name="line-770"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-771"></a><a name="emitProc"><a href="StgCmmMonad.html#emitProc"><span class="hs-identifier">emitProc</span></a></a><span>  </span><a name="local-6989586621680699645"><a href="#local-6989586621680699645"><span class="hs-identifier">mb_info</span></a></a><span> </span><a name="local-6989586621680699646"><a href="#local-6989586621680699646"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680699647"><a href="#local-6989586621680699647"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621680699648"><a href="#local-6989586621680699648"><span class="hs-identifier">blocks</span></a></a><span> </span><a name="local-6989586621680699649"><a href="#local-6989586621680699649"><span class="hs-identifier">offset</span></a></a><span>
</span><a name="line-772"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#emitProc_"><span class="hs-identifier hs-var">emitProc_</span></a><span> </span><a href="#local-6989586621680699645"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><a href="#local-6989586621680699646"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680699647"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621680699648"><span class="hs-identifier hs-var">blocks</span></a><span> </span><a href="#local-6989586621680699649"><span class="hs-identifier hs-var">offset</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-identifier">emitProc_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span>
</span><a name="line-775"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-776"></a><a name="emitProc_"><a href="StgCmmMonad.html#emitProc_"><span class="hs-identifier">emitProc_</span></a></a><span> </span><a name="local-6989586621680699650"><a href="#local-6989586621680699650"><span class="hs-identifier">mb_info</span></a></a><span> </span><a name="local-6989586621680699651"><a href="#local-6989586621680699651"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680699652"><a href="#local-6989586621680699652"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621680699653"><a href="#local-6989586621680699653"><span class="hs-identifier">blocks</span></a></a><span> </span><a name="local-6989586621680699654"><a href="#local-6989586621680699654"><span class="hs-identifier">offset</span></a></a><span> </span><a name="local-6989586621680699655"><a href="#local-6989586621680699655"><span class="hs-identifier">do_layout</span></a></a><span>
</span><a name="line-777"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699656"><a href="#local-6989586621680699656"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-778"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699657"><a href="#local-6989586621680699657"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-779"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-780"></a><span>              </span><a name="local-6989586621680699658"><a href="#local-6989586621680699658"><span class="hs-identifier">blks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#labelAGraph"><span class="hs-identifier hs-var">labelAGraph</span></a><span> </span><a href="#local-6989586621680699657"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680699653"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-781"></a><span>
</span><a name="line-782"></a><span>              </span><a name="local-6989586621680699659"><a href="#local-6989586621680699659"><span class="hs-identifier">infos</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680699663"><a href="#local-6989586621680699663"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680699650"><span class="hs-identifier hs-var">mb_info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680699658"><span class="hs-identifier hs-var">blks</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680699663"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-783"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span>              </span><a name="local-6989586621680699660"><a href="#local-6989586621680699660"><span class="hs-identifier">sinfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#StackInfo"><span class="hs-identifier hs-var">StackInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">arg_space</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699654"><span class="hs-identifier hs-var">offset</span></a><span>
</span><a name="line-786"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">updfr_space</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initUpdFrameOff"><span class="hs-identifier hs-var">initUpdFrameOff</span></a><span> </span><a href="#local-6989586621680699656"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">do_layout</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699655"><span class="hs-identifier hs-var">do_layout</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span>              </span><a name="local-6989586621680699661"><a href="#local-6989586621680699661"><span class="hs-identifier">tinfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#TopInfo"><span class="hs-identifier hs-var">TopInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">info_tbls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680699659"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-790"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stack_info</span><span class="hs-glyph">=</span><a href="#local-6989586621680699660"><span class="hs-identifier hs-var">sinfo</span></a><span class="hs-special">}</span><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span>              </span><a name="local-6989586621680699662"><a href="#local-6989586621680699662"><span class="hs-identifier">proc_block</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621680699661"><span class="hs-identifier hs-var">tinfo</span></a><span> </span><a href="#local-6989586621680699651"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680699652"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621680699658"><span class="hs-identifier hs-var">blks</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680699664"><a href="#local-6989586621680699664"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-795"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699664"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><a href="#local-6989586621680699664"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680699662"><span class="hs-identifier hs-var">proc_block</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span class="hs-identifier">getCmm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="Cmm.html#CmmGroup"><span class="hs-identifier hs-type">CmmGroup</span></a><span>
</span><a name="line-798"></a><span class="hs-comment">-- Get all the CmmTops (there should be no stmts)</span><span>
</span><a name="line-799"></a><span class="hs-comment">-- Return a single Cmm which may be split from other Cmms by</span><span>
</span><a name="line-800"></a><span class="hs-comment">-- object splitting (at a later stage)</span><span>
</span><a name="line-801"></a><a name="getCmm"><a href="StgCmmMonad.html#getCmm"><span class="hs-identifier">getCmm</span></a></a><span> </span><a name="local-6989586621680699665"><a href="#local-6989586621680699665"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-802"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699666"><a href="#local-6989586621680699666"><span class="hs-identifier">state1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-803"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680699667"><a href="#local-6989586621680699667"><span class="hs-identifier">state2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#withState"><span class="hs-identifier hs-var">withState</span></a><span> </span><a href="#local-6989586621680699665"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699666"><span class="hs-identifier hs-var">state1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_tops</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setState"><span class="hs-identifier hs-var">setState</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680699667"><span class="hs-identifier hs-var">state2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cgs_tops</span><span> </span><a href="#local-6989586621680699666"><span class="hs-identifier hs-var">state1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-805"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cgs_tops</span><span> </span><a href="#local-6989586621680699667"><span class="hs-identifier hs-var">state2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span class="hs-identifier">mkCmmIfThenElse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-809"></a><a name="mkCmmIfThenElse"><a href="StgCmmMonad.html#mkCmmIfThenElse"><span class="hs-identifier">mkCmmIfThenElse</span></a></a><span> </span><a name="local-6989586621680699668"><a href="#local-6989586621680699668"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680699669"><a href="#local-6989586621680699669"><span class="hs-identifier">tbranch</span></a></a><span> </span><a name="local-6989586621680699670"><a href="#local-6989586621680699670"><span class="hs-identifier">fbranch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThenElse%27"><span class="hs-identifier hs-var">mkCmmIfThenElse'</span></a><span> </span><a href="#local-6989586621680699668"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680699669"><span class="hs-identifier hs-var">tbranch</span></a><span> </span><a href="#local-6989586621680699670"><span class="hs-identifier hs-var">fbranch</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-identifier">mkCmmIfThenElse'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-812"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-813"></a><a name="mkCmmIfThenElse%27"><a href="StgCmmMonad.html#mkCmmIfThenElse%27"><span class="hs-identifier">mkCmmIfThenElse'</span></a></a><span> </span><a name="local-6989586621680699671"><a href="#local-6989586621680699671"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680699672"><a href="#local-6989586621680699672"><span class="hs-identifier">tbranch</span></a></a><span> </span><a name="local-6989586621680699673"><a href="#local-6989586621680699673"><span class="hs-identifier">fbranch</span></a></a><span> </span><a name="local-6989586621680699674"><a href="#local-6989586621680699674"><span class="hs-identifier">likely</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-814"></a><span>  </span><a name="local-6989586621680699675"><a href="#local-6989586621680699675"><span class="hs-identifier">tscp</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-815"></a><span>  </span><a name="local-6989586621680699676"><a href="#local-6989586621680699676"><span class="hs-identifier">endif</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-816"></a><span>  </span><a name="local-6989586621680699677"><a href="#local-6989586621680699677"><span class="hs-identifier">tid</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-817"></a><span>  </span><a name="local-6989586621680699678"><a href="#local-6989586621680699678"><span class="hs-identifier">fid</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-820"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680699679"><a href="#local-6989586621680699679"><span class="hs-identifier">test</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699680"><a href="#local-6989586621680699680"><span class="hs-identifier">then_</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699681"><a href="#local-6989586621680699681"><span class="hs-identifier">else_</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699682"><a href="#local-6989586621680699682"><span class="hs-identifier">likely'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680699674"><span class="hs-identifier hs-var">likely</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-821"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680699683"><a href="#local-6989586621680699683"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmExpr.html#maybeInvertCmmExpr"><span class="hs-identifier hs-var">maybeInvertCmmExpr</span></a><span> </span><a href="#local-6989586621680699671"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-822"></a><span>        </span><span class="hs-comment">-- currently NCG doesn't know about likely</span><span>
</span><a name="line-823"></a><span>        </span><span class="hs-comment">-- annotations. We manually switch then and</span><span>
</span><a name="line-824"></a><span>        </span><span class="hs-comment">-- else branch so the likely false branch</span><span>
</span><a name="line-825"></a><span>        </span><span class="hs-comment">-- becomes a fallthrough.</span><span>
</span><a name="line-826"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699683"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699673"><span class="hs-identifier hs-var">fbranch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699672"><span class="hs-identifier hs-var">tbranch</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680699671"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699672"><span class="hs-identifier hs-var">tbranch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699673"><span class="hs-identifier hs-var">fbranch</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699674"><span class="hs-identifier hs-var">likely</span></a><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="MkGraph.html#mkCbranch"><span class="hs-identifier hs-var">mkCbranch</span></a><span> </span><a href="#local-6989586621680699679"><span class="hs-identifier hs-var">test</span></a><span> </span><a href="#local-6989586621680699677"><span class="hs-identifier hs-var">tid</span></a><span> </span><a href="#local-6989586621680699678"><span class="hs-identifier hs-var">fid</span></a><span> </span><a href="#local-6989586621680699682"><span class="hs-identifier hs-var">likely'</span></a><span>
</span><a name="line-830"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699677"><span class="hs-identifier hs-var">tid</span></a><span> </span><a href="#local-6989586621680699675"><span class="hs-identifier hs-var">tscp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699680"><span class="hs-identifier hs-var">then_</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621680699676"><span class="hs-identifier hs-var">endif</span></a><span>
</span><a name="line-831"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699678"><span class="hs-identifier hs-var">fid</span></a><span> </span><a href="#local-6989586621680699675"><span class="hs-identifier hs-var">tscp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699681"><span class="hs-identifier hs-var">else_</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699676"><span class="hs-identifier hs-var">endif</span></a><span> </span><a href="#local-6989586621680699675"><span class="hs-identifier hs-var">tscp</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span class="hs-identifier">mkCmmIfGoto</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-834"></a><a name="mkCmmIfGoto"><a href="StgCmmMonad.html#mkCmmIfGoto"><span class="hs-identifier">mkCmmIfGoto</span></a></a><span> </span><a name="local-6989586621680699684"><a href="#local-6989586621680699684"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680699685"><a href="#local-6989586621680699685"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#mkCmmIfGoto%27"><span class="hs-identifier hs-var">mkCmmIfGoto'</span></a><span> </span><a href="#local-6989586621680699684"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680699685"><span class="hs-identifier hs-var">tid</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span class="hs-identifier">mkCmmIfGoto'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-837"></a><a name="mkCmmIfGoto%27"><a href="StgCmmMonad.html#mkCmmIfGoto%27"><span class="hs-identifier">mkCmmIfGoto'</span></a></a><span> </span><a name="local-6989586621680699686"><a href="#local-6989586621680699686"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680699687"><a href="#local-6989586621680699687"><span class="hs-identifier">tid</span></a></a><span> </span><a name="local-6989586621680699688"><a href="#local-6989586621680699688"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-838"></a><span>  </span><a name="local-6989586621680699689"><a href="#local-6989586621680699689"><span class="hs-identifier">endif</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-839"></a><span>  </span><a name="local-6989586621680699690"><a href="#local-6989586621680699690"><span class="hs-identifier">tscp</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-840"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="MkGraph.html#mkCbranch"><span class="hs-identifier hs-var">mkCbranch</span></a><span> </span><a href="#local-6989586621680699686"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680699687"><span class="hs-identifier hs-var">tid</span></a><span> </span><a href="#local-6989586621680699689"><span class="hs-identifier hs-var">endif</span></a><span> </span><a href="#local-6989586621680699688"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699689"><span class="hs-identifier hs-var">endif</span></a><span> </span><a href="#local-6989586621680699690"><span class="hs-identifier hs-var">tscp</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-identifier">mkCmmIfThen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-843"></a><a name="mkCmmIfThen"><a href="StgCmmMonad.html#mkCmmIfThen"><span class="hs-identifier">mkCmmIfThen</span></a></a><span> </span><a name="local-6989586621680699691"><a href="#local-6989586621680699691"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680699692"><a href="#local-6989586621680699692"><span class="hs-identifier">tbranch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThen%27"><span class="hs-identifier hs-var">mkCmmIfThen'</span></a><span> </span><a href="#local-6989586621680699691"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680699692"><span class="hs-identifier hs-var">tbranch</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span class="hs-identifier">mkCmmIfThen'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-846"></a><a name="mkCmmIfThen%27"><a href="StgCmmMonad.html#mkCmmIfThen%27"><span class="hs-identifier">mkCmmIfThen'</span></a></a><span> </span><a name="local-6989586621680699693"><a href="#local-6989586621680699693"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680699694"><a href="#local-6989586621680699694"><span class="hs-identifier">tbranch</span></a></a><span> </span><a name="local-6989586621680699695"><a href="#local-6989586621680699695"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-847"></a><span>  </span><a name="local-6989586621680699696"><a href="#local-6989586621680699696"><span class="hs-identifier">endif</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-848"></a><span>  </span><a name="local-6989586621680699697"><a href="#local-6989586621680699697"><span class="hs-identifier">tid</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-849"></a><span>  </span><a name="local-6989586621680699698"><a href="#local-6989586621680699698"><span class="hs-identifier">tscp</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="MkGraph.html#mkCbranch"><span class="hs-identifier hs-var">mkCbranch</span></a><span> </span><a href="#local-6989586621680699693"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680699697"><span class="hs-identifier hs-var">tid</span></a><span> </span><a href="#local-6989586621680699696"><span class="hs-identifier hs-var">endif</span></a><span> </span><a href="#local-6989586621680699695"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-851"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699697"><span class="hs-identifier hs-var">tid</span></a><span> </span><a href="#local-6989586621680699698"><span class="hs-identifier hs-var">tscp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699694"><span class="hs-identifier hs-var">tbranch</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699696"><span class="hs-identifier hs-var">endif</span></a><span> </span><a href="#local-6989586621680699698"><span class="hs-identifier hs-var">tscp</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span class="hs-identifier">mkCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#Convention"><span class="hs-identifier hs-type">Convention</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#Convention"><span class="hs-identifier hs-type">Convention</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-854"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-855"></a><a name="mkCall"><a href="StgCmmMonad.html#mkCall"><span class="hs-identifier">mkCall</span></a></a><span> </span><a name="local-6989586621680699699"><a href="#local-6989586621680699699"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680699700"><a href="#local-6989586621680699700"><span class="hs-identifier">callConv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680699701"><a href="#local-6989586621680699701"><span class="hs-identifier">retConv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680699702"><a href="#local-6989586621680699702"><span class="hs-identifier">results</span></a></a><span> </span><a name="local-6989586621680699703"><a href="#local-6989586621680699703"><span class="hs-identifier">actuals</span></a></a><span> </span><a name="local-6989586621680699704"><a href="#local-6989586621680699704"><span class="hs-identifier">updfr_off</span></a></a><span> </span><a name="local-6989586621680699705"><a href="#local-6989586621680699705"><span class="hs-identifier">extra_stack</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-856"></a><span>  </span><a name="local-6989586621680699706"><a href="#local-6989586621680699706"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-857"></a><span>  </span><a name="local-6989586621680699707"><a href="#local-6989586621680699707"><span class="hs-identifier">k</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-858"></a><span>  </span><a name="local-6989586621680699708"><a href="#local-6989586621680699708"><span class="hs-identifier">tscp</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-859"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680699709"><a href="#local-6989586621680699709"><span class="hs-identifier">area</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621680699707"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-860"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621680699710"><a href="#local-6989586621680699710"><span class="hs-identifier">off</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680699711"><a href="#local-6989586621680699711"><span class="hs-identifier">copyin</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#copyInOflow"><span class="hs-identifier hs-var">copyInOflow</span></a><span> </span><a href="#local-6989586621680699706"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680699701"><span class="hs-identifier hs-var">retConv</span></a><span> </span><a href="#local-6989586621680699709"><span class="hs-identifier hs-var">area</span></a><span> </span><a href="#local-6989586621680699702"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-861"></a><span>      </span><a name="local-6989586621680699712"><a href="#local-6989586621680699712"><span class="hs-identifier">copyout</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkCallReturnsTo"><span class="hs-identifier hs-var">mkCallReturnsTo</span></a><span> </span><a href="#local-6989586621680699706"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680699699"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680699700"><span class="hs-identifier hs-var">callConv</span></a><span> </span><a href="#local-6989586621680699703"><span class="hs-identifier hs-var">actuals</span></a><span> </span><a href="#local-6989586621680699707"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680699710"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621680699704"><span class="hs-identifier hs-var">updfr_off</span></a><span> </span><a href="#local-6989586621680699705"><span class="hs-identifier hs-var">extra_stack</span></a><span>
</span><a name="line-862"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680699712"><span class="hs-identifier hs-var">copyout</span></a><span class="hs-special">,</span><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680699707"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680699708"><span class="hs-identifier hs-var">tscp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680699711"><span class="hs-identifier hs-var">copyin</span></a><span class="hs-special">]</span><span>
</span><a name="line-863"></a><span>
</span><a name="line-864"></a><span class="hs-identifier">mkCmmCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span>
</span><a name="line-865"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-866"></a><a name="mkCmmCall"><a href="StgCmmMonad.html#mkCmmCall"><span class="hs-identifier">mkCmmCall</span></a></a><span> </span><a name="local-6989586621680699713"><a href="#local-6989586621680699713"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680699714"><a href="#local-6989586621680699714"><span class="hs-identifier">results</span></a></a><span> </span><a name="local-6989586621680699715"><a href="#local-6989586621680699715"><span class="hs-identifier">actuals</span></a></a><span> </span><a name="local-6989586621680699716"><a href="#local-6989586621680699716"><span class="hs-identifier">updfr_off</span></a></a><span>
</span><a name="line-867"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#mkCall"><span class="hs-identifier hs-var">mkCall</span></a><span> </span><a href="#local-6989586621680699713"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#NativeDirectCall"><span class="hs-identifier hs-var">NativeDirectCall</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680699714"><span class="hs-identifier hs-var">results</span></a><span> </span><a href="#local-6989586621680699715"><span class="hs-identifier hs-var">actuals</span></a><span> </span><a href="#local-6989586621680699716"><span class="hs-identifier hs-var">updfr_off</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-868"></a><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-871"></a><span class="hs-comment">-- turn CmmAGraph into CmmGraph, for making a new proc.</span><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span class="hs-identifier">aGraphToGraph</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span>
</span><a name="line-874"></a><a name="aGraphToGraph"><a href="StgCmmMonad.html#aGraphToGraph"><span class="hs-identifier">aGraphToGraph</span></a></a><span> </span><a name="local-6989586621680699717"><a href="#local-6989586621680699717"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-875"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680699718"><a href="#local-6989586621680699718"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-876"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkGraph.html#labelAGraph"><span class="hs-identifier hs-var">labelAGraph</span></a><span> </span><a href="#local-6989586621680699718"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680699717"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-877"></a></pre></body></html>