<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Stg to C-- code generation: expressions</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmExpr</span><span> </span><span class="hs-special">(</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="StgCmmBind.html"><span class="hs-identifier">StgCmmBind</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="StgCmmBind.html#cgBind"><span class="hs-identifier hs-var">cgBind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmMonad.html"><span class="hs-identifier">StgCmmMonad</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmHeap.html"><span class="hs-identifier">StgCmmHeap</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmEnv.html"><span class="hs-identifier">StgCmmEnv</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmCon.html"><span class="hs-identifier">StgCmmCon</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmProf.html"><span class="hs-identifier">StgCmmProf</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#saveCurrentCostCentre"><span class="hs-identifier hs-var">saveCurrentCostCentre</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#restoreCurrentCostCentre"><span class="hs-identifier hs-var">restoreCurrentCostCentre</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#emitSetCCC"><span class="hs-identifier hs-var">emitSetCCC</span></a><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmPrim.html"><span class="hs-identifier">StgCmmPrim</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmHpc.html"><span class="hs-identifier">StgCmmHpc</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmTicky.html"><span class="hs-identifier">StgCmmTicky</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="CmmInfo.html"><span class="hs-identifier">CmmInfo</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ForeignCall</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrimOp</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isVoidTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">countConRepArgs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">primRepSlot</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">currentCCS</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">first</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">on</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-56"></a><span class="hs-comment">--              cgExpr: the main function</span><span>
</span><a name="line-57"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-identifier">cgExpr</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><a name="cgExpr"><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier">cgExpr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681525044"><a href="#local-6989586621681525044"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621681525045"><a href="#local-6989586621681525045"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#cgIdApp"><span class="hs-identifier hs-var">cgIdApp</span></a><span> </span><a href="#local-6989586621681525044"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621681525045"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- seq# a s ==&gt; a</span><span>
</span><a name="line-64"></a><span class="hs-comment">-- See Note [seq# magic] in PrelRules</span><span>
</span><a name="line-65"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><span class="hs-identifier hs-var">SeqOp</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621681525046"><a href="#local-6989586621681525046"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681525047"><a href="#local-6989586621681525047"><span class="hs-identifier">_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-66"></a><span>  </span><a href="StgCmmExpr.html#cgIdApp"><span class="hs-identifier hs-var">cgIdApp</span></a><span> </span><a href="#local-6989586621681525046"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- dataToTag# :: a -&gt; Int#</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- See Note [dataToTag#] in primops.txt.pp</span><span>
</span><a name="line-70"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><span class="hs-identifier hs-var">DataToTagOp</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621681525048"><a href="#local-6989586621681525048"><span class="hs-identifier">a</span></a></a><span class="hs-special">]</span><span> </span><a name="local-6989586621681525049"><a href="#local-6989586621681525049"><span class="hs-identifier">_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-71"></a><span>  </span><a name="local-6989586621681525050"><a href="#local-6989586621681525050"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-72"></a><span>  </span><a href="StgCmmMonad.html#emitComment"><span class="hs-identifier hs-var">emitComment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;dataToTag#&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><a name="local-6989586621681525051"><a href="#local-6989586621681525051"><span class="hs-identifier">tmp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621681525050"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#withSequel"><span class="hs-identifier hs-var">withSequel</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier hs-var">AssignTo</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681525051"><span class="hs-identifier hs-var">tmp</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#cgIdApp"><span class="hs-identifier hs-var">cgIdApp</span></a><span> </span><a href="#local-6989586621681525048"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-comment">-- TODO: For small types look at the tag bits instead of reading info table</span><span>
</span><a name="line-76"></a><span>  </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">[</span><a href="CmmInfo.html#getConstrTag"><span class="hs-identifier hs-var">getConstrTag</span></a><span> </span><a href="#local-6989586621681525050"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmUntag"><span class="hs-identifier hs-var">cmmUntag</span></a><span> </span><a href="#local-6989586621681525050"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681525051"><span class="hs-identifier hs-var">tmp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a name="local-6989586621681525052"><a href="#local-6989586621681525052"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621681525053"><a href="#local-6989586621681525053"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681525054"><a href="#local-6989586621681525054"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmPrim.html#cgOpApp"><span class="hs-identifier hs-var">cgOpApp</span></a><span> </span><a href="#local-6989586621681525052"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621681525053"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621681525054"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-79"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a name="local-6989586621681525055"><a href="#local-6989586621681525055"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621681525056"><a href="#local-6989586621681525056"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#cgConApp"><span class="hs-identifier hs-var">cgConApp</span></a><span> </span><a href="#local-6989586621681525055"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621681525056"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-80"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a name="local-6989586621681525057"><a href="#local-6989586621681525057"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621681525058"><a href="#local-6989586621681525058"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#cgTick"><span class="hs-identifier hs-var">cgTick</span></a><span> </span><a href="#local-6989586621681525057"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525058"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-81"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a name="local-6989586621681525059"><a href="#local-6989586621681525059"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681525060"><a href="#local-6989586621681525060"><span class="hs-identifier">cmm_lit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#cgLit"><span class="hs-identifier hs-var">cgLit</span></a><span> </span><a href="#local-6989586621681525059"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-82"></a><span>                               </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><a href="#local-6989586621681525060"><span class="hs-identifier hs-var">cmm_lit</span></a><span class="hs-special">]</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681525061"><a href="#local-6989586621681525061"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621681525062"><a href="#local-6989586621681525062"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="StgCmmBind.html#cgBind"><span class="hs-identifier hs-var">cgBind</span></a><span> </span><a href="#local-6989586621681525061"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">;</span><span>     </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525062"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-85"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681525063"><a href="#local-6989586621681525063"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621681525064"><a href="#local-6989586621681525064"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525065"><a href="#local-6989586621681525065"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-87"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525066"><a href="#local-6989586621681525066"><span class="hs-identifier">join_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockId.html#mkBlockId"><span class="hs-identifier hs-var">mkBlockId</span></a><span> </span><a href="#local-6989586621681525065"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-88"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="StgCmmExpr.html#cgLneBinds"><span class="hs-identifier hs-var">cgLneBinds</span></a><span> </span><a href="#local-6989586621681525066"><span class="hs-identifier hs-var">join_id</span></a><span> </span><a href="#local-6989586621681525063"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-89"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525067"><a href="#local-6989586621681525067"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525064"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-90"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621681525066"><span class="hs-identifier hs-var">join_id</span></a><span>
</span><a name="line-91"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681525067"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a name="local-6989586621681525068"><a href="#local-6989586621681525068"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621681525069"><a href="#local-6989586621681525069"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525070"><a href="#local-6989586621681525070"><span class="hs-identifier">alt_type</span></a></a><span> </span><a name="local-6989586621681525071"><a href="#local-6989586621681525071"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-94"></a><span>  </span><a href="StgCmmExpr.html#cgCase"><span class="hs-identifier hs-var">cgCase</span></a><span> </span><a href="#local-6989586621681525068"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621681525069"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525070"><span class="hs-identifier hs-var">alt_type</span></a><span> </span><a href="#local-6989586621681525071"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-identifier">cgExpr</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLam"><span class="hs-identifier hs-var">StgLam</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cgExpr: StgLam&quot;</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-99"></a><span class="hs-comment">--              Let no escape</span><span>
</span><a name="line-100"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">{- Generating code for a let-no-escape binding, aka join point is very
very similar to what we do for a case expression.  The duality is
between
        let-no-escape x = b
        in e
and
        case e of ... -&gt; b

That is, the RHS of 'x' (ie 'b') will execute *later*, just like
the alternative of the case; it needs to be compiled in an environment
in which all volatile bindings are forgotten, and the free vars are
bound only to stable things like stack locations..  The 'e' part will
execute *next*, just like the scrutinee of a case. -}</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-117"></a><span class="hs-identifier">cgLneBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgBinding"><span class="hs-identifier hs-type">CgStgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><a name="cgLneBinds"><a href="StgCmmExpr.html#cgLneBinds"><span class="hs-identifier">cgLneBinds</span></a></a><span> </span><a name="local-6989586621681525072"><a href="#local-6989586621681525072"><span class="hs-identifier">join_id</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621681525073"><a href="#local-6989586621681525073"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525074"><a href="#local-6989586621681525074"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525075"><a href="#local-6989586621681525075"><span class="hs-identifier">local_cc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmProf.html#saveCurrentCostCentre"><span class="hs-identifier hs-var">saveCurrentCostCentre</span></a><span>
</span><a name="line-120"></a><span>                </span><span class="hs-comment">-- See Note [Saving the current cost centre]</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525076"><a href="#local-6989586621681525076"><span class="hs-identifier">info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525077"><a href="#local-6989586621681525077"><span class="hs-identifier">fcode</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgLetNoEscapeRhs"><span class="hs-identifier hs-var">cgLetNoEscapeRhs</span></a><span> </span><a href="#local-6989586621681525072"><span class="hs-identifier hs-var">join_id</span></a><span> </span><a href="#local-6989586621681525075"><span class="hs-identifier hs-var">local_cc</span></a><span> </span><a href="#local-6989586621681525073"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525074"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-122"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621681525077"><span class="hs-identifier hs-var">fcode</span></a><span>
</span><a name="line-123"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmEnv.html#addBindC"><span class="hs-identifier hs-var">addBindC</span></a><span> </span><a href="#local-6989586621681525076"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">cgLneBinds</span><span> </span><a name="local-6989586621681525078"><a href="#local-6989586621681525078"><span class="hs-identifier">join_id</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621681525079"><a href="#local-6989586621681525079"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525080"><a href="#local-6989586621681525080"><span class="hs-identifier">local_cc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmProf.html#saveCurrentCostCentre"><span class="hs-identifier hs-var">saveCurrentCostCentre</span></a><span>
</span><a name="line-127"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525081"><a href="#local-6989586621681525081"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unzipWith</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#cgLetNoEscapeRhs"><span class="hs-identifier hs-var">cgLetNoEscapeRhs</span></a><span> </span><a href="#local-6989586621681525078"><span class="hs-identifier hs-var">join_id</span></a><span> </span><a href="#local-6989586621681525080"><span class="hs-identifier hs-var">local_cc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525079"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-128"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525082"><a href="#local-6989586621681525082"><span class="hs-identifier">infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525083"><a href="#local-6989586621681525083"><span class="hs-identifier">fcodes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681525081"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmEnv.html#addBindsC"><span class="hs-identifier hs-var">addBindsC</span></a><span> </span><a href="#local-6989586621681525082"><span class="hs-identifier hs-var">infos</span></a><span>
</span><a name="line-130"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">sequence_</span><span> </span><a href="#local-6989586621681525083"><span class="hs-identifier hs-var">fcodes</span></a><span>
</span><a name="line-131"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-134"></a><span class="hs-identifier">cgLetNoEscapeRhs</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>          </span><span class="hs-comment">-- join point for successor of let-no-escape</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span>   </span><span class="hs-comment">-- Saved cost centre</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgRhs"><span class="hs-identifier hs-type">CgStgRhs</span></a><span>
</span><a name="line-139"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><a name="cgLetNoEscapeRhs"><a href="StgCmmExpr.html#cgLetNoEscapeRhs"><span class="hs-identifier">cgLetNoEscapeRhs</span></a></a><span> </span><a name="local-6989586621681525084"><a href="#local-6989586621681525084"><span class="hs-identifier">join_id</span></a></a><span> </span><a name="local-6989586621681525085"><a href="#local-6989586621681525085"><span class="hs-identifier">local_cc</span></a></a><span> </span><a name="local-6989586621681525086"><a href="#local-6989586621681525086"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525087"><a href="#local-6989586621681525087"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525088"><a href="#local-6989586621681525088"><span class="hs-identifier">info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525089"><a href="#local-6989586621681525089"><span class="hs-identifier">rhs_code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgLetNoEscapeRhsBody"><span class="hs-identifier hs-var">cgLetNoEscapeRhsBody</span></a><span> </span><a href="#local-6989586621681525085"><span class="hs-identifier hs-var">local_cc</span></a><span> </span><a href="#local-6989586621681525086"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525087"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-143"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525090"><a href="#local-6989586621681525090"><span class="hs-identifier">bid</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;cgLetNoEscapeRhs&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmEnv.html#maybeLetNoEscape"><span class="hs-identifier hs-var">maybeLetNoEscape</span></a><span> </span><a href="#local-6989586621681525088"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-144"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525091"><a href="#local-6989586621681525091"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681525092"><a href="#local-6989586621681525092"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getCodeScoped"><span class="hs-identifier hs-var">getCodeScoped</span></a><span> </span><a href="#local-6989586621681525089"><span class="hs-identifier hs-var">rhs_code</span></a><span>
</span><a name="line-145"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitOutOfLine"><span class="hs-identifier hs-var">emitOutOfLine</span></a><span> </span><a href="#local-6989586621681525090"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">(</span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621681525084"><span class="hs-identifier hs-var">join_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525092"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-146"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525088"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681525091"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">cgLetNoEscapeRhsBody</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span>   </span><span class="hs-comment">-- Saved cost centre</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgRhs"><span class="hs-identifier hs-type">CgStgRhs</span></a><span>
</span><a name="line-153"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><a name="cgLetNoEscapeRhsBody"><a href="StgCmmExpr.html#cgLetNoEscapeRhsBody"><span class="hs-identifier">cgLetNoEscapeRhsBody</span></a></a><span> </span><a name="local-6989586621681525093"><a href="#local-6989586621681525093"><span class="hs-identifier">local_cc</span></a></a><span> </span><a name="local-6989586621681525094"><a href="#local-6989586621681525094"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681525095"><a href="#local-6989586621681525095"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681525096"><a href="#local-6989586621681525096"><span class="hs-identifier">_upd</span></a></a><span> </span><a name="local-6989586621681525097"><a href="#local-6989586621681525097"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681525098"><a href="#local-6989586621681525098"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#cgLetNoEscapeClosure"><span class="hs-identifier hs-var">cgLetNoEscapeClosure</span></a><span> </span><a href="#local-6989586621681525094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525093"><span class="hs-identifier hs-var">local_cc</span></a><span> </span><a href="#local-6989586621681525095"><span class="hs-identifier hs-var">cc</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span> </span><a href="#local-6989586621681525097"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525098"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-156"></a><span class="hs-identifier">cgLetNoEscapeRhsBody</span><span> </span><a name="local-6989586621681525099"><a href="#local-6989586621681525099"><span class="hs-identifier">local_cc</span></a></a><span> </span><a name="local-6989586621681525100"><a href="#local-6989586621681525100"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621681525101"><a href="#local-6989586621681525101"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681525102"><a href="#local-6989586621681525102"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621681525103"><a href="#local-6989586621681525103"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#cgLetNoEscapeClosure"><span class="hs-identifier hs-var">cgLetNoEscapeClosure</span></a><span> </span><a href="#local-6989586621681525100"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525099"><span class="hs-identifier hs-var">local_cc</span></a><span> </span><a href="#local-6989586621681525101"><span class="hs-identifier hs-var">cc</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-158"></a><span>      </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a href="#local-6989586621681525102"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621681525103"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;cgLetNoEscapeRhsBody&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-159"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StgRhsCon doesn't have type args&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-comment">-- For a constructor RHS we want to generate a single chunk of</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-comment">-- code which can be jumped to from many places, which will</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-comment">-- return the constructor. It's easy; just behave as if it</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-comment">-- was an StgRhsClosure with a ConApp inside!</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-166"></a><span class="hs-identifier">cgLetNoEscapeClosure</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                   </span><span class="hs-comment">-- binder</span><span>
</span><a name="line-168"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span>       </span><span class="hs-comment">-- Slot for saved current cost centre</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span>      </span><span class="hs-comment">-- XXX: *** NOT USED *** why not?</span><span>
</span><a name="line-170"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Args (as in \ args -&gt; body)</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span>            </span><span class="hs-comment">-- Body (as in above)</span><span>
</span><a name="line-172"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><a name="cgLetNoEscapeClosure"><a href="StgCmmExpr.html#cgLetNoEscapeClosure"><span class="hs-identifier">cgLetNoEscapeClosure</span></a></a><span> </span><a name="local-6989586621681525104"><a href="#local-6989586621681525104"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525105"><a href="#local-6989586621681525105"><span class="hs-identifier">cc_slot</span></a></a><span> </span><a name="local-6989586621681525106"><a href="#local-6989586621681525106"><span class="hs-identifier">_unused_cc</span></a></a><span> </span><a name="local-6989586621681525107"><a href="#local-6989586621681525107"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681525108"><a href="#local-6989586621681525108"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681525111"><a href="#local-6989586621681525111"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-176"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="StgCmmEnv.html#lneIdInfo"><span class="hs-identifier hs-var">lneIdInfo</span></a><span> </span><a href="#local-6989586621681525111"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525104"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525107"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-177"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681525109"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-179"></a><span>   </span><a name="local-6989586621681525109"><a href="#local-6989586621681525109"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#forkLneBody"><span class="hs-identifier hs-var">forkLneBody</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounterLNE"><span class="hs-identifier hs-var">withNewTickyCounterLNE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681525104"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525107"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-181"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#restoreCurrentCostCentre"><span class="hs-identifier hs-var">restoreCurrentCostCentre</span></a><span> </span><a href="#local-6989586621681525105"><span class="hs-identifier hs-var">cc_slot</span></a><span>
</span><a name="line-182"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525110"><a href="#local-6989586621681525110"><span class="hs-identifier">arg_regs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#bindArgsToRegs"><span class="hs-identifier hs-var">bindArgsToRegs</span></a><span> </span><a href="#local-6989586621681525107"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-183"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmHeap.html#noEscapeHeapCheck"><span class="hs-identifier hs-var">noEscapeHeapCheck</span></a><span> </span><a href="#local-6989586621681525110"><span class="hs-identifier hs-var">arg_regs</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmTicky.html#tickyEnterLNE"><span class="hs-identifier hs-var">tickyEnterLNE</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525108"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-187"></a><span class="hs-comment">--              Case expressions</span><span>
</span><a name="line-188"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-comment">{- Note [Compiling case expressions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It is quite interesting to decide whether to put a heap-check at the
start of each alternative.  Of course we certainly have to do so if
the case forces an evaluation, or if there is a primitive op which can
trigger GC.

A more interesting situation is this (a Plan-B situation)

        !P!;
        ...P...
        case x# of
          0#      -&gt; !Q!; ...Q...
          default -&gt; !R!; ...R...

where !x! indicates a possible heap-check point. The heap checks
in the alternatives *can* be omitted, in which case the topmost
heapcheck will take their worst case into account.

In favour of omitting !Q!, !R!:

 - *May* save a heap overflow test,
   if ...P... allocates anything.

 - We can use relative addressing from a single Hp to
   get at all the closures so allocated.

 - No need to save volatile vars etc across heap checks
   in !Q!, !R!

Against omitting !Q!, !R!

  - May put a heap-check into the inner loop.  Suppose
        the main loop is P -&gt; R -&gt; P -&gt; R...
        Q is the loop exit, and only it does allocation.
    This only hurts us if P does no allocation.  If P allocates,
    then there is a heap check in the inner loop anyway.

  - May do more allocation than reqd.  This sometimes bites us
    badly.  For example, nfib (ha!) allocates about 30\% more space if the
    worst-casing is done, because many many calls to nfib are leaf calls
    which don't need to allocate anything.

    We can un-allocate, but that costs an instruction

Neither problem hurts us if there is only one alternative.

Suppose the inner loop is P-&gt;R-&gt;P-&gt;R etc.  Then here is
how many heap checks we get in the *inner loop* under various
conditions

  Alloc   Heap check in branches (!Q!, !R!)?
  P Q R      yes     no (absorb to !P!)
--------------------------------------
  n n n      0          0
  n y n      0          1
  n . y      1          1
  y . y      2          1
  y . n      1          1

Best choices: absorb heap checks from Q and R into !P! iff
  a) P itself does some allocation
or
  b) P does allocation, or there is exactly one alternative

We adopt (b) because that is more likely to put the heap check at the
entry to a function, when not many things are live.  After a bunch of
single-branch cases, we may have lots of things live

Hence: two basic plans for

        case e of r { alts }

------ Plan A: the general case ---------

        ...save current cost centre...

        ...code for e,
           with sequel (SetLocals r)

        ...restore current cost centre...
        ...code for alts...
        ...alts do their own heap checks

------ Plan B: special case when ---------
  (i)  e does not allocate or call GC
  (ii) either upstream code performs allocation
       or there is just one alternative

  Then heap allocation in the (single) case branch
  is absorbed by the upstream check.
  Very common example: primops on unboxed values

        ...code for e,
           with sequel (SetLocals r)...

        ...code for alts...
        ...no heap check...
-}</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-293"></a><span class="hs-keyword">data</span><span> </span><a name="GcPlan"><a href="StgCmmExpr.html#GcPlan"><span class="hs-identifier">GcPlan</span></a></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="GcInAlts"><a href="StgCmmExpr.html#GcInAlts"><span class="hs-identifier">GcInAlts</span></a></a><span>            </span><span class="hs-comment">-- Put a GC check at the start the case alternatives,</span><span>
</span><a name="line-295"></a><span>        </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- which binds these registers</span><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NoGcInAlts"><a href="StgCmmExpr.html#NoGcInAlts"><span class="hs-identifier">NoGcInAlts</span></a></a><span>          </span><span class="hs-comment">-- The scrutinee is a primitive value, or a call to a</span><span>
</span><a name="line-297"></a><span>                        </span><span class="hs-comment">-- primitive op which does no GC.  Absorb the allocation</span><span>
</span><a name="line-298"></a><span>                        </span><span class="hs-comment">-- of the case alternative(s) into the upstream check</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-301"></a><span class="hs-identifier">cgCase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><a name="cgCase"><a href="StgCmmExpr.html#cgCase"><span class="hs-identifier">cgCase</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><a name="local-6989586621681525112"><a href="#local-6989586621681525112"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681525113"><a href="#local-6989586621681525113"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525114"><a href="#local-6989586621681525114"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#AlgAlt"><span class="hs-identifier hs-var">AlgAlt</span></a><span> </span><a name="local-6989586621681525115"><a href="#local-6989586621681525115"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681525116"><a href="#local-6989586621681525116"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-304"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEnumerationTyCon</span><span> </span><a href="#local-6989586621681525115"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-comment">-- Note [case on bool]</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525123"><a href="#local-6989586621681525123"><span class="hs-identifier">tag_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681525117"><span class="hs-identifier hs-var">do_enum_primop</span></a><span> </span><a href="#local-6989586621681525112"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621681525113"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>       </span><span class="hs-comment">-- If the binder is not dead, convert the tag to a constructor</span><span>
</span><a name="line-308"></a><span>       </span><span class="hs-comment">-- and assign it. See Note [Dead-binder optimisation]</span><span>
</span><a name="line-309"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDeadBinder</span><span> </span><a href="#local-6989586621681525114"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-310"></a><span>            </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525124"><a href="#local-6989586621681525124"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-311"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525125"><a href="#local-6989586621681525125"><span class="hs-identifier">tmp_reg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#bindArgToReg"><span class="hs-identifier hs-var">bindArgToReg</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525114"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitAssign"><span class="hs-identifier hs-var">emitAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681525125"><span class="hs-identifier hs-var">tmp_reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>                         </span><span class="hs-special">(</span><a href="StgCmmUtils.html#tagToClosure"><span class="hs-identifier hs-var">tagToClosure</span></a><span> </span><a href="#local-6989586621681525124"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525115"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621681525123"><span class="hs-identifier hs-var">tag_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525126"><a href="#local-6989586621681525126"><span class="hs-identifier">mb_deflt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525127"><a href="#local-6989586621681525127"><span class="hs-identifier">branches</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgAlgAltRhss"><span class="hs-identifier hs-var">cgAlgAltRhss</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#NoGcInAlts"><span class="hs-identifier hs-var">NoGcInAlts</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>                                              </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525114"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525116"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-317"></a><span>                                 </span><span class="hs-comment">-- See Note [GC for conditionals]</span><span>
</span><a name="line-318"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmUtils.html#emitSwitch"><span class="hs-identifier hs-var">emitSwitch</span></a><span> </span><a href="#local-6989586621681525123"><span class="hs-identifier hs-var">tag_expr</span></a><span> </span><a href="#local-6989586621681525127"><span class="hs-identifier hs-var">branches</span></a><span> </span><a href="#local-6989586621681525126"><span class="hs-identifier hs-var">mb_deflt</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConFamilySize</span><span> </span><a href="#local-6989586621681525115"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span>
</span><a name="line-320"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-321"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-322"></a><span>    </span><span class="hs-identifier">do_enum_primop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PrimOp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-323"></a><span>    </span><a name="local-6989586621681525117"><a href="#local-6989586621681525117"><span class="hs-identifier">do_enum_primop</span></a></a><span> </span><span class="hs-identifier hs-var">TagToEnumOp</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681525118"><a href="#local-6989586621681525118"><span class="hs-identifier">arg</span></a></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- No code!</span><span>
</span><a name="line-324"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmEnv.html#getArgAmode"><span class="hs-identifier hs-var">getArgAmode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525118"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-identifier">do_enum_primop</span><span> </span><a name="local-6989586621681525119"><a href="#local-6989586621681525119"><span class="hs-identifier">primop</span></a></a><span> </span><a name="local-6989586621681525120"><a href="#local-6989586621681525120"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-326"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681525121"><a href="#local-6989586621681525121"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-327"></a><span>           </span><a name="local-6989586621681525122"><a href="#local-6989586621681525122"><span class="hs-identifier">tmp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621681525121"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>           </span><a href="StgCmmPrim.html#cgPrimOp"><span class="hs-identifier hs-var">cgPrimOp</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681525122"><span class="hs-identifier hs-var">tmp</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621681525119"><span class="hs-identifier hs-var">primop</span></a><span> </span><a href="#local-6989586621681525120"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-329"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681525122"><span class="hs-identifier hs-var">tmp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-comment">{-
Note [case on bool]
~~~~~~~~~~~~~~~~~~~
This special case handles code like

  case a &lt;# b of
    True -&gt;
    False -&gt;

--&gt;  case tagToEnum# (a &lt;$# b) of
        True -&gt; .. ; False -&gt; ...

--&gt; case (a &lt;$# b) of r -&gt;
    case tagToEnum# r of
        True -&gt; .. ; False -&gt; ...

If we let the ordinary case code handle it, we'll get something like

 tmp1 = a &lt; b
 tmp2 = Bool_closure_tbl[tmp1]
 if (tmp2 &amp; 7 != 0) then ... // normal tagged case

but this junk won't optimise away.  What we really want is just an
inline comparison:

 if (a &lt; b) then ...

So we add a special case to generate

 tmp1 = a &lt; b
 if (tmp1 == 0) then ...

and later optimisations will further improve this.

Now that #6135 has been resolved it should be possible to remove that
special case. The idea behind this special case and pre-6135 implementation
of Bool-returning primops was that tagToEnum# was added implicitly in the
codegen and then optimized away. Now the call to tagToEnum# is explicit
in the source code, which allows to optimize it away at the earlier stages
of compilation (i.e. at the Core level).

Note [Scrutinising VoidRep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have this STG code:
   f = \[s : State# RealWorld] -&gt;
       case s of _ -&gt; blah
This is very odd.  Why are we scrutinising a state token?  But it
can arise with bizarre NOINLINE pragmas (Trac #9964)
    crash :: IO ()
    crash = IO (\s -&gt; let {-# NOINLINE s' #-}
                          s' = s
                      in (# s', () #))

Now the trouble is that 's' has VoidRep, and we do not bind void
arguments in the environment; they don't live anywhere.  See the
calls to nonVoidIds in various places.  So we must not look up
's' in the environment.  Instead, just evaluate the RHS!  Simple.

Note [Dead-binder optimisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A case-binder, or data-constructor argument, may be marked as dead,
because we preserve occurrence-info on binders in CoreTidy (see
CoreTidy.tidyIdBndr).

If the binder is dead, we can sometimes eliminate a load.  While
CmmSink will eliminate that load, it's very easy to kill it at source
(giving CmmSink less work to do), and in any case CmmSink only runs
with -O. Since the majority of case binders are dead, this
optimisation probably still has a great benefit-cost ratio and we want
to keep it for -O0. See also Phab:D5358.

This probably also was the reason for occurrence hack in Phab:D5339 to
exist, perhaps because the occurrence information preserved by
'CoreTidy.tidyIdBndr' was insufficient.  But now that CmmSink does the
job we deleted the hacks.
-}</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">cgCase</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681525128"><a href="#local-6989586621681525128"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525129"><a href="#local-6989586621681525129"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-409"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVoidRep</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier hs-var">idPrimRep</span></a><span> </span><a href="#local-6989586621681525128"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Scrutinising VoidRep]</span><span>
</span><a name="line-410"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681525130"><a href="#local-6989586621681525130"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681525129"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-411"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525130"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-comment">{- Note [Dodgy unsafeCoerce 1]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    case (x :: HValue) |&gt; co of (y :: MutVar# Int)
        DEFAULT -&gt; ...
We want to gnerate an assignment
     y := x
We want to allow this assignment to be generated in the case when the
types are compatible, because this allows some slightly-dodgy but
occasionally-useful casts to be used, such as in RtClosureInspect
where we cast an HValue to a MutVar# so we can print out the contents
of the MutVar#.  If instead we generate code that enters the HValue,
then we'll get a runtime panic, because the HValue really is a
MutVar#.  The types are compatible though, so we can just generate an
assignment.
-}</span><span>
</span><a name="line-429"></a><span class="hs-identifier">cgCase</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681525131"><a href="#local-6989586621681525131"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525132"><a href="#local-6989586621681525132"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525133"><a href="#local-6989586621681525133"><span class="hs-identifier">alt_type</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525134"><a href="#local-6989586621681525134"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-430"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681525131"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Note [Dodgy unsafeCoerce 1]</span><span>
</span><a name="line-431"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681525135"><span class="hs-identifier hs-var">reps_compatible</span></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- assignment suffices for unlifted types</span><span>
</span><a name="line-433"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525138"><a href="#local-6989586621681525138"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-434"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621681525135"><span class="hs-identifier hs-var">reps_compatible</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-435"></a><span>           </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;cgCase: reps do not match, perhaps a dodgy unsafeCoerce?&quot;</span><span>
</span><a name="line-436"></a><span>                    </span><span class="hs-special">(</span><a href="#local-6989586621681525136"><span class="hs-identifier hs-var">pp_bndr</span></a><span> </span><a href="#local-6989586621681525131"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621681525136"><span class="hs-identifier hs-var">pp_bndr</span></a><span> </span><a href="#local-6989586621681525132"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525139"><a href="#local-6989586621681525139"><span class="hs-identifier">v_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getCgIdInfo"><span class="hs-identifier hs-var">getCgIdInfo</span></a><span> </span><a href="#local-6989586621681525131"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-438"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitAssign"><span class="hs-identifier hs-var">emitAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681525138"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525132"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>                    </span><span class="hs-special">(</span><a href="StgCmmEnv.html#idInfoToAmode"><span class="hs-identifier hs-var">idInfoToAmode</span></a><span> </span><a href="#local-6989586621681525139"><span class="hs-identifier hs-var">v_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>       </span><span class="hs-comment">-- Add bndr to the environment</span><span>
</span><a name="line-441"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#bindArgToReg"><span class="hs-identifier hs-var">bindArgToReg</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525132"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmExpr.html#cgAlts"><span class="hs-identifier hs-var">cgAlts</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#NoGcInAlts"><span class="hs-identifier hs-var">NoGcInAlts</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525132"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525133"><span class="hs-identifier hs-var">alt_type</span></a><span> </span><a href="#local-6989586621681525134"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-443"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-444"></a><span>    </span><a name="local-6989586621681525135"><a href="#local-6989586621681525135"><span class="hs-identifier">reps_compatible</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">primRepSlot</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier hs-var">idPrimRep</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525131"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621681525132"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-445"></a><span>      </span><span class="hs-comment">-- Must compare SlotTys, not proper PrimReps, because with unboxed sums,</span><span>
</span><a name="line-446"></a><span>      </span><span class="hs-comment">-- the types of the binders are generated from slotPrimRep and might not</span><span>
</span><a name="line-447"></a><span>      </span><span class="hs-comment">-- match. Test case:</span><span>
</span><a name="line-448"></a><span>      </span><span class="hs-comment">--   swap :: (# Int | Int #) -&gt; (# Int | Int #)</span><span>
</span><a name="line-449"></a><span>      </span><span class="hs-comment">--   swap (# x | #) = (# | x #)</span><span>
</span><a name="line-450"></a><span>      </span><span class="hs-comment">--   swap (# | y #) = (# y | #)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>    </span><a name="local-6989586621681525136"><a href="#local-6989586621681525136"><span class="hs-identifier">pp_bndr</span></a></a><span> </span><a name="local-6989586621681525137"><a href="#local-6989586621681525137"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681525137"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681525137"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier hs-var">idPrimRep</span></a><span> </span><a href="#local-6989586621681525137"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-comment">{- Note [Dodgy unsafeCoerce 2, #3132]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In all other cases of a lifted Id being cast to an unlifted type, the
Id should be bound to bottom, otherwise this is an unsafe use of
unsafeCoerce.  We can generate code to enter the Id and assume that
it will never return.  Hence, we emit the usual enter/return code, and
because bottom must be untagged, it will be entered.  The Sequel is a
type-correct assignment, albeit bogus.  The (dead) continuation loops;
it would be better to invoke some kind of panic function here.
-}</span><span>
</span><a name="line-464"></a><span class="hs-identifier">cgCase</span><span> </span><a name="local-6989586621681525140"><a href="#local-6989586621681525140"><span class="hs-identifier">scrut</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681525141"><a href="#local-6989586621681525141"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525142"><a href="#local-6989586621681525142"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-466"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525143"><a href="#local-6989586621681525143"><span class="hs-identifier">mb_cc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#maybeSaveCostCentre"><span class="hs-identifier hs-var">maybeSaveCostCentre</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-467"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#withSequel"><span class="hs-identifier hs-var">withSequel</span></a><span>
</span><a name="line-468"></a><span>                  </span><span class="hs-special">(</span><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier hs-var">AssignTo</span></a><span> </span><span class="hs-special">[</span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681525142"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525141"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525140"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#restoreCurrentCostCentre"><span class="hs-identifier hs-var">restoreCurrentCostCentre</span></a><span> </span><a href="#local-6989586621681525143"><span class="hs-identifier hs-var">mb_cc</span></a><span>
</span><a name="line-470"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitComment"><span class="hs-identifier hs-var">emitComment</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;should be unreachable code&quot;</span><span>
</span><a name="line-471"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525144"><a href="#local-6989586621681525144"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-472"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621681525144"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-473"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621681525144"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- an infinite loop</span><span>
</span><a name="line-474"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span>
</span><a name="line-475"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">{- Note [Handle seq#]
~~~~~~~~~~~~~~~~~~~~~
See Note [seq# magic] in PrelRules.
The special case for seq# in cgCase does this:

  case seq# a s of v
    (# s', a' #) -&gt; e
==&gt;
  case a of v
    (# s', a' #) -&gt; e

(taking advantage of the fact that the return convention for (# State#, a #)
is the same as the return convention for just 'a')
-}</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-identifier">cgCase</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><span class="hs-identifier hs-var">SeqOp</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621681525145"><a href="#local-6989586621681525145"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525146"><a href="#local-6989586621681525146"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525147"><a href="#local-6989586621681525147"><span class="hs-identifier">alt_type</span></a></a><span> </span><a name="local-6989586621681525148"><a href="#local-6989586621681525148"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-493"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Note [Handle seq#]</span><span>
</span><a name="line-494"></a><span>    </span><span class="hs-comment">-- And see Note [seq# magic] in PrelRules</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-comment">-- Use the same return convention as vanilla 'a'.</span><span>
</span><a name="line-496"></a><span>    </span><a href="StgCmmExpr.html#cgCase"><span class="hs-identifier hs-var">cgCase</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621681525145"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525146"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525147"><span class="hs-identifier hs-var">alt_type</span></a><span> </span><a href="#local-6989586621681525148"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-identifier">cgCase</span><span> </span><a name="local-6989586621681525149"><a href="#local-6989586621681525149"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621681525150"><a href="#local-6989586621681525150"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525151"><a href="#local-6989586621681525151"><span class="hs-identifier">alt_type</span></a></a><span> </span><a name="local-6989586621681525152"><a href="#local-6989586621681525152"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-499"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- the general case</span><span>
</span><a name="line-500"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525155"><a href="#local-6989586621681525155"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-501"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525156"><a href="#local-6989586621681525156"><span class="hs-identifier">up_hp_usg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getVirtHp"><span class="hs-identifier hs-var">getVirtHp</span></a><span>        </span><span class="hs-comment">-- Upstream heap usage</span><span>
</span><a name="line-502"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525157"><a href="#local-6989586621681525157"><span class="hs-identifier">ret_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#chooseReturnBndrs"><span class="hs-identifier hs-var">chooseReturnBndrs</span></a><span> </span><a href="#local-6989586621681525150"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525151"><span class="hs-identifier hs-var">alt_type</span></a><span> </span><a href="#local-6989586621681525152"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-503"></a><span>             </span><a name="local-6989586621681525158"><a href="#local-6989586621681525158"><span class="hs-identifier">alt_regs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681525155"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525157"><span class="hs-identifier hs-var">ret_bndrs</span></a><span>
</span><a name="line-504"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525159"><a href="#local-6989586621681525159"><span class="hs-identifier">simple_scrut</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#isSimpleScrut"><span class="hs-identifier hs-var">isSimpleScrut</span></a><span> </span><a href="#local-6989586621681525149"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621681525151"><span class="hs-identifier hs-var">alt_type</span></a><span>
</span><a name="line-505"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525160"><a href="#local-6989586621681525160"><span class="hs-identifier">do_gc</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681525153"><span class="hs-identifier hs-var">is_cmp_op</span></a><span> </span><a href="#local-6989586621681525149"><span class="hs-identifier hs-var">scrut</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- See Note [GC for conditionals]</span><span>
</span><a name="line-506"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681525159"><span class="hs-identifier hs-var">simple_scrut</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-507"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSingleton</span><span> </span><a href="#local-6989586621681525152"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-508"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681525156"><span class="hs-identifier hs-var">up_hp_usg</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-509"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-510"></a><span>               </span><span class="hs-comment">-- cf Note [Compiling case expressions]</span><span>
</span><a name="line-511"></a><span>             </span><a name="local-6989586621681525161"><a href="#local-6989586621681525161"><span class="hs-identifier">gc_plan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681525160"><span class="hs-identifier hs-var">do_gc</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmExpr.html#GcInAlts"><span class="hs-identifier hs-var">GcInAlts</span></a><span> </span><a href="#local-6989586621681525158"><span class="hs-identifier hs-var">alt_regs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmExpr.html#NoGcInAlts"><span class="hs-identifier hs-var">NoGcInAlts</span></a><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525162"><a href="#local-6989586621681525162"><span class="hs-identifier">mb_cc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#maybeSaveCostCentre"><span class="hs-identifier hs-var">maybeSaveCostCentre</span></a><span> </span><a href="#local-6989586621681525159"><span class="hs-identifier hs-var">simple_scrut</span></a><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525163"><a href="#local-6989586621681525163"><span class="hs-identifier">sequel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier hs-var">AssignTo</span></a><span> </span><a href="#local-6989586621681525158"><span class="hs-identifier hs-var">alt_regs</span></a><span> </span><a href="#local-6989586621681525160"><span class="hs-identifier hs-var">do_gc</span></a><span class="hs-comment">{- Note [scrut sequel] -}</span><span>
</span><a name="line-516"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525164"><a href="#local-6989586621681525164"><span class="hs-identifier">ret_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#withSequel"><span class="hs-identifier hs-var">withSequel</span></a><span> </span><a href="#local-6989586621681525163"><span class="hs-identifier hs-var">sequel</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525149"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span>
</span><a name="line-517"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#restoreCurrentCostCentre"><span class="hs-identifier hs-var">restoreCurrentCostCentre</span></a><span> </span><a href="#local-6989586621681525162"><span class="hs-identifier hs-var">mb_cc</span></a><span>
</span><a name="line-518"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#bindArgsToRegs"><span class="hs-identifier hs-var">bindArgsToRegs</span></a><span> </span><a href="#local-6989586621681525157"><span class="hs-identifier hs-var">ret_bndrs</span></a><span>
</span><a name="line-519"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmExpr.html#cgAlts"><span class="hs-identifier hs-var">cgAlts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525161"><span class="hs-identifier hs-var">gc_plan</span></a><span class="hs-special">,</span><a href="#local-6989586621681525164"><span class="hs-identifier hs-var">ret_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681525150"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525151"><span class="hs-identifier hs-var">alt_type</span></a><span> </span><a href="#local-6989586621681525152"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-520"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-521"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-522"></a><span>    </span><a name="local-6989586621681525153"><a href="#local-6989586621681525153"><span class="hs-identifier">is_cmp_op</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><a name="local-6989586621681525154"><a href="#local-6989586621681525154"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isComparisonPrimOp</span><span> </span><a href="#local-6989586621681525154"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-523"></a><span>    </span><span class="hs-identifier">is_cmp_op</span><span> </span><span class="hs-identifier">_</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span class="hs-comment">{- Note [GC for conditionals]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For boolean conditionals it seems that we have always done NoGcInAlts.
That is, we have always done the GC check before the conditional.
This is enshrined in the special case for
   case tagToEnum# (a&gt;b) of ...
See Note [case on bool]

It's odd, and it's flagrantly inconsistent with the rules described
Note [Compiling case expressions].  However, after eliminating the
tagToEnum# (Trac #13397) we will have:
   case (a&gt;b) of ...
Rather than make it behave quite differently, I am testing for a
comparison operator here in in the general case as well.

ToDo: figure out what the Right Rule should be.

Note [scrut sequel]
~~~~~~~~~~~~~~~~~~~
The job of the scrutinee is to assign its value(s) to alt_regs.
Additionally, if we plan to do a heap-check in the alternatives (see
Note [Compiling case expressions]), then we *must* retreat Hp to
recover any unused heap before passing control to the sequel.  If we
don't do this, then any unused heap will become slop because the heap
check will reset the heap usage. Slop in the heap breaks LDV profiling
(+RTS -hb) which needs to do a linear sweep through the nursery.


Note [Inlining out-of-line primops and heap checks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If shouldInlinePrimOp returns True when called from StgCmmExpr for the
purpose of heap check placement, we *must* inline the primop later in
StgCmmPrim. If we don't things will go wrong.
-}</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-561"></a><span class="hs-identifier">maybeSaveCostCentre</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><a name="maybeSaveCostCentre"><a href="StgCmmExpr.html#maybeSaveCostCentre"><span class="hs-identifier">maybeSaveCostCentre</span></a></a><span> </span><a name="local-6989586621681525165"><a href="#local-6989586621681525165"><span class="hs-identifier">simple_scrut</span></a></a><span>
</span><a name="line-563"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681525165"><span class="hs-identifier hs-var">simple_scrut</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-564"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmProf.html#saveCurrentCostCentre"><span class="hs-identifier hs-var">saveCurrentCostCentre</span></a><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-568"></a><span class="hs-identifier">isSimpleScrut</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- Simple scrutinee, does not block or allocate; hence safe to amalgamate</span><span>
</span><a name="line-570"></a><span class="hs-comment">-- heap usage from alternatives into the stuff before the case</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- NB: if you get this wrong, and claim that the expression doesn't allocate</span><span>
</span><a name="line-572"></a><span class="hs-comment">--     when it does, you'll deeply mess up allocation</span><span>
</span><a name="line-573"></a><a name="isSimpleScrut"><a href="StgCmmExpr.html#isSimpleScrut"><span class="hs-identifier">isSimpleScrut</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a name="local-6989586621681525166"><a href="#local-6989586621681525166"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621681525167"><a href="#local-6989586621681525167"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#isSimpleOp"><span class="hs-identifier hs-var">isSimpleOp</span></a><span> </span><a href="#local-6989586621681525166"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621681525167"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-574"></a><span class="hs-identifier">isSimpleScrut</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- case 1# of { 0# -&gt; ..; ... }</span><span>
</span><a name="line-575"></a><span class="hs-identifier">isSimpleScrut</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- case x# of { 0# -&gt; ..; ... }</span><span>
</span><a name="line-576"></a><span class="hs-identifier">isSimpleScrut</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-identifier">isSimpleOp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#StgOp"><span class="hs-identifier hs-type">StgOp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-579"></a><span class="hs-comment">-- True iff the op cannot block or allocate</span><span>
</span><a name="line-580"></a><a name="isSimpleOp"><a href="StgCmmExpr.html#isSimpleOp"><span class="hs-identifier">isSimpleOp</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgFCallOp"><span class="hs-identifier hs-var">StgFCallOp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCall</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCallSpec</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-keyword">safe</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">playSafe</span><span> </span><span class="hs-keyword">safe</span><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span class="hs-comment">-- dataToTag# evalautes its argument, see Note [dataToTag#] in primops.txt.pp</span><span>
</span><a name="line-582"></a><span class="hs-identifier">isSimpleOp</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><span class="hs-identifier hs-var">DataToTagOp</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-583"></a><span class="hs-identifier">isSimpleOp</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimOp"><span class="hs-identifier hs-var">StgPrimOp</span></a><span> </span><a name="local-6989586621681525169"><a href="#local-6989586621681525169"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681525170"><a href="#local-6989586621681525170"><span class="hs-identifier">stg_args</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-584"></a><span>    </span><a name="local-6989586621681525171"><a href="#local-6989586621681525171"><span class="hs-identifier">arg_exprs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getNonVoidArgAmodes"><span class="hs-identifier hs-var">getNonVoidArgAmodes</span></a><span> </span><a href="#local-6989586621681525170"><span class="hs-identifier hs-var">stg_args</span></a><span>
</span><a name="line-585"></a><span>    </span><a name="local-6989586621681525172"><a href="#local-6989586621681525172"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-586"></a><span>    </span><span class="hs-comment">-- See Note [Inlining out-of-line primops and heap checks]</span><span>
</span><a name="line-587"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmPrim.html#shouldInlinePrimOp"><span class="hs-identifier hs-var">shouldInlinePrimOp</span></a><span> </span><a href="#local-6989586621681525172"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525169"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621681525171"><span class="hs-identifier hs-var">arg_exprs</span></a><span>
</span><a name="line-588"></a><span class="hs-identifier">isSimpleOp</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgPrimCallOp"><span class="hs-identifier hs-var">StgPrimCallOp</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-591"></a><span class="hs-identifier">chooseReturnBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- These are the binders of a case that are assigned by the evaluation of the</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- scrutinee.</span><span>
</span><a name="line-594"></a><span class="hs-comment">-- They're non-void, see Note [Post-unarisation invariants] in UnariseStg.</span><span>
</span><a name="line-595"></a><a name="chooseReturnBndrs"><a href="StgCmmExpr.html#chooseReturnBndrs"><span class="hs-identifier">chooseReturnBndrs</span></a></a><span> </span><a name="local-6989586621681525173"><a href="#local-6989586621681525173"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525174"><a href="#local-6989586621681525174"><span class="hs-identifier">_alts</span></a></a><span>
</span><a name="line-596"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681525173"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">]</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-identifier">chooseReturnBndrs</span><span> </span><a name="local-6989586621681525175"><a href="#local-6989586621681525175"><span class="hs-identifier">_bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><a name="local-6989586621681525176"><a href="#local-6989586621681525176"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681525177"><a href="#local-6989586621681525177"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-599"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ids</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681525177"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">n</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ids</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">_bndr</span><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>    </span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span> </span><a href="#local-6989586621681525177"><span class="hs-identifier hs-var">ids</span></a><span>     </span><span class="hs-comment">-- 'bndr' is not assigned!</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-identifier">chooseReturnBndrs</span><span> </span><a name="local-6989586621681525178"><a href="#local-6989586621681525178"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#AlgAlt"><span class="hs-identifier hs-var">AlgAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525179"><a href="#local-6989586621681525179"><span class="hs-identifier">_alts</span></a></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681525178"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Only 'bndr' is assigned</span><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span class="hs-identifier">chooseReturnBndrs</span><span> </span><a name="local-6989586621681525180"><a href="#local-6989586621681525180"><span class="hs-identifier">bndr</span></a></a><span> </span><a href="StgSyn.html#PolyAlt"><span class="hs-identifier hs-var">PolyAlt</span></a><span> </span><a name="local-6989586621681525181"><a href="#local-6989586621681525181"><span class="hs-identifier">_alts</span></a></a><span>
</span><a name="line-606"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681525180"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Only 'bndr' is assigned</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span class="hs-identifier">chooseReturnBndrs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;chooseReturnBndrs&quot;</span><span>
</span><a name="line-609"></a><span>                             </span><span class="hs-comment">-- MultiValAlt has only one alternative</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-612"></a><span class="hs-identifier">cgAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#GcPlan"><span class="hs-identifier hs-type">GcPlan</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-613"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-614"></a><span class="hs-comment">-- At this point the result of the case are in the binders</span><span>
</span><a name="line-615"></a><a name="cgAlts"><a href="StgCmmExpr.html#cgAlts"><span class="hs-identifier">cgAlts</span></a></a><span> </span><a name="local-6989586621681525182"><a href="#local-6989586621681525182"><span class="hs-identifier">gc_plan</span></a></a><span> </span><a name="local-6989586621681525183"><a href="#local-6989586621681525183"><span class="hs-identifier">_bndr</span></a></a><span> </span><a href="StgSyn.html#PolyAlt"><span class="hs-identifier hs-var">PolyAlt</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681525184"><a href="#local-6989586621681525184"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-616"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#maybeAltHeapCheck"><span class="hs-identifier hs-var">maybeAltHeapCheck</span></a><span> </span><a href="#local-6989586621681525182"><span class="hs-identifier hs-var">gc_plan</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525184"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span class="hs-identifier">cgAlts</span><span> </span><a name="local-6989586621681525185"><a href="#local-6989586621681525185"><span class="hs-identifier">gc_plan</span></a></a><span> </span><a name="local-6989586621681525186"><a href="#local-6989586621681525186"><span class="hs-identifier">_bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681525187"><a href="#local-6989586621681525187"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmExpr.html#maybeAltHeapCheck"><span class="hs-identifier hs-var">maybeAltHeapCheck</span></a><span> </span><a href="#local-6989586621681525185"><span class="hs-identifier hs-var">gc_plan</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525187"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>        </span><span class="hs-comment">-- Here bndrs are *already* in scope, so don't rebind them</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span class="hs-identifier">cgAlts</span><span> </span><a name="local-6989586621681525188"><a href="#local-6989586621681525188"><span class="hs-identifier">gc_plan</span></a></a><span> </span><a name="local-6989586621681525189"><a href="#local-6989586621681525189"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681525190"><a href="#local-6989586621681525190"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525191"><a href="#local-6989586621681525191"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525192"><a href="#local-6989586621681525192"><span class="hs-identifier">tagged_cmms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgAltRhss"><span class="hs-identifier hs-var">cgAltRhss</span></a><span> </span><a href="#local-6989586621681525188"><span class="hs-identifier hs-var">gc_plan</span></a><span> </span><a href="#local-6989586621681525189"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525190"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525193"><a href="#local-6989586621681525193"><span class="hs-identifier">bndr_reg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681525191"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525189"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><a name="local-6989586621681525194"><a href="#local-6989586621681525194"><span class="hs-identifier">deflt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621681525192"><span class="hs-identifier hs-var">tagged_cmms</span></a><span>
</span><a name="line-629"></a><span>                </span><span class="hs-comment">-- PrimAlts always have a DEFAULT case</span><span>
</span><a name="line-630"></a><span>                </span><span class="hs-comment">-- and it always comes first</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span>              </span><a name="local-6989586621681525195"><a href="#local-6989586621681525195"><span class="hs-identifier">tagged_cmms'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681525196"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">,</span><a href="#local-6989586621681525197"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitAlt</span><span> </span><a name="local-6989586621681525196"><a href="#local-6989586621681525196"><span class="hs-identifier">lit</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525197"><a href="#local-6989586621681525197"><span class="hs-identifier">code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681525192"><span class="hs-identifier hs-var">tagged_cmms</span></a><span class="hs-special">]</span><span>
</span><a name="line-634"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmUtils.html#emitCmmLitSwitch"><span class="hs-identifier hs-var">emitCmmLitSwitch</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621681525193"><span class="hs-identifier hs-var">bndr_reg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525195"><span class="hs-identifier hs-var">tagged_cmms'</span></a><span> </span><a href="#local-6989586621681525194"><span class="hs-identifier hs-var">deflt</span></a><span>
</span><a name="line-635"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-identifier">cgAlts</span><span> </span><a name="local-6989586621681525198"><a href="#local-6989586621681525198"><span class="hs-identifier">gc_plan</span></a></a><span> </span><a name="local-6989586621681525199"><a href="#local-6989586621681525199"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#AlgAlt"><span class="hs-identifier hs-var">AlgAlt</span></a><span> </span><a name="local-6989586621681525200"><a href="#local-6989586621681525200"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681525201"><a href="#local-6989586621681525201"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-638"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525202"><a href="#local-6989586621681525202"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-639"></a><span>
</span><a name="line-640"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525203"><a href="#local-6989586621681525203"><span class="hs-identifier">mb_deflt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525204"><a href="#local-6989586621681525204"><span class="hs-identifier">branches</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgAlgAltRhss"><span class="hs-identifier hs-var">cgAlgAltRhss</span></a><span> </span><a href="#local-6989586621681525198"><span class="hs-identifier hs-var">gc_plan</span></a><span> </span><a href="#local-6989586621681525199"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525201"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525205"><a href="#local-6989586621681525205"><span class="hs-identifier">fam_sz</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConFamilySize</span><span> </span><a href="#local-6989586621681525200"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-643"></a><span>              </span><a name="local-6989586621681525206"><a href="#local-6989586621681525206"><span class="hs-identifier">bndr_reg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681525202"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525199"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span>                    </span><span class="hs-comment">-- Is the constructor tag in the node reg?</span><span>
</span><a name="line-646"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#isSmallFamily"><span class="hs-identifier hs-var">isSmallFamily</span></a><span> </span><a href="#local-6989586621681525202"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525205"><span class="hs-identifier hs-var">fam_sz</span></a><span>
</span><a name="line-647"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-648"></a><span>                </span><span class="hs-keyword">let</span><span>   </span><span class="hs-comment">-- Yes, bndr_reg has constr. tag in ls bits</span><span>
</span><a name="line-649"></a><span>                   </span><a name="local-6989586621681525207"><a href="#local-6989586621681525207"><span class="hs-identifier">tag_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmConstrTag1"><span class="hs-identifier hs-var">cmmConstrTag1</span></a><span> </span><a href="#local-6989586621681525202"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621681525206"><span class="hs-identifier hs-var">bndr_reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>                   </span><a name="local-6989586621681525208"><a href="#local-6989586621681525208"><span class="hs-identifier">branches'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681525209"><span class="hs-identifier hs-var">tag</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621681525210"><span class="hs-identifier hs-var">branch</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525209"><a href="#local-6989586621681525209"><span class="hs-identifier">tag</span></a></a><span class="hs-special">,</span><a name="local-6989586621681525210"><a href="#local-6989586621681525210"><span class="hs-identifier">branch</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681525204"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">]</span><span>
</span><a name="line-651"></a><span>                </span><a href="StgCmmUtils.html#emitSwitch"><span class="hs-identifier hs-var">emitSwitch</span></a><span> </span><a href="#local-6989586621681525207"><span class="hs-identifier hs-var">tag_expr</span></a><span> </span><a href="#local-6989586621681525208"><span class="hs-identifier hs-var">branches'</span></a><span> </span><a href="#local-6989586621681525203"><span class="hs-identifier hs-var">mb_deflt</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621681525205"><span class="hs-identifier hs-var">fam_sz</span></a><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- No, get tag from info table</span><span>
</span><a name="line-654"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Note that ptr _always_ has tag 1</span><span>
</span><a name="line-655"></a><span>                    </span><span class="hs-comment">-- when the family size is big enough</span><span>
</span><a name="line-656"></a><span>                    </span><a name="local-6989586621681525211"><a href="#local-6989586621681525211"><span class="hs-identifier">untagged_ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmRegOffB"><span class="hs-identifier hs-var">cmmRegOffB</span></a><span> </span><a href="#local-6989586621681525206"><span class="hs-identifier hs-var">bndr_reg</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>                    </span><a name="local-6989586621681525212"><a href="#local-6989586621681525212"><span class="hs-identifier">tag_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmInfo.html#getConstrTag"><span class="hs-identifier hs-var">getConstrTag</span></a><span> </span><a href="#local-6989586621681525202"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525211"><span class="hs-identifier hs-var">untagged_ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>                </span><span class="hs-keyword">in</span><span> </span><a href="StgCmmUtils.html#emitSwitch"><span class="hs-identifier hs-var">emitSwitch</span></a><span> </span><a href="#local-6989586621681525212"><span class="hs-identifier hs-var">tag_expr</span></a><span> </span><a href="#local-6989586621681525204"><span class="hs-identifier hs-var">branches</span></a><span> </span><a href="#local-6989586621681525203"><span class="hs-identifier hs-var">mb_deflt</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525205"><span class="hs-identifier hs-var">fam_sz</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-identifier">cgAlts</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cgAlts&quot;</span><span>
</span><a name="line-663"></a><span>        </span><span class="hs-comment">-- UbxTupAlt and PolyAlt have only one alternative</span><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span class="hs-comment">-- Note [alg-alt heap check]</span><span>
</span><a name="line-667"></a><span class="hs-comment">--</span><span>
</span><a name="line-668"></a><span class="hs-comment">-- In an algebraic case with more than one alternative, we will have</span><span>
</span><a name="line-669"></a><span class="hs-comment">-- code like</span><span>
</span><a name="line-670"></a><span class="hs-comment">--</span><span>
</span><a name="line-671"></a><span class="hs-comment">-- L0:</span><span>
</span><a name="line-672"></a><span class="hs-comment">--   x = R1</span><span>
</span><a name="line-673"></a><span class="hs-comment">--   goto L1</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- L1:</span><span>
</span><a name="line-675"></a><span class="hs-comment">--   if (x &amp; 7 &gt;= 2) then goto L2 else goto L3</span><span>
</span><a name="line-676"></a><span class="hs-comment">-- L2:</span><span>
</span><a name="line-677"></a><span class="hs-comment">--   Hp = Hp + 16</span><span>
</span><a name="line-678"></a><span class="hs-comment">--   if (Hp &gt; HpLim) then goto L4</span><span>
</span><a name="line-679"></a><span class="hs-comment">--   ...</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- L4:</span><span>
</span><a name="line-681"></a><span class="hs-comment">--   call gc() returns to L5</span><span>
</span><a name="line-682"></a><span class="hs-comment">-- L5:</span><span>
</span><a name="line-683"></a><span class="hs-comment">--   x = R1</span><span>
</span><a name="line-684"></a><span class="hs-comment">--   goto L1</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-687"></a><span class="hs-identifier">cgAlgAltRhss</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#GcPlan"><span class="hs-identifier hs-type">GcPlan</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-688"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span>
</span><a name="line-689"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ConTagZ</span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-690"></a><a name="cgAlgAltRhss"><a href="StgCmmExpr.html#cgAlgAltRhss"><span class="hs-identifier">cgAlgAltRhss</span></a></a><span> </span><a name="local-6989586621681525213"><a href="#local-6989586621681525213"><span class="hs-identifier">gc_plan</span></a></a><span> </span><a name="local-6989586621681525214"><a href="#local-6989586621681525214"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525215"><a href="#local-6989586621681525215"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-691"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525216"><a href="#local-6989586621681525216"><span class="hs-identifier">tagged_cmms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgAltRhss"><span class="hs-identifier hs-var">cgAltRhss</span></a><span> </span><a href="#local-6989586621681525213"><span class="hs-identifier hs-var">gc_plan</span></a><span> </span><a href="#local-6989586621681525214"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681525215"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525217"><a href="#local-6989586621681525217"><span class="hs-identifier">mb_deflt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681525216"><span class="hs-identifier hs-var">tagged_cmms</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-694"></a><span>                           </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><a name="local-6989586621681525219"><a href="#local-6989586621681525219"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681525219"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-695"></a><span>                           </span><a name="local-6989586621681525220"><a href="#local-6989586621681525220"><span class="hs-identifier">_other</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-696"></a><span>                            </span><span class="hs-comment">-- DEFAULT is always first, if present</span><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525218"><a href="#local-6989586621681525218"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTagZ</span><span> </span><a href="#local-6989586621681525221"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681525222"><span class="hs-identifier hs-var">cmm</span></a><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621681525221"><a href="#local-6989586621681525221"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525222"><a href="#local-6989586621681525222"><span class="hs-identifier">cmm</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681525216"><span class="hs-identifier hs-var">tagged_cmms</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-700"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525217"><span class="hs-identifier hs-var">mb_deflt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681525218"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-707"></a><span class="hs-identifier">cgAltRhss</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#GcPlan"><span class="hs-identifier hs-type">GcPlan</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-708"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">AltCon</span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-709"></a><a name="cgAltRhss"><a href="StgCmmExpr.html#cgAltRhss"><span class="hs-identifier">cgAltRhss</span></a></a><span> </span><a name="local-6989586621681525223"><a href="#local-6989586621681525223"><span class="hs-identifier">gc_plan</span></a></a><span> </span><a name="local-6989586621681525224"><a href="#local-6989586621681525224"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681525225"><a href="#local-6989586621681525225"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-710"></a><span>  </span><a name="local-6989586621681525226"><a href="#local-6989586621681525226"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-711"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-712"></a><span>    </span><a name="local-6989586621681525227"><a href="#local-6989586621681525227"><span class="hs-identifier">base_reg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681525226"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525224"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-713"></a><span>    </span><span class="hs-identifier">cg_alt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgAlt"><span class="hs-identifier hs-type">CgStgAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AltCon</span><span class="hs-special">,</span><span> </span><a href="MkGraph.html#CmmAGraphScoped"><span class="hs-identifier hs-type">CmmAGraphScoped</span></a><span class="hs-special">)</span><span>
</span><a name="line-714"></a><span>    </span><a name="local-6989586621681525228"><a href="#local-6989586621681525228"><span class="hs-identifier">cg_alt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681525229"><a href="#local-6989586621681525229"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525230"><a href="#local-6989586621681525230"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525231"><a href="#local-6989586621681525231"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#getCodeScoped"><span class="hs-identifier hs-var">getCodeScoped</span></a><span>             </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-716"></a><span>        </span><a href="StgCmmExpr.html#maybeAltHeapCheck"><span class="hs-identifier hs-var">maybeAltHeapCheck</span></a><span> </span><a href="#local-6989586621681525223"><span class="hs-identifier hs-var">gc_plan</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-717"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmCon.html#bindConArgs"><span class="hs-identifier hs-var">bindConArgs</span></a><span> </span><a href="#local-6989586621681525229"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621681525227"><span class="hs-identifier hs-var">base_reg</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span> </span><a href="#local-6989586621681525230"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>                    </span><span class="hs-comment">-- alt binders are always non-void,</span><span>
</span><a name="line-719"></a><span>                    </span><span class="hs-comment">-- see Note [Post-unarisation invariants] in UnariseStg</span><span>
</span><a name="line-720"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681525231"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-721"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681525229"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-722"></a><span>  </span><a href="StgCmmMonad.html#forkAlts"><span class="hs-identifier hs-var">forkAlts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681525228"><span class="hs-identifier hs-var">cg_alt</span></a><span> </span><a href="#local-6989586621681525225"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-identifier">maybeAltHeapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#GcPlan"><span class="hs-identifier hs-type">GcPlan</span></a><span class="hs-special">,</span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621681525043"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621681525043"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-725"></a><a name="maybeAltHeapCheck"><a href="StgCmmExpr.html#maybeAltHeapCheck"><span class="hs-identifier">maybeAltHeapCheck</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#NoGcInAlts"><span class="hs-identifier hs-var">NoGcInAlts</span></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621681525232"><a href="#local-6989586621681525232"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681525232"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-726"></a><span class="hs-identifier">maybeAltHeapCheck</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#GcInAlts"><span class="hs-identifier hs-var">GcInAlts</span></a><span> </span><a name="local-6989586621681525233"><a href="#local-6989586621681525233"><span class="hs-identifier">regs</span></a></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681525234"><a href="#local-6989586621681525234"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-727"></a><span>  </span><a href="StgCmmHeap.html#altHeapCheck"><span class="hs-identifier hs-var">altHeapCheck</span></a><span> </span><a href="#local-6989586621681525233"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621681525234"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-728"></a><span class="hs-identifier">maybeAltHeapCheck</span><span> </span><span class="hs-special">(</span><a href="StgCmmExpr.html#GcInAlts"><span class="hs-identifier hs-var">GcInAlts</span></a><span> </span><a name="local-6989586621681525235"><a href="#local-6989586621681525235"><span class="hs-identifier">regs</span></a></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#ReturnedTo"><span class="hs-identifier hs-var">ReturnedTo</span></a><span> </span><a name="local-6989586621681525236"><a href="#local-6989586621681525236"><span class="hs-identifier">lret</span></a></a><span> </span><a name="local-6989586621681525237"><a href="#local-6989586621681525237"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681525238"><a href="#local-6989586621681525238"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-729"></a><span>  </span><a href="StgCmmHeap.html#altHeapCheckReturnsTo"><span class="hs-identifier hs-var">altHeapCheckReturnsTo</span></a><span> </span><a href="#local-6989586621681525235"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621681525236"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621681525237"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621681525238"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-732"></a><span class="hs-comment">--      Tail calls</span><span>
</span><a name="line-733"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span class="hs-identifier">cgConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-736"></a><a name="cgConApp"><a href="StgCmmExpr.html#cgConApp"><span class="hs-identifier">cgConApp</span></a></a><span> </span><a name="local-6989586621681525239"><a href="#local-6989586621681525239"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621681525240"><a href="#local-6989586621681525240"><span class="hs-identifier">stg_args</span></a></a><span>
</span><a name="line-737"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleCon</span><span> </span><a href="#local-6989586621681525239"><span class="hs-identifier hs-var">con</span></a><span>       </span><span class="hs-comment">-- Unboxed tuple: assign and return</span><span>
</span><a name="line-738"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525241"><a href="#local-6989586621681525241"><span class="hs-identifier">arg_exprs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getNonVoidArgAmodes"><span class="hs-identifier hs-var">getNonVoidArgAmodes</span></a><span> </span><a href="#local-6989586621681525240"><span class="hs-identifier hs-var">stg_args</span></a><span>
</span><a name="line-739"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#tickyUnboxedTupleReturn"><span class="hs-identifier hs-var">tickyUnboxedTupleReturn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681525241"><span class="hs-identifier hs-var">arg_exprs</span></a><span class="hs-special">)</span><span>
</span><a name="line-740"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><a href="#local-6989586621681525241"><span class="hs-identifier hs-var">arg_exprs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">--  Boxed constructors; allocate and return</span><span>
</span><a name="line-743"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">stg_args</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">countConRepArgs</span><span> </span><span class="hs-identifier hs-var">con</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">con</span><span> </span><a href="#local-6989586621681525239"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><span class="hs-identifier">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">countConRepArgs</span><span> </span><span class="hs-identifier">con</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">stg_args</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525242"><a href="#local-6989586621681525242"><span class="hs-identifier">idinfo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525243"><a href="#local-6989586621681525243"><span class="hs-identifier">fcode_init</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmCon.html#buildDynCon"><span class="hs-identifier hs-var">buildDynCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWorkId</span><span> </span><a href="#local-6989586621681525239"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-745"></a><span>                                     </span><span class="hs-identifier hs-var">currentCCS</span><span> </span><a href="#local-6989586621681525239"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#assertNonVoidStgArgs"><span class="hs-identifier hs-var">assertNonVoidStgArgs</span></a><span> </span><a href="#local-6989586621681525240"><span class="hs-identifier hs-var">stg_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-746"></a><span>                                     </span><span class="hs-comment">-- con args are always non-void,</span><span>
</span><a name="line-747"></a><span>                                     </span><span class="hs-comment">-- see Note [Post-unarisation invariants] in UnariseStg</span><span>
</span><a name="line-748"></a><span>                </span><span class="hs-comment">-- The first &quot;con&quot; says that the name bound to this</span><span>
</span><a name="line-749"></a><span>                </span><span class="hs-comment">-- closure is &quot;con&quot;, which is a bit of a fudge, but</span><span>
</span><a name="line-750"></a><span>                </span><span class="hs-comment">-- it only affects profiling (hence the False)</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="#local-6989586621681525243"><span class="hs-identifier hs-var">fcode_init</span></a><span>
</span><a name="line-753"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#tickyReturnNewCon"><span class="hs-identifier hs-var">tickyReturnNewCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681525240"><span class="hs-identifier hs-var">stg_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">[</span><a href="StgCmmEnv.html#idInfoToAmode"><span class="hs-identifier hs-var">idInfoToAmode</span></a><span> </span><a href="#local-6989586621681525242"><span class="hs-identifier hs-var">idinfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span class="hs-identifier">cgIdApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-757"></a><a name="cgIdApp"><a href="StgCmmExpr.html#cgIdApp"><span class="hs-identifier">cgIdApp</span></a></a><span> </span><a name="local-6989586621681525244"><a href="#local-6989586621681525244"><span class="hs-identifier">fun_id</span></a></a><span> </span><a name="local-6989586621681525245"><a href="#local-6989586621681525245"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-758"></a><span>    </span><a name="local-6989586621681525246"><a href="#local-6989586621681525246"><span class="hs-identifier">dflags</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-759"></a><span>    </span><a name="local-6989586621681525247"><a href="#local-6989586621681525247"><span class="hs-identifier">fun_info</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getCgIdInfo"><span class="hs-identifier hs-var">getCgIdInfo</span></a><span> </span><a href="#local-6989586621681525244"><span class="hs-identifier hs-var">fun_id</span></a><span>
</span><a name="line-760"></a><span>    </span><a name="local-6989586621681525248"><a href="#local-6989586621681525248"><span class="hs-identifier">self_loop_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getSelfLoop"><span class="hs-identifier hs-var">getSelfLoop</span></a><span>
</span><a name="line-761"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525249"><a href="#local-6989586621681525249"><span class="hs-identifier">cg_fun_id</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cg_id</span><span> </span><a href="#local-6989586621681525247"><span class="hs-identifier hs-var">fun_info</span></a><span>
</span><a name="line-762"></a><span>           </span><span class="hs-comment">-- NB: use (cg_id fun_info) instead of fun_id, because</span><span>
</span><a name="line-763"></a><span>           </span><span class="hs-comment">-- the former may be externalised for -split-objs.</span><span>
</span><a name="line-764"></a><span>           </span><span class="hs-comment">-- See Note [Externalise when splitting] in StgCmmMonad</span><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span>        </span><a name="local-6989586621681525250"><a href="#local-6989586621681525250"><span class="hs-identifier">fun_arg</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621681525249"><span class="hs-identifier hs-var">cg_fun_id</span></a><span>
</span><a name="line-767"></a><span>        </span><a name="local-6989586621681525251"><a href="#local-6989586621681525251"><span class="hs-identifier">fun_name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span>    </span><a href="#local-6989586621681525249"><span class="hs-identifier hs-var">cg_fun_id</span></a><span>
</span><a name="line-768"></a><span>        </span><a name="local-6989586621681525252"><a href="#local-6989586621681525252"><span class="hs-identifier">fun</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmEnv.html#idInfoToAmode"><span class="hs-identifier hs-var">idInfoToAmode</span></a><span> </span><a href="#local-6989586621681525247"><span class="hs-identifier hs-var">fun_info</span></a><span>
</span><a name="line-769"></a><span>        </span><a name="local-6989586621681525253"><a href="#local-6989586621681525253"><span class="hs-identifier">lf_info</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cg_lf</span><span>         </span><a href="#local-6989586621681525247"><span class="hs-identifier hs-var">fun_info</span></a><span>
</span><a name="line-770"></a><span>        </span><a name="local-6989586621681525254"><a href="#local-6989586621681525254"><span class="hs-identifier">n_args</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-771"></a><span>        </span><a name="local-6989586621681525255"><a href="#local-6989586621681525255"><span class="hs-identifier">v_args</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isVoidTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-772"></a><span>        </span><a name="local-6989586621681525256"><a href="#local-6989586621681525256"><span class="hs-identifier">node_points</span></a></a><span> </span><a name="local-6989586621681525257"><a href="#local-6989586621681525257"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#nodeMustPointToIt"><span class="hs-identifier hs-var">nodeMustPointToIt</span></a><span> </span><a href="#local-6989586621681525257"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525253"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-773"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="StgCmmClosure.html#getCallMethod"><span class="hs-identifier hs-var">getCallMethod</span></a><span> </span><a href="#local-6989586621681525246"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525251"><span class="hs-identifier hs-var">fun_name</span></a><span> </span><a href="#local-6989586621681525249"><span class="hs-identifier hs-var">cg_fun_id</span></a><span> </span><a href="#local-6989586621681525253"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681525254"><span class="hs-identifier hs-var">n_args</span></a><span> </span><a href="#local-6989586621681525255"><span class="hs-identifier hs-var">v_args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cg_loc</span><span> </span><a href="#local-6989586621681525247"><span class="hs-identifier hs-var">fun_info</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525248"><span class="hs-identifier hs-var">self_loop_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-774"></a><span>            </span><span class="hs-comment">-- A value in WHNF, so we can just return it.</span><span>
</span><a name="line-775"></a><span>        </span><a href="StgCmmClosure.html#ReturnIt"><span class="hs-identifier hs-var">ReturnIt</span></a><span>
</span><a name="line-776"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVoidTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681525244"><span class="hs-identifier hs-var">fun_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-777"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681525252"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">]</span><span>
</span><a name="line-778"></a><span>          </span><span class="hs-comment">-- ToDo: does ReturnIt guarantee tagged?</span><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>        </span><a href="StgCmmClosure.html#EnterIt"><span class="hs-identifier hs-var">EnterIt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Discarding arguments</span><span>
</span><a name="line-781"></a><span>                   </span><a href="StgCmmExpr.html#emitEnter"><span class="hs-identifier hs-var">emitEnter</span></a><span> </span><a href="#local-6989586621681525252"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span>        </span><a href="StgCmmClosure.html#SlowCall"><span class="hs-identifier hs-var">SlowCall</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>      </span><span class="hs-comment">-- A slow function call via the RTS apply routines</span><span>
</span><a name="line-784"></a><span>                </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#tickySlowCall"><span class="hs-identifier hs-var">tickySlowCall</span></a><span> </span><a href="#local-6989586621681525253"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-785"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emitComment"><span class="hs-identifier hs-var">emitComment</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;slowCall&quot;</span><span>
</span><a name="line-786"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#slowCall"><span class="hs-identifier hs-var">slowCall</span></a><span> </span><a href="#local-6989586621681525252"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span>        </span><span class="hs-comment">-- A direct function call (possibly with some left-over arguments)</span><span>
</span><a name="line-789"></a><span>        </span><a href="StgCmmClosure.html#DirectEntry"><span class="hs-identifier hs-var">DirectEntry</span></a><span> </span><a name="local-6989586621681525258"><a href="#local-6989586621681525258"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681525259"><a href="#local-6989586621681525259"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-790"></a><span>                </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#tickyDirectCall"><span class="hs-identifier hs-var">tickyDirectCall</span></a><span> </span><a href="#local-6989586621681525259"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-791"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681525256"><span class="hs-identifier hs-var">node_points</span></a><span> </span><a href="#local-6989586621681525246"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-792"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmLayout.html#directCall"><span class="hs-identifier hs-var">directCall</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span>   </span><a href="#local-6989586621681525258"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681525259"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525250"><span class="hs-identifier hs-var">fun_arg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-793"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmLayout.html#directCall"><span class="hs-identifier hs-var">directCall</span></a><span> </span><a href="CmmNode.html#NativeDirectCall"><span class="hs-identifier hs-var">NativeDirectCall</span></a><span> </span><a href="#local-6989586621681525258"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681525259"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span>        </span><span class="hs-comment">-- Let-no-escape call or self-recursive tail-call</span><span>
</span><a name="line-796"></a><span>        </span><a href="StgCmmClosure.html#JumpToIt"><span class="hs-identifier hs-var">JumpToIt</span></a><span> </span><a name="local-6989586621681525260"><a href="#local-6989586621681525260"><span class="hs-identifier">blk_id</span></a></a><span> </span><a name="local-6989586621681525261"><a href="#local-6989586621681525261"><span class="hs-identifier">lne_regs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-797"></a><span>          </span><span class="hs-special">{</span><span> </span><a href="StgCmmLayout.html#adjustHpBackwards"><span class="hs-identifier hs-var">adjustHpBackwards</span></a><span> </span><span class="hs-comment">-- always do this before a tail-call</span><span>
</span><a name="line-798"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525262"><a href="#local-6989586621681525262"><span class="hs-identifier">cmm_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getNonVoidArgAmodes"><span class="hs-identifier hs-var">getNonVoidArgAmodes</span></a><span> </span><a href="#local-6989586621681525245"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-799"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="StgCmmUtils.html#emitMultiAssign"><span class="hs-identifier hs-var">emitMultiAssign</span></a><span> </span><a href="#local-6989586621681525261"><span class="hs-identifier hs-var">lne_regs</span></a><span> </span><a href="#local-6989586621681525262"><span class="hs-identifier hs-var">cmm_args</span></a><span>
</span><a name="line-800"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621681525260"><span class="hs-identifier hs-var">blk_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-802"></a><span>
</span><a name="line-803"></a><span class="hs-comment">-- Note [Self-recursive tail calls]</span><span>
</span><a name="line-804"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-805"></a><span class="hs-comment">--</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- Self-recursive tail calls can be optimized into a local jump in the same</span><span>
</span><a name="line-807"></a><span class="hs-comment">-- way as let-no-escape bindings (see Note [What is a non-escaping let] in</span><span>
</span><a name="line-808"></a><span class="hs-comment">-- stgSyn/CoreToStg.hs). Consider this:</span><span>
</span><a name="line-809"></a><span class="hs-comment">--</span><span>
</span><a name="line-810"></a><span class="hs-comment">-- foo.info:</span><span>
</span><a name="line-811"></a><span class="hs-comment">--     a = R1  // calling convention</span><span>
</span><a name="line-812"></a><span class="hs-comment">--     b = R2</span><span>
</span><a name="line-813"></a><span class="hs-comment">--     goto L1</span><span>
</span><a name="line-814"></a><span class="hs-comment">-- L1: ...</span><span>
</span><a name="line-815"></a><span class="hs-comment">--     ...</span><span>
</span><a name="line-816"></a><span class="hs-comment">-- ...</span><span>
</span><a name="line-817"></a><span class="hs-comment">-- L2: R1 = x</span><span>
</span><a name="line-818"></a><span class="hs-comment">--     R2 = y</span><span>
</span><a name="line-819"></a><span class="hs-comment">--     call foo(R1,R2)</span><span>
</span><a name="line-820"></a><span class="hs-comment">--</span><span>
</span><a name="line-821"></a><span class="hs-comment">-- Instead of putting x and y into registers (or other locations required by the</span><span>
</span><a name="line-822"></a><span class="hs-comment">-- calling convention) and performing a call we can put them into local</span><span>
</span><a name="line-823"></a><span class="hs-comment">-- variables a and b and perform jump to L1:</span><span>
</span><a name="line-824"></a><span class="hs-comment">--</span><span>
</span><a name="line-825"></a><span class="hs-comment">-- foo.info:</span><span>
</span><a name="line-826"></a><span class="hs-comment">--     a = R1</span><span>
</span><a name="line-827"></a><span class="hs-comment">--     b = R2</span><span>
</span><a name="line-828"></a><span class="hs-comment">--     goto L1</span><span>
</span><a name="line-829"></a><span class="hs-comment">-- L1: ...</span><span>
</span><a name="line-830"></a><span class="hs-comment">--     ...</span><span>
</span><a name="line-831"></a><span class="hs-comment">-- ...</span><span>
</span><a name="line-832"></a><span class="hs-comment">-- L2: a = x</span><span>
</span><a name="line-833"></a><span class="hs-comment">--     b = y</span><span>
</span><a name="line-834"></a><span class="hs-comment">--     goto L1</span><span>
</span><a name="line-835"></a><span class="hs-comment">--</span><span>
</span><a name="line-836"></a><span class="hs-comment">-- This can be done only when function is calling itself in a tail position</span><span>
</span><a name="line-837"></a><span class="hs-comment">-- and only if the call passes number of parameters equal to function's arity.</span><span>
</span><a name="line-838"></a><span class="hs-comment">-- Note that this cannot be performed if a function calls itself with a</span><span>
</span><a name="line-839"></a><span class="hs-comment">-- continuation.</span><span>
</span><a name="line-840"></a><span class="hs-comment">--</span><span>
</span><a name="line-841"></a><span class="hs-comment">-- This in fact implements optimization known as &quot;loopification&quot;. It was</span><span>
</span><a name="line-842"></a><span class="hs-comment">-- described in &quot;Low-level code optimizations in the Glasgow Haskell Compiler&quot;</span><span>
</span><a name="line-843"></a><span class="hs-comment">-- by Krzysztof Wo&#347;, though we use different approach. Krzysztof performed his</span><span>
</span><a name="line-844"></a><span class="hs-comment">-- optimization at the Cmm level, whereas we perform ours during code generation</span><span>
</span><a name="line-845"></a><span class="hs-comment">-- (Stg-to-Cmm pass) essentially making sure that optimized Cmm code is</span><span>
</span><a name="line-846"></a><span class="hs-comment">-- generated in the first place.</span><span>
</span><a name="line-847"></a><span class="hs-comment">--</span><span>
</span><a name="line-848"></a><span class="hs-comment">-- Implementation is spread across a couple of places in the code:</span><span>
</span><a name="line-849"></a><span class="hs-comment">--</span><span>
</span><a name="line-850"></a><span class="hs-comment">--   * FCode monad stores additional information in its reader environment</span><span>
</span><a name="line-851"></a><span class="hs-comment">--     (cgd_self_loop field). This information tells us which function can</span><span>
</span><a name="line-852"></a><span class="hs-comment">--     tail call itself in an optimized way (it is the function currently</span><span>
</span><a name="line-853"></a><span class="hs-comment">--     being compiled), what is the label of a loop header (L1 in example above)</span><span>
</span><a name="line-854"></a><span class="hs-comment">--     and information about local registers in which we should arguments</span><span>
</span><a name="line-855"></a><span class="hs-comment">--     before making a call (this would be a and b in example above).</span><span>
</span><a name="line-856"></a><span class="hs-comment">--</span><span>
</span><a name="line-857"></a><span class="hs-comment">--   * Whenever we are compiling a function, we set that information to reflect</span><span>
</span><a name="line-858"></a><span class="hs-comment">--     the fact that function currently being compiled can be jumped to, instead</span><span>
</span><a name="line-859"></a><span class="hs-comment">--     of called. This is done in closureCodyBody in StgCmmBind.</span><span>
</span><a name="line-860"></a><span class="hs-comment">--</span><span>
</span><a name="line-861"></a><span class="hs-comment">--   * We also have to emit a label to which we will be jumping. We make sure</span><span>
</span><a name="line-862"></a><span class="hs-comment">--     that the label is placed after a stack check but before the heap</span><span>
</span><a name="line-863"></a><span class="hs-comment">--     check. The reason is that making a recursive tail-call does not increase</span><span>
</span><a name="line-864"></a><span class="hs-comment">--     the stack so we only need to check once. But it may grow the heap, so we</span><span>
</span><a name="line-865"></a><span class="hs-comment">--     have to repeat the heap check in every self-call. This is done in</span><span>
</span><a name="line-866"></a><span class="hs-comment">--     do_checks in StgCmmHeap.</span><span>
</span><a name="line-867"></a><span class="hs-comment">--</span><span>
</span><a name="line-868"></a><span class="hs-comment">--   * When we begin compilation of another closure we remove the additional</span><span>
</span><a name="line-869"></a><span class="hs-comment">--     information from the environment. This is done by forkClosureBody</span><span>
</span><a name="line-870"></a><span class="hs-comment">--     in StgCmmMonad. Other functions that duplicate the environment -</span><span>
</span><a name="line-871"></a><span class="hs-comment">--     forkLneBody, forkAlts, codeOnly - duplicate that information. In other</span><span>
</span><a name="line-872"></a><span class="hs-comment">--     words, we only need to clean the environment of the self-loop information</span><span>
</span><a name="line-873"></a><span class="hs-comment">--     when compiling right hand side of a closure (binding).</span><span>
</span><a name="line-874"></a><span class="hs-comment">--</span><span>
</span><a name="line-875"></a><span class="hs-comment">--   * When compiling a call (cgIdApp) we use getCallMethod to decide what kind</span><span>
</span><a name="line-876"></a><span class="hs-comment">--     of call will be generated. getCallMethod decides to generate a self</span><span>
</span><a name="line-877"></a><span class="hs-comment">--     recursive tail call when (a) environment stores information about</span><span>
</span><a name="line-878"></a><span class="hs-comment">--     possible self tail-call; (b) that tail call is to a function currently</span><span>
</span><a name="line-879"></a><span class="hs-comment">--     being compiled; (c) number of passed non-void arguments is equal to</span><span>
</span><a name="line-880"></a><span class="hs-comment">--     function's arity. (d) loopification is turned on via -floopification</span><span>
</span><a name="line-881"></a><span class="hs-comment">--     command-line option.</span><span>
</span><a name="line-882"></a><span class="hs-comment">--</span><span>
</span><a name="line-883"></a><span class="hs-comment">--   * Command line option to turn loopification on and off is implemented in</span><span>
</span><a name="line-884"></a><span class="hs-comment">--     DynFlags.</span><span>
</span><a name="line-885"></a><span class="hs-comment">--</span><span>
</span><a name="line-886"></a><span class="hs-comment">--</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- Note [Void arguments in self-recursive tail calls]</span><span>
</span><a name="line-888"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-889"></a><span class="hs-comment">--</span><span>
</span><a name="line-890"></a><span class="hs-comment">-- State# tokens can get in the way of the loopification optimization as seen in</span><span>
</span><a name="line-891"></a><span class="hs-comment">-- #11372. Consider this:</span><span>
</span><a name="line-892"></a><span class="hs-comment">--</span><span>
</span><a name="line-893"></a><span class="hs-comment">-- foo :: [a]</span><span>
</span><a name="line-894"></a><span class="hs-comment">--     -&gt; (a -&gt; State# s -&gt; (# State s, Bool #))</span><span>
</span><a name="line-895"></a><span class="hs-comment">--     -&gt; State# s</span><span>
</span><a name="line-896"></a><span class="hs-comment">--     -&gt; (# State# s, Maybe a #)</span><span>
</span><a name="line-897"></a><span class="hs-comment">-- foo [] f s = (# s, Nothing #)</span><span>
</span><a name="line-898"></a><span class="hs-comment">-- foo (x:xs) f s = case f x s of</span><span>
</span><a name="line-899"></a><span class="hs-comment">--      (# s', b #) -&gt; case b of</span><span>
</span><a name="line-900"></a><span class="hs-comment">--          True -&gt; (# s', Just x #)</span><span>
</span><a name="line-901"></a><span class="hs-comment">--          False -&gt; foo xs f s'</span><span>
</span><a name="line-902"></a><span class="hs-comment">--</span><span>
</span><a name="line-903"></a><span class="hs-comment">-- We would like to compile the call to foo as a local jump instead of a call</span><span>
</span><a name="line-904"></a><span class="hs-comment">-- (see Note [Self-recursive tail calls]). However, the generated function has</span><span>
</span><a name="line-905"></a><span class="hs-comment">-- an arity of 2 while we apply it to 3 arguments, one of them being of void</span><span>
</span><a name="line-906"></a><span class="hs-comment">-- type. Thus, we mustn't count arguments of void type when checking whether</span><span>
</span><a name="line-907"></a><span class="hs-comment">-- we can turn a call into a self-recursive jump.</span><span>
</span><a name="line-908"></a><span class="hs-comment">--</span><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span class="hs-identifier">emitEnter</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-911"></a><a name="emitEnter"><a href="StgCmmExpr.html#emitEnter"><span class="hs-identifier">emitEnter</span></a></a><span> </span><a name="local-6989586621681525263"><a href="#local-6989586621681525263"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-912"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525264"><a href="#local-6989586621681525264"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-913"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#adjustHpBackwards"><span class="hs-identifier hs-var">adjustHpBackwards</span></a><span>
</span><a name="line-914"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525265"><a href="#local-6989586621681525265"><span class="hs-identifier">sequel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getSequel"><span class="hs-identifier hs-var">getSequel</span></a><span>
</span><a name="line-915"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525266"><a href="#local-6989586621681525266"><span class="hs-identifier">updfr_off</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-916"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681525265"><span class="hs-identifier hs-var">sequel</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-917"></a><span>      </span><span class="hs-comment">-- For a return, we have the option of generating a tag-test or</span><span>
</span><a name="line-918"></a><span>      </span><span class="hs-comment">-- not.  If the value is tagged, we can return directly, which</span><span>
</span><a name="line-919"></a><span>      </span><span class="hs-comment">-- is quicker than entering the value.  This is a code</span><span>
</span><a name="line-920"></a><span>      </span><span class="hs-comment">-- size/speed trade-off: when optimising for speed rather than</span><span>
</span><a name="line-921"></a><span>      </span><span class="hs-comment">-- size we could generate the tag test.</span><span>
</span><a name="line-922"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-923"></a><span>      </span><span class="hs-comment">-- Right now, we do what the old codegen did, and omit the tag</span><span>
</span><a name="line-924"></a><span>      </span><span class="hs-comment">-- test, just generating an enter.</span><span>
</span><a name="line-925"></a><span>      </span><a href="StgCmmMonad.html#Return"><span class="hs-identifier hs-var">Return</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-926"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525267"><a href="#local-6989586621681525267"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmInfo.html#entryCode"><span class="hs-identifier hs-var">entryCode</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmInfo.html#closureInfoPtr"><span class="hs-identifier hs-var">closureInfoPtr</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#nodeReg"><span class="hs-identifier hs-var">nodeReg</span></a><span>
</span><a name="line-927"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#mkJump"><span class="hs-identifier hs-var">mkJump</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span> </span><a href="#local-6989586621681525267"><span class="hs-identifier hs-var">entry</span></a><span>
</span><a name="line-928"></a><span>                        </span><span class="hs-special">[</span><a href="CmmUtils.html#cmmUntag"><span class="hs-identifier hs-var">cmmUntag</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525263"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621681525266"><span class="hs-identifier hs-var">updfr_off</span></a><span>
</span><a name="line-929"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span>
</span><a name="line-930"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span>      </span><span class="hs-comment">-- The result will be scrutinised in the sequel.  This is where</span><span>
</span><a name="line-933"></a><span>      </span><span class="hs-comment">-- we generate a tag-test to avoid entering the closure if</span><span>
</span><a name="line-934"></a><span>      </span><span class="hs-comment">-- possible.</span><span>
</span><a name="line-935"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-936"></a><span>      </span><span class="hs-comment">-- The generated code will be something like this:</span><span>
</span><a name="line-937"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-938"></a><span>      </span><span class="hs-comment">--    R1 = fun  -- copyout</span><span>
</span><a name="line-939"></a><span>      </span><span class="hs-comment">--    if (fun &amp; 7 != 0) goto Lret else goto Lcall</span><span>
</span><a name="line-940"></a><span>      </span><span class="hs-comment">--  Lcall:</span><span>
</span><a name="line-941"></a><span>      </span><span class="hs-comment">--    call [fun] returns to Lret</span><span>
</span><a name="line-942"></a><span>      </span><span class="hs-comment">--  Lret:</span><span>
</span><a name="line-943"></a><span>      </span><span class="hs-comment">--    fun' = R1  -- copyin</span><span>
</span><a name="line-944"></a><span>      </span><span class="hs-comment">--    ...</span><span>
</span><a name="line-945"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-946"></a><span>      </span><span class="hs-comment">-- Note in particular that the label Lret is used as a</span><span>
</span><a name="line-947"></a><span>      </span><span class="hs-comment">-- destination by both the tag-test and the call.  This is</span><span>
</span><a name="line-948"></a><span>      </span><span class="hs-comment">-- because Lret will necessarily be a proc-point, and we want to</span><span>
</span><a name="line-949"></a><span>      </span><span class="hs-comment">-- ensure that we generate only one proc-point for this</span><span>
</span><a name="line-950"></a><span>      </span><span class="hs-comment">-- sequence.</span><span>
</span><a name="line-951"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-952"></a><span>      </span><span class="hs-comment">-- Furthermore, we tell the caller that we generated a native</span><span>
</span><a name="line-953"></a><span>      </span><span class="hs-comment">-- return continuation by returning (ReturnedTo Lret off), so</span><span>
</span><a name="line-954"></a><span>      </span><span class="hs-comment">-- that the continuation can be reused by the heap-check failure</span><span>
</span><a name="line-955"></a><span>      </span><span class="hs-comment">-- code in the enclosing case expression.</span><span>
</span><a name="line-956"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-957"></a><span>      </span><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier hs-var">AssignTo</span></a><span> </span><a name="local-6989586621681525268"><a href="#local-6989586621681525268"><span class="hs-identifier">res_regs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-958"></a><span>       </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525269"><a href="#local-6989586621681525269"><span class="hs-identifier">lret</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-959"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525270"><a href="#local-6989586621681525270"><span class="hs-identifier">off</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681525271"><a href="#local-6989586621681525271"><span class="hs-identifier">copyin</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#copyInOflow"><span class="hs-identifier hs-var">copyInOflow</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621681525269"><span class="hs-identifier hs-var">lret</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525268"><span class="hs-identifier hs-var">res_regs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-960"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525272"><a href="#local-6989586621681525272"><span class="hs-identifier">lcall</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-961"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525273"><a href="#local-6989586621681525273"><span class="hs-identifier">updfr_off</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-962"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525274"><a href="#local-6989586621681525274"><span class="hs-identifier">area</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621681525269"><span class="hs-identifier hs-var">lret</span></a><span>
</span><a name="line-963"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681525275"><a href="#local-6989586621681525275"><span class="hs-identifier">outArgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525276"><a href="#local-6989586621681525276"><span class="hs-identifier">regs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681525277"><a href="#local-6989586621681525277"><span class="hs-identifier">copyout</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#copyOutOflow"><span class="hs-identifier hs-var">copyOutOflow</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span> </span><a href="MkGraph.html#Call"><span class="hs-identifier hs-var">Call</span></a><span> </span><a href="#local-6989586621681525274"><span class="hs-identifier hs-var">area</span></a><span>
</span><a name="line-964"></a><span>                                          </span><span class="hs-special">[</span><a href="#local-6989586621681525263"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621681525273"><span class="hs-identifier hs-var">updfr_off</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-965"></a><span>         </span><span class="hs-comment">-- refer to fun via nodeReg after the copyout, to avoid having</span><span>
</span><a name="line-966"></a><span>         </span><span class="hs-comment">-- both live simultaneously; this sometimes enables fun to be</span><span>
</span><a name="line-967"></a><span>         </span><span class="hs-comment">-- inlined in the RHS of the R1 assignment.</span><span>
</span><a name="line-968"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681525278"><a href="#local-6989586621681525278"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmInfo.html#entryCode"><span class="hs-identifier hs-var">entryCode</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmInfo.html#closureInfoPtr"><span class="hs-identifier hs-var">closureInfoPtr</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#nodeReg"><span class="hs-identifier hs-var">nodeReg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>             </span><a name="local-6989586621681525279"><a href="#local-6989586621681525279"><span class="hs-identifier">the_call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#toCall"><span class="hs-identifier hs-var">toCall</span></a><span> </span><a href="#local-6989586621681525278"><span class="hs-identifier hs-var">entry</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681525269"><span class="hs-identifier hs-var">lret</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681525273"><span class="hs-identifier hs-var">updfr_off</span></a><span> </span><a href="#local-6989586621681525270"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621681525275"><span class="hs-identifier hs-var">outArgs</span></a><span> </span><a href="#local-6989586621681525276"><span class="hs-identifier hs-var">regs</span></a><span>
</span><a name="line-970"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681525280"><a href="#local-6989586621681525280"><span class="hs-identifier">tscope</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-971"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-972"></a><span>           </span><a href="#local-6989586621681525277"><span class="hs-identifier hs-var">copyout</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-973"></a><span>           </span><a href="MkGraph.html#mkCbranch"><span class="hs-identifier hs-var">mkCbranch</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmIsTagged"><span class="hs-identifier hs-var">cmmIsTagged</span></a><span> </span><a href="#local-6989586621681525264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#nodeReg"><span class="hs-identifier hs-var">nodeReg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>                     </span><a href="#local-6989586621681525269"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621681525272"><span class="hs-identifier hs-var">lcall</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-975"></a><span>           </span><a href="MkGraph.html#outOfLine"><span class="hs-identifier hs-var">outOfLine</span></a><span> </span><a href="#local-6989586621681525272"><span class="hs-identifier hs-var">lcall</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681525279"><span class="hs-identifier hs-var">the_call</span></a><span class="hs-special">,</span><a href="#local-6989586621681525280"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-976"></a><span>           </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621681525269"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621681525280"><span class="hs-identifier hs-var">tscope</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span>
</span><a name="line-977"></a><span>           </span><a href="#local-6989586621681525271"><span class="hs-identifier hs-var">copyin</span></a><span>
</span><a name="line-978"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#ReturnedTo"><span class="hs-identifier hs-var">ReturnedTo</span></a><span> </span><a href="#local-6989586621681525269"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621681525270"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-980"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-983"></a><span class="hs-comment">--              Ticks</span><span>
</span><a name="line-984"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-985"></a><span>
</span><a name="line-986"></a><span class="hs-comment">-- | Generate Cmm code for a tick. Depending on the type of Tickish,</span><span>
</span><a name="line-987"></a><span class="hs-comment">-- this will either generate actual Cmm instrumentation code, or</span><span>
</span><a name="line-988"></a><span class="hs-comment">-- simply pass on the annotation as a @CmmTickish@.</span><span>
</span><a name="line-989"></a><span class="hs-identifier">cgTick</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-990"></a><a name="cgTick"><a href="StgCmmExpr.html#cgTick"><span class="hs-identifier">cgTick</span></a></a><span> </span><a name="local-6989586621681525281"><a href="#local-6989586621681525281"><span class="hs-identifier">tick</span></a></a><span>
</span><a name="line-991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681525282"><a href="#local-6989586621681525282"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-992"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681525281"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-993"></a><span>           </span><span class="hs-identifier hs-var">ProfNote</span><span>   </span><a name="local-6989586621681525283"><a href="#local-6989586621681525283"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681525284"><a href="#local-6989586621681525284"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621681525285"><a href="#local-6989586621681525285"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmProf.html#emitSetCCC"><span class="hs-identifier hs-var">emitSetCCC</span></a><span> </span><a href="#local-6989586621681525283"><span class="hs-identifier hs-var">cc</span></a><span> </span><a href="#local-6989586621681525284"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621681525285"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-994"></a><span>           </span><span class="hs-identifier hs-var">HpcTick</span><span>    </span><a name="local-6989586621681525286"><a href="#local-6989586621681525286"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621681525287"><a href="#local-6989586621681525287"><span class="hs-identifier">n</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmHpc.html#mkTickBox"><span class="hs-identifier hs-var">mkTickBox</span></a><span> </span><a href="#local-6989586621681525282"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681525286"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621681525287"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>           </span><span class="hs-identifier hs-var">SourceNote</span><span> </span><a name="local-6989586621681525288"><a href="#local-6989586621681525288"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681525289"><a href="#local-6989586621681525289"><span class="hs-identifier">n</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#emitTick"><span class="hs-identifier hs-var">emitTick</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SourceNote</span><span> </span><a href="#local-6989586621681525288"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681525289"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-996"></a><span>           </span><a name="local-6989586621681525290"><a href="#local-6989586621681525290"><span class="hs-identifier">_other</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ignore</span><span>
</span><a name="line-997"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-998"></a></pre></body></html>