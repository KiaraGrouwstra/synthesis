<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[RnNames]{Extracting imported and top-level names in scope}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP, NondecreasingIndentation, MultiWayIf, NamedFieldPuns #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RnNames</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>        </span><a href="RnNames.html#rnImports"><span class="hs-identifier hs-var">rnImports</span></a><span class="hs-special">,</span><span> </span><a href="RnNames.html#getLocalNonValBinders"><span class="hs-identifier hs-var">getLocalNonValBinders</span></a><span class="hs-special">,</span><span> </span><a href="RnNames.html#newRecordSelector"><span class="hs-identifier hs-var">newRecordSelector</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><span class="hs-identifier hs-var">gresFromAvails</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="RnNames.html#calculateAvails"><span class="hs-identifier hs-var">calculateAvails</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="RnNames.html#reportUnusedNames"><span class="hs-identifier hs-var">reportUnusedNames</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="RnNames.html#checkConName"><span class="hs-identifier hs-var">checkConName</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="RnNames.html#mkChildEnv"><span class="hs-identifier hs-var">mkChildEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="RnNames.html#findChildren"><span class="hs-identifier hs-var">findChildren</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="RnNames.html#dodgyMsg"><span class="hs-identifier hs-var">dodgyMsg</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="RnNames.html#dodgyMsgInsert"><span class="hs-identifier hs-var">dodgyMsgInsert</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="RnNames.html#findImportUsage"><span class="hs-identifier hs-var">findImportUsage</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="RnNames.html#getMinimalImports"><span class="hs-identifier hs-var">getMinimalImports</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="RnNames.html#printMinimalImports"><span class="hs-identifier hs-var">printMinimalImports</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier hs-type">ImportDeclUsage</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="RnFixity.html"><span class="hs-identifier">RnFixity</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#warnUnusedTopBinds"><span class="hs-identifier hs-var">warnUnusedTopBinds</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#mkFieldEnv"><span class="hs-identifier hs-var">mkFieldEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="LoadIface.html#loadSrcInterface"><span class="hs-identifier hs-var">loadSrcInterface</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Avail</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FieldLabel</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrHsSyn</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">setRdrNameSpace</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">StringLiteral</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastStringEnv</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Either</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isRight</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">partition</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">find</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;/&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{rnImports}
*                                                                      *
************************************************************************

Note [Tracking Trust Transitively]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we import a package as well as checking that the direct imports are safe
according to the rules outlined in the Note [HscMain . Safe Haskell Trust Check]
we must also check that these rules hold transitively for all dependent modules
and packages. Doing this without caching any trust information would be very
slow as we would need to touch all packages and interface files a module depends
on. To avoid this we make use of the property that if a modules Safe Haskell
mode changes, this triggers a recompilation from that module in the dependcy
graph. So we can just worry mostly about direct imports.

There is one trust property that can change for a package though without
recompliation being triggered: package trust. So we must check that all
packages a module tranitively depends on to be trusted are still trusted when
we are compiling this module (as due to recompilation avoidance some modules
below may not be considered trusted any more without recompilation being
triggered).

We handle this by augmenting the existing transitive list of packages a module M
depends on with a bool for each package that says if it must be trusted when the
module M is being checked for trust. This list of trust required packages for a
single import is gathered in the rnImportDecl function and stored in an
ImportAvails data structure. The union of these trust required packages for all
imports is done by the rnImports function using the combine function which calls
the plusImportAvails function that is a union operation for the ImportAvails
type. This gives us in an ImportAvails structure all packages required to be
trusted for the module we are currently compiling. Checking that these packages
are still trusted (and that direct imports are trusted) is done in
HscMain.checkSafeImports.

See the note below, [Trust Own Package] for a corner case in this method and
how its handled.


Note [Trust Own Package]
~~~~~~~~~~~~~~~~~~~~~~~~
There is a corner case of package trust checking that the usual transitive check
doesn't cover. (For how the usual check operates see the Note [Tracking Trust
Transitively] below). The case is when you import a -XSafe module M and M
imports a -XTrustworthy module N. If N resides in a different package than M,
then the usual check works as M will record a package dependency on N's package
and mark it as required to be trusted. If N resides in the same package as M
though, then importing M should require its own package be trusted due to N
(since M is -XSafe so doesn't create this requirement by itself). The usual
check fails as a module doesn't record a package dependency of its own package.
So instead we now have a bool field in a modules interface file that simply
states if the module requires its own package to be trusted. This field avoids
us having to load all interface files that the module depends on to see if one
is trustworthy.


Note [Trust Transitive Property]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
So there is an interesting design question in regards to transitive trust
checking. Say I have a module B compiled with -XSafe. B is dependent on a bunch
of modules and packages, some packages it requires to be trusted as its using
-XTrustworthy modules from them. Now if I have a module A that doesn't use safe
haskell at all and simply imports B, should A inherit all the trust
requirements from B? Should A now also require that a package p is trusted since
B required it?

We currently say no but saying yes also makes sense. The difference is, if a
module M that doesn't use Safe Haskell imports a module N that does, should all
the trusted package requirements be dropped since M didn't declare that it cares
about Safe Haskell (so -XSafe is more strongly associated with the module doing
the importing) or should it be done still since the author of the module N that
uses Safe Haskell said they cared (so -XSafe is more strongly associated with
the module that was compiled that used it).

Going with yes is a simpler semantics we think and harder for the user to stuff
up but it does mean that Safe Haskell will affect users who don't care about
Safe Haskell as they might grab a package from Cabal which uses safe haskell (say
network) and that packages imports -XTrustworthy modules from another package
(say bytestring), so requires that package is trusted. The user may now get
compilation errors in code that doesn't do anything with Safe Haskell simply
because they are using the network package. They will have to call 'ghc-pkg
trust network' to get everything working. Due to this invasive nature of going
with yes we have gone with no for now.
-}</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- | Process Import Decls.  See 'rnImportDecl' for a description of what</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- the return types represent.</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- Note: Do the non SOURCE ones first, so that we get a helpful warning</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- for SOURCE ones that are unnecessary</span><span>
</span><a name="line-166"></a><span class="hs-identifier">rnImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-167"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnyHpcUsage</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><a name="rnImports"><a href="RnNames.html#rnImports"><span class="hs-identifier">rnImports</span></a></a><span> </span><a name="local-6989586621682169949"><a href="#local-6989586621682169949"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621682169969"><a href="#local-6989586621682169969"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">-- NB: want an identity module here, because it's OK for a signature</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-comment">-- module to import from its implementor</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682169970"><a href="#local-6989586621682169970"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><a href="#local-6989586621682169969"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682169971"><a href="#local-6989586621682169971"><span class="hs-identifier">source</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169972"><a href="#local-6989586621682169972"><span class="hs-identifier">ordinary</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="#local-6989586621682169973"><span class="hs-identifier hs-var">is_source_import</span></a><span> </span><a href="#local-6989586621682169949"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-174"></a><span>        </span><a name="local-6989586621682169973"><a href="#local-6989586621682169973"><span class="hs-identifier">is_source_import</span></a></a><span> </span><a name="local-6989586621682169974"><a href="#local-6989586621682169974"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ideclSource</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682169974"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>    </span><a name="local-6989586621682169975"><a href="#local-6989586621682169975"><span class="hs-identifier">stuff1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mapAndReportM"><span class="hs-identifier hs-var">mapAndReportM</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#rnImportDecl"><span class="hs-identifier hs-var">rnImportDecl</span></a><span> </span><a href="#local-6989586621682169970"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682169972"><span class="hs-identifier hs-var">ordinary</span></a><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621682169976"><a href="#local-6989586621682169976"><span class="hs-identifier">stuff2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mapAndReportM"><span class="hs-identifier hs-var">mapAndReportM</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#rnImportDecl"><span class="hs-identifier hs-var">rnImportDecl</span></a><span> </span><a href="#local-6989586621682169970"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682169971"><span class="hs-identifier hs-var">source</span></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-comment">-- Safe Haskell: See Note [Tracking Trust Transitively]</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682169977"><a href="#local-6989586621682169977"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169978"><a href="#local-6989586621682169978"><span class="hs-identifier">rdr_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169979"><a href="#local-6989586621682169979"><span class="hs-identifier">imp_avails</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169980"><a href="#local-6989586621682169980"><span class="hs-identifier">hpc_usage</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169950"><span class="hs-identifier hs-var">combine</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169975"><span class="hs-identifier hs-var">stuff1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682169976"><span class="hs-identifier hs-var">stuff2</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169977"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682169978"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682169979"><span class="hs-identifier hs-var">imp_avails</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682169980"><span class="hs-identifier hs-var">hpc_usage</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-comment">-- See Note [Combining ImportAvails]</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">combine</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnyHpcUsage</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-184"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnyHpcUsage</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>    </span><a name="local-6989586621682169950"><a href="#local-6989586621682169950"><span class="hs-identifier">combine</span></a></a><span> </span><a name="local-6989586621682169952"><a href="#local-6989586621682169952"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-186"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682169953"><a href="#local-6989586621682169953"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169954"><a href="#local-6989586621682169954"><span class="hs-identifier">rdr_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169955"><a href="#local-6989586621682169955"><span class="hs-identifier">imp_avails</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169956"><a href="#local-6989586621682169956"><span class="hs-identifier">hpc_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169957"><a href="#local-6989586621682169957"><span class="hs-identifier">finsts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span>
</span><a name="line-187"></a><span>            </span><a href="#local-6989586621682169951"><span class="hs-identifier hs-var">plus</span></a><span>
</span><a name="line-188"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyGlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyImportAvails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyModuleSet</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>            </span><a href="#local-6989586621682169952"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-190"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169953"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682169954"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682169955"><span class="hs-identifier hs-var">imp_avails</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">imp_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleSetElts</span><span> </span><a href="#local-6989586621682169957"><span class="hs-identifier hs-var">finsts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-191"></a><span>            </span><a href="#local-6989586621682169956"><span class="hs-identifier hs-var">hpc_usage</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621682169951"><a href="#local-6989586621682169951"><span class="hs-identifier">plus</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682169958"><a href="#local-6989586621682169958"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682169959"><a href="#local-6989586621682169959"><span class="hs-identifier">gbl_env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169960"><a href="#local-6989586621682169960"><span class="hs-identifier">imp_avails1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169961"><a href="#local-6989586621682169961"><span class="hs-identifier">hpc_usage1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621682169962"><a href="#local-6989586621682169962"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169963"><a href="#local-6989586621682169963"><span class="hs-identifier">gbl_env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169964"><a href="#local-6989586621682169964"><span class="hs-identifier">imp_avails2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169965"><a href="#local-6989586621682169965"><span class="hs-identifier">hpc_usage2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682169966"><a href="#local-6989586621682169966"><span class="hs-identifier">finsts_set</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682169958"><span class="hs-identifier hs-var">decl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682169962"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-196"></a><span>          </span><a href="#local-6989586621682169959"><span class="hs-identifier hs-var">gbl_env1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusGlobalRdrEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682169963"><span class="hs-identifier hs-var">gbl_env2</span></a><span class="hs-special">,</span><span>
</span><a name="line-197"></a><span>          </span><a href="#local-6989586621682169967"><span class="hs-identifier hs-var">imp_avails1'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusImportAvails</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682169964"><span class="hs-identifier hs-var">imp_avails2</span></a><span class="hs-special">,</span><span>
</span><a name="line-198"></a><span>          </span><a href="#local-6989586621682169961"><span class="hs-identifier hs-var">hpc_usage1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682169965"><span class="hs-identifier hs-var">hpc_usage2</span></a><span class="hs-special">,</span><span>
</span><a name="line-199"></a><span>          </span><span class="hs-identifier hs-var">extendModuleSetList</span><span> </span><a href="#local-6989586621682169966"><span class="hs-identifier hs-var">finsts_set</span></a><span> </span><a href="#local-6989586621682169968"><span class="hs-identifier hs-var">new_finsts</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-201"></a><span>      </span><a name="local-6989586621682169967"><a href="#local-6989586621682169967"><span class="hs-identifier">imp_avails1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169960"><span class="hs-identifier hs-var">imp_avails1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">imp_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-202"></a><span>      </span><a name="local-6989586621682169968"><a href="#local-6989586621682169968"><span class="hs-identifier">new_finsts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_finsts</span><span> </span><a href="#local-6989586621682169960"><span class="hs-identifier hs-var">imp_avails1</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">{-
Note [Combining ImportAvails]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
imp_finsts in ImportAvails is a list of family instance modules
transitively depended on by an import. imp_finsts for a currently
compiled module is a union of all the imp_finsts of imports.
Computing the union of two lists of size N is O(N^2) and if we
do it to M imports we end up with O(M*N^2). That can get very
expensive for bigger module hierarchies.

Union can be optimized to O(N log N) if we use a Set.
imp_finsts is converted back and forth between dep_finsts, so
changing a type of imp_finsts means either paying for the conversions
or changing the type of dep_finsts as well.

I've measured that the conversions would cost 20% of allocations on my
test case, so that can be ruled out.

Changing the type of dep_finsts forces checkFamInsts to
get the module lists in non-deterministic order. If we wanted to restore
the deterministic order, we'd have to sort there, which is an additional
cost. As far as I can tell, using a non-deterministic order is fine there,
but that's a brittle nonlocal property which I'd like to avoid.

Additionally, dep_finsts is read from an interface file, so its &quot;natural&quot;
type is a list. Which makes it a natural type for imp_finsts.

Since rnImports.combine is really the only place that would benefit from
it being a Set, it makes sense to optimize the hot loop in rnImports.combine
without changing the representation.

So here's what we do: instead of naively merging ImportAvails with
plusImportAvails in a loop, we make plusImportAvails merge empty imp_finsts
and compute the union on the side using Sets. When we're done, we can
convert it back to a list. One nice side effect of this approach is that
if there's a lot of overlap in the imp_finsts of imports, the
Set doesn't really need to grow and we don't need to allocate.

Running generateModules from Trac #14693 with DEPTH=16, WIDTH=30 finishes in
23s before, and 11s after.
-}</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-comment">-- | Given a located import declaration @decl@ from @this_mod@,</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- calculate the following pieces of information:</span><span>
</span><a name="line-250"></a><span class="hs-comment">--</span><span>
</span><a name="line-251"></a><span class="hs-comment">--  1. An updated 'LImportDecl', where all unresolved 'RdrName' in</span><span>
</span><a name="line-252"></a><span class="hs-comment">--     the entity lists have been resolved into 'Name's,</span><span>
</span><a name="line-253"></a><span class="hs-comment">--</span><span>
</span><a name="line-254"></a><span class="hs-comment">--  2. A 'GlobalRdrEnv' representing the new identifiers that were</span><span>
</span><a name="line-255"></a><span class="hs-comment">--     brought into scope (taking into account module qualification</span><span>
</span><a name="line-256"></a><span class="hs-comment">--     and hiding),</span><span>
</span><a name="line-257"></a><span class="hs-comment">--</span><span>
</span><a name="line-258"></a><span class="hs-comment">--  3. 'ImportAvails' summarizing the identifiers that were imported</span><span>
</span><a name="line-259"></a><span class="hs-comment">--     by this declaration, and</span><span>
</span><a name="line-260"></a><span class="hs-comment">--</span><span>
</span><a name="line-261"></a><span class="hs-comment">--  4. A boolean 'AnyHpcUsage' which is true if the imported module</span><span>
</span><a name="line-262"></a><span class="hs-comment">--     used HPC.</span><span>
</span><a name="line-263"></a><span class="hs-identifier">rnImportDecl</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-264"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AnyHpcUsage</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="rnImportDecl"><a href="RnNames.html#rnImportDecl"><span class="hs-identifier">rnImportDecl</span></a></a><span> </span><a name="local-6989586621682169981"><a href="#local-6989586621682169981"><span class="hs-identifier">this_mod</span></a></a><span>
</span><a name="line-266"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682169982"><a href="#local-6989586621682169982"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682169983"><a href="#local-6989586621682169983"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ideclExt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169984"><a href="#local-6989586621682169984"><span class="hs-identifier">noExt</span></a></a><span>
</span><a name="line-267"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169985"><a href="#local-6989586621682169985"><span class="hs-identifier">loc_imp_mod_name</span></a></a><span>
</span><a name="line-268"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclPkgQual</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169986"><a href="#local-6989586621682169986"><span class="hs-identifier">mb_pkg</span></a></a><span>
</span><a name="line-269"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclSource</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169987"><a href="#local-6989586621682169987"><span class="hs-identifier">want_boot</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclSafe</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169988"><a href="#local-6989586621682169988"><span class="hs-identifier">mod_safe</span></a></a><span>
</span><a name="line-270"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclQualified</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169989"><a href="#local-6989586621682169989"><span class="hs-identifier">qual_only</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclImplicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169990"><a href="#local-6989586621682169990"><span class="hs-identifier">implicit</span></a></a><span>
</span><a name="line-271"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclAs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169991"><a href="#local-6989586621682169991"><span class="hs-identifier">as_mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682169992"><a href="#local-6989586621682169992"><span class="hs-identifier">imp_details</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682169982"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621682169986"><span class="hs-identifier hs-var">mb_pkg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-275"></a><span>        </span><a name="local-6989586621682169993"><a href="#local-6989586621682169993"><span class="hs-identifier">pkg_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.PackageImports</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682169993"><span class="hs-identifier hs-var">pkg_imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="RnNames.html#packageImportErr"><span class="hs-identifier hs-var">packageImportErr</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>    </span><span class="hs-comment">-- If there's an error in loadInterface, (e.g. interface</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-comment">-- file not found) we get lots of spurious errors from 'filterImports'</span><span>
</span><a name="line-280"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682169994"><a href="#local-6989586621682169994"><span class="hs-identifier">imp_mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682169985"><span class="hs-identifier hs-var">loc_imp_mod_name</span></a><span>
</span><a name="line-281"></a><span>        </span><a name="local-6989586621682169995"><a href="#local-6989586621682169995"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is directly imported&quot;</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span>    </span><span class="hs-comment">-- Check for self-import, which confuses the typechecker (Trac #9032)</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-comment">-- ghc --make rejects self-import cycles already, but batch-mode may not</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">-- at least not until TcIface.tcHiBootIface, which is too late to avoid</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-comment">-- typechecker crashes.  (Indirect self imports are not caught until</span><span>
</span><a name="line-287"></a><span>    </span><span class="hs-comment">-- TcIface, see #10337 tracking how to make this error better.)</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-comment">-- Originally, we also allowed 'import {-# SOURCE #-} M', but this</span><span>
</span><a name="line-290"></a><span>    </span><span class="hs-comment">-- caused bug #10182: in one-shot mode, we should never load an hs-boot</span><span>
</span><a name="line-291"></a><span>    </span><span class="hs-comment">-- file for the module we are compiling into the EPS.  In principle,</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-comment">-- it should be possible to support this mode of use, but we would have to</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-comment">-- extend Provenance to support a local definition in a qualified location.</span><span>
</span><a name="line-294"></a><span>    </span><span class="hs-comment">-- For now, we don't support it, but see #10336</span><span>
</span><a name="line-295"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682169981"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-296"></a><span>          </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682169986"><span class="hs-identifier hs-var">mb_pkg</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- If we have import &quot;&lt;pkg&gt;&quot; M, then we should</span><span>
</span><a name="line-297"></a><span>                           </span><span class="hs-comment">-- check that &quot;&lt;pkg&gt;&quot; is &quot;this&quot; (which is magic)</span><span>
</span><a name="line-298"></a><span>                           </span><span class="hs-comment">-- or the name of this_mod's package.  Yurgh!</span><span>
</span><a name="line-299"></a><span>                           </span><span class="hs-comment">-- c.f. GHC.findModule, and Trac #9997</span><span>
</span><a name="line-300"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-301"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StringLiteral</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682169996"><a href="#local-6989586621682169996"><span class="hs-identifier">pkg_fs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682169996"><span class="hs-identifier hs-var">pkg_fs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;this&quot;</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-302"></a><span>                            </span><span class="hs-identifier hs-var">fsToUnitId</span><span> </span><a href="#local-6989586621682169996"><span class="hs-identifier hs-var">pkg_fs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621682169981"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>         </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A module cannot import itself:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span>    </span><span class="hs-comment">-- Check for a missing import list (Opt_WarnMissingImportList also</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-comment">-- checks for T(..) items but that is done in checkDodgyImport below)</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682169992"><span class="hs-identifier hs-var">imp_details</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-308"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Explicit import list</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682169990"><span class="hs-identifier hs-var">implicit</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Do not bleat for implicit imports</span><span>
</span><a name="line-310"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682169989"><span class="hs-identifier hs-var">qual_only</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingImportList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-312"></a><span>                           </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingImportList</span><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>                                   </span><span class="hs-special">(</span><a href="RnNames.html#missingImportListWarn"><span class="hs-identifier hs-var">missingImportListWarn</span></a><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span>    </span><a name="local-6989586621682169997"><a href="#local-6989586621682169997"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadSrcInterface"><span class="hs-identifier hs-var">loadSrcInterface</span></a><span> </span><a href="#local-6989586621682169995"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span> </span><a href="#local-6989586621682169987"><span class="hs-identifier hs-var">want_boot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><a href="#local-6989586621682169986"><span class="hs-identifier hs-var">mb_pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-comment">-- Compiler sanity check: if the import didn't say</span><span>
</span><a name="line-318"></a><span>    </span><span class="hs-comment">-- {-# SOURCE #-} we should not get a hi-boot file</span><span>
</span><a name="line-319"></a><span>    </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-identifier">want_boot</span><span> </span><a href="#local-6989586621682169987"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><span class="hs-identifier">mi_boot</span><span> </span><span class="hs-identifier">iface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">imp_mod_name</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>    </span><span class="hs-comment">-- Issue a user warning for a redundant {- SOURCE -} import</span><span>
</span><a name="line-322"></a><span>    </span><span class="hs-comment">-- NB that we arrange to read all the ordinary imports before</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-comment">-- any of the {- SOURCE -} imports.</span><span>
</span><a name="line-324"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-comment">-- in --make and GHCi, the compilation manager checks for this,</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-comment">-- and indeed we shouldn't do it here because the existence of</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-comment">-- the non-boot module depends on the compilation order, which</span><span>
</span><a name="line-328"></a><span>    </span><span class="hs-comment">-- is not deterministic.  The hs-boot test can show this up.</span><span>
</span><a name="line-329"></a><span>    </span><a name="local-6989586621682169998"><a href="#local-6989586621682169998"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-330"></a><span>    </span><a href="TcRnMonad.html#warnIf"><span class="hs-identifier hs-var">warnIf</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169987"><span class="hs-identifier hs-var">want_boot</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621682169997"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isOneShot</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcMode</span><span> </span><a href="#local-6989586621682169998"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>           </span><span class="hs-special">(</span><a href="RnNames.html#warnRedundantSourceImport"><span class="hs-identifier hs-var">warnRedundantSourceImport</span></a><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169988"><span class="hs-identifier hs-var">mod_safe</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">safeImportsOn</span><span> </span><a href="#local-6989586621682169998"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-333"></a><span>        </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;safe import can't be used as Safe Haskell isn't on!&quot;</span><span>
</span><a name="line-334"></a><span>                </span><span class="hs-operator hs-var">$+$</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;please enable Safe Haskell through either &quot;</span><span>
</span><a name="line-335"></a><span>                                   </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;Safe, Trustworthy or Unsafe&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-338"></a><span>        </span><a name="local-6989586621682169999"><a href="#local-6989586621682169999"><span class="hs-identifier">qual_mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682169991"><span class="hs-identifier hs-var">as_mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span>
</span><a name="line-339"></a><span>        </span><a name="local-6989586621682170000"><a href="#local-6989586621682170000"><span class="hs-identifier">imp_spec</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpDeclSpec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_qual</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169989"><span class="hs-identifier hs-var">qual_only</span></a><span class="hs-special">,</span><span>
</span><a name="line-340"></a><span>                                  </span><span class="hs-identifier">is_dloc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169982"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169999"><span class="hs-identifier hs-var">qual_mod_name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span>    </span><span class="hs-comment">-- filter the imports according to the import declaration</span><span>
</span><a name="line-343"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682170001"><a href="#local-6989586621682170001"><span class="hs-identifier">new_imp_details</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170002"><a href="#local-6989586621682170002"><span class="hs-identifier">gres</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#filterImports"><span class="hs-identifier hs-var">filterImports</span></a><span> </span><a href="#local-6989586621682169997"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682170000"><span class="hs-identifier hs-var">imp_spec</span></a><span> </span><a href="#local-6989586621682169992"><span class="hs-identifier hs-var">imp_details</span></a><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>    </span><span class="hs-comment">-- for certain error messages, we&#8217;d like to know what could be imported</span><span>
</span><a name="line-346"></a><span>    </span><span class="hs-comment">-- here, if everything were imported</span><span>
</span><a name="line-347"></a><span>    </span><a name="local-6989586621682170003"><a href="#local-6989586621682170003"><span class="hs-identifier">potential_gres</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkGlobalRdrEnv</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="RnNames.html#filterImports"><span class="hs-identifier hs-var">filterImports</span></a><span> </span><a href="#local-6989586621682169997"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682170000"><span class="hs-identifier hs-var">imp_spec</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170004"><a href="#local-6989586621682170004"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkGlobalRdrEnv</span><span> </span><a href="#local-6989586621682170002"><span class="hs-identifier hs-var">gres</span></a><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>        </span><a name="local-6989586621682170005"><a href="#local-6989586621682170005"><span class="hs-identifier">is_hiding</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682169992"><span class="hs-identifier hs-var">imp_details</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-352"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>        </span><span class="hs-comment">-- should the import be safe?</span><span>
</span><a name="line-355"></a><span>        </span><a name="local-6989586621682170006"><a href="#local-6989586621682170006"><span class="hs-identifier">mod_safe'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169988"><span class="hs-identifier hs-var">mod_safe</span></a><span>
</span><a name="line-356"></a><span>                    </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682169990"><span class="hs-identifier hs-var">implicit</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">safeDirectImpsReq</span><span> </span><a href="#local-6989586621682169998"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>                    </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169990"><span class="hs-identifier hs-var">implicit</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">safeImplicitImpsReq</span><span> </span><a href="#local-6989586621682169998"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170007"><a href="#local-6989586621682170007"><span class="hs-identifier">imv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImportedModsVal</span><span>
</span><a name="line-360"></a><span>            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">imv_name</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169999"><span class="hs-identifier hs-var">qual_mod_name</span></a><span>
</span><a name="line-361"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_span</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169982"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-362"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_is_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170006"><span class="hs-identifier hs-var">mod_safe'</span></a><span>
</span><a name="line-363"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_is_hiding</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170005"><span class="hs-identifier hs-var">is_hiding</span></a><span>
</span><a name="line-364"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_all_exports</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170003"><span class="hs-identifier hs-var">potential_gres</span></a><span>
</span><a name="line-365"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_qualified</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169989"><span class="hs-identifier hs-var">qual_only</span></a><span>
</span><a name="line-366"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-367"></a><span>        </span><a name="local-6989586621682170008"><a href="#local-6989586621682170008"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#calculateAvails"><span class="hs-identifier hs-var">calculateAvails</span></a><span> </span><a href="#local-6989586621682169998"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682169997"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682170006"><span class="hs-identifier hs-var">mod_safe'</span></a><span> </span><a href="#local-6989586621682169987"><span class="hs-identifier hs-var">want_boot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportedByUser</span><span> </span><a href="#local-6989586621682170007"><span class="hs-identifier hs-var">imv</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>    </span><span class="hs-comment">-- Complain if we import a deprecated module</span><span>
</span><a name="line-370"></a><span>    </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnWarningsDeprecations</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-371"></a><span>       </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_warns</span><span> </span><a href="#local-6989586621682169997"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-372"></a><span>          </span><span class="hs-identifier hs-var">WarnAll</span><span> </span><a name="local-6989586621682170009"><a href="#local-6989586621682170009"><span class="hs-identifier">txt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnWarningsDeprecations</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>                                </span><span class="hs-special">(</span><a href="RnNames.html#moduleWarn"><span class="hs-identifier hs-var">moduleWarn</span></a><span> </span><a href="#local-6989586621682169994"><span class="hs-identifier hs-var">imp_mod_name</span></a><span> </span><a href="#local-6989586621682170009"><span class="hs-identifier hs-var">txt</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>          </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170010"><a href="#local-6989586621682170010"><span class="hs-identifier">new_imp_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682169982"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682169983"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ideclExt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682169984"><span class="hs-identifier hs-var">noExt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclSafe</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170006"><span class="hs-identifier hs-var">mod_safe'</span></a><span>
</span><a name="line-378"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170001"><span class="hs-identifier hs-var">new_imp_details</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170010"><span class="hs-identifier hs-var">new_imp_decl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170004"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170008"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mi_hpc</span><span> </span><a href="#local-6989586621682169997"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span class="hs-identifier">rnImportDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XImportDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnImportDecl&quot;</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- | Calculate the 'ImportAvails' induced by an import of a particular</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- interface, but without 'imp_mods'.</span><span>
</span><a name="line-385"></a><span class="hs-identifier">calculateAvails</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-386"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-387"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsSafeImport</span><span>
</span><a name="line-388"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span>
</span><a name="line-389"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImportedBy</span><span>
</span><a name="line-390"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span>
</span><a name="line-391"></a><a name="calculateAvails"><a href="RnNames.html#calculateAvails"><span class="hs-identifier">calculateAvails</span></a></a><span> </span><a name="local-6989586621682170011"><a href="#local-6989586621682170011"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682170012"><a href="#local-6989586621682170012"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621682170013"><a href="#local-6989586621682170013"><span class="hs-identifier">mod_safe'</span></a></a><span> </span><a name="local-6989586621682170014"><a href="#local-6989586621682170014"><span class="hs-identifier">want_boot</span></a></a><span> </span><a name="local-6989586621682170015"><a href="#local-6989586621682170015"><span class="hs-identifier">imported_by</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-392"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170016"><a href="#local-6989586621682170016"><span class="hs-identifier">imp_mod</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-393"></a><span>      </span><a name="local-6989586621682170017"><a href="#local-6989586621682170017"><span class="hs-identifier">imp_sem_mod</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mi_semantic_module</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-394"></a><span>      </span><a name="local-6989586621682170018"><a href="#local-6989586621682170018"><span class="hs-identifier">orph_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_orphan</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-395"></a><span>      </span><a name="local-6989586621682170019"><a href="#local-6989586621682170019"><span class="hs-identifier">has_finsts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_finsts</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-396"></a><span>      </span><a name="local-6989586621682170020"><a href="#local-6989586621682170020"><span class="hs-identifier">deps</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-397"></a><span>      </span><a name="local-6989586621682170021"><a href="#local-6989586621682170021"><span class="hs-identifier">trust</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSafeMode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mi_trust</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-398"></a><span>      </span><a name="local-6989586621682170022"><a href="#local-6989586621682170022"><span class="hs-identifier">trust_pkg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_trust_pkg</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span>      </span><span class="hs-comment">-- If the module exports anything defined in this module, just</span><span>
</span><a name="line-401"></a><span>      </span><span class="hs-comment">-- ignore it.  Reason: otherwise it looks as if there are two</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-comment">-- local definition sites for the thing, and an error gets</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-comment">-- reported.  Easiest thing is just to filter them out up</span><span>
</span><a name="line-404"></a><span>      </span><span class="hs-comment">-- front. This situation only arises if a module imports</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-comment">-- itself, or another module that imported it.  (Necessarily,</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-comment">-- this invoves a loop.)</span><span>
</span><a name="line-407"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-408"></a><span>      </span><span class="hs-comment">-- We do this *after* filterImports, so that if you say</span><span>
</span><a name="line-409"></a><span>      </span><span class="hs-comment">--      module A where</span><span>
</span><a name="line-410"></a><span>      </span><span class="hs-comment">--         import B( AType )</span><span>
</span><a name="line-411"></a><span>      </span><span class="hs-comment">--         type AType = ...</span><span>
</span><a name="line-412"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-413"></a><span>      </span><span class="hs-comment">--      module B( AType ) where</span><span>
</span><a name="line-414"></a><span>      </span><span class="hs-comment">--         import {-# SOURCE #-} A( AType )</span><span>
</span><a name="line-415"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-416"></a><span>      </span><span class="hs-comment">-- then you won't get a 'B does not export AType' message.</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span>      </span><span class="hs-comment">-- Compute new transitive dependencies</span><span>
</span><a name="line-420"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-421"></a><span>      </span><span class="hs-comment">-- 'dep_orphs' and 'dep_finsts' do NOT include the imported module</span><span>
</span><a name="line-422"></a><span>      </span><span class="hs-comment">-- itself, but we DO need to include this module in 'imp_orphs' and</span><span>
</span><a name="line-423"></a><span>      </span><span class="hs-comment">-- 'imp_finsts' if it defines an orphan or instance family; thus the</span><span>
</span><a name="line-424"></a><span>      </span><span class="hs-comment">-- orph_iface/has_iface tests.</span><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span>      </span><a name="local-6989586621682170023"><a href="#local-6989586621682170023"><span class="hs-identifier">orphans</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170018"><span class="hs-identifier hs-var">orph_iface</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_sem_mod</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621682170017"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><span class="hs-identifier">deps</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">imp_sem_mod</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_orphs</span><span> </span><span class="hs-identifier">deps</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>                             </span><a href="#local-6989586621682170017"><span class="hs-identifier hs-var">imp_sem_mod</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-428"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span>      </span><a name="local-6989586621682170024"><a href="#local-6989586621682170024"><span class="hs-identifier">finsts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170019"><span class="hs-identifier hs-var">has_finsts</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_sem_mod</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621682170017"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-identifier">deps</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">imp_sem_mod</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_orphs</span><span> </span><span class="hs-identifier">deps</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>                            </span><a href="#local-6989586621682170017"><span class="hs-identifier hs-var">imp_sem_mod</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dep_finsts</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-432"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_finsts</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span>      </span><a name="local-6989586621682170025"><a href="#local-6989586621682170025"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>      </span><a name="local-6989586621682170026"><a href="#local-6989586621682170026"><span class="hs-identifier">ipkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><a href="#local-6989586621682170025"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>      </span><span class="hs-comment">-- Does this import mean we now require our own pkg</span><span>
</span><a name="line-438"></a><span>      </span><span class="hs-comment">-- to be trusted? See Note [Trust Own Package]</span><span>
</span><a name="line-439"></a><span>      </span><a name="local-6989586621682170027"><a href="#local-6989586621682170027"><span class="hs-identifier">ptrust</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170021"><span class="hs-identifier hs-var">trust</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Sf_Trustworthy</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682170022"><span class="hs-identifier hs-var">trust_pkg</span></a><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682170028"><a href="#local-6989586621682170028"><span class="hs-identifier">dependent_mods</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170029"><a href="#local-6989586621682170029"><span class="hs-identifier">dependent_pkgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170030"><a href="#local-6989586621682170030"><span class="hs-identifier">pkg_trust_req</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170025"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682170011"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-443"></a><span>            </span><span class="hs-comment">-- Imported module is from the home package</span><span>
</span><a name="line-444"></a><span>            </span><span class="hs-comment">-- Take its dependent modules and add imp_mod itself</span><span>
</span><a name="line-445"></a><span>            </span><span class="hs-comment">-- Take its dependent packages unchanged</span><span>
</span><a name="line-446"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-447"></a><span>            </span><span class="hs-comment">-- NB: (dep_mods deps) might include a hi-boot file</span><span>
</span><a name="line-448"></a><span>            </span><span class="hs-comment">-- for the module being compiled, CM. Do *not* filter</span><span>
</span><a name="line-449"></a><span>            </span><span class="hs-comment">-- this out (as we used to), because when we've</span><span>
</span><a name="line-450"></a><span>            </span><span class="hs-comment">-- finished dealing with the direct imports we want to</span><span>
</span><a name="line-451"></a><span>            </span><span class="hs-comment">-- know if any of them depended on CM.hi-boot, in</span><span>
</span><a name="line-452"></a><span>            </span><span class="hs-comment">-- which case we should do the hi-boot consistency</span><span>
</span><a name="line-453"></a><span>            </span><span class="hs-comment">-- check.  See LoadIface.loadHiBootInterface</span><span>
</span><a name="line-454"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682170016"><span class="hs-identifier hs-var">imp_mod</span></a><span class="hs-special">,</span><a href="#local-6989586621682170014"><span class="hs-identifier hs-var">want_boot</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-identifier">dep_mods</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">,</span><span class="hs-identifier">dep_pkgs</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">,</span><a href="#local-6989586621682170027"><span class="hs-identifier hs-var">ptrust</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-457"></a><span>            </span><span class="hs-comment">-- Imported module is from another package</span><span>
</span><a name="line-458"></a><span>            </span><span class="hs-comment">-- Dump the dependent modules</span><span>
</span><a name="line-459"></a><span>            </span><span class="hs-comment">-- Add the package imp_mod comes from to the dependent packages</span><span>
</span><a name="line-460"></a><span>            </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ipkg</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170026"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-identifier">deps</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ipkg</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-identifier">deps</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170026"><span class="hs-identifier hs-var">ipkg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><a href="#local-6989586621682170020"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">ImportAvails</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-465"></a><span>          </span><span class="hs-identifier">imp_mods</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682170012"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170015"><span class="hs-identifier hs-var">imported_by</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-466"></a><span>          </span><span class="hs-identifier">imp_orphs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170023"><span class="hs-identifier hs-var">orphans</span></a><span class="hs-special">,</span><span>
</span><a name="line-467"></a><span>          </span><span class="hs-identifier">imp_finsts</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170024"><span class="hs-identifier hs-var">finsts</span></a><span class="hs-special">,</span><span>
</span><a name="line-468"></a><span>          </span><span class="hs-identifier">imp_dep_mods</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModDeps</span><span> </span><a href="#local-6989586621682170028"><span class="hs-identifier hs-var">dependent_mods</span></a><span class="hs-special">,</span><span>
</span><a name="line-469"></a><span>          </span><span class="hs-identifier">imp_dep_pkgs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682170029"><span class="hs-identifier hs-var">dependent_pkgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-470"></a><span>          </span><span class="hs-comment">-- Add in the imported modules trusted package</span><span>
</span><a name="line-471"></a><span>          </span><span class="hs-comment">-- requirements. ONLY do this though if we import the</span><span>
</span><a name="line-472"></a><span>          </span><span class="hs-comment">-- module as a safe import.</span><span>
</span><a name="line-473"></a><span>          </span><span class="hs-comment">-- See Note [Tracking Trust Transitively]</span><span>
</span><a name="line-474"></a><span>          </span><span class="hs-comment">-- and Note [Trust Transitive Property]</span><span>
</span><a name="line-475"></a><span>          </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682170013"><span class="hs-identifier hs-var">mod_safe'</span></a><span>
</span><a name="line-476"></a><span>                               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621682170029"><span class="hs-identifier hs-var">dependent_pkgs</span></a><span>
</span><a name="line-477"></a><span>                               </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span class="hs-special">,</span><span>
</span><a name="line-478"></a><span>          </span><span class="hs-comment">-- Do we require our own pkg to be trusted?</span><span>
</span><a name="line-479"></a><span>          </span><span class="hs-comment">-- See Note [Trust Own Package]</span><span>
</span><a name="line-480"></a><span>          </span><span class="hs-identifier">imp_trust_own_pkg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170030"><span class="hs-identifier hs-var">pkg_trust_req</span></a><span>
</span><a name="line-481"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-identifier">warnRedundantSourceImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-485"></a><a name="warnRedundantSourceImport"><a href="RnNames.html#warnRedundantSourceImport"><span class="hs-identifier">warnRedundantSourceImport</span></a></a><span> </span><a name="local-6989586621682170031"><a href="#local-6989586621682170031"><span class="hs-identifier">mod_name</span></a></a><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unnecessary {-# SOURCE #-} in the import of module&quot;</span><span>
</span><a name="line-487"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170031"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{importsFromLocalDecls}
*                                                                      *
************************************************************************

From the top-level declarations of this module produce
        * the lexical environment
        * the ImportAvails
created by its bindings.

Note [Top-level Names in Template Haskell decl quotes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also: Note [Interactively-bound Ids in GHCi] in HscTypes
          Note [Looking up Exact RdrNames] in RnEnv

Consider a Template Haskell declaration quotation like this:
      module M where
        f x = h [d| f = 3 |]
When renaming the declarations inside [d| ...|], we treat the
top level binders specially in two ways

1.  We give them an Internal Name, not (as usual) an External one.
    This is done by RnEnv.newTopSrcBinder.

2.  We make them *shadow* the outer bindings.
    See Note [GlobalRdrEnv shadowing]

3. We find out whether we are inside a [d| ... |] by testing the TH
   stage. This is a slight hack, because the stage field was really
   meant for the type checker, and here we are not interested in the
   fields of Brack, hence the error thunks in thRnBrack.
-}</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-identifier">extendGlobalRdrEnvRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">]</span><span>
</span><a name="line-525"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span>
</span><a name="line-526"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- Updates both the GlobalRdrEnv and the FixityEnv</span><span>
</span><a name="line-528"></a><span class="hs-comment">-- We return a new TcLclEnv only because we might have to</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- delete some bindings from it;</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- see Note [Top-level Names in Template Haskell decl quotes]</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><a name="extendGlobalRdrEnvRn"><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier">extendGlobalRdrEnvRn</span></a></a><span> </span><a name="local-6989586621682170032"><a href="#local-6989586621682170032"><span class="hs-identifier">avails</span></a></a><span> </span><a name="local-6989586621682170033"><a href="#local-6989586621682170033"><span class="hs-identifier">new_fixities</span></a></a><span>
</span><a name="line-533"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170049"><a href="#local-6989586621682170049"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170050"><a href="#local-6989586621682170050"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span>
</span><a name="line-534"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170051"><a href="#local-6989586621682170051"><span class="hs-identifier">stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-535"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170052"><a href="#local-6989586621682170052"><span class="hs-identifier">isGHCi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getIsGHCi"><span class="hs-identifier hs-var">getIsGHCi</span></a><span>
</span><a name="line-536"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170053"><a href="#local-6989586621682170053"><span class="hs-identifier">rdr_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621682170049"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-537"></a><span>              </span><a name="local-6989586621682170054"><a href="#local-6989586621682170054"><span class="hs-identifier">fix_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_fix_env</span><span> </span><a href="#local-6989586621682170049"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-538"></a><span>              </span><a name="local-6989586621682170055"><a href="#local-6989586621682170055"><span class="hs-identifier">th_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_th_bndrs</span><span> </span><a href="#local-6989586621682170050"><span class="hs-identifier hs-var">lcl_env</span></a><span>
</span><a name="line-539"></a><span>              </span><a name="local-6989586621682170056"><a href="#local-6989586621682170056"><span class="hs-identifier">th_lvl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thLevel</span><span> </span><a href="#local-6989586621682170051"><span class="hs-identifier hs-var">stage</span></a><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span>              </span><span class="hs-comment">-- Delete new_occs from global and local envs</span><span>
</span><a name="line-542"></a><span>              </span><span class="hs-comment">-- If we are in a TemplateHaskell decl bracket,</span><span>
</span><a name="line-543"></a><span>              </span><span class="hs-comment">--    we are going to shadow them</span><span>
</span><a name="line-544"></a><span>              </span><span class="hs-comment">-- See Note [GlobalRdrEnv shadowing]</span><span>
</span><a name="line-545"></a><span>              </span><a name="local-6989586621682170057"><a href="#local-6989586621682170057"><span class="hs-identifier">inBracket</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#isBrackStage"><span class="hs-identifier hs-var">isBrackStage</span></a><span> </span><a href="#local-6989586621682170051"><span class="hs-identifier hs-var">stage</span></a><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span>              </span><a name="local-6989586621682170058"><a href="#local-6989586621682170058"><span class="hs-identifier">lcl_env_TH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170050"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_rdr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delLocalRdrEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_rdr</span><span> </span><a href="#local-6989586621682170050"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170035"><span class="hs-identifier hs-var">new_occs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-548"></a><span>                           </span><span class="hs-comment">-- See Note [GlobalRdrEnv shadowing]</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>              </span><a name="local-6989586621682170059"><a href="#local-6989586621682170059"><span class="hs-identifier">lcl_env2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170057"><span class="hs-identifier hs-var">inBracket</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170058"><span class="hs-identifier hs-var">lcl_env_TH</span></a><span>
</span><a name="line-551"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170050"><span class="hs-identifier hs-var">lcl_env</span></a><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span>              </span><span class="hs-comment">-- Deal with shadowing: see Note [GlobalRdrEnv shadowing]</span><span>
</span><a name="line-554"></a><span>              </span><a name="local-6989586621682170060"><a href="#local-6989586621682170060"><span class="hs-identifier">want_shadowing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170052"><span class="hs-identifier hs-var">isGHCi</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682170057"><span class="hs-identifier hs-var">inBracket</span></a><span>
</span><a name="line-555"></a><span>              </span><a name="local-6989586621682170061"><a href="#local-6989586621682170061"><span class="hs-identifier">rdr_env1</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170060"><span class="hs-identifier hs-var">want_shadowing</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">shadowNames</span><span> </span><a href="#local-6989586621682170053"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682170034"><span class="hs-identifier hs-var">new_names</span></a><span>
</span><a name="line-556"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170053"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span>              </span><a name="local-6989586621682170062"><a href="#local-6989586621682170062"><span class="hs-identifier">lcl_env3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170059"><span class="hs-identifier hs-var">lcl_env2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_th_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><a href="#local-6989586621682170055"><span class="hs-identifier hs-var">th_bndrs</span></a><span>
</span><a name="line-559"></a><span>                                                       </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170063"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TopLevel</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170056"><span class="hs-identifier hs-var">th_lvl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>                                                       </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682170063"><a href="#local-6989586621682170063"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170034"><span class="hs-identifier hs-var">new_names</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170064"><a href="#local-6989586621682170064"><span class="hs-identifier">rdr_env2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="#local-6989586621682170038"><span class="hs-identifier hs-var">add_gre</span></a><span> </span><a href="#local-6989586621682170061"><span class="hs-identifier hs-var">rdr_env1</span></a><span> </span><a href="#local-6989586621682170037"><span class="hs-identifier hs-var">new_gres</span></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170065"><a href="#local-6989586621682170065"><span class="hs-identifier">fix_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621682170036"><span class="hs-identifier hs-var">extend_fix_env</span></a><span> </span><a href="#local-6989586621682170054"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682170037"><span class="hs-identifier hs-var">new_gres</span></a><span>
</span><a name="line-565"></a><span>              </span><a name="local-6989586621682170066"><a href="#local-6989586621682170066"><span class="hs-identifier">gbl_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170049"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170064"><span class="hs-identifier hs-var">rdr_env2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fix_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170065"><span class="hs-identifier hs-var">fix_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;extendGlobalRdrEnvRn 2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprGlobalRdrEnv</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682170064"><span class="hs-identifier hs-var">rdr_env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170066"><span class="hs-identifier hs-var">gbl_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170062"><span class="hs-identifier hs-var">lcl_env3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-569"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-570"></a><span>    </span><a name="local-6989586621682170034"><a href="#local-6989586621682170034"><span class="hs-identifier">new_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">availNames</span><span> </span><a href="#local-6989586621682170032"><span class="hs-identifier hs-var">avails</span></a><span>
</span><a name="line-571"></a><span>    </span><a name="local-6989586621682170035"><a href="#local-6989586621682170035"><span class="hs-identifier">new_occs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682170034"><span class="hs-identifier hs-var">new_names</span></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>    </span><span class="hs-comment">-- If there is a fixity decl for the gre, add it to the fixity env</span><span>
</span><a name="line-574"></a><span>    </span><a name="local-6989586621682170036"><a href="#local-6989586621682170036"><span class="hs-identifier">extend_fix_env</span></a></a><span> </span><a name="local-6989586621682170039"><a href="#local-6989586621682170039"><span class="hs-identifier">fix_env</span></a></a><span> </span><a name="local-6989586621682170040"><a href="#local-6989586621682170040"><span class="hs-identifier">gre</span></a></a><span>
</span><a name="line-575"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170043"><a href="#local-6989586621682170043"><span class="hs-identifier">fi</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupFsEnv</span><span> </span><a href="#local-6989586621682170033"><span class="hs-identifier hs-var">new_fixities</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><a href="#local-6989586621682170042"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnv</span><span> </span><a href="#local-6989586621682170039"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682170041"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FixItem</span><span> </span><a href="#local-6989586621682170042"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621682170043"><span class="hs-identifier hs-var">fi</span></a><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-578"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170039"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-579"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-580"></a><span>        </span><a name="local-6989586621682170041"><a href="#local-6989586621682170041"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682170040"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-581"></a><span>        </span><a name="local-6989586621682170042"><a href="#local-6989586621682170042"><span class="hs-identifier">occ</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">greOccName</span><span> </span><a href="#local-6989586621682170040"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span>    </span><span class="hs-identifier">new_gres</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- New LocalDef GREs, derived from avails</span><span>
</span><a name="line-584"></a><span>    </span><a name="local-6989586621682170037"><a href="#local-6989586621682170037"><span class="hs-identifier">new_gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">localGREsFromAvail</span><span> </span><a href="#local-6989586621682170032"><span class="hs-identifier hs-var">avails</span></a><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>    </span><span class="hs-identifier">add_gre</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-587"></a><span>    </span><span class="hs-comment">-- Extend the GlobalRdrEnv with a LocalDef GRE</span><span>
</span><a name="line-588"></a><span>    </span><span class="hs-comment">-- If there is already a LocalDef GRE with the same OccName,</span><span>
</span><a name="line-589"></a><span>    </span><span class="hs-comment">--    report an error and discard the new GRE</span><span>
</span><a name="line-590"></a><span>    </span><span class="hs-comment">-- This establishes INVARIANT 1 of GlobalRdrEnvs</span><span>
</span><a name="line-591"></a><span>    </span><a name="local-6989586621682170038"><a href="#local-6989586621682170038"><span class="hs-identifier">add_gre</span></a></a><span> </span><a name="local-6989586621682170044"><a href="#local-6989586621682170044"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682170045"><a href="#local-6989586621682170045"><span class="hs-identifier">gre</span></a></a><span>
</span><a name="line-592"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170048"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Same OccName defined twice</span><span>
</span><a name="line-593"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnNames.html#addDupDeclErr"><span class="hs-identifier hs-var">addDupDeclErr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170045"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682170048"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682170044"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-596"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendGlobalRdrEnv</span><span> </span><a href="#local-6989586621682170044"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682170045"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-598"></a><span>        </span><a name="local-6989586621682170046"><a href="#local-6989586621682170046"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682170045"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-599"></a><span>        </span><a name="local-6989586621682170047"><a href="#local-6989586621682170047"><span class="hs-identifier">occ</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682170046"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-600"></a><span>        </span><a name="local-6989586621682170048"><a href="#local-6989586621682170048"><span class="hs-identifier">dups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isLocalGRE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupGlobalRdrEnv</span><span> </span><a href="#local-6989586621682170044"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682170047"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
    getLocalDeclBindersd@ returns the names for an HsDecl
             It's used for source code.

        *** See Note [The Naming story] in HsDecls ****
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-identifier">getLocalNonValBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-613"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span class="hs-comment">-- Get all the top-level binders bound the group *except*</span><span>
</span><a name="line-615"></a><span class="hs-comment">-- for value bindings, which are treated separately</span><span>
</span><a name="line-616"></a><span class="hs-comment">-- Specifically we return AvailInfo for</span><span>
</span><a name="line-617"></a><span class="hs-comment">--      * type decls (incl constructors and record selectors)</span><span>
</span><a name="line-618"></a><span class="hs-comment">--      * class decls (including class ops)</span><span>
</span><a name="line-619"></a><span class="hs-comment">--      * associated types</span><span>
</span><a name="line-620"></a><span class="hs-comment">--      * foreign imports</span><span>
</span><a name="line-621"></a><span class="hs-comment">--      * value signatures (in hs-boot files only)</span><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><a name="getLocalNonValBinders"><a href="RnNames.html#getLocalNonValBinders"><span class="hs-identifier">getLocalNonValBinders</span></a></a><span> </span><a name="local-6989586621682170067"><a href="#local-6989586621682170067"><span class="hs-identifier">fixity_env</span></a></a><span>
</span><a name="line-624"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_valds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170068"><a href="#local-6989586621682170068"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-625"></a><span>                </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170069"><a href="#local-6989586621682170069"><span class="hs-identifier">tycl_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-626"></a><span>                </span><span class="hs-identifier">hs_fords</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170070"><a href="#local-6989586621682170070"><span class="hs-identifier">foreign_decls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Process all type/class decls *except* family instances</span><span>
</span><a name="line-628"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170140"><a href="#local-6989586621682170140"><span class="hs-identifier">inst_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170069"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier">group_instds</span><span>
</span><a name="line-629"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170141"><a href="#local-6989586621682170141"><span class="hs-identifier">overload_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DuplicateRecordFields</span><span>
</span><a name="line-630"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170142"><a href="#local-6989586621682170142"><span class="hs-identifier">tc_avails</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170143"><a href="#local-6989586621682170143"><span class="hs-identifier">tc_fldss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170076"><span class="hs-identifier hs-var">new_tc</span></a><span> </span><a href="#local-6989586621682170141"><span class="hs-identifier hs-var">overload_ok</span></a><span class="hs-special">)</span><span>
</span><a name="line-632"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyClGroupTyClDecls</span><span> </span><a href="#local-6989586621682170069"><span class="hs-identifier hs-var">tycl_decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;getLocalNonValBinders 1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170142"><span class="hs-identifier hs-var">tc_avails</span></a><span class="hs-special">)</span><span>
</span><a name="line-634"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170144"><a href="#local-6989586621682170144"><span class="hs-identifier">envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span> </span><a href="#local-6989586621682170142"><span class="hs-identifier hs-var">tc_avails</span></a><span> </span><a href="#local-6989586621682170067"><span class="hs-identifier hs-var">fixity_env</span></a><span>
</span><a name="line-635"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-6989586621682170144"><span class="hs-identifier hs-var">envs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-636"></a><span>            </span><span class="hs-comment">-- Bring these things into scope first</span><span>
</span><a name="line-637"></a><span>            </span><span class="hs-comment">-- See Note [Looking up family names in family instances]</span><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span>          </span><span class="hs-comment">-- Process all family instances</span><span>
</span><a name="line-640"></a><span>          </span><span class="hs-comment">-- to bring new data constructors into scope</span><span>
</span><a name="line-641"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170145"><a href="#local-6989586621682170145"><span class="hs-identifier">nti_availss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170146"><a href="#local-6989586621682170146"><span class="hs-identifier">nti_fldss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170078"><span class="hs-identifier hs-var">new_assoc</span></a><span> </span><a href="#local-6989586621682170141"><span class="hs-identifier hs-var">overload_ok</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>                                                   </span><a href="#local-6989586621682170140"><span class="hs-identifier hs-var">inst_decls</span></a><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span>          </span><span class="hs-comment">-- Finish off with value binders:</span><span>
</span><a name="line-645"></a><span>          </span><span class="hs-comment">--    foreign decls and pattern synonyms for an ordinary module</span><span>
</span><a name="line-646"></a><span>          </span><span class="hs-comment">--    type sigs in case of a hs-boot file only</span><span>
</span><a name="line-647"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170147"><a href="#local-6989586621682170147"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span>
</span><a name="line-648"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170148"><a href="#local-6989586621682170148"><span class="hs-identifier">val_bndrs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170147"><span class="hs-identifier hs-var">is_boot</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170074"><span class="hs-identifier hs-var">hs_boot_sig_bndrs</span></a><span>
</span><a name="line-649"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170073"><span class="hs-identifier hs-var">for_hs_bndrs</span></a><span>
</span><a name="line-650"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170149"><a href="#local-6989586621682170149"><span class="hs-identifier">val_avails</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621682170075"><span class="hs-identifier hs-var">new_simple</span></a><span> </span><a href="#local-6989586621682170148"><span class="hs-identifier hs-var">val_bndrs</span></a><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170150"><a href="#local-6989586621682170150"><span class="hs-identifier">avails</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682170145"><span class="hs-identifier hs-var">nti_availss</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682170149"><span class="hs-identifier hs-var">val_avails</span></a><span>
</span><a name="line-653"></a><span>              </span><a name="local-6989586621682170151"><a href="#local-6989586621682170151"><span class="hs-identifier">new_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">availsToNameSetWithSelectors</span><span> </span><a href="#local-6989586621682170150"><span class="hs-identifier hs-var">avails</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span>
</span><a name="line-654"></a><span>                          </span><span class="hs-identifier hs-var">availsToNameSetWithSelectors</span><span> </span><a href="#local-6989586621682170142"><span class="hs-identifier hs-var">tc_avails</span></a><span>
</span><a name="line-655"></a><span>              </span><a name="local-6989586621682170152"><a href="#local-6989586621682170152"><span class="hs-identifier">flds</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682170146"><span class="hs-identifier hs-var">nti_fldss</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682170143"><span class="hs-identifier hs-var">tc_fldss</span></a><span>
</span><a name="line-656"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;getLocalNonValBinders 2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170150"><span class="hs-identifier hs-var">avails</span></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170153"><a href="#local-6989586621682170153"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170154"><a href="#local-6989586621682170154"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span> </span><a href="#local-6989586621682170150"><span class="hs-identifier hs-var">avails</span></a><span> </span><a href="#local-6989586621682170067"><span class="hs-identifier hs-var">fixity_env</span></a><span>
</span><a name="line-658"></a><span>
</span><a name="line-659"></a><span>        </span><span class="hs-comment">-- Extend tcg_field_env with new fields (this used to be the</span><span>
</span><a name="line-660"></a><span>        </span><span class="hs-comment">-- work of extendRecordFieldEnv)</span><span>
</span><a name="line-661"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170155"><a href="#local-6989586621682170155"><span class="hs-identifier">field_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_field_env</span><span> </span><a href="#local-6989586621682170153"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170152"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-662"></a><span>              </span><a name="local-6989586621682170156"><a href="#local-6989586621682170156"><span class="hs-identifier">envs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170153"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_field_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170155"><span class="hs-identifier hs-var">field_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170154"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;getLocalNonValBinders 3&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170152"><span class="hs-identifier hs-var">flds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170155"><span class="hs-identifier hs-var">field_env</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170156"><span class="hs-identifier hs-var">envs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170151"><span class="hs-identifier hs-var">new_bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-666"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-667"></a><span>    </span><span class="hs-identifier hs-var">ValBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170071"><a href="#local-6989586621682170071"><span class="hs-identifier">_val_binds</span></a></a><span> </span><a name="local-6989586621682170072"><a href="#local-6989586621682170072"><span class="hs-identifier">val_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170068"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>    </span><span class="hs-identifier">for_hs_bndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span>
</span><a name="line-670"></a><span>    </span><a name="local-6989586621682170073"><a href="#local-6989586621682170073"><span class="hs-identifier">for_hs_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsForeignDeclsBinders</span><span> </span><a href="#local-6989586621682170070"><span class="hs-identifier hs-var">foreign_decls</span></a><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span>    </span><span class="hs-comment">-- In a hs-boot file, the value binders come from the</span><span>
</span><a name="line-673"></a><span>    </span><span class="hs-comment">--  *signatures*, and there should be no foreign binders</span><span>
</span><a name="line-674"></a><span>    </span><a name="local-6989586621682170074"><a href="#local-6989586621682170074"><span class="hs-identifier">hs_boot_sig_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170081"><span class="hs-identifier hs-var">decl_loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170083"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170081"><a href="#local-6989586621682170081"><span class="hs-identifier">decl_loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170082"><a href="#local-6989586621682170082"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170072"><span class="hs-identifier hs-var">val_sigs</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170083"><a href="#local-6989586621682170083"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170082"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">]</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span>      </span><span class="hs-comment">-- the SrcSpan attached to the input should be the span of the</span><span>
</span><a name="line-678"></a><span>      </span><span class="hs-comment">-- declaration, not just the name</span><span>
</span><a name="line-679"></a><span>    </span><span class="hs-identifier">new_simple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span>
</span><a name="line-680"></a><span>    </span><a name="local-6989586621682170075"><a href="#local-6989586621682170075"><span class="hs-identifier">new_simple</span></a></a><span> </span><a name="local-6989586621682170084"><a href="#local-6989586621682170084"><span class="hs-identifier">rdr_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170085"><a href="#local-6989586621682170085"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#newTopSrcBinder"><span class="hs-identifier hs-var">newTopSrcBinder</span></a><span> </span><a href="#local-6989586621682170084"><span class="hs-identifier hs-var">rdr_name</span></a><span>
</span><a name="line-681"></a><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">avail</span><span> </span><a href="#local-6989586621682170085"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span>    </span><span class="hs-identifier">new_tc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-684"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>    </span><a name="local-6989586621682170076"><a href="#local-6989586621682170076"><span class="hs-identifier">new_tc</span></a></a><span> </span><a name="local-6989586621682170086"><a href="#local-6989586621682170086"><span class="hs-identifier">overload_ok</span></a></a><span> </span><a name="local-6989586621682170087"><a href="#local-6989586621682170087"><span class="hs-identifier">tc_decl</span></a></a><span> </span><span class="hs-comment">-- NOT for type/data instances</span><span>
</span><a name="line-686"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170088"><a href="#local-6989586621682170088"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170089"><a href="#local-6989586621682170089"><span class="hs-identifier">flds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsLTyClDeclBinders</span><span> </span><a href="#local-6989586621682170087"><span class="hs-identifier hs-var">tc_decl</span></a><span>
</span><a name="line-687"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170090"><a href="#local-6989586621682170090"><span class="hs-identifier">names</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621682170091"><a href="#local-6989586621682170091"><span class="hs-identifier">main_name</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682170092"><a href="#local-6989586621682170092"><span class="hs-identifier">sub_names</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnEnv.html#newTopSrcBinder"><span class="hs-identifier hs-var">newTopSrcBinder</span></a><span> </span><a href="#local-6989586621682170088"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-688"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170093"><a href="#local-6989586621682170093"><span class="hs-identifier">flds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#newRecordSelector"><span class="hs-identifier hs-var">newRecordSelector</span></a><span> </span><a href="#local-6989586621682170086"><span class="hs-identifier hs-var">overload_ok</span></a><span> </span><a href="#local-6989586621682170092"><span class="hs-identifier hs-var">sub_names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170089"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-689"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170094"><a href="#local-6989586621682170094"><span class="hs-identifier">fld_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170087"><span class="hs-identifier hs-var">tc_decl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-690"></a><span>                     </span><span class="hs-identifier hs-var">DataDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170095"><a href="#local-6989586621682170095"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170077"><span class="hs-identifier hs-var">mk_fld_env</span></a><span> </span><a href="#local-6989586621682170095"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621682170090"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621682170093"><span class="hs-identifier hs-var">flds'</span></a><span>
</span><a name="line-691"></a><span>                     </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-692"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170091"><span class="hs-identifier hs-var">main_name</span></a><span> </span><a href="#local-6989586621682170090"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621682170093"><span class="hs-identifier hs-var">flds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170094"><span class="hs-identifier hs-var">fld_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span>    </span><span class="hs-comment">-- Calculate the mapping from constructor names to fields, which</span><span>
</span><a name="line-696"></a><span>    </span><span class="hs-comment">-- will go in tcg_field_env. It's convenient to do this here where</span><span>
</span><a name="line-697"></a><span>    </span><span class="hs-comment">-- we are working with a single datatype definition.</span><span>
</span><a name="line-698"></a><span>    </span><span class="hs-identifier">mk_fld_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsDataDefn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span>
</span><a name="line-699"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-700"></a><span>    </span><a name="local-6989586621682170077"><a href="#local-6989586621682170077"><span class="hs-identifier">mk_fld_env</span></a></a><span> </span><a name="local-6989586621682170096"><a href="#local-6989586621682170096"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621682170097"><a href="#local-6989586621682170097"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621682170098"><a href="#local-6989586621682170098"><span class="hs-identifier">flds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621682170099"><span class="hs-identifier hs-var">find_con_flds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dd_cons</span><span> </span><a href="#local-6989586621682170096"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-702"></a><span>        </span><a name="local-6989586621682170099"><a href="#local-6989586621682170099"><span class="hs-identifier">find_con_flds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConDeclH98</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170103"><a href="#local-6989586621682170103"><span class="hs-identifier">rdr</span></a></a><span>
</span><a name="line-703"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecCon</span><span> </span><a name="local-6989586621682170104"><a href="#local-6989586621682170104"><span class="hs-identifier">cdflds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-704"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682170100"><span class="hs-identifier hs-var">find_con_name</span></a><span> </span><a href="#local-6989586621682170103"><span class="hs-identifier hs-var">rdr</span></a><span>
</span><a name="line-705"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621682170101"><span class="hs-identifier hs-var">find_con_decl_flds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170104"><span class="hs-identifier hs-var">cdflds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-identifier">find_con_flds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConDeclGADT</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_names</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170105"><a href="#local-6989586621682170105"><span class="hs-identifier">rdrs</span></a></a><span>
</span><a name="line-707"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecCon</span><span> </span><a name="local-6989586621682170106"><a href="#local-6989586621682170106"><span class="hs-identifier">flds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682170100"><span class="hs-identifier hs-var">find_con_name</span></a><span> </span><a href="#local-6989586621682170107"><span class="hs-identifier hs-var">rdr</span></a><span>
</span><a name="line-709"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621682170101"><span class="hs-identifier hs-var">find_con_decl_flds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170106"><span class="hs-identifier hs-var">flds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170107"><a href="#local-6989586621682170107"><span class="hs-identifier">rdr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170105"><span class="hs-identifier hs-var">rdrs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>        </span><span class="hs-identifier">find_con_flds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span>        </span><a name="local-6989586621682170100"><a href="#local-6989586621682170100"><span class="hs-identifier">find_con_name</span></a></a><span> </span><a name="local-6989586621682170108"><a href="#local-6989586621682170108"><span class="hs-identifier">rdr</span></a></a><span>
</span><a name="line-715"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;getLocalNonValBinders/find_con_name&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-716"></a><span>              </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682170109"><a href="#local-6989586621682170109"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682170109"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621682170108"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170097"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-717"></a><span>        </span><a name="local-6989586621682170101"><a href="#local-6989586621682170101"><span class="hs-identifier">find_con_decl_flds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170110"><a href="#local-6989586621682170110"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682170102"><span class="hs-identifier hs-var">find_con_decl_fld</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cd_fld_names</span><span> </span><a href="#local-6989586621682170110"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span>        </span><a name="local-6989586621682170102"><a href="#local-6989586621682170102"><span class="hs-identifier">find_con_decl_fld</span></a></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170111"><a href="#local-6989586621682170111"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;getLocalNonValBinders/find_con_decl_fld&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-722"></a><span>              </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682170113"><a href="#local-6989586621682170113"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621682170113"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682170112"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170098"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-723"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682170112"><a href="#local-6989586621682170112"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621682170111"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-724"></a><span>        </span><span class="hs-identifier">find_con_decl_fld</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFieldOcc</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getLocalNonValBinders&quot;</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span>    </span><span class="hs-identifier">new_assoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-727"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-728"></a><span>    </span><a name="local-6989586621682170078"><a href="#local-6989586621682170078"><span class="hs-identifier">new_assoc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFamInstD</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-729"></a><span>      </span><span class="hs-comment">-- type instances don't bind new names</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span>    </span><span class="hs-identifier">new_assoc</span><span> </span><a name="local-6989586621682170114"><a href="#local-6989586621682170114"><span class="hs-identifier">overload_ok</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170115"><a href="#local-6989586621682170115"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170116"><a href="#local-6989586621682170116"><span class="hs-identifier">avail</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170117"><a href="#local-6989586621682170117"><span class="hs-identifier">flds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170079"><span class="hs-identifier hs-var">new_di</span></a><span> </span><a href="#local-6989586621682170114"><span class="hs-identifier hs-var">overload_ok</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682170115"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-733"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682170116"><span class="hs-identifier hs-var">avail</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170117"><span class="hs-identifier hs-var">flds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-734"></a><span>    </span><span class="hs-identifier">new_assoc</span><span> </span><a name="local-6989586621682170118"><a href="#local-6989586621682170118"><span class="hs-identifier">overload_ok</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_poly_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170119"><a href="#local-6989586621682170119"><span class="hs-identifier">inst_ty</span></a></a><span>
</span><a name="line-735"></a><span>                                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_datafam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170120"><a href="#local-6989586621682170120"><span class="hs-identifier">adts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-736"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170121"><a href="#local-6989586621682170121"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682170122"><a href="#local-6989586621682170122"><span class="hs-identifier">cls_rdr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getLHsInstDeclClass_maybe</span><span> </span><a href="#local-6989586621682170119"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-737"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170123"><a href="#local-6989586621682170123"><span class="hs-identifier">cls_nm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682170121"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnEnv.html#lookupGlobalOccRn"><span class="hs-identifier hs-var">lookupGlobalOccRn</span></a><span> </span><a href="#local-6989586621682170122"><span class="hs-identifier hs-var">cls_rdr</span></a><span>
</span><a name="line-738"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170124"><a href="#local-6989586621682170124"><span class="hs-identifier">avails</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170125"><a href="#local-6989586621682170125"><span class="hs-identifier">fldss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-739"></a><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170080"><span class="hs-identifier hs-var">new_loc_di</span></a><span> </span><a href="#local-6989586621682170118"><span class="hs-identifier hs-var">overload_ok</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682170123"><span class="hs-identifier hs-var">cls_nm</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170120"><span class="hs-identifier hs-var">adts</span></a><span>
</span><a name="line-740"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170124"><span class="hs-identifier hs-var">avails</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682170125"><span class="hs-identifier hs-var">fldss</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-741"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-742"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Do not crash on ill-formed instances</span><span>
</span><a name="line-743"></a><span>                           </span><span class="hs-comment">-- Eg   instance !Show Int   Trac #3811c</span><span>
</span><a name="line-744"></a><span>    </span><span class="hs-identifier">new_assoc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XClsInstDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;new_assoc&quot;</span><span>
</span><a name="line-745"></a><span>    </span><span class="hs-identifier">new_assoc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XInstDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;new_assoc&quot;</span><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span>    </span><span class="hs-identifier">new_di</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-748"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>    </span><a name="local-6989586621682170079"><a href="#local-6989586621682170079"><span class="hs-identifier">new_di</span></a></a><span> </span><a name="local-6989586621682170126"><a href="#local-6989586621682170126"><span class="hs-identifier">overload_ok</span></a></a><span> </span><a name="local-6989586621682170127"><a href="#local-6989586621682170127"><span class="hs-identifier">mb_cls</span></a></a><span> </span><a name="local-6989586621682170128"><a href="#local-6989586621682170128"><span class="hs-identifier">dfid</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-750"></a><span>                                     </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170129"><a href="#local-6989586621682170129"><span class="hs-identifier">ti_decl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170130"><a href="#local-6989586621682170130"><span class="hs-identifier">main_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupFamInstName"><span class="hs-identifier hs-var">lookupFamInstName</span></a><span> </span><a href="#local-6989586621682170127"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">feqn_tycon</span><span> </span><a href="#local-6989586621682170129"><span class="hs-identifier hs-var">ti_decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170131"><a href="#local-6989586621682170131"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170132"><a href="#local-6989586621682170132"><span class="hs-identifier">flds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsDataFamInstBinders</span><span> </span><a href="#local-6989586621682170128"><span class="hs-identifier hs-var">dfid</span></a><span>
</span><a name="line-753"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170133"><a href="#local-6989586621682170133"><span class="hs-identifier">sub_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnEnv.html#newTopSrcBinder"><span class="hs-identifier hs-var">newTopSrcBinder</span></a><span> </span><a href="#local-6989586621682170131"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-754"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170134"><a href="#local-6989586621682170134"><span class="hs-identifier">flds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#newRecordSelector"><span class="hs-identifier hs-var">newRecordSelector</span></a><span> </span><a href="#local-6989586621682170126"><span class="hs-identifier hs-var">overload_ok</span></a><span> </span><a href="#local-6989586621682170133"><span class="hs-identifier hs-var">sub_names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170132"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-755"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170135"><a href="#local-6989586621682170135"><span class="hs-identifier">avail</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170130"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170133"><span class="hs-identifier hs-var">sub_names</span></a><span> </span><a href="#local-6989586621682170134"><span class="hs-identifier hs-var">flds'</span></a><span>
</span><a name="line-756"></a><span>                                  </span><span class="hs-comment">-- main_name is not bound here!</span><span>
</span><a name="line-757"></a><span>                   </span><a name="local-6989586621682170136"><a href="#local-6989586621682170136"><span class="hs-identifier">fld_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170077"><span class="hs-identifier hs-var">mk_fld_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">feqn_rhs</span><span> </span><a href="#local-6989586621682170129"><span class="hs-identifier hs-var">ti_decl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170133"><span class="hs-identifier hs-var">sub_names</span></a><span> </span><a href="#local-6989586621682170134"><span class="hs-identifier hs-var">flds'</span></a><span>
</span><a name="line-758"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170135"><span class="hs-identifier hs-var">avail</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170136"><span class="hs-identifier hs-var">fld_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-759"></a><span>    </span><span class="hs-identifier">new_di</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;new_di&quot;</span><span>
</span><a name="line-760"></a><span>
</span><a name="line-761"></a><span>    </span><span class="hs-identifier">new_loc_di</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LDataFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-762"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-763"></a><span>    </span><a name="local-6989586621682170080"><a href="#local-6989586621682170080"><span class="hs-identifier">new_loc_di</span></a></a><span> </span><a name="local-6989586621682170137"><a href="#local-6989586621682170137"><span class="hs-identifier">overload_ok</span></a></a><span> </span><a name="local-6989586621682170138"><a href="#local-6989586621682170138"><span class="hs-identifier">mb_cls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170139"><a href="#local-6989586621682170139"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170079"><span class="hs-identifier hs-var">new_di</span></a><span> </span><a href="#local-6989586621682170137"><span class="hs-identifier hs-var">overload_ok</span></a><span> </span><a href="#local-6989586621682170138"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><a href="#local-6989586621682170139"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-764"></a><span class="hs-identifier">getLocalNonValBinders</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getLocalNonValBinders&quot;</span><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-identifier">newRecordSelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span>
</span><a name="line-767"></a><a name="newRecordSelector"><a href="RnNames.html#newRecordSelector"><span class="hs-identifier">newRecordSelector</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;newRecordSelector: datatype has no constructors!&quot;</span><span>
</span><a name="line-768"></a><span class="hs-identifier">newRecordSelector</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFieldOcc</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;newRecordSelector&quot;</span><span>
</span><a name="line-769"></a><span class="hs-identifier">newRecordSelector</span><span> </span><a name="local-6989586621682170157"><a href="#local-6989586621682170157"><span class="hs-identifier">overload_ok</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682170158"><a href="#local-6989586621682170158"><span class="hs-identifier">dc</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170159"><a href="#local-6989586621682170159"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170160"><a href="#local-6989586621682170160"><span class="hs-identifier">fld</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170164"><a href="#local-6989586621682170164"><span class="hs-identifier">selName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#newTopSrcBinder"><span class="hs-identifier hs-var">newTopSrcBinder</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170159"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682170163"><span class="hs-identifier hs-var">field</span></a><span>
</span><a name="line-771"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682170162"><span class="hs-identifier hs-var">qualFieldLbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170164"><span class="hs-identifier hs-var">selName</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-772"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-773"></a><span>    </span><a name="local-6989586621682170161"><a href="#local-6989586621682170161"><span class="hs-identifier">fieldOccName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621682170160"><span class="hs-identifier hs-var">fld</span></a><span>
</span><a name="line-774"></a><span>    </span><a name="local-6989586621682170162"><a href="#local-6989586621682170162"><span class="hs-identifier">qualFieldLbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFieldLabelOccs</span><span> </span><a href="#local-6989586621682170161"><span class="hs-identifier hs-var">fieldOccName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682170158"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170157"><span class="hs-identifier hs-var">overload_ok</span></a><span>
</span><a name="line-775"></a><span>    </span><a name="local-6989586621682170163"><a href="#local-6989586621682170163"><span class="hs-identifier">field</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isExact</span><span> </span><a href="#local-6989586621682170160"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170160"><span class="hs-identifier hs-var">fld</span></a><span>
</span><a name="line-776"></a><span>              </span><span class="hs-comment">-- use an Exact RdrName as is to preserve the bindings</span><span>
</span><a name="line-777"></a><span>              </span><span class="hs-comment">-- of an already renamer-resolved field and its use</span><span>
</span><a name="line-778"></a><span>              </span><span class="hs-comment">-- sites. This is needed to correctly support record</span><span>
</span><a name="line-779"></a><span>              </span><span class="hs-comment">-- selectors in Template Haskell. See Note [Binders in</span><span>
</span><a name="line-780"></a><span>              </span><span class="hs-comment">-- Template Haskell] in Convert.hs and Note [Looking up</span><span>
</span><a name="line-781"></a><span>              </span><span class="hs-comment">-- Exact RdrNames] in RnEnv.hs.</span><span>
</span><a name="line-782"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRdrUnqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621682170162"><span class="hs-identifier hs-var">qualFieldLbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span class="hs-comment">{-
Note [Looking up family names in family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  module M where
    type family T a :: *
    type instance M.T Int = Bool

We might think that we can simply use 'lookupOccRn' when processing the type
instance to look up 'M.T'.  Alas, we can't!  The type family declaration is in
the *same* HsGroup as the type instance declaration.  Hence, as we are
currently collecting the binders declared in that HsGroup, these binders will
not have been added to the global environment yet.

Solution is simple: process the type family declarations first, extend
the environment, and then process the type instances.


************************************************************************
*                                                                      *
\subsection{Filtering imports}
*                                                                      *
************************************************************************

@filterImports@ takes the @ExportEnv@ telling what the imported module makes
available, and filters it through the import spec (if any).

Note [Dealing with imports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
For import M( ies ), we take the mi_exports of M, and make
   imp_occ_env :: OccEnv (Name, AvailInfo, Maybe Name)
One entry for each Name that M exports; the AvailInfo is the
AvailInfo exported from M that exports that Name.

The situation is made more complicated by associated types. E.g.
   module M where
     class    C a    where { data T a }
     instance C Int  where { data T Int = T1 | T2 }
     instance C Bool where { data T Int = T3 }
Then M's export_avails are (recall the AvailTC invariant from Avails.hs)
  C(C,T), T(T,T1,T2,T3)
Notice that T appears *twice*, once as a child and once as a parent. From
this list we construct a raw list including
   T -&gt; (T, T( T1, T2, T3 ), Nothing)
   T -&gt; (C, C( C, T ),       Nothing)
and we combine these (in function 'combine' in 'imp_occ_env' in
'filterImports') to get
   T  -&gt; (T,  T(T,T1,T2,T3), Just C)

So the overall imp_occ_env is
   C  -&gt; (C,  C(C,T),        Nothing)
   T  -&gt; (T,  T(T,T1,T2,T3), Just C)
   T1 -&gt; (T1, T(T,T1,T2,T3), Nothing)   -- similarly T2,T3

If we say
   import M( T(T1,T2) )
then we get *two* Avails:  C(T), T(T1,T2)

Note that the imp_occ_env will have entries for data constructors too,
although we never look up data constructors.
-}</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-identifier">filterImports</span><span>
</span><a name="line-848"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-849"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImpDeclSpec</span><span>                     </span><span class="hs-comment">-- The span for the entire import decl</span><span>
</span><a name="line-850"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Import spec; True =&gt; hiding</span><span>
</span><a name="line-851"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Import spec w/ Names</span><span>
</span><a name="line-852"></a><span>            </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- Same again, but in GRE form</span><span>
</span><a name="line-853"></a><a name="filterImports"><a href="RnNames.html#filterImports"><span class="hs-identifier">filterImports</span></a></a><span> </span><a name="local-6989586621682170165"><a href="#local-6989586621682170165"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621682170166"><a href="#local-6989586621682170166"><span class="hs-identifier">decl_spec</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-854"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gresFromAvails</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682170167"><span class="hs-identifier hs-var">imp_spec</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exports</span><span> </span><a href="#local-6989586621682170165"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-855"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-856"></a><span>    </span><a name="local-6989586621682170167"><a href="#local-6989586621682170167"><span class="hs-identifier">imp_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpSpec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_decl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170166"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_item</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpAll</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span class="hs-identifier">filterImports</span><span> </span><a name="local-6989586621682170168"><a href="#local-6989586621682170168"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621682170169"><a href="#local-6989586621682170169"><span class="hs-identifier">decl_spec</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170170"><a href="#local-6989586621682170170"><span class="hs-identifier">want_hiding</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170171"><a href="#local-6989586621682170171"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170172"><a href="#local-6989586621682170172"><span class="hs-identifier">import_items</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- check for errors, convert RdrNames to Names</span><span>
</span><a name="line-861"></a><span>        </span><a name="local-6989586621682170280"><a href="#local-6989586621682170280"><span class="hs-identifier">items1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621682170176"><span class="hs-identifier hs-var">lookup_lie</span></a><span> </span><a href="#local-6989586621682170172"><span class="hs-identifier hs-var">import_items</span></a><span>
</span><a name="line-862"></a><span>
</span><a name="line-863"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">items2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-864"></a><span>            </span><a name="local-6989586621682170281"><a href="#local-6989586621682170281"><span class="hs-identifier">items2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682170280"><span class="hs-identifier hs-var">items1</span></a><span>
</span><a name="line-865"></a><span>                </span><span class="hs-comment">-- NB the AvailInfo may have duplicates, and several items</span><span>
</span><a name="line-866"></a><span>                </span><span class="hs-comment">--    for the same parent; e.g N(x) and N(y)</span><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span>            </span><a name="local-6989586621682170282"><a href="#local-6989586621682170282"><span class="hs-identifier">names</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">availsToNameSetWithSelectors</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621682170281"><span class="hs-identifier hs-var">items2</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>            </span><a name="local-6989586621682170283"><a href="#local-6989586621682170283"><span class="hs-identifier">keep</span></a></a><span> </span><a name="local-6989586621682170287"><a href="#local-6989586621682170287"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170287"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170282"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>            </span><a name="local-6989586621682170284"><a href="#local-6989586621682170284"><span class="hs-identifier">pruned_avails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterAvails</span><span> </span><a href="#local-6989586621682170283"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="#local-6989586621682170173"><span class="hs-identifier hs-var">all_avails</span></a><span>
</span><a name="line-871"></a><span>            </span><a name="local-6989586621682170285"><a href="#local-6989586621682170285"><span class="hs-identifier">hiding_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpSpec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_decl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170169"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_item</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpAll</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span>            </span><a name="local-6989586621682170286"><a href="#local-6989586621682170286"><span class="hs-identifier">gres</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170170"><span class="hs-identifier hs-var">want_hiding</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gresFromAvails</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682170285"><span class="hs-identifier hs-var">hiding_spec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170284"><span class="hs-identifier hs-var">pruned_avails</span></a><span>
</span><a name="line-874"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#gresFromIE"><span class="hs-identifier hs-var">gresFromIE</span></a><span> </span><a href="#local-6989586621682170169"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170281"><span class="hs-identifier hs-var">items2</span></a><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170170"><span class="hs-identifier hs-var">want_hiding</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170171"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682170281"><span class="hs-identifier hs-var">items2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170286"><span class="hs-identifier hs-var">gres</span></a><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-878"></a><span>    </span><a name="local-6989586621682170173"><a href="#local-6989586621682170173"><span class="hs-identifier">all_avails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_exports</span><span> </span><a href="#local-6989586621682170168"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span>        </span><span class="hs-comment">-- See Note [Dealing with imports]</span><span>
</span><a name="line-881"></a><span>    </span><span class="hs-identifier">imp_occ_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- the name</span><span>
</span><a name="line-882"></a><span>                           </span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- the export item providing the name</span><span>
</span><a name="line-883"></a><span>                           </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the parent of associated types</span><span>
</span><a name="line-884"></a><span>    </span><a name="local-6989586621682170174"><a href="#local-6989586621682170174"><span class="hs-identifier">imp_occ_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkOccEnv_C</span><span> </span><a href="#local-6989586621682170178"><span class="hs-identifier hs-var">combine</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170191"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170190"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170189"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-885"></a><span>                                     </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682170189"><a href="#local-6989586621682170189"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170173"><span class="hs-identifier hs-var">all_avails</span></a><span>
</span><a name="line-886"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170190"><a href="#local-6989586621682170190"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170191"><a href="#local-6989586621682170191"><span class="hs-identifier">occ</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">availNamesWithOccs</span><span> </span><a href="#local-6989586621682170189"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-887"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-888"></a><span>        </span><span class="hs-comment">-- See Note [Dealing with imports]</span><span>
</span><a name="line-889"></a><span>        </span><span class="hs-comment">-- 'combine' is only called for associated data types which appear</span><span>
</span><a name="line-890"></a><span>        </span><span class="hs-comment">-- twice in the all_avails. In the example, we combine</span><span>
</span><a name="line-891"></a><span>        </span><span class="hs-comment">--    T(T,T1,T2,T3) and C(C,T)  to give   (T, T(T,T1,T2,T3), Just C)</span><span>
</span><a name="line-892"></a><span>        </span><span class="hs-comment">-- NB: the AvailTC can have fields as well as data constructors (Trac #12127)</span><span>
</span><a name="line-893"></a><span>        </span><a name="local-6989586621682170178"><a href="#local-6989586621682170178"><span class="hs-identifier">combine</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682170179"><a href="#local-6989586621682170179"><span class="hs-identifier">name1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170180"><a href="#local-6989586621682170180"><span class="hs-identifier">a1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682170181"><a href="#local-6989586621682170181"><span class="hs-identifier">p1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682170182"><a href="#local-6989586621682170182"><span class="hs-identifier">mp1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-894"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621682170183"><a href="#local-6989586621682170183"><span class="hs-identifier">name2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170184"><a href="#local-6989586621682170184"><span class="hs-identifier">a2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682170185"><a href="#local-6989586621682170185"><span class="hs-identifier">p2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682170186"><a href="#local-6989586621682170186"><span class="hs-identifier">mp2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-895"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">name1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">name2</span><span> </span><a href="#local-6989586621682170179"><span class="hs-operator hs-var">&amp;&amp;</span></a><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">mp1</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">mp2</span><span>
</span><a name="line-896"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">name1</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">name2</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">mp1</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">mp2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682170181"><span class="hs-identifier hs-var">p1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682170179"><span class="hs-identifier hs-var">name1</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170179"><span class="hs-identifier hs-var">name1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170180"><span class="hs-identifier hs-var">a1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682170185"><span class="hs-identifier hs-var">p2</span></a><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170179"><span class="hs-identifier hs-var">name1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170184"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682170181"><span class="hs-identifier hs-var">p1</span></a><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>        </span><span class="hs-identifier">combine</span><span> </span><a name="local-6989586621682170187"><a href="#local-6989586621682170187"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682170188"><a href="#local-6989586621682170188"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;filterImports/combine&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170187"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170188"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>
</span><a name="line-901"></a><span>    </span><span class="hs-identifier">lookup_name</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>    </span><a name="local-6989586621682170175"><a href="#local-6989586621682170175"><span class="hs-identifier">lookup_name</span></a></a><span> </span><a name="local-6989586621682170192"><a href="#local-6989586621682170192"><span class="hs-identifier">ie</span></a></a><span> </span><a name="local-6989586621682170193"><a href="#local-6989586621682170193"><span class="hs-identifier">rdr</span></a></a><span>
</span><a name="line-903"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isQual</span><span> </span><a href="#local-6989586621682170193"><span class="hs-identifier hs-var">rdr</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#failLookupWith"><span class="hs-identifier hs-var">failLookupWith</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#QualImportError"><span class="hs-identifier hs-var">QualImportError</span></a><span> </span><a href="#local-6989586621682170193"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-904"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170195"><a href="#local-6989586621682170195"><span class="hs-identifier">succ</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170194"><span class="hs-identifier hs-var">mb_success</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682170195"><span class="hs-identifier hs-var">succ</span></a><span>
</span><a name="line-905"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#failLookupWith"><span class="hs-identifier hs-var">failLookupWith</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#BadImport"><span class="hs-identifier hs-var">BadImport</span></a><span> </span><a href="#local-6989586621682170192"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-907"></a><span>        </span><a name="local-6989586621682170194"><a href="#local-6989586621682170194"><span class="hs-identifier">mb_success</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682170174"><span class="hs-identifier hs-var">imp_occ_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621682170193"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><span>    </span><span class="hs-identifier">lookup_lie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-910"></a><span>    </span><a name="local-6989586621682170176"><a href="#local-6989586621682170176"><span class="hs-identifier">lookup_lie</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170196"><a href="#local-6989586621682170196"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682170197"><a href="#local-6989586621682170197"><span class="hs-identifier">ieRdr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170210"><a href="#local-6989586621682170210"><span class="hs-identifier">stuff</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170211"><a href="#local-6989586621682170211"><span class="hs-identifier">warns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682170196"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-912"></a><span>                               </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-913"></a><span>                               </span><a href="#local-6989586621682170199"><span class="hs-identifier hs-var">run_lookup</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170177"><span class="hs-identifier hs-var">lookup_ie</span></a><span> </span><a href="#local-6989586621682170197"><span class="hs-identifier hs-var">ieRdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-914"></a><span>             </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682170198"><span class="hs-identifier hs-var">emit_warning</span></a><span> </span><a href="#local-6989586621682170211"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-915"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170196"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682170212"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170213"><span class="hs-identifier hs-var">avail</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170212"><a href="#local-6989586621682170212"><span class="hs-identifier">ie</span></a></a><span class="hs-special">,</span><a name="local-6989586621682170213"><a href="#local-6989586621682170213"><span class="hs-identifier">avail</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170210"><span class="hs-identifier hs-var">stuff</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-916"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-917"></a><span>            </span><span class="hs-comment">-- Warn when importing T(..) if T was exported abstractly</span><span>
</span><a name="line-918"></a><span>            </span><a name="local-6989586621682170198"><a href="#local-6989586621682170198"><span class="hs-identifier">emit_warning</span></a></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#DodgyImport"><span class="hs-identifier hs-var">DodgyImport</span></a><span> </span><a name="local-6989586621682170202"><a href="#local-6989586621682170202"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnDodgyImports</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-919"></a><span>              </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnDodgyImports</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#dodgyImportWarn"><span class="hs-identifier hs-var">dodgyImportWarn</span></a><span> </span><a href="#local-6989586621682170202"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>            </span><span class="hs-identifier">emit_warning</span><span> </span><a href="RnNames.html#MissingImportList"><span class="hs-identifier hs-var">MissingImportList</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingImportList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-921"></a><span>              </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingImportList</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#missingImportListItem"><span class="hs-identifier hs-var">missingImportListItem</span></a><span> </span><a href="#local-6989586621682170197"><span class="hs-identifier hs-var">ieRdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>            </span><span class="hs-identifier">emit_warning</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#BadImportW"><span class="hs-identifier hs-var">BadImportW</span></a><span> </span><a name="local-6989586621682170203"><a href="#local-6989586621682170203"><span class="hs-identifier">ie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnDodgyImports</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-923"></a><span>              </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnDodgyImports</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170200"><span class="hs-identifier hs-var">lookup_err_msg</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#BadImport"><span class="hs-identifier hs-var">BadImport</span></a><span> </span><a href="#local-6989586621682170203"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span>            </span><span class="hs-identifier">run_lookup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><a href="#local-6989586621682170201"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621682170201"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-926"></a><span>            </span><a name="local-6989586621682170199"><a href="#local-6989586621682170199"><span class="hs-identifier">run_lookup</span></a></a><span> </span><a name="local-6989586621682170204"><a href="#local-6989586621682170204"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170204"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-927"></a><span>              </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621682170205"><a href="#local-6989586621682170205"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170200"><span class="hs-identifier hs-var">lookup_err_msg</span></a><span> </span><a href="#local-6989586621682170205"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-928"></a><span>              </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621682170206"><a href="#local-6989586621682170206"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682170206"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span>            </span><a name="local-6989586621682170200"><a href="#local-6989586621682170200"><span class="hs-identifier">lookup_err_msg</span></a></a><span> </span><a name="local-6989586621682170207"><a href="#local-6989586621682170207"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170207"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-931"></a><span>              </span><a href="RnNames.html#BadImport"><span class="hs-identifier hs-var">BadImport</span></a><span> </span><a name="local-6989586621682170208"><a href="#local-6989586621682170208"><span class="hs-identifier">ie</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#badImportItemErr"><span class="hs-identifier hs-var">badImportItemErr</span></a><span> </span><a href="#local-6989586621682170168"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682170169"><span class="hs-identifier hs-var">decl_spec</span></a><span> </span><a href="#local-6989586621682170208"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682170173"><span class="hs-identifier hs-var">all_avails</span></a><span>
</span><a name="line-932"></a><span>              </span><a href="RnNames.html#IllegalImport"><span class="hs-identifier hs-var">IllegalImport</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#illegalImportItemErr"><span class="hs-identifier hs-var">illegalImportItemErr</span></a><span>
</span><a name="line-933"></a><span>              </span><a href="RnNames.html#QualImportError"><span class="hs-identifier hs-var">QualImportError</span></a><span> </span><a name="local-6989586621682170209"><a href="#local-6989586621682170209"><span class="hs-identifier">rdr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#qualImportItemErr"><span class="hs-identifier hs-var">qualImportItemErr</span></a><span> </span><a href="#local-6989586621682170209"><span class="hs-identifier hs-var">rdr</span></a><span>
</span><a name="line-934"></a><span>
</span><a name="line-935"></a><span>        </span><span class="hs-comment">-- For each import item, we convert its RdrNames to Names,</span><span>
</span><a name="line-936"></a><span>        </span><span class="hs-comment">-- and at the same time construct an AvailInfo corresponding</span><span>
</span><a name="line-937"></a><span>        </span><span class="hs-comment">-- to what is actually imported by this item.</span><span>
</span><a name="line-938"></a><span>        </span><span class="hs-comment">-- Returns Nothing on error.</span><span>
</span><a name="line-939"></a><span>        </span><span class="hs-comment">-- We return a list here, because in the case of an import</span><span>
</span><a name="line-940"></a><span>        </span><span class="hs-comment">-- item like C, if we are hiding, then C refers to *both* a</span><span>
</span><a name="line-941"></a><span>        </span><span class="hs-comment">-- type/class and a data constructor.  Moreover, when we import</span><span>
</span><a name="line-942"></a><span>        </span><span class="hs-comment">-- data constructors of an associated family, we need separate</span><span>
</span><a name="line-943"></a><span>        </span><span class="hs-comment">-- AvailInfos for the data constructors and the family (as they have</span><span>
</span><a name="line-944"></a><span>        </span><span class="hs-comment">-- different parents).  See Note [Dealing with imports]</span><span>
</span><a name="line-945"></a><span>    </span><span class="hs-identifier">lookup_ie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-946"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#IELookupWarning"><span class="hs-identifier hs-type">IELookupWarning</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-947"></a><span>    </span><a name="local-6989586621682170177"><a href="#local-6989586621682170177"><span class="hs-identifier">lookup_ie</span></a></a><span> </span><a name="local-6989586621682170214"><a href="#local-6989586621682170214"><span class="hs-identifier">ie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170216"><span class="hs-identifier hs-var">handle_bad_import</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-948"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-949"></a><span>        </span><span class="hs-identifier hs-var">IEVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170228"><a href="#local-6989586621682170228"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170229"><a href="#local-6989586621682170229"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-950"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682170230"><a href="#local-6989586621682170230"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170231"><a href="#local-6989586621682170231"><span class="hs-identifier">avail</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170175"><span class="hs-identifier hs-var">lookup_name</span></a><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170229"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-951"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170228"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replaceWrappedName</span><span> </span><a href="#local-6989586621682170229"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682170230"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-952"></a><span>                                                  </span><span class="hs-identifier hs-var">trimAvail</span><span> </span><a href="#local-6989586621682170231"><span class="hs-identifier hs-var">avail</span></a><span> </span><a href="#local-6989586621682170230"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span>        </span><span class="hs-identifier hs-var">IEThingAll</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170232"><a href="#local-6989586621682170232"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170233"><a href="#local-6989586621682170233"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-955"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682170234"><a href="#local-6989586621682170234"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170235"><a href="#local-6989586621682170235"><span class="hs-identifier">avail</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170236"><a href="#local-6989586621682170236"><span class="hs-identifier">mb_parent</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170175"><span class="hs-identifier hs-var">lookup_name</span></a><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170233"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-956"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170237"><a href="#local-6989586621682170237"><span class="hs-identifier">warns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170235"><span class="hs-identifier hs-var">avail</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-957"></a><span>                          </span><span class="hs-identifier hs-var">Avail</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                     </span><span class="hs-comment">-- e.g. f(..)</span><span>
</span><a name="line-958"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#DodgyImport"><span class="hs-identifier hs-var">DodgyImport</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170233"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">]</span><span>
</span><a name="line-959"></a><span>
</span><a name="line-960"></a><span>                          </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170240"><a href="#local-6989586621682170240"><span class="hs-identifier">subs</span></a></a><span> </span><a name="local-6989586621682170241"><a href="#local-6989586621682170241"><span class="hs-identifier">fs</span></a></a><span>
</span><a name="line-961"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621682170240"><span class="hs-identifier hs-var">subs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170241"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-comment">-- e.g. T(..) where T is a synonym</span><span>
</span><a name="line-962"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#DodgyImport"><span class="hs-identifier hs-var">DodgyImport</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170233"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">]</span><span>
</span><a name="line-963"></a><span>
</span><a name="line-964"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_qual</span><span> </span><a href="#local-6989586621682170169"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- e.g. import M( T(..) )</span><span>
</span><a name="line-965"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#MissingImportList"><span class="hs-identifier hs-var">MissingImportList</span></a><span class="hs-special">]</span><span>
</span><a name="line-966"></a><span>
</span><a name="line-967"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-968"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span>                </span><a name="local-6989586621682170238"><a href="#local-6989586621682170238"><span class="hs-identifier">renamed_ie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IEThingAll</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170232"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replaceWrappedName</span><span> </span><a href="#local-6989586621682170233"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682170234"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>                </span><a name="local-6989586621682170239"><a href="#local-6989586621682170239"><span class="hs-identifier">sub_avails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170235"><span class="hs-identifier hs-var">avail</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-972"></a><span>                               </span><span class="hs-identifier hs-var">Avail</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-973"></a><span>                               </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682170242"><a href="#local-6989586621682170242"><span class="hs-identifier">name2</span></a></a><span> </span><a name="local-6989586621682170243"><a href="#local-6989586621682170243"><span class="hs-identifier">subs</span></a></a><span> </span><a name="local-6989586621682170244"><a href="#local-6989586621682170244"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682170238"><span class="hs-identifier hs-var">renamed_ie</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170242"><span class="hs-identifier hs-var">name2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170243"><span class="hs-identifier hs-var">subs</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170234"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170244"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-974"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170236"><span class="hs-identifier hs-var">mb_parent</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-975"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682170238"><span class="hs-identifier hs-var">renamed_ie</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170235"><span class="hs-identifier hs-var">avail</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170237"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>                             </span><span class="hs-comment">-- non-associated ty/cls</span><span>
</span><a name="line-977"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170245"><a href="#local-6989586621682170245"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682170238"><span class="hs-identifier hs-var">renamed_ie</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170245"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170234"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682170239"><span class="hs-identifier hs-var">sub_avails</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170237"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>                             </span><span class="hs-comment">-- associated type</span><span>
</span><a name="line-979"></a><span>
</span><a name="line-980"></a><span>        </span><span class="hs-identifier hs-var">IEThingAbs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170246"><a href="#local-6989586621682170246"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170247"><a href="#local-6989586621682170247"><span class="hs-identifier">tc'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170170"><span class="hs-identifier hs-var">want_hiding</span></a><span>   </span><span class="hs-comment">-- hiding ( C )</span><span>
</span><a name="line-982"></a><span>                       </span><span class="hs-comment">-- Here the 'C' can be a data constructor</span><span>
</span><a name="line-983"></a><span>                       </span><span class="hs-comment">--  *or* a type/class, or even both</span><span>
</span><a name="line-984"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170248"><a href="#local-6989586621682170248"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170247"><span class="hs-identifier hs-var">tc'</span></a><span>
</span><a name="line-985"></a><span>                   </span><a name="local-6989586621682170249"><a href="#local-6989586621682170249"><span class="hs-identifier">tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170175"><span class="hs-identifier hs-var">lookup_name</span></a><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682170248"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-986"></a><span>                   </span><a name="local-6989586621682170250"><a href="#local-6989586621682170250"><span class="hs-identifier">dc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170175"><span class="hs-identifier hs-var">lookup_name</span></a><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setRdrNameSpace</span><span> </span><a href="#local-6989586621682170248"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-identifier hs-var">srcDataName</span><span class="hs-special">)</span><span>
</span><a name="line-987"></a><span>               </span><span class="hs-keyword">in</span><span>
</span><a name="line-988"></a><span>               </span><span class="hs-keyword">case</span><span> </span><a href="RnNames.html#catIELookupM"><span class="hs-identifier hs-var">catIELookupM</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682170249"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170250"><span class="hs-identifier hs-var">dc_name</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-989"></a><span>                 </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#failLookupWith"><span class="hs-identifier hs-var">failLookupWith</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#BadImport"><span class="hs-identifier hs-var">BadImport</span></a><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>                 </span><a name="local-6989586621682170251"><a href="#local-6989586621682170251"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682170215"><span class="hs-identifier hs-var">mkIEThingAbs</span></a><span> </span><a href="#local-6989586621682170247"><span class="hs-identifier hs-var">tc'</span></a><span> </span><a href="#local-6989586621682170246"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170252"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682170252"><a href="#local-6989586621682170252"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170251"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-991"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-992"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682170253"><a href="#local-6989586621682170253"><span class="hs-identifier">nameAvail</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170175"><span class="hs-identifier hs-var">lookup_name</span></a><span> </span><a href="#local-6989586621682170214"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170247"><span class="hs-identifier hs-var">tc'</span></a><span class="hs-special">)</span><span>
</span><a name="line-993"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682170215"><span class="hs-identifier hs-var">mkIEThingAbs</span></a><span> </span><a href="#local-6989586621682170247"><span class="hs-identifier hs-var">tc'</span></a><span> </span><a href="#local-6989586621682170246"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170253"><span class="hs-identifier hs-var">nameAvail</span></a><span class="hs-special">]</span><span>
</span><a name="line-994"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>
</span><a name="line-996"></a><span>        </span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><a name="local-6989586621682170254"><a href="#local-6989586621682170254"><span class="hs-identifier">xt</span></a></a><span> </span><a name="local-6989586621682170255"><a href="#local-6989586621682170255"><span class="hs-identifier">ltc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170256"><a href="#local-6989586621682170256"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170257"><a href="#local-6989586621682170257"><span class="hs-identifier">rdr_tc</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682170258"><a href="#local-6989586621682170258"><span class="hs-identifier">wc</span></a></a><span> </span><a name="local-6989586621682170259"><a href="#local-6989586621682170259"><span class="hs-identifier">rdr_ns</span></a></a><span> </span><a name="local-6989586621682170260"><a href="#local-6989586621682170260"><span class="hs-identifier">rdr_fs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-997"></a><span>          </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">rdr_fs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">rdr_fs</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-998"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621682170261"><a href="#local-6989586621682170261"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170262"><a href="#local-6989586621682170262"><span class="hs-identifier">avail</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170263"><a href="#local-6989586621682170263"><span class="hs-identifier">mb_parent</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170175"><span class="hs-identifier hs-var">lookup_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingAbs</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682170255"><span class="hs-identifier hs-var">ltc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ieWrappedName</span><span> </span><a href="#local-6989586621682170257"><span class="hs-identifier hs-var">rdr_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170264"><a href="#local-6989586621682170264"><span class="hs-identifier">ns</span></a></a><span class="hs-special">,</span><a name="local-6989586621682170265"><a href="#local-6989586621682170265"><span class="hs-identifier">subflds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170262"><span class="hs-identifier hs-var">avail</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1002"></a><span>                                </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170266"><a href="#local-6989586621682170266"><span class="hs-identifier">ns'</span></a></a><span> </span><a name="local-6989586621682170267"><a href="#local-6989586621682170267"><span class="hs-identifier">subflds'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170266"><span class="hs-identifier hs-var">ns'</span></a><span class="hs-special">,</span><a href="#local-6989586621682170267"><span class="hs-identifier hs-var">subflds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>                                </span><span class="hs-identifier hs-var">Avail</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;filterImports&quot;</span><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span>           </span><span class="hs-comment">-- Look up the children in the sub-names of the parent</span><span>
</span><a name="line-1006"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170268"><a href="#local-6989586621682170268"><span class="hs-identifier">subnames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170264"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- The tc is first in ns,</span><span>
</span><a name="line-1007"></a><span>                            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- if it is there at all</span><span>
</span><a name="line-1008"></a><span>                                       </span><span class="hs-comment">-- See the AvailTC Invariant in Avail.hs</span><span>
</span><a name="line-1009"></a><span>                            </span><span class="hs-special">(</span><a name="local-6989586621682170269"><a href="#local-6989586621682170269"><span class="hs-identifier">n1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682170270"><a href="#local-6989586621682170270"><span class="hs-identifier">ns1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170269"><span class="hs-identifier hs-var">n1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170270"><span class="hs-identifier hs-var">ns1</span></a><span>
</span><a name="line-1010"></a><span>                                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170264"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-1011"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="RnNames.html#lookupChildren"><span class="hs-identifier hs-var">lookupChildren</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621682170268"><span class="hs-identifier hs-var">subnames</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621682170265"><span class="hs-identifier hs-var">subflds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170259"><span class="hs-identifier hs-var">rdr_ns</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span>             </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621682170271"><a href="#local-6989586621682170271"><span class="hs-identifier">rdrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#failLookupWith"><span class="hs-identifier hs-var">failLookupWith</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#BadImport"><span class="hs-identifier hs-var">BadImport</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><a href="#local-6989586621682170254"><span class="hs-identifier hs-var">xt</span></a><span> </span><a href="#local-6989586621682170255"><span class="hs-identifier hs-var">ltc</span></a><span> </span><a href="#local-6989586621682170258"><span class="hs-identifier hs-var">wc</span></a><span> </span><a href="#local-6989586621682170271"><span class="hs-identifier hs-var">rdrs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1014"></a><span>                                </span><span class="hs-comment">-- We are trying to import T( a,b,c,d ), and failed</span><span>
</span><a name="line-1015"></a><span>                                </span><span class="hs-comment">-- to find 'b' and 'd'.  So we make up an import item</span><span>
</span><a name="line-1016"></a><span>                                </span><span class="hs-comment">-- to report as failing, namely T( b, d ).</span><span>
</span><a name="line-1017"></a><span>                                </span><span class="hs-comment">-- c.f. Trac #15412</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span>             </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170272"><a href="#local-6989586621682170272"><span class="hs-identifier">childnames</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170273"><a href="#local-6989586621682170273"><span class="hs-identifier">childflds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1020"></a><span>               </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170263"><span class="hs-identifier hs-var">mb_parent</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1021"></a><span>                 </span><span class="hs-comment">-- non-associated ty/cls</span><span>
</span><a name="line-1022"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1023"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170256"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170274"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170258"><span class="hs-identifier hs-var">wc</span></a><span> </span><a href="#local-6989586621682170275"><span class="hs-identifier hs-var">childnames'</span></a><span>
</span><a name="line-1024"></a><span>                                                                 </span><a href="#local-6989586621682170273"><span class="hs-identifier hs-var">childflds</span></a><span class="hs-special">,</span><span>
</span><a name="line-1025"></a><span>                               </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span class="hs-glyph">:</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170272"><span class="hs-identifier hs-var">childnames</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170273"><span class="hs-identifier hs-var">childflds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1026"></a><span>                              </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>                   </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682170274"><a href="#local-6989586621682170274"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replaceWrappedName</span><span> </span><a href="#local-6989586621682170257"><span class="hs-identifier hs-var">rdr_tc</span></a><span> </span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1028"></a><span>                         </span><a name="local-6989586621682170275"><a href="#local-6989586621682170275"><span class="hs-identifier">childnames'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><a href="#local-6989586621682170272"><span class="hs-identifier hs-var">childnames</span></a><span>
</span><a name="line-1029"></a><span>                         </span><span class="hs-comment">-- childnames' = postrn_ies childnames</span><span>
</span><a name="line-1030"></a><span>                 </span><span class="hs-comment">-- associated ty</span><span>
</span><a name="line-1031"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170276"><a href="#local-6989586621682170276"><span class="hs-identifier">parent</span></a></a><span>
</span><a name="line-1032"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170256"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170277"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170258"><span class="hs-identifier hs-var">wc</span></a><span> </span><a href="#local-6989586621682170278"><span class="hs-identifier hs-var">childnames'</span></a><span>
</span><a name="line-1033"></a><span>                                                           </span><a href="#local-6989586621682170273"><span class="hs-identifier hs-var">childflds</span></a><span class="hs-special">,</span><span>
</span><a name="line-1034"></a><span>                                </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170272"><span class="hs-identifier hs-var">childnames</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682170273"><span class="hs-identifier hs-var">childflds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1035"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170256"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170277"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170258"><span class="hs-identifier hs-var">wc</span></a><span> </span><a href="#local-6989586621682170278"><span class="hs-identifier hs-var">childnames'</span></a><span>
</span><a name="line-1036"></a><span>                                                           </span><a href="#local-6989586621682170273"><span class="hs-identifier hs-var">childflds</span></a><span class="hs-special">,</span><span>
</span><a name="line-1037"></a><span>                                </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170276"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1038"></a><span>                              </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1039"></a><span>                   </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682170277"><a href="#local-6989586621682170277"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replaceWrappedName</span><span> </span><a href="#local-6989586621682170257"><span class="hs-identifier hs-var">rdr_tc</span></a><span> </span><a href="#local-6989586621682170261"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1040"></a><span>                         </span><a name="local-6989586621682170278"><a href="#local-6989586621682170278"><span class="hs-identifier">childnames'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><a href="#local-6989586621682170272"><span class="hs-identifier hs-var">childnames</span></a><span>
</span><a name="line-1041"></a><span>
</span><a name="line-1042"></a><span>        </span><a name="local-6989586621682170279"><a href="#local-6989586621682170279"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#failLookupWith"><span class="hs-identifier hs-var">failLookupWith</span></a><span> </span><a href="RnNames.html#IllegalImport"><span class="hs-identifier hs-var">IllegalImport</span></a><span>
</span><a name="line-1043"></a><span>        </span><span class="hs-comment">-- could be IEModuleContents, IEGroup, IEDoc, IEDocNamed</span><span>
</span><a name="line-1044"></a><span>        </span><span class="hs-comment">-- all errors.</span><span>
</span><a name="line-1045"></a><span>
</span><a name="line-1046"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1047"></a><span>        </span><a name="local-6989586621682170215"><a href="#local-6989586621682170215"><span class="hs-identifier">mkIEThingAbs</span></a></a><span> </span><a name="local-6989586621682170217"><a href="#local-6989586621682170217"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682170218"><a href="#local-6989586621682170218"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682170219"><a href="#local-6989586621682170219"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170220"><a href="#local-6989586621682170220"><span class="hs-identifier">av</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-1048"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingAbs</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170218"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replaceWrappedName</span><span> </span><a href="#local-6989586621682170217"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682170219"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">trimAvail</span><span> </span><a href="#local-6989586621682170220"><span class="hs-identifier hs-var">av</span></a><span> </span><a href="#local-6989586621682170219"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1049"></a><span>        </span><span class="hs-identifier">mkIEThingAbs</span><span> </span><a name="local-6989586621682170221"><a href="#local-6989586621682170221"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682170222"><a href="#local-6989586621682170222"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682170223"><a href="#local-6989586621682170223"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170224"><a href="#local-6989586621682170224"><span class="hs-identifier">parent</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1050"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingAbs</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170222"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replaceWrappedName</span><span> </span><a href="#local-6989586621682170221"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682170223"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682170224"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170223"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span>        </span><a name="local-6989586621682170216"><a href="#local-6989586621682170216"><span class="hs-identifier">handle_bad_import</span></a></a><span> </span><a name="local-6989586621682170225"><a href="#local-6989586621682170225"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#catchIELookup"><span class="hs-identifier hs-var">catchIELookup</span></a><span> </span><a href="#local-6989586621682170225"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682170226"><a href="#local-6989586621682170226"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170226"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1054"></a><span>          </span><a href="RnNames.html#BadImport"><span class="hs-identifier hs-var">BadImport</span></a><span> </span><a name="local-6989586621682170227"><a href="#local-6989586621682170227"><span class="hs-identifier">ie</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170170"><span class="hs-identifier hs-var">want_hiding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#BadImportW"><span class="hs-identifier hs-var">BadImportW</span></a><span> </span><a href="#local-6989586621682170227"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1055"></a><span>          </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#failLookupWith"><span class="hs-identifier hs-var">failLookupWith</span></a><span> </span><a href="#local-6989586621682170226"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1056"></a><span>
</span><a name="line-1057"></a><span class="hs-keyword">type</span><span> </span><a name="IELookupM"><a href="RnNames.html#IELookupM"><span class="hs-identifier">IELookupM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><a href="RnNames.html#IELookupError"><span class="hs-identifier hs-type">IELookupError</span></a><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span class="hs-keyword">data</span><span> </span><a name="IELookupWarning"><a href="RnNames.html#IELookupWarning"><span class="hs-identifier">IELookupWarning</span></a></a><span>
</span><a name="line-1060"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="BadImportW"><a href="RnNames.html#BadImportW"><span class="hs-identifier">BadImportW</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1061"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="MissingImportList"><a href="RnNames.html#MissingImportList"><span class="hs-identifier">MissingImportList</span></a></a><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DodgyImport"><a href="RnNames.html#DodgyImport"><span class="hs-identifier">DodgyImport</span></a></a><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-1063"></a><span>  </span><span class="hs-comment">-- NB. use the RdrName for reporting a &quot;dodgy&quot; import</span><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span class="hs-keyword">data</span><span> </span><a name="IELookupError"><a href="RnNames.html#IELookupError"><span class="hs-identifier">IELookupError</span></a></a><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="QualImportError"><a href="RnNames.html#QualImportError"><span class="hs-identifier">QualImportError</span></a></a><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-1067"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="BadImport"><a href="RnNames.html#BadImport"><span class="hs-identifier">BadImport</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1068"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IllegalImport"><a href="RnNames.html#IllegalImport"><span class="hs-identifier">IllegalImport</span></a></a><span>
</span><a name="line-1069"></a><span>
</span><a name="line-1070"></a><span class="hs-identifier">failLookupWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnNames.html#IELookupError"><span class="hs-identifier hs-type">IELookupError</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><a href="#local-6989586621682169948"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1071"></a><a name="failLookupWith"><a href="RnNames.html#failLookupWith"><span class="hs-identifier">failLookupWith</span></a></a><span> </span><a name="local-6989586621682170288"><a href="#local-6989586621682170288"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621682170288"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1072"></a><span>
</span><a name="line-1073"></a><span class="hs-identifier">catchIELookup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><a href="#local-6989586621682169947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#IELookupError"><span class="hs-identifier hs-type">IELookupError</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><a href="#local-6989586621682169947"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><a href="#local-6989586621682169947"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1074"></a><a name="catchIELookup"><a href="RnNames.html#catchIELookup"><span class="hs-identifier">catchIELookup</span></a></a><span> </span><a name="local-6989586621682170289"><a href="#local-6989586621682170289"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682170290"><a href="#local-6989586621682170290"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170289"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621682170291"><a href="#local-6989586621682170291"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682170291"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1076"></a><span>  </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621682170292"><a href="#local-6989586621682170292"><span class="hs-identifier">err</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170290"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621682170292"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span class="hs-identifier">catIELookupM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#IELookupM"><span class="hs-identifier hs-type">IELookupM</span></a><span> </span><a href="#local-6989586621682169946"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682169946"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1079"></a><a name="catIELookupM"><a href="RnNames.html#catIELookupM"><span class="hs-identifier">catIELookupM</span></a></a><span> </span><a name="local-6989586621682170293"><a href="#local-6989586621682170293"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682170294"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621682170294"><a href="#local-6989586621682170294"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170293"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1080"></a><span>
</span><a name="line-1081"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Import/Export Utils}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-comment">-- | Given an import\/export spec, construct the appropriate 'GlobalRdrElt's.</span><span>
</span><a name="line-1090"></a><span class="hs-identifier">gresFromIE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImpDeclSpec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1091"></a><a name="gresFromIE"><a href="RnNames.html#gresFromIE"><span class="hs-identifier">gresFromIE</span></a></a><span> </span><a name="local-6989586621682170295"><a href="#local-6989586621682170295"><span class="hs-identifier">decl_spec</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170296"><a href="#local-6989586621682170296"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682170297"><a href="#local-6989586621682170297"><span class="hs-identifier">ie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170298"><a href="#local-6989586621682170298"><span class="hs-identifier">avail</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gresFromAvail</span><span> </span><a href="#local-6989586621682170300"><span class="hs-identifier hs-var">prov_fn</span></a><span> </span><a href="#local-6989586621682170298"><span class="hs-identifier hs-var">avail</span></a><span>
</span><a name="line-1093"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1094"></a><span>    </span><a name="local-6989586621682170299"><a href="#local-6989586621682170299"><span class="hs-identifier">is_explicit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170297"><span class="hs-identifier hs-var">ie</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1095"></a><span>                    </span><span class="hs-identifier hs-var">IEThingAll</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170301"><a href="#local-6989586621682170301"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682170302"><a href="#local-6989586621682170302"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170302"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">lieWrappedName</span><span> </span><a href="#local-6989586621682170301"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1096"></a><span>                    </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1097"></a><span>    </span><a name="local-6989586621682170300"><a href="#local-6989586621682170300"><span class="hs-identifier">prov_fn</span></a></a><span> </span><a name="local-6989586621682170303"><a href="#local-6989586621682170303"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1098"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImpSpec</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_decl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170295"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_item</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170304"><span class="hs-identifier hs-var">item_spec</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1100"></a><span>        </span><a name="local-6989586621682170304"><a href="#local-6989586621682170304"><span class="hs-identifier">item_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ImpSome</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170299"><span class="hs-identifier hs-var">is_explicit</span></a><span> </span><a href="#local-6989586621682170303"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_iloc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170296"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span>
</span><a name="line-1103"></a><span class="hs-comment">{-
Note [Children for duplicate record fields]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the module

    {-# LANGUAGE DuplicateRecordFields #-}
    module M (F(foo, MkFInt, MkFBool)) where
      data family F a
      data instance F Int = MkFInt { foo :: Int }
      data instance F Bool = MkFBool { foo :: Bool }

The `foo` in the export list refers to *both* selectors! For this
reason, lookupChildren builds an environment that maps the FastString
to a list of items, rather than a single item.
-}</span><span>
</span><a name="line-1118"></a><span>
</span><a name="line-1119"></a><span class="hs-identifier">mkChildEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1120"></a><a name="mkChildEnv"><a href="RnNames.html#mkChildEnv"><span class="hs-identifier">mkChildEnv</span></a></a><span> </span><a name="local-6989586621682170305"><a href="#local-6989586621682170305"><span class="hs-identifier">gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682170306"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><a href="#local-6989586621682170305"><span class="hs-identifier hs-var">gres</span></a><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1122"></a><span>    </span><a name="local-6989586621682170306"><a href="#local-6989586621682170306"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682170307"><a href="#local-6989586621682170307"><span class="hs-identifier">gre</span></a></a><span> </span><a name="local-6989586621682170308"><a href="#local-6989586621682170308"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">gre_par</span><span> </span><a href="#local-6989586621682170307"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1123"></a><span>        </span><span class="hs-identifier hs-var">FldParent</span><span> </span><a name="local-6989586621682170309"><a href="#local-6989586621682170309"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendNameEnv_Acc</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621682170308"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682170309"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621682170307"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-1124"></a><span>        </span><span class="hs-identifier hs-var">ParentIs</span><span>  </span><a name="local-6989586621682170310"><a href="#local-6989586621682170310"><span class="hs-identifier">p</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendNameEnv_Acc</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621682170308"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682170310"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621682170307"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-1125"></a><span>        </span><span class="hs-identifier hs-var">NoParent</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170308"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span class="hs-identifier">findChildren</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682169945"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682169945"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1128"></a><a name="findChildren"><a href="RnNames.html#findChildren"><span class="hs-identifier">findChildren</span></a></a><span> </span><a name="local-6989586621682170311"><a href="#local-6989586621682170311"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682170312"><a href="#local-6989586621682170312"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621682170311"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682170312"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1129"></a><span>
</span><a name="line-1130"></a><span class="hs-identifier">lookupChildren</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LIEWrappedName</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span>
</span><a name="line-1131"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LIEWrappedName</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- The ones for which the lookup failed</span><span>
</span><a name="line-1132"></a><span>                           </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1133"></a><span class="hs-comment">-- (lookupChildren all_kids rdr_items) maps each rdr_item to its</span><span>
</span><a name="line-1134"></a><span class="hs-comment">-- corresponding Name all_kids, if the former exists</span><span>
</span><a name="line-1135"></a><span class="hs-comment">-- The matching is done by FastString, not OccName, so that</span><span>
</span><a name="line-1136"></a><span class="hs-comment">--    Cls( meth, AssocTy )</span><span>
</span><a name="line-1137"></a><span class="hs-comment">-- will correctly find AssocTy among the all_kids of Cls, even though</span><span>
</span><a name="line-1138"></a><span class="hs-comment">-- the RdrName for AssocTy may have a (bogus) DataName namespace</span><span>
</span><a name="line-1139"></a><span class="hs-comment">-- (Really the rdr_items should be FastStrings in the first place.)</span><span>
</span><a name="line-1140"></a><a name="lookupChildren"><a href="RnNames.html#lookupChildren"><span class="hs-identifier">lookupChildren</span></a></a><span> </span><a name="local-6989586621682170313"><a href="#local-6989586621682170313"><span class="hs-identifier">all_kids</span></a></a><span> </span><a name="local-6989586621682170314"><a href="#local-6989586621682170314"><span class="hs-identifier">rdr_items</span></a></a><span>
</span><a name="line-1141"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170316"><span class="hs-identifier hs-var">fails</span></a><span>
</span><a name="line-1142"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><a href="#local-6989586621682170317"><span class="hs-identifier hs-var">oks</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1143"></a><span>       </span><span class="hs-comment">-- This 'fmap concat' trickily applies concat to the /second/ component</span><span>
</span><a name="line-1144"></a><span>       </span><span class="hs-comment">-- of the pair, whose type is ([Located Name], [[Located FieldLabel]])</span><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621682170316"><span class="hs-identifier hs-var">fails</span></a><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1148"></a><span>    </span><a name="local-6989586621682170315"><a href="#local-6989586621682170315"><span class="hs-identifier">mb_xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682170318"><span class="hs-identifier hs-var">doOne</span></a><span> </span><a href="#local-6989586621682170314"><span class="hs-identifier hs-var">rdr_items</span></a><span>
</span><a name="line-1149"></a><span>    </span><a name="local-6989586621682170316"><a href="#local-6989586621682170316"><span class="hs-identifier">fails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682170320"><span class="hs-identifier hs-var">bad_rdr</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621682170320"><a href="#local-6989586621682170320"><span class="hs-identifier">bad_rdr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170315"><span class="hs-identifier hs-var">mb_xs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1150"></a><span>    </span><a name="local-6989586621682170317"><a href="#local-6989586621682170317"><span class="hs-identifier">oks</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682170321"><span class="hs-identifier hs-var">ok</span></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621682170321"><a href="#local-6989586621682170321"><span class="hs-identifier">ok</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170315"><span class="hs-identifier hs-var">mb_xs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1151"></a><span>    </span><span class="hs-identifier">oks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span>    </span><a name="local-6989586621682170318"><a href="#local-6989586621682170318"><span class="hs-identifier">doOne</span></a></a><span> </span><a name="local-6989586621682170322"><a href="#local-6989586621682170322"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170323"><a href="#local-6989586621682170323"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170324"><a href="#local-6989586621682170324"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupFsEnv</span><span> </span><a href="#local-6989586621682170319"><span class="hs-identifier hs-var">kid_env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ieWrappedName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170324"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1155"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682170325"><a href="#local-6989586621682170325"><span class="hs-identifier">n</span></a></a><span class="hs-special">]</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170323"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170325"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170326"><a href="#local-6989586621682170326"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isRight</span><span> </span><a href="#local-6989586621682170326"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170323"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rights</span><span> </span><a href="#local-6989586621682170326"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1157"></a><span>           </span><span class="hs-identifier">_</span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Failed</span><span>    </span><a href="#local-6989586621682170322"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>    </span><span class="hs-comment">-- See Note [Children for duplicate record fields]</span><span>
</span><a name="line-1160"></a><span>    </span><a name="local-6989586621682170319"><a href="#local-6989586621682170319"><span class="hs-identifier">kid_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendFsEnvList_C</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyFsEnv</span><span>
</span><a name="line-1161"></a><span>              </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621682170327"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170327"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682170327"><a href="#local-6989586621682170327"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682170313"><span class="hs-identifier hs-var">all_kids</span></a><span class="hs-special">]</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span>
</span><a name="line-1164"></a><span>
</span><a name="line-1165"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
\subsection{Unused names}
*                                                       *
*********************************************************
-}</span><span>
</span><a name="line-1174"></a><span>
</span><a name="line-1175"></a><span class="hs-identifier">reportUnusedNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Export list</span><span>
</span><a name="line-1176"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1177"></a><a name="reportUnusedNames"><a href="RnNames.html#reportUnusedNames"><span class="hs-identifier">reportUnusedNames</span></a></a><span> </span><a name="local-6989586621682170328"><a href="#local-6989586621682170328"><span class="hs-identifier">_export_decls</span></a></a><span> </span><a name="local-6989586621682170329"><a href="#local-6989586621682170329"><span class="hs-identifier">gbl_env</span></a></a><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;RUN&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621682170329"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1179"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnNames.html#warnUnusedImportDecls"><span class="hs-identifier hs-var">warnUnusedImportDecls</span></a><span> </span><a href="#local-6989586621682170329"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-1180"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#warnUnusedTopBinds"><span class="hs-identifier hs-var">warnUnusedTopBinds</span></a><span> </span><a href="#local-6989586621682170336"><span class="hs-identifier hs-var">unused_locals</span></a><span>
</span><a name="line-1181"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnNames.html#warnMissingSignatures"><span class="hs-identifier hs-var">warnMissingSignatures</span></a><span> </span><a href="#local-6989586621682170329"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1183"></a><span>    </span><span class="hs-identifier">used_names</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1184"></a><span>    </span><a name="local-6989586621682170330"><a href="#local-6989586621682170330"><span class="hs-identifier">used_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findUses</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621682170329"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span>
</span><a name="line-1185"></a><span>    </span><span class="hs-comment">-- NB: currently, if f x = g, we only treat 'g' as used if 'f' is used</span><span>
</span><a name="line-1186"></a><span>    </span><span class="hs-comment">-- Hence findUses</span><span>
</span><a name="line-1187"></a><span>
</span><a name="line-1188"></a><span>    </span><span class="hs-comment">-- Collect the defined names from the in-scope environment</span><span>
</span><a name="line-1189"></a><span>    </span><span class="hs-identifier">defined_names</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1190"></a><span>    </span><a name="local-6989586621682170331"><a href="#local-6989586621682170331"><span class="hs-identifier">defined_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621682170329"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span>    </span><span class="hs-comment">-- Note that defined_and_used, defined_but_not_used</span><span>
</span><a name="line-1193"></a><span>    </span><span class="hs-comment">-- are both [GRE]; that's why we need defined_and_used</span><span>
</span><a name="line-1194"></a><span>    </span><span class="hs-comment">-- rather than just used_names</span><span>
</span><a name="line-1195"></a><span>    </span><span class="hs-identifier">_defined_and_used</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">defined_but_not_used</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1196"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682170332"><a href="#local-6989586621682170332"><span class="hs-identifier">_defined_and_used</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170333"><a href="#local-6989586621682170333"><span class="hs-identifier">defined_but_not_used</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1197"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170335"><span class="hs-identifier hs-var">gre_is_used</span></a><span> </span><a href="#local-6989586621682170330"><span class="hs-identifier hs-var">used_names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170331"><span class="hs-identifier hs-var">defined_names</span></a><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span>    </span><a name="local-6989586621682170334"><a href="#local-6989586621682170334"><span class="hs-identifier">kids_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#mkChildEnv"><span class="hs-identifier hs-var">mkChildEnv</span></a><span> </span><a href="#local-6989586621682170331"><span class="hs-identifier hs-var">defined_names</span></a><span>
</span><a name="line-1200"></a><span>    </span><span class="hs-comment">-- This is done in mkExports too; duplicated work</span><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span>    </span><span class="hs-identifier">gre_is_used</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1203"></a><span>    </span><a name="local-6989586621682170335"><a href="#local-6989586621682170335"><span class="hs-identifier">gre_is_used</span></a></a><span> </span><a name="local-6989586621682170338"><a href="#local-6989586621682170338"><span class="hs-identifier">used_names</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRE</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">gre_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170339"><a href="#local-6989586621682170339"><span class="hs-identifier">name</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1204"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170339"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170338"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-1205"></a><span>          </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682170340"><a href="#local-6989586621682170340"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682170340"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170338"><span class="hs-identifier hs-var">used_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#findChildren"><span class="hs-identifier hs-var">findChildren</span></a><span> </span><a href="#local-6989586621682170334"><span class="hs-identifier hs-var">kids_env</span></a><span> </span><a href="#local-6989586621682170339"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1206"></a><span>                </span><span class="hs-comment">-- A use of C implies a use of T,</span><span>
</span><a name="line-1207"></a><span>                </span><span class="hs-comment">-- if C was brought into scope by T(..) or T(C)</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span>    </span><span class="hs-comment">-- Filter out the ones that are</span><span>
</span><a name="line-1210"></a><span>    </span><span class="hs-comment">--  (a) defined in this module, and</span><span>
</span><a name="line-1211"></a><span>    </span><span class="hs-comment">--  (b) not defined by a 'deriving' clause</span><span>
</span><a name="line-1212"></a><span>    </span><span class="hs-comment">-- The latter have an Internal Name, so we can filter them out easily</span><span>
</span><a name="line-1213"></a><span>    </span><span class="hs-identifier">unused_locals</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1214"></a><span>    </span><a name="local-6989586621682170336"><a href="#local-6989586621682170336"><span class="hs-identifier">unused_locals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621682170337"><span class="hs-identifier hs-var">is_unused_local</span></a><span> </span><a href="#local-6989586621682170333"><span class="hs-identifier hs-var">defined_but_not_used</span></a><span>
</span><a name="line-1215"></a><span>    </span><span class="hs-identifier">is_unused_local</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1216"></a><span>    </span><a name="local-6989586621682170337"><a href="#local-6989586621682170337"><span class="hs-identifier">is_unused_local</span></a></a><span> </span><a name="local-6989586621682170341"><a href="#local-6989586621682170341"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isLocalGRE</span><span> </span><a href="#local-6989586621682170341"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682170341"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
              Missing signatures
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span class="hs-comment">-- | Warn the user about top level binders that lack type signatures.</span><span>
</span><a name="line-1225"></a><span class="hs-comment">-- Called /after/ type inference, so that we can report the</span><span>
</span><a name="line-1226"></a><span class="hs-comment">-- inferred type of the function</span><span>
</span><a name="line-1227"></a><span class="hs-identifier">warnMissingSignatures</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><a name="warnMissingSignatures"><a href="RnNames.html#warnMissingSignatures"><span class="hs-identifier">warnMissingSignatures</span></a></a><span> </span><a name="local-6989586621682170342"><a href="#local-6989586621682170342"><span class="hs-identifier">gbl_env</span></a></a><span>
</span><a name="line-1229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170343"><a href="#local-6989586621682170343"><span class="hs-identifier">exports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">availsToNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_exports</span><span> </span><a href="#local-6989586621682170342"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1230"></a><span>             </span><a name="local-6989586621682170344"><a href="#local-6989586621682170344"><span class="hs-identifier">sig_ns</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_sigs</span><span> </span><a href="#local-6989586621682170342"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-1231"></a><span>               </span><span class="hs-comment">-- We use sig_ns to exclude top-level bindings that are generated by GHC</span><span>
</span><a name="line-1232"></a><span>             </span><a name="local-6989586621682170345"><a href="#local-6989586621682170345"><span class="hs-identifier">binds</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectHsBindsBinders</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tcg_binds</span><span> </span><a href="#local-6989586621682170342"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-1233"></a><span>             </span><a name="local-6989586621682170346"><a href="#local-6989586621682170346"><span class="hs-identifier">pat_syns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_patsyns</span><span> </span><a href="#local-6989586621682170342"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span>         </span><span class="hs-comment">-- Warn about missing signatures</span><span>
</span><a name="line-1236"></a><span>         </span><span class="hs-comment">-- Do this only when we have a type to offer</span><span>
</span><a name="line-1237"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170347"><a href="#local-6989586621682170347"><span class="hs-identifier">warn_missing_sigs</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingSignatures</span><span>
</span><a name="line-1238"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170348"><a href="#local-6989586621682170348"><span class="hs-identifier">warn_only_exported</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingExportedSignatures</span><span>
</span><a name="line-1239"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170349"><a href="#local-6989586621682170349"><span class="hs-identifier">warn_pat_syns</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingPatternSynonymSignatures</span><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170350"><a href="#local-6989586621682170350"><span class="hs-identifier">add_sig_warns</span></a></a><span>
</span><a name="line-1242"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170348"><span class="hs-identifier hs-var">warn_only_exported</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170351"><span class="hs-identifier hs-var">add_warns</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingExportedSignatures</span><span>
</span><a name="line-1243"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170347"><span class="hs-identifier hs-var">warn_missing_sigs</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170351"><span class="hs-identifier hs-var">add_warns</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingSignatures</span><span>
</span><a name="line-1244"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170349"><span class="hs-identifier hs-var">warn_pat_syns</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170351"><span class="hs-identifier hs-var">add_warns</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingPatternSynonymSignatures</span><span>
</span><a name="line-1245"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1246"></a><span>
</span><a name="line-1247"></a><span>             </span><a name="local-6989586621682170351"><a href="#local-6989586621682170351"><span class="hs-identifier">add_warns</span></a></a><span> </span><a name="local-6989586621682170352"><a href="#local-6989586621682170352"><span class="hs-identifier">flag</span></a></a><span>
</span><a name="line-1248"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621682170349"><span class="hs-identifier hs-var">warn_pat_syns</span></a><span>
</span><a name="line-1249"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682170353"><span class="hs-identifier hs-var">add_pat_syn_warn</span></a><span> </span><a href="#local-6989586621682170346"><span class="hs-identifier hs-var">pat_syns</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-1250"></a><span>                  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170347"><span class="hs-identifier hs-var">warn_missing_sigs</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682170348"><span class="hs-identifier hs-var">warn_only_exported</span></a><span class="hs-special">)</span><span>
</span><a name="line-1251"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621682170354"><span class="hs-identifier hs-var">add_bind_warn</span></a><span> </span><a href="#local-6989586621682170345"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-1253"></a><span>                  </span><a name="local-6989586621682170353"><a href="#local-6989586621682170353"><span class="hs-identifier">add_pat_syn_warn</span></a></a><span> </span><a name="local-6989586621682170357"><a href="#local-6989586621682170357"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-1254"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170355"><span class="hs-identifier hs-var">add_warn</span></a><span> </span><a href="#local-6989586621682170358"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1255"></a><span>                      </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Pattern synonym with no type signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1256"></a><span>                         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;pattern&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprPrefixName</span><span> </span><a href="#local-6989586621682170358"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170359"><span class="hs-identifier hs-var">pp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span>                    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1258"></a><span>                      </span><a name="local-6989586621682170358"><a href="#local-6989586621682170358"><span class="hs-identifier">name</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">patSynName</span><span> </span><a href="#local-6989586621682170357"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1259"></a><span>                      </span><a name="local-6989586621682170359"><a href="#local-6989586621682170359"><span class="hs-identifier">pp_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPatSynType</span><span> </span><a href="#local-6989586621682170357"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1260"></a><span>
</span><a name="line-1261"></a><span>                  </span><span class="hs-identifier">add_bind_warn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IOEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Env</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1262"></a><span>                  </span><a name="local-6989586621682170354"><a href="#local-6989586621682170354"><span class="hs-identifier">add_bind_warn</span></a></a><span> </span><a name="local-6989586621682170360"><a href="#local-6989586621682170360"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1263"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170361"><a href="#local-6989586621682170361"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>     </span><span class="hs-comment">-- Why not use emptyTidyEnv?</span><span>
</span><a name="line-1264"></a><span>                         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170362"><a href="#local-6989586621682170362"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621682170360"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1265"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682170363"><a href="#local-6989586621682170363"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyOpenType</span><span> </span><a href="#local-6989586621682170361"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682170360"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>                               </span><a name="local-6989586621682170364"><a href="#local-6989586621682170364"><span class="hs-identifier">ty_msg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprSigmaType</span><span> </span><a href="#local-6989586621682170363"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1267"></a><span>                         </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682170355"><span class="hs-identifier hs-var">add_warn</span></a><span> </span><a href="#local-6989586621682170362"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1268"></a><span>                           </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Top-level binding with no type signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1269"></a><span>                              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprPrefixName</span><span> </span><a href="#local-6989586621682170362"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170364"><span class="hs-identifier hs-var">ty_msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1270"></a><span>
</span><a name="line-1271"></a><span>                  </span><a name="local-6989586621682170355"><a href="#local-6989586621682170355"><span class="hs-identifier">add_warn</span></a></a><span> </span><a name="local-6989586621682170365"><a href="#local-6989586621682170365"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682170366"><a href="#local-6989586621682170366"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1272"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170365"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170344"><span class="hs-identifier hs-var">sig_ns</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682170356"><span class="hs-identifier hs-var">export_check</span></a><span> </span><a href="#local-6989586621682170365"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>                           </span><span class="hs-special">(</span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682170352"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621682170365"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170366"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>
</span><a name="line-1275"></a><span>                  </span><a name="local-6989586621682170356"><a href="#local-6989586621682170356"><span class="hs-identifier">export_check</span></a></a><span> </span><a name="local-6989586621682170367"><a href="#local-6989586621682170367"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1276"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682170348"><span class="hs-identifier hs-var">warn_only_exported</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682170367"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170343"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-1277"></a><span>
</span><a name="line-1278"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682170350"><span class="hs-identifier hs-var">add_sig_warns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span>
</span><a name="line-1281"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
\subsection{Unused imports}
*                                                       *
*********************************************************

This code finds which import declarations are unused.  The
specification and implementation notes are here:
  http://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/UnusedImports

See also Note [Choosing the best import declaration] in RdrName
-}</span><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-keyword">type</span><span> </span><a name="ImportDeclUsage"><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier">ImportDeclUsage</span></a></a><span>
</span><a name="line-1296"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>   </span><span class="hs-comment">-- The import declaration</span><span>
</span><a name="line-1297"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- What *is* used (normalised)</span><span>
</span><a name="line-1298"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- What is imported but *not* used</span><span>
</span><a name="line-1299"></a><span>
</span><a name="line-1300"></a><span class="hs-identifier">warnUnusedImportDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1301"></a><a name="warnUnusedImportDecls"><a href="RnNames.html#warnUnusedImportDecls"><span class="hs-identifier">warnUnusedImportDecls</span></a></a><span> </span><a name="local-6989586621682170368"><a href="#local-6989586621682170368"><span class="hs-identifier">gbl_env</span></a></a><span>
</span><a name="line-1302"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170369"><a href="#local-6989586621682170369"><span class="hs-identifier">uses</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_used_gres</span><span> </span><a href="#local-6989586621682170368"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170370"><a href="#local-6989586621682170370"><span class="hs-identifier">user_imports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span>
</span><a name="line-1304"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier">ideclImplicit</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span>
</span><a name="line-1305"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rn_imports</span><span> </span><a href="#local-6989586621682170368"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1306"></a><span>                </span><span class="hs-comment">-- This whole function deals only with *user* imports</span><span>
</span><a name="line-1307"></a><span>                </span><span class="hs-comment">-- both for warning about unnecessary ones, and for</span><span>
</span><a name="line-1308"></a><span>                </span><span class="hs-comment">-- deciding the minimal ones</span><span>
</span><a name="line-1309"></a><span>             </span><a name="local-6989586621682170371"><a href="#local-6989586621682170371"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621682170368"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-1310"></a><span>             </span><a name="local-6989586621682170372"><a href="#local-6989586621682170372"><span class="hs-identifier">fld_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#mkFieldEnv"><span class="hs-identifier hs-var">mkFieldEnv</span></a><span> </span><a href="#local-6989586621682170371"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">usage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier hs-type">ImportDeclUsage</span></a><span class="hs-special">]</span><span>
</span><a name="line-1313"></a><span>             </span><a name="local-6989586621682170373"><a href="#local-6989586621682170373"><span class="hs-identifier">usage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#findImportUsage"><span class="hs-identifier hs-var">findImportUsage</span></a><span> </span><a href="#local-6989586621682170370"><span class="hs-identifier hs-var">user_imports</span></a><span> </span><a href="#local-6989586621682170369"><span class="hs-identifier hs-var">uses</span></a><span>
</span><a name="line-1314"></a><span>
</span><a name="line-1315"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;warnUnusedImportDecls&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1316"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Uses:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170369"><span class="hs-identifier hs-var">uses</span></a><span>
</span><a name="line-1317"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Import usage&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170373"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1318"></a><span>
</span><a name="line-1319"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnUnusedImports</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1320"></a><span>         </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#warnUnusedImport"><span class="hs-identifier hs-var">warnUnusedImport</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnUnusedImports</span><span> </span><a href="#local-6989586621682170372"><span class="hs-identifier hs-var">fld_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170373"><span class="hs-identifier hs-var">usage</span></a><span>
</span><a name="line-1321"></a><span>
</span><a name="line-1322"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#whenGOptM"><span class="hs-identifier hs-var">whenGOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_minimal_imports</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1323"></a><span>         </span><a href="RnNames.html#printMinimalImports"><span class="hs-identifier hs-var">printMinimalImports</span></a><span> </span><a href="#local-6989586621682170373"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span class="hs-identifier">findImportUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1326"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1327"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier hs-type">ImportDeclUsage</span></a><span class="hs-special">]</span><span>
</span><a name="line-1328"></a><span>
</span><a name="line-1329"></a><a name="findImportUsage"><a href="RnNames.html#findImportUsage"><span class="hs-identifier">findImportUsage</span></a></a><span> </span><a name="local-6989586621682170374"><a href="#local-6989586621682170374"><span class="hs-identifier">imports</span></a></a><span> </span><a name="local-6989586621682170375"><a href="#local-6989586621682170375"><span class="hs-identifier">used_gres</span></a></a><span>
</span><a name="line-1330"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682170377"><span class="hs-identifier hs-var">unused_decl</span></a><span> </span><a href="#local-6989586621682170374"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-1331"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1332"></a><span>    </span><span class="hs-identifier">import_usage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnNames.html#ImportMap"><span class="hs-identifier hs-type">ImportMap</span></a><span>
</span><a name="line-1333"></a><span>    </span><a name="local-6989586621682170376"><a href="#local-6989586621682170376"><span class="hs-identifier">import_usage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#mkImportMap"><span class="hs-identifier hs-var">mkImportMap</span></a><span> </span><a href="#local-6989586621682170375"><span class="hs-identifier hs-var">used_gres</span></a><span>
</span><a name="line-1334"></a><span>
</span><a name="line-1335"></a><span>    </span><a name="local-6989586621682170377"><a href="#local-6989586621682170377"><span class="hs-identifier">unused_decl</span></a></a><span> </span><a name="local-6989586621682170378"><a href="#local-6989586621682170378"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170379"><a href="#local-6989586621682170379"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170380"><a href="#local-6989586621682170380"><span class="hs-identifier">imps</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1336"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170378"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170381"><span class="hs-identifier hs-var">used_gres</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><a href="#local-6989586621682170384"><span class="hs-identifier hs-var">unused_imps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1337"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1338"></a><span>        </span><a name="local-6989586621682170381"><a href="#local-6989586621682170381"><span class="hs-identifier">used_gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanEnd</span><span> </span><a href="#local-6989586621682170379"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170376"><span class="hs-identifier hs-var">import_usage</span></a><span>
</span><a name="line-1339"></a><span>                               </span><span class="hs-comment">-- srcSpanEnd: see Note [The ImportMap]</span><span>
</span><a name="line-1340"></a><span>                    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1341"></a><span>
</span><a name="line-1342"></a><span>        </span><a name="local-6989586621682170382"><a href="#local-6989586621682170382"><span class="hs-identifier">used_names</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span>      </span><span class="hs-identifier">gre_name</span><span>        </span><a href="#local-6989586621682170381"><span class="hs-identifier hs-var">used_gres</span></a><span class="hs-special">)</span><span>
</span><a name="line-1343"></a><span>        </span><a name="local-6989586621682170383"><a href="#local-6989586621682170383"><span class="hs-identifier">used_parents</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-identifier hs-var">greParent_maybe</span><span> </span><a href="#local-6989586621682170381"><span class="hs-identifier hs-var">used_gres</span></a><span class="hs-special">)</span><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span>        </span><a name="local-6989586621682170384"><a href="#local-6989586621682170384"><span class="hs-identifier">unused_imps</span></a></a><span>   </span><span class="hs-comment">-- Not trivial; see eg Trac #7454</span><span>
</span><a name="line-1346"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170380"><span class="hs-identifier hs-var">imps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1347"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170389"><a href="#local-6989586621682170389"><span class="hs-identifier">imp_ies</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1348"></a><span>                                 </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170385"><span class="hs-identifier hs-var">add_unused</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><a href="#local-6989586621682170389"><span class="hs-identifier hs-var">imp_ies</span></a><span>
</span><a name="line-1349"></a><span>              </span><a name="local-6989586621682170390"><a href="#local-6989586621682170390"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-comment">-- No explicit import list =&gt; no unused-name list</span><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><span>        </span><span class="hs-identifier">add_unused</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1352"></a><span>        </span><a name="local-6989586621682170385"><a href="#local-6989586621682170385"><span class="hs-identifier">add_unused</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170391"><a href="#local-6989586621682170391"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>      </span><a name="local-6989586621682170392"><a href="#local-6989586621682170392"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170386"><span class="hs-identifier hs-var">add_unused_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lieWrappedName</span><span> </span><a href="#local-6989586621682170391"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170392"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1353"></a><span>        </span><span class="hs-identifier">add_unused</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingAbs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170393"><a href="#local-6989586621682170393"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682170394"><a href="#local-6989586621682170394"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170386"><span class="hs-identifier hs-var">add_unused_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lieWrappedName</span><span> </span><a href="#local-6989586621682170393"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170394"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1354"></a><span>        </span><span class="hs-identifier">add_unused</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingAll</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170395"><a href="#local-6989586621682170395"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682170396"><a href="#local-6989586621682170396"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170387"><span class="hs-identifier hs-var">add_unused_all</span></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lieWrappedName</span><span> </span><a href="#local-6989586621682170395"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170396"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1355"></a><span>        </span><span class="hs-identifier">add_unused</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170397"><a href="#local-6989586621682170397"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621682170398"><a href="#local-6989586621682170398"><span class="hs-identifier">wc</span></a></a><span> </span><a name="local-6989586621682170399"><a href="#local-6989586621682170399"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-6989586621682170400"><a href="#local-6989586621682170400"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682170401"><a href="#local-6989586621682170401"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1356"></a><span>          </span><a href="#local-6989586621682170404"><span class="hs-identifier hs-var">add_wc_all</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170388"><span class="hs-identifier hs-var">add_unused_with</span></a><span> </span><a href="#local-6989586621682170402"><span class="hs-identifier hs-var">pn</span></a><span> </span><a href="#local-6989586621682170403"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621682170401"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1357"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682170402"><a href="#local-6989586621682170402"><span class="hs-identifier">pn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lieWrappedName</span><span> </span><a href="#local-6989586621682170397"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1358"></a><span>                </span><a name="local-6989586621682170403"><a href="#local-6989586621682170403"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">lieWrappedName</span><span> </span><a href="#local-6989586621682170399"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170400"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1359"></a><span>                </span><a name="local-6989586621682170404"><a href="#local-6989586621682170404"><span class="hs-identifier">add_wc_all</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682170398"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1360"></a><span>                            </span><span class="hs-identifier hs-var">NoIEWildcard</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-1361"></a><span>                            </span><span class="hs-identifier hs-var">IEWildcard</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170387"><span class="hs-identifier hs-var">add_unused_all</span></a><span> </span><a href="#local-6989586621682170402"><span class="hs-identifier hs-var">pn</span></a><span>
</span><a name="line-1362"></a><span>        </span><span class="hs-identifier">add_unused</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170405"><a href="#local-6989586621682170405"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170405"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1363"></a><span>
</span><a name="line-1364"></a><span>        </span><a name="local-6989586621682170386"><a href="#local-6989586621682170386"><span class="hs-identifier">add_unused_name</span></a></a><span> </span><a name="local-6989586621682170406"><a href="#local-6989586621682170406"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682170407"><a href="#local-6989586621682170407"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-1365"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170406"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170382"><span class="hs-identifier hs-var">used_names</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170407"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1366"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170407"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170406"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1367"></a><span>        </span><a name="local-6989586621682170387"><a href="#local-6989586621682170387"><span class="hs-identifier">add_unused_all</span></a></a><span> </span><a name="local-6989586621682170408"><a href="#local-6989586621682170408"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682170409"><a href="#local-6989586621682170409"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-1368"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170408"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170382"><span class="hs-identifier hs-var">used_names</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170409"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1369"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170408"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170383"><span class="hs-identifier hs-var">used_parents</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170409"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1370"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170409"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170408"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1371"></a><span>        </span><a name="local-6989586621682170388"><a href="#local-6989586621682170388"><span class="hs-identifier">add_unused_with</span></a></a><span> </span><a name="local-6989586621682170410"><a href="#local-6989586621682170410"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621682170411"><a href="#local-6989586621682170411"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-6989586621682170412"><a href="#local-6989586621682170412"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-1372"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170413"><span class="hs-identifier hs-var">acc1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170411"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170386"><span class="hs-identifier hs-var">add_unused_name</span></a><span> </span><a href="#local-6989586621682170410"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621682170413"><span class="hs-identifier hs-var">acc1</span></a><span>
</span><a name="line-1373"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170413"><span class="hs-identifier hs-var">acc1</span></a><span>
</span><a name="line-1374"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-1375"></a><span>            </span><a name="local-6989586621682170413"><a href="#local-6989586621682170413"><span class="hs-identifier">acc1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682170386"><span class="hs-identifier hs-var">add_unused_name</span></a><span> </span><a href="#local-6989586621682170412"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621682170411"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-1376"></a><span>       </span><span class="hs-comment">-- If you use 'signum' from Num, then the user may well have</span><span>
</span><a name="line-1377"></a><span>       </span><span class="hs-comment">-- imported Num(signum).  We don't want to complain that</span><span>
</span><a name="line-1378"></a><span>       </span><span class="hs-comment">-- Num is not itself mentioned.  Hence the two cases in add_unused_with.</span><span>
</span><a name="line-1379"></a><span>    </span><span class="hs-identifier">unused_decl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XImportDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;unused_decl&quot;</span><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><span>
</span><a name="line-1382"></a><span class="hs-comment">{- Note [The ImportMap]
~~~~~~~~~~~~~~~~~~~~~~~
The ImportMap is a short-lived intermediate data structure records, for
each import declaration, what stuff brought into scope by that
declaration is actually used in the module.

The SrcLoc is the location of the END of a particular 'import'
declaration.  Why *END*?  Because we don't want to get confused
by the implicit Prelude import. Consider (Trac #7476) the module
    import Foo( foo )
    main = print foo
There is an implicit 'import Prelude(print)', and it gets a SrcSpan
of line 1:1 (just the point, not a span). If we use the *START* of
the SrcSpan to identify the import decl, we'll confuse the implicit
import Prelude with the explicit 'import Foo'.  So we use the END.
It's just a cheap hack; we could equally well use the Span too.

The [GlobalRdrElt] are the things imported from that decl.
-}</span><span>
</span><a name="line-1401"></a><span>
</span><a name="line-1402"></a><span class="hs-keyword">type</span><span> </span><a name="ImportMap"><a href="RnNames.html#ImportMap"><span class="hs-identifier">ImportMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">SrcLoc</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- See [The ImportMap]</span><span>
</span><a name="line-1403"></a><span>     </span><span class="hs-comment">-- If loc :-&gt; gres, then</span><span>
</span><a name="line-1404"></a><span>     </span><span class="hs-comment">--   'loc' = the end loc of the bestImport of each GRE in 'gres'</span><span>
</span><a name="line-1405"></a><span>
</span><a name="line-1406"></a><span class="hs-identifier">mkImportMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#ImportMap"><span class="hs-identifier hs-type">ImportMap</span></a><span>
</span><a name="line-1407"></a><span class="hs-comment">-- For each of a list of used GREs, find all the import decls that brought</span><span>
</span><a name="line-1408"></a><span class="hs-comment">-- it into scope; choose one of them (bestImport), and record</span><span>
</span><a name="line-1409"></a><span class="hs-comment">-- the RdrName in that import decl's entry in the ImportMap</span><span>
</span><a name="line-1410"></a><a name="mkImportMap"><a href="RnNames.html#mkImportMap"><span class="hs-identifier">mkImportMap</span></a></a><span> </span><a name="local-6989586621682170414"><a href="#local-6989586621682170414"><span class="hs-identifier">gres</span></a></a><span>
</span><a name="line-1411"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682170415"><span class="hs-identifier hs-var">add_one</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621682170414"><span class="hs-identifier hs-var">gres</span></a><span>
</span><a name="line-1412"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1413"></a><span>    </span><a name="local-6989586621682170415"><a href="#local-6989586621682170415"><span class="hs-identifier">add_one</span></a></a><span> </span><a name="local-6989586621682170416"><a href="#local-6989586621682170416"><span class="hs-identifier">gre</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">gre_imp</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170417"><a href="#local-6989586621682170417"><span class="hs-identifier">imp_specs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682170418"><a href="#local-6989586621682170418"><span class="hs-identifier">imp_map</span></a></a><span>
</span><a name="line-1414"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insertWith</span><span> </span><a href="#local-6989586621682170421"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621682170420"><span class="hs-identifier hs-var">decl_loc</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682170416"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682170418"><span class="hs-identifier hs-var">imp_map</span></a><span>
</span><a name="line-1415"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-1416"></a><span>          </span><a name="local-6989586621682170419"><a href="#local-6989586621682170419"><span class="hs-identifier">best_imp_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bestImport</span><span> </span><a href="#local-6989586621682170417"><span class="hs-identifier hs-var">imp_specs</span></a><span>
</span><a name="line-1417"></a><span>          </span><a name="local-6989586621682170420"><a href="#local-6989586621682170420"><span class="hs-identifier">decl_loc</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcSpanEnd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_dloc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_decl</span><span> </span><a href="#local-6989586621682170419"><span class="hs-identifier hs-var">best_imp_spec</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1418"></a><span>                        </span><span class="hs-comment">-- For srcSpanEnd see Note [The ImportMap]</span><span>
</span><a name="line-1419"></a><span>          </span><a name="local-6989586621682170421"><a href="#local-6989586621682170421"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170422"><a href="#local-6989586621682170422"><span class="hs-identifier">gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170416"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682170422"><span class="hs-identifier hs-var">gres</span></a><span>
</span><a name="line-1420"></a><span>
</span><a name="line-1421"></a><span class="hs-identifier">warnUnusedImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-1422"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier hs-type">ImportDeclUsage</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1423"></a><a name="warnUnusedImport"><a href="RnNames.html#warnUnusedImport"><span class="hs-identifier">warnUnusedImport</span></a></a><span> </span><a name="local-6989586621682170423"><a href="#local-6989586621682170423"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621682170424"><a href="#local-6989586621682170424"><span class="hs-identifier">fld_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170425"><a href="#local-6989586621682170425"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682170426"><a href="#local-6989586621682170426"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170427"><a href="#local-6989586621682170427"><span class="hs-identifier">used</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170428"><a href="#local-6989586621682170428"><span class="hs-identifier">unused</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>
</span><a name="line-1425"></a><span>  </span><span class="hs-comment">-- Do not warn for 'import M()'</span><span>
</span><a name="line-1426"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><a href="#local-6989586621682170426"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1427"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1428"></a><span>
</span><a name="line-1429"></a><span>  </span><span class="hs-comment">-- Note [Do not warn about Prelude hiding]</span><span>
</span><a name="line-1430"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170440"><a href="#local-6989586621682170440"><span class="hs-identifier">hides</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><a href="#local-6989586621682170426"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1431"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170440"><span class="hs-identifier hs-var">hides</span></a><span class="hs-special">)</span><span>
</span><a name="line-1432"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pRELUDE_NAME</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ideclName</span><span> </span><a href="#local-6989586621682170426"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1433"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1434"></a><span>
</span><a name="line-1435"></a><span>  </span><span class="hs-comment">-- Nothing used; drop entire declaration</span><span>
</span><a name="line-1436"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170427"><span class="hs-identifier hs-var">used</span></a><span>
</span><a name="line-1437"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682170423"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170425"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682170429"><span class="hs-identifier hs-var">msg1</span></a><span>
</span><a name="line-1438"></a><span>
</span><a name="line-1439"></a><span>  </span><span class="hs-comment">-- Everything imported is used; nop</span><span>
</span><a name="line-1440"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170428"><span class="hs-identifier hs-var">unused</span></a><span>
</span><a name="line-1441"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1442"></a><span>
</span><a name="line-1443"></a><span>  </span><span class="hs-comment">-- Some imports are unused</span><span>
</span><a name="line-1444"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1445"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682170423"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170425"><span class="hs-identifier hs-var">loc</span></a><span>  </span><a href="#local-6989586621682170430"><span class="hs-identifier hs-var">msg2</span></a><span>
</span><a name="line-1446"></a><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1448"></a><span>    </span><a name="local-6989586621682170429"><a href="#local-6989586621682170429"><span class="hs-identifier">msg1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682170431"><span class="hs-identifier hs-var">pp_herald</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682170433"><span class="hs-identifier hs-var">pp_mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170434"><span class="hs-identifier hs-var">is_redundant</span></a><span>
</span><a name="line-1449"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;except perhaps to import instances from&quot;</span><span>
</span><a name="line-1450"></a><span>                                   </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682170433"><span class="hs-identifier hs-var">pp_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1451"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;To import instances alone, use:&quot;</span><span>
</span><a name="line-1452"></a><span>                                   </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;import&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170433"><span class="hs-identifier hs-var">pp_mod</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1453"></a><span>    </span><a name="local-6989586621682170430"><a href="#local-6989586621682170430"><span class="hs-identifier">msg2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682170431"><span class="hs-identifier hs-var">pp_herald</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682170436"><span class="hs-identifier hs-var">sort_unused</span></a><span>
</span><a name="line-1454"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;from module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682170433"><span class="hs-identifier hs-var">pp_mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170434"><span class="hs-identifier hs-var">is_redundant</span></a><span class="hs-special">]</span><span>
</span><a name="line-1455"></a><span>    </span><a name="local-6989586621682170431"><a href="#local-6989586621682170431"><span class="hs-identifier">pp_herald</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170432"><span class="hs-identifier hs-var">pp_qual</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;import of&quot;</span><span>
</span><a name="line-1456"></a><span>    </span><a name="local-6989586621682170432"><a href="#local-6989586621682170432"><span class="hs-identifier">pp_qual</span></a></a><span>
</span><a name="line-1457"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ideclQualified</span><span> </span><a href="#local-6989586621682170426"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;qualified&quot;</span><span>
</span><a name="line-1458"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1459"></a><span>    </span><a name="local-6989586621682170433"><a href="#local-6989586621682170433"><span class="hs-identifier">pp_mod</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ideclName</span><span> </span><a href="#local-6989586621682170426"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1460"></a><span>    </span><a name="local-6989586621682170434"><a href="#local-6989586621682170434"><span class="hs-identifier">is_redundant</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is redundant&quot;</span><span>
</span><a name="line-1461"></a><span>
</span><a name="line-1462"></a><span>    </span><span class="hs-comment">-- In warning message, pretty-print identifiers unqualified unconditionally</span><span>
</span><a name="line-1463"></a><span>    </span><span class="hs-comment">-- to improve the consistent for ambiguous/unambiguous identifiers.</span><span>
</span><a name="line-1464"></a><span>    </span><span class="hs-comment">-- See trac#14881.</span><span>
</span><a name="line-1465"></a><span>    </span><a name="local-6989586621682170435"><a href="#local-6989586621682170435"><span class="hs-identifier">ppr_possible_field</span></a></a><span> </span><a name="local-6989586621682170437"><a href="#local-6989586621682170437"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621682170424"><span class="hs-identifier hs-var">fld_env</span></a><span> </span><a href="#local-6989586621682170437"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1466"></a><span>                               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682170438"><a href="#local-6989586621682170438"><span class="hs-identifier">fld</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170439"><a href="#local-6989586621682170439"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprNameUnqualified</span><span> </span><a href="#local-6989586621682170439"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170438"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">)</span><span>
</span><a name="line-1467"></a><span>                               </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprNameUnqualified</span><span> </span><a href="#local-6989586621682170437"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1468"></a><span>
</span><a name="line-1469"></a><span>    </span><span class="hs-comment">-- Print unused names in a deterministic (lexicographic) order</span><span>
</span><a name="line-1470"></a><span>    </span><span class="hs-identifier">sort_unused</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1471"></a><span>    </span><a name="local-6989586621682170436"><a href="#local-6989586621682170436"><span class="hs-identifier">sort_unused</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><a href="#local-6989586621682170435"><span class="hs-identifier hs-var">ppr_possible_field</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1472"></a><span>                  </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170428"><span class="hs-identifier hs-var">unused</span></a><span>
</span><a name="line-1473"></a><span>
</span><a name="line-1474"></a><span class="hs-comment">{-
Note [Do not warn about Prelude hiding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not warn about
   import Prelude hiding( x, y )
because even if nothing else from Prelude is used, it may be essential to hide
x,y to avoid name-shadowing warnings.  Example (Trac #9061)
   import Prelude hiding( log )
   f x = log where log = ()



Note [Printing minimal imports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To print the minimal imports we walk over the user-supplied import
decls, and simply trim their import lists.  NB that

  * We do *not* change the 'qualified' or 'as' parts!

  * We do not disard a decl altogether; we might need instances
    from it.  Instead we just trim to an empty import list
-}</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-identifier">getMinimalImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier hs-type">ImportDeclUsage</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1498"></a><a name="getMinimalImports"><a href="RnNames.html#getMinimalImports"><span class="hs-identifier">getMinimalImports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621682170441"><span class="hs-identifier hs-var">mk_minimal</span></a><span>
</span><a name="line-1499"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1500"></a><span>    </span><a name="local-6989586621682170441"><a href="#local-6989586621682170441"><span class="hs-identifier">mk_minimal</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170443"><a href="#local-6989586621682170443"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170444"><a href="#local-6989586621682170444"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170445"><a href="#local-6989586621682170445"><span class="hs-identifier">used_gres</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170446"><a href="#local-6989586621682170446"><span class="hs-identifier">unused</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1501"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682170446"><span class="hs-identifier hs-var">unused</span></a><span>
</span><a name="line-1502"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><a href="#local-6989586621682170444"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1503"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170443"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170444"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1504"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1505"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">ImportDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ideclName</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170448"><a href="#local-6989586621682170448"><span class="hs-identifier">mod_name</span></a></a><span>
</span><a name="line-1506"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclSource</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170449"><a href="#local-6989586621682170449"><span class="hs-identifier">is_boot</span></a></a><span>
</span><a name="line-1507"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclPkgQual</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682170450"><a href="#local-6989586621682170450"><span class="hs-identifier">mb_pkg</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170444"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1508"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170451"><a href="#local-6989586621682170451"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadSrcInterface"><span class="hs-identifier hs-var">loadSrcInterface</span></a><span> </span><a href="#local-6989586621682170447"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682170448"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621682170449"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><a href="#local-6989586621682170450"><span class="hs-identifier hs-var">mb_pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1509"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682170452"><a href="#local-6989586621682170452"><span class="hs-identifier">used_avails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gresToAvailInfo</span><span> </span><a href="#local-6989586621682170445"><span class="hs-identifier hs-var">used_gres</span></a><span>
</span><a name="line-1510"></a><span>                 </span><a name="local-6989586621682170453"><a href="#local-6989586621682170453"><span class="hs-identifier">lies</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170443"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170442"><span class="hs-identifier hs-var">to_ie</span></a><span> </span><a href="#local-6989586621682170451"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170452"><span class="hs-identifier hs-var">used_avails</span></a><span class="hs-special">)</span><span>
</span><a name="line-1511"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170443"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170444"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170443"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170453"><span class="hs-identifier hs-var">lies</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1512"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1513"></a><span>        </span><a name="local-6989586621682170447"><a href="#local-6989586621682170447"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Compute minimal imports for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170444"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1514"></a><span>
</span><a name="line-1515"></a><span>    </span><span class="hs-identifier">to_ie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1516"></a><span>    </span><span class="hs-comment">-- The main trick here is that if we're importing all the constructors</span><span>
</span><a name="line-1517"></a><span>    </span><span class="hs-comment">-- we want to say &quot;T(..)&quot;, but if we're importing only a subset we want</span><span>
</span><a name="line-1518"></a><span>    </span><span class="hs-comment">-- to say &quot;T(A,B,C)&quot;.  So we have to find out what the module exports.</span><span>
</span><a name="line-1519"></a><span>    </span><a name="local-6989586621682170442"><a href="#local-6989586621682170442"><span class="hs-identifier">to_ie</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Avail</span><span> </span><a name="local-6989586621682170454"><a href="#local-6989586621682170454"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1520"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">IEVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170454"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1521"></a><span>    </span><span class="hs-identifier">to_ie</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682170455"><a href="#local-6989586621682170455"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682170456"><a href="#local-6989586621682170456"><span class="hs-identifier">m</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1522"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170455"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621682170456"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">IEThingAbs</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170455"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1523"></a><span>    </span><span class="hs-identifier">to_ie</span><span> </span><a name="local-6989586621682170457"><a href="#local-6989586621682170457"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682170458"><a href="#local-6989586621682170458"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682170459"><a href="#local-6989586621682170459"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-6989586621682170460"><a href="#local-6989586621682170460"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1524"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682170467"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><a href="#local-6989586621682170468"><span class="hs-identifier hs-var">gs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682170466"><a href="#local-6989586621682170466"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682170467"><a href="#local-6989586621682170467"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621682170468"><a href="#local-6989586621682170468"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mi_exports</span><span> </span><a href="#local-6989586621682170457"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1525"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170466"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682170458"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1526"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170466"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170467"><span class="hs-identifier hs-var">xs</span></a><span>    </span><span class="hs-comment">-- Note [Partial export]</span><span>
</span><a name="line-1527"></a><span>                 </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1528"></a><span>           </span><span class="hs-special">[</span><a name="local-6989586621682170469"><a href="#local-6989586621682170469"><span class="hs-identifier">xs</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170462"><span class="hs-identifier hs-var">all_used</span></a><span> </span><a href="#local-6989586621682170469"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">IEThingAll</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170458"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1529"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1530"></a><span>                   </span><span class="hs-special">[</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170458"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">NoIEWildcard</span><span>
</span><a name="line-1531"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682170458"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170459"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1532"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170460"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1533"></a><span>                                          </span><span class="hs-comment">-- Note [Overloaded field import]</span><span>
</span><a name="line-1534"></a><span>           </span><a name="local-6989586621682170470"><a href="#local-6989586621682170470"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682170463"><span class="hs-identifier hs-var">all_non_overloaded</span></a><span> </span><a href="#local-6989586621682170460"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1535"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="RnNames.html#to_ie_post_rn_var"><span class="hs-identifier hs-var">to_ie_post_rn_var</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682170459"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-1536"></a><span>                                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621682170460"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1537"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1538"></a><span>                      </span><span class="hs-special">[</span><span class="hs-identifier hs-var">IEThingWith</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170458"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">NoIEWildcard</span><span>
</span><a name="line-1539"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier hs-var">to_ie_post_rn</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682170458"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170459"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1540"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170460"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1541"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1542"></a><span>
</span><a name="line-1543"></a><span>          </span><a name="local-6989586621682170461"><a href="#local-6989586621682170461"><span class="hs-identifier">fld_lbls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621682170460"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1544"></a><span>
</span><a name="line-1545"></a><span>          </span><a name="local-6989586621682170462"><a href="#local-6989586621682170462"><span class="hs-identifier">all_used</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682170464"><a href="#local-6989586621682170464"><span class="hs-identifier">avail_occs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682170465"><a href="#local-6989586621682170465"><span class="hs-identifier">avail_flds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1546"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170459"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170464"><span class="hs-identifier hs-var">avail_occs</span></a><span>
</span><a name="line-1547"></a><span>                    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682170461"><span class="hs-identifier hs-var">fld_lbls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621682170465"><span class="hs-identifier hs-var">avail_flds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span>          </span><a name="local-6989586621682170463"><a href="#local-6989586621682170463"><span class="hs-identifier">all_non_overloaded</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">flIsOverloaded</span><span class="hs-special">)</span><span>
</span><a name="line-1550"></a><span>
</span><a name="line-1551"></a><span class="hs-identifier">printMinimalImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="RnNames.html#ImportDeclUsage"><span class="hs-identifier hs-type">ImportDeclUsage</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1552"></a><span class="hs-comment">-- See Note [Printing minimal imports]</span><span>
</span><a name="line-1553"></a><a name="printMinimalImports"><a href="RnNames.html#printMinimalImports"><span class="hs-identifier">printMinimalImports</span></a></a><span> </span><a name="local-6989586621682170471"><a href="#local-6989586621682170471"><span class="hs-identifier">imports_w_usage</span></a></a><span>
</span><a name="line-1554"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170477"><a href="#local-6989586621682170477"><span class="hs-identifier">imports'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#getMinimalImports"><span class="hs-identifier hs-var">getMinimalImports</span></a><span> </span><a href="#local-6989586621682170471"><span class="hs-identifier hs-var">imports_w_usage</span></a><span>
</span><a name="line-1555"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170478"><a href="#local-6989586621682170478"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-1556"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682170479"><a href="#local-6989586621682170479"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1557"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1558"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682170480"><a href="#local-6989586621682170480"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">openFile</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170472"><span class="hs-identifier hs-var">mkFilename</span></a><span> </span><a href="#local-6989586621682170479"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682170478"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">WriteMode</span><span>
</span><a name="line-1559"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">printForUser</span><span> </span><a href="#local-6989586621682170479"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682170480"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-identifier hs-var">neverQualify</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170477"><span class="hs-identifier hs-var">imports'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1560"></a><span>              </span><span class="hs-comment">-- The neverQualify is important.  We are printing Names</span><span>
</span><a name="line-1561"></a><span>              </span><span class="hs-comment">-- but they are in the context of an 'import' decl, and</span><span>
</span><a name="line-1562"></a><span>              </span><span class="hs-comment">-- we never qualify things inside there</span><span>
</span><a name="line-1563"></a><span>              </span><span class="hs-comment">-- E.g.   import Blag( f, b )</span><span>
</span><a name="line-1564"></a><span>              </span><span class="hs-comment">-- not    import Blag( Blag.f, Blag.g )!</span><span>
</span><a name="line-1565"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1566"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1567"></a><span>    </span><a name="local-6989586621682170472"><a href="#local-6989586621682170472"><span class="hs-identifier">mkFilename</span></a></a><span> </span><a name="local-6989586621682170473"><a href="#local-6989586621682170473"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682170474"><a href="#local-6989586621682170474"><span class="hs-identifier">this_mod</span></a></a><span>
</span><a name="line-1568"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170476"><a href="#local-6989586621682170476"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">dumpDir</span><span> </span><a href="#local-6989586621682170473"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170476"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621682170475"><span class="hs-identifier hs-var">basefn</span></a><span>
</span><a name="line-1569"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682170475"><span class="hs-identifier hs-var">basefn</span></a><span>
</span><a name="line-1570"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1571"></a><span>        </span><a name="local-6989586621682170475"><a href="#local-6989586621682170475"><span class="hs-identifier">basefn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682170474"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.imports&quot;</span><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span>
</span><a name="line-1574"></a><span class="hs-identifier">to_ie_post_rn_var</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasOccName</span><span> </span><a href="#local-6989586621682169944"><span class="hs-identifier hs-type">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><a href="#local-6989586621682169944"><span class="hs-identifier hs-type">name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LIEWrappedName</span><span> </span><a href="#local-6989586621682169944"><span class="hs-identifier hs-type">name</span></a><span>
</span><a name="line-1575"></a><a name="to_ie_post_rn_var"><a href="RnNames.html#to_ie_post_rn_var"><span class="hs-identifier">to_ie_post_rn_var</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170481"><a href="#local-6989586621682170481"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170482"><a href="#local-6989586621682170482"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDataOcc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">occName</span><span> </span><a href="#local-6989586621682170482"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170481"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEPattern</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170481"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170482"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170481"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEName</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170481"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170482"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1578"></a><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span class="hs-identifier">to_ie_post_rn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasOccName</span><span> </span><a href="#local-6989586621682169943"><span class="hs-identifier hs-type">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><a href="#local-6989586621682169943"><span class="hs-identifier hs-type">name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LIEWrappedName</span><span> </span><a href="#local-6989586621682169943"><span class="hs-identifier hs-type">name</span></a><span>
</span><a name="line-1581"></a><a name="to_ie_post_rn"><a href="RnNames.html#to_ie_post_rn"><span class="hs-identifier">to_ie_post_rn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682170483"><a href="#local-6989586621682170483"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682170484"><a href="#local-6989586621682170484"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1582"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTcOcc</span><span> </span><a href="#local-6989586621682170485"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isSymOcc</span><span> </span><a href="#local-6989586621682170485"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170483"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170483"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170484"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1583"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170483"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682170483"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682170484"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1584"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682170485"><a href="#local-6989586621682170485"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">occName</span><span> </span><a href="#local-6989586621682170484"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1585"></a><span>
</span><a name="line-1586"></a><span class="hs-comment">{-
Note [Partial export]
~~~~~~~~~~~~~~~~~~~~~
Suppose we have

   module A( op ) where
     class C a where
       op :: a -&gt; a

   module B where
   import A
   f = ..op...

Then the minimal import for module B is
   import A( op )
not
   import A( C( op ) )
which we would usually generate if C was exported from B.  Hence
the (x `elem` xs) test when deciding what to generate.


Note [Overloaded field import]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
On the other hand, if we have

    {-# LANGUAGE DuplicateRecordFields #-}
    module A where
      data T = MkT { foo :: Int }

    module B where
      import A
      f = ...foo...

then the minimal import for module B must be
    import A ( T(foo) )
because when DuplicateRecordFields is enabled, field selectors are
not in scope without their enclosing datatype.


************************************************************************
*                                                                      *
\subsection{Errors}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1631"></a><span>
</span><a name="line-1632"></a><span class="hs-identifier">qualImportItemErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1633"></a><a name="qualImportItemErr"><a href="RnNames.html#qualImportItemErr"><span class="hs-identifier">qualImportItemErr</span></a></a><span> </span><a name="local-6989586621682170486"><a href="#local-6989586621682170486"><span class="hs-identifier">rdr</span></a></a><span>
</span><a name="line-1634"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal qualified name in import item:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1635"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170486"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1636"></a><span>
</span><a name="line-1637"></a><span class="hs-identifier">badImportItemErrStd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImpDeclSpec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1638"></a><a name="badImportItemErrStd"><a href="RnNames.html#badImportItemErrStd"><span class="hs-identifier">badImportItemErrStd</span></a></a><span> </span><a name="local-6989586621682170487"><a href="#local-6989586621682170487"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621682170488"><a href="#local-6989586621682170488"><span class="hs-identifier">decl_spec</span></a></a><span> </span><a name="local-6989586621682170489"><a href="#local-6989586621682170489"><span class="hs-identifier">ie</span></a></a><span>
</span><a name="line-1639"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_mod</span><span> </span><a href="#local-6989586621682170488"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682170490"><span class="hs-identifier hs-var">source_import</span></a><span class="hs-special">,</span><span>
</span><a name="line-1640"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;does not export&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170489"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1641"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1642"></a><span>    </span><a name="local-6989586621682170490"><a href="#local-6989586621682170490"><span class="hs-identifier">source_import</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621682170487"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(hi-boot interface)&quot;</span><span>
</span><a name="line-1643"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1644"></a><span>
</span><a name="line-1645"></a><span class="hs-identifier">badImportItemErrDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImpDeclSpec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1646"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1647"></a><a name="badImportItemErrDataCon"><a href="RnNames.html#badImportItemErrDataCon"><span class="hs-identifier">badImportItemErrDataCon</span></a></a><span> </span><a name="local-6989586621682170491"><a href="#local-6989586621682170491"><span class="hs-identifier">dataType_occ</span></a></a><span> </span><a name="local-6989586621682170492"><a href="#local-6989586621682170492"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621682170493"><a href="#local-6989586621682170493"><span class="hs-identifier">decl_spec</span></a></a><span> </span><a name="local-6989586621682170494"><a href="#local-6989586621682170494"><span class="hs-identifier">ie</span></a></a><span>
</span><a name="line-1648"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In module&quot;</span><span>
</span><a name="line-1649"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_mod</span><span> </span><a href="#local-6989586621682170493"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1650"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170498"><span class="hs-identifier hs-var">source_import</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span>
</span><a name="line-1651"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682170496"><span class="hs-identifier hs-var">datacon</span></a><span>
</span><a name="line-1652"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is a data constructor of&quot;</span><span>
</span><a name="line-1653"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682170497"><span class="hs-identifier hs-var">dataType</span></a><span>
</span><a name="line-1654"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;To import it use&quot;</span><span>
</span><a name="line-1655"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;import&quot;</span><span>
</span><a name="line-1656"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_mod</span><span> </span><a href="#local-6989586621682170493"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-1657"></a><span>             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621682170499"><span class="hs-identifier hs-var">parens_sp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170497"><span class="hs-identifier hs-var">dataType</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621682170499"><span class="hs-identifier hs-var">parens_sp</span></a><span> </span><a href="#local-6989586621682170496"><span class="hs-identifier hs-var">datacon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1658"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;or&quot;</span><span>
</span><a name="line-1659"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;import&quot;</span><span>
</span><a name="line-1660"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_mod</span><span> </span><a href="#local-6989586621682170493"><span class="hs-identifier hs-var">decl_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-1661"></a><span>             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621682170499"><span class="hs-identifier hs-var">parens_sp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170497"><span class="hs-identifier hs-var">dataType</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(..)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1662"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-1663"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1664"></a><span>    </span><a name="local-6989586621682170495"><a href="#local-6989586621682170495"><span class="hs-identifier">datacon_occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ieName</span><span> </span><a href="#local-6989586621682170494"><span class="hs-identifier hs-var">ie</span></a><span>
</span><a name="line-1665"></a><span>    </span><a name="local-6989586621682170496"><a href="#local-6989586621682170496"><span class="hs-identifier">datacon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parenSymOcc</span><span> </span><a href="#local-6989586621682170495"><span class="hs-identifier hs-var">datacon_occ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170495"><span class="hs-identifier hs-var">datacon_occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-1666"></a><span>    </span><a name="local-6989586621682170497"><a href="#local-6989586621682170497"><span class="hs-identifier">dataType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parenSymOcc</span><span> </span><a href="#local-6989586621682170491"><span class="hs-identifier hs-var">dataType_occ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170491"><span class="hs-identifier hs-var">dataType_occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-1667"></a><span>    </span><a name="local-6989586621682170498"><a href="#local-6989586621682170498"><span class="hs-identifier">source_import</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621682170492"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(hi-boot interface)&quot;</span><span>
</span><a name="line-1668"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1669"></a><span>    </span><a name="local-6989586621682170499"><a href="#local-6989586621682170499"><span class="hs-identifier">parens_sp</span></a></a><span> </span><a name="local-6989586621682170500"><a href="#local-6989586621682170500"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">space</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621682170500"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">space</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- T( f,g )</span><span>
</span><a name="line-1670"></a><span>
</span><a name="line-1671"></a><span class="hs-identifier">badImportItemErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImpDeclSpec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1672"></a><a name="badImportItemErr"><a href="RnNames.html#badImportItemErr"><span class="hs-identifier">badImportItemErr</span></a></a><span> </span><a name="local-6989586621682170501"><a href="#local-6989586621682170501"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621682170502"><a href="#local-6989586621682170502"><span class="hs-identifier">decl_spec</span></a></a><span> </span><a name="local-6989586621682170503"><a href="#local-6989586621682170503"><span class="hs-identifier">ie</span></a></a><span> </span><a name="local-6989586621682170504"><a href="#local-6989586621682170504"><span class="hs-identifier">avails</span></a></a><span>
</span><a name="line-1673"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><a href="#local-6989586621682170505"><span class="hs-identifier hs-var">checkIfDataCon</span></a><span> </span><a href="#local-6989586621682170504"><span class="hs-identifier hs-var">avails</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1674"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170512"><a href="#local-6989586621682170512"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#badImportItemErrDataCon"><span class="hs-identifier hs-var">badImportItemErrDataCon</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682170506"><span class="hs-identifier hs-var">availOccName</span></a><span> </span><a href="#local-6989586621682170512"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170501"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682170502"><span class="hs-identifier hs-var">decl_spec</span></a><span> </span><a href="#local-6989586621682170503"><span class="hs-identifier hs-var">ie</span></a><span>
</span><a name="line-1675"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnNames.html#badImportItemErrStd"><span class="hs-identifier hs-var">badImportItemErrStd</span></a><span> </span><a href="#local-6989586621682170501"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682170502"><span class="hs-identifier hs-var">decl_spec</span></a><span> </span><a href="#local-6989586621682170503"><span class="hs-identifier hs-var">ie</span></a><span>
</span><a name="line-1676"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1677"></a><span>    </span><a name="local-6989586621682170505"><a href="#local-6989586621682170505"><span class="hs-identifier">checkIfDataCon</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170509"><a href="#local-6989586621682170509"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1678"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682170510"><a href="#local-6989586621682170510"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682170508"><span class="hs-identifier hs-var">importedFS</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682170507"><span class="hs-identifier hs-var">nameOccNameFS</span></a><span> </span><a href="#local-6989586621682170510"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170509"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1679"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682170511"><a href="#local-6989586621682170511"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isDataConName</span><span> </span><a href="#local-6989586621682170511"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1680"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1681"></a><span>    </span><span class="hs-identifier">checkIfDataCon</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1682"></a><span>    </span><a name="local-6989586621682170506"><a href="#local-6989586621682170506"><span class="hs-identifier">availOccName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">availName</span><span>
</span><a name="line-1683"></a><span>    </span><a name="local-6989586621682170507"><a href="#local-6989586621682170507"><span class="hs-identifier">nameOccNameFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span>
</span><a name="line-1684"></a><span>    </span><a name="local-6989586621682170508"><a href="#local-6989586621682170508"><span class="hs-identifier">importedFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ieName</span><span> </span><a href="#local-6989586621682170503"><span class="hs-identifier hs-var">ie</span></a><span>
</span><a name="line-1685"></a><span>
</span><a name="line-1686"></a><span class="hs-identifier">illegalImportItemErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1687"></a><a name="illegalImportItemErr"><a href="RnNames.html#illegalImportItemErr"><span class="hs-identifier">illegalImportItemErr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal import item&quot;</span><span>
</span><a name="line-1688"></a><span>
</span><a name="line-1689"></a><span class="hs-identifier">dodgyImportWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1690"></a><a name="dodgyImportWarn"><a href="RnNames.html#dodgyImportWarn"><span class="hs-identifier">dodgyImportWarn</span></a></a><span> </span><a name="local-6989586621682170513"><a href="#local-6989586621682170513"><span class="hs-identifier">item</span></a></a><span>
</span><a name="line-1691"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnNames.html#dodgyMsg"><span class="hs-identifier hs-var">dodgyMsg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;import&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170513"><span class="hs-identifier hs-var">item</span></a><span> </span><span class="hs-special">(</span><a href="RnNames.html#dodgyMsgInsert"><span class="hs-identifier hs-var">dodgyMsgInsert</span></a><span> </span><a href="#local-6989586621682170513"><span class="hs-identifier hs-var">item</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1692"></a><span>
</span><a name="line-1693"></a><span class="hs-identifier">dodgyMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682169941"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682169942"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682169941"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682169942"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1694"></a><a name="dodgyMsg"><a href="RnNames.html#dodgyMsg"><span class="hs-identifier">dodgyMsg</span></a></a><span> </span><a name="local-6989586621682170514"><a href="#local-6989586621682170514"><span class="hs-identifier">kind</span></a></a><span> </span><a name="local-6989586621682170515"><a href="#local-6989586621682170515"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682170516"><a href="#local-6989586621682170516"><span class="hs-identifier">ie</span></a></a><span>
</span><a name="line-1695"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682170514"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;item&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1696"></a><span>                    </span><span class="hs-comment">-- &lt;+&gt; quotes (ppr (IEThingAll (noLoc (IEName $ noLoc tc))))</span><span>
</span><a name="line-1697"></a><span>                     </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170516"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">)</span><span>
</span><a name="line-1698"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;suggests that&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1699"></a><span>          </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170515"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has (in-scope) constructors or class methods,&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1700"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but it has none&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1701"></a><span>
</span><a name="line-1702"></a><span class="hs-identifier">dodgyMsgInsert</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621682169940"><a href="#local-6989586621682169940"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">IdP</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682169940"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682169940"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-1703"></a><a name="dodgyMsgInsert"><a href="RnNames.html#dodgyMsgInsert"><span class="hs-identifier">dodgyMsgInsert</span></a></a><span> </span><a name="local-6989586621682170517"><a href="#local-6989586621682170517"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IEThingAll</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682170518"><span class="hs-identifier hs-var">ii</span></a><span>
</span><a name="line-1704"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1705"></a><span>    </span><span class="hs-identifier">ii</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LIEWrappedName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IdP</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682169940"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1706"></a><span>    </span><a name="local-6989586621682170518"><a href="#local-6989586621682170518"><span class="hs-identifier">ii</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IEName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682170517"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1707"></a><span>
</span><a name="line-1708"></a><span>
</span><a name="line-1709"></a><span class="hs-identifier">addDupDeclErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1710"></a><a name="addDupDeclErr"><a href="RnNames.html#addDupDeclErr"><span class="hs-identifier">addDupDeclErr</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;addDupDeclErr: empty list&quot;</span><span>
</span><a name="line-1711"></a><span class="hs-identifier">addDupDeclErr</span><span> </span><a name="local-6989586621682170519"><a href="#local-6989586621682170519"><span class="hs-identifier">gres</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621682170520"><a href="#local-6989586621682170520"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1712"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621682170522"><span class="hs-identifier hs-var">sorted_names</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1713"></a><span>    </span><span class="hs-comment">-- Report the error at the later location</span><span>
</span><a name="line-1714"></a><span>    </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Multiple declarations of&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1715"></a><span>             </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682170521"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1716"></a><span>             </span><span class="hs-comment">-- NB. print the OccName, not the Name, because the</span><span>
</span><a name="line-1717"></a><span>             </span><span class="hs-comment">-- latter might not be in scope in the RdrEnv and so will</span><span>
</span><a name="line-1718"></a><span>             </span><span class="hs-comment">-- be printed qualified.</span><span>
</span><a name="line-1719"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Declared at:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1720"></a><span>                   </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameSrcLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170522"><span class="hs-identifier hs-var">sorted_names</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1721"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1722"></a><span>    </span><a name="local-6989586621682170521"><a href="#local-6989586621682170521"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682170520"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-1723"></a><span>    </span><a name="local-6989586621682170522"><a href="#local-6989586621682170522"><span class="hs-identifier">sorted_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-identifier hs-var">nameSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682170519"><span class="hs-identifier hs-var">gres</span></a><span class="hs-special">)</span><span>
</span><a name="line-1724"></a><span>
</span><a name="line-1725"></a><span>
</span><a name="line-1726"></a><span>
</span><a name="line-1727"></a><span class="hs-identifier">missingImportListWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1728"></a><a name="missingImportListWarn"><a href="RnNames.html#missingImportListWarn"><span class="hs-identifier">missingImportListWarn</span></a></a><span> </span><a name="local-6989586621682170523"><a href="#local-6989586621682170523"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-1729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170523"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;does not have an explicit import list&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1730"></a><span>
</span><a name="line-1731"></a><span class="hs-identifier">missingImportListItem</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IE</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1732"></a><a name="missingImportListItem"><a href="RnNames.html#missingImportListItem"><span class="hs-identifier">missingImportListItem</span></a></a><span> </span><a name="local-6989586621682170524"><a href="#local-6989586621682170524"><span class="hs-identifier">ie</span></a></a><span>
</span><a name="line-1733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The import item&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170524"><span class="hs-identifier hs-var">ie</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;does not have an explicit import list&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1734"></a><span>
</span><a name="line-1735"></a><span class="hs-identifier">moduleWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WarningTxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1736"></a><a name="moduleWarn"><a href="RnNames.html#moduleWarn"><span class="hs-identifier">moduleWarn</span></a></a><span> </span><a name="local-6989586621682170525"><a href="#local-6989586621682170525"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WarningTxt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170526"><a href="#local-6989586621682170526"><span class="hs-identifier">txt</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170525"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;:&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1738"></a><span>          </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170526"><span class="hs-identifier hs-var">txt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1739"></a><span class="hs-identifier">moduleWarn</span><span> </span><a name="local-6989586621682170527"><a href="#local-6989586621682170527"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DeprecatedTxt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682170528"><a href="#local-6989586621682170528"><span class="hs-identifier">txt</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1740"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170527"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1741"></a><span>                                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is deprecated:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1742"></a><span>          </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682170528"><span class="hs-identifier hs-var">txt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1743"></a><span>
</span><a name="line-1744"></a><span class="hs-identifier">packageImportErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1745"></a><a name="packageImportErr"><a href="RnNames.html#packageImportErr"><span class="hs-identifier">packageImportErr</span></a></a><span>
</span><a name="line-1746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Package-qualified imports are not enabled; use PackageImports&quot;</span><span>
</span><a name="line-1747"></a><span>
</span><a name="line-1748"></a><span class="hs-comment">-- This data decl will parse OK</span><span>
</span><a name="line-1749"></a><span class="hs-comment">--      data T = a Int</span><span>
</span><a name="line-1750"></a><span class="hs-comment">-- treating &quot;a&quot; as the constructor.</span><span>
</span><a name="line-1751"></a><span class="hs-comment">-- It is really hard to make the parser spot this malformation.</span><span>
</span><a name="line-1752"></a><span class="hs-comment">-- So the renamer has to check that the constructor is legal</span><span>
</span><a name="line-1753"></a><span class="hs-comment">--</span><span>
</span><a name="line-1754"></a><span class="hs-comment">-- We can get an operator as the constructor, even in the prefix form:</span><span>
</span><a name="line-1755"></a><span class="hs-comment">--      data T = :% Int Int</span><span>
</span><a name="line-1756"></a><span class="hs-comment">-- from interface files, which always print in prefix form</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span class="hs-identifier">checkConName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1759"></a><a name="checkConName"><a href="RnNames.html#checkConName"><span class="hs-identifier">checkConName</span></a></a><span> </span><a name="local-6989586621682170529"><a href="#local-6989586621682170529"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkErr"><span class="hs-identifier hs-var">checkErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isRdrDataCon</span><span> </span><a href="#local-6989586621682170529"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#badDataCon"><span class="hs-identifier hs-var">badDataCon</span></a><span> </span><a href="#local-6989586621682170529"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span class="hs-identifier">badDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1762"></a><a name="badDataCon"><a href="RnNames.html#badDataCon"><span class="hs-identifier">badDataCon</span></a></a><span> </span><a name="local-6989586621682170530"><a href="#local-6989586621682170530"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1763"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal data constructor name&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682170530"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1764"></a></pre></body></html>