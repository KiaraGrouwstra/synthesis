<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
%
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[TcExpr]{Typecheck an expression}
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, TupleSections, ScopedTypeVariables #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcExpr</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>                </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcInferSigmaNC"><span class="hs-identifier hs-var">tcInferSigmaNC</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcInferRho"><span class="hs-identifier hs-var">tcInferRho</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcInferRhoNC"><span class="hs-identifier hs-var">tcInferRhoNC</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>                </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcSyntaxOpGen"><span class="hs-identifier hs-var">tcSyntaxOpGen</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SyntaxOpType</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>                </span><a href="TcExpr.html#tcCheckId"><span class="hs-identifier hs-var">tcCheckId</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>                </span><a href="TcExpr.html#addExprErrCtxt"><span class="hs-identifier hs-var">addExprErrCtxt</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>                </span><a href="TcExpr.html#getFixedTyVars"><span class="hs-identifier hs-var">getFixedTyVars</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="TcSplice.html"><span class="hs-identifier">TcSplice</span></a><span class="hs-special">(</span><span> </span><a href="TcSplice.html#tcSpliceExpr"><span class="hs-identifier hs-var">tcSpliceExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#tcTypedBracket"><span class="hs-identifier hs-var">tcTypedBracket</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#tcUntypedBracket"><span class="hs-identifier hs-var">tcUntypedBracket</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="THNames.html"><span class="hs-identifier">THNames</span></a><span class="hs-special">(</span><span> </span><a href="THNames.html#liftStringName"><span class="hs-identifier hs-var">liftStringName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#liftName"><span class="hs-identifier hs-var">liftName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcBinds.html"><span class="hs-identifier">TcBinds</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="TcBinds.html#chooseInferredQuantifiers"><span class="hs-identifier hs-var">chooseInferredQuantifiers</span></a><span class="hs-special">,</span><span> </span><a href="TcBinds.html#tcLocalBinds"><span class="hs-identifier hs-var">tcLocalBinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcSigs.html"><span class="hs-identifier">TcSigs</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="TcSigs.html#tcUserTypeSig"><span class="hs-identifier hs-var">tcUserTypeSig</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcInstSig"><span class="hs-identifier hs-var">tcInstSig</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TcSimplify.html#simplifyInfer"><span class="hs-identifier hs-var">simplifyInfer</span></a><span class="hs-special">,</span><span> </span><a href="TcSimplify.html#InferMode"><span class="hs-identifier hs-type">InferMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="RnEnv.html#addUsedGRE"><span class="hs-identifier hs-var">addUsedGRE</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#addNameClashErrRn"><span class="hs-identifier hs-var">addNameClashErrRn</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#unknownSubordinateErr"><span class="hs-identifier hs-var">unknownSubordinateErr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TcArrows.html"><span class="hs-identifier">TcArrows</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="TcMatches.html"><span class="hs-identifier">TcMatches</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcPatSyn.html"><span class="hs-identifier">TcPatSyn</span></a><span class="hs-special">(</span><span> </span><a href="TcPatSyn.html#tcPatSynBuilderOcc"><span class="hs-identifier hs-var">tcPatSynBuilderOcc</span></a><span class="hs-special">,</span><span> </span><a href="TcPatSyn.html#nonBidirectionalErr"><span class="hs-identifier hs-var">nonBidirectionalErr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TcPat.html"><span class="hs-identifier">TcPat</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">seqId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTemplateTyVars</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tYPE</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrimOp</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">tagToEnumKey</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span class="hs-special">(</span><span class="hs-identifier hs-var">classTyCon</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Main wrappers}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">tcPolyExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcPolyExprNC</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>         </span><span class="hs-comment">-- Expression to type check</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>           </span><span class="hs-comment">-- Expected type (could be a polytype)</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Generalised expr with expected type</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- tcPolyExpr is a convenient place (frequent but not too frequent)</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- place to add context information.</span><span>
</span><a name="line-99"></a><span class="hs-comment">-- The NC version does not do so, usually because the caller wants</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- to do so himself.</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><a name="tcPolyExpr"><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier">tcPolyExpr</span></a></a><span>   </span><a name="local-6989586621683755723"><a href="#local-6989586621683755723"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683755724"><a href="#local-6989586621683755724"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tc_poly_expr"><span class="hs-identifier hs-var">tc_poly_expr</span></a><span> </span><a href="#local-6989586621683755723"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683755724"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><a name="tcPolyExprNC"><a href="TcExpr.html#tcPolyExprNC"><span class="hs-identifier">tcPolyExprNC</span></a></a><span> </span><a name="local-6989586621683755725"><a href="#local-6989586621683755725"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683755726"><a href="#local-6989586621683755726"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tc_poly_expr_nc"><span class="hs-identifier hs-var">tc_poly_expr_nc</span></a><span> </span><a href="#local-6989586621683755725"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683755726"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- these versions take an ExpType</span><span>
</span><a name="line-106"></a><span class="hs-identifier">tc_poly_expr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tc_poly_expr_nc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>
</span><a name="line-107"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><a name="tc_poly_expr"><a href="TcExpr.html#tc_poly_expr"><span class="hs-identifier">tc_poly_expr</span></a></a><span> </span><a name="local-6989586621683755727"><a href="#local-6989586621683755727"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683755728"><a href="#local-6989586621683755728"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#addExprErrCtxt"><span class="hs-identifier hs-var">addExprErrCtxt</span></a><span> </span><a href="#local-6989586621683755727"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPolyExpr&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683755728"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tc_poly_expr_nc"><span class="hs-identifier hs-var">tc_poly_expr_nc</span></a><span> </span><a href="#local-6989586621683755727"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755728"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><a name="tc_poly_expr_nc"><a href="TcExpr.html#tc_poly_expr_nc"><span class="hs-identifier">tc_poly_expr_nc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755729"><a href="#local-6989586621683755729"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683755730"><a href="#local-6989586621683755730"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755731"><a href="#local-6989586621683755731"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683755729"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPolyExprNC&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683755731"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755733"><a href="#local-6989586621683755733"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755734"><a href="#local-6989586621683755734"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSkolemiseET"><span class="hs-identifier hs-var">tcSkolemiseET</span></a><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span> </span><a href="#local-6989586621683755731"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683755732"><a href="#local-6989586621683755732"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-117"></a><span>              </span><a href="TcExpr.html#tcExpr"><span class="hs-identifier hs-var">tcExpr</span></a><span> </span><a href="#local-6989586621683755730"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755732"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-118"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755729"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755733"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683755734"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-121"></a><span class="hs-identifier">tcMonoExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcMonoExprNC</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>     </span><span class="hs-comment">-- Expression to type check</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>        </span><span class="hs-comment">-- Expected type</span><span>
</span><a name="line-124"></a><span>                         </span><span class="hs-comment">-- Definitely no foralls at the top</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><a name="tcMonoExpr"><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier">tcMonoExpr</span></a></a><span> </span><a name="local-6989586621683755735"><a href="#local-6989586621683755735"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683755736"><a href="#local-6989586621683755736"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#exprCtxt"><span class="hs-identifier hs-var">exprCtxt</span></a><span> </span><a href="#local-6989586621683755735"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-129"></a><span>    </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683755735"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755736"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><a name="tcMonoExprNC"><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier">tcMonoExprNC</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755737"><a href="#local-6989586621683755737"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683755738"><a href="#local-6989586621683755738"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755739"><a href="#local-6989586621683755739"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683755737"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-133"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755740"><a href="#local-6989586621683755740"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcExpr"><span class="hs-identifier hs-var">tcExpr</span></a><span> </span><a href="#local-6989586621683755738"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755739"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-134"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755737"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683755740"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-137"></a><span class="hs-identifier">tcInferSigma</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcInferSigmaNC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span>
</span><a name="line-138"></a><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- Infer a *sigma*-type.</span><span>
</span><a name="line-140"></a><a name="tcInferSigma"><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier">tcInferSigma</span></a></a><span> </span><a name="local-6989586621683755741"><a href="#local-6989586621683755741"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#exprCtxt"><span class="hs-identifier hs-var">exprCtxt</span></a><span> </span><a href="#local-6989586621683755741"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcInferSigmaNC"><span class="hs-identifier hs-var">tcInferSigmaNC</span></a><span> </span><a href="#local-6989586621683755741"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><a name="tcInferSigmaNC"><a href="TcExpr.html#tcInferSigmaNC"><span class="hs-identifier">tcInferSigmaNC</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755742"><a href="#local-6989586621683755742"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683755743"><a href="#local-6989586621683755743"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683755742"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755744"><a href="#local-6989586621683755744"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755745"><a href="#local-6989586621683755745"><span class="hs-identifier">sigma</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcInferNoInst"><span class="hs-identifier hs-var">tcInferNoInst</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcExpr"><span class="hs-identifier hs-var">tcExpr</span></a><span> </span><a href="#local-6989586621683755743"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755742"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683755744"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755745"><span class="hs-identifier hs-var">sigma</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-identifier">tcInferRho</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcInferRhoNC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- Infer a *rho*-type. The return type is always (shallowly) instantiated.</span><span>
</span><a name="line-149"></a><a name="tcInferRho"><a href="TcExpr.html#tcInferRho"><span class="hs-identifier">tcInferRho</span></a></a><span> </span><a name="local-6989586621683755746"><a href="#local-6989586621683755746"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#exprCtxt"><span class="hs-identifier hs-var">exprCtxt</span></a><span> </span><a href="#local-6989586621683755746"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcInferRhoNC"><span class="hs-identifier hs-var">tcInferRhoNC</span></a><span> </span><a href="#local-6989586621683755746"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><a name="tcInferRhoNC"><a href="TcExpr.html#tcInferRhoNC"><span class="hs-identifier">tcInferRhoNC</span></a></a><span> </span><a name="local-6989586621683755747"><a href="#local-6989586621683755747"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-152"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755748"><a href="#local-6989586621683755748"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755749"><a href="#local-6989586621683755749"><span class="hs-identifier">sigma</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferSigmaNC"><span class="hs-identifier hs-var">tcInferSigmaNC</span></a><span> </span><a href="#local-6989586621683755747"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-153"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755750"><a href="#local-6989586621683755750"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755751"><a href="#local-6989586621683755751"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683755747"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755749"><span class="hs-identifier hs-var">sigma</span></a><span>
</span><a name="line-154"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683755750"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683755748"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755751"><span class="hs-identifier hs-var">rho</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        tcExpr: the main expression typechecker
*                                                                      *
************************************************************************

NB: The res_ty is always deeply skolemised.
-}</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><a name="tcExpr"><a href="TcExpr.html#tcExpr"><span class="hs-identifier">tcExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755752"><a href="#local-6989586621683755752"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><a name="local-6989586621683755753"><a href="#local-6989586621683755753"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcCheckId"><span class="hs-identifier hs-var">tcCheckId</span></a><span> </span><a href="#local-6989586621683755752"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683755753"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-169"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755754"><a href="#local-6989586621683755754"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsUnboundVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755755"><a href="#local-6989586621683755755"><span class="hs-identifier">uv</span></a></a><span class="hs-special">)</span><span>  </span><a name="local-6989586621683755756"><a href="#local-6989586621683755756"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcUnboundId"><span class="hs-identifier hs-var">tcUnboundId</span></a><span> </span><a href="#local-6989586621683755754"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683755755"><span class="hs-identifier hs-var">uv</span></a><span> </span><a href="#local-6989586621683755756"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755757"><a href="#local-6989586621683755757"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><a name="local-6989586621683755758"><a href="#local-6989586621683755758"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcApp1"><span class="hs-identifier hs-var">tcApp1</span></a><span> </span><a href="#local-6989586621683755757"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683755758"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-172"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755759"><a href="#local-6989586621683755759"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683755760"><a href="#local-6989586621683755760"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcApp1"><span class="hs-identifier hs-var">tcApp1</span></a><span> </span><a href="#local-6989586621683755759"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683755760"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755761"><a href="#local-6989586621683755761"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><a name="local-6989586621683755762"><a href="#local-6989586621683755762"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755763"><a href="#local-6989586621683755763"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755764"><a href="#local-6989586621683755764"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755765"><a href="#local-6989586621683755765"><span class="hs-identifier">lit_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsLitType"><span class="hs-identifier hs-var">hsLitType</span></a><span> </span><a href="#local-6989586621683755763"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-176"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResult"><span class="hs-identifier hs-var">tcWrapResult</span></a><span> </span><a href="#local-6989586621683755761"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><a href="#local-6989586621683755762"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">convertLit</span><span> </span><a href="#local-6989586621683755763"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755765"><span class="hs-identifier hs-var">lit_ty</span></a><span> </span><a href="#local-6989586621683755764"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a name="local-6989586621683755766"><a href="#local-6989586621683755766"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755767"><a href="#local-6989586621683755767"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755768"><a href="#local-6989586621683755768"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755769"><a href="#local-6989586621683755769"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683755767"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755768"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-179"></a><span>                                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><a href="#local-6989586621683755766"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755769"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSCC</span><span> </span><a name="local-6989586621683755770"><a href="#local-6989586621683755770"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755771"><a href="#local-6989586621683755771"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621683755772"><a href="#local-6989586621683755772"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621683755773"><a href="#local-6989586621683755773"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755774"><a href="#local-6989586621683755774"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-182"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755775"><a href="#local-6989586621683755775"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755773"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755774"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-183"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSCC</span><span> </span><a href="#local-6989586621683755770"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755771"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621683755772"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621683755775"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTickPragma</span><span> </span><a name="local-6989586621683755776"><a href="#local-6989586621683755776"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755777"><a href="#local-6989586621683755777"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621683755778"><a href="#local-6989586621683755778"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621683755779"><a href="#local-6989586621683755779"><span class="hs-identifier">srcInfo</span></a></a><span> </span><a name="local-6989586621683755780"><a href="#local-6989586621683755780"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755781"><a href="#local-6989586621683755781"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-186"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755782"><a href="#local-6989586621683755782"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755780"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755781"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-187"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTickPragma</span><span> </span><a href="#local-6989586621683755776"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755777"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621683755778"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621683755779"><span class="hs-identifier hs-var">srcInfo</span></a><span> </span><a href="#local-6989586621683755782"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCoreAnn</span><span> </span><a name="local-6989586621683755783"><a href="#local-6989586621683755783"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755784"><a href="#local-6989586621683755784"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621683755785"><a href="#local-6989586621683755785"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621683755786"><a href="#local-6989586621683755786"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755787"><a href="#local-6989586621683755787"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755788"><a href="#local-6989586621683755788"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755786"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755787"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-191"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCoreAnn</span><span> </span><a href="#local-6989586621683755783"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755784"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621683755785"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621683755788"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><a name="local-6989586621683755789"><a href="#local-6989586621683755789"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755790"><a href="#local-6989586621683755790"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755791"><a href="#local-6989586621683755791"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-194"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755792"><a href="#local-6989586621683755792"><span class="hs-identifier">lit'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newOverloadedLit"><span class="hs-identifier hs-var">newOverloadedLit</span></a><span> </span><a href="#local-6989586621683755790"><span class="hs-identifier hs-var">lit</span></a><span> </span><a href="#local-6989586621683755791"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-195"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><a href="#local-6989586621683755789"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755792"><span class="hs-identifier hs-var">lit'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><a name="local-6989586621683755793"><a href="#local-6989586621683755793"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755794"><a href="#local-6989586621683755794"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683755795"><a href="#local-6989586621683755795"><span class="hs-identifier">neg_expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755796"><a href="#local-6989586621683755796"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755798"><a href="#local-6989586621683755798"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755799"><a href="#local-6989586621683755799"><span class="hs-identifier">neg_expr'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">NegateOrigin</span><span> </span><a href="#local-6989586621683755795"><span class="hs-identifier hs-var">neg_expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynAny</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683755796"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-200"></a><span>               </span><span class="hs-glyph">\</span><span class="hs-special">[</span><a name="local-6989586621683755797"><a href="#local-6989586621683755797"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-201"></a><span>               </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755794"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683755797"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><a href="#local-6989586621683755793"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755798"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621683755799"><span class="hs-identifier hs-var">neg_expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755800"><a href="#local-6989586621683755800"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755801"><a href="#local-6989586621683755801"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755802"><a href="#local-6989586621683755802"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">{- Implicit parameters must have a *tau-type* not a
              type scheme.  We enforce this by creating a fresh
              type variable as its type.  (Because res_ty may not
              be a tau-type.) -}</span><span>
</span><a name="line-209"></a><span>         </span><a name="local-6989586621683755808"><a href="#local-6989586621683755808"><span class="hs-identifier">ip_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>
</span><a name="line-210"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755809"><a href="#local-6989586621683755809"><span class="hs-identifier">ip_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsIPNameFS</span><span> </span><a href="#local-6989586621683755801"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755810"><a href="#local-6989586621683755810"><span class="hs-identifier">ipClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">ipClassName</span><span>
</span><a name="line-212"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755811"><a href="#local-6989586621683755811"><span class="hs-identifier">ip_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#emitWantedEvVar"><span class="hs-identifier hs-var">emitWantedEvVar</span></a><span> </span><a href="#local-6989586621683755804"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683755810"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683755809"><span class="hs-identifier hs-var">ip_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755808"><span class="hs-identifier hs-var">ip_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResult"><span class="hs-identifier hs-var">tcWrapResult</span></a><span> </span><a href="#local-6989586621683755800"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-214"></a><span>                   </span><span class="hs-special">(</span><a href="#local-6989586621683755803"><span class="hs-identifier hs-var">fromDict</span></a><span> </span><a href="#local-6989586621683755810"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><a href="#local-6989586621683755809"><span class="hs-identifier hs-var">ip_name</span></a><span> </span><a href="#local-6989586621683755808"><span class="hs-identifier hs-var">ip_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683755811"><span class="hs-identifier hs-var">ip_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>                   </span><a href="#local-6989586621683755808"><span class="hs-identifier hs-var">ip_ty</span></a><span> </span><a href="#local-6989586621683755802"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-216"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-comment">-- Coerces a dictionary for `IP &quot;x&quot; t` into `t`.</span><span>
</span><a name="line-218"></a><span>  </span><a name="local-6989586621683755803"><a href="#local-6989586621683755803"><span class="hs-identifier">fromDict</span></a></a><span> </span><a name="local-6989586621683755805"><a href="#local-6989586621683755805"><span class="hs-identifier">ipClass</span></a></a><span> </span><a name="local-6989586621683755806"><a href="#local-6989586621683755806"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755807"><a href="#local-6989586621683755807"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkWpCastR</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-219"></a><span>                          </span><span class="hs-identifier hs-var">unwrapIP</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683755805"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683755806"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621683755807"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-220"></a><span>  </span><a name="local-6989586621683755804"><a href="#local-6989586621683755804"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IPOccOrigin</span><span> </span><a href="#local-6989586621683755801"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755812"><a href="#local-6989586621683755812"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755813"><a href="#local-6989586621683755813"><span class="hs-identifier">mb_fromLabel</span></a></a><span> </span><a name="local-6989586621683755814"><a href="#local-6989586621683755814"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755815"><a href="#local-6989586621683755815"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [Type-checking overloaded labels]</span><span>
</span><a name="line-224"></a><span>         </span><a name="local-6989586621683755823"><a href="#local-6989586621683755823"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-225"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683755813"><span class="hs-identifier hs-var">mb_fromLabel</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-226"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683755824"><a href="#local-6989586621683755824"><span class="hs-identifier">fromLabel</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcExpr.html#tcExpr"><span class="hs-identifier hs-var">tcExpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755819"><span class="hs-identifier hs-var">applyFromLabel</span></a><span> </span><a href="#local-6989586621683755823"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683755824"><span class="hs-identifier hs-var">fromLabel</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755815"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-227"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755825"><a href="#local-6989586621683755825"><span class="hs-identifier">isLabelClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">isLabelClassName</span><span>
</span><a name="line-228"></a><span>                         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755826"><a href="#local-6989586621683755826"><span class="hs-identifier">alpha</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-229"></a><span>                         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755827"><a href="#local-6989586621683755827"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683755825"><span class="hs-identifier hs-var">isLabelClass</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683755818"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755826"><span class="hs-identifier hs-var">alpha</span></a><span class="hs-special">]</span><span>
</span><a name="line-230"></a><span>                         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755828"><a href="#local-6989586621683755828"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-231"></a><span>                         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755829"><a href="#local-6989586621683755829"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#emitWantedEvVar"><span class="hs-identifier hs-var">emitWantedEvVar</span></a><span> </span><a href="#local-6989586621683755817"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-6989586621683755827"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-232"></a><span>                         </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResult"><span class="hs-identifier hs-var">tcWrapResult</span></a><span> </span><a href="#local-6989586621683755812"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-233"></a><span>                                       </span><span class="hs-special">(</span><a href="#local-6989586621683755816"><span class="hs-identifier hs-var">fromDict</span></a><span> </span><a href="#local-6989586621683755827"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755828"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683755829"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>                                        </span><a href="#local-6989586621683755826"><span class="hs-identifier hs-var">alpha</span></a><span> </span><a href="#local-6989586621683755815"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-236"></a><span>  </span><span class="hs-comment">-- Coerces a dictionary for `IsLabel &quot;x&quot; t` into `t`,</span><span>
</span><a name="line-237"></a><span>  </span><span class="hs-comment">-- or `HasField &quot;x&quot; r a into `r -&gt; a`.</span><span>
</span><a name="line-238"></a><span>  </span><a name="local-6989586621683755816"><a href="#local-6989586621683755816"><span class="hs-identifier">fromDict</span></a></a><span> </span><a name="local-6989586621683755820"><a href="#local-6989586621683755820"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkWpCastR</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unwrapIP</span><span> </span><a href="#local-6989586621683755820"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-239"></a><span>  </span><a name="local-6989586621683755817"><a href="#local-6989586621683755817"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OverLabelOrigin</span><span> </span><a href="#local-6989586621683755814"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-240"></a><span>  </span><a name="local-6989586621683755818"><a href="#local-6989586621683755818"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><a href="#local-6989586621683755814"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>  </span><a name="local-6989586621683755819"><a href="#local-6989586621683755819"><span class="hs-identifier">applyFromLabel</span></a></a><span> </span><a name="local-6989586621683755821"><a href="#local-6989586621683755821"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683755822"><a href="#local-6989586621683755822"><span class="hs-identifier">fromLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-243"></a><span>    </span><span class="hs-identifier hs-var">HsAppType</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-244"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755821"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755821"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683755822"><span class="hs-identifier hs-var">fromLabel</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkEmptyWildCardBndrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755821"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTyLit</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStrTy</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><a href="#local-6989586621683755814"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLam</span><span> </span><a name="local-6989586621683755830"><a href="#local-6989586621683755830"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755831"><a href="#local-6989586621683755831"><span class="hs-identifier">match</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755832"><a href="#local-6989586621683755832"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-248"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755835"><a href="#local-6989586621683755835"><span class="hs-identifier">match'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755836"><a href="#local-6989586621683755836"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcMatchLambda"><span class="hs-identifier hs-var">tcMatchLambda</span></a><span> </span><a href="#local-6989586621683755834"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621683755833"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683755831"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621683755832"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-249"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755836"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLam</span><span> </span><a href="#local-6989586621683755830"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755835"><span class="hs-identifier hs-var">match'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-251"></a><span>    </span><a name="local-6989586621683755833"><a href="#local-6989586621683755833"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#MC"><span class="hs-identifier hs-var">MC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LambdaExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-252"></a><span>    </span><a name="local-6989586621683755834"><a href="#local-6989586621683755834"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The lambda expression&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-253"></a><span>                   </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSetDepth</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PartWay</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-254"></a><span>                           </span><span class="hs-identifier hs-var">pprMatches</span><span> </span><a href="#local-6989586621683755831"><span class="hs-identifier hs-var">match</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-255"></a><span>                        </span><span class="hs-comment">-- The pprSetDepth makes the abstraction print briefly</span><span>
</span><a name="line-256"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755837"><a href="#local-6989586621683755837"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLamCase</span><span> </span><a name="local-6989586621683755838"><a href="#local-6989586621683755838"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755839"><a href="#local-6989586621683755839"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755840"><a href="#local-6989586621683755840"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755843"><a href="#local-6989586621683755843"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755844"><a href="#local-6989586621683755844"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcMatchLambda"><span class="hs-identifier hs-var">tcMatchLambda</span></a><span> </span><a href="#local-6989586621683755841"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621683755842"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683755839"><span class="hs-identifier hs-var">matches</span></a><span> </span><a href="#local-6989586621683755840"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-261"></a><span>           </span><span class="hs-comment">-- The laziness annotation is because we don't want to fail here</span><span>
</span><a name="line-262"></a><span>           </span><span class="hs-comment">-- if there are multiple arguments</span><span>
</span><a name="line-263"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755844"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsLamCase</span><span> </span><a href="#local-6989586621683755838"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755843"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621683755841"><a href="#local-6989586621683755841"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The function&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683755837"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;requires&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-267"></a><span>    </span><a name="local-6989586621683755842"><a href="#local-6989586621683755842"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#MC"><span class="hs-identifier hs-var">MC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755845"><a href="#local-6989586621683755845"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755846"><a href="#local-6989586621683755846"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683755847"><a href="#local-6989586621683755847"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755848"><a href="#local-6989586621683755848"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755849"><a href="#local-6989586621683755849"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsSigWcType</span><span> </span><a href="#local-6989586621683755847"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755850"><a href="#local-6989586621683755850"><span class="hs-identifier">sig_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Avoid error cascade</span><span>
</span><a name="line-272"></a><span>                     </span><a href="TcSigs.html#tcUserTypeSig"><span class="hs-identifier hs-var">tcUserTypeSig</span></a><span> </span><a href="#local-6989586621683755849"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683755847"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-273"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755851"><a href="#local-6989586621683755851"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755852"><a href="#local-6989586621683755852"><span class="hs-identifier">poly_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcExprSig"><span class="hs-identifier hs-var">tcExprSig</span></a><span> </span><a href="#local-6989586621683755846"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755850"><span class="hs-identifier hs-var">sig_info</span></a><span>
</span><a name="line-274"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755853"><a href="#local-6989586621683755853"><span class="hs-identifier">expr''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683755851"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621683755847"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-275"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResult"><span class="hs-identifier hs-var">tcWrapResult</span></a><span> </span><a href="#local-6989586621683755845"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683755853"><span class="hs-identifier hs-var">expr''</span></a><span> </span><a href="#local-6989586621683755852"><span class="hs-identifier hs-var">poly_ty</span></a><span> </span><a href="#local-6989586621683755848"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">{-
Note [Type-checking overloaded labels]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Recall that we have

  module GHC.OverloadedLabels where
    class IsLabel (x :: Symbol) a where
      fromLabel :: a

We translate `#foo` to `fromLabel @&quot;foo&quot;`, where we use

 * the in-scope `fromLabel` if `RebindableSyntax` is enabled; or if not
 * `GHC.OverloadedLabels.fromLabel`.

In the `RebindableSyntax` case, the renamer will have filled in the
first field of `HsOverLabel` with the `fromLabel` function to use, and
we simply apply it to the appropriate visible type argument.

In the `OverloadedLabels` case, when we see an overloaded label like
`#foo`, we generate a fresh variable `alpha` for the type and emit an
`IsLabel &quot;foo&quot; alpha` constraint.  Because the `IsLabel` class has a
single method, it is represented by a newtype, so we can coerce
`IsLabel &quot;foo&quot; alpha` to `alpha` (just like for implicit parameters).

-}</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Infix operators and sections
*                                                                      *
************************************************************************

Note [Left sections]
~~~~~~~~~~~~~~~~~~~~
Left sections, like (4 *), are equivalent to
        \ x -&gt; (*) 4 x,
or, if PostfixOperators is enabled, just
        (*) 4
With PostfixOperators we don't actually require the function to take
two arguments at all.  For example, (x `not`) means (not x); you get
postfix operators!  Not Haskell 98, but it's less work and kind of
useful.

Note [Typing rule for ($)]
~~~~~~~~~~~~~~~~~~~~~~~~~~
People write
   runST $ blah
so much, where
   runST :: (forall s. ST s a) -&gt; a
that I have finally given in and written a special type-checking
rule just for saturated applications of ($).
  * Infer the type of the first argument
  * Decompose it; should be of form (arg2_ty -&gt; res_ty),
       where arg2_ty might be a polytype
  * Use arg2_ty to typecheck arg2

Note [Typing rule for seq]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to allow
       x `seq` (# p,q #)
which suggests this type for seq:
   seq :: forall (a:*) (b:Open). a -&gt; b -&gt; b,
with (b:Open) meaning that be can be instantiated with an unboxed
tuple.  The trouble is that this might accept a partially-applied
'seq', and I'm just not certain that would work.  I'm only sure it's
only going to work when it's fully applied, so it turns into
    case x of _ -&gt; (# p,q #)

So it seems more uniform to treat 'seq' as if it was a language
construct.

See also Note [seqId magic] in MkId
-}</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755854"><a href="#local-6989586621683755854"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><a name="local-6989586621683755855"><a href="#local-6989586621683755855"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621683755856"><a href="#local-6989586621683755856"><span class="hs-identifier">arg1</span></a></a><span> </span><a name="local-6989586621683755857"><a href="#local-6989586621683755857"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621683755858"><a href="#local-6989586621683755858"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755859"><a href="#local-6989586621683755859"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755860"><a href="#local-6989586621683755860"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755861"><a href="#local-6989586621683755861"><span class="hs-identifier">lv</span></a></a><span> </span><a name="local-6989586621683755862"><a href="#local-6989586621683755862"><span class="hs-identifier">op_name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755862"><span class="hs-identifier hs-var">op_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">seqIdKey</span><span>           </span><span class="hs-comment">-- Note [Typing rule for seq]</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755863"><a href="#local-6989586621683755863"><span class="hs-identifier">arg1_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-357"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755864"><a href="#local-6989586621683755864"><span class="hs-identifier">arg2_exp_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683755859"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-358"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755865"><a href="#local-6989586621683755865"><span class="hs-identifier">arg1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcArg"><span class="hs-identifier hs-var">tcArg</span></a><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-6989586621683755863"><span class="hs-identifier hs-var">arg1_ty</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-359"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755866"><a href="#local-6989586621683755866"><span class="hs-identifier">arg2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#funAppCtxt"><span class="hs-identifier hs-var">funAppCtxt</span></a><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683755858"><span class="hs-identifier hs-var">arg2</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-360"></a><span>                  </span><a href="TcExpr.html#tc_poly_expr_nc"><span class="hs-identifier hs-var">tc_poly_expr_nc</span></a><span> </span><a href="#local-6989586621683755858"><span class="hs-identifier hs-var">arg2</span></a><span> </span><a href="#local-6989586621683755864"><span class="hs-identifier hs-var">arg2_exp_ty</span></a><span>
</span><a name="line-361"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755867"><a href="#local-6989586621683755867"><span class="hs-identifier">arg2_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683755864"><span class="hs-identifier hs-var">arg2_exp_ty</span></a><span>
</span><a name="line-362"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755868"><a href="#local-6989586621683755868"><span class="hs-identifier">op_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683755862"><span class="hs-identifier hs-var">op_name</span></a><span>
</span><a name="line-363"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755869"><a href="#local-6989586621683755869"><span class="hs-identifier">op'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755860"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683755863"><span class="hs-identifier hs-var">arg1_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755867"><span class="hs-identifier hs-var">arg2_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755861"><span class="hs-identifier hs-var">lv</span></a><span> </span><a href="#local-6989586621683755868"><span class="hs-identifier hs-var">op_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">OpApp</span><span> </span><a href="#local-6989586621683755855"><span class="hs-identifier hs-var">fix</span></a><span> </span><a href="#local-6989586621683755865"><span class="hs-identifier hs-var">arg1'</span></a><span> </span><a href="#local-6989586621683755869"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621683755866"><span class="hs-identifier hs-var">arg2'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755870"><a href="#local-6989586621683755870"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755871"><a href="#local-6989586621683755871"><span class="hs-identifier">lv</span></a></a><span> </span><a name="local-6989586621683755872"><a href="#local-6989586621683755872"><span class="hs-identifier">op_name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755872"><span class="hs-identifier hs-var">op_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">dollarIdKey</span><span>        </span><span class="hs-comment">-- Note [Typing rule for ($)]</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Application rule&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755873"><a href="#local-6989586621683755873"><span class="hs-identifier">arg1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755874"><a href="#local-6989586621683755874"><span class="hs-identifier">arg1_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755875"><a href="#local-6989586621683755875"><span class="hs-identifier">doc</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The first argument of ($) takes&quot;</span><span>
</span><a name="line-373"></a><span>             </span><a name="local-6989586621683755876"><a href="#local-6989586621683755876"><span class="hs-identifier">orig1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-374"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755877"><a href="#local-6989586621683755877"><span class="hs-identifier">wrap_arg1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683755878"><a href="#local-6989586621683755878"><span class="hs-identifier">arg2_sigma</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683755879"><a href="#local-6989586621683755879"><span class="hs-identifier">op_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-375"></a><span>           </span><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier hs-var">matchActualFunTys</span></a><span> </span><a href="#local-6989586621683755875"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621683755876"><span class="hs-identifier hs-var">orig1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621683755874"><span class="hs-identifier hs-var">arg1_ty</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>         </span><span class="hs-comment">-- We have (arg1 $ arg2)</span><span>
</span><a name="line-378"></a><span>         </span><span class="hs-comment">-- So: arg1_ty = arg2_ty -&gt; op_res_ty</span><span>
</span><a name="line-379"></a><span>         </span><span class="hs-comment">-- where arg2_sigma maybe polymorphic; that's the point</span><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755880"><a href="#local-6989586621683755880"><span class="hs-identifier">arg2'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcArg"><span class="hs-identifier hs-var">tcArg</span></a><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683755858"><span class="hs-identifier hs-var">arg2</span></a><span> </span><a href="#local-6989586621683755878"><span class="hs-identifier hs-var">arg2_sigma</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span>       </span><span class="hs-comment">-- Make sure that the argument type has kind '*'</span><span>
</span><a name="line-384"></a><span>       </span><span class="hs-comment">--   ($) :: forall (r:RuntimeRep) (a:*) (b:TYPE r). (a-&gt;b) -&gt; a -&gt; b</span><span>
</span><a name="line-385"></a><span>       </span><span class="hs-comment">-- Eg we do not want to allow  (D#  $  4.0#)   Trac #5570</span><span>
</span><a name="line-386"></a><span>       </span><span class="hs-comment">--    (which gives a seg fault)</span><span>
</span><a name="line-387"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-388"></a><span>       </span><span class="hs-comment">-- The *result* type can have any kind (Trac #8739),</span><span>
</span><a name="line-389"></a><span>       </span><span class="hs-comment">-- so we don't need to check anything for that</span><span>
</span><a name="line-390"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyKind"><span class="hs-identifier hs-var">unifyKind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsType</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">NHsCoreTy</span><span> </span><a href="#local-6989586621683755878"><span class="hs-identifier hs-var">arg2_sigma</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621683755878"><span class="hs-identifier hs-var">arg2_sigma</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-392"></a><span>           </span><span class="hs-comment">-- ignore the evidence. arg2_sigma must have type * or #,</span><span>
</span><a name="line-393"></a><span>           </span><span class="hs-comment">-- because we know arg2_sigma -&gt; or_res_ty is well-kinded</span><span>
</span><a name="line-394"></a><span>           </span><span class="hs-comment">-- (because otherwise matchActualFunTys would fail)</span><span>
</span><a name="line-395"></a><span>           </span><span class="hs-comment">-- There's no possibility here of, say, a kind family reducing to *.</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755881"><a href="#local-6989586621683755881"><span class="hs-identifier">wrap_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span> </span><a href="#local-6989586621683755876"><span class="hs-identifier hs-var">orig1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683755854"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755879"><span class="hs-identifier hs-var">op_res_ty</span></a><span> </span><a href="#local-6989586621683755859"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-398"></a><span>                       </span><span class="hs-comment">-- op_res -&gt; res</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755882"><a href="#local-6989586621683755882"><span class="hs-identifier">op_id</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683755872"><span class="hs-identifier hs-var">op_name</span></a><span>
</span><a name="line-401"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755883"><a href="#local-6989586621683755883"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683755859"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-402"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755884"><a href="#local-6989586621683755884"><span class="hs-identifier">op'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755870"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">getRuntimeRep</span><span> </span><a href="#local-6989586621683755883"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-403"></a><span>                                               </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755878"><span class="hs-identifier hs-var">arg2_sigma</span></a><span>
</span><a name="line-404"></a><span>                                               </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755883"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755871"><span class="hs-identifier hs-var">lv</span></a><span> </span><a href="#local-6989586621683755882"><span class="hs-identifier hs-var">op_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>             </span><span class="hs-comment">-- arg1' :: arg1_ty</span><span>
</span><a name="line-407"></a><span>             </span><span class="hs-comment">-- wrap_arg1 :: arg1_ty &quot;-&gt;&quot; (arg2_sigma -&gt; op_res_ty)</span><span>
</span><a name="line-408"></a><span>             </span><span class="hs-comment">-- wrap_res :: op_res_ty &quot;-&gt;&quot; res_ty</span><span>
</span><a name="line-409"></a><span>             </span><span class="hs-comment">-- op' :: (a2_ty -&gt; res_ty) -&gt; a2_ty -&gt; res_ty</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span>             </span><span class="hs-comment">-- wrap1 :: arg1_ty &quot;-&gt;&quot; (arg2_sigma -&gt; res_ty)</span><span>
</span><a name="line-412"></a><span>             </span><a name="local-6989586621683755885"><a href="#local-6989586621683755885"><span class="hs-identifier">wrap1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpFun</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span> </span><a href="#local-6989586621683755881"><span class="hs-identifier hs-var">wrap_res</span></a><span> </span><a href="#local-6989586621683755878"><span class="hs-identifier hs-var">arg2_sigma</span></a><span> </span><a href="#local-6989586621683755883"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683755886"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-413"></a><span>                     </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683755877"><span class="hs-identifier hs-var">wrap_arg1</span></a><span>
</span><a name="line-414"></a><span>             </span><a name="local-6989586621683755886"><a href="#local-6989586621683755886"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When looking at the argument to ($)&quot;</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><a href="#local-6989586621683755855"><span class="hs-identifier hs-var">fix</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683755885"><span class="hs-identifier hs-var">wrap1</span></a><span> </span><a href="#local-6989586621683755873"><span class="hs-identifier hs-var">arg1'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755884"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621683755880"><span class="hs-identifier hs-var">arg2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755887"><a href="#local-6989586621683755887"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ambiguous</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755888"><a href="#local-6989586621683755888"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-419"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683755889"><a href="#local-6989586621683755889"><span class="hs-identifier">sig_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#obviousSig"><span class="hs-identifier hs-var">obviousSig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>    </span><span class="hs-comment">-- See Note [Disambiguating record fields]</span><span>
</span><a name="line-421"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755890"><a href="#local-6989586621683755890"><span class="hs-identifier">sig_tc_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsSigWcType"><span class="hs-identifier hs-var">tcHsSigWcType</span></a><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span> </span><a href="#local-6989586621683755889"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-422"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755891"><a href="#local-6989586621683755891"><span class="hs-identifier">sel_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#disambiguateSelector"><span class="hs-identifier hs-var">disambiguateSelector</span></a><span> </span><a href="#local-6989586621683755888"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621683755890"><span class="hs-identifier hs-var">sig_tc_ty</span></a><span>
</span><a name="line-423"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755892"><a href="#local-6989586621683755892"><span class="hs-identifier">op'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755887"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a href="#local-6989586621683755891"><span class="hs-identifier hs-var">sel_name</span></a><span> </span><a href="#local-6989586621683755888"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcExpr"><span class="hs-identifier hs-var">tcExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><a href="#local-6989586621683755855"><span class="hs-identifier hs-var">fix</span></a><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-6989586621683755892"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621683755858"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755859"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-425"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-428"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Non Application rule&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755893"><a href="#local-6989586621683755893"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755894"><a href="#local-6989586621683755894"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683755895"><a href="#local-6989586621683755895"><span class="hs-identifier">arg1'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683755896"><a href="#local-6989586621683755896"><span class="hs-identifier">arg2'</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcApp"><span class="hs-identifier hs-var">tcApp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcExpr.html#mk_op_msg"><span class="hs-identifier hs-var">mk_op_msg</span></a><span> </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>                     </span><a href="#local-6989586621683755857"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683755856"><span class="hs-identifier hs-var">arg1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683755858"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683755859"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-432"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755893"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">OpApp</span><span> </span><a href="#local-6989586621683755855"><span class="hs-identifier hs-var">fix</span></a><span> </span><a href="#local-6989586621683755895"><span class="hs-identifier hs-var">arg1'</span></a><span> </span><a href="#local-6989586621683755894"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621683755896"><span class="hs-identifier hs-var">arg2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-comment">-- Right sections, equivalent to \ x -&gt; x `op` expr, or</span><span>
</span><a name="line-435"></a><span class="hs-comment">--      \ x -&gt; op x expr</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755897"><a href="#local-6989586621683755897"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><a name="local-6989586621683755898"><a href="#local-6989586621683755898"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755899"><a href="#local-6989586621683755899"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621683755900"><a href="#local-6989586621683755900"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755901"><a href="#local-6989586621683755901"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-438"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755903"><a href="#local-6989586621683755903"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755904"><a href="#local-6989586621683755904"><span class="hs-identifier">op_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferFun"><span class="hs-identifier hs-var">tcInferFun</span></a><span> </span><a href="#local-6989586621683755899"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-439"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755905"><a href="#local-6989586621683755905"><span class="hs-identifier">wrap_fun</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683755906"><a href="#local-6989586621683755906"><span class="hs-identifier">arg1_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755907"><a href="#local-6989586621683755907"><span class="hs-identifier">arg2_ty</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683755908"><a href="#local-6989586621683755908"><span class="hs-identifier">op_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>                  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier hs-var">matchActualFunTys</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#mk_op_msg"><span class="hs-identifier hs-var">mk_op_msg</span></a><span> </span><a href="#local-6989586621683755899"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755902"><span class="hs-identifier hs-var">fn_orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683755899"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621683755904"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-441"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755909"><a href="#local-6989586621683755909"><span class="hs-identifier">wrap_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span> </span><span class="hs-identifier hs-var">SectionOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683755897"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683755906"><span class="hs-identifier hs-var">arg1_ty</span></a><span> </span><a href="#local-6989586621683755908"><span class="hs-identifier hs-var">op_res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755901"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-443"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755910"><a href="#local-6989586621683755910"><span class="hs-identifier">arg2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcArg"><span class="hs-identifier hs-var">tcArg</span></a><span> </span><a href="#local-6989586621683755899"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683755900"><span class="hs-identifier hs-var">arg2</span></a><span> </span><a href="#local-6989586621683755907"><span class="hs-identifier hs-var">arg2_ty</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-444"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755909"><span class="hs-identifier hs-var">wrap_res</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-445"></a><span>                  </span><span class="hs-identifier hs-var">SectionR</span><span> </span><a href="#local-6989586621683755898"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683755905"><span class="hs-identifier hs-var">wrap_fun</span></a><span> </span><a href="#local-6989586621683755903"><span class="hs-identifier hs-var">op'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755910"><span class="hs-identifier hs-var">arg2'</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-447"></a><span>    </span><a name="local-6989586621683755902"><a href="#local-6989586621683755902"><span class="hs-identifier">fn_orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683755899"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-448"></a><span>    </span><span class="hs-comment">-- It's important to use the origin of 'op', so that call-stacks</span><span>
</span><a name="line-449"></a><span>    </span><span class="hs-comment">-- come out right; they are driven by the OccurrenceOf CtOrigin</span><span>
</span><a name="line-450"></a><span>    </span><span class="hs-comment">-- See Trac #13285</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755911"><a href="#local-6989586621683755911"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><a name="local-6989586621683755912"><a href="#local-6989586621683755912"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755913"><a href="#local-6989586621683755913"><span class="hs-identifier">arg1</span></a></a><span> </span><a name="local-6989586621683755914"><a href="#local-6989586621683755914"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755915"><a href="#local-6989586621683755915"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-453"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755917"><a href="#local-6989586621683755917"><span class="hs-identifier">op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755918"><a href="#local-6989586621683755918"><span class="hs-identifier">op_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferFun"><span class="hs-identifier hs-var">tcInferFun</span></a><span> </span><a href="#local-6989586621683755914"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-454"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755919"><a href="#local-6989586621683755919"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>      </span><span class="hs-comment">-- Note [Left sections]</span><span>
</span><a name="line-455"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755920"><a href="#local-6989586621683755920"><span class="hs-identifier">n_reqd_args</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.PostfixOperators</span><span> </span><a href="#local-6989586621683755919"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-456"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755921"><a href="#local-6989586621683755921"><span class="hs-identifier">wrap_fn</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755922"><a href="#local-6989586621683755922"><span class="hs-identifier">arg1_ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683755923"><a href="#local-6989586621683755923"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683755924"><a href="#local-6989586621683755924"><span class="hs-identifier">op_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier hs-var">matchActualFunTys</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#mk_op_msg"><span class="hs-identifier hs-var">mk_op_msg</span></a><span> </span><a href="#local-6989586621683755914"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755916"><span class="hs-identifier hs-var">fn_orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683755914"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>                                </span><a href="#local-6989586621683755920"><span class="hs-identifier hs-var">n_reqd_args</span></a><span> </span><a href="#local-6989586621683755918"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-461"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755925"><a href="#local-6989586621683755925"><span class="hs-identifier">wrap_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span> </span><span class="hs-identifier hs-var">SectionOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683755911"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621683755923"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621683755924"><span class="hs-identifier hs-var">op_res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755915"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-463"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755926"><a href="#local-6989586621683755926"><span class="hs-identifier">arg1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcArg"><span class="hs-identifier hs-var">tcArg</span></a><span> </span><a href="#local-6989586621683755914"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683755913"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-6989586621683755922"><span class="hs-identifier hs-var">arg1_ty</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-464"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755925"><span class="hs-identifier hs-var">wrap_res</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-465"></a><span>                  </span><span class="hs-identifier hs-var">SectionL</span><span> </span><a href="#local-6989586621683755912"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755926"><span class="hs-identifier hs-var">arg1'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683755921"><span class="hs-identifier hs-var">wrap_fn</span></a><span> </span><a href="#local-6989586621683755917"><span class="hs-identifier hs-var">op'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-467"></a><span>    </span><a name="local-6989586621683755916"><a href="#local-6989586621683755916"><span class="hs-identifier">fn_orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683755914"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-468"></a><span>    </span><span class="hs-comment">-- It's important to use the origin of 'op', so that call-stacks</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-comment">-- come out right; they are driven by the OccurrenceOf CtOrigin</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-comment">-- See Trac #13285</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683755927"><a href="#local-6989586621683755927"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><a name="local-6989586621683755928"><a href="#local-6989586621683755928"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755929"><a href="#local-6989586621683755929"><span class="hs-identifier">tup_args</span></a></a><span> </span><a name="local-6989586621683755930"><a href="#local-6989586621683755930"><span class="hs-identifier">boxity</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755931"><a href="#local-6989586621683755931"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-473"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">tupArgPresent</span><span> </span><a href="#local-6989586621683755929"><span class="hs-identifier hs-var">tup_args</span></a><span>
</span><a name="line-474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755932"><a href="#local-6989586621683755932"><span class="hs-identifier">arity</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683755929"><span class="hs-identifier hs-var">tup_args</span></a><span>
</span><a name="line-475"></a><span>             </span><a name="local-6989586621683755933"><a href="#local-6989586621683755933"><span class="hs-identifier">tup_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tupleTyCon</span><span> </span><a href="#local-6989586621683755930"><span class="hs-identifier hs-var">boxity</span></a><span> </span><a href="#local-6989586621683755932"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-476"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755934"><a href="#local-6989586621683755934"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683755931"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-477"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755935"><a href="#local-6989586621683755935"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755936"><a href="#local-6989586621683755936"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="#local-6989586621683755933"><span class="hs-identifier hs-var">tup_tc</span></a><span> </span><a href="#local-6989586621683755934"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-478"></a><span>                           </span><span class="hs-comment">-- Unboxed tuples have RuntimeRep vars, which we</span><span>
</span><a name="line-479"></a><span>                           </span><span class="hs-comment">-- don't care about here</span><span>
</span><a name="line-480"></a><span>                           </span><span class="hs-comment">-- See Note [Unboxed tuple RuntimeRep vars] in TyCon</span><span>
</span><a name="line-481"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755937"><a href="#local-6989586621683755937"><span class="hs-identifier">arg_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683755930"><span class="hs-identifier hs-var">boxity</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621683755932"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683755936"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-482"></a><span>                                       </span><span class="hs-identifier hs-var">Boxed</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683755936"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-483"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755938"><a href="#local-6989586621683755938"><span class="hs-identifier">tup_args1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcTupArgs"><span class="hs-identifier hs-var">tcTupArgs</span></a><span> </span><a href="#local-6989586621683755929"><span class="hs-identifier hs-var">tup_args</span></a><span> </span><a href="#local-6989586621683755937"><span class="hs-identifier hs-var">arg_tys'</span></a><span>
</span><a name="line-484"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrapCo</span><span> </span><a href="#local-6989586621683755935"><span class="hs-identifier hs-var">coi</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><a href="#local-6989586621683755928"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755938"><span class="hs-identifier hs-var">tup_args1</span></a><span> </span><a href="#local-6989586621683755930"><span class="hs-identifier hs-var">boxity</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-487"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- The tup_args are a mixture of Present and Missing (for tuple sections)</span><span>
</span><a name="line-488"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755939"><a href="#local-6989586621683755939"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683755929"><span class="hs-identifier hs-var">tup_args</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755940"><a href="#local-6989586621683755940"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683755930"><span class="hs-identifier hs-var">boxity</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-491"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Boxed</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newFlexiTyVarTys"><span class="hs-identifier hs-var">newFlexiTyVarTys</span></a><span> </span><a href="#local-6989586621683755939"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-492"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621683755939"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-493"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755941"><a href="#local-6989586621683755941"><span class="hs-identifier">actual_res_ty</span></a></a><span>
</span><a name="line-494"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683755942"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755942"><a href="#local-6989586621683755942"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683755940"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683755929"><span class="hs-identifier hs-var">tup_args</span></a><span class="hs-special">]</span><span>
</span><a name="line-495"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTupleTy</span><span> </span><a href="#local-6989586621683755930"><span class="hs-identifier hs-var">boxity</span></a><span> </span><a href="#local-6989586621683755940"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755943"><a href="#local-6989586621683755943"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Shouldn'tHappenOrigin</span><span> </span><span class="hs-string">&quot;ExpTuple&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683755927"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>                             </span><a href="#local-6989586621683755941"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683755931"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>       </span><span class="hs-comment">-- Handle tuple sections where</span><span>
</span><a name="line-502"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755944"><a href="#local-6989586621683755944"><span class="hs-identifier">tup_args1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcTupArgs"><span class="hs-identifier hs-var">tcTupArgs</span></a><span> </span><a href="#local-6989586621683755929"><span class="hs-identifier hs-var">tup_args</span></a><span> </span><a href="#local-6989586621683755940"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683755943"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><a href="#local-6989586621683755928"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755944"><span class="hs-identifier hs-var">tup_args1</span></a><span> </span><a href="#local-6989586621683755930"><span class="hs-identifier hs-var">boxity</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755945"><a href="#local-6989586621683755945"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621683755946"><a href="#local-6989586621683755946"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621683755947"><a href="#local-6989586621683755947"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755948"><a href="#local-6989586621683755948"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-507"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755949"><a href="#local-6989586621683755949"><span class="hs-identifier">sum_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sumTyCon</span><span> </span><a href="#local-6989586621683755946"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-508"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755950"><a href="#local-6989586621683755950"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683755948"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-509"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755951"><a href="#local-6989586621683755951"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755952"><a href="#local-6989586621683755952"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="#local-6989586621683755949"><span class="hs-identifier hs-var">sum_tc</span></a><span> </span><a href="#local-6989586621683755950"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-510"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Drop levity vars, we don't care about them here</span><span>
</span><a name="line-511"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683755953"><a href="#local-6989586621683755953"><span class="hs-identifier">arg_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621683755946"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683755952"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-512"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755954"><a href="#local-6989586621683755954"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683755947"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755953"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">getNth</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755945"><span class="hs-identifier hs-var">alt</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrapCo</span><span> </span><a href="#local-6989586621683755951"><span class="hs-identifier hs-var">coi</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><a href="#local-6989586621683755953"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><a href="#local-6989586621683755945"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621683755946"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683755954"><span class="hs-identifier hs-var">expr'</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683755955"><a href="#local-6989586621683755955"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621683755956"><a href="#local-6989586621683755956"><span class="hs-identifier">exprs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755957"><a href="#local-6989586621683755957"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-516"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683755955"><span class="hs-identifier hs-var">witness</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-517"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755961"><a href="#local-6989586621683755961"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683755957"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-518"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755962"><a href="#local-6989586621683755962"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755963"><a href="#local-6989586621683755963"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span> </span><a href="#local-6989586621683755961"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-519"></a><span>                       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755964"><a href="#local-6989586621683755964"><span class="hs-identifier">exprs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755958"><span class="hs-identifier hs-var">tc_elt</span></a><span> </span><a href="#local-6989586621683755963"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755956"><span class="hs-identifier hs-var">exprs</span></a><span>
</span><a name="line-520"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-521"></a><span>                         </span><span class="hs-identifier hs-var">mkHsWrapCo</span><span> </span><a href="#local-6989586621683755962"><span class="hs-identifier hs-var">coi</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a href="#local-6989586621683755963"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683755964"><span class="hs-identifier hs-var">exprs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683755965"><a href="#local-6989586621683755965"><span class="hs-identifier">fln</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683755968"><a href="#local-6989586621683755968"><span class="hs-identifier">exprs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755969"><a href="#local-6989586621683755969"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683755970"><a href="#local-6989586621683755970"><span class="hs-identifier">fln'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>                         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">ListOrigin</span><span> </span><a href="#local-6989586621683755965"><span class="hs-identifier hs-var">fln</span></a><span>
</span><a name="line-525"></a><span>                                       </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><span class="hs-identifier hs-var">intTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynList</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683755957"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-526"></a><span>                            </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683755966"><a href="#local-6989586621683755966"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-527"></a><span>                            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755967"><a href="#local-6989586621683755967"><span class="hs-identifier">exprs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-528"></a><span>                                    </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755958"><span class="hs-identifier hs-var">tc_elt</span></a><span> </span><a href="#local-6989586621683755966"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755956"><span class="hs-identifier hs-var">exprs</span></a><span>
</span><a name="line-529"></a><span>                               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755967"><span class="hs-identifier hs-var">exprs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683755966"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a href="#local-6989586621683755969"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683755970"><span class="hs-identifier hs-var">fln'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755968"><span class="hs-identifier hs-var">exprs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-532"></a><span>     </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683755958"><a href="#local-6989586621683755958"><span class="hs-identifier">tc_elt</span></a></a><span> </span><a name="local-6989586621683755959"><a href="#local-6989586621683755959"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621683755960"><a href="#local-6989586621683755960"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683755960"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755959"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Let, case, if, do
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLet</span><span> </span><a name="local-6989586621683755971"><a href="#local-6989586621683755971"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683755972"><a href="#local-6989586621683755972"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683755973"><a href="#local-6989586621683755973"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755974"><a href="#local-6989586621683755974"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755975"><a href="#local-6989586621683755975"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-543"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683755976"><a href="#local-6989586621683755976"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755977"><a href="#local-6989586621683755977"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcLocalBinds"><span class="hs-identifier hs-var">tcLocalBinds</span></a><span> </span><a href="#local-6989586621683755973"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-544"></a><span>                             </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755974"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683755975"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-545"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLet</span><span> </span><a href="#local-6989586621683755971"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683755972"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683755976"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683755977"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCase</span><span> </span><a name="local-6989586621683755978"><a href="#local-6989586621683755978"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683755979"><a href="#local-6989586621683755979"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621683755980"><a href="#local-6989586621683755980"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755981"><a href="#local-6989586621683755981"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- We used to typecheck the case alternatives first.</span><span>
</span><a name="line-549"></a><span>           </span><span class="hs-comment">-- The case patterns tend to give good type info to use</span><span>
</span><a name="line-550"></a><span>           </span><span class="hs-comment">-- when typechecking the scrutinee.  For example</span><span>
</span><a name="line-551"></a><span>           </span><span class="hs-comment">--   case (map f) of</span><span>
</span><a name="line-552"></a><span>           </span><span class="hs-comment">--     (x:xs) -&gt; ...</span><span>
</span><a name="line-553"></a><span>           </span><span class="hs-comment">-- will report that map is applied to too few arguments</span><span>
</span><a name="line-554"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-555"></a><span>           </span><span class="hs-comment">-- But now, in the GADT world, we need to typecheck the scrutinee</span><span>
</span><a name="line-556"></a><span>           </span><span class="hs-comment">-- first, to get type info that may be refined in the case alternatives</span><span>
</span><a name="line-557"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621683755983"><a href="#local-6989586621683755983"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683755984"><a href="#local-6989586621683755984"><span class="hs-identifier">scrut_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferRho"><span class="hs-identifier hs-var">tcInferRho</span></a><span> </span><a href="#local-6989586621683755979"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;HsCase&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683755984"><span class="hs-identifier hs-var">scrut_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755985"><a href="#local-6989586621683755985"><span class="hs-identifier">matches'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcMatchesCase"><span class="hs-identifier hs-var">tcMatchesCase</span></a><span> </span><a href="#local-6989586621683755982"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683755984"><span class="hs-identifier hs-var">scrut_ty</span></a><span> </span><a href="#local-6989586621683755980"><span class="hs-identifier hs-var">matches</span></a><span> </span><a href="#local-6989586621683755981"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-561"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCase</span><span> </span><a href="#local-6989586621683755978"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683755983"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621683755985"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-562"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-563"></a><span>    </span><a name="local-6989586621683755982"><a href="#local-6989586621683755982"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#MC"><span class="hs-identifier hs-var">MC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span class="hs-special">,</span><span>
</span><a name="line-564"></a><span>                      </span><span class="hs-identifier">mc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><a name="local-6989586621683755986"><a href="#local-6989586621683755986"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621683755987"><a href="#local-6989586621683755987"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621683755988"><a href="#local-6989586621683755988"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-6989586621683755989"><a href="#local-6989586621683755989"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755990"><a href="#local-6989586621683755990"><span class="hs-identifier">res_ty</span></a></a><span>    </span><span class="hs-comment">-- Ordinary 'if'</span><span>
</span><a name="line-567"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683755991"><a href="#local-6989586621683755991"><span class="hs-identifier">pred'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755987"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755992"><a href="#local-6989586621683755992"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tauifyExpType"><span class="hs-identifier hs-var">tauifyExpType</span></a><span> </span><a href="#local-6989586621683755990"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-569"></a><span>           </span><span class="hs-comment">-- Just like Note [Case branches must never infer a non-tau type]</span><span>
</span><a name="line-570"></a><span>           </span><span class="hs-comment">-- in TcMatches (See #10619)</span><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755993"><a href="#local-6989586621683755993"><span class="hs-identifier">b1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755988"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-6989586621683755992"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-573"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683755994"><a href="#local-6989586621683755994"><span class="hs-identifier">b2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683755989"><span class="hs-identifier hs-var">b2</span></a><span> </span><a href="#local-6989586621683755992"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-574"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><a href="#local-6989586621683755986"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683755991"><span class="hs-identifier hs-var">pred'</span></a><span> </span><a href="#local-6989586621683755993"><span class="hs-identifier hs-var">b1'</span></a><span> </span><a href="#local-6989586621683755994"><span class="hs-identifier hs-var">b2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><a name="local-6989586621683755995"><a href="#local-6989586621683755995"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683755996"><a href="#local-6989586621683755996"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683755997"><a href="#local-6989586621683755997"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621683755998"><a href="#local-6989586621683755998"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-6989586621683755999"><a href="#local-6989586621683755999"><span class="hs-identifier">b2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756000"><a href="#local-6989586621683756000"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-577"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683756007"><a href="#local-6989586621683756007"><span class="hs-identifier">pred'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756008"><a href="#local-6989586621683756008"><span class="hs-identifier">b1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756009"><a href="#local-6989586621683756009"><span class="hs-identifier">b2'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756010"><a href="#local-6989586621683756010"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">IfOrigin</span><span> </span><a href="#local-6989586621683755996"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynAny</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynAny</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynAny</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683756000"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-579"></a><span>              </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683756001"><a href="#local-6989586621683756001"><span class="hs-identifier">pred_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756002"><a href="#local-6989586621683756002"><span class="hs-identifier">b1_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756003"><a href="#local-6989586621683756003"><span class="hs-identifier">b2_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-580"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756004"><a href="#local-6989586621683756004"><span class="hs-identifier">pred'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683755997"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621683756001"><span class="hs-identifier hs-var">pred_ty</span></a><span>
</span><a name="line-581"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756005"><a href="#local-6989586621683756005"><span class="hs-identifier">b1'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683755998"><span class="hs-identifier hs-var">b1</span></a><span>   </span><a href="#local-6989586621683756002"><span class="hs-identifier hs-var">b1_ty</span></a><span>
</span><a name="line-582"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756006"><a href="#local-6989586621683756006"><span class="hs-identifier">b2'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683755999"><span class="hs-identifier hs-var">b2</span></a><span>   </span><a href="#local-6989586621683756003"><span class="hs-identifier hs-var">b2_ty</span></a><span>
</span><a name="line-583"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756004"><span class="hs-identifier hs-var">pred'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756005"><span class="hs-identifier hs-var">b1'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756006"><span class="hs-identifier hs-var">b2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-584"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><a href="#local-6989586621683755995"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756010"><span class="hs-identifier hs-var">fun'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756007"><span class="hs-identifier hs-var">pred'</span></a><span> </span><a href="#local-6989586621683756008"><span class="hs-identifier hs-var">b1'</span></a><span> </span><a href="#local-6989586621683756009"><span class="hs-identifier hs-var">b2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsMultiIf</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756011"><a href="#local-6989586621683756011"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756012"><a href="#local-6989586621683756012"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-587"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756014"><a href="#local-6989586621683756014"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isSingleton</span><span> </span><a href="#local-6989586621683756011"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-588"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756012"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-589"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><a href="TcMType.html#tauifyExpType"><span class="hs-identifier hs-var">tauifyExpType</span></a><span> </span><a href="#local-6989586621683756012"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-590"></a><span>             </span><span class="hs-comment">-- Just like TcMatches</span><span>
</span><a name="line-591"></a><span>             </span><span class="hs-comment">-- Note [Case branches must never infer a non-tau type]</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756015"><a href="#local-6989586621683756015"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcMatches.html#tcGRHS"><span class="hs-identifier hs-var">tcGRHS</span></a><span> </span><a href="#local-6989586621683756013"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683756014"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756011"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-594"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756016"><a href="#local-6989586621683756016"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683756014"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-595"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsMultiIf</span><span> </span><a href="#local-6989586621683756016"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683756015"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-596"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683756013"><a href="#local-6989586621683756013"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#MC"><span class="hs-identifier hs-var">MC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfAlt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756017"><a href="#local-6989586621683756017"><span class="hs-identifier">do_or_lc</span></a></a><span> </span><a name="local-6989586621683756018"><a href="#local-6989586621683756018"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756019"><a href="#local-6989586621683756019"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-599"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756020"><a href="#local-6989586621683756020"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcDoStmts"><span class="hs-identifier hs-var">tcDoStmts</span></a><span> </span><a href="#local-6989586621683756017"><span class="hs-identifier hs-var">do_or_lc</span></a><span> </span><a href="#local-6989586621683756018"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683756019"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-600"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756020"><span class="hs-identifier hs-var">expr'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsProc</span><span> </span><a name="local-6989586621683756021"><a href="#local-6989586621683756021"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683756022"><a href="#local-6989586621683756022"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683756023"><a href="#local-6989586621683756023"><span class="hs-identifier">cmd</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756024"><a href="#local-6989586621683756024"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756025"><a href="#local-6989586621683756025"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756026"><a href="#local-6989586621683756026"><span class="hs-identifier">cmd'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756027"><a href="#local-6989586621683756027"><span class="hs-identifier">coi</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcArrows.html#tcProc"><span class="hs-identifier hs-var">tcProc</span></a><span> </span><a href="#local-6989586621683756022"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683756023"><span class="hs-identifier hs-var">cmd</span></a><span> </span><a href="#local-6989586621683756024"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-604"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrapCo</span><span> </span><a href="#local-6989586621683756027"><span class="hs-identifier hs-var">coi</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsProc</span><span> </span><a href="#local-6989586621683756021"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683756025"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683756026"><span class="hs-identifier hs-var">cmd'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-comment">-- Typechecks the static form and wraps it with a call to 'fromStaticPtr'.</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- See Note [Grand plan for static forms] in StaticPtrTable for an overview.</span><span>
</span><a name="line-608"></a><span class="hs-comment">-- To type check</span><span>
</span><a name="line-609"></a><span class="hs-comment">--      (static e) :: p a</span><span>
</span><a name="line-610"></a><span class="hs-comment">-- we want to check (e :: a),</span><span>
</span><a name="line-611"></a><span class="hs-comment">-- and wrap (static e) in a call to</span><span>
</span><a name="line-612"></a><span class="hs-comment">--    fromStaticPtr :: IsStatic p =&gt; StaticPtr a -&gt; p a</span><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStatic</span><span> </span><a name="local-6989586621683756028"><a href="#local-6989586621683756028"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621683756029"><a href="#local-6989586621683756029"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756030"><a href="#local-6989586621683756030"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-615"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756031"><a href="#local-6989586621683756031"><span class="hs-identifier">res_ty</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683756030"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-616"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756032"><a href="#local-6989586621683756032"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756033"><a href="#local-6989586621683756033"><span class="hs-identifier">p_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756034"><a href="#local-6989586621683756034"><span class="hs-identifier">expr_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedAppTy"><span class="hs-identifier hs-var">matchExpectedAppTy</span></a><span> </span><a href="#local-6989586621683756031"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-617"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756035"><a href="#local-6989586621683756035"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756036"><a href="#local-6989586621683756036"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-618"></a><span>            </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the body of a static form:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>                             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756029"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>                       </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-621"></a><span>            </span><a href="TcExpr.html#tcPolyExprNC"><span class="hs-identifier hs-var">tcPolyExprNC</span></a><span> </span><a href="#local-6989586621683756029"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756034"><span class="hs-identifier hs-var">expr_ty</span></a><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span>        </span><span class="hs-comment">-- Check that the free variables of the static form are closed.</span><span>
</span><a name="line-624"></a><span>        </span><span class="hs-comment">-- It's OK to use nonDetEltsUniqSet here as the only side effects of</span><span>
</span><a name="line-625"></a><span>        </span><span class="hs-comment">-- checkClosedInStaticForm are error messages.</span><span>
</span><a name="line-626"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="TcExpr.html#checkClosedInStaticForm"><span class="hs-identifier hs-var">checkClosedInStaticForm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621683756028"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span>        </span><span class="hs-comment">-- Require the type of the argument to be Typeable.</span><span>
</span><a name="line-629"></a><span>        </span><span class="hs-comment">-- The evidence is not used, but asking the constraint ensures that</span><span>
</span><a name="line-630"></a><span>        </span><span class="hs-comment">-- the current implementation is as restrictive as future versions</span><span>
</span><a name="line-631"></a><span>        </span><span class="hs-comment">-- of the StaticPointers extension.</span><span>
</span><a name="line-632"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756037"><a href="#local-6989586621683756037"><span class="hs-identifier">typeableClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">typeableClassName</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#emitWantedEvVar"><span class="hs-identifier hs-var">emitWantedEvVar</span></a><span> </span><span class="hs-identifier hs-var">StaticOrigin</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-634"></a><span>                  </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621683756037"><span class="hs-identifier hs-var">typeableClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>                             </span><span class="hs-special">[</span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756034"><span class="hs-identifier hs-var">expr_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>        </span><span class="hs-comment">-- Insert the constraints of the static form in a global list for later</span><span>
</span><a name="line-638"></a><span>        </span><span class="hs-comment">-- validation.</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitStaticConstraints"><span class="hs-identifier hs-var">emitStaticConstraints</span></a><span> </span><a href="#local-6989586621683756036"><span class="hs-identifier hs-var">lie</span></a><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span>        </span><span class="hs-comment">-- Wrap the static form with the 'fromStaticPtr' call.</span><span>
</span><a name="line-642"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756038"><a href="#local-6989586621683756038"><span class="hs-identifier">fromStaticPtr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><span class="hs-identifier hs-var">StaticOrigin</span><span> </span><span class="hs-identifier hs-var">fromStaticPtrName</span><span> </span><a href="#local-6989586621683756033"><span class="hs-identifier hs-var">p_ty</span></a><span>
</span><a name="line-643"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756039"><a href="#local-6989586621683756039"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756034"><span class="hs-identifier hs-var">expr_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-644"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756040"><a href="#local-6989586621683756040"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-645"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrapCo</span><span> </span><a href="#local-6989586621683756032"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-646"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756040"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756039"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683756038"><span class="hs-identifier hs-var">fromStaticPtr</span></a><span class="hs-special">)</span><span>
</span><a name="line-647"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756040"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStatic</span><span> </span><a href="#local-6989586621683756028"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621683756035"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Record construction and update
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683756041"><a href="#local-6989586621683756041"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756042"><a href="#local-6989586621683756042"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683756043"><a href="#local-6989586621683756043"><span class="hs-identifier">con_name</span></a></a><span>
</span><a name="line-659"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756044"><a href="#local-6989586621683756044"><span class="hs-identifier">rbinds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756045"><a href="#local-6989586621683756045"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756046"><a href="#local-6989586621683756046"><span class="hs-identifier">con_like</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupConLike"><span class="hs-identifier hs-var">tcLookupConLike</span></a><span> </span><a href="#local-6989586621683756043"><span class="hs-identifier hs-var">con_name</span></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span>        </span><span class="hs-comment">-- Check for missing fields</span><span>
</span><a name="line-663"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#checkMissingFields"><span class="hs-identifier hs-var">checkMissingFields</span></a><span> </span><a href="#local-6989586621683756046"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756044"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756047"><a href="#local-6989586621683756047"><span class="hs-identifier">con_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756048"><a href="#local-6989586621683756048"><span class="hs-identifier">con_sigma</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferId"><span class="hs-identifier hs-var">tcInferId</span></a><span> </span><a href="#local-6989586621683756043"><span class="hs-identifier hs-var">con_name</span></a><span>
</span><a name="line-666"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756049"><a href="#local-6989586621683756049"><span class="hs-identifier">con_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756050"><a href="#local-6989586621683756050"><span class="hs-identifier">con_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-667"></a><span>            </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a href="#local-6989586621683756043"><span class="hs-identifier hs-var">con_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756048"><span class="hs-identifier hs-var">con_sigma</span></a><span>
</span><a name="line-668"></a><span>              </span><span class="hs-comment">-- a shallow instantiation should really be enough for</span><span>
</span><a name="line-669"></a><span>              </span><span class="hs-comment">-- a data constructor.</span><span>
</span><a name="line-670"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756051"><a href="#local-6989586621683756051"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeArity</span><span> </span><a href="#local-6989586621683756046"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-671"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756052"><a href="#local-6989586621683756052"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756053"><a href="#local-6989586621683756053"><span class="hs-identifier">actual_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTysN</span><span> </span><a href="#local-6989586621683756051"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683756050"><span class="hs-identifier hs-var">con_tau</span></a><span>
</span><a name="line-672"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">conLikeWrapId_maybe</span><span> </span><a href="#local-6989586621683756046"><span class="hs-identifier hs-var">con_like</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-673"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPatSyn.html#nonBidirectionalErr"><span class="hs-identifier hs-var">nonBidirectionalErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conLikeName</span><span> </span><a href="#local-6989586621683756046"><span class="hs-identifier hs-var">con_like</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756054"><a href="#local-6989586621683756054"><span class="hs-identifier">con_id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-675"></a><span>                  </span><a name="local-6989586621683756055"><a href="#local-6989586621683756055"><span class="hs-identifier">res_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Shouldn'tHappenOrigin</span><span> </span><span class="hs-string">&quot;RecordCon&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756041"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756053"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756045"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-677"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756056"><a href="#local-6989586621683756056"><span class="hs-identifier">rbinds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcRecordBinds"><span class="hs-identifier hs-var">tcRecordBinds</span></a><span> </span><a href="#local-6989586621683756046"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756052"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621683756044"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-678"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-679"></a><span>                  </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756055"><span class="hs-identifier hs-var">res_wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-680"></a><span>                  </span><span class="hs-identifier hs-var">RecordCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecordConTc</span><span>
</span><a name="line-681"></a><span>                                 </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_con_like</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756046"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-682"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_con_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756049"><span class="hs-identifier hs-var">con_wrap</span></a><span> </span><a href="#local-6989586621683756047"><span class="hs-identifier hs-var">con_expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-683"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756042"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756054"><span class="hs-identifier hs-var">con_id</span></a><span>
</span><a name="line-684"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756056"><span class="hs-identifier hs-var">rbinds'</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-comment">{-
Note [Type of a record update]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The main complication with RecordUpd is that we need to explicitly
handle the *non-updated* fields.  Consider:

        data T a b c = MkT1 { fa :: a, fb :: (b,c) }
                     | MkT2 { fa :: a, fb :: (b,c), fc :: c -&gt; c }
                     | MkT3 { fd :: a }

        upd :: T a b c -&gt; (b',c) -&gt; T a b' c
        upd t x = t { fb = x}

The result type should be (T a b' c)
not (T a b c),   because 'b' *is not* mentioned in a non-updated field
not (T a b' c'), because 'c' *is*     mentioned in a non-updated field
NB that it's not good enough to look at just one constructor; we must
look at them all; cf Trac #3219

After all, upd should be equivalent to:
        upd t x = case t of
                        MkT1 p q -&gt; MkT1 p x
                        MkT2 a b -&gt; MkT2 p b
                        MkT3 d   -&gt; error ...

So we need to give a completely fresh type to the result record,
and then constrain it by the fields that are *not* updated (&quot;p&quot; above).
We call these the &quot;fixed&quot; type variables, and compute them in getFixedTyVars.

Note that because MkT3 doesn't contain all the fields being updated,
its RHS is simply an error, so it doesn't impose any type constraints.
Hence the use of 'relevant_cont'.

Note [Implicit type sharing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We also take into account any &quot;implicit&quot; non-update fields.  For example
        data T a b where { MkT { f::a } :: T a a; ... }
So the &quot;real&quot; type of MkT is: forall ab. (a~b) =&gt; a -&gt; T a b

Then consider
        upd t x = t { f=x }
We infer the type
        upd :: T a b -&gt; a -&gt; T a b
        upd (t::T a b) (x::a)
           = case t of { MkT (co:a~b) (_:a) -&gt; MkT co x }
We can't give it the more general type
        upd :: T a b -&gt; c -&gt; T c b

Note [Criteria for update]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to allow update for existentials etc, provided the updated
field isn't part of the existential. For example, this should be ok.
  data T a where { MkT { f1::a, f2::b-&gt;b } :: T a }
  f :: T a -&gt; b -&gt; T b
  f t b = t { f1=b }

The criterion we use is this:

  The types of the updated fields
  mention only the universally-quantified type variables
  of the data constructor

NB: this is not (quite) the same as being a &quot;naughty&quot; record selector
(See Note [Naughty record selectors]) in TcTyClsDecls), at least
in the case of GADTs. Consider
   data T a where { MkT :: { f :: a } :: T [a] }
Then f is not &quot;naughty&quot; because it has a well-typed record selector.
But we don't allow updates for 'f'.  (One could consider trying to
allow this, but it makes my head hurt.  Badly.  And no one has asked
for it.)

In principle one could go further, and allow
  g :: T a -&gt; T a
  g t = t { f2 = \x -&gt; x }
because the expression is polymorphic...but that seems a bridge too far.

Note [Data family example]
~~~~~~~~~~~~~~~~~~~~~~~~~~
    data instance T (a,b) = MkT { x::a, y::b }
  ---&gt;
    data :TP a b = MkT { a::a, y::b }
    coTP a b :: T (a,b) ~ :TP a b

Suppose r :: T (t1,t2), e :: t3
Then  r { x=e } :: T (t3,t1)
  ---&gt;
      case r |&gt; co1 of
        MkT x y -&gt; MkT e y |&gt; co2
      where co1 :: T (t1,t2) ~ :TP t1 t2
            co2 :: :TP t3 t2 ~ T (t3,t2)
The wrapping with co2 is done by the constructor wrapper for MkT

Outgoing invariants
~~~~~~~~~~~~~~~~~~~
In the outgoing (HsRecordUpd scrut binds cons in_inst_tys out_inst_tys):

  * cons are the data constructors to be updated

  * in_inst_tys, out_inst_tys have same length, and instantiate the
        *representation* tycon of the data cons.  In Note [Data
        family example], in_inst_tys = [t1,t2], out_inst_tys = [t3,t2]

Note [Mixed Record Field Updates]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following pattern synonym.

  data MyRec = MyRec { foo :: Int, qux :: String }

  pattern HisRec{f1, f2} = MyRec{foo = f1, qux=f2}

This allows updates such as the following

  updater :: MyRec -&gt; MyRec
  updater a = a {f1 = 1 }

It would also make sense to allow the following update (which we reject).

  updater a = a {f1 = 1, qux = &quot;two&quot; } ==? MyRec 1 &quot;two&quot;

This leads to confusing behaviour when the selectors in fact refer the same
field.

  updater a = a {f1 = 1, foo = 2} ==? ???

For this reason, we reject a mixture of pattern synonym and normal record
selectors in the same update block. Although of course we still allow the
following.

  updater a = (a {f1 = 1}) {foo = 2}

  &gt; updater (MyRec 0 &quot;str&quot;)
  MyRec 2 &quot;str&quot;

-}</span><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683756057"><a href="#local-6989586621683756057"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordUpd</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756058"><a href="#local-6989586621683756058"><span class="hs-identifier">record_expr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756059"><a href="#local-6989586621683756059"><span class="hs-identifier">rbnds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756060"><a href="#local-6989586621683756060"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">rbnds</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- STEP -2: typecheck the record_expr, the record to be updated</span><span>
</span><a name="line-824"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621683756061"><a href="#local-6989586621683756061"><span class="hs-identifier">record_expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756062"><a href="#local-6989586621683756062"><span class="hs-identifier">record_rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferRho"><span class="hs-identifier hs-var">tcInferRho</span></a><span> </span><a href="#local-6989586621683756058"><span class="hs-identifier hs-var">record_expr</span></a><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span>        </span><span class="hs-comment">-- STEP -1  See Note [Disambiguating record fields]</span><span>
</span><a name="line-827"></a><span>        </span><span class="hs-comment">-- After this we know that rbinds is unambiguous</span><span>
</span><a name="line-828"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756063"><a href="#local-6989586621683756063"><span class="hs-identifier">rbinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#disambiguateRecordBinds"><span class="hs-identifier hs-var">disambiguateRecordBinds</span></a><span> </span><a href="#local-6989586621683756058"><span class="hs-identifier hs-var">record_expr</span></a><span> </span><a href="#local-6989586621683756062"><span class="hs-identifier hs-var">record_rho</span></a><span> </span><a href="#local-6989586621683756059"><span class="hs-identifier hs-var">rbnds</span></a><span> </span><a href="#local-6989586621683756060"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-829"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756064"><a href="#local-6989586621683756064"><span class="hs-identifier">upd_flds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756063"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-830"></a><span>              </span><a name="local-6989586621683756065"><a href="#local-6989586621683756065"><span class="hs-identifier">upd_fld_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameAmbiguousFieldOcc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756064"><span class="hs-identifier hs-var">upd_flds</span></a><span>
</span><a name="line-831"></a><span>              </span><a name="local-6989586621683756066"><a href="#local-6989586621683756066"><span class="hs-identifier">sel_ids</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">selectorAmbiguousFieldOcc</span><span> </span><a href="#local-6989586621683756064"><span class="hs-identifier hs-var">upd_flds</span></a><span>
</span><a name="line-832"></a><span>        </span><span class="hs-comment">-- STEP 0</span><span>
</span><a name="line-833"></a><span>        </span><span class="hs-comment">-- Check that the field names are really field names</span><span>
</span><a name="line-834"></a><span>        </span><span class="hs-comment">-- and they are all field names for proper records or</span><span>
</span><a name="line-835"></a><span>        </span><span class="hs-comment">-- all field names for pattern synonyms.</span><span>
</span><a name="line-836"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756067"><a href="#local-6989586621683756067"><span class="hs-identifier">bad_guys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683756069"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#notSelector"><span class="hs-identifier hs-var">notSelector</span></a><span> </span><a href="#local-6989586621683756071"><span class="hs-identifier hs-var">fld_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683756068"><a href="#local-6989586621683756068"><span class="hs-identifier">fld</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756063"><span class="hs-identifier hs-var">rbinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-838"></a><span>                           </span><span class="hs-comment">-- Excludes class ops</span><span>
</span><a name="line-839"></a><span>                           </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756069"><a href="#local-6989586621683756069"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683756070"><a href="#local-6989586621683756070"><span class="hs-identifier">sel_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsRecUpdFieldId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756068"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-840"></a><span>                           </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isRecordSelector</span><span> </span><a href="#local-6989586621683756070"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-841"></a><span>                           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756071"><a href="#local-6989586621683756071"><span class="hs-identifier">fld_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683756070"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-842"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756067"><span class="hs-identifier hs-var">bad_guys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sequence</span><span> </span><a href="#local-6989586621683756067"><span class="hs-identifier hs-var">bad_guys</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span class="hs-special">)</span><span>
</span><a name="line-843"></a><span>        </span><span class="hs-comment">-- See note [Mixed Record Selectors]</span><span>
</span><a name="line-844"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756072"><a href="#local-6989586621683756072"><span class="hs-identifier">data_sels</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756073"><a href="#local-6989586621683756073"><span class="hs-identifier">pat_syn_sels</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-845"></a><span>                </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-identifier hs-var">isDataConRecordSelector</span><span> </span><a href="#local-6989586621683756066"><span class="hs-identifier hs-var">sel_ids</span></a><span>
</span><a name="line-846"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">isPatSynRecordSelector</span><span> </span><span class="hs-identifier hs-var">pat_syn_sels</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-847"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756072"><span class="hs-identifier hs-var">data_sels</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756073"><span class="hs-identifier hs-var">pat_syn_sels</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>                  </span><span class="hs-special">(</span><span> </span><a href="TcExpr.html#mixedSelectors"><span class="hs-identifier hs-var">mixedSelectors</span></a><span> </span><a href="#local-6989586621683756072"><span class="hs-identifier hs-var">data_sels</span></a><span> </span><a href="#local-6989586621683756073"><span class="hs-identifier hs-var">pat_syn_sels</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span>        </span><span class="hs-comment">-- STEP 1</span><span>
</span><a name="line-851"></a><span>        </span><span class="hs-comment">-- Figure out the tycon and data cons from the first field name</span><span>
</span><a name="line-852"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-comment">-- It's OK to use the non-tc splitters here (for a selector)</span><span>
</span><a name="line-853"></a><span>              </span><a name="local-6989586621683756074"><a href="#local-6989586621683756074"><span class="hs-identifier">sel_id</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756066"><span class="hs-identifier hs-var">sel_ids</span></a><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span>              </span><span class="hs-identifier">mtycon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-856"></a><span>              </span><a name="local-6989586621683756075"><a href="#local-6989586621683756075"><span class="hs-identifier">mtycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">idDetails</span><span> </span><a href="#local-6989586621683756074"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-857"></a><span>                          </span><span class="hs-identifier hs-var">RecSelId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a name="local-6989586621683756078"><a href="#local-6989586621683756078"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756078"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-858"></a><span>                          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-859"></a><span>
</span><a name="line-860"></a><span>              </span><span class="hs-identifier">con_likes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span>
</span><a name="line-861"></a><span>              </span><a name="local-6989586621683756076"><a href="#local-6989586621683756076"><span class="hs-identifier">con_likes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">idDetails</span><span> </span><a href="#local-6989586621683756074"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-862"></a><span>                             </span><span class="hs-identifier hs-var">RecSelId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a name="local-6989586621683756079"><a href="#local-6989586621683756079"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-863"></a><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683756079"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-864"></a><span>                             </span><span class="hs-identifier hs-var">RecSelId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecSelPatSyn</span><span> </span><a name="local-6989586621683756080"><a href="#local-6989586621683756080"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-865"></a><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a href="#local-6989586621683756080"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">]</span><span>
</span><a name="line-866"></a><span>                             </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcRecordUpd&quot;</span><span>
</span><a name="line-867"></a><span>                </span><span class="hs-comment">-- NB: for a data type family, the tycon is the instance tycon</span><span>
</span><a name="line-868"></a><span>
</span><a name="line-869"></a><span>              </span><a name="local-6989586621683756077"><a href="#local-6989586621683756077"><span class="hs-identifier">relevant_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikesWithFields</span><span> </span><a href="#local-6989586621683756076"><span class="hs-identifier hs-var">con_likes</span></a><span> </span><a href="#local-6989586621683756065"><span class="hs-identifier hs-var">upd_fld_occs</span></a><span>
</span><a name="line-870"></a><span>                </span><span class="hs-comment">-- A constructor is only relevant to this process if</span><span>
</span><a name="line-871"></a><span>                </span><span class="hs-comment">-- it contains *all* the fields that are being updated</span><span>
</span><a name="line-872"></a><span>                </span><span class="hs-comment">-- Other ones will cause a runtime error if they occur</span><span>
</span><a name="line-873"></a><span>
</span><a name="line-874"></a><span>        </span><span class="hs-comment">-- Step 2</span><span>
</span><a name="line-875"></a><span>        </span><span class="hs-comment">-- Check that at least one constructor has all the named fields</span><span>
</span><a name="line-876"></a><span>        </span><span class="hs-comment">-- i.e. has an empty set of bad fields returned by badFields</span><span>
</span><a name="line-877"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756077"><span class="hs-identifier hs-var">relevant_cons</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#badFieldsUpd"><span class="hs-identifier hs-var">badFieldsUpd</span></a><span> </span><a href="#local-6989586621683756063"><span class="hs-identifier hs-var">rbinds</span></a><span> </span><a href="#local-6989586621683756076"><span class="hs-identifier hs-var">con_likes</span></a><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span>        </span><span class="hs-comment">-- Take apart a representative constructor</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756081"><a href="#local-6989586621683756081"><span class="hs-identifier">con1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">relevant_cons</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756077"><span class="hs-identifier hs-var">head</span></a><span> </span><span class="hs-identifier">relevant_cons</span><span>
</span><a name="line-881"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683756082"><a href="#local-6989586621683756082"><span class="hs-identifier">con1_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756083"><a href="#local-6989586621683756083"><span class="hs-identifier">_prov_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756084"><a href="#local-6989586621683756084"><span class="hs-identifier">req_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756085"><a href="#local-6989586621683756085"><span class="hs-identifier">con1_arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-882"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFullSig</span><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span>
</span><a name="line-883"></a><span>              </span><a name="local-6989586621683756086"><a href="#local-6989586621683756086"><span class="hs-identifier">con1_flds</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span>
</span><a name="line-884"></a><span>              </span><a name="local-6989586621683756087"><a href="#local-6989586621683756087"><span class="hs-identifier">con1_tv_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683756082"><span class="hs-identifier hs-var">con1_tvs</span></a><span>
</span><a name="line-885"></a><span>              </span><a name="local-6989586621683756088"><a href="#local-6989586621683756088"><span class="hs-identifier">con1_res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756075"><span class="hs-identifier hs-var">mtycon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-886"></a><span>                              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756089"><a href="#local-6989586621683756089"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkFamilyTyConApp</span><span> </span><a href="#local-6989586621683756089"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683756087"><span class="hs-identifier hs-var">con1_tv_tys</span></a><span>
</span><a name="line-887"></a><span>                              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">conLikeResTy</span><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621683756087"><span class="hs-identifier hs-var">con1_tv_tys</span></a><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span>        </span><span class="hs-comment">-- Check that we're not dealing with a unidirectional pattern</span><span>
</span><a name="line-890"></a><span>        </span><span class="hs-comment">-- synonym</span><span>
</span><a name="line-891"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">conLikeWrapId_maybe</span><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span class="hs-special">)</span><span>
</span><a name="line-892"></a><span>                  </span><span class="hs-special">(</span><a href="TcPatSyn.html#nonBidirectionalErr"><span class="hs-identifier hs-var">nonBidirectionalErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conLikeName</span><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span>        </span><span class="hs-comment">-- STEP 3    Note [Criteria for update]</span><span>
</span><a name="line-895"></a><span>        </span><span class="hs-comment">-- Check that each updated field is polymorphic; that is, its type</span><span>
</span><a name="line-896"></a><span>        </span><span class="hs-comment">-- mentions only the universally-quantified variables of the data con</span><span>
</span><a name="line-897"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756090"><a href="#local-6989586621683756090"><span class="hs-identifier">flds1_w_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;tcExpr:RecConUpd&quot;</span><span> </span><a href="#local-6989586621683756086"><span class="hs-identifier hs-var">con1_flds</span></a><span> </span><a href="#local-6989586621683756085"><span class="hs-identifier hs-var">con1_arg_tys</span></a><span>
</span><a name="line-898"></a><span>              </span><a name="local-6989586621683756091"><a href="#local-6989586621683756091"><span class="hs-identifier">bad_upd_flds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683756093"><span class="hs-identifier hs-var">bad_fld</span></a><span> </span><a href="#local-6989586621683756090"><span class="hs-identifier hs-var">flds1_w_tys</span></a><span>
</span><a name="line-899"></a><span>              </span><a name="local-6989586621683756092"><a href="#local-6989586621683756092"><span class="hs-identifier">con1_tv_set</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621683756082"><span class="hs-identifier hs-var">con1_tvs</span></a><span>
</span><a name="line-900"></a><span>              </span><a name="local-6989586621683756093"><a href="#local-6989586621683756093"><span class="hs-identifier">bad_fld</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683756094"><a href="#local-6989586621683756094"><span class="hs-identifier">fld</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756095"><a href="#local-6989586621683756095"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756094"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756065"><span class="hs-identifier hs-var">upd_fld_occs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-901"></a><span>                                      </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683756095"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">subVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756092"><span class="hs-identifier hs-var">con1_tv_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756091"><span class="hs-identifier hs-var">bad_upd_flds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#badFieldTypes"><span class="hs-identifier hs-var">badFieldTypes</span></a><span> </span><a href="#local-6989586621683756091"><span class="hs-identifier hs-var">bad_upd_flds</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span>        </span><span class="hs-comment">-- STEP 4  Note [Type of a record update]</span><span>
</span><a name="line-905"></a><span>        </span><span class="hs-comment">-- Figure out types for the scrutinee and result</span><span>
</span><a name="line-906"></a><span>        </span><span class="hs-comment">-- Both are of form (T a b c), with fresh type variables, but with</span><span>
</span><a name="line-907"></a><span>        </span><span class="hs-comment">-- common variables where the scrutinee and result must have the same type</span><span>
</span><a name="line-908"></a><span>        </span><span class="hs-comment">-- These are variables that appear in *any* arg of *any* of the</span><span>
</span><a name="line-909"></a><span>        </span><span class="hs-comment">-- relevant constructors *except* in the updated fields</span><span>
</span><a name="line-910"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-911"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756096"><a href="#local-6989586621683756096"><span class="hs-identifier">fixed_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#getFixedTyVars"><span class="hs-identifier hs-var">getFixedTyVars</span></a><span> </span><a href="#local-6989586621683756065"><span class="hs-identifier hs-var">upd_fld_occs</span></a><span> </span><a href="#local-6989586621683756082"><span class="hs-identifier hs-var">con1_tvs</span></a><span> </span><a href="#local-6989586621683756077"><span class="hs-identifier hs-var">relevant_cons</span></a><span>
</span><a name="line-912"></a><span>              </span><a name="local-6989586621683756097"><a href="#local-6989586621683756097"><span class="hs-identifier">is_fixed_tv</span></a></a><span> </span><a name="local-6989586621683756099"><a href="#local-6989586621683756099"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756099"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756096"><span class="hs-identifier hs-var">fixed_tvs</span></a><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>              </span><span class="hs-identifier">mk_inst_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TCvSubst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>              </span><span class="hs-comment">-- Deals with instantiation of kind variables</span><span>
</span><a name="line-916"></a><span>              </span><span class="hs-comment">--   c.f. TcMType.newMetaTyVars</span><span>
</span><a name="line-917"></a><span>              </span><a name="local-6989586621683756098"><a href="#local-6989586621683756098"><span class="hs-identifier">mk_inst_ty</span></a></a><span> </span><a name="local-6989586621683756100"><a href="#local-6989586621683756100"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683756101"><a href="#local-6989586621683756101"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756102"><a href="#local-6989586621683756102"><span class="hs-identifier">result_inst_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-918"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756097"><span class="hs-identifier hs-var">is_fixed_tv</span></a><span> </span><a href="#local-6989586621683756101"><span class="hs-identifier hs-var">tv</span></a><span>   </span><span class="hs-comment">-- Same as result type</span><span>
</span><a name="line-919"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTvSubst</span><span> </span><a href="#local-6989586621683756100"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683756101"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621683756102"><span class="hs-identifier hs-var">result_inst_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756102"><span class="hs-identifier hs-var">result_inst_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-comment">-- Fresh type, of correct kind</span><span>
</span><a name="line-921"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756103"><a href="#local-6989586621683756103"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756104"><a href="#local-6989586621683756104"><span class="hs-identifier">new_tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVarX"><span class="hs-identifier hs-var">newMetaTyVarX</span></a><span> </span><a href="#local-6989586621683756100"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683756101"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-922"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756103"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683756104"><span class="hs-identifier hs-var">new_tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-923"></a><span>
</span><a name="line-924"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756105"><a href="#local-6989586621683756105"><span class="hs-identifier">result_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756106"><a href="#local-6989586621683756106"><span class="hs-identifier">con1_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a><span> </span><a href="#local-6989586621683756082"><span class="hs-identifier hs-var">con1_tvs</span></a><span>
</span><a name="line-925"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756107"><a href="#local-6989586621683756107"><span class="hs-identifier">result_inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683756106"><span class="hs-identifier hs-var">con1_tvs'</span></a><span>
</span><a name="line-926"></a><span>              </span><a name="local-6989586621683756108"><a href="#local-6989586621683756108"><span class="hs-identifier">init_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getTCvInScope</span><span> </span><a href="#local-6989586621683756105"><span class="hs-identifier hs-var">result_subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756109"><a href="#local-6989586621683756109"><span class="hs-identifier">scrut_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756110"><a href="#local-6989586621683756110"><span class="hs-identifier">scrut_inst_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="#local-6989586621683756098"><span class="hs-identifier hs-var">mk_inst_ty</span></a><span> </span><a href="#local-6989586621683756108"><span class="hs-identifier hs-var">init_subst</span></a><span>
</span><a name="line-929"></a><span>                                                      </span><span class="hs-special">(</span><a href="#local-6989586621683756082"><span class="hs-identifier hs-var">con1_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756107"><span class="hs-identifier hs-var">result_inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>
</span><a name="line-931"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756111"><a href="#local-6989586621683756111"><span class="hs-identifier">rec_res_ty</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TcType.substTy</span><span> </span><a href="#local-6989586621683756105"><span class="hs-identifier hs-var">result_subst</span></a><span> </span><a href="#local-6989586621683756088"><span class="hs-identifier hs-var">con1_res_ty</span></a><span>
</span><a name="line-932"></a><span>              </span><a name="local-6989586621683756112"><a href="#local-6989586621683756112"><span class="hs-identifier">scrut_ty</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TcType.substTy</span><span> </span><a href="#local-6989586621683756109"><span class="hs-identifier hs-var">scrut_subst</span></a><span>  </span><a href="#local-6989586621683756088"><span class="hs-identifier hs-var">con1_res_ty</span></a><span>
</span><a name="line-933"></a><span>              </span><a name="local-6989586621683756113"><a href="#local-6989586621683756113"><span class="hs-identifier">con1_arg_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcType.substTy</span><span> </span><a href="#local-6989586621683756105"><span class="hs-identifier hs-var">result_subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756085"><span class="hs-identifier hs-var">con1_arg_tys</span></a><span>
</span><a name="line-934"></a><span>
</span><a name="line-935"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756114"><a href="#local-6989586621683756114"><span class="hs-identifier">wrap_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeHR"><span class="hs-identifier hs-var">tcSubTypeHR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprCtOrigin</span><span> </span><a href="#local-6989586621683756057"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756057"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756111"><span class="hs-identifier hs-var">rec_res_ty</span></a><span> </span><a href="#local-6989586621683756060"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-937"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756115"><a href="#local-6989586621683756115"><span class="hs-identifier">co_scrut</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756058"><span class="hs-identifier hs-var">record_expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756062"><span class="hs-identifier hs-var">record_rho</span></a><span> </span><a href="#local-6989586621683756112"><span class="hs-identifier hs-var">scrut_ty</span></a><span>
</span><a name="line-938"></a><span>                </span><span class="hs-comment">-- NB: normal unification is OK here (as opposed to subsumption),</span><span>
</span><a name="line-939"></a><span>                </span><span class="hs-comment">-- because for this to work out, both record_rho and scrut_ty have</span><span>
</span><a name="line-940"></a><span>                </span><span class="hs-comment">-- to be normal datatypes -- no contravariant stuff can go on</span><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>        </span><span class="hs-comment">-- STEP 5</span><span>
</span><a name="line-943"></a><span>        </span><span class="hs-comment">-- Typecheck the bindings</span><span>
</span><a name="line-944"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756116"><a href="#local-6989586621683756116"><span class="hs-identifier">rbinds'</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcRecordUpd"><span class="hs-identifier hs-var">tcRecordUpd</span></a><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621683756113"><span class="hs-identifier hs-var">con1_arg_tys'</span></a><span> </span><a href="#local-6989586621683756063"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span>        </span><span class="hs-comment">-- STEP 6: Deal with the stupid theta</span><span>
</span><a name="line-947"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756117"><a href="#local-6989586621683756117"><span class="hs-identifier">theta'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substThetaUnchecked</span><span> </span><a href="#local-6989586621683756109"><span class="hs-identifier hs-var">scrut_subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conLikeStupidTheta</span><span> </span><a href="#local-6989586621683756081"><span class="hs-identifier hs-var">con1</span></a><span class="hs-special">)</span><span>
</span><a name="line-948"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Inst.html#instStupidTheta"><span class="hs-identifier hs-var">instStupidTheta</span></a><span> </span><span class="hs-identifier hs-var">RecordUpdOrigin</span><span> </span><a href="#local-6989586621683756117"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span>        </span><span class="hs-comment">-- Step 7: make a cast for the scrutinee, in the</span><span>
</span><a name="line-951"></a><span>        </span><span class="hs-comment">--         case that it's from a data family</span><span>
</span><a name="line-952"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">fam_co</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span>   </span><span class="hs-comment">-- RepT t1 .. tn ~R scrut_ty</span><span>
</span><a name="line-953"></a><span>              </span><a name="local-6989586621683756118"><a href="#local-6989586621683756118"><span class="hs-identifier">fam_co</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756119"><a href="#local-6989586621683756119"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756075"><span class="hs-identifier hs-var">mtycon</span></a><span>
</span><a name="line-954"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756120"><a href="#local-6989586621683756120"><span class="hs-identifier">co_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConFamilyCoercion_maybe</span><span> </span><a href="#local-6989586621683756119"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-955"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpCastR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcUnbranchedAxInstCo</span><span> </span><a href="#local-6989586621683756120"><span class="hs-identifier hs-var">co_con</span></a><span> </span><a href="#local-6989586621683756110"><span class="hs-identifier hs-var">scrut_inst_tys</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-957"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><span>        </span><span class="hs-comment">-- Step 8: Check that the req constraints are satisfied</span><span>
</span><a name="line-960"></a><span>        </span><span class="hs-comment">-- For normal data constructors req_theta is empty but we must do</span><span>
</span><a name="line-961"></a><span>        </span><span class="hs-comment">-- this check for pattern synonyms.</span><span>
</span><a name="line-962"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756121"><a href="#local-6989586621683756121"><span class="hs-identifier">req_theta'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substThetaUnchecked</span><span> </span><a href="#local-6989586621683756109"><span class="hs-identifier hs-var">scrut_subst</span></a><span> </span><a href="#local-6989586621683756084"><span class="hs-identifier hs-var">req_theta</span></a><span>
</span><a name="line-963"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756122"><a href="#local-6989586621683756122"><span class="hs-identifier">req_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCallConstraints"><span class="hs-identifier hs-var">instCallConstraints</span></a><span> </span><span class="hs-identifier hs-var">RecordUpdOrigin</span><span> </span><a href="#local-6989586621683756121"><span class="hs-identifier hs-var">req_theta'</span></a><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span>        </span><span class="hs-comment">-- Phew!</span><span>
</span><a name="line-966"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-967"></a><span>          </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756114"><span class="hs-identifier hs-var">wrap_res</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-968"></a><span>          </span><span class="hs-identifier hs-var">RecordUpd</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_expr</span><span>
</span><a name="line-969"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683756118"><span class="hs-identifier hs-var">fam_co</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrapCo</span><span> </span><a href="#local-6989586621683756115"><span class="hs-identifier hs-var">co_scrut</span></a><span> </span><a href="#local-6989586621683756061"><span class="hs-identifier hs-var">record_expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-970"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756116"><span class="hs-identifier hs-var">rbinds'</span></a><span>
</span><a name="line-971"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecordUpdTc</span><span>
</span><a name="line-972"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756077"><span class="hs-identifier hs-var">relevant_cons</span></a><span>
</span><a name="line-973"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_in_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756110"><span class="hs-identifier hs-var">scrut_inst_tys</span></a><span>
</span><a name="line-974"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_out_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756107"><span class="hs-identifier hs-var">result_inst_tys</span></a><span>
</span><a name="line-975"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756122"><span class="hs-identifier hs-var">req_wrap</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683756123"><a href="#local-6989586621683756123"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756124"><a href="#local-6989586621683756124"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756125"><a href="#local-6989586621683756125"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-978"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcCheckRecSelId"><span class="hs-identifier hs-var">tcCheckRecSelId</span></a><span> </span><a href="#local-6989586621683756123"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683756124"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683756125"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-979"></a><span>
</span><a name="line-980"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Arithmetic sequences                    e.g. [a,b..]
        and their parallel-array counterparts   e.g. [: a,b.. :]

*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-989"></a><span>
</span><a name="line-990"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756126"><a href="#local-6989586621683756126"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621683756127"><a href="#local-6989586621683756127"><span class="hs-identifier">seq</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756128"><a href="#local-6989586621683756128"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcArithSeq"><span class="hs-identifier hs-var">tcArithSeq</span></a><span> </span><a href="#local-6989586621683756126"><span class="hs-identifier hs-var">witness</span></a><span> </span><a href="#local-6989586621683756127"><span class="hs-identifier hs-var">seq</span></a><span> </span><a href="#local-6989586621683756128"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Template Haskell
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span class="hs-comment">-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceExpr'.</span><span>
</span><a name="line-1002"></a><span class="hs-comment">-- Here we get rid of it and add the finalizers to the global environment.</span><span>
</span><a name="line-1003"></a><span class="hs-comment">--</span><span>
</span><a name="line-1004"></a><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices] in RnSplice.</span><span>
</span><a name="line-1005"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756129"><a href="#local-6989586621683756129"><span class="hs-identifier">mod_finalizers</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedExpr</span><span> </span><a name="local-6989586621683756130"><a href="#local-6989586621683756130"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>       </span><a name="local-6989586621683756131"><a href="#local-6989586621683756131"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-var">addModFinalizersWithLclEnv</span></a><span> </span><a href="#local-6989586621683756129"><span class="hs-identifier hs-var">mod_finalizers</span></a><span>
</span><a name="line-1008"></a><span>       </span><a href="TcExpr.html#tcExpr"><span class="hs-identifier hs-var">tcExpr</span></a><span> </span><a href="#local-6989586621683756130"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756131"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1009"></a><span class="hs-identifier">tcExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756132"><a href="#local-6989586621683756132"><span class="hs-identifier">splice</span></a></a><span class="hs-special">)</span><span>          </span><a name="local-6989586621683756133"><a href="#local-6989586621683756133"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1010"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#tcSpliceExpr"><span class="hs-identifier hs-var">tcSpliceExpr</span></a><span> </span><a href="#local-6989586621683756132"><span class="hs-identifier hs-var">splice</span></a><span> </span><a href="#local-6989586621683756133"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1011"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683756134"><a href="#local-6989586621683756134"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBracket</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756135"><a href="#local-6989586621683756135"><span class="hs-identifier">brack</span></a></a><span class="hs-special">)</span><span>         </span><a name="local-6989586621683756136"><a href="#local-6989586621683756136"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1012"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#tcTypedBracket"><span class="hs-identifier hs-var">tcTypedBracket</span></a><span> </span><a href="#local-6989586621683756134"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683756135"><span class="hs-identifier hs-var">brack</span></a><span> </span><a href="#local-6989586621683756136"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1013"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683756137"><a href="#local-6989586621683756137"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRnBracketOut</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756138"><a href="#local-6989586621683756138"><span class="hs-identifier">brack</span></a></a><span> </span><a name="local-6989586621683756139"><a href="#local-6989586621683756139"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756140"><a href="#local-6989586621683756140"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#tcUntypedBracket"><span class="hs-identifier hs-var">tcUntypedBracket</span></a><span> </span><a href="#local-6989586621683756137"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683756138"><span class="hs-identifier hs-var">brack</span></a><span> </span><a href="#local-6989586621683756139"><span class="hs-identifier hs-var">ps</span></a><span> </span><a href="#local-6989586621683756140"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Catch-all
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1023"></a><span>
</span><a name="line-1024"></a><span class="hs-identifier">tcExpr</span><span> </span><a name="local-6989586621683756141"><a href="#local-6989586621683756141"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcMonoExpr&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756141"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>  </span><span class="hs-comment">-- Include ArrForm, ArrApp, which shouldn't appear at all</span><span>
</span><a name="line-1026"></a><span>  </span><span class="hs-comment">-- Also HsTcBracketOut, HsQuasiQuoteE</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Arithmetic sequences [a..b] etc
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-identifier">tcArithSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ArithSeqInfo</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-1037"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><a name="tcArithSeq"><a href="TcExpr.html#tcArithSeq"><span class="hs-identifier">tcArithSeq</span></a></a><span> </span><a name="local-6989586621683756142"><a href="#local-6989586621683756142"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621683756143"><a href="#local-6989586621683756143"><span class="hs-identifier">seq</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">From</span><span> </span><a name="local-6989586621683756144"><a href="#local-6989586621683756144"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756145"><a href="#local-6989586621683756145"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1040"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756146"><a href="#local-6989586621683756146"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756147"><a href="#local-6989586621683756147"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756148"><a href="#local-6989586621683756148"><span class="hs-identifier">wit'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#arithSeqEltType"><span class="hs-identifier hs-var">arithSeqEltType</span></a><span> </span><a href="#local-6989586621683756142"><span class="hs-identifier hs-var">witness</span></a><span> </span><a href="#local-6989586621683756145"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1041"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756149"><a href="#local-6989586621683756149"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756144"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756147"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1042"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756150"><a href="#local-6989586621683756150"><span class="hs-identifier">enum_from</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeqOrigin</span><span> </span><a href="#local-6989586621683756143"><span class="hs-identifier hs-var">seq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span>                              </span><span class="hs-identifier hs-var">enumFromName</span><span> </span><a href="#local-6989586621683756147"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1044"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756146"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1045"></a><span>         </span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a href="#local-6989586621683756150"><span class="hs-identifier hs-var">enum_from</span></a><span> </span><a href="#local-6989586621683756148"><span class="hs-identifier hs-var">wit'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">From</span><span> </span><a href="#local-6989586621683756149"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1046"></a><span>
</span><a name="line-1047"></a><span class="hs-identifier">tcArithSeq</span><span> </span><a name="local-6989586621683756151"><a href="#local-6989586621683756151"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621683756152"><a href="#local-6989586621683756152"><span class="hs-identifier">seq</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThen</span><span> </span><a name="local-6989586621683756153"><a href="#local-6989586621683756153"><span class="hs-identifier">expr1</span></a></a><span> </span><a name="local-6989586621683756154"><a href="#local-6989586621683756154"><span class="hs-identifier">expr2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756155"><a href="#local-6989586621683756155"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1048"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756156"><a href="#local-6989586621683756156"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756157"><a href="#local-6989586621683756157"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756158"><a href="#local-6989586621683756158"><span class="hs-identifier">wit'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#arithSeqEltType"><span class="hs-identifier hs-var">arithSeqEltType</span></a><span> </span><a href="#local-6989586621683756151"><span class="hs-identifier hs-var">witness</span></a><span> </span><a href="#local-6989586621683756155"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1049"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756159"><a href="#local-6989586621683756159"><span class="hs-identifier">expr1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756153"><span class="hs-identifier hs-var">expr1</span></a><span> </span><a href="#local-6989586621683756157"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1050"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756160"><a href="#local-6989586621683756160"><span class="hs-identifier">expr2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756154"><span class="hs-identifier hs-var">expr2</span></a><span> </span><a href="#local-6989586621683756157"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1051"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756161"><a href="#local-6989586621683756161"><span class="hs-identifier">enum_from_then</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeqOrigin</span><span> </span><a href="#local-6989586621683756152"><span class="hs-identifier hs-var">seq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>                              </span><span class="hs-identifier hs-var">enumFromThenName</span><span> </span><a href="#local-6989586621683756157"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1053"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756156"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1054"></a><span>         </span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a href="#local-6989586621683756161"><span class="hs-identifier hs-var">enum_from_then</span></a><span> </span><a href="#local-6989586621683756158"><span class="hs-identifier hs-var">wit'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThen</span><span> </span><a href="#local-6989586621683756159"><span class="hs-identifier hs-var">expr1'</span></a><span> </span><a href="#local-6989586621683756160"><span class="hs-identifier hs-var">expr2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span class="hs-identifier">tcArithSeq</span><span> </span><a name="local-6989586621683756162"><a href="#local-6989586621683756162"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621683756163"><a href="#local-6989586621683756163"><span class="hs-identifier">seq</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromTo</span><span> </span><a name="local-6989586621683756164"><a href="#local-6989586621683756164"><span class="hs-identifier">expr1</span></a></a><span> </span><a name="local-6989586621683756165"><a href="#local-6989586621683756165"><span class="hs-identifier">expr2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756166"><a href="#local-6989586621683756166"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1057"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756167"><a href="#local-6989586621683756167"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756168"><a href="#local-6989586621683756168"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756169"><a href="#local-6989586621683756169"><span class="hs-identifier">wit'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#arithSeqEltType"><span class="hs-identifier hs-var">arithSeqEltType</span></a><span> </span><a href="#local-6989586621683756162"><span class="hs-identifier hs-var">witness</span></a><span> </span><a href="#local-6989586621683756166"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1058"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756170"><a href="#local-6989586621683756170"><span class="hs-identifier">expr1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756164"><span class="hs-identifier hs-var">expr1</span></a><span> </span><a href="#local-6989586621683756168"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1059"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756171"><a href="#local-6989586621683756171"><span class="hs-identifier">expr2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756165"><span class="hs-identifier hs-var">expr2</span></a><span> </span><a href="#local-6989586621683756168"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1060"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756172"><a href="#local-6989586621683756172"><span class="hs-identifier">enum_from_to</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeqOrigin</span><span> </span><a href="#local-6989586621683756163"><span class="hs-identifier hs-var">seq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1061"></a><span>                              </span><span class="hs-identifier hs-var">enumFromToName</span><span> </span><a href="#local-6989586621683756168"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1062"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756167"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1063"></a><span>         </span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a href="#local-6989586621683756172"><span class="hs-identifier hs-var">enum_from_to</span></a><span> </span><a href="#local-6989586621683756169"><span class="hs-identifier hs-var">wit'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromTo</span><span> </span><a href="#local-6989586621683756170"><span class="hs-identifier hs-var">expr1'</span></a><span> </span><a href="#local-6989586621683756171"><span class="hs-identifier hs-var">expr2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span class="hs-identifier">tcArithSeq</span><span> </span><a name="local-6989586621683756173"><a href="#local-6989586621683756173"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621683756174"><a href="#local-6989586621683756174"><span class="hs-identifier">seq</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThenTo</span><span> </span><a name="local-6989586621683756175"><a href="#local-6989586621683756175"><span class="hs-identifier">expr1</span></a></a><span> </span><a name="local-6989586621683756176"><a href="#local-6989586621683756176"><span class="hs-identifier">expr2</span></a></a><span> </span><a name="local-6989586621683756177"><a href="#local-6989586621683756177"><span class="hs-identifier">expr3</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756178"><a href="#local-6989586621683756178"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756179"><a href="#local-6989586621683756179"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756180"><a href="#local-6989586621683756180"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756181"><a href="#local-6989586621683756181"><span class="hs-identifier">wit'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#arithSeqEltType"><span class="hs-identifier hs-var">arithSeqEltType</span></a><span> </span><a href="#local-6989586621683756173"><span class="hs-identifier hs-var">witness</span></a><span> </span><a href="#local-6989586621683756178"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1067"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756182"><a href="#local-6989586621683756182"><span class="hs-identifier">expr1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756175"><span class="hs-identifier hs-var">expr1</span></a><span> </span><a href="#local-6989586621683756180"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1068"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756183"><a href="#local-6989586621683756183"><span class="hs-identifier">expr2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756176"><span class="hs-identifier hs-var">expr2</span></a><span> </span><a href="#local-6989586621683756180"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1069"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756184"><a href="#local-6989586621683756184"><span class="hs-identifier">expr3'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756177"><span class="hs-identifier hs-var">expr3</span></a><span> </span><a href="#local-6989586621683756180"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1070"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756185"><a href="#local-6989586621683756185"><span class="hs-identifier">eft</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeqOrigin</span><span> </span><a href="#local-6989586621683756174"><span class="hs-identifier hs-var">seq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><span>                              </span><span class="hs-identifier hs-var">enumFromThenToName</span><span> </span><a href="#local-6989586621683756180"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1072"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756179"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1073"></a><span>          </span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a href="#local-6989586621683756185"><span class="hs-identifier hs-var">eft</span></a><span> </span><a href="#local-6989586621683756181"><span class="hs-identifier hs-var">wit'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThenTo</span><span> </span><a href="#local-6989586621683756182"><span class="hs-identifier hs-var">expr1'</span></a><span> </span><a href="#local-6989586621683756183"><span class="hs-identifier hs-var">expr2'</span></a><span> </span><a href="#local-6989586621683756184"><span class="hs-identifier hs-var">expr3'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-1076"></a><span class="hs-identifier">arithSeqEltType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-1077"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1078"></a><a name="arithSeqEltType"><a href="TcExpr.html#arithSeqEltType"><span class="hs-identifier">arithSeqEltType</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621683756186"><a href="#local-6989586621683756186"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756187"><a href="#local-6989586621683756187"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683756186"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1080"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756188"><a href="#local-6989586621683756188"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756189"><a href="#local-6989586621683756189"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span> </span><a href="#local-6989586621683756187"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1081"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><a href="#local-6989586621683756188"><span class="hs-identifier hs-var">coi</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756189"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1082"></a><span class="hs-identifier">arithSeqEltType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756190"><a href="#local-6989586621683756190"><span class="hs-identifier">fl</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756191"><a href="#local-6989586621683756191"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1083"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756193"><a href="#local-6989586621683756193"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756194"><a href="#local-6989586621683756194"><span class="hs-identifier">fl'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1084"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">ListOrigin</span><span> </span><a href="#local-6989586621683756190"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynList</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683756191"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1085"></a><span>              </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683756192"><a href="#local-6989586621683756192"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756192"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1086"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756193"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756194"><span class="hs-identifier hs-var">fl'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1087"></a><span>
</span><a name="line-1088"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Applications
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span class="hs-comment">-- HsArg is defined in HsTypes.hs</span><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span class="hs-identifier">wrapHsArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">NoGhcTc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683755722"><span class="hs-identifier hs-type">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683755722"><span class="hs-identifier hs-type">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HsArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683755722"><span class="hs-identifier hs-type">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1101"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621683755722"><span class="hs-identifier hs-type">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1102"></a><a name="wrapHsArgs"><a href="TcExpr.html#wrapHsArgs"><span class="hs-identifier">wrapHsArgs</span></a></a><span> </span><a name="local-6989586621683756195"><a href="#local-6989586621683756195"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756195"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-1103"></a><span class="hs-identifier">wrapHsArgs</span><span> </span><a name="local-6989586621683756196"><a href="#local-6989586621683756196"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span>  </span><a name="local-6989586621683756197"><a href="#local-6989586621683756197"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756198"><a href="#local-6989586621683756198"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#wrapHsArgs"><span class="hs-identifier hs-var">wrapHsArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsApp</span><span> </span><a href="#local-6989586621683756196"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683756197"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>          </span><a href="#local-6989586621683756198"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1104"></a><span class="hs-identifier">wrapHsArgs</span><span> </span><a name="local-6989586621683756199"><a href="#local-6989586621683756199"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756200"><a href="#local-6989586621683756200"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756201"><a href="#local-6989586621683756201"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#wrapHsArgs"><span class="hs-identifier hs-var">wrapHsArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsAppType</span><span> </span><a href="#local-6989586621683756199"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683756200"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>      </span><a href="#local-6989586621683756201"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1105"></a><span class="hs-identifier">wrapHsArgs</span><span> </span><a name="local-6989586621683756202"><a href="#local-6989586621683756202"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><a name="local-6989586621683756203"><a href="#local-6989586621683756203"><span class="hs-identifier">sp</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756204"><a href="#local-6989586621683756204"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#wrapHsArgs"><span class="hs-identifier hs-var">wrapHsArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756203"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683756202"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756204"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1106"></a><span>
</span><a name="line-1107"></a><span class="hs-identifier">isHsValArg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsArg</span><span> </span><a href="#local-6989586621683755720"><span class="hs-identifier hs-type">tm</span></a><span> </span><a href="#local-6989586621683755721"><span class="hs-identifier hs-type">ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1108"></a><a name="isHsValArg"><a href="TcExpr.html#isHsValArg"><span class="hs-identifier">isHsValArg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1109"></a><span class="hs-identifier">isHsValArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1110"></a><span class="hs-identifier">isHsValArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span class="hs-identifier">isArgPar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsArg</span><span> </span><a href="#local-6989586621683755718"><span class="hs-identifier hs-type">tm</span></a><span> </span><a href="#local-6989586621683755719"><span class="hs-identifier hs-type">ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1113"></a><a name="isArgPar"><a href="TcExpr.html#isArgPar"><span class="hs-identifier">isArgPar</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1114"></a><span class="hs-identifier">isArgPar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1115"></a><span class="hs-identifier">isArgPar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1116"></a><span>
</span><a name="line-1117"></a><span class="hs-identifier">isArgPar_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsArg</span><span> </span><a href="#local-6989586621683755714"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621683755715"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsArg</span><span> </span><a href="#local-6989586621683755716"><span class="hs-identifier hs-type">c</span></a><span> </span><a href="#local-6989586621683755717"><span class="hs-identifier hs-type">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-1118"></a><a name="isArgPar_maybe"><a href="TcExpr.html#isArgPar_maybe"><span class="hs-identifier">isArgPar_maybe</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><a name="local-6989586621683756205"><a href="#local-6989586621683756205"><span class="hs-identifier">sp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><a href="#local-6989586621683756205"><span class="hs-identifier hs-var">sp</span></a><span>
</span><a name="line-1119"></a><span class="hs-identifier">isArgPar_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1120"></a><span>
</span><a name="line-1121"></a><span class="hs-keyword">type</span><span> </span><a name="LHsExprArgIn"><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier">LHsExprArgIn</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">HsArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span class="hs-keyword">type</span><span> </span><a name="LHsExprArgOut"><a href="TcExpr.html#LHsExprArgOut"><span class="hs-identifier">LHsExprArgOut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">HsArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>
</span><a name="line-1124"></a><span class="hs-identifier">tcApp1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>  </span><span class="hs-comment">-- either HsApp or HsAppType</span><span>
</span><a name="line-1125"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1126"></a><a name="tcApp1"><a href="TcExpr.html#tcApp1"><span class="hs-identifier">tcApp1</span></a></a><span> </span><a name="local-6989586621683756206"><a href="#local-6989586621683756206"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621683756207"><a href="#local-6989586621683756207"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1127"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756208"><a href="#local-6989586621683756208"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756209"><a href="#local-6989586621683756209"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756210"><a href="#local-6989586621683756210"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcApp"><span class="hs-identifier hs-var">tcApp</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756206"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683756207"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1128"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756208"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcExpr.html#wrapHsArgs"><span class="hs-identifier hs-var">wrapHsArgs</span></a><span> </span><a href="#local-6989586621683756209"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683756210"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1129"></a><span>
</span><a name="line-1130"></a><span class="hs-identifier">tcApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>  </span><span class="hs-comment">-- like &quot;The function `f' is applied to&quot;</span><span>
</span><a name="line-1131"></a><span>                     </span><span class="hs-comment">-- or leave out to get exactly that message</span><span>
</span><a name="line-1132"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier hs-type">LHsExprArgIn</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Function and args</span><span>
</span><a name="line-1133"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgOut"><span class="hs-identifier hs-type">LHsExprArgOut</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>           </span><span class="hs-comment">-- (wrap, fun, args). For an ordinary function application,</span><span>
</span><a name="line-1135"></a><span>           </span><span class="hs-comment">-- these should be assembled as (wrap (fun args)).</span><span>
</span><a name="line-1136"></a><span>           </span><span class="hs-comment">-- But OpApp is slightly different, so that's why the caller</span><span>
</span><a name="line-1137"></a><span>           </span><span class="hs-comment">-- must assemble</span><span>
</span><a name="line-1138"></a><span>
</span><a name="line-1139"></a><a name="tcApp"><a href="TcExpr.html#tcApp"><span class="hs-identifier">tcApp</span></a></a><span> </span><a name="local-6989586621683756211"><a href="#local-6989586621683756211"><span class="hs-identifier">m_herald</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756212"><a href="#local-6989586621683756212"><span class="hs-identifier">sp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756213"><a href="#local-6989586621683756213"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756214"><a href="#local-6989586621683756214"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756215"><a href="#local-6989586621683756215"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1140"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcApp"><span class="hs-identifier hs-var">tcApp</span></a><span> </span><a href="#local-6989586621683756211"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><a href="#local-6989586621683756213"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><a href="#local-6989586621683756212"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756214"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756215"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1141"></a><span>
</span><a name="line-1142"></a><span class="hs-identifier">tcApp</span><span> </span><a name="local-6989586621683756216"><a href="#local-6989586621683756216"><span class="hs-identifier">m_herald</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756217"><a href="#local-6989586621683756217"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756218"><a href="#local-6989586621683756218"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756219"><a href="#local-6989586621683756219"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756220"><a href="#local-6989586621683756220"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1143"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcApp"><span class="hs-identifier hs-var">tcApp</span></a><span> </span><a href="#local-6989586621683756216"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><a href="#local-6989586621683756217"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683756218"><span class="hs-identifier hs-var">arg1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756219"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756220"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1144"></a><span>
</span><a name="line-1145"></a><span class="hs-identifier">tcApp</span><span> </span><a name="local-6989586621683756221"><a href="#local-6989586621683756221"><span class="hs-identifier">m_herald</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756222"><a href="#local-6989586621683756222"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756223"><a href="#local-6989586621683756223"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756224"><a href="#local-6989586621683756224"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756225"><a href="#local-6989586621683756225"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcApp"><span class="hs-identifier hs-var">tcApp</span></a><span> </span><a href="#local-6989586621683756221"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><a href="#local-6989586621683756222"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><a href="#local-6989586621683756223"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756224"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756225"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1147"></a><span>
</span><a name="line-1148"></a><span class="hs-identifier">tcApp</span><span> </span><a name="local-6989586621683756226"><a href="#local-6989586621683756226"><span class="hs-identifier">m_herald</span></a></a><span> </span><a name="local-6989586621683756227"><a href="#local-6989586621683756227"><span class="hs-identifier">fun</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756228"><a href="#local-6989586621683756228"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756229"><a href="#local-6989586621683756229"><span class="hs-identifier">fld_lbl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756230"><a href="#local-6989586621683756230"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756231"><a href="#local-6989586621683756231"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1149"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Ambiguous</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756232"><a href="#local-6989586621683756232"><span class="hs-identifier">lbl</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756229"><span class="hs-identifier hs-var">fld_lbl</span></a><span>  </span><span class="hs-comment">-- Still ambiguous</span><span>
</span><a name="line-1150"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756233"><a href="#local-6989586621683756233"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><a href="TcExpr.html#isArgPar"><span class="hs-identifier hs-var">isArgPar</span></a><span> </span><a href="#local-6989586621683756230"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-comment">-- A value arg is first</span><span>
</span><a name="line-1151"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756234"><a href="#local-6989586621683756234"><span class="hs-identifier">sig_ty</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#obviousSig"><span class="hs-identifier hs-var">obviousSig</span></a><span> </span><a href="#local-6989586621683756233"><span class="hs-identifier hs-var">arg</span></a><span>  </span><span class="hs-comment">-- A type sig on the arg disambiguates</span><span>
</span><a name="line-1152"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756235"><a href="#local-6989586621683756235"><span class="hs-identifier">sig_tc_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsSigWcType"><span class="hs-identifier hs-var">tcHsSigWcType</span></a><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span> </span><a href="#local-6989586621683756234"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-1153"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756236"><a href="#local-6989586621683756236"><span class="hs-identifier">sel_name</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#disambiguateSelector"><span class="hs-identifier hs-var">disambiguateSelector</span></a><span> </span><a href="#local-6989586621683756232"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621683756235"><span class="hs-identifier hs-var">sig_tc_ty</span></a><span>
</span><a name="line-1154"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756237"><a href="#local-6989586621683756237"><span class="hs-identifier">tc_fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756238"><a href="#local-6989586621683756238"><span class="hs-identifier">fun_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferRecSelId"><span class="hs-identifier hs-var">tcInferRecSelId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a href="#local-6989586621683756236"><span class="hs-identifier hs-var">sel_name</span></a><span> </span><a href="#local-6989586621683756232"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcFunApp"><span class="hs-identifier hs-var">tcFunApp</span></a><span> </span><a href="#local-6989586621683756226"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><a href="#local-6989586621683756227"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756228"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756237"><span class="hs-identifier hs-var">tc_fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756238"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621683756230"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621683756231"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1156"></a><span>
</span><a name="line-1157"></a><span class="hs-identifier">tcApp</span><span> </span><a name="local-6989586621683756239"><a href="#local-6989586621683756239"><span class="hs-identifier">m_herald</span></a></a><span> </span><a name="local-6989586621683756240"><a href="#local-6989586621683756240"><span class="hs-identifier">fun</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756241"><a href="#local-6989586621683756241"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756242"><a href="#local-6989586621683756242"><span class="hs-identifier">fun_id</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756243"><a href="#local-6989586621683756243"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756244"><a href="#local-6989586621683756244"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1158"></a><span>  </span><span class="hs-comment">-- Special typing rule for tagToEnum#</span><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756242"><span class="hs-identifier hs-var">fun_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tagToEnumKey</span><span>
</span><a name="line-1160"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756245"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1161"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcTagToEnum"><span class="hs-identifier hs-var">tcTagToEnum</span></a><span> </span><a href="#local-6989586621683756241"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756242"><span class="hs-identifier hs-var">fun_id</span></a><span> </span><a href="#local-6989586621683756243"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621683756244"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span>  </span><span class="hs-comment">-- Special typing rule for 'seq'</span><span>
</span><a name="line-1164"></a><span>  </span><span class="hs-comment">-- In the saturated case, behave as if seq had type</span><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-comment">--    forall a (b::TYPE r). a -&gt; b -&gt; b</span><span>
</span><a name="line-1166"></a><span>  </span><span class="hs-comment">-- for some type r.  See Note [Typing rule for seq]</span><span>
</span><a name="line-1167"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756242"><span class="hs-identifier hs-var">fun_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">seqIdKey</span><span>
</span><a name="line-1168"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756245"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-1169"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756246"><a href="#local-6989586621683756246"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">runtimeRepTy</span><span>
</span><a name="line-1170"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683756247"><a href="#local-6989586621683756247"><span class="hs-identifier">alpha</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756248"><a href="#local-6989586621683756248"><span class="hs-identifier">beta</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTemplateTyVars</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tYPE</span><span> </span><a href="#local-6989586621683756246"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">]</span><span>
</span><a name="line-1171"></a><span>             </span><a name="local-6989586621683756249"><a href="#local-6989586621683756249"><span class="hs-identifier">seq_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756247"><span class="hs-identifier hs-var">alpha</span></a><span class="hs-special">,</span><a href="#local-6989586621683756248"><span class="hs-identifier hs-var">beta</span></a><span class="hs-special">]</span><span>
</span><a name="line-1172"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683756247"><span class="hs-identifier hs-var">alpha</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683756248"><span class="hs-identifier hs-var">beta</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683756248"><span class="hs-identifier hs-var">beta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1173"></a><span>             </span><a name="local-6989586621683756250"><a href="#local-6989586621683756250"><span class="hs-identifier">seq_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756241"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756241"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">seqId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>             </span><span class="hs-comment">-- seq_ty = forall (a:*) (b:TYPE r). a -&gt; b -&gt; b</span><span>
</span><a name="line-1175"></a><span>             </span><span class="hs-comment">-- where 'r' is a meta type variable</span><span>
</span><a name="line-1176"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcFunApp"><span class="hs-identifier hs-var">tcFunApp</span></a><span> </span><a href="#local-6989586621683756239"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><a href="#local-6989586621683756240"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683756250"><span class="hs-identifier hs-var">seq_fun</span></a><span> </span><a href="#local-6989586621683756249"><span class="hs-identifier hs-var">seq_ty</span></a><span> </span><a href="#local-6989586621683756243"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621683756244"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1177"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1178"></a><span>    </span><a name="local-6989586621683756245"><a href="#local-6989586621683756245"><span class="hs-identifier">n_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="TcExpr.html#isHsValArg"><span class="hs-identifier hs-var">isHsValArg</span></a><span> </span><a href="#local-6989586621683756243"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1179"></a><span>
</span><a name="line-1180"></a><span class="hs-identifier">tcApp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756251"><a href="#local-6989586621683756251"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756252"><a href="#local-6989586621683756252"><span class="hs-identifier">ty_arg</span></a></a><span class="hs-special">]</span><span> </span><a name="local-6989586621683756253"><a href="#local-6989586621683756253"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1181"></a><span>  </span><span class="hs-comment">-- See Note [Visible type application for the empty list constructor]</span><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756254"><a href="#local-6989586621683756254"><span class="hs-identifier">ty_arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsTypeApp"><span class="hs-identifier hs-var">tcHsTypeApp</span></a><span> </span><a href="#local-6989586621683756252"><span class="hs-identifier hs-var">ty_arg</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-1183"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756255"><a href="#local-6989586621683756255"><span class="hs-identifier">list_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TyConApp</span><span> </span><span class="hs-identifier hs-var">listTyCon</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756254"><span class="hs-identifier hs-var">ty_arg'</span></a><span class="hs-special">]</span><span>
</span><a name="line-1184"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeDS"><span class="hs-identifier hs-var">tcSubTypeDS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><span class="hs-identifier hs-var">nilDataConName</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span>
</span><a name="line-1185"></a><span>                          </span><a href="#local-6989586621683756255"><span class="hs-identifier hs-var">list_ty</span></a><span> </span><a href="#local-6989586621683756253"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1186"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">expr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span>
</span><a name="line-1187"></a><span>             </span><a name="local-6989586621683756256"><a href="#local-6989586621683756256"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756251"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a href="#local-6989586621683756254"><span class="hs-identifier hs-var">ty_arg'</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1188"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756256"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1189"></a><span>
</span><a name="line-1190"></a><span class="hs-identifier">tcApp</span><span> </span><a name="local-6989586621683756257"><a href="#local-6989586621683756257"><span class="hs-identifier">m_herald</span></a></a><span> </span><a name="local-6989586621683756258"><a href="#local-6989586621683756258"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756259"><a href="#local-6989586621683756259"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756260"><a href="#local-6989586621683756260"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1191"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756261"><a href="#local-6989586621683756261"><span class="hs-identifier">tc_fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756262"><a href="#local-6989586621683756262"><span class="hs-identifier">fun_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferFun"><span class="hs-identifier hs-var">tcInferFun</span></a><span> </span><a href="#local-6989586621683756258"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1192"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcFunApp"><span class="hs-identifier hs-var">tcFunApp</span></a><span> </span><a href="#local-6989586621683756257"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><a href="#local-6989586621683756258"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683756261"><span class="hs-identifier hs-var">tc_fun</span></a><span> </span><a href="#local-6989586621683756262"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621683756259"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621683756260"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1193"></a><span>
</span><a name="line-1194"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-1195"></a><span class="hs-identifier">tcFunApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>  </span><span class="hs-comment">-- like &quot;The function `f' is applied to&quot;</span><span>
</span><a name="line-1196"></a><span>                        </span><span class="hs-comment">-- or leave out to get exactly that message</span><span>
</span><a name="line-1197"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>                  </span><span class="hs-comment">-- Renamed function</span><span>
</span><a name="line-1198"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-comment">-- Function and its type</span><span>
</span><a name="line-1199"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier hs-type">LHsExprArgIn</span></a><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Arguments</span><span>
</span><a name="line-1200"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>                     </span><span class="hs-comment">-- Overall result type</span><span>
</span><a name="line-1201"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgOut"><span class="hs-identifier hs-type">LHsExprArgOut</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1202"></a><span>            </span><span class="hs-comment">-- (wrapper-for-result, fun, args)</span><span>
</span><a name="line-1203"></a><span>            </span><span class="hs-comment">-- For an ordinary function application,</span><span>
</span><a name="line-1204"></a><span>            </span><span class="hs-comment">-- these should be assembled as wrap_res[ fun args ]</span><span>
</span><a name="line-1205"></a><span>            </span><span class="hs-comment">-- But OpApp is slightly different, so that's why the caller</span><span>
</span><a name="line-1206"></a><span>            </span><span class="hs-comment">-- must assemble</span><span>
</span><a name="line-1207"></a><span>
</span><a name="line-1208"></a><span class="hs-comment">-- tcFunApp deals with the general case;</span><span>
</span><a name="line-1209"></a><span class="hs-comment">-- the special cases are handled by tcApp</span><span>
</span><a name="line-1210"></a><a name="tcFunApp"><a href="TcExpr.html#tcFunApp"><span class="hs-identifier">tcFunApp</span></a></a><span> </span><a name="local-6989586621683756263"><a href="#local-6989586621683756263"><span class="hs-identifier">m_herald</span></a></a><span> </span><a name="local-6989586621683756264"><a href="#local-6989586621683756264"><span class="hs-identifier">rn_fun</span></a></a><span> </span><a name="local-6989586621683756265"><a href="#local-6989586621683756265"><span class="hs-identifier">tc_fun</span></a></a><span> </span><a name="local-6989586621683756266"><a href="#local-6989586621683756266"><span class="hs-identifier">fun_sigma</span></a></a><span> </span><a name="local-6989586621683756267"><a href="#local-6989586621683756267"><span class="hs-identifier">rn_args</span></a></a><span> </span><a name="local-6989586621683756268"><a href="#local-6989586621683756268"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1211"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756269"><a href="#local-6989586621683756269"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683756264"><span class="hs-identifier hs-var">rn_fun</span></a><span>
</span><a name="line-1212"></a><span>
</span><a name="line-1213"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcFunApp&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756264"><span class="hs-identifier hs-var">rn_fun</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756266"><span class="hs-identifier hs-var">fun_sigma</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756267"><span class="hs-identifier hs-var">rn_args</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756268"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1214"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756270"><a href="#local-6989586621683756270"><span class="hs-identifier">wrap_fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756271"><a href="#local-6989586621683756271"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756272"><a href="#local-6989586621683756272"><span class="hs-identifier">actual_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcArgs"><span class="hs-identifier hs-var">tcArgs</span></a><span> </span><a href="#local-6989586621683756264"><span class="hs-identifier hs-var">rn_fun</span></a><span> </span><a href="#local-6989586621683756266"><span class="hs-identifier hs-var">fun_sigma</span></a><span> </span><a href="#local-6989586621683756269"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756267"><span class="hs-identifier hs-var">rn_args</span></a><span>
</span><a name="line-1216"></a><span>                     </span><span class="hs-special">(</span><a href="#local-6989586621683756263"><span class="hs-identifier hs-var">m_herald</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="TcExpr.html#mk_app_msg"><span class="hs-identifier hs-var">mk_app_msg</span></a><span> </span><a href="#local-6989586621683756264"><span class="hs-identifier hs-var">rn_fun</span></a><span> </span><a href="#local-6989586621683756267"><span class="hs-identifier hs-var">rn_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span>            </span><span class="hs-comment">-- this is just like tcWrapResult, but the types don't line</span><span>
</span><a name="line-1219"></a><span>            </span><span class="hs-comment">-- up to call that function</span><span>
</span><a name="line-1220"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756273"><a href="#local-6989586621683756273"><span class="hs-identifier">wrap_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#addFunResCtxt"><span class="hs-identifier hs-var">addFunResCtxt</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756264"><span class="hs-identifier hs-var">rn_fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756272"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756268"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1221"></a><span>                     </span><a href="TcUnify.html#tcSubTypeDS_NC_O"><span class="hs-identifier hs-var">tcSubTypeDS_NC_O</span></a><span> </span><a href="#local-6989586621683756269"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span>
</span><a name="line-1222"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcExpr.html#wrapHsArgs"><span class="hs-identifier hs-var">wrapHsArgs</span></a><span> </span><a href="#local-6989586621683756264"><span class="hs-identifier hs-var">rn_fun</span></a><span> </span><a href="#local-6989586621683756267"><span class="hs-identifier hs-var">rn_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1223"></a><span>                       </span><a href="#local-6989586621683756272"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756268"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1224"></a><span>
</span><a name="line-1225"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756273"><span class="hs-identifier hs-var">wrap_res</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683756270"><span class="hs-identifier hs-var">wrap_fun</span></a><span> </span><a href="#local-6989586621683756265"><span class="hs-identifier hs-var">tc_fun</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756271"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span class="hs-identifier">mk_app_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier hs-type">LHsExprArgIn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1228"></a><a name="mk_app_msg"><a href="TcExpr.html#mk_app_msg"><span class="hs-identifier">mk_app_msg</span></a></a><span> </span><a name="local-6989586621683756274"><a href="#local-6989586621683756274"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756275"><a href="#local-6989586621683756275"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683756276"><span class="hs-identifier hs-var">what</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756277"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1229"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is applied to&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1230"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1231"></a><span>    </span><a name="local-6989586621683756276"><a href="#local-6989586621683756276"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756278"><span class="hs-identifier hs-var">type_app_args</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;function&quot;</span><span>
</span><a name="line-1232"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;expression&quot;</span><span>
</span><a name="line-1233"></a><span>    </span><span class="hs-comment">-- Include visible type arguments (but not other arguments) in the herald.</span><span>
</span><a name="line-1234"></a><span>    </span><span class="hs-comment">-- See Note [Herald for matchExpectedFunTys] in TcUnify.</span><span>
</span><a name="line-1235"></a><span>    </span><a name="local-6989586621683756277"><a href="#local-6989586621683756277"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsAppTypes</span><span> </span><a href="#local-6989586621683756274"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683756278"><span class="hs-identifier hs-var">type_app_args</span></a><span>
</span><a name="line-1236"></a><span>    </span><a name="local-6989586621683756278"><a href="#local-6989586621683756278"><span class="hs-identifier">type_app_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756279"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756279"><a href="#local-6989586621683756279"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756275"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">]</span><span>
</span><a name="line-1237"></a><span>
</span><a name="line-1238"></a><span class="hs-identifier">mk_op_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1239"></a><a name="mk_op_msg"><a href="TcExpr.html#mk_op_msg"><span class="hs-identifier">mk_op_msg</span></a></a><span> </span><a name="local-6989586621683756280"><a href="#local-6989586621683756280"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The operator&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756280"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;takes&quot;</span><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span class="hs-comment">{-
Note [Visible type application for the empty list constructor]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Getting the expression [] @Int to typecheck is slightly tricky since [] isn't
an ordinary data constructor. By default, when tcExpr typechecks a list
expression, it wraps the expression in a coercion, which gives it a type to the
effect of p[a]. It isn't until later zonking that the type becomes
forall a. [a], but that's too late for visible type application.

The workaround is to check for empty list expressions that have a visible type
argument in tcApp, and if so, directly typecheck [] @ty data constructor name.
This avoids the intermediate coercion and produces an expression of type [ty],
as one would intuitively expect.

Unfortunately, this workaround isn't terribly robust, since more involved
expressions such as (let in []) @Int won't work. Until a more elegant fix comes
along, however, this at least allows direct type application on [] to work,
which is better than before.
-}</span><span>
</span><a name="line-1260"></a><span>
</span><a name="line-1261"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1262"></a><span class="hs-identifier">tcInferFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span>
</span><a name="line-1263"></a><span class="hs-comment">-- Infer type of a function</span><span>
</span><a name="line-1264"></a><a name="tcInferFun"><a href="TcExpr.html#tcInferFun"><span class="hs-identifier">tcInferFun</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756281"><a href="#local-6989586621683756281"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756282"><a href="#local-6989586621683756282"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1265"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756283"><a href="#local-6989586621683756283"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756284"><a href="#local-6989586621683756284"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683756281"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcInferId"><span class="hs-identifier hs-var">tcInferId</span></a><span> </span><a href="#local-6989586621683756282"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>               </span><span class="hs-comment">-- Don't wrap a context around a plain Id</span><span>
</span><a name="line-1267"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756281"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756283"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756284"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1268"></a><span>
</span><a name="line-1269"></a><span class="hs-identifier">tcInferFun</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756285"><a href="#local-6989586621683756285"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756286"><a href="#local-6989586621683756286"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756287"><a href="#local-6989586621683756287"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756288"><a href="#local-6989586621683756288"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683756285"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcInferRecSelId"><span class="hs-identifier hs-var">tcInferRecSelId</span></a><span> </span><a href="#local-6989586621683756286"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1271"></a><span>               </span><span class="hs-comment">-- Don't wrap a context around a plain Id</span><span>
</span><a name="line-1272"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756285"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756287"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756288"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span class="hs-identifier">tcInferFun</span><span> </span><a name="local-6989586621683756289"><a href="#local-6989586621683756289"><span class="hs-identifier">fun</span></a></a><span>
</span><a name="line-1275"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><a href="#local-6989586621683756289"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1276"></a><span>      </span><span class="hs-comment">-- NB: tcInferSigma; see TcUnify</span><span>
</span><a name="line-1277"></a><span>      </span><span class="hs-comment">-- Note [Deep instantiation of InferResult]</span><span>
</span><a name="line-1278"></a><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1281"></a><span class="hs-comment">-- | Type-check the arguments to a function, possibly including visible type</span><span>
</span><a name="line-1282"></a><span class="hs-comment">-- applications</span><span>
</span><a name="line-1283"></a><span class="hs-identifier">tcArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>   </span><span class="hs-comment">-- ^ The function itself (for err msgs only)</span><span>
</span><a name="line-1284"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>    </span><span class="hs-comment">-- ^ the (uninstantiated) type of the function</span><span>
</span><a name="line-1285"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>       </span><span class="hs-comment">-- ^ the origin for the function's type</span><span>
</span><a name="line-1286"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier hs-type">LHsExprArgIn</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ the args</span><span>
</span><a name="line-1287"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>           </span><span class="hs-comment">-- ^ the herald for matchActualFunTys</span><span>
</span><a name="line-1288"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgOut"><span class="hs-identifier hs-type">LHsExprArgOut</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>          </span><span class="hs-comment">-- ^ (a wrapper for the function, the tc'd args, result type)</span><span>
</span><a name="line-1290"></a><a name="tcArgs"><a href="TcExpr.html#tcArgs"><span class="hs-identifier">tcArgs</span></a></a><span> </span><a name="local-6989586621683756290"><a href="#local-6989586621683756290"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756291"><a href="#local-6989586621683756291"><span class="hs-identifier">orig_fun_ty</span></a></a><span> </span><a name="local-6989586621683756292"><a href="#local-6989586621683756292"><span class="hs-identifier">fun_orig</span></a></a><span> </span><a name="local-6989586621683756293"><a href="#local-6989586621683756293"><span class="hs-identifier">orig_args</span></a></a><span> </span><a name="local-6989586621683756294"><a href="#local-6989586621683756294"><span class="hs-identifier">herald</span></a></a><span>
</span><a name="line-1291"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756296"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621683756291"><span class="hs-identifier hs-var">orig_fun_ty</span></a><span> </span><a href="#local-6989586621683756293"><span class="hs-identifier hs-var">orig_args</span></a><span>
</span><a name="line-1292"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1293"></a><span>    </span><span class="hs-comment">-- Don't count visible type arguments when determining how many arguments</span><span>
</span><a name="line-1294"></a><span>    </span><span class="hs-comment">-- an expression is given in an arity mismatch error, since visible type</span><span>
</span><a name="line-1295"></a><span>    </span><span class="hs-comment">-- arguments reported as a part of the expression herald itself.</span><span>
</span><a name="line-1296"></a><span>    </span><span class="hs-comment">-- See Note [Herald for matchExpectedFunTys] in TcUnify.</span><span>
</span><a name="line-1297"></a><span>    </span><a name="local-6989586621683756295"><a href="#local-6989586621683756295"><span class="hs-identifier">orig_expr_args_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="TcExpr.html#isHsValArg"><span class="hs-identifier hs-var">isHsValArg</span></a><span> </span><a href="#local-6989586621683756293"><span class="hs-identifier hs-var">orig_args</span></a><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span>    </span><a name="local-6989586621683756296"><a href="#local-6989586621683756296"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756298"><a href="#local-6989586621683756298"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756298"><span class="hs-identifier hs-var">fun_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1300"></a><span>
</span><a name="line-1301"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756299"><a href="#local-6989586621683756299"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-6989586621683756300"><a href="#local-6989586621683756300"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683756301"><a href="#local-6989586621683756301"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><a name="local-6989586621683756302"><a href="#local-6989586621683756302"><span class="hs-identifier">sp</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756303"><a href="#local-6989586621683756303"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756304"><a href="#local-6989586621683756304"><span class="hs-identifier">inner_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756305"><a href="#local-6989586621683756305"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756306"><a href="#local-6989586621683756306"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756296"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683756299"><span class="hs-identifier hs-var">acc_args</span></a><span> </span><a href="#local-6989586621683756300"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683756301"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621683756303"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1303"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756304"><span class="hs-identifier hs-var">inner_wrap</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><a href="#local-6989586621683756302"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756305"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756306"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1304"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756307"><a href="#local-6989586621683756307"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-6989586621683756308"><a href="#local-6989586621683756308"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683756309"><a href="#local-6989586621683756309"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><a name="local-6989586621683756310"><a href="#local-6989586621683756310"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683756311"><a href="#local-6989586621683756311"><span class="hs-identifier">hs_ty_arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756312"><a href="#local-6989586621683756312"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1307"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756313"><a href="#local-6989586621683756313"><span class="hs-identifier">wrap1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756314"><a href="#local-6989586621683756314"><span class="hs-identifier">upsilon_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiateInferred"><span class="hs-identifier hs-var">topInstantiateInferred</span></a><span> </span><a href="#local-6989586621683756292"><span class="hs-identifier hs-var">fun_orig</span></a><span> </span><a href="#local-6989586621683756309"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-1308"></a><span>               </span><span class="hs-comment">-- wrap1 :: fun_ty &quot;-&gt;&quot; upsilon_ty</span><span>
</span><a name="line-1309"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitForAllTy_maybe</span><span> </span><a href="#local-6989586621683756314"><span class="hs-identifier hs-var">upsilon_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1310"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756315"><a href="#local-6989586621683756315"><span class="hs-identifier">tvb</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756316"><a href="#local-6989586621683756316"><span class="hs-identifier">inner_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1311"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">binderArgFlag</span><span> </span><a href="#local-6989586621683756315"><span class="hs-identifier hs-var">tvb</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Specified</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1312"></a><span>                   </span><span class="hs-comment">-- It really can't be Inferred, because we've justn</span><span>
</span><a name="line-1313"></a><span>                   </span><span class="hs-comment">-- instantiated those. But, oddly, it might just be Required.</span><span>
</span><a name="line-1314"></a><span>                   </span><span class="hs-comment">-- See Note [Required quantifiers in the type of a term]</span><span>
</span><a name="line-1315"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756317"><a href="#local-6989586621683756317"><span class="hs-identifier">tv</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderVar</span><span> </span><a href="#local-6989586621683756315"><span class="hs-identifier hs-var">tvb</span></a><span>
</span><a name="line-1316"></a><span>                          </span><a name="local-6989586621683756318"><a href="#local-6989586621683756318"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683756317"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1317"></a><span>                    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756319"><a href="#local-6989586621683756319"><span class="hs-identifier">ty_arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsTypeApp"><span class="hs-identifier hs-var">tcHsTypeApp</span></a><span> </span><a href="#local-6989586621683756311"><span class="hs-identifier hs-var">hs_ty_arg</span></a><span> </span><a href="#local-6989586621683756318"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1318"></a><span>
</span><a name="line-1319"></a><span>                    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756320"><a href="#local-6989586621683756320"><span class="hs-identifier">inner_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683756316"><span class="hs-identifier hs-var">inner_ty</span></a><span>
</span><a name="line-1320"></a><span>                          </span><span class="hs-comment">-- See Note [Visible type application zonk]</span><span>
</span><a name="line-1321"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756321"><a href="#local-6989586621683756321"><span class="hs-identifier">in_scope</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756314"><span class="hs-identifier hs-var">upsilon_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756319"><span class="hs-identifier hs-var">ty_arg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>                          </span><a name="local-6989586621683756322"><a href="#local-6989586621683756322"><span class="hs-identifier">insted_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTyWithInScope</span><span> </span><a href="#local-6989586621683756321"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756317"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756319"><span class="hs-identifier hs-var">ty_arg</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683756320"><span class="hs-identifier hs-var">inner_ty</span></a><span>
</span><a name="line-1324"></a><span>                                      </span><span class="hs-comment">-- NB: tv and ty_arg have the same kind, so this</span><span>
</span><a name="line-1325"></a><span>                                      </span><span class="hs-comment">--     substitution is kind-respecting</span><span>
</span><a name="line-1326"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;VTA&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756317"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><a href="#local-6989586621683756318"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1327"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><a href="#local-6989586621683756319"><span class="hs-identifier hs-var">ty_arg</span></a><span>
</span><a name="line-1328"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621683756319"><span class="hs-identifier hs-var">ty_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1329"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><a href="#local-6989586621683756320"><span class="hs-identifier hs-var">inner_ty</span></a><span>
</span><a name="line-1330"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><a href="#local-6989586621683756322"><span class="hs-identifier hs-var">insted_ty</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1331"></a><span>
</span><a name="line-1332"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756323"><a href="#local-6989586621683756323"><span class="hs-identifier">inner_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756324"><a href="#local-6989586621683756324"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756325"><a href="#local-6989586621683756325"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1333"></a><span>                        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756296"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683756307"><span class="hs-identifier hs-var">acc_args</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756308"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756322"><span class="hs-identifier hs-var">insted_ty</span></a><span> </span><a href="#local-6989586621683756312"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1334"></a><span>                   </span><span class="hs-comment">-- inner_wrap :: insted_ty &quot;-&gt;&quot; (map typeOf args') -&gt; res_ty</span><span>
</span><a name="line-1335"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756326"><a href="#local-6989586621683756326"><span class="hs-identifier">inst_wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756319"><span class="hs-identifier hs-var">ty_arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-1336"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621683756323"><span class="hs-identifier hs-var">inner_wrap</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683756326"><span class="hs-identifier hs-var">inst_wrap</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683756313"><span class="hs-identifier hs-var">wrap1</span></a><span>
</span><a name="line-1337"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><a href="#local-6989586621683756310"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683756311"><span class="hs-identifier hs-var">hs_ty_arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756324"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-1338"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756325"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1339"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683756297"><span class="hs-identifier hs-var">ty_app_err</span></a><span> </span><a href="#local-6989586621683756314"><span class="hs-identifier hs-var">upsilon_ty</span></a><span> </span><a href="#local-6989586621683756311"><span class="hs-identifier hs-var">hs_ty_arg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1340"></a><span>
</span><a name="line-1341"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756327"><a href="#local-6989586621683756327"><span class="hs-identifier">acc_args</span></a></a><span> </span><a name="local-6989586621683756328"><a href="#local-6989586621683756328"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683756329"><a href="#local-6989586621683756329"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683756330"><a href="#local-6989586621683756330"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756331"><a href="#local-6989586621683756331"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1342"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756333"><a href="#local-6989586621683756333"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683756334"><a href="#local-6989586621683756334"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756335"><a href="#local-6989586621683756335"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1343"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchActualFunTysPart"><span class="hs-identifier hs-var">matchActualFunTysPart</span></a><span> </span><a href="#local-6989586621683756294"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621683756292"><span class="hs-identifier hs-var">fun_orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756290"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621683756329"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-1344"></a><span>                                        </span><a href="#local-6989586621683756327"><span class="hs-identifier hs-var">acc_args</span></a><span> </span><a href="#local-6989586621683756295"><span class="hs-identifier hs-var">orig_expr_args_arity</span></a><span>
</span><a name="line-1345"></a><span>               </span><span class="hs-comment">-- wrap :: fun_ty &quot;-&gt;&quot; arg_ty -&gt; res_ty</span><span>
</span><a name="line-1346"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756336"><a href="#local-6989586621683756336"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcArg"><span class="hs-identifier hs-var">tcArg</span></a><span> </span><a href="#local-6989586621683756290"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683756330"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621683756334"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-6989586621683756328"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1347"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756337"><a href="#local-6989586621683756337"><span class="hs-identifier">inner_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756338"><a href="#local-6989586621683756338"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756339"><a href="#local-6989586621683756339"><span class="hs-identifier">inner_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1348"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756296"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756334"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756327"><span class="hs-identifier hs-var">acc_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756328"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756335"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683756331"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1349"></a><span>               </span><span class="hs-comment">-- inner_wrap :: res_ty &quot;-&gt;&quot; (map typeOf args') -&gt; inner_res_ty</span><span>
</span><a name="line-1350"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkWpFun</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span> </span><a href="#local-6989586621683756337"><span class="hs-identifier hs-var">inner_wrap</span></a><span> </span><a href="#local-6989586621683756334"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-6989586621683756335"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683756332"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683756333"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-1351"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683756336"><span class="hs-identifier hs-var">arg'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756338"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-1352"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756339"><span class="hs-identifier hs-var">inner_res_ty</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1353"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1354"></a><span>        </span><a name="local-6989586621683756332"><a href="#local-6989586621683756332"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">speakNth</span><span> </span><a href="#local-6989586621683756328"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1355"></a><span>              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;argument to&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756290"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1356"></a><span>
</span><a name="line-1357"></a><span>    </span><a name="local-6989586621683756297"><a href="#local-6989586621683756297"><span class="hs-identifier">ty_app_err</span></a></a><span> </span><a name="local-6989586621683756340"><a href="#local-6989586621683756340"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683756341"><a href="#local-6989586621683756341"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-1358"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756342"><a href="#local-6989586621683756342"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><a href="#local-6989586621683756340"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1359"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1360"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot apply expression of type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756342"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1361"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to a visible type argument&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756341"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1362"></a><span>
</span><a name="line-1363"></a><span class="hs-comment">{- Note [Required quantifiers in the type of a term]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (Trac #15859)

  data A k :: k -&gt; Type      -- A      :: forall k -&gt; k -&gt; Type
  type KindOf (a :: k) = k   -- KindOf :: forall k. k -&gt; Type
  a = (undefind :: KindOf A) @Int

With ImpredicativeTypes (thin ice, I know), we instantiate
KindOf at type (forall k -&gt; k -&gt; Type), so
  KindOf A = forall k -&gt; k -&gt; Type
whose first argument is Required

We want to reject this type application to Int, but in earlier
GHCs we had an ASSERT that Required could not occur here.

The ice is thin; c.f. Note [No Required TyCoBinder in terms]
in TyCoRep.

Note [Visible type application zonk]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Substitutions should be kind-preserving, so we need kind(tv) = kind(ty_arg).

* tcHsTypeApp only guarantees that
    - ty_arg is zonked
    - kind(zonk(tv)) = kind(ty_arg)
  (checkExpectedKind zonks as it goes).

So we must zonk inner_ty as well, to guarantee consistency between zonk(tv)
and inner_ty.  Otherwise we can build an ill-kinded type.  An example was
Trac #14158, where we had:
   id :: forall k. forall (cat :: k -&gt; k -&gt; *). forall (a :: k). cat a a
and we had the visible type application
  id @(-&gt;)

* We instantiated k := kappa, yielding
    forall (cat :: kappa -&gt; kappa -&gt; *). forall (a :: kappa). cat a a
* Then we called tcHsTypeApp (-&gt;) with expected kind (kappa -&gt; kappa -&gt; *).
* That instantiated (-&gt;) as ((-&gt;) q1 q1), and unified kappa := q1,
  Here q1 :: RuntimeRep
* Now we substitute
     cat  :-&gt;  (-&gt;) q1 q1 :: TYPE q1 -&gt; TYPE q1 -&gt; *
  but we must first zonk the inner_ty to get
      forall (a :: TYPE q1). cat a a
  so that the result of substitution is well-kinded
  Failing to do so led to Trac #14158.
-}</span><span>
</span><a name="line-1410"></a><span>
</span><a name="line-1411"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1412"></a><span class="hs-identifier">tcArg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>                   </span><span class="hs-comment">-- The function (for error messages)</span><span>
</span><a name="line-1413"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>                   </span><span class="hs-comment">-- Actual arguments</span><span>
</span><a name="line-1414"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span>                       </span><span class="hs-comment">-- expected arg type</span><span>
</span><a name="line-1415"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>                             </span><span class="hs-comment">-- # of argument</span><span>
</span><a name="line-1416"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Resulting argument</span><span>
</span><a name="line-1417"></a><a name="tcArg"><a href="TcExpr.html#tcArg"><span class="hs-identifier">tcArg</span></a></a><span> </span><a name="local-6989586621683756343"><a href="#local-6989586621683756343"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756344"><a href="#local-6989586621683756344"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621683756345"><a href="#local-6989586621683756345"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683756346"><a href="#local-6989586621683756346"><span class="hs-identifier">arg_no</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#funAppCtxt"><span class="hs-identifier hs-var">funAppCtxt</span></a><span> </span><a href="#local-6989586621683756343"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683756344"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621683756346"><span class="hs-identifier hs-var">arg_no</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1418"></a><span>                          </span><a href="TcExpr.html#tcPolyExprNC"><span class="hs-identifier hs-var">tcPolyExprNC</span></a><span> </span><a href="#local-6989586621683756344"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621683756345"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1419"></a><span>
</span><a name="line-1420"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1421"></a><span class="hs-identifier">tcTupArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTupArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTupArg</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">]</span><span>
</span><a name="line-1422"></a><a name="tcTupArgs"><a href="TcExpr.html#tcTupArgs"><span class="hs-identifier">tcTupArgs</span></a></a><span> </span><a name="local-6989586621683756347"><a href="#local-6989586621683756347"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756348"><a href="#local-6989586621683756348"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1423"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-identifier hs-var">tys</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mapM</span><span> </span><a href="#local-6989586621683756347"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">args</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">zip</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tys</span><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1425"></a><span>    </span><a name="local-6989586621683756349"><a href="#local-6989586621683756349"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756350"><a href="#local-6989586621683756350"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span>   </span><a name="local-6989586621683756351"><a href="#local-6989586621683756351"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756350"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><a href="#local-6989586621683756351"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1426"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756352"><a href="#local-6989586621683756352"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><a name="local-6989586621683756353"><a href="#local-6989586621683756353"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683756354"><a href="#local-6989586621683756354"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756355"><a href="#local-6989586621683756355"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756356"><a href="#local-6989586621683756356"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683756354"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756355"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-1427"></a><span>                                           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756352"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><a href="#local-6989586621683756353"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683756356"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1428"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTupArg</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcTupArgs&quot;</span><span>
</span><a name="line-1429"></a><span>
</span><a name="line-1430"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1431"></a><span class="hs-comment">-- See TcType.SyntaxOpType also for commentary</span><span>
</span><a name="line-1432"></a><span class="hs-identifier">tcSyntaxOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-1433"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-1434"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SyntaxOpType</span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- ^ shape of syntax operator arguments</span><span>
</span><a name="line-1435"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>               </span><span class="hs-comment">-- ^ overall result type</span><span>
</span><a name="line-1436"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755713"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Type check any arguments</span><span>
</span><a name="line-1437"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755713"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span class="hs-comment">-- ^ Typecheck a syntax operator</span><span>
</span><a name="line-1439"></a><span class="hs-comment">-- The operator is a variable or a lambda at this stage (i.e. renamer</span><span>
</span><a name="line-1440"></a><span class="hs-comment">-- output)</span><span>
</span><a name="line-1441"></a><a name="tcSyntaxOp"><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier">tcSyntaxOp</span></a></a><span> </span><a name="local-6989586621683756357"><a href="#local-6989586621683756357"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621683756358"><a href="#local-6989586621683756358"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683756359"><a href="#local-6989586621683756359"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-6989586621683756360"><a href="#local-6989586621683756360"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1442"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tcSyntaxOpGen"><span class="hs-identifier hs-var">tcSyntaxOpGen</span></a><span> </span><a href="#local-6989586621683756357"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756358"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756359"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynType</span><span> </span><a href="#local-6989586621683756360"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1443"></a><span>
</span><a name="line-1444"></a><span class="hs-comment">-- | Slightly more general version of 'tcSyntaxOp' that allows the caller</span><span>
</span><a name="line-1445"></a><span class="hs-comment">-- to specify the shape of the result of the syntax operator</span><span>
</span><a name="line-1446"></a><span class="hs-identifier">tcSyntaxOpGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-1447"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-1448"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SyntaxOpType</span><span class="hs-special">]</span><span>
</span><a name="line-1449"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxOpType</span><span>
</span><a name="line-1450"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755712"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1451"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755712"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1452"></a><a name="tcSyntaxOpGen"><a href="TcExpr.html#tcSyntaxOpGen"><span class="hs-identifier">tcSyntaxOpGen</span></a></a><span> </span><a name="local-6989586621683756361"><a href="#local-6989586621683756361"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621683756362"><a href="#local-6989586621683756362"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621683756363"><a href="#local-6989586621683756363"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-6989586621683756364"><a href="#local-6989586621683756364"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683756365"><a href="#local-6989586621683756365"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1453"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756366"><a href="#local-6989586621683756366"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756367"><a href="#local-6989586621683756367"><span class="hs-identifier">sigma</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">syn_expr</span><span> </span><a href="#local-6989586621683756362"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-1454"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756368"><a href="#local-6989586621683756368"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756369"><a href="#local-6989586621683756369"><span class="hs-identifier">expr_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756370"><a href="#local-6989586621683756370"><span class="hs-identifier">arg_wraps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756371"><a href="#local-6989586621683756371"><span class="hs-identifier">res_wrap</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1455"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSynArgA"><span class="hs-identifier hs-var">tcSynArgA</span></a><span> </span><a href="#local-6989586621683756361"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756367"><span class="hs-identifier hs-var">sigma</span></a><span> </span><a href="#local-6989586621683756363"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621683756364"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1456"></a><span>              </span><a href="#local-6989586621683756365"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1457"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756368"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SyntaxExpr</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">syn_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756369"><span class="hs-identifier hs-var">expr_wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756366"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1458"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_arg_wraps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756370"><span class="hs-identifier hs-var">arg_wraps</span></a><span>
</span><a name="line-1459"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_res_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756371"><span class="hs-identifier hs-var">res_wrap</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1460"></a><span>
</span><a name="line-1461"></a><span class="hs-comment">{-
Note [tcSynArg]
~~~~~~~~~~~~~~~
Because of the rich structure of SyntaxOpType, we must do the
contra-/covariant thing when working down arrows, to get the
instantiation vs. skolemisation decisions correct (and, more
obviously, the orientation of the HsWrappers). We thus have
two tcSynArgs.
-}</span><span>
</span><a name="line-1470"></a><span>
</span><a name="line-1471"></a><span class="hs-comment">-- works on &quot;expected&quot; types, skolemising where necessary</span><span>
</span><a name="line-1472"></a><span class="hs-comment">-- See Note [tcSynArg]</span><span>
</span><a name="line-1473"></a><span class="hs-identifier">tcSynArgE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-1474"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>
</span><a name="line-1475"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxOpType</span><span>                </span><span class="hs-comment">-- ^ shape it is expected to have</span><span>
</span><a name="line-1476"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755711"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ check the arguments</span><span>
</span><a name="line-1477"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755711"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">)</span><span>
</span><a name="line-1478"></a><span>           </span><span class="hs-comment">-- ^ returns a wrapper :: (type of right shape) &quot;-&gt;&quot; (type passed in)</span><span>
</span><a name="line-1479"></a><a name="tcSynArgE"><a href="TcExpr.html#tcSynArgE"><span class="hs-identifier">tcSynArgE</span></a></a><span> </span><a name="local-6989586621683756372"><a href="#local-6989586621683756372"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621683756373"><a href="#local-6989586621683756373"><span class="hs-identifier">sigma_ty</span></a></a><span> </span><a name="local-6989586621683756374"><a href="#local-6989586621683756374"><span class="hs-identifier">syn_ty</span></a></a><span> </span><a name="local-6989586621683756375"><a href="#local-6989586621683756375"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1480"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756409"><a href="#local-6989586621683756409"><span class="hs-identifier">skol_wrap</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756410"><a href="#local-6989586621683756410"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756411"><a href="#local-6989586621683756411"><span class="hs-identifier">ty_wrapper</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1481"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span> </span><a href="#local-6989586621683756373"><span class="hs-identifier hs-var">sigma_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756408"><a href="#local-6989586621683756408"><span class="hs-identifier">rho_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1482"></a><span>              </span><a href="#local-6989586621683756376"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683756408"><span class="hs-identifier hs-var">rho_ty</span></a><span> </span><a href="#local-6989586621683756374"><span class="hs-identifier hs-var">syn_ty</span></a><span>
</span><a name="line-1483"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756410"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756409"><span class="hs-identifier hs-var">skol_wrap</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683756411"><span class="hs-identifier hs-var">ty_wrapper</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1484"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1485"></a><span>    </span><a name="local-6989586621683756376"><a href="#local-6989586621683756376"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683756377"><a href="#local-6989586621683756377"><span class="hs-identifier">rho_ty</span></a></a><span> </span><span class="hs-identifier hs-var">SynAny</span><span>
</span><a name="line-1486"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756378"><a href="#local-6989586621683756378"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756375"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756377"><span class="hs-identifier hs-var">rho_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1487"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756378"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1488"></a><span>
</span><a name="line-1489"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756379"><a href="#local-6989586621683756379"><span class="hs-identifier">rho_ty</span></a></a><span> </span><span class="hs-identifier hs-var">SynRho</span><span>   </span><span class="hs-comment">-- same as SynAny, because we skolemise eagerly</span><span>
</span><a name="line-1490"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756380"><a href="#local-6989586621683756380"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756375"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756379"><span class="hs-identifier hs-var">rho_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1491"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756380"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1492"></a><span>
</span><a name="line-1493"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756381"><a href="#local-6989586621683756381"><span class="hs-identifier">rho_ty</span></a></a><span> </span><span class="hs-identifier hs-var">SynList</span><span>
</span><a name="line-1494"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756382"><a href="#local-6989586621683756382"><span class="hs-identifier">list_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756383"><a href="#local-6989586621683756383"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span> </span><a href="#local-6989586621683756381"><span class="hs-identifier hs-var">rho_ty</span></a><span>
</span><a name="line-1495"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756384"><a href="#local-6989586621683756384"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756375"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756383"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1496"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756384"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><a href="#local-6989586621683756382"><span class="hs-identifier hs-var">list_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1497"></a><span>
</span><a name="line-1498"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756385"><a href="#local-6989586621683756385"><span class="hs-identifier">rho_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynFun</span><span> </span><a name="local-6989586621683756386"><a href="#local-6989586621683756386"><span class="hs-identifier">arg_shape</span></a></a><span> </span><a name="local-6989586621683756387"><a href="#local-6989586621683756387"><span class="hs-identifier">res_shape</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756397"><a href="#local-6989586621683756397"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756398"><a href="#local-6989586621683756398"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756399"><a href="#local-6989586621683756399"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1500"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756400"><a href="#local-6989586621683756400"><span class="hs-identifier">res_wrapper</span></a></a><span> </span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- :: res_ty_out &quot;-&gt;&quot; res_ty</span><span>
</span><a name="line-1501"></a><span>               </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756401"><a href="#local-6989586621683756401"><span class="hs-identifier">arg_wrapper1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756402"><a href="#local-6989586621683756402"><span class="hs-identifier">arg_wrapper2</span></a></a><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- :: arg_ty &quot;-&gt;&quot; arg_ty_out</span><span>
</span><a name="line-1502"></a><span>             </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756403"><a href="#local-6989586621683756403"><span class="hs-identifier">match_wrapper</span></a></a><span> </span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- :: (arg_ty -&gt; res_ty) &quot;-&gt;&quot; rho_ty</span><span>
</span><a name="line-1503"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedFunTys"><span class="hs-identifier hs-var">matchExpectedFunTys</span></a><span> </span><a href="#local-6989586621683756388"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683756385"><span class="hs-identifier hs-var">rho_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1504"></a><span>                  </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683756390"><a href="#local-6989586621683756390"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">]</span><span> </span><a name="local-6989586621683756391"><a href="#local-6989586621683756391"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1505"></a><span>                  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756392"><a href="#local-6989586621683756392"><span class="hs-identifier">arg_tc_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683756390"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-1506"></a><span>                     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756393"><a href="#local-6989586621683756393"><span class="hs-identifier">res_tc_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683756391"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1507"></a><span>
</span><a name="line-1508"></a><span>                         </span><span class="hs-comment">-- another nested arrow is too much for now,</span><span>
</span><a name="line-1509"></a><span>                         </span><span class="hs-comment">-- but I bet we'll never need this</span><span>
</span><a name="line-1510"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">arg_shape</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1511"></a><span>                                   </span><span class="hs-identifier">SynFun</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span class="hs-special">;</span><span>
</span><a name="line-1512"></a><span>                                   </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-1513"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Too many nested arrows in SyntaxOpType&quot;</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-1514"></a><span>                                 </span><span class="hs-identifier">pprCtOrigin</span><span> </span><span class="hs-identifier">orig</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>
</span><a name="line-1516"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcSynArgA"><span class="hs-identifier hs-var">tcSynArgA</span></a><span> </span><a href="#local-6989586621683756372"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756392"><span class="hs-identifier hs-var">arg_tc_ty</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683756386"><span class="hs-identifier hs-var">arg_shape</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1517"></a><span>                       </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756394"><a href="#local-6989586621683756394"><span class="hs-identifier">arg_results</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1518"></a><span>                       </span><a href="TcExpr.html#tcSynArgE"><span class="hs-identifier hs-var">tcSynArgE</span></a><span> </span><a href="#local-6989586621683756372"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756393"><span class="hs-identifier hs-var">res_tc_ty</span></a><span> </span><a href="#local-6989586621683756387"><span class="hs-identifier hs-var">res_shape</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1519"></a><span>                       </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756395"><a href="#local-6989586621683756395"><span class="hs-identifier">res_results</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1520"></a><span>                       </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756396"><a href="#local-6989586621683756396"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756375"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756394"><span class="hs-identifier hs-var">arg_results</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683756395"><span class="hs-identifier hs-var">res_results</span></a><span class="hs-special">)</span><span>
</span><a name="line-1521"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756396"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756392"><span class="hs-identifier hs-var">arg_tc_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756393"><span class="hs-identifier hs-var">res_tc_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1522"></a><span>
</span><a name="line-1523"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621683756397"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-1524"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756403"><span class="hs-identifier hs-var">match_wrapper</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span>
</span><a name="line-1525"></a><span>                      </span><span class="hs-identifier hs-var">mkWpFun</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756402"><span class="hs-identifier hs-var">arg_wrapper2</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683756401"><span class="hs-identifier hs-var">arg_wrapper1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756400"><span class="hs-identifier hs-var">res_wrapper</span></a><span>
</span><a name="line-1526"></a><span>                              </span><a href="#local-6989586621683756398"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-6989586621683756399"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683756389"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1527"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1528"></a><span>        </span><a name="local-6989586621683756388"><a href="#local-6989586621683756388"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;This rebindable syntax expects a function with&quot;</span><span>
</span><a name="line-1529"></a><span>        </span><a name="local-6989586621683756389"><a href="#local-6989586621683756389"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking a rebindable syntax operator arising from&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756372"><span class="hs-identifier hs-var">orig</span></a><span>
</span><a name="line-1530"></a><span>
</span><a name="line-1531"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683756404"><a href="#local-6989586621683756404"><span class="hs-identifier">rho_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynType</span><span> </span><a name="local-6989586621683756405"><a href="#local-6989586621683756405"><span class="hs-identifier">the_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1532"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756406"><a href="#local-6989586621683756406"><span class="hs-identifier">wrap</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeET"><span class="hs-identifier hs-var">tcSubTypeET</span></a><span> </span><a href="#local-6989586621683756372"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span> </span><a href="#local-6989586621683756405"><span class="hs-identifier hs-var">the_ty</span></a><span> </span><a href="#local-6989586621683756404"><span class="hs-identifier hs-var">rho_ty</span></a><span>
</span><a name="line-1533"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756407"><a href="#local-6989586621683756407"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756375"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1534"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756407"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756406"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1535"></a><span>
</span><a name="line-1536"></a><span class="hs-comment">-- works on &quot;actual&quot; types, instantiating where necessary</span><span>
</span><a name="line-1537"></a><span class="hs-comment">-- See Note [tcSynArg]</span><span>
</span><a name="line-1538"></a><span class="hs-identifier">tcSynArgA</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-1539"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>
</span><a name="line-1540"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SyntaxOpType</span><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- ^ argument shapes</span><span>
</span><a name="line-1541"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxOpType</span><span>                </span><span class="hs-comment">-- ^ result shape</span><span>
</span><a name="line-1542"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755710"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ check the arguments</span><span>
</span><a name="line-1543"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683755710"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">)</span><span>
</span><a name="line-1544"></a><span>            </span><span class="hs-comment">-- ^ returns a wrapper to be applied to the original function,</span><span>
</span><a name="line-1545"></a><span>            </span><span class="hs-comment">-- wrappers to be applied to arguments</span><span>
</span><a name="line-1546"></a><span>            </span><span class="hs-comment">-- and a wrapper to be applied to the overall expression</span><span>
</span><a name="line-1547"></a><a name="tcSynArgA"><a href="TcExpr.html#tcSynArgA"><span class="hs-identifier">tcSynArgA</span></a></a><span> </span><a name="local-6989586621683756412"><a href="#local-6989586621683756412"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621683756413"><a href="#local-6989586621683756413"><span class="hs-identifier">sigma_ty</span></a></a><span> </span><a name="local-6989586621683756414"><a href="#local-6989586621683756414"><span class="hs-identifier">arg_shapes</span></a></a><span> </span><a name="local-6989586621683756415"><a href="#local-6989586621683756415"><span class="hs-identifier">res_shape</span></a></a><span> </span><a name="local-6989586621683756416"><a href="#local-6989586621683756416"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1548"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756453"><a href="#local-6989586621683756453"><span class="hs-identifier">match_wrapper</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756454"><a href="#local-6989586621683756454"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756455"><a href="#local-6989586621683756455"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1549"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier hs-var">matchActualFunTys</span></a><span> </span><a href="#local-6989586621683756417"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621683756412"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683756414"><span class="hs-identifier hs-var">arg_shapes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756413"><span class="hs-identifier hs-var">sigma_ty</span></a><span>
</span><a name="line-1550"></a><span>              </span><span class="hs-comment">-- match_wrapper :: sigma_ty &quot;-&gt;&quot; (arg_tys -&gt; res_ty)</span><span>
</span><a name="line-1551"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683756458"><a href="#local-6989586621683756458"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756459"><a href="#local-6989586621683756459"><span class="hs-identifier">res_wrapper</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756460"><a href="#local-6989586621683756460"><span class="hs-identifier">arg_wrappers</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1552"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756418"><span class="hs-identifier hs-var">tc_syn_args_e</span></a><span> </span><a href="#local-6989586621683756454"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621683756414"><span class="hs-identifier hs-var">arg_shapes</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756456"><a href="#local-6989586621683756456"><span class="hs-identifier">arg_results</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1553"></a><span>              </span><a href="#local-6989586621683756419"><span class="hs-identifier hs-var">tc_syn_arg</span></a><span>    </span><a href="#local-6989586621683756455"><span class="hs-identifier hs-var">res_ty</span></a><span>  </span><a href="#local-6989586621683756415"><span class="hs-identifier hs-var">res_shape</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756457"><a href="#local-6989586621683756457"><span class="hs-identifier">res_results</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1554"></a><span>              </span><a href="#local-6989586621683756416"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756456"><span class="hs-identifier hs-var">arg_results</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683756457"><span class="hs-identifier hs-var">res_results</span></a><span class="hs-special">)</span><span>
</span><a name="line-1555"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756458"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756453"><span class="hs-identifier hs-var">match_wrapper</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756460"><span class="hs-identifier hs-var">arg_wrappers</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756459"><span class="hs-identifier hs-var">res_wrapper</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1556"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1557"></a><span>    </span><a name="local-6989586621683756417"><a href="#local-6989586621683756417"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;This rebindable syntax expects a function with&quot;</span><span>
</span><a name="line-1558"></a><span>
</span><a name="line-1559"></a><span>    </span><span class="hs-identifier">tc_syn_args_e</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SyntaxOpType</span><span class="hs-special">]</span><span>
</span><a name="line-1560"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683756420"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1561"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756420"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1562"></a><span>                    </span><span class="hs-comment">-- the wrappers are for arguments</span><span>
</span><a name="line-1563"></a><span>    </span><a name="local-6989586621683756418"><a href="#local-6989586621683756418"><span class="hs-identifier">tc_syn_args_e</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683756422"><a href="#local-6989586621683756422"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756423"><a href="#local-6989586621683756423"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756424"><a href="#local-6989586621683756424"><span class="hs-identifier">arg_shape</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683756425"><a href="#local-6989586621683756425"><span class="hs-identifier">arg_shapes</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756426"><a href="#local-6989586621683756426"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1564"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683756429"><a href="#local-6989586621683756429"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756430"><a href="#local-6989586621683756430"><span class="hs-identifier">arg_wraps</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756431"><a href="#local-6989586621683756431"><span class="hs-identifier">arg_wrap</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSynArgE"><span class="hs-identifier hs-var">tcSynArgE</span></a><span>     </span><a href="#local-6989586621683756412"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756422"><span class="hs-identifier hs-var">arg_ty</span></a><span>  </span><a href="#local-6989586621683756424"><span class="hs-identifier hs-var">arg_shape</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756427"><a href="#local-6989586621683756427"><span class="hs-identifier">arg1_results</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1566"></a><span>                  </span><a href="#local-6989586621683756418"><span class="hs-identifier hs-var">tc_syn_args_e</span></a><span>      </span><a href="#local-6989586621683756423"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621683756425"><span class="hs-identifier hs-var">arg_shapes</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756428"><a href="#local-6989586621683756428"><span class="hs-identifier">args_results</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1567"></a><span>                  </span><a href="#local-6989586621683756426"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756427"><span class="hs-identifier hs-var">arg1_results</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683756428"><span class="hs-identifier hs-var">args_results</span></a><span class="hs-special">)</span><span>
</span><a name="line-1568"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756429"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756431"><span class="hs-identifier hs-var">arg_wrap</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756430"><span class="hs-identifier hs-var">arg_wraps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1569"></a><span>    </span><span class="hs-identifier">tc_syn_args_e</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756432"><a href="#local-6989586621683756432"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683756432"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1570"></a><span>
</span><a name="line-1571"></a><span>    </span><span class="hs-identifier">tc_syn_arg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxOpType</span><span>
</span><a name="line-1572"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683756421"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1573"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756421"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">)</span><span>
</span><a name="line-1574"></a><span>                  </span><span class="hs-comment">-- the wrapper applies to the overall result</span><span>
</span><a name="line-1575"></a><span>    </span><a name="local-6989586621683756419"><a href="#local-6989586621683756419"><span class="hs-identifier">tc_syn_arg</span></a></a><span> </span><a name="local-6989586621683756433"><a href="#local-6989586621683756433"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-identifier hs-var">SynAny</span><span> </span><a name="local-6989586621683756434"><a href="#local-6989586621683756434"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1576"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756435"><a href="#local-6989586621683756435"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756434"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756433"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1577"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756435"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1578"></a><span>    </span><span class="hs-identifier">tc_syn_arg</span><span> </span><a name="local-6989586621683756436"><a href="#local-6989586621683756436"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-identifier hs-var">SynRho</span><span> </span><a name="local-6989586621683756437"><a href="#local-6989586621683756437"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1579"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756438"><a href="#local-6989586621683756438"><span class="hs-identifier">inst_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756439"><a href="#local-6989586621683756439"><span class="hs-identifier">rho_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#deeplyInstantiate"><span class="hs-identifier hs-var">deeplyInstantiate</span></a><span> </span><a href="#local-6989586621683756412"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756436"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1580"></a><span>               </span><span class="hs-comment">-- inst_wrap :: res_ty &quot;-&gt;&quot; rho_ty</span><span>
</span><a name="line-1581"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756440"><a href="#local-6989586621683756440"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756437"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756439"><span class="hs-identifier hs-var">rho_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1582"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756440"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756438"><span class="hs-identifier hs-var">inst_wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1583"></a><span>    </span><span class="hs-identifier">tc_syn_arg</span><span> </span><a name="local-6989586621683756441"><a href="#local-6989586621683756441"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-identifier hs-var">SynList</span><span> </span><a name="local-6989586621683756442"><a href="#local-6989586621683756442"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1584"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756443"><a href="#local-6989586621683756443"><span class="hs-identifier">inst_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756444"><a href="#local-6989586621683756444"><span class="hs-identifier">rho_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-6989586621683756412"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683756441"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1585"></a><span>               </span><span class="hs-comment">-- inst_wrap :: res_ty &quot;-&gt;&quot; rho_ty</span><span>
</span><a name="line-1586"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756445"><a href="#local-6989586621683756445"><span class="hs-identifier">list_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756446"><a href="#local-6989586621683756446"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span> </span><a href="#local-6989586621683756444"><span class="hs-identifier hs-var">rho_ty</span></a><span>
</span><a name="line-1587"></a><span>               </span><span class="hs-comment">-- list_co :: [elt_ty] ~N rho_ty</span><span>
</span><a name="line-1588"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756447"><a href="#local-6989586621683756447"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756442"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756446"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1589"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756447"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621683756445"><span class="hs-identifier hs-var">list_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683756443"><span class="hs-identifier hs-var">inst_wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1590"></a><span>    </span><span class="hs-identifier">tc_syn_arg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynFun</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1591"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcSynArgA hits a SynFun&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756412"><span class="hs-identifier hs-var">orig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1592"></a><span>    </span><span class="hs-identifier">tc_syn_arg</span><span> </span><a name="local-6989586621683756448"><a href="#local-6989586621683756448"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynType</span><span> </span><a name="local-6989586621683756449"><a href="#local-6989586621683756449"><span class="hs-identifier">the_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756450"><a href="#local-6989586621683756450"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1593"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756451"><a href="#local-6989586621683756451"><span class="hs-identifier">wrap</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeO"><span class="hs-identifier hs-var">tcSubTypeO</span></a><span> </span><a href="#local-6989586621683756412"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span> </span><a href="#local-6989586621683756448"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683756449"><span class="hs-identifier hs-var">the_ty</span></a><span>
</span><a name="line-1594"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756452"><a href="#local-6989586621683756452"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756450"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1595"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756452"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756451"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1596"></a><span>
</span><a name="line-1597"></a><span class="hs-comment">{-
Note [Push result type in]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Unify with expected result before type-checking the args so that the
info from res_ty percolates to args.  This is when we might detect a
too-few args situation.  (One can think of cases when the opposite
order would give a better error message.)
experimenting with putting this first.

Here's an example where it actually makes a real difference

   class C t a b | t a -&gt; b
   instance C Char a Bool

   data P t a = forall b. (C t a b) =&gt; MkP b
   data Q t   = MkQ (forall a. P t a)

   f1, f2 :: Q Char;
   f1 = MkQ (MkP True)
   f2 = MkQ (MkP True :: forall a. P Char a)

With the change, f1 will type-check, because the 'Char' info from
the signature is propagated into MkQ's argument. With the check
in the other order, the extra signature in f2 is reqd.

************************************************************************
*                                                                      *
                Expressions with a type signature
                        expr :: type
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span class="hs-identifier">tcExprSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-1630"></a><a name="tcExprSig"><a href="TcExpr.html#tcExprSig"><span class="hs-identifier">tcExprSig</span></a></a><span> </span><a name="local-6989586621683756461"><a href="#local-6989586621683756461"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756462"><a href="#local-6989586621683756462"><span class="hs-identifier">poly_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756463"><a href="#local-6989586621683756463"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1631"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683756463"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-comment">-- Sets the location for the implication constraint</span><span>
</span><a name="line-1632"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756464"><a href="#local-6989586621683756464"><span class="hs-identifier">tv_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756465"><a href="#local-6989586621683756465"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756466"><a href="#local-6989586621683756466"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstType"><span class="hs-identifier hs-var">tcInstType</span></a><span> </span><a href="TcMType.html#tcInstSkolTyVars"><span class="hs-identifier hs-var">tcInstSkolTyVars</span></a><span> </span><a href="#local-6989586621683756462"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-1633"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756467"><a href="#local-6989586621683756467"><span class="hs-identifier">given</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newEvVars"><span class="hs-identifier hs-var">newEvVars</span></a><span> </span><a href="#local-6989586621683756465"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1634"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcExprSig: CompleteSig&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1635"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;poly_id:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756462"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756462"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1636"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tv_prs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756464"><span class="hs-identifier hs-var">tv_prs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1637"></a><span>
</span><a name="line-1638"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756468"><a href="#local-6989586621683756468"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SigSkol</span><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756462"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756464"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-1639"></a><span>             </span><a name="local-6989586621683756469"><a href="#local-6989586621683756469"><span class="hs-identifier">skol_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683756464"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-1640"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756470"><a href="#local-6989586621683756470"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756471"><a href="#local-6989586621683756471"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-6989586621683756468"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683756469"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-6989586621683756467"><span class="hs-identifier hs-var">given</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1641"></a><span>                              </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683756464"><span class="hs-identifier hs-var">tv_prs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1642"></a><span>                              </span><a href="TcExpr.html#tcPolyExprNC"><span class="hs-identifier hs-var">tcPolyExprNC</span></a><span> </span><a href="#local-6989586621683756461"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756466"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-1643"></a><span>
</span><a name="line-1644"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756472"><a href="#local-6989586621683756472"><span class="hs-identifier">poly_wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpTyLams</span><span>   </span><a href="#local-6989586621683756469"><span class="hs-identifier hs-var">skol_tvs</span></a><span>
</span><a name="line-1645"></a><span>                         </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpLams</span><span> </span><a href="#local-6989586621683756467"><span class="hs-identifier hs-var">given</span></a><span>
</span><a name="line-1646"></a><span>                         </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpLet</span><span>  </span><a href="#local-6989586621683756470"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1647"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683756472"><span class="hs-identifier hs-var">poly_wrap</span></a><span> </span><a href="#local-6989586621683756471"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756462"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1648"></a><span>
</span><a name="line-1649"></a><span class="hs-identifier">tcExprSig</span><span> </span><a name="local-6989586621683756473"><a href="#local-6989586621683756473"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683756474"><a href="#local-6989586621683756474"><span class="hs-identifier">sig</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756475"><a href="#local-6989586621683756475"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756476"><a href="#local-6989586621683756476"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1650"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683756476"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-comment">-- Sets the location for the implication constraint</span><span>
</span><a name="line-1651"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756479"><a href="#local-6989586621683756479"><span class="hs-identifier">tclvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756480"><a href="#local-6989586621683756480"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756481"><a href="#local-6989586621683756481"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756482"><a href="#local-6989586621683756482"><span class="hs-identifier">sig_inst</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1652"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1653"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756477"><a href="#local-6989586621683756477"><span class="hs-identifier">sig_inst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcInstSig"><span class="hs-identifier hs-var">tcInstSig</span></a><span> </span><a href="#local-6989586621683756474"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1654"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756478"><a href="#local-6989586621683756478"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_inst_skols</span><span> </span><a href="#local-6989586621683756477"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1655"></a><span>                              </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_inst_wcs</span><span>   </span><a href="#local-6989586621683756477"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1656"></a><span>                              </span><a href="TcExpr.html#tcPolyExprNC"><span class="hs-identifier hs-var">tcPolyExprNC</span></a><span> </span><a href="#local-6989586621683756473"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_inst_tau</span><span> </span><a href="#local-6989586621683756477"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1657"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756478"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756477"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1658"></a><span>       </span><span class="hs-comment">-- See Note [Partial expression signatures]</span><span>
</span><a name="line-1659"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756483"><a href="#local-6989586621683756483"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sig_inst_tau</span><span> </span><a href="#local-6989586621683756482"><span class="hs-identifier hs-var">sig_inst</span></a><span>
</span><a name="line-1660"></a><span>             </span><a name="local-6989586621683756484"><a href="#local-6989586621683756484"><span class="hs-identifier">infer_mode</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_inst_theta</span><span> </span><a href="#local-6989586621683756482"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1661"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sig_inst_wcx</span><span> </span><a href="#local-6989586621683756482"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1662"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#ApplyMR"><span class="hs-identifier hs-var">ApplyMR</span></a><span>
</span><a name="line-1663"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1664"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="TcSimplify.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a><span>
</span><a name="line-1665"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756485"><a href="#local-6989586621683756485"><span class="hs-identifier">qtvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756486"><a href="#local-6989586621683756486"><span class="hs-identifier">givens</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756487"><a href="#local-6989586621683756487"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756488"><a href="#local-6989586621683756488"><span class="hs-identifier">residual</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1666"></a><span>                 </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simplifyInfer"><span class="hs-identifier hs-var">simplifyInfer</span></a><span> </span><a href="#local-6989586621683756479"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-6989586621683756484"><span class="hs-identifier hs-var">infer_mode</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756482"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683756475"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756483"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683756480"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-1667"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier hs-var">emitConstraints</span></a><span> </span><a href="#local-6989586621683756488"><span class="hs-identifier hs-var">residual</span></a><span>
</span><a name="line-1668"></a><span>
</span><a name="line-1669"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756489"><a href="#local-6989586621683756489"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683756483"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-1670"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756490"><a href="#local-6989586621683756490"><span class="hs-identifier">inferred_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">evVarPred</span><span> </span><a href="#local-6989586621683756486"><span class="hs-identifier hs-var">givens</span></a><span>
</span><a name="line-1671"></a><span>             </span><a name="local-6989586621683756491"><a href="#local-6989586621683756491"><span class="hs-identifier">tau_tvs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683756489"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-1672"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756492"><a href="#local-6989586621683756492"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756493"><a href="#local-6989586621683756493"><span class="hs-identifier">my_theta</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#chooseInferredQuantifiers"><span class="hs-identifier hs-var">chooseInferredQuantifiers</span></a><span> </span><a href="#local-6989586621683756490"><span class="hs-identifier hs-var">inferred_theta</span></a><span>
</span><a name="line-1673"></a><span>                                   </span><a href="#local-6989586621683756491"><span class="hs-identifier hs-var">tau_tvs</span></a><span> </span><a href="#local-6989586621683756485"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756482"><span class="hs-identifier hs-var">sig_inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1674"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756494"><a href="#local-6989586621683756494"><span class="hs-identifier">inferred_sigma</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInfSigmaTy</span><span> </span><a href="#local-6989586621683756485"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><a href="#local-6989586621683756490"><span class="hs-identifier hs-var">inferred_theta</span></a><span> </span><a href="#local-6989586621683756489"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-1675"></a><span>             </span><a name="local-6989586621683756495"><a href="#local-6989586621683756495"><span class="hs-identifier">my_sigma</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkForAllTys</span><span> </span><a href="#local-6989586621683756492"><span class="hs-identifier hs-var">binders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPhiTy</span><span>  </span><a href="#local-6989586621683756493"><span class="hs-identifier hs-var">my_theta</span></a><span> </span><a href="#local-6989586621683756489"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span>
</span><a name="line-1676"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756496"><a href="#local-6989586621683756496"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683756494"><span class="hs-identifier hs-var">inferred_sigma</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756495"><span class="hs-identifier hs-var">my_sigma</span></a><span> </span><span class="hs-comment">-- NB: eqType ignores vis.</span><span>
</span><a name="line-1677"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span>  </span><span class="hs-comment">-- Fast path; also avoids complaint when we infer</span><span>
</span><a name="line-1678"></a><span>                                          </span><span class="hs-comment">-- an ambiguous type and have AllowAmbiguousType</span><span>
</span><a name="line-1679"></a><span>                                          </span><span class="hs-comment">-- e..g infer  x :: forall a. F a -&gt; Int</span><span>
</span><a name="line-1680"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span> </span><a href="#local-6989586621683756494"><span class="hs-identifier hs-var">inferred_sigma</span></a><span> </span><a href="#local-6989586621683756495"><span class="hs-identifier hs-var">my_sigma</span></a><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcExpSig&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756485"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756486"><span class="hs-identifier hs-var">givens</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756494"><span class="hs-identifier hs-var">inferred_sigma</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756495"><span class="hs-identifier hs-var">my_sigma</span></a><span class="hs-special">)</span><span>
</span><a name="line-1683"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756497"><a href="#local-6989586621683756497"><span class="hs-identifier">poly_wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756496"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-1684"></a><span>                         </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpTyLams</span><span> </span><a href="#local-6989586621683756485"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-1685"></a><span>                         </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpLams</span><span> </span><a href="#local-6989586621683756486"><span class="hs-identifier hs-var">givens</span></a><span>
</span><a name="line-1686"></a><span>                         </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpLet</span><span>  </span><a href="#local-6989586621683756487"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1687"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683756497"><span class="hs-identifier hs-var">poly_wrap</span></a><span> </span><a href="#local-6989586621683756481"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756495"><span class="hs-identifier hs-var">my_sigma</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1688"></a><span>
</span><a name="line-1689"></a><span>
</span><a name="line-1690"></a><span class="hs-comment">{- Note [Partial expression signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Partial type signatures on expressions are easy to get wrong.  But
here is a guiding principile
    e :: ty
should behave like
    let x :: ty
        x = e
    in x

So for partial signatures we apply the MR if no context is given.  So
   e :: IO _          apply the MR
   e :: _ =&gt; IO _     do not apply the MR
just like in TcBinds.decideGeneralisationPlan

This makes a difference (Trac #11670):
   peek :: Ptr a -&gt; IO CLong
   peek ptr = peekElemOff undefined 0 :: _
from (peekElemOff undefined 0) we get
          type: IO w
   constraints: Storable w

We must NOT try to generalise over 'w' because the signature specifies
no constraints so we'll complain about not being able to solve
Storable w.  Instead, don't generalise; then _ gets instantiated to
CLong, as it should.
-}</span><span>
</span><a name="line-1717"></a><span>
</span><a name="line-1718"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                 tcInferId
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1723"></a><span>
</span><a name="line-1724"></a><span class="hs-identifier">tcCheckId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1725"></a><a name="tcCheckId"><a href="TcExpr.html#tcCheckId"><span class="hs-identifier">tcCheckId</span></a></a><span> </span><a name="local-6989586621683756498"><a href="#local-6989586621683756498"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683756499"><a href="#local-6989586621683756499"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1726"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756500"><a href="#local-6989586621683756500"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756501"><a href="#local-6989586621683756501"><span class="hs-identifier">actual_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferId"><span class="hs-identifier hs-var">tcInferId</span></a><span> </span><a href="#local-6989586621683756498"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1727"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcCheckId&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756498"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756501"><span class="hs-identifier hs-var">actual_res_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756499"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1728"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#addFunResCtxt"><span class="hs-identifier hs-var">addFunResCtxt</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756498"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756501"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756499"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1729"></a><span>         </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a href="#local-6989586621683756498"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756498"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756500"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1730"></a><span>                                                          </span><a href="#local-6989586621683756501"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756499"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1731"></a><span>
</span><a name="line-1732"></a><span class="hs-identifier">tcCheckRecSelId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1733"></a><a name="tcCheckRecSelId"><a href="TcExpr.html#tcCheckRecSelId"><span class="hs-identifier">tcCheckRecSelId</span></a></a><span> </span><a name="local-6989586621683756502"><a href="#local-6989586621683756502"><span class="hs-identifier">rn_expr</span></a></a><span> </span><a name="local-6989586621683756503"><a href="#local-6989586621683756503"><span class="hs-identifier">f</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756504"><a href="#local-6989586621683756504"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756505"><a href="#local-6989586621683756505"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1734"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756506"><a href="#local-6989586621683756506"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756507"><a href="#local-6989586621683756507"><span class="hs-identifier">actual_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferRecSelId"><span class="hs-identifier hs-var">tcInferRecSelId</span></a><span> </span><a href="#local-6989586621683756503"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-1735"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#addFunResCtxt"><span class="hs-identifier hs-var">addFunResCtxt</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683756503"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756507"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756505"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1736"></a><span>         </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOfRecSel</span><span> </span><a href="#local-6989586621683756504"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756502"><span class="hs-identifier hs-var">rn_expr</span></a><span> </span><a href="#local-6989586621683756506"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621683756507"><span class="hs-identifier hs-var">actual_res_ty</span></a><span> </span><a href="#local-6989586621683756505"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1737"></a><span class="hs-identifier">tcCheckRecSelId</span><span> </span><a name="local-6989586621683756508"><a href="#local-6989586621683756508"><span class="hs-identifier">rn_expr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ambiguous</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756509"><a href="#local-6989586621683756509"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756510"><a href="#local-6989586621683756510"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1738"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTy_maybe</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="TcMType.html#checkingExpType_maybe"><span class="hs-identifier hs-var">checkingExpType_maybe</span></a><span> </span><a href="#local-6989586621683756510"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1739"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcExpr.html#ambiguousSelector"><span class="hs-identifier hs-var">ambiguousSelector</span></a><span> </span><a href="#local-6989586621683756509"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-1740"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756511"><a href="#local-6989586621683756511"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756512"><a href="#local-6989586621683756512"><span class="hs-identifier">sel_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#disambiguateSelector"><span class="hs-identifier hs-var">disambiguateSelector</span></a><span> </span><a href="#local-6989586621683756509"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621683756511"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1741"></a><span>                          </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcCheckRecSelId"><span class="hs-identifier hs-var">tcCheckRecSelId</span></a><span> </span><a href="#local-6989586621683756508"><span class="hs-identifier hs-var">rn_expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a href="#local-6989586621683756512"><span class="hs-identifier hs-var">sel_name</span></a><span> </span><a href="#local-6989586621683756509"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1742"></a><span>                                                    </span><a href="#local-6989586621683756510"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1743"></a><span class="hs-identifier">tcCheckRecSelId</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XAmbiguousFieldOcc</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcCheckRecSelId&quot;</span><span>
</span><a name="line-1744"></a><span>
</span><a name="line-1745"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1746"></a><span class="hs-identifier">tcInferRecSelId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span class="hs-special">)</span><span>
</span><a name="line-1747"></a><a name="tcInferRecSelId"><a href="TcExpr.html#tcInferRecSelId"><span class="hs-identifier">tcInferRecSelId</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a name="local-6989586621683756513"><a href="#local-6989586621683756513"><span class="hs-identifier">sel</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756514"><a href="#local-6989586621683756514"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1748"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756515"><a href="#local-6989586621683756515"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756516"><a href="#local-6989586621683756516"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tc_infer_id"><span class="hs-identifier hs-var">tc_infer_id</span></a><span> </span><a href="#local-6989586621683756514"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621683756513"><span class="hs-identifier hs-var">sel</span></a><span>
</span><a name="line-1749"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756515"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756516"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1750"></a><span class="hs-identifier">tcInferRecSelId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ambiguous</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756517"><a href="#local-6989586621683756517"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1751"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#ambiguousSelector"><span class="hs-identifier hs-var">ambiguousSelector</span></a><span> </span><a href="#local-6989586621683756517"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-1752"></a><span class="hs-identifier">tcInferRecSelId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XAmbiguousFieldOcc</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcInferRecSelId&quot;</span><span>
</span><a name="line-1753"></a><span>
</span><a name="line-1754"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1755"></a><span class="hs-identifier">tcInferId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span>
</span><a name="line-1756"></a><span class="hs-comment">-- Look up an occurrence of an Id</span><span>
</span><a name="line-1757"></a><span class="hs-comment">-- Do not instantiate its type</span><span>
</span><a name="line-1758"></a><a name="tcInferId"><a href="TcExpr.html#tcInferId"><span class="hs-identifier">tcInferId</span></a></a><span> </span><a name="local-6989586621683756518"><a href="#local-6989586621683756518"><span class="hs-identifier">id_name</span></a></a><span>
</span><a name="line-1759"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tagToEnumKey</span><span>
</span><a name="line-1760"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tagToEnum# must appear applied to one argument&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1761"></a><span>        </span><span class="hs-comment">-- tcApp catches the case (tagToEnum# arg)</span><span>
</span><a name="line-1762"></a><span>
</span><a name="line-1763"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">assertIdKey</span><span>
</span><a name="line-1764"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756519"><a href="#local-6989586621683756519"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1765"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_IgnoreAsserts</span><span> </span><a href="#local-6989586621683756519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1766"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="TcExpr.html#tc_infer_id"><span class="hs-identifier hs-var">tc_infer_id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameRdrName</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span>
</span><a name="line-1767"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="TcExpr.html#tc_infer_assert"><span class="hs-identifier hs-var">tc_infer_assert</span></a><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1768"></a><span>
</span><a name="line-1769"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1770"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756520"><a href="#local-6989586621683756520"><span class="hs-identifier">expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756521"><a href="#local-6989586621683756521"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tc_infer_id"><span class="hs-identifier hs-var">tc_infer_id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameRdrName</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span>
</span><a name="line-1771"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferId&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756518"><span class="hs-identifier hs-var">id_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756521"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1772"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756520"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756521"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-identifier">tc_infer_assert</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span>
</span><a name="line-1775"></a><span class="hs-comment">-- Deal with an occurrence of 'assert'</span><span>
</span><a name="line-1776"></a><span class="hs-comment">-- See Note [Adding the implicit parameter to 'assert']</span><span>
</span><a name="line-1777"></a><a name="tc_infer_assert"><a href="TcExpr.html#tc_infer_assert"><span class="hs-identifier">tc_infer_assert</span></a></a><span> </span><a name="local-6989586621683756522"><a href="#local-6989586621683756522"><span class="hs-identifier">assert_name</span></a></a><span>
</span><a name="line-1778"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756523"><a href="#local-6989586621683756523"><span class="hs-identifier">assert_error_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-identifier hs-var">assertErrorName</span><span>
</span><a name="line-1779"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756524"><a href="#local-6989586621683756524"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756525"><a href="#local-6989586621683756525"><span class="hs-identifier">id_rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a href="#local-6989586621683756522"><span class="hs-identifier hs-var">assert_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1780"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756523"><span class="hs-identifier hs-var">assert_error_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1781"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756524"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756523"><span class="hs-identifier hs-var">assert_error_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756525"><span class="hs-identifier hs-var">id_rho</span></a><span class="hs-special">)</span><span>
</span><a name="line-1782"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1783"></a><span>
</span><a name="line-1784"></a><span class="hs-identifier">tc_infer_id</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span>
</span><a name="line-1785"></a><a name="tc_infer_id"><a href="TcExpr.html#tc_infer_id"><span class="hs-identifier">tc_infer_id</span></a></a><span> </span><a name="local-6989586621683756526"><a href="#local-6989586621683756526"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621683756527"><a href="#local-6989586621683756527"><span class="hs-identifier">id_name</span></a></a><span>
</span><a name="line-1786"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756545"><a href="#local-6989586621683756545"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621683756527"><span class="hs-identifier hs-var">id_name</span></a><span>
</span><a name="line-1787"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756545"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1788"></a><span>             </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756546"><a href="#local-6989586621683756546"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1789"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621683756530"><span class="hs-identifier hs-var">check_naughty</span></a><span> </span><a href="#local-6989586621683756546"><span class="hs-identifier hs-var">id</span></a><span>        </span><span class="hs-comment">-- Note [Local record selectors]</span><span>
</span><a name="line-1790"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#checkThLocalId"><span class="hs-identifier hs-var">checkThLocalId</span></a><span> </span><a href="#local-6989586621683756546"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1791"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683756528"><span class="hs-identifier hs-var">return_id</span></a><span> </span><a href="#local-6989586621683756546"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1792"></a><span>
</span><a name="line-1793"></a><span>             </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621683756547"><a href="#local-6989586621683756547"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1794"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621683756530"><span class="hs-identifier hs-var">check_naughty</span></a><span> </span><a href="#local-6989586621683756547"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1795"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683756528"><span class="hs-identifier hs-var">return_id</span></a><span> </span><a href="#local-6989586621683756547"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1796"></a><span>                    </span><span class="hs-comment">-- A global cannot possibly be ill-staged</span><span>
</span><a name="line-1797"></a><span>                    </span><span class="hs-comment">-- nor does it need the 'lifting' treatment</span><span>
</span><a name="line-1798"></a><span>                    </span><span class="hs-comment">-- hence no checkTh stuff here</span><span>
</span><a name="line-1799"></a><span>
</span><a name="line-1800"></a><span>             </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><a name="local-6989586621683756548"><a href="#local-6989586621683756548"><span class="hs-identifier">cl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756548"><span class="hs-identifier hs-var">cl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1801"></a><span>                 </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621683756549"><a href="#local-6989586621683756549"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683756529"><span class="hs-identifier hs-var">return_data_con</span></a><span> </span><a href="#local-6989586621683756549"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1802"></a><span>                 </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621683756550"><a href="#local-6989586621683756550"><span class="hs-identifier">ps</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPatSyn.html#tcPatSynBuilderOcc"><span class="hs-identifier hs-var">tcPatSynBuilderOcc</span></a><span> </span><a href="#local-6989586621683756550"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-1803"></a><span>
</span><a name="line-1804"></a><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1805"></a><span>                  </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756545"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;used where a value identifier was expected&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1806"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1807"></a><span>    </span><a name="local-6989586621683756528"><a href="#local-6989586621683756528"><span class="hs-identifier">return_id</span></a></a><span> </span><a name="local-6989586621683756531"><a href="#local-6989586621683756531"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756531"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756531"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1808"></a><span>
</span><a name="line-1809"></a><span>    </span><a name="local-6989586621683756529"><a href="#local-6989586621683756529"><span class="hs-identifier">return_data_con</span></a></a><span> </span><a name="local-6989586621683756532"><a href="#local-6989586621683756532"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-1810"></a><span>       </span><span class="hs-comment">-- For data constructors, must perform the stupid-theta check</span><span>
</span><a name="line-1811"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756534"><span class="hs-identifier hs-var">stupid_theta</span></a><span>
</span><a name="line-1812"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a href="#local-6989586621683756532"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756533"><span class="hs-identifier hs-var">con_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1813"></a><span>
</span><a name="line-1814"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1815"></a><span>       </span><span class="hs-comment">-- See Note [Instantiating stupid theta]</span><span>
</span><a name="line-1816"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756535"><a href="#local-6989586621683756535"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756536"><a href="#local-6989586621683756536"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756537"><a href="#local-6989586621683756537"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621683756533"><span class="hs-identifier hs-var">con_ty</span></a><span>
</span><a name="line-1817"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756538"><a href="#local-6989586621683756538"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756539"><a href="#local-6989586621683756539"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a><span> </span><a href="#local-6989586621683756535"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1818"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756540"><a href="#local-6989586621683756540"><span class="hs-identifier">tys'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683756539"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-1819"></a><span>                 </span><a name="local-6989586621683756541"><a href="#local-6989586621683756541"><span class="hs-identifier">theta'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621683756538"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683756536"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1820"></a><span>                 </span><a name="local-6989586621683756542"><a href="#local-6989586621683756542"><span class="hs-identifier">rho'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683756538"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683756537"><span class="hs-identifier hs-var">rho</span></a><span>
</span><a name="line-1821"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756543"><a href="#local-6989586621683756543"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a href="#local-6989586621683756527"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756540"><span class="hs-identifier hs-var">tys'</span></a><span> </span><a href="#local-6989586621683756541"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-1822"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcPat.html#addDataConStupidTheta"><span class="hs-identifier hs-var">addDataConStupidTheta</span></a><span> </span><a href="#local-6989586621683756532"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683756540"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-1823"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621683756543"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a href="#local-6989586621683756532"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1824"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756542"><span class="hs-identifier hs-var">rho'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1825"></a><span>
</span><a name="line-1826"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1827"></a><span>        </span><a name="local-6989586621683756533"><a href="#local-6989586621683756533"><span class="hs-identifier">con_ty</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConUserType</span><span> </span><a href="#local-6989586621683756532"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1828"></a><span>        </span><a name="local-6989586621683756534"><a href="#local-6989586621683756534"><span class="hs-identifier">stupid_theta</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConStupidTheta</span><span> </span><a href="#local-6989586621683756532"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1829"></a><span>
</span><a name="line-1830"></a><span>    </span><a name="local-6989586621683756530"><a href="#local-6989586621683756530"><span class="hs-identifier">check_naughty</span></a></a><span> </span><a name="local-6989586621683756544"><a href="#local-6989586621683756544"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1831"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNaughtyRecordSelector</span><span> </span><a href="#local-6989586621683756544"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#naughtyRecordSel"><span class="hs-identifier hs-var">naughtyRecordSel</span></a><span> </span><a href="#local-6989586621683756526"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1832"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1833"></a><span>
</span><a name="line-1834"></a><span>
</span><a name="line-1835"></a><span class="hs-identifier">tcUnboundId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UnboundVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1836"></a><span class="hs-comment">-- Typecheck an occurrence of an unbound Id</span><span>
</span><a name="line-1837"></a><span class="hs-comment">--</span><span>
</span><a name="line-1838"></a><span class="hs-comment">-- Some of these started life as a true expression hole &quot;_&quot;.</span><span>
</span><a name="line-1839"></a><span class="hs-comment">-- Others might simply be variables that accidentally have no binding site</span><span>
</span><a name="line-1840"></a><span class="hs-comment">--</span><span>
</span><a name="line-1841"></a><span class="hs-comment">-- We turn all of them into HsVar, since HsUnboundVar can't contain an</span><span>
</span><a name="line-1842"></a><span class="hs-comment">-- Id; and indeed the evidence for the CHoleCan does bind it, so it's</span><span>
</span><a name="line-1843"></a><span class="hs-comment">-- not unbound any more!</span><span>
</span><a name="line-1844"></a><a name="tcUnboundId"><a href="TcExpr.html#tcUnboundId"><span class="hs-identifier">tcUnboundId</span></a></a><span> </span><a name="local-6989586621683756551"><a href="#local-6989586621683756551"><span class="hs-identifier">rn_expr</span></a></a><span> </span><a name="local-6989586621683756552"><a href="#local-6989586621683756552"><span class="hs-identifier">unbound</span></a></a><span> </span><a name="local-6989586621683756553"><a href="#local-6989586621683756553"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1845"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756554"><a href="#local-6989586621683756554"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenFlexiTyVarTy"><span class="hs-identifier hs-var">newOpenFlexiTyVarTy</span></a><span>  </span><span class="hs-comment">-- Allow Int# etc (Trac #12531)</span><span>
</span><a name="line-1846"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756555"><a href="#local-6989586621683756555"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unboundVarOcc</span><span> </span><a href="#local-6989586621683756552"><span class="hs-identifier hs-var">unbound</span></a><span>
</span><a name="line-1847"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756556"><a href="#local-6989586621683756556"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newSysName"><span class="hs-identifier hs-var">newSysName</span></a><span> </span><a href="#local-6989586621683756555"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-1848"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756557"><a href="#local-6989586621683756557"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683756556"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683756554"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1849"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756558"><a href="#local-6989586621683756558"><span class="hs-identifier">can</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newHoleCt"><span class="hs-identifier hs-var">newHoleCt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExprHole</span><span> </span><a href="#local-6989586621683756552"><span class="hs-identifier hs-var">unbound</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756557"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621683756554"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1850"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitInsoluble"><span class="hs-identifier hs-var">emitInsoluble</span></a><span> </span><a href="#local-6989586621683756558"><span class="hs-identifier hs-var">can</span></a><span>
</span><a name="line-1851"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnboundOccurrenceOf</span><span> </span><a href="#local-6989586621683756555"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756551"><span class="hs-identifier hs-var">rn_expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756557"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1852"></a><span>                                                                     </span><a href="#local-6989586621683756554"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683756553"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1853"></a><span>
</span><a name="line-1854"></a><span>
</span><a name="line-1855"></a><span class="hs-comment">{-
Note [Adding the implicit parameter to 'assert']
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The typechecker transforms (assert e1 e2) to (assertError e1 e2).
This isn't really the Right Thing because there's no way to &quot;undo&quot;
if you want to see the original source code in the typechecker
output.  We'll have fix this in due course, when we care more about
being able to reconstruct the exact original program.

Note [tagToEnum#]
~~~~~~~~~~~~~~~~~
Nasty check to ensure that tagToEnum# is applied to a type that is an
enumeration TyCon.  Unification may refine the type later, but this
check won't see that, alas.  It's crude, because it relies on our
knowing *now* that the type is ok, which in turn relies on the
eager-unification part of the type checker pushing enough information
here.  In theory the Right Thing to do is to have a new form of
constraint but I definitely cannot face that!  And it works ok as-is.

Here's are two cases that should fail
        f :: forall a. a
        f = tagToEnum# 0        -- Can't do tagToEnum# at a type variable

        g :: Int
        g = tagToEnum# 0        -- Int is not an enumeration

When data type families are involved it's a bit more complicated.
     data family F a
     data instance F [Int] = A | B | C
Then we want to generate something like
     tagToEnum# R:FListInt 3# |&gt; co :: R:FListInt ~ F [Int]
Usually that coercion is hidden inside the wrappers for
constructors of F [Int] but here we have to do it explicitly.

It's all grotesquely complicated.

Note [Instantiating stupid theta]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Normally, when we infer the type of an Id, we don't instantiate,
because we wish to allow for visible type application later on.
But if a datacon has a stupid theta, we're a bit stuck. We need
to emit the stupid theta constraints with instantiated types. It's
difficult to defer this to the lazy instantiation, because a stupid
theta has no spot to put it in a type. So we just instantiate eagerly
in this case. Thus, users cannot use visible type application with
a data constructor sporting a stupid theta. I won't feel so bad for
the users that complain.

-}</span><span>
</span><a name="line-1904"></a><span>
</span><a name="line-1905"></a><span class="hs-identifier">tcTagToEnum</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier hs-type">LHsExprArgIn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-1906"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgOut"><span class="hs-identifier hs-type">LHsExprArgOut</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1907"></a><span class="hs-comment">-- tagToEnum# :: forall a. Int# -&gt; a</span><span>
</span><a name="line-1908"></a><span class="hs-comment">-- See Note [tagToEnum#]   Urgh!</span><span>
</span><a name="line-1909"></a><a name="tcTagToEnum"><a href="TcExpr.html#tcTagToEnum"><span class="hs-identifier">tcTagToEnum</span></a></a><span> </span><a name="local-6989586621683756559"><a href="#local-6989586621683756559"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683756560"><a href="#local-6989586621683756560"><span class="hs-identifier">fun_name</span></a></a><span> </span><a name="local-6989586621683756561"><a href="#local-6989586621683756561"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683756562"><a href="#local-6989586621683756562"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-1910"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756568"><a href="#local-6989586621683756568"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683756560"><span class="hs-identifier hs-var">fun_name</span></a><span>
</span><a name="line-1911"></a><span>
</span><a name="line-1912"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756569"><a href="#local-6989586621683756569"><span class="hs-identifier">pars1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="TcExpr.html#isArgPar_maybe"><span class="hs-identifier hs-var">isArgPar_maybe</span></a><span> </span><a href="#local-6989586621683756571"><span class="hs-identifier hs-var">before</span></a><span>
</span><a name="line-1913"></a><span>             </span><a name="local-6989586621683756570"><a href="#local-6989586621683756570"><span class="hs-identifier">pars2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="TcExpr.html#isArgPar_maybe"><span class="hs-identifier hs-var">isArgPar_maybe</span></a><span> </span><a href="#local-6989586621683756572"><span class="hs-identifier hs-var">after</span></a><span>
</span><a name="line-1914"></a><span>             </span><span class="hs-comment">-- args contains exactly one HsValArg</span><span>
</span><a name="line-1915"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621683756571"><a href="#local-6989586621683756571"><span class="hs-identifier">before</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621683756572"><a href="#local-6989586621683756572"><span class="hs-identifier">after</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><a href="TcExpr.html#isHsValArg"><span class="hs-identifier hs-var">isHsValArg</span></a><span> </span><a href="#local-6989586621683756561"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756577"><a href="#local-6989586621683756577"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><a href="TcExpr.html#isArgPar"><span class="hs-identifier hs-var">isArgPar</span></a><span> </span><a href="#local-6989586621683756561"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1918"></a><span>           </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756573"><a href="#local-6989586621683756573"><span class="hs-identifier">hs_ty_arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683756574"><a href="#local-6989586621683756574"><span class="hs-identifier">term_arg</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-1919"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756575"><a href="#local-6989586621683756575"><span class="hs-identifier">ty_arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsTypeApp"><span class="hs-identifier hs-var">tcHsTypeApp</span></a><span> </span><a href="#local-6989586621683756573"><span class="hs-identifier hs-var">hs_ty_arg</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-1920"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSubTypeDS"><span class="hs-identifier hs-var">tcSubTypeDS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a href="#local-6989586621683756560"><span class="hs-identifier hs-var">fun_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span> </span><a href="#local-6989586621683756575"><span class="hs-identifier hs-var">ty_arg</span></a><span> </span><a href="#local-6989586621683756562"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1921"></a><span>                     </span><span class="hs-comment">-- other than influencing res_ty, we just</span><span>
</span><a name="line-1922"></a><span>                     </span><span class="hs-comment">-- don't care about a type arg passed in.</span><span>
</span><a name="line-1923"></a><span>                     </span><span class="hs-comment">-- So drop the evidence.</span><span>
</span><a name="line-1924"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756574"><span class="hs-identifier hs-var">term_arg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1925"></a><span>           </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683756576"><a href="#local-6989586621683756576"><span class="hs-identifier">term_arg</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683756562"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1926"></a><span>                                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756576"><span class="hs-identifier hs-var">term_arg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1927"></a><span>           </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcExpr.html#too_many_args"><span class="hs-identifier hs-var">too_many_args</span></a><span> </span><span class="hs-string">&quot;tagToEnum#&quot;</span><span> </span><a href="#local-6989586621683756561"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1928"></a><span>
</span><a name="line-1929"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756578"><a href="#local-6989586621683756578"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683756562"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1930"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756579"><a href="#local-6989586621683756579"><span class="hs-identifier">ty'</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683756578"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1931"></a><span>
</span><a name="line-1932"></a><span>       </span><span class="hs-comment">-- Check that the type is algebraic</span><span>
</span><a name="line-1933"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756580"><a href="#local-6989586621683756580"><span class="hs-identifier">mb_tc_app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683756579"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1934"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756581"><a href="#local-6989586621683756581"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756582"><a href="#local-6989586621683756582"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756580"><span class="hs-identifier hs-var">mb_tc_app</span></a><span>
</span><a name="line-1935"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621683756580"><span class="hs-identifier hs-var">mb_tc_app</span></a><span class="hs-special">)</span><span>
</span><a name="line-1936"></a><span>                 </span><span class="hs-special">(</span><a href="#local-6989586621683756565"><span class="hs-identifier hs-var">mk_error</span></a><span> </span><a href="#local-6989586621683756579"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683756563"><span class="hs-identifier hs-var">doc1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1937"></a><span>
</span><a name="line-1938"></a><span>       </span><span class="hs-comment">-- Look through any type family</span><span>
</span><a name="line-1939"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756583"><a href="#local-6989586621683756583"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-1940"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756584"><a href="#local-6989586621683756584"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756585"><a href="#local-6989586621683756585"><span class="hs-identifier">rep_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756586"><a href="#local-6989586621683756586"><span class="hs-identifier">coi</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1941"></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><a href="#local-6989586621683756583"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621683756581"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683756582"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1942"></a><span>            </span><span class="hs-comment">-- coi :: tc tc_args ~R rep_tc rep_args</span><span>
</span><a name="line-1943"></a><span>
</span><a name="line-1944"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEnumerationTyCon</span><span> </span><a href="#local-6989586621683756584"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1945"></a><span>                 </span><span class="hs-special">(</span><a href="#local-6989586621683756565"><span class="hs-identifier hs-var">mk_error</span></a><span> </span><a href="#local-6989586621683756579"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621683756564"><span class="hs-identifier hs-var">doc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1946"></a><span>
</span><a name="line-1947"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756587"><a href="#local-6989586621683756587"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683756577"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span class="hs-special">)</span><span>
</span><a name="line-1948"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756588"><a href="#local-6989586621683756588"><span class="hs-identifier">fun'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756559"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a href="#local-6989586621683756589"><span class="hs-identifier hs-var">rep_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756559"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756568"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1949"></a><span>             </span><a name="local-6989586621683756589"><a href="#local-6989586621683756589"><span class="hs-identifier">rep_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683756584"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><a href="#local-6989586621683756585"><span class="hs-identifier hs-var">rep_args</span></a><span>
</span><a name="line-1950"></a><span>             </span><a name="local-6989586621683756590"><a href="#local-6989586621683756590"><span class="hs-identifier">out_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-1951"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683756569"><span class="hs-identifier hs-var">pars1</span></a><span>
</span><a name="line-1952"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683756587"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">]</span><span>
</span><a name="line-1953"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756570"><span class="hs-identifier hs-var">pars2</span></a><span>
</span><a name="line-1954"></a><span>              </span><span class="hs-special">]</span><span>
</span><a name="line-1955"></a><span>
</span><a name="line-1956"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpCastR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621683756586"><span class="hs-identifier hs-var">coi</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756588"><span class="hs-identifier hs-var">fun'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756590"><span class="hs-identifier hs-var">out_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1957"></a><span>                 </span><span class="hs-comment">-- coi is a Representational coercion</span><span>
</span><a name="line-1958"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1959"></a><span>    </span><a name="local-6989586621683756563"><a href="#local-6989586621683756563"><span class="hs-identifier">doc1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Specify the type by giving a type signature&quot;</span><span>
</span><a name="line-1960"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;e.g. (tagToEnum# x) :: Bool&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1961"></a><span>    </span><a name="local-6989586621683756564"><a href="#local-6989586621683756564"><span class="hs-identifier">doc2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Result type must be an enumeration type&quot;</span><span>
</span><a name="line-1962"></a><span>
</span><a name="line-1963"></a><span>    </span><span class="hs-identifier">mk_error</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1964"></a><span>    </span><a name="local-6989586621683756565"><a href="#local-6989586621683756565"><span class="hs-identifier">mk_error</span></a></a><span> </span><a name="local-6989586621683756566"><a href="#local-6989586621683756566"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683756567"><a href="#local-6989586621683756567"><span class="hs-identifier">what</span></a></a><span>
</span><a name="line-1965"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Bad call to tagToEnum#&quot;</span><span>
</span><a name="line-1966"></a><span>               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;at type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756566"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1967"></a><span>           </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621683756567"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-1968"></a><span>
</span><a name="line-1969"></a><span class="hs-identifier">too_many_args</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcExpr.html#LHsExprArgIn"><span class="hs-identifier hs-type">LHsExprArgIn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755709"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1970"></a><a name="too_many_args"><a href="TcExpr.html#too_many_args"><span class="hs-identifier">too_many_args</span></a></a><span> </span><a name="local-6989586621683756591"><a href="#local-6989586621683756591"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756592"><a href="#local-6989586621683756592"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1971"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1972"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Too many type arguments to&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683756591"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-1973"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683756593"><span class="hs-identifier hs-var">pp</span></a><span> </span><a href="#local-6989586621683756592"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1974"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1975"></a><span>    </span><a name="local-6989586621683756593"><a href="#local-6989586621683756593"><span class="hs-identifier">pp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683756594"><a href="#local-6989586621683756594"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756594"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1976"></a><span>    </span><span class="hs-identifier">pp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hswc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756595"><a href="#local-6989586621683756595"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprHsType</span><span> </span><a href="#local-6989586621683756595"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1977"></a><span>    </span><span class="hs-identifier">pp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsWildCardBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;too_many_args&quot;</span><span>
</span><a name="line-1978"></a><span>    </span><span class="hs-identifier">pp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1979"></a><span>
</span><a name="line-1980"></a><span>
</span><a name="line-1981"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                 Template Haskell checks
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1988"></a><span>
</span><a name="line-1989"></a><span class="hs-identifier">checkThLocalId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1990"></a><a name="checkThLocalId"><a href="TcExpr.html#checkThLocalId"><span class="hs-identifier">checkThLocalId</span></a></a><span> </span><a name="local-6989586621683756596"><a href="#local-6989586621683756596"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756597"><a href="#local-6989586621683756597"><span class="hs-identifier">mb_local_use</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStageAndBindLevel"><span class="hs-identifier hs-var">getStageAndBindLevel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683756596"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1992"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756597"><span class="hs-identifier hs-var">mb_local_use</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1993"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756598"><a href="#local-6989586621683756598"><span class="hs-identifier">top_lvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756599"><a href="#local-6989586621683756599"><span class="hs-identifier">bind_lvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756600"><a href="#local-6989586621683756600"><span class="hs-identifier">use_stage</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1994"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thLevel</span><span> </span><a href="#local-6989586621683756600"><span class="hs-identifier hs-var">use_stage</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621683756599"><span class="hs-identifier hs-var">bind_lvl</span></a><span>
</span><a name="line-1995"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcExpr.html#checkCrossStageLifting"><span class="hs-identifier hs-var">checkCrossStageLifting</span></a><span> </span><a href="#local-6989586621683756598"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621683756596"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621683756600"><span class="hs-identifier hs-var">use_stage</span></a><span>
</span><a name="line-1996"></a><span>             </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Not a locally-bound thing, or</span><span>
</span><a name="line-1997"></a><span>                               </span><span class="hs-comment">-- no cross-stage link</span><span>
</span><a name="line-1998"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1999"></a><span>
</span><a name="line-2000"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-2001"></a><span class="hs-identifier">checkCrossStageLifting</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2002"></a><span class="hs-comment">-- If we are inside typed brackets, and (use_lvl &gt; bind_lvl)</span><span>
</span><a name="line-2003"></a><span class="hs-comment">-- we must check whether there's a cross-stage lift to do</span><span>
</span><a name="line-2004"></a><span class="hs-comment">-- Examples   \x -&gt; [|| x ||]</span><span>
</span><a name="line-2005"></a><span class="hs-comment">--            [|| map ||]</span><span>
</span><a name="line-2006"></a><span class="hs-comment">-- There is no error-checking to do, because the renamer did that</span><span>
</span><a name="line-2007"></a><span class="hs-comment">--</span><span>
</span><a name="line-2008"></a><span class="hs-comment">-- This is similar to checkCrossStageLifting in RnSplice, but</span><span>
</span><a name="line-2009"></a><span class="hs-comment">-- this code is applied to *typed* brackets.</span><span>
</span><a name="line-2010"></a><span>
</span><a name="line-2011"></a><a name="checkCrossStageLifting"><a href="TcExpr.html#checkCrossStageLifting"><span class="hs-identifier">checkCrossStageLifting</span></a></a><span> </span><a name="local-6989586621683756601"><a href="#local-6989586621683756601"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621683756602"><a href="#local-6989586621683756602"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Brack</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcPending</span><span> </span><a name="local-6989586621683756603"><a href="#local-6989586621683756603"><span class="hs-identifier">ps_var</span></a></a><span> </span><a name="local-6989586621683756604"><a href="#local-6989586621683756604"><span class="hs-identifier">lie_var</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2012"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621683756601"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-2013"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621683756605"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#keepAlive"><span class="hs-identifier hs-var">keepAlive</span></a><span> </span><a href="#local-6989586621683756605"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2014"></a><span>    </span><span class="hs-comment">-- See Note [Keeping things alive for Template Haskell] in RnSplice</span><span>
</span><a name="line-2015"></a><span>
</span><a name="line-2016"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2017"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- Nested identifiers, such as 'x' in</span><span>
</span><a name="line-2018"></a><span>        </span><span class="hs-comment">-- E.g. \x -&gt; [|| h x ||]</span><span>
</span><a name="line-2019"></a><span>        </span><span class="hs-comment">-- We must behave as if the reference to x was</span><span>
</span><a name="line-2020"></a><span>        </span><span class="hs-comment">--      h $(lift x)</span><span>
</span><a name="line-2021"></a><span>        </span><span class="hs-comment">-- We use 'x' itself as the splice proxy, used by</span><span>
</span><a name="line-2022"></a><span>        </span><span class="hs-comment">-- the desugarer to stitch it all back together.</span><span>
</span><a name="line-2023"></a><span>        </span><span class="hs-comment">-- If 'x' occurs many times we may get many identical</span><span>
</span><a name="line-2024"></a><span>        </span><span class="hs-comment">-- bindings of the same splice proxy, but that doesn't</span><span>
</span><a name="line-2025"></a><span>        </span><span class="hs-comment">-- matter, although it's a mite untidy.</span><span>
</span><a name="line-2026"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756606"><a href="#local-6989586621683756606"><span class="hs-identifier">id_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756602"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-2027"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTauTy</span><span> </span><a href="#local-6989586621683756606"><span class="hs-identifier hs-var">id_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#polySpliceErr"><span class="hs-identifier hs-var">polySpliceErr</span></a><span> </span><a href="#local-6989586621683756602"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><span>               </span><span class="hs-comment">-- If x is polymorphic, its occurrence sites might</span><span>
</span><a name="line-2029"></a><span>               </span><span class="hs-comment">-- have different instantiations, so we can't use plain</span><span>
</span><a name="line-2030"></a><span>               </span><span class="hs-comment">-- 'x' as the splice proxy name.  I don't know how to</span><span>
</span><a name="line-2031"></a><span>               </span><span class="hs-comment">-- solve this, and it's probably unimportant, so I'm</span><span>
</span><a name="line-2032"></a><span>               </span><span class="hs-comment">-- just going to flag an error for now</span><span>
</span><a name="line-2033"></a><span>
</span><a name="line-2034"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756608"><a href="#local-6989586621683756608"><span class="hs-identifier">lift</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isStringTy</span><span> </span><a href="#local-6989586621683756606"><span class="hs-identifier hs-var">id_ty</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-2035"></a><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756607"><a href="#local-6989586621683756607"><span class="hs-identifier">sid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="THNames.html#liftStringName"><span class="hs-identifier hs-var">THNames.liftStringName</span></a><span>
</span><a name="line-2036"></a><span>                                     </span><span class="hs-comment">-- See Note [Lifting strings]</span><span>
</span><a name="line-2037"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756607"><span class="hs-identifier hs-var">sid</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2038"></a><span>                  </span><span class="hs-keyword">else</span><span>
</span><a name="line-2039"></a><span>                     </span><a href="TcRnMonad.html#setConstraintVar"><span class="hs-identifier hs-var">setConstraintVar</span></a><span> </span><a href="#local-6989586621683756604"><span class="hs-identifier hs-var">lie_var</span></a><span>   </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2040"></a><span>                          </span><span class="hs-comment">-- Put the 'lift' constraint into the right LIE</span><span>
</span><a name="line-2041"></a><span>                     </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a href="#local-6989586621683756605"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2042"></a><span>                                       </span><a href="THNames.html#liftName"><span class="hs-identifier hs-var">THNames.liftName</span></a><span> </span><a href="#local-6989586621683756606"><span class="hs-identifier hs-var">id_ty</span></a><span>
</span><a name="line-2043"></a><span>
</span><a name="line-2044"></a><span>                   </span><span class="hs-comment">-- Update the pending splices</span><span>
</span><a name="line-2045"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756609"><a href="#local-6989586621683756609"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621683756603"><span class="hs-identifier hs-var">ps_var</span></a><span>
</span><a name="line-2046"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756610"><a href="#local-6989586621683756610"><span class="hs-identifier">pending_splice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PendingTcSplice</span><span> </span><a href="#local-6989586621683756605"><span class="hs-identifier hs-var">id_name</span></a><span>
</span><a name="line-2047"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683756608"><span class="hs-identifier hs-var">lift</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683756602"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2048"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><a href="#local-6989586621683756603"><span class="hs-identifier hs-var">ps_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756610"><span class="hs-identifier hs-var">pending_splice</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756609"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-2049"></a><span>
</span><a name="line-2050"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2051"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2052"></a><span>    </span><a name="local-6989586621683756605"><a href="#local-6989586621683756605"><span class="hs-identifier">id_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683756602"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-2053"></a><span>
</span><a name="line-2054"></a><span class="hs-identifier">checkCrossStageLifting</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2055"></a><span>
</span><a name="line-2056"></a><span class="hs-identifier">polySpliceErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2057"></a><a name="polySpliceErr"><a href="TcExpr.html#polySpliceErr"><span class="hs-identifier">polySpliceErr</span></a></a><span> </span><a name="local-6989586621683756611"><a href="#local-6989586621683756611"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-2058"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't splice the polymorphic local variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756611"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2059"></a><span>
</span><a name="line-2060"></a><span class="hs-comment">{-
Note [Lifting strings]
~~~~~~~~~~~~~~~~~~~~~~
If we see $(... [| s |] ...) where s::String, we don't want to
generate a mass of Cons (CharL 'x') (Cons (CharL 'y') ...)) etc.
So this conditional short-circuits the lifting mechanism to generate
(liftString &quot;xy&quot;) in that case.  I didn't want to use overlapping instances
for the Lift class in TH.Syntax, because that can lead to overlapping-instance
errors in a polymorphic situation.

If this check fails (which isn't impossible) we get another chance; see
Note [Converting strings] in Convert.hs

Local record selectors
~~~~~~~~~~~~~~~~~~~~~~
Record selectors for TyCons in this module are ordinary local bindings,
which show up as ATcIds rather than AGlobals.  So we need to check for
naughtiness in both branches.  c.f. TcTyClsBindings.mkAuxBinds.


************************************************************************
*                                                                      *
\subsection{Record bindings}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2086"></a><span>
</span><a name="line-2087"></a><span class="hs-identifier">getFixedTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVarSet</span><span>
</span><a name="line-2088"></a><span class="hs-comment">-- These tyvars must not change across the updates</span><span>
</span><a name="line-2089"></a><a name="getFixedTyVars"><a href="TcExpr.html#getFixedTyVars"><span class="hs-identifier">getFixedTyVars</span></a></a><span> </span><a name="local-6989586621683756612"><a href="#local-6989586621683756612"><span class="hs-identifier">upd_fld_occs</span></a></a><span> </span><a name="local-6989586621683756613"><a href="#local-6989586621683756613"><span class="hs-identifier">univ_tvs</span></a></a><span> </span><a name="local-6989586621683756614"><a href="#local-6989586621683756614"><span class="hs-identifier">cons</span></a></a><span>
</span><a name="line-2090"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756627"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683756615"><a href="#local-6989586621683756615"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756614"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-2091"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756616"><a href="#local-6989586621683756616"><span class="hs-identifier">u_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756617"><a href="#local-6989586621683756617"><span class="hs-identifier">eqspec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756618"><a href="#local-6989586621683756618"><span class="hs-identifier">prov_theta</span></a></a><span>
</span><a name="line-2092"></a><span>                             </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756619"><a href="#local-6989586621683756619"><span class="hs-identifier">req_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756620"><a href="#local-6989586621683756620"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-2093"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFullSig</span><span> </span><a href="#local-6989586621683756615"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2094"></a><span>                            </span><a name="local-6989586621683756621"><a href="#local-6989586621683756621"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqSpecPreds</span><span> </span><a href="#local-6989586621683756617"><span class="hs-identifier hs-var">eqspec</span></a><span>
</span><a name="line-2095"></a><span>                                     </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683756618"><span class="hs-identifier hs-var">prov_theta</span></a><span>
</span><a name="line-2096"></a><span>                                     </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683756619"><span class="hs-identifier hs-var">req_theta</span></a><span>
</span><a name="line-2097"></a><span>                            </span><a name="local-6989586621683756622"><a href="#local-6989586621683756622"><span class="hs-identifier">flds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621683756615"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2098"></a><span>                            </span><a name="local-6989586621683756623"><a href="#local-6989586621683756623"><span class="hs-identifier">fixed_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exactTyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683756624"><span class="hs-identifier hs-var">fixed_tys</span></a><span>
</span><a name="line-2099"></a><span>                                    </span><span class="hs-comment">-- fixed_tys: See Note [Type of a record update]</span><span>
</span><a name="line-2100"></a><span>                                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683756621"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-2101"></a><span>                                    </span><span class="hs-comment">-- Universally-quantified tyvars that</span><span>
</span><a name="line-2102"></a><span>                                    </span><span class="hs-comment">-- appear in any of the *implicit*</span><span>
</span><a name="line-2103"></a><span>                                    </span><span class="hs-comment">-- arguments to the constructor are fixed</span><span>
</span><a name="line-2104"></a><span>                                    </span><span class="hs-comment">-- See Note [Implicit type sharing]</span><span>
</span><a name="line-2105"></a><span>
</span><a name="line-2106"></a><span>                            </span><a name="local-6989586621683756624"><a href="#local-6989586621683756624"><span class="hs-identifier">fixed_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756626"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756625"><a href="#local-6989586621683756625"><span class="hs-identifier">fl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756626"><a href="#local-6989586621683756626"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621683756622"><span class="hs-identifier hs-var">flds</span></a><span> </span><a href="#local-6989586621683756620"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-2107"></a><span>                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621683756625"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756612"><span class="hs-identifier hs-var">upd_fld_occs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2108"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756627"><a href="#local-6989586621683756627"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683756628"><a href="#local-6989586621683756628"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756613"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756616"><span class="hs-identifier hs-var">u_tvs</span></a><span>
</span><a name="line-2109"></a><span>                      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756628"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756623"><span class="hs-identifier hs-var">fixed_tvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2110"></a><span>
</span><a name="line-2111"></a><span class="hs-comment">{-
Note [Disambiguating record fields]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the -XDuplicateRecordFields extension is used, and the renamer
encounters a record selector or update that it cannot immediately
disambiguate (because it involves fields that belong to multiple
datatypes), it will defer resolution of the ambiguity to the
typechecker.  In this case, the `Ambiguous` constructor of
`AmbiguousFieldOcc` is used.

Consider the following definitions:

        data S = MkS { foo :: Int }
        data T = MkT { foo :: Int, bar :: Int }
        data U = MkU { bar :: Int, baz :: Int }

When the renamer sees `foo` as a selector or an update, it will not
know which parent datatype is in use.

For selectors, there are two possible ways to disambiguate:

1. Check if the pushed-in type is a function whose domain is a
   datatype, for example:

       f s = (foo :: S -&gt; Int) s

       g :: T -&gt; Int
       g = foo

    This is checked by `tcCheckRecSelId` when checking `HsRecFld foo`.

2. Check if the selector is applied to an argument that has a type
   signature, for example:

       h = foo (s :: S)

    This is checked by `tcApp`.


Updates are slightly more complex.  The `disambiguateRecordBinds`
function tries to determine the parent datatype in three ways:

1. Check for types that have all the fields being updated. For example:

        f x = x { foo = 3, bar = 2 }

   Here `f` must be updating `T` because neither `S` nor `U` have
   both fields. This may also discover that no possible type exists.
   For example the following will be rejected:

        f' x = x { foo = 3, baz = 3 }

2. Use the type being pushed in, if it is already a TyConApp. The
   following are valid updates to `T`:

        g :: T -&gt; T
        g x = x { foo = 3 }

        g' x = x { foo = 3 } :: T

3. Use the type signature of the record expression, if it exists and
   is a TyConApp. Thus this is valid update to `T`:

        h x = (x :: T) { foo = 3 }


Note that we do not look up the types of variables being updated, and
no constraint-solving is performed, so for example the following will
be rejected as ambiguous:

     let bad (s :: S) = foo s

     let r :: T
         r = blah
     in r { foo = 3 }

     \r. (r { foo = 3 },  r :: T )

We could add further tests, of a more heuristic nature. For example,
rather than looking for an explicit signature, we could try to infer
the type of the argument to a selector or the record expression being
updated, in case we are lucky enough to get a TyConApp straight
away. However, it might be hard for programmers to predict whether a
particular update is sufficiently obvious for the signature to be
omitted. Moreover, this might change the behaviour of typechecker in
non-obvious ways.

See also Note [HsRecField and HsRecUpdField] in HsPat.
-}</span><span>
</span><a name="line-2200"></a><span>
</span><a name="line-2201"></a><span class="hs-comment">-- Given a RdrName that refers to multiple record fields, and the type</span><span>
</span><a name="line-2202"></a><span class="hs-comment">-- of its argument, try to determine the name of the selector that is</span><span>
</span><a name="line-2203"></a><span class="hs-comment">-- meant.</span><span>
</span><a name="line-2204"></a><span class="hs-identifier">disambiguateSelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-2205"></a><a name="disambiguateSelector"><a href="TcExpr.html#disambiguateSelector"><span class="hs-identifier">disambiguateSelector</span></a></a><span> </span><a name="local-6989586621683756629"><a href="#local-6989586621683756629"><span class="hs-identifier">lr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756630"><a href="#local-6989586621683756630"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683756631"><a href="#local-6989586621683756631"><span class="hs-identifier">parent_type</span></a></a><span>
</span><a name="line-2206"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756632"><a href="#local-6989586621683756632"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-2207"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcExpr.html#tyConOf"><span class="hs-identifier hs-var">tyConOf</span></a><span> </span><a href="#local-6989586621683756632"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621683756631"><span class="hs-identifier hs-var">parent_type</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2208"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcExpr.html#ambiguousSelector"><span class="hs-identifier hs-var">ambiguousSelector</span></a><span> </span><a href="#local-6989586621683756629"><span class="hs-identifier hs-var">lr</span></a><span>
</span><a name="line-2209"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756633"><a href="#local-6989586621683756633"><span class="hs-identifier">p</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2210"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756634"><a href="#local-6989586621683756634"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#lookupParents"><span class="hs-identifier hs-var">lookupParents</span></a><span> </span><a href="#local-6989586621683756630"><span class="hs-identifier hs-var">rdr</span></a><span>
</span><a name="line-2211"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756635"><a href="#local-6989586621683756635"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a href="#local-6989586621683756633"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-2212"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621683756635"><span class="hs-identifier hs-var">parent</span></a><span> </span><a href="#local-6989586621683756634"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2213"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756636"><a href="#local-6989586621683756636"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnEnv.html#addUsedGRE"><span class="hs-identifier hs-var">addUsedGRE</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621683756636"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-2214"></a><span>                                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683756636"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2215"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#fieldNotInType"><span class="hs-identifier hs-var">fieldNotInType</span></a><span> </span><a href="#local-6989586621683756635"><span class="hs-identifier hs-var">parent</span></a><span> </span><a href="#local-6989586621683756630"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2216"></a><span>
</span><a name="line-2217"></a><span class="hs-comment">-- This field name really is ambiguous, so add a suitable &quot;ambiguous</span><span>
</span><a name="line-2218"></a><span class="hs-comment">-- occurrence&quot; error, then give up.</span><span>
</span><a name="line-2219"></a><span class="hs-identifier">ambiguousSelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755708"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2220"></a><a name="ambiguousSelector"><a href="TcExpr.html#ambiguousSelector"><span class="hs-identifier">ambiguousSelector</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756637"><a href="#local-6989586621683756637"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2221"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756638"><a href="#local-6989586621683756638"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-2222"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756639"><a href="#local-6989586621683756639"><span class="hs-identifier">gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupGRE_RdrName</span><span> </span><a href="#local-6989586621683756637"><span class="hs-identifier hs-var">rdr</span></a><span> </span><a href="#local-6989586621683756638"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2223"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setErrCtxt"><span class="hs-identifier hs-var">setErrCtxt</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnUtils.html#addNameClashErrRn"><span class="hs-identifier hs-var">addNameClashErrRn</span></a><span> </span><a href="#local-6989586621683756637"><span class="hs-identifier hs-var">rdr</span></a><span> </span><a href="#local-6989586621683756639"><span class="hs-identifier hs-var">gres</span></a><span>
</span><a name="line-2224"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">failM</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2225"></a><span>
</span><a name="line-2226"></a><span class="hs-comment">-- Disambiguate the fields in a record update.</span><span>
</span><a name="line-2227"></a><span class="hs-comment">-- See Note [Disambiguating record fields]</span><span>
</span><a name="line-2228"></a><span class="hs-identifier">disambiguateRecordBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span>
</span><a name="line-2229"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-2230"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecField'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2231"></a><a name="disambiguateRecordBinds"><a href="TcExpr.html#disambiguateRecordBinds"><span class="hs-identifier">disambiguateRecordBinds</span></a></a><span> </span><a name="local-6989586621683756640"><a href="#local-6989586621683756640"><span class="hs-identifier">record_expr</span></a></a><span> </span><a name="local-6989586621683756641"><a href="#local-6989586621683756641"><span class="hs-identifier">record_rho</span></a></a><span> </span><a name="local-6989586621683756642"><a href="#local-6989586621683756642"><span class="hs-identifier">rbnds</span></a></a><span> </span><a name="local-6989586621683756643"><a href="#local-6989586621683756643"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-2232"></a><span>    </span><span class="hs-comment">-- Are all the fields unambiguous?</span><span>
</span><a name="line-2233"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683756644"><span class="hs-identifier hs-var">isUnambiguous</span></a><span> </span><a href="#local-6989586621683756642"><span class="hs-identifier hs-var">rbnds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2234"></a><span>                     </span><span class="hs-comment">-- If so, just skip to looking up the Ids</span><span>
</span><a name="line-2235"></a><span>                     </span><span class="hs-comment">-- Always the case if DuplicateRecordFields is off</span><span>
</span><a name="line-2236"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756668"><a href="#local-6989586621683756668"><span class="hs-identifier">rbnds'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683756648"><span class="hs-identifier hs-var">lookupSelector</span></a><span> </span><a href="#local-6989586621683756668"><span class="hs-identifier hs-var">rbnds'</span></a><span>
</span><a name="line-2237"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- If not, try to identify a single parent</span><span>
</span><a name="line-2238"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756669"><a href="#local-6989586621683756669"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-2239"></a><span>             </span><span class="hs-comment">-- Look up the possible parents for each field</span><span>
</span><a name="line-2240"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756670"><a href="#local-6989586621683756670"><span class="hs-identifier">rbnds_with_parents</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756645"><span class="hs-identifier hs-var">getUpdFieldsParents</span></a><span>
</span><a name="line-2241"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756671"><a href="#local-6989586621683756671"><span class="hs-identifier">possible_parents</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756670"><span class="hs-identifier hs-var">rbnds_with_parents</span></a><span>
</span><a name="line-2242"></a><span>             </span><span class="hs-comment">-- Identify a single parent</span><span>
</span><a name="line-2243"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756672"><a href="#local-6989586621683756672"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756646"><span class="hs-identifier hs-var">identifyParent</span></a><span> </span><a href="#local-6989586621683756669"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621683756671"><span class="hs-identifier hs-var">possible_parents</span></a><span>
</span><a name="line-2244"></a><span>             </span><span class="hs-comment">-- Pick the right selector with that parent for each field</span><span>
</span><a name="line-2245"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756647"><span class="hs-identifier hs-var">pickParent</span></a><span> </span><a href="#local-6989586621683756672"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756670"><span class="hs-identifier hs-var">rbnds_with_parents</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2246"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2247"></a><span>    </span><span class="hs-comment">-- Extract the selector name of a field update if it is unambiguous</span><span>
</span><a name="line-2248"></a><span>    </span><span class="hs-identifier">isUnambiguous</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-2249"></a><span>    </span><a name="local-6989586621683756644"><a href="#local-6989586621683756644"><span class="hs-identifier">isUnambiguous</span></a></a><span> </span><a name="local-6989586621683756649"><a href="#local-6989586621683756649"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756649"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2250"></a><span>                        </span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a name="local-6989586621683756650"><a href="#local-6989586621683756650"><span class="hs-identifier">sel_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756649"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756650"><span class="hs-identifier hs-var">sel_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2251"></a><span>                        </span><span class="hs-identifier hs-var">Ambiguous</span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2252"></a><span>                        </span><span class="hs-identifier hs-var">XAmbiguousFieldOcc</span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2253"></a><span>
</span><a name="line-2254"></a><span>    </span><span class="hs-comment">-- Look up the possible parents and selector GREs for each field</span><span>
</span><a name="line-2255"></a><span>    </span><span class="hs-identifier">getUpdFieldsParents</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-2256"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecSelParent</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2257"></a><span>    </span><a name="local-6989586621683756645"><a href="#local-6989586621683756645"><span class="hs-identifier">getUpdFieldsParents</span></a></a><span>
</span><a name="line-2258"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621683756642"><span class="hs-identifier hs-var">rbnds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span>
</span><a name="line-2259"></a><span>          </span><span class="hs-special">(</span><a href="TcExpr.html#lookupParents"><span class="hs-identifier hs-var">lookupParents</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">hsRecUpdFieldRdr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span>
</span><a name="line-2260"></a><span>          </span><a href="#local-6989586621683756642"><span class="hs-identifier hs-var">rbnds</span></a><span>
</span><a name="line-2261"></a><span>
</span><a name="line-2262"></a><span>    </span><span class="hs-comment">-- Given a the lists of possible parents for each field,</span><span>
</span><a name="line-2263"></a><span>    </span><span class="hs-comment">-- identify a single parent</span><span>
</span><a name="line-2264"></a><span>    </span><span class="hs-identifier">identifyParent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">RecSelParent</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">RecSelParent</span><span>
</span><a name="line-2265"></a><span>    </span><a name="local-6989586621683756646"><a href="#local-6989586621683756646"><span class="hs-identifier">identifyParent</span></a></a><span> </span><a name="local-6989586621683756651"><a href="#local-6989586621683756651"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-6989586621683756652"><a href="#local-6989586621683756652"><span class="hs-identifier">possible_parents</span></a></a><span>
</span><a name="line-2266"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-identifier hs-var">intersect</span><span> </span><a href="#local-6989586621683756652"><span class="hs-identifier hs-var">possible_parents</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2267"></a><span>        </span><span class="hs-comment">-- No parents for all fields: record update is ill-typed</span><span>
</span><a name="line-2268"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#noPossibleParents"><span class="hs-identifier hs-var">noPossibleParents</span></a><span> </span><a href="#local-6989586621683756642"><span class="hs-identifier hs-var">rbnds</span></a><span class="hs-special">)</span><span>
</span><a name="line-2269"></a><span>
</span><a name="line-2270"></a><span>        </span><span class="hs-comment">-- Exactly one datatype with all the fields: use that</span><span>
</span><a name="line-2271"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621683756653"><a href="#local-6989586621683756653"><span class="hs-identifier">p</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756653"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-2272"></a><span>
</span><a name="line-2273"></a><span>        </span><span class="hs-comment">-- Multiple possible parents: try harder to disambiguate</span><span>
</span><a name="line-2274"></a><span>        </span><span class="hs-comment">-- Can we get a parent TyCon from the pushed-in type?</span><span>
</span><a name="line-2275"></a><span>        </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756654"><a href="#local-6989586621683756654"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tyConOfET"><span class="hs-identifier hs-var">tyConOfET</span></a><span> </span><a href="#local-6989586621683756651"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621683756643"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a href="#local-6989586621683756654"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-2276"></a><span>
</span><a name="line-2277"></a><span>        </span><span class="hs-comment">-- Does the expression being updated have a type signature?</span><span>
</span><a name="line-2278"></a><span>        </span><span class="hs-comment">-- If so, try to extract a parent TyCon from it</span><span>
</span><a name="line-2279"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#obviousSig"><span class="hs-identifier hs-var">obviousSig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756640"><span class="hs-identifier hs-var">record_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2280"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756655"><a href="#local-6989586621683756655"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tyConOf"><span class="hs-identifier hs-var">tyConOf</span></a><span> </span><a href="#local-6989586621683756651"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621683756641"><span class="hs-identifier hs-var">record_rho</span></a><span>
</span><a name="line-2281"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a href="#local-6989586621683756655"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2282"></a><span>
</span><a name="line-2283"></a><span>        </span><span class="hs-comment">-- Nothing else we can try...</span><span>
</span><a name="line-2284"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="TcExpr.html#badOverloadedUpdate"><span class="hs-identifier hs-var">badOverloadedUpdate</span></a><span>
</span><a name="line-2285"></a><span>
</span><a name="line-2286"></a><span>    </span><span class="hs-comment">-- Make a field unambiguous by choosing the given parent.</span><span>
</span><a name="line-2287"></a><span>    </span><span class="hs-comment">-- Emits an error if the field cannot have that parent,</span><span>
</span><a name="line-2288"></a><span>    </span><span class="hs-comment">-- e.g. if the user writes</span><span>
</span><a name="line-2289"></a><span>    </span><span class="hs-comment">--     r { x = e } :: T</span><span>
</span><a name="line-2290"></a><span>    </span><span class="hs-comment">-- where T does not have field x.</span><span>
</span><a name="line-2291"></a><span>    </span><span class="hs-identifier">pickParent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecSelParent</span><span>
</span><a name="line-2292"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecSelParent</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2293"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecField'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2294"></a><span>    </span><a name="local-6989586621683756647"><a href="#local-6989586621683756647"><span class="hs-identifier">pickParent</span></a></a><span> </span><a name="local-6989586621683756656"><a href="#local-6989586621683756656"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683756657"><a href="#local-6989586621683756657"><span class="hs-identifier">upd</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756658"><a href="#local-6989586621683756658"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2295"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621683756656"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683756658"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2296"></a><span>                      </span><span class="hs-comment">-- Phew! The parent is valid for this field.</span><span>
</span><a name="line-2297"></a><span>                      </span><span class="hs-comment">-- Previously ambiguous fields must be marked as</span><span>
</span><a name="line-2298"></a><span>                      </span><span class="hs-comment">-- used now that we know which one is meant, but</span><span>
</span><a name="line-2299"></a><span>                      </span><span class="hs-comment">-- unambiguous ones shouldn't be recorded again</span><span>
</span><a name="line-2300"></a><span>                      </span><span class="hs-comment">-- (giving duplicate deprecation warnings).</span><span>
</span><a name="line-2301"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756659"><a href="#local-6989586621683756659"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621683756658"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2302"></a><span>                             </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756660"><a href="#local-6989586621683756660"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756657"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">)</span><span>
</span><a name="line-2303"></a><span>                             </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683756660"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnEnv.html#addUsedGRE"><span class="hs-identifier hs-var">addUsedGRE</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621683756659"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-2304"></a><span>                         </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683756648"><span class="hs-identifier hs-var">lookupSelector</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756657"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683756659"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2305"></a><span>                      </span><span class="hs-comment">-- The field doesn't belong to this parent, so report</span><span>
</span><a name="line-2306"></a><span>                      </span><span class="hs-comment">-- an error but keep going through all the fields</span><span>
</span><a name="line-2307"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#fieldNotInType"><span class="hs-identifier hs-var">fieldNotInType</span></a><span> </span><a href="#local-6989586621683756656"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-2308"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsRecUpdFieldRdr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756657"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2309"></a><span>                         </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683756648"><span class="hs-identifier hs-var">lookupSelector</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756657"><span class="hs-identifier hs-var">upd</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621683756658"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2310"></a><span>
</span><a name="line-2311"></a><span>    </span><span class="hs-comment">-- Given a (field update, selector name) pair, look up the</span><span>
</span><a name="line-2312"></a><span>    </span><span class="hs-comment">-- selector to give a field update with an unambiguous Id</span><span>
</span><a name="line-2313"></a><span>    </span><span class="hs-identifier">lookupSelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-2314"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecField'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2315"></a><span>    </span><a name="local-6989586621683756648"><a href="#local-6989586621683756648"><span class="hs-identifier">lookupSelector</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756661"><a href="#local-6989586621683756661"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683756662"><a href="#local-6989586621683756662"><span class="hs-identifier">upd</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756663"><a href="#local-6989586621683756663"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2316"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756664"><a href="#local-6989586621683756664"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683756663"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-2317"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756665"><a href="#local-6989586621683756665"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683756666"><a href="#local-6989586621683756666"><span class="hs-identifier">af</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><a href="#local-6989586621683756662"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-2318"></a><span>                 </span><a name="local-6989586621683756667"><a href="#local-6989586621683756667"><span class="hs-identifier">lbl</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rdrNameAmbiguousFieldOcc</span><span> </span><a href="#local-6989586621683756666"><span class="hs-identifier hs-var">af</span></a><span>
</span><a name="line-2319"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756661"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683756662"><span class="hs-identifier hs-var">upd</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span>
</span><a name="line-2320"></a><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756665"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span> </span><a href="#local-6989586621683756664"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756665"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756667"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2321"></a><span>
</span><a name="line-2322"></a><span>
</span><a name="line-2323"></a><span class="hs-comment">-- Extract the outermost TyCon of a type, if there is one; for</span><span>
</span><a name="line-2324"></a><span class="hs-comment">-- data families this is the representation tycon (because that's</span><span>
</span><a name="line-2325"></a><span class="hs-comment">-- where the fields live).</span><span>
</span><a name="line-2326"></a><span class="hs-identifier">tyConOf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-2327"></a><a name="tyConOf"><a href="TcExpr.html#tyConOf"><span class="hs-identifier">tyConOf</span></a></a><span> </span><a name="local-6989586621683756673"><a href="#local-6989586621683756673"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-6989586621683756674"><a href="#local-6989586621683756674"><span class="hs-identifier">ty0</span></a></a><span>
</span><a name="line-2328"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683756675"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2329"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756676"><a href="#local-6989586621683756676"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756677"><a href="#local-6989586621683756677"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fstOf3</span><span> </span><span class="hs-special">(</span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><a href="#local-6989586621683756673"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621683756676"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683756677"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2330"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2331"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2332"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756675"><a href="#local-6989586621683756675"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621683756674"><span class="hs-identifier hs-var">ty0</span></a><span>
</span><a name="line-2333"></a><span>
</span><a name="line-2334"></a><span class="hs-comment">-- Variant of tyConOf that works for ExpTypes</span><span>
</span><a name="line-2335"></a><span class="hs-identifier">tyConOfET</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-2336"></a><a name="tyConOfET"><a href="TcExpr.html#tyConOfET"><span class="hs-identifier">tyConOfET</span></a></a><span> </span><a name="local-6989586621683756678"><a href="#local-6989586621683756678"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-6989586621683756679"><a href="#local-6989586621683756679"><span class="hs-identifier">ty0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#tyConOf"><span class="hs-identifier hs-var">tyConOf</span></a><span> </span><a href="#local-6989586621683756678"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="TcMType.html#checkingExpType_maybe"><span class="hs-identifier hs-var">checkingExpType_maybe</span></a><span> </span><a href="#local-6989586621683756679"><span class="hs-identifier hs-var">ty0</span></a><span>
</span><a name="line-2337"></a><span>
</span><a name="line-2338"></a><span class="hs-comment">-- For an ambiguous record field, find all the candidate record</span><span>
</span><a name="line-2339"></a><span class="hs-comment">-- selectors (as GlobalRdrElts) and their parents.</span><span>
</span><a name="line-2340"></a><span class="hs-identifier">lookupParents</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecSelParent</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2341"></a><a name="lookupParents"><a href="TcExpr.html#lookupParents"><span class="hs-identifier">lookupParents</span></a></a><span> </span><a name="local-6989586621683756680"><a href="#local-6989586621683756680"><span class="hs-identifier">rdr</span></a></a><span>
</span><a name="line-2342"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756684"><a href="#local-6989586621683756684"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-2343"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756685"><a href="#local-6989586621683756685"><span class="hs-identifier">gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupGRE_RdrName</span><span> </span><a href="#local-6989586621683756680"><span class="hs-identifier hs-var">rdr</span></a><span> </span><a href="#local-6989586621683756684"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2344"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683756681"><span class="hs-identifier hs-var">lookupParent</span></a><span> </span><a href="#local-6989586621683756685"><span class="hs-identifier hs-var">gres</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2345"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2346"></a><span>    </span><span class="hs-identifier">lookupParent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecSelParent</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">)</span><span>
</span><a name="line-2347"></a><span>    </span><a name="local-6989586621683756681"><a href="#local-6989586621683756681"><span class="hs-identifier">lookupParent</span></a></a><span> </span><a name="local-6989586621683756682"><a href="#local-6989586621683756682"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756683"><a href="#local-6989586621683756683"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683756682"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-2348"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isRecordSelector</span><span> </span><a href="#local-6989586621683756683"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-2349"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">recordSelectorTyCon</span><span> </span><a href="#local-6989586621683756683"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756682"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-2350"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#notSelector"><span class="hs-identifier hs-var">notSelector</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683756682"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2351"></a><span>
</span><a name="line-2352"></a><span class="hs-comment">-- A type signature on the argument of an ambiguous record selector or</span><span>
</span><a name="line-2353"></a><span class="hs-comment">-- the record expression in an update must be &quot;obvious&quot;, i.e. the</span><span>
</span><a name="line-2354"></a><span class="hs-comment">-- outermost constructor ignoring parentheses.</span><span>
</span><a name="line-2355"></a><span class="hs-identifier">obviousSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-2356"></a><a name="obviousSig"><a href="TcExpr.html#obviousSig"><span class="hs-identifier">obviousSig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756686"><a href="#local-6989586621683756686"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683756686"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2357"></a><span class="hs-identifier">obviousSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683756687"><a href="#local-6989586621683756687"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="TcExpr.html#obviousSig"><span class="hs-identifier hs-var">obviousSig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756687"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-2358"></a><span class="hs-identifier">obviousSig</span><span> </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2359"></a><span>
</span><a name="line-2360"></a><span>
</span><a name="line-2361"></a><span class="hs-comment">{-
Game plan for record bindings
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
1. Find the TyCon for the bindings, from the first field label.

2. Instantiate its tyvars and unify (T a1 .. an) with expected_ty.

For each binding field = value

3. Instantiate the field type (from the field label) using the type
   envt from step 2.

4  Type check the value using tcArg, passing the field type as
   the expected argument type.

This extends OK when the field types are universally quantified.
-}</span><span>
</span><a name="line-2378"></a><span>
</span><a name="line-2379"></a><span class="hs-identifier">tcRecordBinds</span><span>
</span><a name="line-2380"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span>
</span><a name="line-2381"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Expected type for each field</span><span>
</span><a name="line-2382"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsRecordBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-2383"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsRecordBinds</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-2384"></a><span>
</span><a name="line-2385"></a><a name="tcRecordBinds"><a href="TcExpr.html#tcRecordBinds"><span class="hs-identifier">tcRecordBinds</span></a></a><span> </span><a name="local-6989586621683756688"><a href="#local-6989586621683756688"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683756689"><a href="#local-6989586621683756689"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><a name="local-6989586621683756690"><a href="#local-6989586621683756690"><span class="hs-identifier">rbinds</span></a></a><span> </span><a name="local-6989586621683756691"><a href="#local-6989586621683756691"><span class="hs-identifier">dd</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2386"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756702"><a href="#local-6989586621683756702"><span class="hs-identifier">mb_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683756694"><span class="hs-identifier hs-var">do_bind</span></a><span> </span><a href="#local-6989586621683756690"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-2387"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621683756702"><span class="hs-identifier hs-var">mb_binds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756691"><span class="hs-identifier hs-var">dd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2388"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2389"></a><span>    </span><a name="local-6989586621683756692"><a href="#local-6989586621683756692"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621683756688"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-2390"></a><span>    </span><a name="local-6989586621683756693"><a href="#local-6989586621683756693"><span class="hs-identifier">flds_w_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;tcRecordBinds&quot;</span><span> </span><a href="#local-6989586621683756692"><span class="hs-identifier hs-var">fields</span></a><span> </span><a href="#local-6989586621683756689"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-2391"></a><span>
</span><a name="line-2392"></a><span>    </span><span class="hs-identifier">do_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsRecField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-2393"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecField</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2394"></a><span>    </span><a name="local-6989586621683756694"><a href="#local-6989586621683756694"><span class="hs-identifier">do_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756695"><a href="#local-6989586621683756695"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683756696"><a href="#local-6989586621683756696"><span class="hs-identifier">fld</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecField</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756697"><a href="#local-6989586621683756697"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-2395"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756698"><a href="#local-6989586621683756698"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2396"></a><span>
</span><a name="line-2397"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756699"><a href="#local-6989586621683756699"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcRecordField"><span class="hs-identifier hs-var">tcRecordField</span></a><span> </span><a href="#local-6989586621683756688"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756693"><span class="hs-identifier hs-var">flds_w_tys</span></a><span> </span><a href="#local-6989586621683756697"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683756698"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2398"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756699"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2399"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2400"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756700"><a href="#local-6989586621683756700"><span class="hs-identifier">f'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756701"><a href="#local-6989586621683756701"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756695"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756696"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756700"><span class="hs-identifier hs-var">f'</span></a><span>
</span><a name="line-2401"></a><span>                                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756701"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2402"></a><span>
</span><a name="line-2403"></a><span class="hs-identifier">tcRecordUpd</span><span>
</span><a name="line-2404"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span>
</span><a name="line-2405"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Expected type for each field</span><span>
</span><a name="line-2406"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecField'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2407"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">]</span><span>
</span><a name="line-2408"></a><span>
</span><a name="line-2409"></a><a name="tcRecordUpd"><a href="TcExpr.html#tcRecordUpd"><span class="hs-identifier">tcRecordUpd</span></a></a><span> </span><a name="local-6989586621683756703"><a href="#local-6989586621683756703"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683756704"><a href="#local-6989586621683756704"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-6989586621683756705"><a href="#local-6989586621683756705"><span class="hs-identifier">rbinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683756708"><span class="hs-identifier hs-var">do_bind</span></a><span> </span><a href="#local-6989586621683756705"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-2410"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2411"></a><span>    </span><a name="local-6989586621683756706"><a href="#local-6989586621683756706"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621683756703"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-2412"></a><span>    </span><a name="local-6989586621683756707"><a href="#local-6989586621683756707"><span class="hs-identifier">flds_w_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;tcRecordUpd&quot;</span><span> </span><a href="#local-6989586621683756706"><span class="hs-identifier hs-var">fields</span></a><span> </span><a href="#local-6989586621683756704"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-2413"></a><span>
</span><a name="line-2414"></a><span>    </span><span class="hs-identifier">do_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsRecField'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-2415"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2416"></a><span>    </span><a name="local-6989586621683756708"><a href="#local-6989586621683756708"><span class="hs-identifier">do_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756709"><a href="#local-6989586621683756709"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683756710"><a href="#local-6989586621683756710"><span class="hs-identifier">fld</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecField</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756711"><a href="#local-6989586621683756711"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683756712"><a href="#local-6989586621683756712"><span class="hs-identifier">af</span></a></a><span>
</span><a name="line-2417"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756713"><a href="#local-6989586621683756713"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2418"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756714"><a href="#local-6989586621683756714"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rdrNameAmbiguousFieldOcc</span><span> </span><a href="#local-6989586621683756712"><span class="hs-identifier hs-var">af</span></a><span>
</span><a name="line-2419"></a><span>                 </span><a name="local-6989586621683756715"><a href="#local-6989586621683756715"><span class="hs-identifier">sel_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">selectorAmbiguousFieldOcc</span><span> </span><a href="#local-6989586621683756712"><span class="hs-identifier hs-var">af</span></a><span>
</span><a name="line-2420"></a><span>                 </span><a name="local-6989586621683756716"><a href="#local-6989586621683756716"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756711"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683756715"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756711"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756714"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2421"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756717"><a href="#local-6989586621683756717"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcRecordField"><span class="hs-identifier hs-var">tcRecordField</span></a><span> </span><a href="#local-6989586621683756703"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756707"><span class="hs-identifier hs-var">flds_w_tys</span></a><span> </span><a href="#local-6989586621683756716"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683756713"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2422"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756717"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2423"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2424"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756718"><a href="#local-6989586621683756718"><span class="hs-identifier">f'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756719"><a href="#local-6989586621683756719"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2425"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span>
</span><a name="line-2426"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756709"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756710"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span>
</span><a name="line-2427"></a><span>                                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756711"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unambiguous</span><span>
</span><a name="line-2428"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-identifier">extFieldOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756718"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2429"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756711"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683756714"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2430"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756719"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2431"></a><span>
</span><a name="line-2432"></a><span class="hs-identifier">tcRecordField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Assoc</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-2433"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-2434"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2435"></a><a name="tcRecordField"><a href="TcExpr.html#tcRecordField"><span class="hs-identifier">tcRecordField</span></a></a><span> </span><a name="local-6989586621683756720"><a href="#local-6989586621683756720"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683756721"><a href="#local-6989586621683756721"><span class="hs-identifier">flds_w_tys</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683756722"><a href="#local-6989586621683756722"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><a name="local-6989586621683756723"><a href="#local-6989586621683756723"><span class="hs-identifier">sel_name</span></a></a><span> </span><a name="local-6989586621683756724"><a href="#local-6989586621683756724"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756725"><a href="#local-6989586621683756725"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-2436"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756727"><a href="#local-6989586621683756727"><span class="hs-identifier">field_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">assocMaybe</span><span> </span><a href="#local-6989586621683756721"><span class="hs-identifier hs-var">flds_w_tys</span></a><span> </span><a href="#local-6989586621683756723"><span class="hs-identifier hs-var">sel_name</span></a><span>
</span><a name="line-2437"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#fieldCtxt"><span class="hs-identifier hs-var">fieldCtxt</span></a><span> </span><a href="#local-6989586621683756726"><span class="hs-identifier hs-var">field_lbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2438"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756728"><a href="#local-6989586621683756728"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExprNC"><span class="hs-identifier hs-var">tcPolyExprNC</span></a><span> </span><a href="#local-6989586621683756725"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621683756727"><span class="hs-identifier hs-var">field_ty</span></a><span>
</span><a name="line-2439"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756729"><a href="#local-6989586621683756729"><span class="hs-identifier">field_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUserLocal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683756723"><span class="hs-identifier hs-var">sel_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2440"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameUnique</span><span> </span><a href="#local-6989586621683756723"><span class="hs-identifier hs-var">sel_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2441"></a><span>                                        </span><a href="#local-6989586621683756727"><span class="hs-identifier hs-var">field_ty</span></a><span> </span><a href="#local-6989586621683756722"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-2442"></a><span>                </span><span class="hs-comment">-- Yuk: the field_id has the *unique* of the selector Id</span><span>
</span><a name="line-2443"></a><span>                </span><span class="hs-comment">--          (so we can find it easily)</span><span>
</span><a name="line-2444"></a><span>                </span><span class="hs-comment">--      but is a LocalId with the appropriate type of the RHS</span><span>
</span><a name="line-2445"></a><span>                </span><span class="hs-comment">--          (so the desugarer knows the type of local binder to make)</span><span>
</span><a name="line-2446"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683756722"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><a href="#local-6989586621683756729"><span class="hs-identifier hs-var">field_id</span></a><span> </span><a href="#local-6989586621683756724"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756728"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2447"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2448"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#badFieldCon"><span class="hs-identifier hs-var">badFieldCon</span></a><span> </span><a href="#local-6989586621683756720"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756726"><span class="hs-identifier hs-var">field_lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-2449"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2450"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2451"></a><span>        </span><a name="local-6989586621683756726"><a href="#local-6989586621683756726"><span class="hs-identifier">field_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683756724"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-2452"></a><span class="hs-identifier">tcRecordField</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFieldOcc</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcRecordField&quot;</span><span>
</span><a name="line-2453"></a><span>
</span><a name="line-2454"></a><span>
</span><a name="line-2455"></a><span class="hs-identifier">checkMissingFields</span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsRecordBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2456"></a><a name="checkMissingFields"><a href="TcExpr.html#checkMissingFields"><span class="hs-identifier">checkMissingFields</span></a></a><span> </span><a name="local-6989586621683756730"><a href="#local-6989586621683756730"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683756731"><a href="#local-6989586621683756731"><span class="hs-identifier">rbinds</span></a></a><span>
</span><a name="line-2457"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756735"><span class="hs-identifier hs-var">field_labels</span></a><span>   </span><span class="hs-comment">-- Not declared as a record;</span><span>
</span><a name="line-2458"></a><span>                        </span><span class="hs-comment">-- But C{} is still valid if no strict fields</span><span>
</span><a name="line-2459"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isBanged</span><span> </span><a href="#local-6989586621683756737"><span class="hs-identifier hs-var">field_strs</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-2460"></a><span>        </span><span class="hs-comment">-- Illegal if any arg is strict</span><span>
</span><a name="line-2461"></a><span>        </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#missingStrictFields"><span class="hs-identifier hs-var">missingStrictFields</span></a><span> </span><a href="#local-6989586621683756730"><span class="hs-identifier hs-var">con_like</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2462"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2463"></a><span>        </span><a name="local-6989586621683756746"><a href="#local-6989586621683756746"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingFields</span><span>
</span><a name="line-2464"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756746"><span class="hs-identifier hs-var">warn</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621683756737"><span class="hs-identifier hs-var">field_strs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756735"><span class="hs-identifier hs-var">field_labels</span></a><span class="hs-special">)</span><span>
</span><a name="line-2465"></a><span>             </span><span class="hs-special">(</span><a href="TcRnMonad.html#warnTc"><span class="hs-identifier hs-var">warnTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingFields</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2466"></a><span>                 </span><span class="hs-special">(</span><a href="TcExpr.html#missingFields"><span class="hs-identifier hs-var">missingFields</span></a><span> </span><a href="#local-6989586621683756730"><span class="hs-identifier hs-var">con_like</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2467"></a><span>
</span><a name="line-2468"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>              </span><span class="hs-comment">-- A record</span><span>
</span><a name="line-2469"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756732"><span class="hs-identifier hs-var">missing_s_fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-2470"></a><span>           </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#missingStrictFields"><span class="hs-identifier hs-var">missingStrictFields</span></a><span> </span><a href="#local-6989586621683756730"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756732"><span class="hs-identifier hs-var">missing_s_fields</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2471"></a><span>
</span><a name="line-2472"></a><span>    </span><a name="local-6989586621683756747"><a href="#local-6989586621683756747"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingFields</span><span>
</span><a name="line-2473"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756747"><span class="hs-identifier hs-var">warn</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621683756733"><span class="hs-identifier hs-var">missing_ns_fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-2474"></a><span>         </span><span class="hs-special">(</span><a href="TcRnMonad.html#warnTc"><span class="hs-identifier hs-var">warnTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingFields</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2475"></a><span>             </span><span class="hs-special">(</span><a href="TcExpr.html#missingFields"><span class="hs-identifier hs-var">missingFields</span></a><span> </span><a href="#local-6989586621683756730"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683756733"><span class="hs-identifier hs-var">missing_ns_fields</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2476"></a><span>
</span><a name="line-2477"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2478"></a><span>    </span><a name="local-6989586621683756732"><a href="#local-6989586621683756732"><span class="hs-identifier">missing_s_fields</span></a></a><span>
</span><a name="line-2479"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621683756739"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756739"><a href="#local-6989586621683756739"><span class="hs-identifier">fl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756740"><a href="#local-6989586621683756740"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756736"><span class="hs-identifier hs-var">field_info</span></a><span class="hs-special">,</span><span>
</span><a name="line-2480"></a><span>                 </span><span class="hs-identifier hs-var">isBanged</span><span> </span><a href="#local-6989586621683756740"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">,</span><span>
</span><a name="line-2481"></a><span>                 </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756739"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621683756738"><span class="hs-identifier hs-var">elemField</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756734"><span class="hs-identifier hs-var">field_names_used</span></a><span class="hs-special">)</span><span>
</span><a name="line-2482"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-2483"></a><span>    </span><a name="local-6989586621683756733"><a href="#local-6989586621683756733"><span class="hs-identifier">missing_ns_fields</span></a></a><span>
</span><a name="line-2484"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621683756741"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756741"><a href="#local-6989586621683756741"><span class="hs-identifier">fl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756742"><a href="#local-6989586621683756742"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756736"><span class="hs-identifier hs-var">field_info</span></a><span class="hs-special">,</span><span>
</span><a name="line-2485"></a><span>                 </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBanged</span><span> </span><a href="#local-6989586621683756742"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-2486"></a><span>                 </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756741"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621683756738"><span class="hs-identifier hs-var">elemField</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621683756734"><span class="hs-identifier hs-var">field_names_used</span></a><span class="hs-special">)</span><span>
</span><a name="line-2487"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-2488"></a><span>
</span><a name="line-2489"></a><span>    </span><a name="local-6989586621683756734"><a href="#local-6989586621683756734"><span class="hs-identifier">field_names_used</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsRecFields</span><span> </span><a href="#local-6989586621683756731"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-2490"></a><span>    </span><a name="local-6989586621683756735"><a href="#local-6989586621683756735"><span class="hs-identifier">field_labels</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621683756730"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-2491"></a><span>
</span><a name="line-2492"></a><span>    </span><a name="local-6989586621683756736"><a href="#local-6989586621683756736"><span class="hs-identifier">field_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;missingFields&quot;</span><span>
</span><a name="line-2493"></a><span>                          </span><a href="#local-6989586621683756735"><span class="hs-identifier hs-var">field_labels</span></a><span>
</span><a name="line-2494"></a><span>                          </span><a href="#local-6989586621683756737"><span class="hs-identifier hs-var">field_strs</span></a><span>
</span><a name="line-2495"></a><span>
</span><a name="line-2496"></a><span>    </span><a name="local-6989586621683756737"><a href="#local-6989586621683756737"><span class="hs-identifier">field_strs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeImplBangs</span><span> </span><a href="#local-6989586621683756730"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-2497"></a><span>
</span><a name="line-2498"></a><span>    </span><a name="local-6989586621683756743"><a href="#local-6989586621683756743"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-special">`</span><a name="local-6989586621683756738"><a href="#local-6989586621683756738"><span class="hs-identifier">elemField</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621683756744"><a href="#local-6989586621683756744"><span class="hs-identifier">flds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756745"><a href="#local-6989586621683756745"><span class="hs-identifier">fl'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621683756743"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683756745"><span class="hs-identifier hs-var">fl'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756744"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-2499"></a><span>
</span><a name="line-2500"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Errors and contexts}
*                                                                      *
************************************************************************

Boring and alphabetical:
-}</span><span>
</span><a name="line-2509"></a><span>
</span><a name="line-2510"></a><span class="hs-identifier">addExprErrCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755707"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755707"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2511"></a><a name="addExprErrCtxt"><a href="TcExpr.html#addExprErrCtxt"><span class="hs-identifier">addExprErrCtxt</span></a></a><span> </span><a name="local-6989586621683756748"><a href="#local-6989586621683756748"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcExpr.html#exprCtxt"><span class="hs-identifier hs-var">exprCtxt</span></a><span> </span><a href="#local-6989586621683756748"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2512"></a><span>
</span><a name="line-2513"></a><span class="hs-identifier">exprCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2514"></a><a name="exprCtxt"><a href="TcExpr.html#exprCtxt"><span class="hs-identifier">exprCtxt</span></a></a><span> </span><a name="local-6989586621683756749"><a href="#local-6989586621683756749"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the expression:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756749"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2516"></a><span>
</span><a name="line-2517"></a><span class="hs-identifier">fieldCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FieldLabelString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2518"></a><a name="fieldCtxt"><a href="TcExpr.html#fieldCtxt"><span class="hs-identifier">fieldCtxt</span></a></a><span> </span><a name="local-6989586621683756750"><a href="#local-6989586621683756750"><span class="hs-identifier">field_name</span></a></a><span>
</span><a name="line-2519"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756750"><span class="hs-identifier hs-var">field_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;field of a record&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2520"></a><span>
</span><a name="line-2521"></a><span class="hs-identifier">addFunResCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- There is at least one argument</span><span>
</span><a name="line-2522"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-2523"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755706"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683755706"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2524"></a><span class="hs-comment">-- When we have a mis-match in the return type of a function</span><span>
</span><a name="line-2525"></a><span class="hs-comment">-- try to give a helpful message about too many/few arguments</span><span>
</span><a name="line-2526"></a><span class="hs-comment">--</span><span>
</span><a name="line-2527"></a><span class="hs-comment">-- Used for naked variables too; but with has_args = False</span><span>
</span><a name="line-2528"></a><a name="addFunResCtxt"><a href="TcExpr.html#addFunResCtxt"><span class="hs-identifier">addFunResCtxt</span></a></a><span> </span><a name="local-6989586621683756751"><a href="#local-6989586621683756751"><span class="hs-identifier">has_args</span></a></a><span> </span><a name="local-6989586621683756752"><a href="#local-6989586621683756752"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683756753"><a href="#local-6989586621683756753"><span class="hs-identifier">fun_res_ty</span></a></a><span> </span><a name="local-6989586621683756754"><a href="#local-6989586621683756754"><span class="hs-identifier">env_ty</span></a></a><span>
</span><a name="line-2529"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLandmarkErrCtxtM"><span class="hs-identifier hs-var">addLandmarkErrCtxtM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683756773"><a href="#local-6989586621683756773"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756773"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683756755"><span class="hs-identifier hs-var">mk_msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-2530"></a><span>      </span><span class="hs-comment">-- NB: use a landmark error context, so that an empty context</span><span>
</span><a name="line-2531"></a><span>      </span><span class="hs-comment">-- doesn't suppress some more useful context</span><span>
</span><a name="line-2532"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2533"></a><span>    </span><a name="local-6989586621683756755"><a href="#local-6989586621683756755"><span class="hs-identifier">mk_msg</span></a></a><span>
</span><a name="line-2534"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756759"><a href="#local-6989586621683756759"><span class="hs-identifier">mb_env_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType_maybe"><span class="hs-identifier hs-var">readExpType_maybe</span></a><span> </span><a href="#local-6989586621683756754"><span class="hs-identifier hs-var">env_ty</span></a><span>
</span><a name="line-2535"></a><span>                     </span><span class="hs-comment">-- by the time the message is rendered, the ExpType</span><span>
</span><a name="line-2536"></a><span>                     </span><span class="hs-comment">-- will be filled in (except if we're debugging)</span><span>
</span><a name="line-2537"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756760"><a href="#local-6989586621683756760"><span class="hs-identifier">fun_res'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683756753"><span class="hs-identifier hs-var">fun_res_ty</span></a><span>
</span><a name="line-2538"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683756763"><a href="#local-6989586621683756763"><span class="hs-identifier">env'</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756759"><span class="hs-identifier hs-var">mb_env_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2539"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756761"><a href="#local-6989586621683756761"><span class="hs-identifier">env_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683756761"><span class="hs-identifier hs-var">env_ty</span></a><span>
</span><a name="line-2540"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2541"></a><span>                             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683756762"><a href="#local-6989586621683756762"><span class="hs-identifier">dumping</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#doptM"><span class="hs-identifier hs-var">doptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc_trace</span><span>
</span><a name="line-2542"></a><span>                                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">dumping</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2543"></a><span>                                </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2544"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- See Note [Splitting nested sigma types in mismatched</span><span>
</span><a name="line-2545"></a><span>                 </span><span class="hs-comment">--           function types]</span><span>
</span><a name="line-2546"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756764"><a href="#local-6989586621683756764"><span class="hs-identifier">fun_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitNestedSigmaTys</span><span> </span><a href="#local-6989586621683756760"><span class="hs-identifier hs-var">fun_res'</span></a><span>
</span><a name="line-2547"></a><span>                 </span><span class="hs-comment">-- No need to call tcSplitNestedSigmaTys here, since env_ty is</span><span>
</span><a name="line-2548"></a><span>                 </span><span class="hs-comment">-- an ExpRhoTy, i.e., it's already deeply instantiated.</span><span>
</span><a name="line-2549"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756765"><a href="#local-6989586621683756765"><span class="hs-identifier">env_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621683756763"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-2550"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621683756766"><a href="#local-6989586621683756766"><span class="hs-identifier">args_fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756767"><a href="#local-6989586621683756767"><span class="hs-identifier">res_fun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTys</span><span> </span><a href="#local-6989586621683756764"><span class="hs-identifier hs-var">fun_tau</span></a><span>
</span><a name="line-2551"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621683756768"><a href="#local-6989586621683756768"><span class="hs-identifier">args_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756769"><a href="#local-6989586621683756769"><span class="hs-identifier">res_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTys</span><span> </span><a href="#local-6989586621683756765"><span class="hs-identifier hs-var">env_tau</span></a><span>
</span><a name="line-2552"></a><span>                 </span><a name="local-6989586621683756770"><a href="#local-6989586621683756770"><span class="hs-identifier">n_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683756766"><span class="hs-identifier hs-var">args_fun</span></a><span>
</span><a name="line-2553"></a><span>                 </span><a name="local-6989586621683756771"><a href="#local-6989586621683756771"><span class="hs-identifier">n_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683756768"><span class="hs-identifier hs-var">args_env</span></a><span>
</span><a name="line-2554"></a><span>                 </span><a name="local-6989586621683756772"><a href="#local-6989586621683756772"><span class="hs-identifier">info</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756770"><span class="hs-identifier hs-var">n_fun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683756771"><span class="hs-identifier hs-var">n_env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-2555"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756770"><span class="hs-identifier hs-var">n_fun</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621683756771"><span class="hs-identifier hs-var">n_env</span></a><span>
</span><a name="line-2556"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756756"><span class="hs-identifier hs-var">not_fun</span></a><span> </span><a href="#local-6989586621683756769"><span class="hs-identifier hs-var">res_env</span></a><span>
</span><a name="line-2557"></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable cause:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756752"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-2558"></a><span>                         </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is applied to too few arguments&quot;</span><span>
</span><a name="line-2559"></a><span>
</span><a name="line-2560"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683756751"><span class="hs-identifier hs-var">has_args</span></a><span>
</span><a name="line-2561"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756756"><span class="hs-identifier hs-var">not_fun</span></a><span> </span><a href="#local-6989586621683756767"><span class="hs-identifier hs-var">res_fun</span></a><span>
</span><a name="line-2562"></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Possible cause:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756752"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-2563"></a><span>                         </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is applied to too many arguments&quot;</span><span>
</span><a name="line-2564"></a><span>
</span><a name="line-2565"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2566"></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>  </span><span class="hs-comment">-- Never suggest that a naked variable is                                         -- applied to too many args!</span><span>
</span><a name="line-2567"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683756772"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2568"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2569"></a><span>        </span><a name="local-6989586621683756756"><a href="#local-6989586621683756756"><span class="hs-identifier">not_fun</span></a></a><span> </span><a name="local-6989586621683756757"><a href="#local-6989586621683756757"><span class="hs-identifier">ty</span></a></a><span>   </span><span class="hs-comment">-- ty is definitely not an arrow type,</span><span>
</span><a name="line-2570"></a><span>                     </span><span class="hs-comment">-- and cannot conceivably become one</span><span>
</span><a name="line-2571"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683756757"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2572"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756758"><a href="#local-6989586621683756758"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683756758"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2573"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2574"></a><span>
</span><a name="line-2575"></a><span class="hs-comment">{-
Note [Splitting nested sigma types in mismatched function types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When one applies a function to too few arguments, GHC tries to determine this
fact if possible so that it may give a helpful error message. It accomplishes
this by checking if the type of the applied function has more argument types
than supplied arguments.

Previously, GHC computed the number of argument types through tcSplitSigmaTy.
This is incorrect in the face of nested foralls, however! This caused Trac
#13311, for instance:

  f :: forall a. (Monoid a) =&gt; forall b. (Monoid b) =&gt; Maybe a -&gt; Maybe b

If one uses `f` like so:

  do { f; putChar 'a' }

Then tcSplitSigmaTy will decompose the type of `f` into:

  Tyvars: [a]
  Context: (Monoid a)
  Argument types: []
  Return type: forall b. Monoid b =&gt; Maybe a -&gt; Maybe b

That is, it will conclude that there are *no* argument types, and since `f`
was given no arguments, it won't print a helpful error message. On the other
hand, tcSplitNestedSigmaTys correctly decomposes `f`'s type down to:

  Tyvars: [a, b]
  Context: (Monoid a, Monoid b)
  Argument types: [Maybe a]
  Return type: Maybe b

So now GHC recognizes that `f` has one more argument type than it was actually
provided.
-}</span><span>
</span><a name="line-2612"></a><span>
</span><a name="line-2613"></a><span class="hs-identifier">badFieldTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2614"></a><a name="badFieldTypes"><a href="TcExpr.html#badFieldTypes"><span class="hs-identifier">badFieldTypes</span></a></a><span> </span><a name="local-6989586621683756774"><a href="#local-6989586621683756774"><span class="hs-identifier">prs</span></a></a><span>
</span><a name="line-2615"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Record update for insufficiently polymorphic field&quot;</span><span>
</span><a name="line-2616"></a><span>                         </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">plural</span><span> </span><a href="#local-6989586621683756774"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-2617"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756775"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756776"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756775"><a href="#local-6989586621683756775"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-6989586621683756776"><a href="#local-6989586621683756776"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683756774"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2618"></a><span>
</span><a name="line-2619"></a><span class="hs-identifier">badFieldsUpd</span><span>
</span><a name="line-2620"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecField'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AmbiguousFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2621"></a><span>               </span><span class="hs-comment">-- Field names that don't belong to a single datacon</span><span>
</span><a name="line-2622"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Data cons of the type which the first field name belongs to</span><span>
</span><a name="line-2623"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2624"></a><a name="badFieldsUpd"><a href="TcExpr.html#badFieldsUpd"><span class="hs-identifier">badFieldsUpd</span></a></a><span> </span><a name="local-6989586621683756777"><a href="#local-6989586621683756777"><span class="hs-identifier">rbinds</span></a></a><span> </span><a name="local-6989586621683756778"><a href="#local-6989586621683756778"><span class="hs-identifier">data_cons</span></a></a><span>
</span><a name="line-2625"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No constructor has all these fields:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2626"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprQuotedList</span><span> </span><a href="#local-6989586621683756779"><span class="hs-identifier hs-var">conflictingFields</span></a><span class="hs-special">)</span><span>
</span><a name="line-2627"></a><span>          </span><span class="hs-comment">-- See Note [Finding the conflicting fields]</span><span>
</span><a name="line-2628"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2629"></a><span>    </span><span class="hs-comment">-- A (preferably small) set of fields such that no constructor contains</span><span>
</span><a name="line-2630"></a><span>    </span><span class="hs-comment">-- all of them.  See Note [Finding the conflicting fields]</span><span>
</span><a name="line-2631"></a><span>    </span><a name="local-6989586621683756779"><a href="#local-6989586621683756779"><span class="hs-identifier">conflictingFields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756782"><span class="hs-identifier hs-var">nonMembers</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2632"></a><span>        </span><span class="hs-comment">-- nonMember belongs to a different type.</span><span>
</span><a name="line-2633"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683756787"><a href="#local-6989586621683756787"><span class="hs-identifier">nonMember</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756780"><span class="hs-identifier hs-var">aMember</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756787"><span class="hs-identifier hs-var">nonMember</span></a><span class="hs-special">]</span><span>
</span><a name="line-2634"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-2635"></a><span>            </span><span class="hs-comment">-- All of rbinds belong to one type. In this case, repeatedly add</span><span>
</span><a name="line-2636"></a><span>            </span><span class="hs-comment">-- a field to the set until no constructor contains the set.</span><span>
</span><a name="line-2637"></a><span>
</span><a name="line-2638"></a><span>            </span><span class="hs-comment">-- Each field, together with a list indicating which constructors</span><span>
</span><a name="line-2639"></a><span>            </span><span class="hs-comment">-- have all the fields so far.</span><span>
</span><a name="line-2640"></a><span>            </span><span class="hs-identifier">growingSets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2641"></a><span>            </span><a name="local-6989586621683756788"><a href="#local-6989586621683756788"><span class="hs-identifier">growingSets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scanl1</span><span> </span><a href="#local-6989586621683756789"><span class="hs-identifier hs-var">combine</span></a><span> </span><a href="#local-6989586621683756783"><span class="hs-identifier hs-var">membership</span></a><span>
</span><a name="line-2642"></a><span>            </span><a name="local-6989586621683756789"><a href="#local-6989586621683756789"><span class="hs-identifier">combine</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756790"><a href="#local-6989586621683756790"><span class="hs-identifier">setMem</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756791"><a href="#local-6989586621683756791"><span class="hs-identifier">field</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756792"><a href="#local-6989586621683756792"><span class="hs-identifier">fldMem</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2643"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756791"><span class="hs-identifier hs-var">field</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;&amp;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756790"><span class="hs-identifier hs-var">setMem</span></a><span> </span><a href="#local-6989586621683756792"><span class="hs-identifier hs-var">fldMem</span></a><span class="hs-special">)</span><span>
</span><a name="line-2644"></a><span>            </span><span class="hs-keyword">in</span><span>
</span><a name="line-2645"></a><span>            </span><span class="hs-comment">-- Fields that don't change the membership status of the set</span><span>
</span><a name="line-2646"></a><span>            </span><span class="hs-comment">-- are redundant and can be dropped.</span><span>
</span><a name="line-2647"></a><span>            </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756788"><span class="hs-identifier hs-var">growingSets</span></a><span>
</span><a name="line-2648"></a><span>
</span><a name="line-2649"></a><span>    </span><a name="local-6989586621683756780"><a href="#local-6989586621683756780"><span class="hs-identifier">aMember</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">members</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">fst</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756781"><span class="hs-identifier hs-var">head</span></a><span> </span><span class="hs-identifier">members</span><span class="hs-special">)</span><span>
</span><a name="line-2650"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683756781"><a href="#local-6989586621683756781"><span class="hs-identifier">members</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756782"><a href="#local-6989586621683756782"><span class="hs-identifier">nonMembers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">or</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756783"><span class="hs-identifier hs-var">membership</span></a><span>
</span><a name="line-2651"></a><span>
</span><a name="line-2652"></a><span>    </span><span class="hs-comment">-- For each field, which constructors contain the field?</span><span>
</span><a name="line-2653"></a><span>    </span><span class="hs-identifier">membership</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2654"></a><span>    </span><a name="local-6989586621683756783"><a href="#local-6989586621683756783"><span class="hs-identifier">membership</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756785"><span class="hs-identifier hs-var">sortMembership</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2655"></a><span>        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683756793"><a href="#local-6989586621683756793"><span class="hs-identifier">fld</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756793"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.member</span><span> </span><a href="#local-6989586621683756793"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756784"><span class="hs-identifier hs-var">fieldLabelSets</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2656"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">rdrNameAmbiguousFieldOcc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756777"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-2657"></a><span>
</span><a name="line-2658"></a><span>    </span><span class="hs-identifier">fieldLabelSets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">]</span><span>
</span><a name="line-2659"></a><span>    </span><a name="local-6989586621683756784"><a href="#local-6989586621683756784"><span class="hs-identifier">fieldLabelSets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756778"><span class="hs-identifier hs-var">data_cons</span></a><span>
</span><a name="line-2660"></a><span>
</span><a name="line-2661"></a><span>    </span><span class="hs-comment">-- Sort in order of increasing number of True, so that a smaller</span><span>
</span><a name="line-2662"></a><span>    </span><span class="hs-comment">-- conflicting set can be found.</span><span>
</span><a name="line-2663"></a><span>    </span><a name="local-6989586621683756785"><a href="#local-6989586621683756785"><span class="hs-identifier">sortMembership</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2664"></a><span>      </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-2665"></a><span>      </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-2666"></a><span>      </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683756794"><a href="#local-6989586621683756794"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683756795"><a href="#local-6989586621683756795"><span class="hs-identifier">membershipRow</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756786"><span class="hs-identifier hs-var">countTrue</span></a><span> </span><a href="#local-6989586621683756795"><span class="hs-identifier hs-var">membershipRow</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683756794"><span class="hs-identifier hs-var">item</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2667"></a><span>
</span><a name="line-2668"></a><span>    </span><a name="local-6989586621683756786"><a href="#local-6989586621683756786"><span class="hs-identifier">countTrue</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-2669"></a><span>
</span><a name="line-2670"></a><span class="hs-comment">{-
Note [Finding the conflicting fields]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
  data A = A {a0, a1 :: Int}
         | B {b0, b1 :: Int}
and we see a record update
  x { a0 = 3, a1 = 2, b0 = 4, b1 = 5 }
Then we'd like to find the smallest subset of fields that no
constructor has all of.  Here, say, {a0,b0}, or {a0,b1}, etc.
We don't really want to report that no constructor has all of
{a0,a1,b0,b1}, because when there are hundreds of fields it's
hard to see what was really wrong.

We may need more than two fields, though; eg
  data T = A { x,y :: Int, v::Int }
          | B { y,z :: Int, v::Int }
          | C { z,x :: Int, v::Int }
with update
   r { x=e1, y=e2, z=e3 }, we

Finding the smallest subset is hard, so the code here makes
a decent stab, no more.  See Trac #7989.
-}</span><span>
</span><a name="line-2694"></a><span>
</span><a name="line-2695"></a><span class="hs-identifier">naughtyRecordSel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2696"></a><a name="naughtyRecordSel"><a href="TcExpr.html#naughtyRecordSel"><span class="hs-identifier">naughtyRecordSel</span></a></a><span> </span><a name="local-6989586621683756796"><a href="#local-6989586621683756796"><span class="hs-identifier">sel_id</span></a></a><span>
</span><a name="line-2697"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot use record selector&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756796"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2698"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;as a function due to escaped type variables&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-2699"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable fix: use pattern-matching syntax instead&quot;</span><span>
</span><a name="line-2700"></a><span>
</span><a name="line-2701"></a><span class="hs-identifier">notSelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2702"></a><a name="notSelector"><a href="TcExpr.html#notSelector"><span class="hs-identifier">notSelector</span></a></a><span> </span><a name="local-6989586621683756797"><a href="#local-6989586621683756797"><span class="hs-identifier">field</span></a></a><span>
</span><a name="line-2703"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756797"><span class="hs-identifier hs-var">field</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not a record selector&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-2704"></a><span>
</span><a name="line-2705"></a><span class="hs-identifier">mixedSelectors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2706"></a><a name="mixedSelectors"><a href="TcExpr.html#mixedSelectors"><span class="hs-identifier">mixedSelectors</span></a></a><span> </span><a name="local-6989586621683756798"><a href="#local-6989586621683756798"><span class="hs-identifier">data_sels</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683756799"><a href="#local-6989586621683756799"><span class="hs-identifier">dc_rep_id</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683756800"><a href="#local-6989586621683756800"><span class="hs-identifier">pat_syn_sels</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683756801"><a href="#local-6989586621683756801"><span class="hs-identifier">ps_rep_id</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-2707"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ptext</span><span>
</span><a name="line-2708"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;Cannot use a mixture of pattern synonym and record selectors&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-2709"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Record selectors defined by&quot;</span><span>
</span><a name="line-2710"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683756803"><span class="hs-identifier hs-var">rep_dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2711"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;:&quot;</span><span>
</span><a name="line-2712"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756798"><span class="hs-identifier hs-var">data_sels</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-2713"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Pattern synonym selectors defined by&quot;</span><span>
</span><a name="line-2714"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">patSynName</span><span> </span><a href="#local-6989586621683756802"><span class="hs-identifier hs-var">rep_ps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2715"></a><span>      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;:&quot;</span><span>
</span><a name="line-2716"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756800"><span class="hs-identifier hs-var">pat_syn_sels</span></a><span>
</span><a name="line-2717"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2718"></a><span>    </span><span class="hs-identifier hs-var">RecSelPatSyn</span><span> </span><a name="local-6989586621683756802"><a href="#local-6989586621683756802"><span class="hs-identifier">rep_ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">recordSelectorTyCon</span><span> </span><a href="#local-6989586621683756801"><span class="hs-identifier hs-var">ps_rep_id</span></a><span>
</span><a name="line-2719"></a><span>    </span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a name="local-6989586621683756803"><a href="#local-6989586621683756803"><span class="hs-identifier">rep_dc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">recordSelectorTyCon</span><span> </span><a href="#local-6989586621683756799"><span class="hs-identifier hs-var">dc_rep_id</span></a><span>
</span><a name="line-2720"></a><span class="hs-identifier">mixedSelectors</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;TcExpr: mixedSelectors emptylists&quot;</span><span>
</span><a name="line-2721"></a><span>
</span><a name="line-2722"></a><span>
</span><a name="line-2723"></a><span class="hs-identifier">missingStrictFields</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2724"></a><a name="missingStrictFields"><a href="TcExpr.html#missingStrictFields"><span class="hs-identifier">missingStrictFields</span></a></a><span> </span><a name="local-6989586621683756804"><a href="#local-6989586621683756804"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683756805"><a href="#local-6989586621683756805"><span class="hs-identifier">fields</span></a></a><span>
</span><a name="line-2725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756807"><span class="hs-identifier hs-var">header</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621683756806"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-2726"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2727"></a><span>    </span><a name="local-6989586621683756806"><a href="#local-6989586621683756806"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756805"><span class="hs-identifier hs-var">fields</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>  </span><span class="hs-comment">-- Happens for non-record constructors</span><span>
</span><a name="line-2728"></a><span>                                           </span><span class="hs-comment">-- with strict fields</span><span>
</span><a name="line-2729"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756805"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-2730"></a><span>
</span><a name="line-2731"></a><span>    </span><a name="local-6989586621683756807"><a href="#local-6989586621683756807"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constructor&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756804"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2732"></a><span>             </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;does not have the required strict field(s)&quot;</span><span>
</span><a name="line-2733"></a><span>
</span><a name="line-2734"></a><span class="hs-identifier">missingFields</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabelString</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2735"></a><a name="missingFields"><a href="TcExpr.html#missingFields"><span class="hs-identifier">missingFields</span></a></a><span> </span><a name="local-6989586621683756808"><a href="#local-6989586621683756808"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683756809"><a href="#local-6989586621683756809"><span class="hs-identifier">fields</span></a></a><span>
</span><a name="line-2736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756811"><span class="hs-identifier hs-var">header</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621683756810"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-2737"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2738"></a><span>    </span><a name="local-6989586621683756810"><a href="#local-6989586621683756810"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683756809"><span class="hs-identifier hs-var">fields</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-2739"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756809"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-2740"></a><span>    </span><a name="local-6989586621683756811"><a href="#local-6989586621683756811"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Fields of&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756808"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2741"></a><span>             </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;not initialised&quot;</span><span>
</span><a name="line-2742"></a><span>
</span><a name="line-2743"></a><span class="hs-comment">-- callCtxt fun args = text &quot;In the call&quot; &lt;+&gt; parens (ppr (foldl' mkHsApp fun args))</span><span>
</span><a name="line-2744"></a><span>
</span><a name="line-2745"></a><span class="hs-identifier">noPossibleParents</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2746"></a><a name="noPossibleParents"><a href="TcExpr.html#noPossibleParents"><span class="hs-identifier">noPossibleParents</span></a></a><span> </span><a name="local-6989586621683756812"><a href="#local-6989586621683756812"><span class="hs-identifier">rbinds</span></a></a><span>
</span><a name="line-2747"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No type has all these fields:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2748"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprQuotedList</span><span> </span><a href="#local-6989586621683756813"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-2749"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2750"></a><span>    </span><a name="local-6989586621683756813"><a href="#local-6989586621683756813"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsRecFieldLbl</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756812"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-2751"></a><span>
</span><a name="line-2752"></a><span class="hs-identifier">badOverloadedUpdate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2753"></a><a name="badOverloadedUpdate"><a href="TcExpr.html#badOverloadedUpdate"><span class="hs-identifier">badOverloadedUpdate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Record update is ambiguous, and requires a type signature&quot;</span><span>
</span><a name="line-2754"></a><span>
</span><a name="line-2755"></a><span class="hs-identifier">fieldNotInType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecSelParent</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2756"></a><a name="fieldNotInType"><a href="TcExpr.html#fieldNotInType"><span class="hs-identifier">fieldNotInType</span></a></a><span> </span><a name="local-6989586621683756814"><a href="#local-6989586621683756814"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621683756815"><a href="#local-6989586621683756815"><span class="hs-identifier">rdr</span></a></a><span>
</span><a name="line-2757"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#unknownSubordinateErr"><span class="hs-identifier hs-var">unknownSubordinateErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;field of type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756814"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756815"><span class="hs-identifier hs-var">rdr</span></a><span>
</span><a name="line-2758"></a><span>
</span><a name="line-2759"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Static Pointers}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2766"></a><span>
</span><a name="line-2767"></a><span class="hs-comment">-- | A data type to describe why a variable is not closed.</span><span>
</span><a name="line-2768"></a><span class="hs-keyword">data</span><span> </span><a name="NotClosedReason"><a href="TcExpr.html#NotClosedReason"><span class="hs-identifier">NotClosedReason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NotLetBoundReason"><a href="TcExpr.html#NotLetBoundReason"><span class="hs-identifier">NotLetBoundReason</span></a></a><span>
</span><a name="line-2769"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a name="NotTypeClosed"><a href="TcExpr.html#NotTypeClosed"><span class="hs-identifier">NotTypeClosed</span></a></a><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-2770"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a name="NotClosed"><a href="TcExpr.html#NotClosed"><span class="hs-identifier">NotClosed</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><a href="TcExpr.html#NotClosedReason"><span class="hs-identifier hs-type">NotClosedReason</span></a><span>
</span><a name="line-2771"></a><span>
</span><a name="line-2772"></a><span class="hs-comment">-- | Checks if the given name is closed and emits an error if not.</span><span>
</span><a name="line-2773"></a><span class="hs-comment">--</span><span>
</span><a name="line-2774"></a><span class="hs-comment">-- See Note [Not-closed error messages].</span><span>
</span><a name="line-2775"></a><span class="hs-identifier">checkClosedInStaticForm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2776"></a><a name="checkClosedInStaticForm"><a href="TcExpr.html#checkClosedInStaticForm"><span class="hs-identifier">checkClosedInStaticForm</span></a></a><span> </span><a name="local-6989586621683756816"><a href="#local-6989586621683756816"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2777"></a><span>    </span><a name="local-6989586621683756840"><a href="#local-6989586621683756840"><span class="hs-identifier">type_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier hs-var">getLclTypeEnv</span></a><span>
</span><a name="line-2778"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756817"><span class="hs-identifier hs-var">checkClosed</span></a><span> </span><a href="#local-6989586621683756840"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621683756816"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2779"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2780"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756841"><a href="#local-6989586621683756841"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683756819"><span class="hs-identifier hs-var">explain</span></a><span> </span><a href="#local-6989586621683756816"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683756841"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-2781"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2782"></a><span>    </span><span class="hs-comment">-- See Note [Checking closedness].</span><span>
</span><a name="line-2783"></a><span>    </span><span class="hs-identifier">checkClosed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TcExpr.html#NotClosedReason"><span class="hs-identifier hs-type">NotClosedReason</span></a><span>
</span><a name="line-2784"></a><span>    </span><a name="local-6989586621683756817"><a href="#local-6989586621683756817"><span class="hs-identifier">checkClosed</span></a></a><span> </span><a name="local-6989586621683756821"><a href="#local-6989586621683756821"><span class="hs-identifier">type_env</span></a></a><span> </span><a name="local-6989586621683756822"><a href="#local-6989586621683756822"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683756818"><span class="hs-identifier hs-var">checkLoop</span></a><span> </span><a href="#local-6989586621683756821"><span class="hs-identifier hs-var">type_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitNameSet</span><span> </span><a href="#local-6989586621683756822"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756822"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-2785"></a><span>
</span><a name="line-2786"></a><span>    </span><span class="hs-identifier">checkLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TcExpr.html#NotClosedReason"><span class="hs-identifier hs-type">NotClosedReason</span></a><span>
</span><a name="line-2787"></a><span>    </span><a name="local-6989586621683756818"><a href="#local-6989586621683756818"><span class="hs-identifier">checkLoop</span></a></a><span> </span><a name="local-6989586621683756823"><a href="#local-6989586621683756823"><span class="hs-identifier">type_env</span></a></a><span> </span><a name="local-6989586621683756824"><a href="#local-6989586621683756824"><span class="hs-identifier">visited</span></a></a><span> </span><a name="local-6989586621683756825"><a href="#local-6989586621683756825"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2788"></a><span>      </span><span class="hs-comment">-- The @visited@ set is an accumulating parameter that contains the set of</span><span>
</span><a name="line-2789"></a><span>      </span><span class="hs-comment">-- visited nodes, so we avoid repeating cycles in the traversal.</span><span>
</span><a name="line-2790"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683756823"><span class="hs-identifier hs-var">type_env</span></a><span> </span><a href="#local-6989586621683756825"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2791"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756826"><a href="#local-6989586621683756826"><span class="hs-identifier">tcid</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683756827"><a href="#local-6989586621683756827"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756827"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2792"></a><span>          </span><span class="hs-identifier hs-var">ClosedLet</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2793"></a><span>          </span><span class="hs-identifier hs-var">NotLetBound</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="TcExpr.html#NotLetBoundReason"><span class="hs-identifier hs-var">NotLetBoundReason</span></a><span>
</span><a name="line-2794"></a><span>          </span><span class="hs-identifier hs-var">NonClosedLet</span><span> </span><a name="local-6989586621683756828"><a href="#local-6989586621683756828"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621683756829"><a href="#local-6989586621683756829"><span class="hs-identifier">type_closed</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2795"></a><span>            </span><span class="hs-comment">-- Look for a non-closed variable in fvs</span><span>
</span><a name="line-2796"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="TcExpr.html#NotClosed"><span class="hs-identifier hs-var">NotClosed</span></a><span> </span><a href="#local-6989586621683756830"><span class="hs-identifier hs-var">n'</span></a><span> </span><a href="#local-6989586621683756831"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-2797"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683756830"><a href="#local-6989586621683756830"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nameSetElemsStable</span><span> </span><a href="#local-6989586621683756828"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-2798"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">elemNameSet</span><span> </span><a href="#local-6989586621683756830"><span class="hs-identifier hs-var">n'</span></a><span> </span><a href="#local-6989586621683756824"><span class="hs-identifier hs-var">visited</span></a><span class="hs-special">)</span><span>
</span><a name="line-2799"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683756831"><a href="#local-6989586621683756831"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683756818"><span class="hs-identifier hs-var">checkLoop</span></a><span> </span><a href="#local-6989586621683756823"><span class="hs-identifier hs-var">type_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendNameSet</span><span> </span><a href="#local-6989586621683756824"><span class="hs-identifier hs-var">visited</span></a><span> </span><a href="#local-6989586621683756830"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756830"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">]</span><span>
</span><a name="line-2800"></a><span>            </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2801"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683756829"><span class="hs-identifier hs-var">type_closed</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-2802"></a><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2803"></a><span>            </span><span class="hs-keyword">else</span><span>
</span><a name="line-2804"></a><span>              </span><span class="hs-comment">-- We consider non-let-bound variables easier to figure out than</span><span>
</span><a name="line-2805"></a><span>              </span><span class="hs-comment">-- non-closed types, so we report non-closed types to the user</span><span>
</span><a name="line-2806"></a><span>              </span><span class="hs-comment">-- only if we cannot spot the former.</span><span>
</span><a name="line-2807"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="TcExpr.html#NotTypeClosed"><span class="hs-identifier hs-var">NotTypeClosed</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683756826"><span class="hs-identifier hs-var">tcid</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2808"></a><span>        </span><span class="hs-comment">-- The binding is closed.</span><span>
</span><a name="line-2809"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2810"></a><span>
</span><a name="line-2811"></a><span>    </span><span class="hs-comment">-- Converts a reason into a human-readable sentence.</span><span>
</span><a name="line-2812"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2813"></a><span>    </span><span class="hs-comment">-- @explain name reason@ starts with</span><span>
</span><a name="line-2814"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2815"></a><span>    </span><span class="hs-comment">-- &quot;&lt;name&gt; is used in a static form but it is not closed because it&quot;</span><span>
</span><a name="line-2816"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2817"></a><span>    </span><span class="hs-comment">-- and then follows a list of causes. For each id in the path, the text</span><span>
</span><a name="line-2818"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2819"></a><span>    </span><span class="hs-comment">-- &quot;uses &lt;id&gt; which&quot;</span><span>
</span><a name="line-2820"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2821"></a><span>    </span><span class="hs-comment">-- is appended, yielding something like</span><span>
</span><a name="line-2822"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2823"></a><span>    </span><span class="hs-comment">-- &quot;uses &lt;id&gt; which uses &lt;id1&gt; which uses &lt;id2&gt; which&quot;</span><span>
</span><a name="line-2824"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2825"></a><span>    </span><span class="hs-comment">-- until the end of the path is reached, which is reported as either</span><span>
</span><a name="line-2826"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2827"></a><span>    </span><span class="hs-comment">-- &quot;is not let-bound&quot;</span><span>
</span><a name="line-2828"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2829"></a><span>    </span><span class="hs-comment">-- when the final node is not let-bound, or</span><span>
</span><a name="line-2830"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2831"></a><span>    </span><span class="hs-comment">-- &quot;has a non-closed type because it contains the type variables:</span><span>
</span><a name="line-2832"></a><span>    </span><span class="hs-comment">-- v1, v2, v3&quot;</span><span>
</span><a name="line-2833"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2834"></a><span>    </span><span class="hs-comment">-- when the final node has a non-closed type.</span><span>
</span><a name="line-2835"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2836"></a><span>    </span><span class="hs-identifier">explain</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcExpr.html#NotClosedReason"><span class="hs-identifier hs-type">NotClosedReason</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2837"></a><span>    </span><a name="local-6989586621683756819"><a href="#local-6989586621683756819"><span class="hs-identifier">explain</span></a></a><span> </span><a name="local-6989586621683756832"><a href="#local-6989586621683756832"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683756833"><a href="#local-6989586621683756833"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2838"></a><span>      </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756832"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is used in a static form but it is not closed&quot;</span><span>
</span><a name="line-2839"></a><span>                        </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;because it&quot;</span><span>
</span><a name="line-2840"></a><span>                        </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-2841"></a><span>                        </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756820"><span class="hs-identifier hs-var">causes</span></a><span> </span><a href="#local-6989586621683756833"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">)</span><span>
</span><a name="line-2842"></a><span>
</span><a name="line-2843"></a><span>    </span><span class="hs-identifier">causes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcExpr.html#NotClosedReason"><span class="hs-identifier hs-type">NotClosedReason</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">]</span><span>
</span><a name="line-2844"></a><span>    </span><a name="local-6989586621683756820"><a href="#local-6989586621683756820"><span class="hs-identifier">causes</span></a></a><span> </span><a href="TcExpr.html#NotLetBoundReason"><span class="hs-identifier hs-var">NotLetBoundReason</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not let-bound.&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-2845"></a><span>    </span><span class="hs-identifier">causes</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#NotTypeClosed"><span class="hs-identifier hs-var">NotTypeClosed</span></a><span> </span><a name="local-6989586621683756834"><a href="#local-6989586621683756834"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2846"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has a non-closed type because it contains the&quot;</span><span>
</span><a name="line-2847"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type variables:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2848"></a><span>        </span><span class="hs-identifier hs-var">pprVarSet</span><span> </span><a href="#local-6989586621683756834"><span class="hs-identifier hs-var">vs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ppr</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2849"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-2850"></a><span>    </span><span class="hs-identifier">causes</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#NotClosed"><span class="hs-identifier hs-var">NotClosed</span></a><span> </span><a name="local-6989586621683756835"><a href="#local-6989586621683756835"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683756836"><a href="#local-6989586621683756836"><span class="hs-identifier">reason</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2851"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683756837"><a href="#local-6989586621683756837"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;uses&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683756835"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;which&quot;</span><span>
</span><a name="line-2852"></a><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683756836"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2853"></a><span>            </span><a href="TcExpr.html#NotClosed"><span class="hs-identifier hs-var">NotClosed</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683756837"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683756820"><span class="hs-identifier hs-var">causes</span></a><span> </span><a href="#local-6989586621683756836"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-2854"></a><span>            </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683756838"><a href="#local-6989586621683756838"><span class="hs-identifier">xs0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683756839"><a href="#local-6989586621683756839"><span class="hs-identifier">xs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683756820"><span class="hs-identifier hs-var">causes</span></a><span> </span><a href="#local-6989586621683756836"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-2855"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683756837"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683756838"><span class="hs-identifier hs-var">xs0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683756839"><span class="hs-identifier hs-var">xs1</span></a><span>
</span><a name="line-2856"></a><span>
</span><a name="line-2857"></a><span class="hs-comment">-- Note [Not-closed error messages]</span><span>
</span><a name="line-2858"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-2859"></a><span class="hs-comment">--</span><span>
</span><a name="line-2860"></a><span class="hs-comment">-- When variables in a static form are not closed, we go through the trouble</span><span>
</span><a name="line-2861"></a><span class="hs-comment">-- of explaining why they aren't.</span><span>
</span><a name="line-2862"></a><span class="hs-comment">--</span><span>
</span><a name="line-2863"></a><span class="hs-comment">-- Thus, the following program</span><span>
</span><a name="line-2864"></a><span class="hs-comment">--</span><span>
</span><a name="line-2865"></a><span class="hs-comment">-- &gt; {-# LANGUAGE StaticPointers #-}</span><span>
</span><a name="line-2866"></a><span class="hs-comment">-- &gt; module M where</span><span>
</span><a name="line-2867"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-2868"></a><span class="hs-comment">-- &gt; f x = static g</span><span>
</span><a name="line-2869"></a><span class="hs-comment">-- &gt;   where</span><span>
</span><a name="line-2870"></a><span class="hs-comment">-- &gt;     g = h</span><span>
</span><a name="line-2871"></a><span class="hs-comment">-- &gt;     h = x</span><span>
</span><a name="line-2872"></a><span class="hs-comment">--</span><span>
</span><a name="line-2873"></a><span class="hs-comment">-- produces the error</span><span>
</span><a name="line-2874"></a><span class="hs-comment">--</span><span>
</span><a name="line-2875"></a><span class="hs-comment">--    'g' is used in a static form but it is not closed because it</span><span>
</span><a name="line-2876"></a><span class="hs-comment">--    uses 'h' which uses 'x' which is not let-bound.</span><span>
</span><a name="line-2877"></a><span class="hs-comment">--</span><span>
</span><a name="line-2878"></a><span class="hs-comment">-- And a program like</span><span>
</span><a name="line-2879"></a><span class="hs-comment">--</span><span>
</span><a name="line-2880"></a><span class="hs-comment">-- &gt; {-# LANGUAGE StaticPointers #-}</span><span>
</span><a name="line-2881"></a><span class="hs-comment">-- &gt; module M where</span><span>
</span><a name="line-2882"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-2883"></a><span class="hs-comment">-- &gt; import Data.Typeable</span><span>
</span><a name="line-2884"></a><span class="hs-comment">-- &gt; import GHC.StaticPtr</span><span>
</span><a name="line-2885"></a><span class="hs-comment">-- &gt;</span><span>
</span><a name="line-2886"></a><span class="hs-comment">-- &gt; f :: Typeable a =&gt; a -&gt; StaticPtr TypeRep</span><span>
</span><a name="line-2887"></a><span class="hs-comment">-- &gt; f x = const (static (g undefined)) (h x)</span><span>
</span><a name="line-2888"></a><span class="hs-comment">-- &gt;   where</span><span>
</span><a name="line-2889"></a><span class="hs-comment">-- &gt;     g = h</span><span>
</span><a name="line-2890"></a><span class="hs-comment">-- &gt;     h = typeOf</span><span>
</span><a name="line-2891"></a><span class="hs-comment">--</span><span>
</span><a name="line-2892"></a><span class="hs-comment">-- produces the error</span><span>
</span><a name="line-2893"></a><span class="hs-comment">--</span><span>
</span><a name="line-2894"></a><span class="hs-comment">--    'g' is used in a static form but it is not closed because it</span><span>
</span><a name="line-2895"></a><span class="hs-comment">--    uses 'h' which has a non-closed type because it contains the</span><span>
</span><a name="line-2896"></a><span class="hs-comment">--    type variables: 'a'</span><span>
</span><a name="line-2897"></a><span class="hs-comment">--</span><span>
</span><a name="line-2898"></a><span>
</span><a name="line-2899"></a><span class="hs-comment">-- Note [Checking closedness]</span><span>
</span><a name="line-2900"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-2901"></a><span class="hs-comment">--</span><span>
</span><a name="line-2902"></a><span class="hs-comment">-- @checkClosed@ checks if a binding is closed and returns a reason if it is</span><span>
</span><a name="line-2903"></a><span class="hs-comment">-- not.</span><span>
</span><a name="line-2904"></a><span class="hs-comment">--</span><span>
</span><a name="line-2905"></a><span class="hs-comment">-- The bindings define a graph where the nodes are ids, and there is an edge</span><span>
</span><a name="line-2906"></a><span class="hs-comment">-- from @id1@ to @id2@ if the rhs of @id1@ contains @id2@ among its free</span><span>
</span><a name="line-2907"></a><span class="hs-comment">-- variables.</span><span>
</span><a name="line-2908"></a><span class="hs-comment">--</span><span>
</span><a name="line-2909"></a><span class="hs-comment">-- When @n@ is not closed, it has to exist in the graph some node reachable</span><span>
</span><a name="line-2910"></a><span class="hs-comment">-- from @n@ that it is not a let-bound variable or that it has a non-closed</span><span>
</span><a name="line-2911"></a><span class="hs-comment">-- type. Thus, the &quot;reason&quot; is a path from @n@ to this offending node.</span><span>
</span><a name="line-2912"></a><span class="hs-comment">--</span><span>
</span><a name="line-2913"></a><span class="hs-comment">-- When @n@ is not closed, we traverse the graph reachable from @n@ to build</span><span>
</span><a name="line-2914"></a><span class="hs-comment">-- the reason.</span><span>
</span><a name="line-2915"></a><span class="hs-comment">--</span><span>
</span><a name="line-2916"></a></pre></body></html>