<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, GeneralizedNewtypeDeriving, CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">{- Note: [The need for Ar.hs]
Building `-staticlib` required the presence of libtool, and was a such
restricted to mach-o only. As libtool on macOS and gnu libtool are very
different, there was no simple portable way to support this.

libtool for static archives does essentially: concatinate the input archives,
add the input objects, and create a symbol index. Using `ar` for this task
fails as even `ar` (bsd and gnu, llvm, ...) do not provide the same
features across platforms (e.g. index prefixed retrieval of objects with
the same name.)

As Archives are rather simple structurally, we can just build the archives
with Haskell directly and use ranlib on the final result to get the symbol
index. This should allow us to work around with the differences/abailability
of libtool across differet platforms.
-}</span><span>
</span><a name="line-18"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ar</span><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#afilter"><span class="hs-identifier hs-var">afilter</span></a><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#parseAr"><span class="hs-identifier hs-var">parseAr</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#loadAr"><span class="hs-identifier hs-var">loadAr</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#writeBSDAr"><span class="hs-identifier hs-var">writeBSDAr</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#writeGNUAr"><span class="hs-identifier hs-var">writeGNUAr</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#isBSDSymdef"><span class="hs-identifier hs-var">isBSDSymdef</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><a href="Ar.html#isGNUSymdef"><span class="hs-identifier hs-var">isGNUSymdef</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapAccumL</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary.Get</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary.Put</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">C</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">L</span><span>
</span><a name="line-46"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.Posix.Files</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">POSIX</span><span>
</span><a name="line-48"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeFileName</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">data</span><span> </span><a name="ArchiveEntry"><a href="Ar.html#ArchiveEntry"><span class="hs-identifier">ArchiveEntry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ArchiveEntry"><a href="Ar.html#ArchiveEntry"><span class="hs-identifier">ArchiveEntry</span></a></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="filename"><a href="Ar.html#filename"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>       </span><span class="hs-comment">-- ^ File name.</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="filetime"><a href="Ar.html#filetime"><span class="hs-identifier">filetime</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- ^ File modification time.</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="fileown"><a href="Ar.html#fileown"><span class="hs-identifier">fileown</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- ^ File owner.</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="filegrp"><a href="Ar.html#filegrp"><span class="hs-identifier">filegrp</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- ^ File group.</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="filemode"><a href="Ar.html#filemode"><span class="hs-identifier">filemode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- ^ File mode.</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="filesize"><a href="Ar.html#filesize"><span class="hs-identifier">filesize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- ^ File size.</span><span>
</span><a name="line-58"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="filedata"><a href="Ar.html#filedata"><span class="hs-identifier">filedata</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span> </span><span class="hs-comment">-- ^ File bytes.</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-keyword">newtype</span><span> </span><a name="Archive"><a href="Ar.html#Archive"><span class="hs-identifier">Archive</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Archive"><a href="Ar.html#Archive"><span class="hs-identifier">Archive</span></a></a><span> </span><span class="hs-special">[</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">]</span><span>
</span><a name="line-62"></a><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-identifier">afilter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span>
</span><a name="line-65"></a><a name="afilter"><a href="Ar.html#afilter"><span class="hs-identifier">afilter</span></a></a><span> </span><a name="local-6989586621679046958"><a href="#local-6989586621679046958"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Ar.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><a name="local-6989586621679046959"><a href="#local-6989586621679046959"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679046958"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679046959"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-identifier">isBSDSymdef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isGNUSymdef</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-68"></a><a name="isBSDSymdef"><a href="Ar.html#isBSDSymdef"><span class="hs-identifier">isBSDSymdef</span></a></a><span> </span><a name="local-6989586621679047148"><a href="#local-6989586621679047148"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;__.SYMDEF&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filename</span><span> </span><a href="#local-6989586621679047148"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><a name="isGNUSymdef"><a href="Ar.html#isGNUSymdef"><span class="hs-identifier">isGNUSymdef</span></a></a><span> </span><a name="local-6989586621679047304"><a href="#local-6989586621679047304"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filename</span><span> </span><a href="#local-6989586621679047304"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-comment">-- | Archives have numeric values padded with '\x20' to the right.</span><span>
</span><a name="line-72"></a><span class="hs-identifier">getPaddedInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-73"></a><a name="getPaddedInt"><a href="Ar.html#getPaddedInt"><span class="hs-identifier">getPaddedInt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\x20'</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-identifier">putPaddedInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-76"></a><a name="putPaddedInt"><a href="Ar.html#putPaddedInt"><span class="hs-identifier">putPaddedInt</span></a></a><span> </span><a name="local-6989586621679047339"><a href="#local-6989586621679047339"><span class="hs-identifier">padding</span></a></a><span> </span><a name="local-6989586621679047340"><a href="#local-6989586621679047340"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ar.html#putPaddedString"><span class="hs-identifier hs-var">putPaddedString</span></a><span> </span><span class="hs-char">'\x20'</span><span> </span><a href="#local-6989586621679047339"><span class="hs-identifier hs-var">padding</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679047340"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-identifier">putPaddedString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-79"></a><a name="putPaddedString"><a href="Ar.html#putPaddedString"><span class="hs-identifier">putPaddedString</span></a></a><span> </span><a name="local-6989586621679047341"><a href="#local-6989586621679047341"><span class="hs-identifier">pad</span></a></a><span> </span><a name="local-6989586621679047342"><a href="#local-6989586621679047342"><span class="hs-identifier">padding</span></a></a><span> </span><a name="local-6989586621679047343"><a href="#local-6989586621679047343"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putByteString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.pack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679047342"><span class="hs-identifier hs-var">padding</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679047343"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="#local-6989586621679047341"><span class="hs-identifier hs-var">pad</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-identifier">getBSDArchEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-special">[</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">]</span><span>
</span><a name="line-82"></a><a name="getBSDArchEntries"><a href="Ar.html#getBSDArchEntries"><span class="hs-identifier">getBSDArchEntries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679047344"><a href="#local-6989586621679047344"><span class="hs-identifier">empty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isEmpty</span><span>
</span><a name="line-84"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679047344"><span class="hs-identifier hs-var">empty</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-86"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-87"></a><span>        </span><a name="local-6989586621679047345"><a href="#local-6989586621679047345"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">16</span><span>
</span><a name="line-88"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-char">'/'</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">C.elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679047345"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">C.take</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621679047345"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-string">&quot;#1/&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-89"></a><span>          </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Looks like GNU Archive&quot;</span><span>
</span><a name="line-90"></a><span>        </span><a name="local-6989586621679047360"><a href="#local-6989586621679047360"><span class="hs-identifier">time</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">12</span><span>
</span><a name="line-91"></a><span>        </span><a name="local-6989586621679047361"><a href="#local-6989586621679047361"><span class="hs-identifier">own</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">6</span><span>
</span><a name="line-92"></a><span>        </span><a name="local-6989586621679047362"><a href="#local-6989586621679047362"><span class="hs-identifier">grp</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">6</span><span>
</span><a name="line-93"></a><span>        </span><a name="local-6989586621679047363"><a href="#local-6989586621679047363"><span class="hs-identifier">mode</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-94"></a><span>        </span><a name="local-6989586621679047364"><a href="#local-6989586621679047364"><span class="hs-identifier">st_size</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">10</span><span>
</span><a name="line-95"></a><span>        </span><a name="local-6989586621679047365"><a href="#local-6989586621679047365"><span class="hs-identifier">end</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679047365"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-string">&quot;\x60\x0a&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-97"></a><span>          </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;[BSD Archive] Invalid archive header end marker for name: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-98"></a><span>                </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><a href="#local-6989586621679047345"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>        </span><a name="local-6989586621679047882"><a href="#local-6989586621679047882"><span class="hs-identifier">off1</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-identifier hs-var">bytesRead</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-comment">-- BSD stores extended filenames, by writing #1/&lt;length&gt; into the</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-comment">-- name field, the first @length@ bytes then represent the file name</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-comment">-- thus the payload size is filesize + file name length.</span><span>
</span><a name="line-103"></a><span>        </span><a name="local-6989586621679047883"><a href="#local-6989586621679047883"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">C.take</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621679047345"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;#1/&quot;</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-104"></a><span>                        </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\0'</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">C.drop</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621679047345"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>                    </span><span class="hs-keyword">else</span><span>
</span><a name="line-106"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">C.takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047345"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-107"></a><span>        </span><a name="local-6989586621679047884"><a href="#local-6989586621679047884"><span class="hs-identifier">off2</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-identifier hs-var">bytesRead</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-108"></a><span>        </span><a name="local-6989586621679047965"><a href="#local-6989586621679047965"><span class="hs-identifier">file</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679047364"><span class="hs-identifier hs-var">st_size</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679047884"><span class="hs-identifier hs-var">off2</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679047882"><span class="hs-identifier hs-var">off1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>        </span><span class="hs-comment">-- data sections are two byte aligned (see Trac #15396)</span><span>
</span><a name="line-110"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">odd</span><span> </span><a href="#local-6989586621679047364"><span class="hs-identifier hs-var">st_size</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-111"></a><span>          </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span>        </span><a name="local-6989586621679047966"><a href="#local-6989586621679047966"><span class="hs-identifier">rest</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getBSDArchEntries"><span class="hs-identifier hs-var">getBSDArchEntries</span></a><span>
</span><a name="line-114"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><a href="#local-6989586621679047883"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679047360"><span class="hs-identifier hs-var">time</span></a><span> </span><a href="#local-6989586621679047361"><span class="hs-identifier hs-var">own</span></a><span> </span><a href="#local-6989586621679047362"><span class="hs-identifier hs-var">grp</span></a><span> </span><a href="#local-6989586621679047363"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679047364"><span class="hs-identifier hs-var">st_size</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679047884"><span class="hs-identifier hs-var">off2</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679047882"><span class="hs-identifier hs-var">off1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047965"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679047966"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-comment">-- | GNU Archives feature a special '//' entry that contains the</span><span>
</span><a name="line-117"></a><span class="hs-comment">-- extended names. Those are referred to as /&lt;num&gt;, where num is the</span><span>
</span><a name="line-118"></a><span class="hs-comment">-- offset into the '//' entry.</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- In addition, filenames are terminated with '/' in the archive.</span><span>
</span><a name="line-120"></a><span class="hs-identifier">getGNUArchEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-special">[</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">]</span><span>
</span><a name="line-121"></a><a name="getGNUArchEntries"><a href="Ar.html#getGNUArchEntries"><span class="hs-identifier">getGNUArchEntries</span></a></a><span> </span><a name="local-6989586621679047967"><a href="#local-6989586621679047967"><span class="hs-identifier">extInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>  </span><a name="local-6989586621679047985"><a href="#local-6989586621679047985"><span class="hs-identifier">empty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isEmpty</span><span>
</span><a name="line-123"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679047985"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-keyword">else</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-127"></a><span>      </span><a name="local-6989586621679047986"><a href="#local-6989586621679047986"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">16</span><span>
</span><a name="line-128"></a><span>      </span><a name="local-6989586621679047987"><a href="#local-6989586621679047987"><span class="hs-identifier">time</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">12</span><span>
</span><a name="line-129"></a><span>      </span><a name="local-6989586621679047988"><a href="#local-6989586621679047988"><span class="hs-identifier">own</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">6</span><span>
</span><a name="line-130"></a><span>      </span><a name="local-6989586621679047989"><a href="#local-6989586621679047989"><span class="hs-identifier">grp</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">6</span><span>
</span><a name="line-131"></a><span>      </span><a name="local-6989586621679047990"><a href="#local-6989586621679047990"><span class="hs-identifier">mode</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-132"></a><span>      </span><a name="local-6989586621679047991"><a href="#local-6989586621679047991"><span class="hs-identifier">st_size</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#getPaddedInt"><span class="hs-identifier hs-var">getPaddedInt</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">10</span><span>
</span><a name="line-133"></a><span>      </span><a name="local-6989586621679047992"><a href="#local-6989586621679047992"><span class="hs-identifier">end</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-134"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679047992"><span class="hs-identifier hs-var">end</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-string">&quot;\x60\x0a&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-135"></a><span>        </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;[BSD Archive] Invalid archive header end marker for name: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-136"></a><span>              </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><a href="#local-6989586621679047986"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>      </span><a name="local-6989586621679047993"><a href="#local-6989586621679047993"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><a href="#local-6989586621679047991"><span class="hs-identifier hs-var">st_size</span></a><span>
</span><a name="line-138"></a><span>      </span><span class="hs-comment">-- data sections are two byte aligned (see Trac #15396)</span><span>
</span><a name="line-139"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">odd</span><span> </span><a href="#local-6989586621679047991"><span class="hs-identifier hs-var">st_size</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>      </span><a name="local-6989586621679047997"><a href="#local-6989586621679047997"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">C.take</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679047986"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;/&quot;</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">C.takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047986"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-144"></a><span>               </span><a name="local-6989586621679047994"><a href="#local-6989586621679047994"><span class="hs-identifier">name</span></a></a><span class="hs-glyph">@</span><span class="hs-string">&quot;/&quot;</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679047994"><span class="hs-identifier hs-var">name</span></a><span>               </span><span class="hs-comment">-- symbol table</span><span>
</span><a name="line-145"></a><span>               </span><a name="local-6989586621679047995"><a href="#local-6989586621679047995"><span class="hs-identifier">name</span></a></a><span class="hs-glyph">@</span><span class="hs-string">&quot;//&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679047995"><span class="hs-identifier hs-var">name</span></a><span>               </span><span class="hs-comment">-- extendedn file names table</span><span>
</span><a name="line-146"></a><span>               </span><a name="local-6989586621679047996"><a href="#local-6989586621679047996"><span class="hs-identifier">name</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679047968"><span class="hs-identifier hs-var">getExtName</span></a><span> </span><a href="#local-6989586621679047967"><span class="hs-identifier hs-var">extInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">C.drop</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679047996"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">C.takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'/'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679047986"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-148"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679047997"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-string">&quot;/&quot;</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#getGNUArchEntries"><span class="hs-identifier hs-var">getGNUArchEntries</span></a><span> </span><a href="#local-6989586621679047967"><span class="hs-identifier hs-var">extInfo</span></a><span>
</span><a name="line-150"></a><span>        </span><span class="hs-string">&quot;//&quot;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#getGNUArchEntries"><span class="hs-identifier hs-var">getGNUArchEntries</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><a href="#local-6989586621679047997"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679047987"><span class="hs-identifier hs-var">time</span></a><span> </span><a href="#local-6989586621679047988"><span class="hs-identifier hs-var">own</span></a><span> </span><a href="#local-6989586621679047989"><span class="hs-identifier hs-var">grp</span></a><span> </span><a href="#local-6989586621679047990"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679047991"><span class="hs-identifier hs-var">st_size</span></a><span> </span><a href="#local-6989586621679047993"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><a href="#local-6989586621679047997"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679047987"><span class="hs-identifier hs-var">time</span></a><span> </span><a href="#local-6989586621679047988"><span class="hs-identifier hs-var">own</span></a><span> </span><a href="#local-6989586621679047989"><span class="hs-identifier hs-var">grp</span></a><span> </span><a href="#local-6989586621679047990"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621679047991"><span class="hs-identifier hs-var">st_size</span></a><span> </span><a href="#local-6989586621679047993"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Ar.html#getGNUArchEntries"><span class="hs-identifier hs-var">getGNUArchEntries</span></a><span> </span><a href="#local-6989586621679047967"><span class="hs-identifier hs-var">extInfo</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-154"></a><span>   </span><span class="hs-identifier">getExtName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span>
</span><a name="line-155"></a><span>   </span><a name="local-6989586621679047968"><a href="#local-6989586621679047968"><span class="hs-identifier">getExtName</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Invalid extended filename reference.&quot;</span><span>
</span><a name="line-156"></a><span>   </span><span class="hs-identifier">getExtName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679047983"><a href="#local-6989586621679047983"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679047984"><a href="#local-6989586621679047984"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">C.takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'/'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">C.drop</span><span> </span><a href="#local-6989586621679047984"><span class="hs-identifier hs-var">offset</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">filedata</span><span> </span><a href="#local-6989586621679047983"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- | put an Archive Entry. This assumes that the entries</span><span>
</span><a name="line-159"></a><span class="hs-comment">-- have been preprocessed to account for the extenden file name</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- table section &quot;//&quot; e.g. for GNU Archives. Or that the names</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- have been move into the payload for BSD Archives.</span><span>
</span><a name="line-162"></a><span class="hs-identifier">putArchEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PutM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><a name="putArchEntry"><a href="Ar.html#putArchEntry"><span class="hs-identifier">putArchEntry</span></a></a><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><a name="local-6989586621679047998"><a href="#local-6989586621679047998"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679047999"><a href="#local-6989586621679047999"><span class="hs-identifier">time</span></a></a><span> </span><a name="local-6989586621679048000"><a href="#local-6989586621679048000"><span class="hs-identifier">own</span></a></a><span> </span><a name="local-6989586621679048001"><a href="#local-6989586621679048001"><span class="hs-identifier">grp</span></a></a><span> </span><a name="local-6989586621679048002"><a href="#local-6989586621679048002"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621679048003"><a href="#local-6989586621679048003"><span class="hs-identifier">st_size</span></a></a><span> </span><a name="local-6989586621679048004"><a href="#local-6989586621679048004"><span class="hs-identifier">file</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-164"></a><span>  </span><a href="Ar.html#putPaddedString"><span class="hs-identifier hs-var">putPaddedString</span></a><span> </span><span class="hs-char">' '</span><span>  </span><span class="hs-number">16</span><span> </span><a href="#local-6989586621679047998"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-165"></a><span>  </span><a href="Ar.html#putPaddedInt"><span class="hs-identifier hs-var">putPaddedInt</span></a><span>         </span><span class="hs-number">12</span><span> </span><a href="#local-6989586621679047999"><span class="hs-identifier hs-var">time</span></a><span>
</span><a name="line-166"></a><span>  </span><a href="Ar.html#putPaddedInt"><span class="hs-identifier hs-var">putPaddedInt</span></a><span>          </span><span class="hs-number">6</span><span> </span><a href="#local-6989586621679048000"><span class="hs-identifier hs-var">own</span></a><span>
</span><a name="line-167"></a><span>  </span><a href="Ar.html#putPaddedInt"><span class="hs-identifier hs-var">putPaddedInt</span></a><span>          </span><span class="hs-number">6</span><span> </span><a href="#local-6989586621679048001"><span class="hs-identifier hs-var">grp</span></a><span>
</span><a name="line-168"></a><span>  </span><a href="Ar.html#putPaddedInt"><span class="hs-identifier hs-var">putPaddedInt</span></a><span>          </span><span class="hs-number">8</span><span> </span><a href="#local-6989586621679048002"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-169"></a><span>  </span><a href="Ar.html#putPaddedInt"><span class="hs-identifier hs-var">putPaddedInt</span></a><span>         </span><span class="hs-number">10</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679048003"><span class="hs-identifier hs-var">st_size</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679048005"><span class="hs-identifier hs-var">pad</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-identifier hs-var">putByteString</span><span>           </span><span class="hs-string">&quot;\x60\x0a&quot;</span><span>
</span><a name="line-171"></a><span>  </span><span class="hs-identifier hs-var">putByteString</span><span>           </span><a href="#local-6989586621679048004"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-172"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679048005"><span class="hs-identifier hs-var">pad</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-173"></a><span>    </span><span class="hs-identifier hs-var">putWord8</span><span>              </span><span class="hs-number">0x0a</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-175"></a><span>    </span><a name="local-6989586621679048005"><a href="#local-6989586621679048005"><span class="hs-identifier">pad</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679048003"><span class="hs-identifier hs-var">st_size</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-identifier">getArchMagic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><a name="getArchMagic"><a href="Ar.html#getArchMagic"><span class="hs-identifier">getArchMagic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>  </span><a name="local-6989586621679048006"><a href="#local-6989586621679048006"><span class="hs-identifier">magic</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">C.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-180"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679048006"><span class="hs-identifier hs-var">magic</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-string">&quot;!&lt;arch&gt;\n&quot;</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Invalid magic number &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679048006"><span class="hs-identifier hs-var">magic</span></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">putArchMagic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-185"></a><a name="putArchMagic"><a href="Ar.html#putArchMagic"><span class="hs-identifier">putArchMagic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putByteString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">C.pack</span><span> </span><span class="hs-string">&quot;!&lt;arch&gt;\n&quot;</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-identifier">getArch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span>
</span><a name="line-188"></a><a name="getArch"><a href="Ar.html#getArch"><span class="hs-identifier">getArch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-189"></a><span>  </span><a href="Ar.html#getArchMagic"><span class="hs-identifier hs-var">getArchMagic</span></a><span>
</span><a name="line-190"></a><span>  </span><a href="Ar.html#getBSDArchEntries"><span class="hs-identifier hs-var">getBSDArchEntries</span></a><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><a href="Ar.html#getGNUArchEntries"><span class="hs-identifier hs-var">getGNUArchEntries</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-identifier">putBSDArch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PutM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><a name="putBSDArch"><a href="Ar.html#putBSDArch"><span class="hs-identifier">putBSDArch</span></a></a><span> </span><span class="hs-special">(</span><a href="Ar.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-194"></a><span>  </span><a href="Ar.html#putArchMagic"><span class="hs-identifier hs-var">putArchMagic</span></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Ar.html#putArchEntry"><span class="hs-identifier hs-var">putArchEntry</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679048012"><span class="hs-identifier hs-var">processEntries</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-198"></a><span>    </span><a name="local-6989586621679048008"><a href="#local-6989586621679048008"><span class="hs-identifier">padStr</span></a></a><span> </span><a name="local-6989586621679048013"><a href="#local-6989586621679048013"><span class="hs-identifier">pad</span></a></a><span> </span><a name="local-6989586621679048014"><a href="#local-6989586621679048014"><span class="hs-identifier">size</span></a></a><span> </span><a name="local-6989586621679048015"><a href="#local-6989586621679048015"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679048014"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679048015"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="#local-6989586621679048013"><span class="hs-identifier hs-var">pad</span></a><span>
</span><a name="line-199"></a><span>    </span><a name="local-6989586621679048009"><a href="#local-6989586621679048009"><span class="hs-identifier">nameSize</span></a></a><span> </span><a name="local-6989586621679048016"><a href="#local-6989586621679048016"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679048016"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">divMod</span><span class="hs-special">`</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-200"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679049153"><a href="#local-6989586621679049153"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679049153"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-201"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679049154"><a href="#local-6989586621679049154"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679049154"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679048010"><a href="#local-6989586621679048010"><span class="hs-identifier">needExt</span></a></a><span> </span><a name="local-6989586621679049155"><a href="#local-6989586621679049155"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679049155"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">16</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679049155"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">processEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span>
</span><a name="line-204"></a><span>    </span><a name="local-6989586621679048011"><a href="#local-6989586621679048011"><span class="hs-identifier">processEntry</span></a></a><span> </span><a name="local-6989586621679049156"><a href="#local-6989586621679049156"><span class="hs-identifier">archive</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><a name="local-6989586621679049157"><a href="#local-6989586621679049157"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679049158"><a href="#local-6989586621679049158"><span class="hs-identifier">st_size</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679048010"><span class="hs-identifier hs-var">needExt</span></a><span> </span><a href="#local-6989586621679049157"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049156"><span class="hs-identifier hs-var">archive</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">filename</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;#1/&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679049159"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-206"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">filedata</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">C.pack</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679048008"><span class="hs-identifier hs-var">padStr</span></a><span> </span><span class="hs-char">'\0'</span><span> </span><a href="#local-6989586621679049159"><span class="hs-identifier hs-var">sz</span></a><span> </span><a href="#local-6989586621679049157"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier">filedata</span><span> </span><a href="#local-6989586621679049156"><span class="hs-identifier hs-var">archive</span></a><span>
</span><a name="line-207"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">filesize</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049158"><span class="hs-identifier hs-var">st_size</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679049159"><span class="hs-identifier hs-var">sz</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-208"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049156"><span class="hs-identifier hs-var">archive</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679049159"><a href="#local-6989586621679049159"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679048009"><span class="hs-identifier hs-var">nameSize</span></a><span> </span><a href="#local-6989586621679049157"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621679048012"><a href="#local-6989586621679048012"><span class="hs-identifier">processEntries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679048011"><span class="hs-identifier hs-var">processEntry</span></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-identifier">putGNUArch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PutM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><a name="putGNUArch"><a href="Ar.html#putGNUArch"><span class="hs-identifier">putGNUArch</span></a></a><span> </span><span class="hs-special">(</span><a href="Ar.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-216"></a><span>  </span><a href="Ar.html#putArchMagic"><span class="hs-identifier hs-var">putArchMagic</span></a><span>
</span><a name="line-217"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Ar.html#putArchEntry"><span class="hs-identifier hs-var">putArchEntry</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679049162"><span class="hs-identifier hs-var">processEntries</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-identifier">processEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">,</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>    </span><a name="local-6989586621679049161"><a href="#local-6989586621679049161"><span class="hs-identifier">processEntry</span></a></a><span> </span><a name="local-6989586621679049163"><a href="#local-6989586621679049163"><span class="hs-identifier">extInfo</span></a></a><span> </span><a name="local-6989586621679049164"><a href="#local-6989586621679049164"><span class="hs-identifier">archive</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><a name="local-6989586621679049165"><a href="#local-6989586621679049165"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679049165"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">15</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679049163"><span class="hs-identifier hs-var">extInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">filesize</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filesize</span><span> </span><a href="#local-6989586621679049163"><span class="hs-identifier hs-var">extInfo</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679049165"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-223"></a><span>                                    </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">filedata</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filedata</span><span> </span><a href="#local-6989586621679049163"><span class="hs-identifier hs-var">extInfo</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>  </span><span class="hs-identifier hs-var">C.pack</span><span> </span><a href="#local-6989586621679049165"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;/\n&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-224"></a><span>                           </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679049164"><span class="hs-identifier hs-var">archive</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">filename</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filesize</span><span> </span><a href="#local-6989586621679049163"><span class="hs-identifier hs-var">extInfo</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621679049163"><span class="hs-identifier hs-var">extInfo</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679049164"><span class="hs-identifier hs-var">archive</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">filename</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049165"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span>    </span><span class="hs-identifier">processEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span class="hs-special">]</span><span>
</span><a name="line-228"></a><span>    </span><a name="local-6989586621679049162"><a href="#local-6989586621679049162"><span class="hs-identifier">processEntries</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-229"></a><span>      </span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621679049161"><span class="hs-identifier hs-var">processEntry</span></a><span> </span><span class="hs-special">(</span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span> </span><span class="hs-string">&quot;//&quot;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-identifier">parseAr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">B.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span>
</span><a name="line-232"></a><a name="parseAr"><a href="Ar.html#parseAr"><span class="hs-identifier">parseAr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runGet</span><span> </span><a href="Ar.html#getArch"><span class="hs-identifier hs-var">getArch</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">L.fromChunks</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">pure</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">writeBSDAr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">writeGNUAr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><a name="writeBSDAr"><a href="Ar.html#writeBSDAr"><span class="hs-identifier">writeBSDAr</span></a></a><span> </span><a name="local-6989586621679049610"><a href="#local-6989586621679049610"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L.writeFile</span><span> </span><a href="#local-6989586621679049610"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ar.html#putBSDArch"><span class="hs-identifier hs-var">putBSDArch</span></a><span>
</span><a name="line-236"></a><a name="writeGNUAr"><a href="Ar.html#writeGNUAr"><span class="hs-identifier">writeGNUAr</span></a></a><span> </span><a name="local-6989586621679049611"><a href="#local-6989586621679049611"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L.writeFile</span><span> </span><a href="#local-6989586621679049611"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ar.html#putGNUArch"><span class="hs-identifier hs-var">putGNUArch</span></a><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-identifier">loadAr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Ar.html#Archive"><span class="hs-identifier hs-type">Archive</span></a><span>
</span><a name="line-239"></a><a name="loadAr"><a href="Ar.html#loadAr"><span class="hs-identifier">loadAr</span></a></a><span> </span><a name="local-6989586621679049612"><a href="#local-6989586621679049612"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Ar.html#parseAr"><span class="hs-identifier hs-var">parseAr</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">B.readFile</span><span> </span><a href="#local-6989586621679049612"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-identifier">loadObj</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-type">ArchiveEntry</span></a><span>
</span><a name="line-242"></a><a name="loadObj"><a href="Ar.html#loadObj"><span class="hs-identifier">loadObj</span></a></a><span> </span><a name="local-6989586621679049613"><a href="#local-6989586621679049613"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-243"></a><span>  </span><a name="local-6989586621679049614"><a href="#local-6989586621679049614"><span class="hs-identifier">payload</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">B.readFile</span><span> </span><a href="#local-6989586621679049613"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-244"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679049615"><a href="#local-6989586621679049615"><span class="hs-identifier">modt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679049616"><a href="#local-6989586621679049616"><span class="hs-identifier">own</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679049617"><a href="#local-6989586621679049617"><span class="hs-identifier">grp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679049618"><a href="#local-6989586621679049618"><span class="hs-identifier">mode</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Ar.html#fileInfo"><span class="hs-identifier hs-var">fileInfo</span></a><span> </span><a href="#local-6989586621679049613"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ar.html#ArchiveEntry"><span class="hs-identifier hs-var">ArchiveEntry</span></a><span>
</span><a name="line-246"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeFileName</span><span> </span><a href="#local-6989586621679049613"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679049615"><span class="hs-identifier hs-var">modt</span></a><span> </span><a href="#local-6989586621679049616"><span class="hs-identifier hs-var">own</span></a><span> </span><a href="#local-6989586621679049617"><span class="hs-identifier hs-var">grp</span></a><span> </span><a href="#local-6989586621679049618"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-247"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">B.length</span><span> </span><a href="#local-6989586621679049614"><span class="hs-identifier hs-var">payload</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679049614"><span class="hs-identifier hs-var">payload</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-comment">-- | Take a filePath and return (mod time, own, grp, mode in decimal)</span><span>
</span><a name="line-250"></a><span class="hs-identifier">fileInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ mod time, own, grp, mode (in decimal)</span><span>
</span><a name="line-251"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-comment">-- on windows mod time, owner group and mode are zero.</span><span>
</span><a name="line-253"></a><span class="hs-identifier">fileInfo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span class="hs-cpp">#else
</span><a name="fileInfo"><a href="Ar.html#fileInfo"><span class="hs-identifier">fileInfo</span></a></a><span> </span><a name="local-6989586621679049754"><a href="#local-6989586621679049754"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679049755"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">POSIX.getFileStatus</span><span> </span><a href="#local-6989586621679049754"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679049755"><a href="#local-6989586621679049755"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679049756"><a href="#local-6989586621679049756"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fromEnum</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">POSIX.modificationTime</span><span> </span><a href="#local-6989586621679049756"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-257"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">POSIX.fileOwner</span><span> </span><a href="#local-6989586621679049756"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-258"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">POSIX.fileGroup</span><span> </span><a href="#local-6989586621679049756"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-259"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="Ar.html#oct2dec"><span class="hs-identifier hs-var">oct2dec</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">POSIX.fileMode</span><span> </span><a href="#local-6989586621679049756"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-260"></a><span>                    </span><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-identifier">oct2dec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-263"></a><a name="oct2dec"><a href="Ar.html#oct2dec"><span class="hs-identifier">oct2dec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679050737"><a href="#local-6989586621679050737"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679050738"><a href="#local-6989586621679050738"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679050737"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">10</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679050738"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679050732"><span class="hs-identifier hs-var">dec</span></a><span> </span><span class="hs-number">8</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679050732"><a href="#local-6989586621679050732"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-265"></a><span>        </span><span class="hs-identifier">dec</span><span> </span><a name="local-6989586621679050733"><a href="#local-6989586621679050733"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679050734"><a href="#local-6989586621679050734"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679050735"><a href="#local-6989586621679050735"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679050736"><a href="#local-6989586621679050736"><span class="hs-identifier">last</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679050734"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679050733"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-266"></a><span>                  </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679050736"><span class="hs-identifier hs-var">last</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679050732"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621679050733"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679050735"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span class="hs-cpp">#endif
</span></pre></body></html>