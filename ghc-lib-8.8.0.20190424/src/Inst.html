<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


The @Inst@ type: dictionaries or method instances
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, MultiWayIf, TupleSections #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Inst</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>       </span><a href="Inst.html#deeplySkolemise"><span class="hs-identifier hs-var">deeplySkolemise</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>       </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#topInstantiateInferred"><span class="hs-identifier hs-var">topInstantiateInferred</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#deeplyInstantiate"><span class="hs-identifier hs-var">deeplyInstantiate</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>       </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#instDFunType"><span class="hs-identifier hs-var">instDFunType</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#instStupidTheta"><span class="hs-identifier hs-var">instStupidTheta</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#instTyVarsWith"><span class="hs-identifier hs-var">instTyVarsWith</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>       </span><a href="TcMType.html#newWanted"><span class="hs-identifier hs-var">newWanted</span></a><span class="hs-special">,</span><span> </span><a href="TcMType.html#newWanteds"><span class="hs-identifier hs-var">newWanteds</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>       </span><a href="Inst.html#tcInstTyBinders"><span class="hs-identifier hs-var">tcInstTyBinders</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#tcInstTyBinder"><span class="hs-identifier hs-var">tcInstTyBinder</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>       </span><a href="Inst.html#newOverloadedLit"><span class="hs-identifier hs-var">newOverloadedLit</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#mkOverLit"><span class="hs-identifier hs-var">mkOverLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>       </span><a href="Inst.html#newClsInst"><span class="hs-identifier hs-var">newClsInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>       </span><a href="Inst.html#tcGetInsts"><span class="hs-identifier hs-var">tcGetInsts</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#getOverlapFlag"><span class="hs-identifier hs-var">getOverlapFlag</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>       </span><a href="Inst.html#tcExtendLocalInstEnv"><span class="hs-identifier hs-var">tcExtendLocalInstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>       </span><a href="Inst.html#instCallConstraints"><span class="hs-identifier hs-var">instCallConstraints</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>       </span><a href="Inst.html#tcSyntaxName"><span class="hs-identifier hs-var">tcSyntaxName</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-comment">-- Simple functions over evidence variables</span><span>
</span><a name="line-29"></a><span>       </span><span class="hs-identifier hs-var">tyCoVarsOfWC</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>       </span><span class="hs-identifier hs-var">tyCoVarsOfCt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfCts</span><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span class="hs-special">(</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span class="hs-special">(</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#unifyKind"><span class="hs-identifier hs-var">unifyKind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">IntegralLit</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SourceText</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">heqDataCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">eqDataCon</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isOrphan</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="FunDeps.html"><span class="hs-identifier">FunDeps</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkDictFunId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Expr</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- For the Coercion constructor</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tyVarName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">VarBndr</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Creating and emittind constraints
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-identifier">newMethodFromName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- Used when Name is the wired-in name for a wired-in class method,</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- so the caller knows its type for sure, which should be of form</span><span>
</span><a name="line-84"></a><span class="hs-comment">--    forall a. C a =&gt; &lt;blah&gt;</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- newMethodFromName is supposed to instantiate just the outer</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- type variable and constraint</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><a name="newMethodFromName"><a href="Inst.html#newMethodFromName"><span class="hs-identifier">newMethodFromName</span></a></a><span> </span><a name="local-6989586621682582392"><a href="#local-6989586621682582392"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-6989586621682582393"><a href="#local-6989586621682582393"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682582394"><a href="#local-6989586621682582394"><span class="hs-identifier">inst_ty</span></a></a><span>
</span><a name="line-89"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582395"><a href="#local-6989586621682582395"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621682582393"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-90"></a><span>              </span><span class="hs-comment">-- Use tcLookupId not tcLookupGlobalId; the method is almost</span><span>
</span><a name="line-91"></a><span>              </span><span class="hs-comment">-- always a class op, but with -XRebindableSyntax GHC is</span><span>
</span><a name="line-92"></a><span>              </span><span class="hs-comment">-- meant to find whatever thing is in scope, and that may</span><span>
</span><a name="line-93"></a><span>              </span><span class="hs-comment">-- be an ordinary function.</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582396"><a href="#local-6989586621682582396"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">piResultTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682582395"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582394"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-96"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682582397"><a href="#local-6989586621682582397"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582398"><a href="#local-6989586621682582398"><span class="hs-identifier">_caller_knows_this</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitPhiTy</span><span> </span><a href="#local-6989586621682582396"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-97"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582399"><a href="#local-6989586621682582399"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isForAllTy</span><span> </span><span class="hs-identifier">ty</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">isSingleton</span><span> </span><span class="hs-identifier">theta</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>                 </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span> </span><a href="#local-6989586621682582392"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682582394"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682582397"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621682582399"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682582395"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Deep instantiation and skolemisation
*                                                                      *
************************************************************************

Note [Deep skolemisation]
~~~~~~~~~~~~~~~~~~~~~~~~~
deeplySkolemise decomposes and skolemises a type, returning a type
with all its arrows visible (ie not buried under foralls)

Examples:

  deeplySkolemise (Int -&gt; forall a. Ord a =&gt; blah)
    =  ( wp, [a], [d:Ord a], Int -&gt; blah )
    where wp = \x:Int. /\a. \(d:Ord a). &lt;hole&gt; x

  deeplySkolemise  (forall a. Ord a =&gt; Maybe a -&gt; forall b. Eq b =&gt; blah)
    =  ( wp, [a,b], [d1:Ord a,d2:Eq b], Maybe a -&gt; blah )
    where wp = /\a.\(d1:Ord a).\(x:Maybe a)./\b.\(d2:Ord b). &lt;hole&gt; x

In general,
  if      deeplySkolemise ty = (wrap, tvs, evs, rho)
    and   e :: rho
  then    wrap e :: ty
    and   'wrap' binds tvs, evs

ToDo: this eta-abstraction plays fast and loose with termination,
      because it can introduce extra lambdas.  Maybe add a `seq` to
      fix this
-}</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">deeplySkolemise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>
</span><a name="line-136"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span>
</span><a name="line-137"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- All skolemised variables</span><span>
</span><a name="line-138"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- All &quot;given&quot;s</span><span>
</span><a name="line-139"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><a name="deeplySkolemise"><a href="Inst.html#deeplySkolemise"><span class="hs-identifier">deeplySkolemise</span></a></a><span> </span><a name="local-6989586621682582400"><a href="#local-6989586621682582400"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-142"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582402"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682582401"><span class="hs-identifier hs-var">init_subst</span></a><span> </span><a href="#local-6989586621682582400"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-143"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-144"></a><span>    </span><a name="local-6989586621682582401"><a href="#local-6989586621682582401"><span class="hs-identifier">init_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621682582400"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span>    </span><a name="local-6989586621682582402"><a href="#local-6989586621682582402"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682582403"><a href="#local-6989586621682582403"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682582404"><a href="#local-6989586621682582404"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-147"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582405"><a href="#local-6989586621682582405"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582406"><a href="#local-6989586621682582406"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582407"><a href="#local-6989586621682582407"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582408"><a href="#local-6989586621682582408"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcDeepSplitSigmaTy_maybe</span><span> </span><a href="#local-6989586621682582404"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-148"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582409"><a href="#local-6989586621682582409"><span class="hs-identifier">arg_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621682582403"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582405"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-149"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582410"><a href="#local-6989586621682582410"><span class="hs-identifier">ids1</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newSysLocalIds"><span class="hs-identifier hs-var">newSysLocalIds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;dk&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582409"><span class="hs-identifier hs-var">arg_tys'</span></a><span>
</span><a name="line-150"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582411"><a href="#local-6989586621682582411"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582412"><a href="#local-6989586621682582412"><span class="hs-identifier">tvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstSkolTyVarsX"><span class="hs-identifier hs-var">tcInstSkolTyVarsX</span></a><span> </span><a href="#local-6989586621682582403"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582406"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-151"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582413"><a href="#local-6989586621682582413"><span class="hs-identifier">ev_vars1</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newEvVars"><span class="hs-identifier hs-var">newEvVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621682582411"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682582407"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582414"><a href="#local-6989586621682582414"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582415"><a href="#local-6989586621682582415"><span class="hs-identifier">tvs_prs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582416"><a href="#local-6989586621682582416"><span class="hs-identifier">ev_vars2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582417"><a href="#local-6989586621682582417"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582402"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682582411"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682582408"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-153"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582418"><a href="#local-6989586621682582418"><span class="hs-identifier">tv_prs1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">tyVarName</span><span> </span><a href="#local-6989586621682582406"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682582412"><span class="hs-identifier hs-var">tvs1</span></a><span>
</span><a name="line-154"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkWpLams</span><span> </span><a href="#local-6989586621682582410"><span class="hs-identifier hs-var">ids1</span></a><span>
</span><a name="line-155"></a><span>                      </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpTyLams</span><span> </span><a href="#local-6989586621682582412"><span class="hs-identifier hs-var">tvs1</span></a><span>
</span><a name="line-156"></a><span>                      </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpLams</span><span> </span><a href="#local-6989586621682582413"><span class="hs-identifier hs-var">ev_vars1</span></a><span>
</span><a name="line-157"></a><span>                      </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621682582414"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-158"></a><span>                      </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpEvVarApps</span><span> </span><a href="#local-6989586621682582410"><span class="hs-identifier hs-var">ids1</span></a><span>
</span><a name="line-159"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582418"><span class="hs-identifier hs-var">tv_prs1</span></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682582415"><span class="hs-identifier hs-var">tvs_prs2</span></a><span>
</span><a name="line-160"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582413"><span class="hs-identifier hs-var">ev_vars1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682582416"><span class="hs-identifier hs-var">ev_vars2</span></a><span>
</span><a name="line-161"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621682582409"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><a href="#local-6989586621682582417"><span class="hs-identifier hs-var">rho</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-164"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682582403"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582404"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>        </span><span class="hs-comment">-- substTy is a quick no-op on an empty substitution</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">-- | Instantiate all outer type variables</span><span>
</span><a name="line-168"></a><span class="hs-comment">-- and any context. Never looks through arrows.</span><span>
</span><a name="line-169"></a><span class="hs-identifier">topInstantiate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- if    topInstantiate ty = (wrap, rho)</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- and   e :: ty</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- then  wrap e :: rho  (that is, wrap :: ty &quot;-&gt;&quot; rho)</span><span>
</span><a name="line-173"></a><a name="topInstantiate"><a href="Inst.html#topInstantiate"><span class="hs-identifier">topInstantiate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#top_instantiate"><span class="hs-identifier hs-var">top_instantiate</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">-- | Instantiate all outer 'Inferred' binders</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- and any context. Never looks through arrows or specified type variables.</span><span>
</span><a name="line-177"></a><span class="hs-comment">-- Used for visible type application.</span><span>
</span><a name="line-178"></a><span class="hs-identifier">topInstantiateInferred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>
</span><a name="line-179"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- if    topInstantiate ty = (wrap, rho)</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- and   e :: ty</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- then  wrap e :: rho</span><span>
</span><a name="line-183"></a><a name="topInstantiateInferred"><a href="Inst.html#topInstantiateInferred"><span class="hs-identifier">topInstantiateInferred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#top_instantiate"><span class="hs-identifier hs-var">top_instantiate</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">top_instantiate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- True  &lt;=&gt; instantiate *all* variables</span><span>
</span><a name="line-186"></a><span>                          </span><span class="hs-comment">-- False &lt;=&gt; instantiate only the inferred ones</span><span>
</span><a name="line-187"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><a name="top_instantiate"><a href="Inst.html#top_instantiate"><span class="hs-identifier">top_instantiate</span></a></a><span> </span><a name="local-6989586621682582419"><a href="#local-6989586621682582419"><span class="hs-identifier">inst_all</span></a></a><span> </span><a name="local-6989586621682582420"><a href="#local-6989586621682582420"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582421"><a href="#local-6989586621682582421"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582422"><span class="hs-identifier hs-var">binders</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582424"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582428"><a href="#local-6989586621682582428"><span class="hs-identifier">inst_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582429"><a href="#local-6989586621682582429"><span class="hs-identifier">leave_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><a href="#local-6989586621682582426"><span class="hs-identifier hs-var">should_inst</span></a><span> </span><a href="#local-6989586621682582422"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-191"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682582430"><a href="#local-6989586621682582430"><span class="hs-identifier">inst_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582431"><a href="#local-6989586621682582431"><span class="hs-identifier">leave_theta</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582429"><span class="hs-identifier hs-var">leave_bndrs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582424"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582424"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>             </span><a name="local-6989586621682582432"><a href="#local-6989586621682582432"><span class="hs-identifier">in_scope</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621682582421"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>             </span><a name="local-6989586621682582433"><a href="#local-6989586621682582433"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><a href="#local-6989586621682582432"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-196"></a><span>             </span><a name="local-6989586621682582434"><a href="#local-6989586621682582434"><span class="hs-identifier">inst_tvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderVars</span><span> </span><a href="#local-6989586621682582428"><span class="hs-identifier hs-var">inst_bndrs</span></a><span>
</span><a name="line-197"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582435"><a href="#local-6989586621682582435"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582436"><a href="#local-6989586621682582436"><span class="hs-identifier">inst_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="TcMType.html#newMetaTyVarX"><span class="hs-identifier hs-var">newMetaTyVarX</span></a><span> </span><a href="#local-6989586621682582433"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621682582434"><span class="hs-identifier hs-var">inst_tvs</span></a><span>
</span><a name="line-198"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582437"><a href="#local-6989586621682582437"><span class="hs-identifier">inst_theta'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621682582435"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582430"><span class="hs-identifier hs-var">inst_theta</span></a><span>
</span><a name="line-199"></a><span>             </span><a name="local-6989586621682582438"><a href="#local-6989586621682582438"><span class="hs-identifier">sigma'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682582435"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkForAllTys</span><span> </span><a href="#local-6989586621682582429"><span class="hs-identifier hs-var">leave_bndrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-200"></a><span>                                          </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621682582431"><span class="hs-identifier hs-var">leave_theta</span></a><span> </span><a href="#local-6989586621682582425"><span class="hs-identifier hs-var">rho</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>             </span><a name="local-6989586621682582439"><a href="#local-6989586621682582439"><span class="hs-identifier">inst_tv_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621682582436"><span class="hs-identifier hs-var">inst_tvs'</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582440"><a href="#local-6989586621682582440"><span class="hs-identifier">wrap1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span> </span><a href="#local-6989586621682582420"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582439"><span class="hs-identifier hs-var">inst_tv_tys'</span></a><span> </span><a href="#local-6989586621682582437"><span class="hs-identifier hs-var">inst_theta'</span></a><span>
</span><a name="line-204"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Instantiating&quot;</span><span>
</span><a name="line-205"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;all tyvars?&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582419"><span class="hs-identifier hs-var">inst_all</span></a><span>
</span><a name="line-206"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;origin&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCtOrigin</span><span> </span><a href="#local-6989586621682582420"><span class="hs-identifier hs-var">orig</span></a><span>
</span><a name="line-207"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><a href="#local-6989586621682582421"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-208"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;theta&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582424"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-209"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;leave_bndrs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582429"><span class="hs-identifier hs-var">leave_bndrs</span></a><span>
</span><a name="line-210"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">debugPprType</span><span> </span><a href="#local-6989586621682582439"><span class="hs-identifier hs-var">inst_tv_tys'</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;theta:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>  </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582437"><span class="hs-identifier hs-var">inst_theta'</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582441"><a href="#local-6989586621682582441"><span class="hs-identifier">wrap2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582442"><a href="#local-6989586621682582442"><span class="hs-identifier">rho2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-214"></a><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582429"><span class="hs-identifier hs-var">leave_bndrs</span></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>         </span><span class="hs-comment">-- account for types like forall a. Num a =&gt; forall b. Ord b =&gt; ...</span><span>
</span><a name="line-217"></a><span>           </span><span class="hs-keyword">then</span><span> </span><a href="Inst.html#top_instantiate"><span class="hs-identifier hs-var">top_instantiate</span></a><span> </span><a href="#local-6989586621682582419"><span class="hs-identifier hs-var">inst_all</span></a><span> </span><a href="#local-6989586621682582420"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582438"><span class="hs-identifier hs-var">sigma'</span></a><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>         </span><span class="hs-comment">-- but don't loop if there were any un-inst'able tyvars</span><span>
</span><a name="line-220"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582438"><span class="hs-identifier hs-var">sigma'</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582441"><span class="hs-identifier hs-var">wrap2</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621682582440"><span class="hs-identifier hs-var">wrap1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582442"><span class="hs-identifier hs-var">rho2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582421"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682582422"><a href="#local-6989586621682582422"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582423"><a href="#local-6989586621682582423"><span class="hs-identifier">phi</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitForAllVarBndrs</span><span> </span><a href="#local-6989586621682582421"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-227"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682582424"><a href="#local-6989586621682582424"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582425"><a href="#local-6989586621682582425"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitPhiTy</span><span> </span><a href="#local-6989586621682582423"><span class="hs-identifier hs-var">phi</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span>    </span><a name="local-6989586621682582426"><a href="#local-6989586621682582426"><span class="hs-identifier">should_inst</span></a></a><span> </span><a name="local-6989586621682582427"><a href="#local-6989586621682582427"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-230"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582419"><span class="hs-identifier hs-var">inst_all</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-231"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderArgFlag</span><span> </span><a href="#local-6989586621682582427"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Inferred</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-identifier">deeplyInstantiate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span class="hs-comment">--   Int -&gt; forall a. a -&gt; a  ==&gt;  (\x:Int. [] x alpha) :: Int -&gt; alpha</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- In general if</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- if    deeplyInstantiate ty = (wrap, rho)</span><span>
</span><a name="line-237"></a><span class="hs-comment">-- and   e :: ty</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- then  wrap e :: rho</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- That is, wrap :: ty ~&gt; rho</span><span>
</span><a name="line-240"></a><span class="hs-comment">--</span><span>
</span><a name="line-241"></a><span class="hs-comment">-- If you don't need the HsWrapper returned from this function, consider</span><span>
</span><a name="line-242"></a><span class="hs-comment">-- using tcSplitNestedSigmaTys in TcType, which is a pure alternative that</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- only computes the returned TcRhoType.</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><a name="deeplyInstantiate"><a href="Inst.html#deeplyInstantiate"><span class="hs-identifier">deeplyInstantiate</span></a></a><span> </span><a name="local-6989586621682582443"><a href="#local-6989586621682582443"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582444"><a href="#local-6989586621682582444"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-246"></a><span>  </span><a href="Inst.html#deeply_instantiate"><span class="hs-identifier hs-var">deeply_instantiate</span></a><span> </span><a href="#local-6989586621682582443"><span class="hs-identifier hs-var">orig</span></a><span>
</span><a name="line-247"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621682582444"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>                     </span><a href="#local-6989586621682582444"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-identifier">deeply_instantiate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-251"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span>
</span><a name="line-252"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- Internal function to deeply instantiate that builds on an existing subst.</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- It extends the input substitution and applies the final subtitution to</span><span>
</span><a name="line-255"></a><span class="hs-comment">-- the types on return.  See #12549.</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><a name="deeply_instantiate"><a href="Inst.html#deeply_instantiate"><span class="hs-identifier">deeply_instantiate</span></a></a><span> </span><a name="local-6989586621682582445"><a href="#local-6989586621682582445"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582446"><a href="#local-6989586621682582446"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682582447"><a href="#local-6989586621682582447"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582448"><a href="#local-6989586621682582448"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582449"><a href="#local-6989586621682582449"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582450"><a href="#local-6989586621682582450"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582451"><a href="#local-6989586621682582451"><span class="hs-identifier">rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcDeepSplitSigmaTy_maybe</span><span> </span><a href="#local-6989586621682582447"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582452"><a href="#local-6989586621682582452"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582453"><a href="#local-6989586621682582453"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVarsX"><span class="hs-identifier hs-var">newMetaTyVarsX</span></a><span> </span><a href="#local-6989586621682582446"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582449"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-260"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582454"><a href="#local-6989586621682582454"><span class="hs-identifier">arg_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span>   </span><a href="#local-6989586621682582452"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682582448"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-261"></a><span>             </span><a name="local-6989586621682582455"><a href="#local-6989586621682582455"><span class="hs-identifier">theta'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621682582452"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682582450"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-262"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582456"><a href="#local-6989586621682582456"><span class="hs-identifier">ids1</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newSysLocalIds"><span class="hs-identifier hs-var">newSysLocalIds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;di&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582454"><span class="hs-identifier hs-var">arg_tys'</span></a><span>
</span><a name="line-263"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582457"><a href="#local-6989586621682582457"><span class="hs-identifier">wrap1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span> </span><a href="#local-6989586621682582445"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621682582453"><span class="hs-identifier hs-var">tvs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582455"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-264"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Instantiating (deeply)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;origin&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCtOrigin</span><span> </span><a href="#local-6989586621682582445"><span class="hs-identifier hs-var">orig</span></a><span>
</span><a name="line-265"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582447"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-266"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582453"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-267"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;args:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582456"><span class="hs-identifier hs-var">ids1</span></a><span>
</span><a name="line-268"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;theta:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>  </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582455"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-269"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;subst:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582452"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582458"><a href="#local-6989586621682582458"><span class="hs-identifier">wrap2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582459"><a href="#local-6989586621682582459"><span class="hs-identifier">rho2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#deeply_instantiate"><span class="hs-identifier hs-var">deeply_instantiate</span></a><span> </span><a href="#local-6989586621682582445"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582452"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682582451"><span class="hs-identifier hs-var">rho</span></a><span>
</span><a name="line-271"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpLams</span><span> </span><a href="#local-6989586621682582456"><span class="hs-identifier hs-var">ids1</span></a><span>
</span><a name="line-272"></a><span>                    </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621682582458"><span class="hs-identifier hs-var">wrap2</span></a><span>
</span><a name="line-273"></a><span>                    </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621682582457"><span class="hs-identifier hs-var">wrap1</span></a><span>
</span><a name="line-274"></a><span>                    </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpEvVarApps</span><span> </span><a href="#local-6989586621682582456"><span class="hs-identifier hs-var">ids1</span></a><span class="hs-special">,</span><span>
</span><a name="line-275"></a><span>                 </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621682582454"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><a href="#local-6989586621682582459"><span class="hs-identifier hs-var">rho2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-278"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582460"><a href="#local-6989586621682582460"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682582446"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582447"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-279"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;deeply_instantiate final subst&quot;</span><span>
</span><a name="line-280"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;origin:&quot;</span><span>   </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCtOrigin</span><span> </span><a href="#local-6989586621682582445"><span class="hs-identifier hs-var">orig</span></a><span>
</span><a name="line-281"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type:&quot;</span><span>     </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582447"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-282"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;new type:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582460"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-283"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;subst:&quot;</span><span>    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582446"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582460"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-identifier">instTyVarsWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- Use this when you want to instantiate (forall a b c. ty) with</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- types [ta, tb, tc], but when the kinds of 'a' and 'ta' might</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- not yet match (perhaps because there are unsolved constraints; Trac #14154)</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- If they don't match, emit a kind-equality to promise that they will</span><span>
</span><a name="line-292"></a><span class="hs-comment">-- eventually do so, and thus make a kind-homongeneous substitution.</span><span>
</span><a name="line-293"></a><a name="instTyVarsWith"><a href="Inst.html#instTyVarsWith"><span class="hs-identifier">instTyVarsWith</span></a></a><span> </span><a name="local-6989586621682582461"><a href="#local-6989586621682582461"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582462"><a href="#local-6989586621682582462"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682582463"><a href="#local-6989586621682582463"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582465"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682582464"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621682582462"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682582463"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-296"></a><span>    </span><a name="local-6989586621682582464"><a href="#local-6989586621682582464"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621682582463"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>    </span><a name="local-6989586621682582465"><a href="#local-6989586621682582465"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682582466"><a href="#local-6989586621682582466"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-299"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682582466"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-300"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682582467"><a href="#local-6989586621682582467"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582468"><a href="#local-6989586621682582468"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682582469"><a href="#local-6989586621682582469"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582470"><a href="#local-6989586621682582470"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682582471"><a href="#local-6989586621682582471"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582472"><span class="hs-identifier hs-var">tv_kind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682582473"><span class="hs-identifier hs-var">ty_kind</span></a><span>
</span><a name="line-302"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582465"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTCvSubst</span><span> </span><a href="#local-6989586621682582467"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582468"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682582470"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582469"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682582471"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-303"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-304"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582474"><a href="#local-6989586621682582474"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#emitWantedEq"><span class="hs-identifier hs-var">emitWantedEq</span></a><span> </span><a href="#local-6989586621682582461"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-identifier hs-var">KindLevel</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621682582473"><span class="hs-identifier hs-var">ty_kind</span></a><span> </span><a href="#local-6989586621682582472"><span class="hs-identifier hs-var">tv_kind</span></a><span>
</span><a name="line-305"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682582465"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTCvSubst</span><span> </span><a href="#local-6989586621682582467"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582468"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582470"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682582474"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582469"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682582471"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-306"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-307"></a><span>        </span><a name="local-6989586621682582472"><a href="#local-6989586621682582472"><span class="hs-identifier">tv_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682582467"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621682582468"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>        </span><a name="local-6989586621682582473"><a href="#local-6989586621682582473"><span class="hs-identifier">ty_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682582470"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;instTysWith&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582462"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582463"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
            Instantiating a call
*                                                                      *
************************************************************************

Note [Handling boxed equality]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The solver deals entirely in terms of unboxed (primitive) equality.
There should never be a boxed Wanted equality. Ever. But, what if
we are calling `foo :: forall a. (F a ~ Bool) =&gt; ...`? That equality
is boxed, so naive treatment here would emit a boxed Wanted equality.

So we simply check for this case and make the right boxing of evidence.

-}</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-331"></a><span class="hs-identifier">instCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span>
</span><a name="line-332"></a><span class="hs-comment">-- Instantiate the constraints of a call</span><span>
</span><a name="line-333"></a><span class="hs-comment">--      (instCall o tys theta)</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- (a) Makes fresh dictionaries as necessary for the constraints (theta)</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- (b) Throws these dictionaries into the LIE</span><span>
</span><a name="line-336"></a><span class="hs-comment">-- (c) Returns an HsWrapper ([.] tys dicts)</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><a name="instCall"><a href="Inst.html#instCall"><span class="hs-identifier">instCall</span></a></a><span> </span><a name="local-6989586621682582475"><a href="#local-6989586621682582475"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582476"><a href="#local-6989586621682582476"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682582477"><a href="#local-6989586621682582477"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582478"><a href="#local-6989586621682582478"><span class="hs-identifier">dict_app</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCallConstraints"><span class="hs-identifier hs-var">instCallConstraints</span></a><span> </span><a href="#local-6989586621682582475"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582477"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-340"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582478"><span class="hs-identifier hs-var">dict_app</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><a href="#local-6989586621682582476"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-343"></a><span class="hs-identifier">instCallConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- Instantiates the TcTheta, puts all constraints thereby generated</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- into the LIE, and returns a HsWrapper to enclose the call site.</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><a name="instCallConstraints"><a href="Inst.html#instCallConstraints"><span class="hs-identifier">instCallConstraints</span></a></a><span> </span><a name="local-6989586621682582479"><a href="#local-6989586621682582479"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582480"><a href="#local-6989586621682582480"><span class="hs-identifier">preds</span></a></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582480"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-351"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582491"><a href="#local-6989586621682582491"><span class="hs-identifier">evs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621682582481"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682582480"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-352"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;instCallConstraints&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582491"><span class="hs-identifier hs-var">evs</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpEvApps</span><span> </span><a href="#local-6989586621682582491"><span class="hs-identifier hs-var">evs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-355"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcPredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span>
</span><a name="line-356"></a><span>    </span><a name="local-6989586621682582481"><a href="#local-6989586621682582481"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682582482"><a href="#local-6989586621682582482"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-357"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582483"><a href="#local-6989586621682582483"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582484"><a href="#local-6989586621682582484"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEqPredTys_maybe</span><span> </span><a href="#local-6989586621682582482"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-comment">-- Try short-cut #1</span><span>
</span><a name="line-358"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582485"><a href="#local-6989586621682582485"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682582483"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682582484"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-359"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evCoercion</span><span> </span><a href="#local-6989586621682582485"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span>       </span><span class="hs-comment">-- Try short-cut #2</span><span>
</span><a name="line-362"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582486"><a href="#local-6989586621682582486"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582487"><a href="#local-6989586621682582487"><span class="hs-identifier">args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582488"><a href="#local-6989586621682582488"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582489"><a href="#local-6989586621682582489"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621682582482"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-363"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582486"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span>
</span><a name="line-364"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582490"><a href="#local-6989586621682582490"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682582488"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682582489"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-365"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evDFunApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId</span><span> </span><span class="hs-identifier hs-var">heqDataCon</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582487"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Coercion</span><span> </span><a href="#local-6989586621682582490"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-368"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#emitWanted"><span class="hs-identifier hs-var">emitWanted</span></a><span> </span><a href="#local-6989586621682582479"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582482"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-identifier">instDFunType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DFunInstType</span><span class="hs-special">]</span><span>
</span><a name="line-371"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- instantiated argument types</span><span>
</span><a name="line-372"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- instantiated constraint</span><span>
</span><a name="line-373"></a><span class="hs-comment">-- See Note [DFunInstType: instantiating types] in InstEnv</span><span>
</span><a name="line-374"></a><a name="instDFunType"><a href="Inst.html#instDFunType"><span class="hs-identifier">instDFunType</span></a></a><span> </span><a name="local-6989586621682582492"><a href="#local-6989586621682582492"><span class="hs-identifier">dfun_id</span></a></a><span> </span><a name="local-6989586621682582493"><a href="#local-6989586621682582493"><span class="hs-identifier">dfun_inst_tys</span></a></a><span>
</span><a name="line-375"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582515"><a href="#local-6989586621682582515"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582516"><a href="#local-6989586621682582516"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582498"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682582497"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621682582495"><span class="hs-identifier hs-var">dfun_tvs</span></a><span> </span><a href="#local-6989586621682582493"><span class="hs-identifier hs-var">dfun_inst_tys</span></a><span>
</span><a name="line-376"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582516"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621682582515"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582496"><span class="hs-identifier hs-var">dfun_theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-377"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621682582494"><a href="#local-6989586621682582494"><span class="hs-identifier">dfun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682582492"><span class="hs-identifier hs-var">dfun_id</span></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682582495"><a href="#local-6989586621682582495"><span class="hs-identifier">dfun_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582496"><a href="#local-6989586621682582496"><span class="hs-identifier">dfun_theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621682582494"><span class="hs-identifier hs-var">dfun_ty</span></a><span>
</span><a name="line-380"></a><span>    </span><a name="local-6989586621682582497"><a href="#local-6989586621682582497"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621682582494"><span class="hs-identifier hs-var">dfun_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>                  </span><span class="hs-comment">-- With quantified constraints, the</span><span>
</span><a name="line-382"></a><span>                  </span><span class="hs-comment">-- type of a dfun may not be closed</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DFunInstType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TCvSubst</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>    </span><a name="local-6989586621682582498"><a href="#local-6989586621682582498"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682582499"><a href="#local-6989586621682582499"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582499"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682582500"><a href="#local-6989586621682582500"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582501"><a href="#local-6989586621682582501"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682582502"><a href="#local-6989586621682582502"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682582503"><a href="#local-6989586621682582503"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682582504"><a href="#local-6989586621682582504"><span class="hs-identifier">mb_tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582505"><a href="#local-6989586621682582505"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582506"><a href="#local-6989586621682582506"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582498"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTvSubstAndInScope</span><span> </span><a href="#local-6989586621682582500"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582501"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682582503"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>                                 </span><a href="#local-6989586621682582502"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-389"></a><span>                                 </span><a href="#local-6989586621682582504"><span class="hs-identifier hs-var">mb_tys</span></a><span>
</span><a name="line-390"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582505"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582503"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682582506"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-391"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682582507"><a href="#local-6989586621682582507"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582508"><a href="#local-6989586621682582508"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682582509"><a href="#local-6989586621682582509"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682582510"><a href="#local-6989586621682582510"><span class="hs-identifier">mb_tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582511"><a href="#local-6989586621682582511"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582512"><a href="#local-6989586621682582512"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVarX"><span class="hs-identifier hs-var">newMetaTyVarX</span></a><span> </span><a href="#local-6989586621682582507"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582508"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-393"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582513"><a href="#local-6989586621682582513"><span class="hs-identifier">subst''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582514"><a href="#local-6989586621682582514"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582498"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682582511"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682582509"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682582510"><span class="hs-identifier hs-var">mb_tys</span></a><span>
</span><a name="line-394"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582513"><span class="hs-identifier hs-var">subst''</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682582512"><span class="hs-identifier hs-var">tv'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682582514"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;instDFunTypes&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582492"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582493"><span class="hs-identifier hs-var">dfun_inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-398"></a><span class="hs-identifier">instStupidTheta</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- Similar to instCall, but only emit the constraints in the LIE</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- Used exclusively for the 'stupid theta' of a data constructor</span><span>
</span><a name="line-401"></a><a name="instStupidTheta"><a href="Inst.html#instStupidTheta"><span class="hs-identifier">instStupidTheta</span></a></a><span> </span><a name="local-6989586621682582517"><a href="#local-6989586621682582517"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582518"><a href="#local-6989586621682582518"><span class="hs-identifier">theta</span></a></a><span>
</span><a name="line-402"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582519"><a href="#local-6989586621682582519"><span class="hs-identifier">_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCallConstraints"><span class="hs-identifier hs-var">instCallConstraints</span></a><span> </span><a href="#local-6989586621682582517"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582518"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-comment">-- Discard the coercion</span><span>
</span><a name="line-403"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
         Instantiating Kinds
*                                                                      *
************************************************************************

Note [Constraints handled in types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generally, we cannot handle constraints written in types. For example,
if we declare

  data C a where
    MkC :: Show a =&gt; a -&gt; C a

we will not be able to use MkC in types, as we have no way of creating
a type-level Show dictionary.

However, we make an exception for equality types. Consider

  data T1 a where
    MkT1 :: T1 Bool

  data T2 a where
    MkT2 :: a ~ Bool =&gt; T2 a

MkT1 has a constrained return type, while MkT2 uses an explicit equality
constraint. These two types are often written interchangeably, with a
reasonable expectation that they mean the same thing. For this to work --
and for us to be able to promote GADTs -- we need to be able to instantiate
equality constraints in types.

One wrinkle is that the equality in MkT2 is *lifted*. But, for proper
GADT equalities, GHC produces *unlifted* constraints. (This unlifting comes
from DataCon.eqSpecPreds, which uses mkPrimEqPred.) And, perhaps a wily
user will use (~~) for a heterogeneous equality. We thus must support
all of (~), (~~), and (~#) in types. (See Note [The equality types story]
in TysPrim for a primer on these equality types.)

The get_eq_tys_maybe function recognizes these three forms of equality,
returning a suitable type formation function and the two types related
by the equality constraint. In the lifted case, it uses mkHEqBoxTy or
mkEqBoxTy, which promote the datacons of the (~~) or (~) datatype,
respectively.

One might reasonably wonder who *unpacks* these boxes once they are
made. After all, there is no type-level `case` construct. The surprising
answer is that no one ever does. Instead, if a GADT constructor is used
on the left-hand side of a type family equation, that occurrence forces
GHC to unify the types in question. For example:

  data G a where
    MkG :: G Bool

  type family F (x :: G a) :: a where
    F MkG = False

When checking the LHS `F MkG`, GHC sees the MkG constructor and then must
unify F's implicit parameter `a` with Bool. This succeeds, making the equation

    F Bool (MkG @Bool &lt;Bool&gt;) = False

Note that we never need unpack the coercion. This is because type family
equations are *not* parametric in their kind variables. That is, we could have
just said

  type family H (x :: G a) :: a where
    H _ = False

The presence of False on the RHS also forces `a` to become Bool, giving us

    H Bool _ = False

The fact that any of this works stems from the lack of phase separation between
types and kinds (unlike the very present phase separation between terms and types).

Once we have the ability to pattern-match on types below top-level, this will
no longer cut it, but it seems fine for now.

-}</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- | Instantantiate the TyConBinders of a forall type,</span><span>
</span><a name="line-488"></a><span class="hs-comment">--   given its decomposed form (tvs, ty)</span><span>
</span><a name="line-489"></a><span class="hs-identifier">tcInstTyBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasDebugCallStack</span><span>
</span><a name="line-490"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCoBinder</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- ^ The type (forall bs. ty)</span><span>
</span><a name="line-491"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- ^ Instantiated bs, substituted ty</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- Takes a pair because that is what splitPiTysInvisible returns</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- See also Note [Bidirectional type checking]</span><span>
</span><a name="line-494"></a><a name="tcInstTyBinders"><a href="Inst.html#tcInstTyBinders"><span class="hs-identifier">tcInstTyBinders</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582520"><a href="#local-6989586621682582520"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582521"><a href="#local-6989586621682582521"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582520"><span class="hs-identifier hs-var">bndrs</span></a><span>        </span><span class="hs-comment">-- It's fine for bndrs to be empty e.g.</span><span>
</span><a name="line-496"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582521"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Check that (Maybe :: forall {k}. k-&gt;*),</span><span>
</span><a name="line-497"></a><span>                      </span><span class="hs-comment">--       and see the call to instTyBinders in checkExpectedKind</span><span>
</span><a name="line-498"></a><span>                      </span><span class="hs-comment">-- A user bug to be reported as such; it is not a compiler crash!</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-501"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582523"><a href="#local-6989586621682582523"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582524"><a href="#local-6989586621682582524"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><span class="hs-special">(</span><a href="Inst.html#tcInstTyBinder"><span class="hs-identifier hs-var">tcInstTyBinder</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582522"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621682582520"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-502"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582525"><a href="#local-6989586621682582525"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682582523"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582521"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>                   </span><span class="hs-comment">-- Why zonk the result? So that tcTyVar can</span><span>
</span><a name="line-504"></a><span>                   </span><span class="hs-comment">-- obey (IT6) of Note [The tcType invariant] in TcHsType</span><span>
</span><a name="line-505"></a><span>                   </span><span class="hs-comment">-- ToDo: SLPJ: I don't think this is needed</span><span>
</span><a name="line-506"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582524"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582525"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-507"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-508"></a><span>     </span><a name="local-6989586621682582522"><a href="#local-6989586621682582522"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621682582521"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-comment">-- | Used only in *types*</span><span>
</span><a name="line-511"></a><span class="hs-identifier">tcInstTyBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">VarEnv</span><span> </span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyBinder</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TCvSubst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><a name="tcInstTyBinder"><a href="Inst.html#tcInstTyBinder"><span class="hs-identifier">tcInstTyBinder</span></a></a><span> </span><a name="local-6989586621682582526"><a href="#local-6989586621682582526"><span class="hs-identifier">mb_kind_info</span></a></a><span> </span><a name="local-6989586621682582527"><a href="#local-6989586621682582527"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Named</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621682582528"><a href="#local-6989586621682582528"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-514"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682582529"><span class="hs-identifier hs-var">lookup_tv</span></a><span> </span><a href="#local-6989586621682582528"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-515"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682582532"><a href="#local-6989586621682582532"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTvSubstAndInScope</span><span> </span><a href="#local-6989586621682582527"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582528"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682582532"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582532"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582533"><a href="#local-6989586621682582533"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582534"><a href="#local-6989586621682582534"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVarX"><span class="hs-identifier hs-var">newMetaTyVarX</span></a><span> </span><a href="#local-6989586621682582527"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582528"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-517"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582533"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682582534"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621682582529"><a href="#local-6989586621682582529"><span class="hs-identifier">lookup_tv</span></a></a><span> </span><a name="local-6989586621682582530"><a href="#local-6989586621682582530"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582531"><a href="#local-6989586621682582531"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582526"><span class="hs-identifier hs-var">mb_kind_info</span></a><span>   </span><span class="hs-comment">-- `Maybe` monad</span><span>
</span><a name="line-520"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621682582531"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682582530"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">tcInstTyBinder</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682582535"><a href="#local-6989586621682582535"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Anon</span><span> </span><a name="local-6989586621682582536"><a href="#local-6989586621682582536"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>     </span><span class="hs-comment">-- This is the *only* constraint currently handled in types.</span><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582551"><a href="#local-6989586621682582551"><span class="hs-identifier">mk</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582552"><a href="#local-6989586621682582552"><span class="hs-identifier">k1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582553"><a href="#local-6989586621682582553"><span class="hs-identifier">k2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582538"><span class="hs-identifier hs-var">get_eq_tys_maybe</span></a><span> </span><a href="#local-6989586621682582537"><span class="hs-identifier hs-var">substed_ty</span></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582554"><a href="#local-6989586621682582554"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyKind"><span class="hs-identifier hs-var">unifyKind</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682582552"><span class="hs-identifier hs-var">k1</span></a><span> </span><a href="#local-6989586621682582553"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-527"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582555"><a href="#local-6989586621682582555"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682582551"><span class="hs-identifier hs-var">mk</span></a><span> </span><a href="#local-6989586621682582554"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-528"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582535"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582555"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPredTy</span><span> </span><a href="#local-6989586621682582537"><span class="hs-identifier hs-var">substed_ty</span></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582556"><a href="#local-6989586621682582556"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582557"><a href="#local-6989586621682582557"><span class="hs-identifier">tidy_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyOpenType</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><a href="#local-6989586621682582537"><span class="hs-identifier hs-var">substed_ty</span></a><span>
</span><a name="line-532"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addErrTcM"><span class="hs-identifier hs-var">addErrTcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582556"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal constraint in a kind:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582557"><span class="hs-identifier hs-var">tidy_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>         </span><span class="hs-comment">-- just invent a new variable so that we can continue</span><span>
</span><a name="line-535"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582558"><a href="#local-6989586621682582558"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-536"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582559"><a href="#local-6989586621682582559"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSysTvName</span><span> </span><a href="#local-6989586621682582558"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;dict&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582535"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkTyVar</span><span> </span><a href="#local-6989586621682582559"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621682582537"><span class="hs-identifier hs-var">substed_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582560"><a href="#local-6989586621682582560"><span class="hs-identifier">tv_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-6989586621682582537"><span class="hs-identifier hs-var">substed_ty</span></a><span>
</span><a name="line-542"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582535"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582560"><span class="hs-identifier hs-var">tv_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-545"></a><span>    </span><a name="local-6989586621682582537"><a href="#local-6989586621682582537"><span class="hs-identifier">substed_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682582535"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582536"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span>      </span><span class="hs-comment">-- See Note [Constraints handled in types]</span><span>
</span><a name="line-548"></a><span>    </span><span class="hs-identifier">get_eq_tys_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-549"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-550"></a><span>                                 </span><span class="hs-comment">-- given a coercion proving t1 ~# t2, produce the</span><span>
</span><a name="line-551"></a><span>                                 </span><span class="hs-comment">-- right instantiation for the TyBinder at hand</span><span>
</span><a name="line-552"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span>  </span><span class="hs-comment">-- t1</span><span>
</span><a name="line-553"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span>  </span><span class="hs-comment">-- t2</span><span>
</span><a name="line-554"></a><span>                              </span><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>    </span><a name="local-6989586621682582538"><a href="#local-6989586621682582538"><span class="hs-identifier">get_eq_tys_maybe</span></a></a><span> </span><a name="local-6989586621682582539"><a href="#local-6989586621682582539"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-556"></a><span>        </span><span class="hs-comment">-- unlifted equality (~#)</span><span>
</span><a name="line-557"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582540"><a href="#local-6989586621682582540"><span class="hs-identifier">k1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582541"><a href="#local-6989586621682582541"><span class="hs-identifier">k2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEqPredTys_maybe</span><span> </span><a href="#local-6989586621682582539"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-558"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682582542"><a href="#local-6989586621682582542"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkCoercionTy</span><span> </span><a href="#local-6989586621682582542"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582540"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582541"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span>        </span><span class="hs-comment">-- lifted heterogeneous equality (~~)</span><span>
</span><a name="line-561"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582543"><a href="#local-6989586621682582543"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582544"><a href="#local-6989586621682582544"><span class="hs-identifier">k1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582545"><a href="#local-6989586621682582545"><span class="hs-identifier">k2</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621682582539"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-562"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582543"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span>
</span><a name="line-563"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682582546"><a href="#local-6989586621682582546"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Inst.html#mkHEqBoxTy"><span class="hs-identifier hs-var">mkHEqBoxTy</span></a><span> </span><a href="#local-6989586621682582546"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682582544"><span class="hs-identifier hs-var">k1</span></a><span> </span><a href="#local-6989586621682582545"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582544"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582545"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-565"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span>        </span><span class="hs-comment">-- lifted homogeneous equality (~)</span><span>
</span><a name="line-568"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582547"><a href="#local-6989586621682582547"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582548"><a href="#local-6989586621682582548"><span class="hs-identifier">k1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582549"><a href="#local-6989586621682582549"><span class="hs-identifier">k2</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621682582539"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-569"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582547"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span>
</span><a name="line-570"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682582550"><a href="#local-6989586621682582550"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Inst.html#mkEqBoxTy"><span class="hs-identifier hs-var">mkEqBoxTy</span></a><span> </span><a href="#local-6989586621682582550"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682582548"><span class="hs-identifier hs-var">k1</span></a><span> </span><a href="#local-6989586621682582549"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582548"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582549"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-572"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-575"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- | This takes @a ~# b@ and returns @a ~~ b@.</span><span>
</span><a name="line-579"></a><span class="hs-identifier">mkHEqBoxTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- monadic just for convenience with mkEqBoxTy</span><span>
</span><a name="line-581"></a><a name="mkHEqBoxTy"><a href="Inst.html#mkHEqBoxTy"><span class="hs-identifier">mkHEqBoxTy</span></a></a><span> </span><a name="local-6989586621682582561"><a href="#local-6989586621682582561"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682582562"><a href="#local-6989586621682582562"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682582563"><a href="#local-6989586621682582563"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-582"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-583"></a><span>    </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><span class="hs-identifier hs-var">heqDataCon</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682582564"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582565"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582562"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582563"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkCoercionTy</span><span> </span><a href="#local-6989586621682582561"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">]</span><span>
</span><a name="line-584"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682582564"><a href="#local-6989586621682582564"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682582562"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-585"></a><span>        </span><a name="local-6989586621682582565"><a href="#local-6989586621682582565"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682582563"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-comment">-- | This takes @a ~# b@ and returns @a ~ b@.</span><span>
</span><a name="line-588"></a><span class="hs-identifier">mkEqBoxTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-589"></a><a name="mkEqBoxTy"><a href="Inst.html#mkEqBoxTy"><span class="hs-identifier">mkEqBoxTy</span></a></a><span> </span><a name="local-6989586621682582566"><a href="#local-6989586621682582566"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682582567"><a href="#local-6989586621682582567"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682582568"><a href="#local-6989586621682582568"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-590"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-591"></a><span>    </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><span class="hs-identifier hs-var">eqDataCon</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682582569"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582567"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582568"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkCoercionTy</span><span> </span><a href="#local-6989586621682582566"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682582569"><a href="#local-6989586621682582569"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682582567"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Literals
*                                                                      *
************************************************************************

-}</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-comment">{-
In newOverloadedLit we convert directly to an Int or Integer if we
know that's what we want.  This may save some time, by not
temporarily generating overloaded literals, but it won't catch all
cases (the rest are caught in lookupInst).

-}</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-identifier">newOverloadedLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsOverLit</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-612"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-613"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsOverLit</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><a name="newOverloadedLit"><a href="Inst.html#newOverloadedLit"><span class="hs-identifier">newOverloadedLit</span></a></a><span>
</span><a name="line-615"></a><span>  </span><a name="local-6989586621682582570"><a href="#local-6989586621682582570"><span class="hs-identifier">lit</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">OverLit</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_val</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682582571"><a href="#local-6989586621682582571"><span class="hs-identifier">val</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ol_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682582572"><a href="#local-6989586621682582572"><span class="hs-identifier">rebindable</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682582573"><a href="#local-6989586621682582573"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-616"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682582572"><span class="hs-identifier hs-var">rebindable</span></a><span>
</span><a name="line-617"></a><span>    </span><span class="hs-comment">-- all built-in overloaded lits are tau-types, so we can just</span><span>
</span><a name="line-618"></a><span>    </span><span class="hs-comment">-- tauify the ExpType</span><span>
</span><a name="line-619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582575"><a href="#local-6989586621682582575"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621682582573"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-620"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582576"><a href="#local-6989586621682582576"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-621"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcHsSyn.html#shortCutLit"><span class="hs-identifier hs-var">shortCutLit</span></a><span> </span><a href="#local-6989586621682582576"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682582571"><span class="hs-identifier hs-var">val</span></a><span> </span><a href="#local-6989586621682582575"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-622"></a><span>        </span><span class="hs-comment">-- Do not generate a LitInst for rebindable syntax.</span><span>
</span><a name="line-623"></a><span>        </span><span class="hs-comment">-- Reason: If we do, tcSimplify will call lookupInst, which</span><span>
</span><a name="line-624"></a><span>        </span><span class="hs-comment">--         will call tcSyntaxName, which does unification,</span><span>
</span><a name="line-625"></a><span>        </span><span class="hs-comment">--         which tcSimplify doesn't like</span><span>
</span><a name="line-626"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682582577"><a href="#local-6989586621682582577"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582570"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_witness</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582577"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-627"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ol_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OverLitTc</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682582575"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Inst.html#newNonTrivialOverloadedLit"><span class="hs-identifier hs-var">newNonTrivialOverloadedLit</span></a><span> </span><a href="#local-6989586621682582574"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582570"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-629"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621682582575"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-632"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#newNonTrivialOverloadedLit"><span class="hs-identifier hs-var">newNonTrivialOverloadedLit</span></a><span> </span><a href="#local-6989586621682582574"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582570"><span class="hs-identifier hs-var">lit</span></a><span> </span><a href="#local-6989586621682582573"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-633"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-634"></a><span>    </span><a name="local-6989586621682582574"><a href="#local-6989586621682582574"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LiteralOrigin</span><span> </span><a href="#local-6989586621682582570"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-635"></a><span class="hs-identifier">newOverloadedLit</span><span> </span><span class="hs-identifier hs-var">XOverLit</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;newOverloadedLit&quot;</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-comment">-- Does not handle things that 'shortCutLit' can handle. See also</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- newOverloadedLit in TcUnify</span><span>
</span><a name="line-639"></a><span class="hs-identifier">newNonTrivialOverloadedLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-640"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsOverLit</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-641"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-642"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsOverLit</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-643"></a><a name="newNonTrivialOverloadedLit"><a href="Inst.html#newNonTrivialOverloadedLit"><span class="hs-identifier">newNonTrivialOverloadedLit</span></a></a><span> </span><a name="local-6989586621682582578"><a href="#local-6989586621682582578"><span class="hs-identifier">orig</span></a></a><span>
</span><a name="line-644"></a><span>  </span><a name="local-6989586621682582579"><a href="#local-6989586621682582579"><span class="hs-identifier">lit</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">OverLit</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_val</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682582580"><a href="#local-6989586621682582580"><span class="hs-identifier">val</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ol_witness</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682582581"><a href="#local-6989586621682582581"><span class="hs-identifier">meth_name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ol_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682582582"><a href="#local-6989586621682582582"><span class="hs-identifier">rebindable</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682582583"><a href="#local-6989586621682582583"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-646"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582584"><a href="#local-6989586621682582584"><span class="hs-identifier">hs_lit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#mkOverLit"><span class="hs-identifier hs-var">mkOverLit</span></a><span> </span><a href="#local-6989586621682582580"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-647"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582585"><a href="#local-6989586621682582585"><span class="hs-identifier">lit_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsLitType"><span class="hs-identifier hs-var">hsLitType</span></a><span> </span><a href="#local-6989586621682582584"><span class="hs-identifier hs-var">hs_lit</span></a><span>
</span><a name="line-648"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582586"><a href="#local-6989586621682582586"><span class="hs-identifier">fi'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><a href="#local-6989586621682582578"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><a href="#local-6989586621682582581"><span class="hs-identifier hs-var">meth_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621682582585"><span class="hs-identifier hs-var">lit_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682582583"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-650"></a><span>                      </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682582587"><a href="#local-6989586621682582587"><span class="hs-identifier">witness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsSyntaxApps</span><span> </span><a href="#local-6989586621682582586"><span class="hs-identifier hs-var">fi'</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><a href="#local-6989586621682582584"><span class="hs-identifier hs-var">hs_lit</span></a><span class="hs-special">]</span><span>
</span><a name="line-652"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582588"><a href="#local-6989586621682582588"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621682582583"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-653"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582579"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_witness</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582587"><span class="hs-identifier hs-var">witness</span></a><span>
</span><a name="line-654"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ol_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OverLitTc</span><span> </span><a href="#local-6989586621682582582"><span class="hs-identifier hs-var">rebindable</span></a><span> </span><a href="#local-6989586621682582588"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-655"></a><span class="hs-identifier">newNonTrivialOverloadedLit</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682582589"><a href="#local-6989586621682582589"><span class="hs-identifier">lit</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-656"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;newNonTrivialOverloadedLit&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582589"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-comment">------------</span><span>
</span><a name="line-659"></a><span class="hs-identifier">mkOverLit</span><span> </span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">OverLitVal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsLit</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-660"></a><a name="mkOverLit"><a href="Inst.html#mkOverLit"><span class="hs-identifier">mkOverLit</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIntegral</span><span> </span><a name="local-6989586621682582590"><a href="#local-6989586621682582590"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582591"><a href="#local-6989586621682582591"><span class="hs-identifier">integer_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><span class="hs-identifier hs-var">integerTyConName</span><span>
</span><a name="line-662"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsInteger</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">il_text</span><span> </span><a href="#local-6989586621682582590"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier">il_value</span><span> </span><a href="#local-6989586621682582590"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582591"><span class="hs-identifier hs-var">integer_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span class="hs-identifier">mkOverLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsFractional</span><span> </span><a name="local-6989586621682582592"><a href="#local-6989586621682582592"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582593"><a href="#local-6989586621682582593"><span class="hs-identifier">rat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><span class="hs-identifier hs-var">rationalTyConName</span><span>
</span><a name="line-667"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682582592"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682582593"><span class="hs-identifier hs-var">rat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span class="hs-identifier">mkOverLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIsString</span><span> </span><a name="local-6989586621682582594"><a href="#local-6989586621682582594"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621682582595"><a href="#local-6989586621682582595"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsString</span><span> </span><a href="#local-6989586621682582594"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621682582595"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Re-mappable syntax

     Used only for arrow syntax -- find a way to nuke this
*                                                                      *
************************************************************************

Suppose we are doing the -XRebindableSyntax thing, and we encounter
a do-expression.  We have to find (&gt;&gt;) in the current environment, which is
done by the rename. Then we have to check that it has the same type as
Control.Monad.(&gt;&gt;).  Or, more precisely, a compatible type. One 'customer' had
this:

  (&gt;&gt;) :: HB m n mn =&gt; m a -&gt; n b -&gt; mn b

So the idea is to generate a local binding for (&gt;&gt;), thus:

        let then72 :: forall a b. m a -&gt; m b -&gt; m b
            then72 = ...something involving the user's (&gt;&gt;)...
        in
        ...the do-expression...

Now the do-expression can proceed using then72, which has exactly
the expected type.

In fact tcSyntaxName just generates the RHS for then72, because we only
want an actual binding in the do-expression case. For literals, we can
just use the expression inline.
-}</span><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span class="hs-identifier">tcSyntaxName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-704"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>                 </span><span class="hs-comment">-- ^ Type to instantiate it at</span><span>
</span><a name="line-705"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- ^ (Standard name, user name)</span><span>
</span><a name="line-706"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>                                       </span><span class="hs-comment">-- ^ (Standard name, suitable expression)</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- USED ONLY FOR CmdTop (sigh) ***</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- See Note [CmdSyntaxTable] in HsExpr</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><a name="tcSyntaxName"><a href="Inst.html#tcSyntaxName"><span class="hs-identifier">tcSyntaxName</span></a></a><span> </span><a name="local-6989586621682582596"><a href="#local-6989586621682582596"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582597"><a href="#local-6989586621682582597"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582598"><a href="#local-6989586621682582598"><span class="hs-identifier">std_nm</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682582599"><a href="#local-6989586621682582599"><span class="hs-identifier">user_nm</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582598"><span class="hs-identifier hs-var">std_nm</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682582599"><span class="hs-identifier hs-var">user_nm</span></a><span>
</span><a name="line-713"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682582600"><a href="#local-6989586621682582600"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newMethodFromName"><span class="hs-identifier hs-var">newMethodFromName</span></a><span> </span><a href="#local-6989586621682582596"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582598"><span class="hs-identifier hs-var">std_nm</span></a><span> </span><a href="#local-6989586621682582597"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-714"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582598"><span class="hs-identifier hs-var">std_nm</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582600"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>
</span><a name="line-716"></a><span class="hs-identifier">tcSyntaxName</span><span> </span><a name="local-6989586621682582601"><a href="#local-6989586621682582601"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582602"><a href="#local-6989586621682582602"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582603"><a href="#local-6989586621682582603"><span class="hs-identifier">std_nm</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582604"><a href="#local-6989586621682582604"><span class="hs-identifier">user_nm_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-717"></a><span>    </span><a name="local-6989586621682582605"><a href="#local-6989586621682582605"><span class="hs-identifier">std_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621682582603"><span class="hs-identifier hs-var">std_nm</span></a><span>
</span><a name="line-718"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-719"></a><span>        </span><span class="hs-comment">-- C.f. newMethodAtLoc</span><span>
</span><a name="line-720"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621682582606"><a href="#local-6989586621682582606"><span class="hs-identifier">tv</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682582607"><a href="#local-6989586621682582607"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682582605"><span class="hs-identifier hs-var">std_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>        </span><a name="local-6989586621682582608"><a href="#local-6989586621682582608"><span class="hs-identifier">sigma1</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTyWith</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682582606"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682582602"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682582607"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-722"></a><span>        </span><span class="hs-comment">-- Actually, the &quot;tau-type&quot; might be a sigma-type in the</span><span>
</span><a name="line-723"></a><span>        </span><span class="hs-comment">-- case of locally-polymorphic methods.</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>    </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="Inst.html#syntaxNameCtxt"><span class="hs-identifier hs-var">syntaxNameCtxt</span></a><span> </span><a href="#local-6989586621682582604"><span class="hs-identifier hs-var">user_nm_expr</span></a><span> </span><a href="#local-6989586621682582601"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621682582608"><span class="hs-identifier hs-var">sigma1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span>        </span><span class="hs-comment">-- Check that the user-supplied thing has the</span><span>
</span><a name="line-728"></a><span>        </span><span class="hs-comment">-- same type as the standard one.</span><span>
</span><a name="line-729"></a><span>        </span><span class="hs-comment">-- Tiresome jiggling because tcCheckSigma takes a located expression</span><span>
</span><a name="line-730"></a><span>     </span><a name="local-6989586621682582609"><a href="#local-6989586621682582609"><span class="hs-identifier">span</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-731"></a><span>     </span><a name="local-6989586621682582610"><a href="#local-6989586621682582610"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621682582609"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621682582604"><span class="hs-identifier hs-var">user_nm_expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682582608"><span class="hs-identifier hs-var">sigma1</span></a><span>
</span><a name="line-732"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582603"><span class="hs-identifier hs-var">std_nm</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682582610"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span class="hs-identifier">syntaxNameCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span>
</span><a name="line-735"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-736"></a><a name="syntaxNameCtxt"><a href="Inst.html#syntaxNameCtxt"><span class="hs-identifier">syntaxNameCtxt</span></a></a><span> </span><a name="local-6989586621682582611"><a href="#local-6989586621682582611"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682582612"><a href="#local-6989586621682582612"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621682582613"><a href="#local-6989586621682582613"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682582614"><a href="#local-6989586621682582614"><span class="hs-identifier">tidy_env</span></a></a><span>
</span><a name="line-737"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582615"><a href="#local-6989586621682582615"><span class="hs-identifier">inst_loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a><span> </span><a href="#local-6989586621682582612"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">TypeLevel</span><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582616"><a href="#local-6989586621682582616"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking that&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582611"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-739"></a><span>                          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(needed by a syntactic construct)&quot;</span><span>
</span><a name="line-740"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has the required type:&quot;</span><span>
</span><a name="line-741"></a><span>                                  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyType</span><span> </span><a href="#local-6989586621682582614"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621682582613"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-742"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCtLoc</span><span> </span><a href="#local-6989586621682582615"><span class="hs-identifier hs-var">inst_loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-743"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682582614"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582616"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Instances
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span class="hs-identifier">getOverlapFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OverlapMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">OverlapFlag</span><span>
</span><a name="line-754"></a><span class="hs-comment">-- Construct the OverlapFlag from the global module flags,</span><span>
</span><a name="line-755"></a><span class="hs-comment">-- but if the overlap_mode argument is (Just m),</span><span>
</span><a name="line-756"></a><span class="hs-comment">--     set the OverlapMode to 'm'</span><span>
</span><a name="line-757"></a><a name="getOverlapFlag"><a href="Inst.html#getOverlapFlag"><span class="hs-identifier">getOverlapFlag</span></a></a><span> </span><a name="local-6989586621682582617"><a href="#local-6989586621682582617"><span class="hs-identifier">overlap_mode</span></a></a><span>
</span><a name="line-758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682582618"><a href="#local-6989586621682582618"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582619"><a href="#local-6989586621682582619"><span class="hs-identifier">overlap_ok</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.OverlappingInstances</span><span> </span><a href="#local-6989586621682582618"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-760"></a><span>              </span><a name="local-6989586621682582620"><a href="#local-6989586621682582620"><span class="hs-identifier">incoherent_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.IncoherentInstances</span><span>  </span><a href="#local-6989586621682582618"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-761"></a><span>              </span><a name="local-6989586621682582621"><a href="#local-6989586621682582621"><span class="hs-identifier">use</span></a></a><span> </span><a name="local-6989586621682582624"><a href="#local-6989586621682582624"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OverlapFlag</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">isSafeOverlap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">safeLanguageOn</span><span> </span><a href="#local-6989586621682582618"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-762"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">overlapMode</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582624"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-763"></a><span>              </span><a name="local-6989586621682582622"><a href="#local-6989586621682582622"><span class="hs-identifier">default_oflag</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582620"><span class="hs-identifier hs-var">incoherent_ok</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582621"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Incoherent</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582619"><span class="hs-identifier hs-var">overlap_ok</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582621"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Overlaps</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582621"><span class="hs-identifier hs-var">use</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NoOverlap</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span>              </span><a name="local-6989586621682582623"><a href="#local-6989586621682582623"><span class="hs-identifier">final_oflag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setOverlapModeMaybe</span><span> </span><a href="#local-6989586621682582622"><span class="hs-identifier hs-var">default_oflag</span></a><span> </span><a href="#local-6989586621682582617"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-768"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682582623"><span class="hs-identifier hs-var">final_oflag</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span class="hs-identifier">tcGetInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span>
</span><a name="line-771"></a><span class="hs-comment">-- Gets the local class instances.</span><span>
</span><a name="line-772"></a><a name="tcGetInsts"><a href="Inst.html#tcGetInsts"><span class="hs-identifier">tcGetInsts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_insts</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-identifier">newClsInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OverlapMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span>
</span><a name="line-775"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span>
</span><a name="line-776"></a><a name="newClsInst"><a href="Inst.html#newClsInst"><span class="hs-identifier">newClsInst</span></a></a><span> </span><a name="local-6989586621682582625"><a href="#local-6989586621682582625"><span class="hs-identifier">overlap_mode</span></a></a><span> </span><a name="local-6989586621682582626"><a href="#local-6989586621682582626"><span class="hs-identifier">dfun_name</span></a></a><span> </span><a name="local-6989586621682582627"><a href="#local-6989586621682582627"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682582628"><a href="#local-6989586621682582628"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682582629"><a href="#local-6989586621682582629"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682582630"><a href="#local-6989586621682582630"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-777"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582631"><a href="#local-6989586621682582631"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582632"><a href="#local-6989586621682582632"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#freshenTyVarBndrs"><span class="hs-identifier hs-var">freshenTyVarBndrs</span></a><span> </span><a href="#local-6989586621682582627"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-778"></a><span>             </span><span class="hs-comment">-- Be sure to freshen those type variables,</span><span>
</span><a name="line-779"></a><span>             </span><span class="hs-comment">-- so they are sure not to appear in any lookup</span><span>
</span><a name="line-780"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582633"><a href="#local-6989586621682582633"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621682582631"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682582630"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-781"></a><span>
</span><a name="line-782"></a><span>             </span><a name="local-6989586621682582634"><a href="#local-6989586621682582634"><span class="hs-identifier">dfun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkDictFunId</span><span> </span><a href="#local-6989586621682582626"><span class="hs-identifier hs-var">dfun_name</span></a><span> </span><a href="#local-6989586621682582627"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682582628"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682582629"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682582630"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-783"></a><span>             </span><span class="hs-comment">-- The dfun uses the original 'tvs' because</span><span>
</span><a name="line-784"></a><span>             </span><span class="hs-comment">-- (a) they don't need to be fresh</span><span>
</span><a name="line-785"></a><span>             </span><span class="hs-comment">-- (b) they may be mentioned in the ib_binds field of</span><span>
</span><a name="line-786"></a><span>             </span><span class="hs-comment">--     an InstInfo, and in TcEnv.pprInstInfoDetails it's</span><span>
</span><a name="line-787"></a><span>             </span><span class="hs-comment">--     helpful to use the same names</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582635"><a href="#local-6989586621682582635"><span class="hs-identifier">oflag</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#getOverlapFlag"><span class="hs-identifier hs-var">getOverlapFlag</span></a><span> </span><a href="#local-6989586621682582625"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-790"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582636"><a href="#local-6989586621682582636"><span class="hs-identifier">inst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalInstance</span><span> </span><a href="#local-6989586621682582634"><span class="hs-identifier hs-var">dfun</span></a><span> </span><a href="#local-6989586621682582635"><span class="hs-identifier hs-var">oflag</span></a><span> </span><a href="#local-6989586621682582632"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621682582629"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682582633"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-791"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#warnIfFlag"><span class="hs-identifier hs-var">warnIfFlag</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnOrphans</span><span>
</span><a name="line-792"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isOrphan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_orphan</span><span> </span><a href="#local-6989586621682582636"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-793"></a><span>                    </span><span class="hs-special">(</span><a href="Inst.html#instOrphWarn"><span class="hs-identifier hs-var">instOrphWarn</span></a><span> </span><a href="#local-6989586621682582636"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-794"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682582636"><span class="hs-identifier hs-var">inst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span class="hs-identifier">instOrphWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-797"></a><a name="instOrphWarn"><a href="Inst.html#instOrphWarn"><span class="hs-identifier">instOrphWarn</span></a></a><span> </span><a name="local-6989586621682582637"><a href="#local-6989586621682582637"><span class="hs-identifier">inst</span></a></a><span>
</span><a name="line-798"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Orphan instance:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprInstanceHdr</span><span> </span><a href="#local-6989586621682582637"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-799"></a><span>    </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;To avoid this&quot;</span><span>
</span><a name="line-800"></a><span>    </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><a href="#local-6989586621682582638"><span class="hs-identifier hs-var">possibilities</span></a><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-802"></a><span>    </span><a name="local-6989586621682582638"><a href="#local-6989586621682582638"><span class="hs-identifier">possibilities</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-803"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;move the instance declaration to the module of the class or of the type, or&quot;</span><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-804"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;wrap the type with a newtype and declare the instance on the new type.&quot;</span><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-805"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span class="hs-identifier">tcExtendLocalInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682582391"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682582391"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-808"></a><span>  </span><span class="hs-comment">-- Add new locally-defined instances</span><span>
</span><a name="line-809"></a><a name="tcExtendLocalInstEnv"><a href="Inst.html#tcExtendLocalInstEnv"><span class="hs-identifier">tcExtendLocalInstEnv</span></a></a><span> </span><a name="local-6989586621682582639"><a href="#local-6989586621682582639"><span class="hs-identifier">dfuns</span></a></a><span> </span><a name="local-6989586621682582640"><a href="#local-6989586621682582640"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-810"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Inst.html#traceDFuns"><span class="hs-identifier hs-var">traceDFuns</span></a><span> </span><a href="#local-6989586621682582639"><span class="hs-identifier hs-var">dfuns</span></a><span>
</span><a name="line-811"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582641"><a href="#local-6989586621682582641"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-812"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582642"><a href="#local-6989586621682582642"><span class="hs-identifier">inst_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582643"><a href="#local-6989586621682582643"><span class="hs-identifier">cls_insts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="Inst.html#addLocalInst"><span class="hs-identifier hs-var">addLocalInst</span></a><span>
</span><a name="line-813"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier">tcg_inst_env</span><span> </span><a href="#local-6989586621682582641"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_insts</span><span> </span><a href="#local-6989586621682582641"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span>                                          </span><a href="#local-6989586621682582639"><span class="hs-identifier hs-var">dfuns</span></a><span>
</span><a name="line-815"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582644"><a href="#local-6989586621682582644"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582641"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582643"><span class="hs-identifier hs-var">cls_insts'</span></a><span>
</span><a name="line-816"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582642"><span class="hs-identifier hs-var">inst_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-817"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621682582644"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682582640"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">addLocalInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">InstEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">InstEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span class="hs-comment">-- Check that the proposed new instance is OK,</span><span>
</span><a name="line-821"></a><span class="hs-comment">-- and then add it to the home inst env</span><span>
</span><a name="line-822"></a><span class="hs-comment">-- If overwrite_inst, then we can overwrite a direct match</span><span>
</span><a name="line-823"></a><a name="addLocalInst"><a href="Inst.html#addLocalInst"><span class="hs-identifier">addLocalInst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682582645"><a href="#local-6989586621682582645"><span class="hs-identifier">home_ie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582646"><a href="#local-6989586621682582646"><span class="hs-identifier">my_insts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682582647"><a href="#local-6989586621682582647"><span class="hs-identifier">ispec</span></a></a><span>
</span><a name="line-824"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-825"></a><span>             </span><span class="hs-comment">-- Load imported instances, so that we report</span><span>
</span><a name="line-826"></a><span>             </span><span class="hs-comment">-- duplicates correctly</span><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span>             </span><span class="hs-comment">-- 'matches'  are existing instance declarations that are less</span><span>
</span><a name="line-829"></a><span>             </span><span class="hs-comment">--            specific than the new one</span><span>
</span><a name="line-830"></a><span>             </span><span class="hs-comment">-- 'dups'     are those 'matches' that are equal to the new one</span><span>
</span><a name="line-831"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582648"><a href="#local-6989586621682582648"><span class="hs-identifier">isGHCi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getIsGHCi"><span class="hs-identifier hs-var">getIsGHCi</span></a><span>
</span><a name="line-832"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582649"><a href="#local-6989586621682582649"><span class="hs-identifier">eps</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-833"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682582650"><a href="#local-6989586621682582650"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span>           </span><span class="hs-comment">-- In GHCi, we *override* any identical instances</span><span>
</span><a name="line-836"></a><span>           </span><span class="hs-comment">-- that are also defined in the interactive context</span><span>
</span><a name="line-837"></a><span>           </span><span class="hs-comment">-- See Note [Override identical instances in GHCi]</span><span>
</span><a name="line-838"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582651"><a href="#local-6989586621682582651"><span class="hs-identifier">home_ie'</span></a></a><span>
</span><a name="line-839"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682582648"><span class="hs-identifier hs-var">isGHCi</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">deleteFromInstEnv</span><span> </span><a href="#local-6989586621682582645"><span class="hs-identifier hs-var">home_ie</span></a><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-840"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582645"><span class="hs-identifier hs-var">home_ie</span></a><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span>               </span><a name="local-6989586621682582652"><a href="#local-6989586621682582652"><span class="hs-identifier">global_ie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_inst_env</span><span> </span><a href="#local-6989586621682582649"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-843"></a><span>               </span><a name="local-6989586621682582653"><a href="#local-6989586621682582653"><span class="hs-identifier">inst_envs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InstEnvs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ie_global</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582652"><span class="hs-identifier hs-var">global_ie</span></a><span>
</span><a name="line-844"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ie_local</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682582651"><span class="hs-identifier hs-var">home_ie'</span></a><span>
</span><a name="line-845"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ie_visible</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcVisibleOrphanMods</span><span> </span><a href="#local-6989586621682582650"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span>             </span><span class="hs-comment">-- Check for inconsistent functional dependencies</span><span>
</span><a name="line-848"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682582654"><a href="#local-6989586621682582654"><span class="hs-identifier">inconsistent_ispecs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FunDeps.html#checkFunDeps"><span class="hs-identifier hs-var">checkFunDeps</span></a><span> </span><a href="#local-6989586621682582653"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-849"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582654"><span class="hs-identifier hs-var">inconsistent_ispecs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-850"></a><span>           </span><a href="Inst.html#funDepErr"><span class="hs-identifier hs-var">funDepErr</span></a><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span> </span><a href="#local-6989586621682582654"><span class="hs-identifier hs-var">inconsistent_ispecs</span></a><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>             </span><span class="hs-comment">-- Check for duplicate instance decls.</span><span>
</span><a name="line-853"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682582655"><a href="#local-6989586621682582655"><span class="hs-identifier">_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582656"><a href="#local-6989586621682582656"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682582657"><a href="#local-6989586621682582657"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">instanceHead</span><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-854"></a><span>               </span><span class="hs-special">(</span><a name="local-6989586621682582658"><a href="#local-6989586621682582658"><span class="hs-identifier">matches</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupInstEnv</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682582653"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621682582656"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682582657"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-855"></a><span>               </span><a name="local-6989586621682582659"><a href="#local-6989586621682582659"><span class="hs-identifier">dups</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">identicalClsInstHead</span><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682582658"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682582659"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-857"></a><span>           </span><a href="Inst.html#dupInstErr"><span class="hs-identifier hs-var">dupInstErr</span></a><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682582659"><span class="hs-identifier hs-var">dups</span></a><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendInstEnv</span><span> </span><a href="#local-6989586621682582651"><span class="hs-identifier hs-var">home_ie'</span></a><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582647"><span class="hs-identifier hs-var">ispec</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682582646"><span class="hs-identifier hs-var">my_insts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span class="hs-comment">{-
Note [Signature files and type class instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Instances in signature files do not have an effect when compiling:
when you compile a signature against an implementation, you will
see the instances WHETHER OR NOT the instance is declared in
the file (this is because the signatures go in the EPS and we
can't filter them out easily.)  This is also why we cannot
place the instance in the hi file: it would show up as a duplicate,
and we don't have instance reexports anyway.

However, you might find them useful when typechecking against
a signature: the instance is a way of indicating to GHC that
some instance exists, in case downstream code uses it.

Implementing this is a little tricky.  Consider the following
situation (sigof03):

 module A where
     instance C T where ...

 module ASig where
     instance C T

When compiling ASig, A.hi is loaded, which brings its instances
into the EPS.  When we process the instance declaration in ASig,
we should ignore it for the purpose of doing a duplicate check,
since it's not actually a duplicate. But don't skip the check
entirely, we still want this to fail (tcfail221):

 module ASig where
     instance C T
     instance C T

Note that in some situations, the interface containing the type
class instances may not have been loaded yet at all.  The usual
situation when A imports another module which provides the
instances (sigof02m):

 module A(module B) where
     import B

See also Note [Signature lazy interface loading].  We can't
rely on this, however, since sometimes we'll have spurious
type class instances in the EPS, see #9422 (sigof02dm)

************************************************************************
*                                                                      *
        Errors and tracing
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span class="hs-identifier">traceDFuns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><a name="traceDFuns"><a href="Inst.html#traceDFuns"><span class="hs-identifier">traceDFuns</span></a></a><span> </span><a name="local-6989586621682582660"><a href="#local-6989586621682582660"><span class="hs-identifier">ispecs</span></a></a><span>
</span><a name="line-916"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Adding instances:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682582661"><span class="hs-identifier hs-var">pp</span></a><span> </span><a href="#local-6989586621682582660"><span class="hs-identifier hs-var">ispecs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-917"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-918"></a><span>    </span><a name="local-6989586621682582661"><a href="#local-6989586621682582661"><span class="hs-identifier">pp</span></a></a><span> </span><a name="local-6989586621682582662"><a href="#local-6989586621682582662"><span class="hs-identifier">ispec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">instanceDFunId</span><span> </span><a href="#local-6989586621682582662"><span class="hs-identifier hs-var">ispec</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>                  </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682582662"><span class="hs-identifier hs-var">ispec</span></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>        </span><span class="hs-comment">-- Print the dfun name itself too</span><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span class="hs-identifier">funDepErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-923"></a><a name="funDepErr"><a href="Inst.html#funDepErr"><span class="hs-identifier">funDepErr</span></a></a><span> </span><a name="local-6989586621682582663"><a href="#local-6989586621682582663"><span class="hs-identifier">ispec</span></a></a><span> </span><a name="local-6989586621682582664"><a href="#local-6989586621682582664"><span class="hs-identifier">ispecs</span></a></a><span>
</span><a name="line-924"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#addClsInstsErr"><span class="hs-identifier hs-var">addClsInstsErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Functional dependencies conflict between instance declarations:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>                    </span><span class="hs-special">(</span><a href="#local-6989586621682582663"><span class="hs-identifier hs-var">ispec</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682582664"><span class="hs-identifier hs-var">ispecs</span></a><span class="hs-special">)</span><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span class="hs-identifier">dupInstErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-928"></a><a name="dupInstErr"><a href="Inst.html#dupInstErr"><span class="hs-identifier">dupInstErr</span></a></a><span> </span><a name="local-6989586621682582665"><a href="#local-6989586621682582665"><span class="hs-identifier">ispec</span></a></a><span> </span><a name="local-6989586621682582666"><a href="#local-6989586621682582666"><span class="hs-identifier">dup_ispec</span></a></a><span>
</span><a name="line-929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#addClsInstsErr"><span class="hs-identifier hs-var">addClsInstsErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Duplicate instance declarations:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>                    </span><span class="hs-special">[</span><a href="#local-6989586621682582665"><span class="hs-identifier hs-var">ispec</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682582666"><span class="hs-identifier hs-var">dup_ispec</span></a><span class="hs-special">]</span><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span class="hs-identifier">addClsInstsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><a name="addClsInstsErr"><a href="Inst.html#addClsInstsErr"><span class="hs-identifier">addClsInstsErr</span></a></a><span> </span><a name="local-6989586621682582667"><a href="#local-6989586621682582667"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621682582668"><a href="#local-6989586621682582668"><span class="hs-identifier">ispecs</span></a></a><span>
</span><a name="line-934"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682582669"><span class="hs-identifier hs-var">sorted</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-935"></a><span>    </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><a href="#local-6989586621682582667"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprInstances</span><span> </span><a href="#local-6989586621682582669"><span class="hs-identifier hs-var">sorted</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-937"></a><span>   </span><a name="local-6989586621682582669"><a href="#local-6989586621682582669"><span class="hs-identifier">sorted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-identifier hs-var">getSrcLoc</span><span> </span><a href="#local-6989586621682582668"><span class="hs-identifier hs-var">ispecs</span></a><span>
</span><a name="line-938"></a><span>   </span><span class="hs-comment">-- The sortWith just arranges that instances are dislayed in order</span><span>
</span><a name="line-939"></a><span>   </span><span class="hs-comment">-- of source location, which reduced wobbling in error messages,</span><span>
</span><a name="line-940"></a><span>   </span><span class="hs-comment">-- and is better for users</span><span>
</span><a name="line-941"></a></pre></body></html>