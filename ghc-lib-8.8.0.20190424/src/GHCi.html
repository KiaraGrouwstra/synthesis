<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards, ScopedTypeVariables, BangPatterns, CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">--</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- | Interacting with the interpreter, whether it is running on an</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- external process or in the current process.</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHCi</span><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * High-level interface to the interpreter</span><span>
</span><a name="line-9"></a><span>    </span><a href="GHCi.html#evalStmt"><span class="hs-identifier hs-var">evalStmt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">EvalStatus_</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">EvalStatus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">EvalResult</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">EvalExpr</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#resumeStmt"><span class="hs-identifier hs-var">resumeStmt</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#abandonStmt"><span class="hs-identifier hs-var">abandonStmt</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#evalIO"><span class="hs-identifier hs-var">evalIO</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#evalString"><span class="hs-identifier hs-var">evalString</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#evalStringToIOString"><span class="hs-identifier hs-var">evalStringToIOString</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#mallocData"><span class="hs-identifier hs-var">mallocData</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#createBCOs"><span class="hs-identifier hs-var">createBCOs</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#addSptEntry"><span class="hs-identifier hs-var">addSptEntry</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#mkCostCentres"><span class="hs-identifier hs-var">mkCostCentres</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#costCentreStackInfo"><span class="hs-identifier hs-var">costCentreStackInfo</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#newBreakArray"><span class="hs-identifier hs-var">newBreakArray</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#enableBreakpoint"><span class="hs-identifier hs-var">enableBreakpoint</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#breakpointStatus"><span class="hs-identifier hs-var">breakpointStatus</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#getBreakpointVar"><span class="hs-identifier hs-var">getBreakpointVar</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#getClosure"><span class="hs-identifier hs-var">getClosure</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#seqHValue"><span class="hs-identifier hs-var">seqHValue</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-comment">-- * The object-code linker</span><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#initObjLinker"><span class="hs-identifier hs-var">initObjLinker</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#lookupSymbol"><span class="hs-identifier hs-var">lookupSymbol</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#lookupClosure"><span class="hs-identifier hs-var">lookupClosure</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#loadDLL"><span class="hs-identifier hs-var">loadDLL</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#loadArchive"><span class="hs-identifier hs-var">loadArchive</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#unloadObj"><span class="hs-identifier hs-var">unloadObj</span></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#addLibrarySearchPath"><span class="hs-identifier hs-var">addLibrarySearchPath</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#removeLibrarySearchPath"><span class="hs-identifier hs-var">removeLibrarySearchPath</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#resolveObjs"><span class="hs-identifier hs-var">resolveObjs</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#findSystemLibrary"><span class="hs-identifier hs-var">findSystemLibrary</span></a><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-comment">-- * Lower-level API using messages</span><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Message</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="GHCi.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a><span class="hs-special">,</span><span> </span><a href="GHCi.html#stopIServ"><span class="hs-identifier hs-var">stopIServ</span></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a><span class="hs-special">,</span><span> </span><a href="GHCi.html#readIServ"><span class="hs-identifier hs-var">readIServ</span></a><span class="hs-special">,</span><span> </span><a href="GHCi.html#writeIServ"><span class="hs-identifier hs-var">writeIServ</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#purgeLookupSymbolCache"><span class="hs-identifier hs-var">purgeLookupSymbolCache</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#freeHValueRefs"><span class="hs-identifier hs-var">freeHValueRefs</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#wormhole"><span class="hs-identifier hs-var">wormhole</span></a><span class="hs-special">,</span><span> </span><a href="GHCi.html#wormholeRef"><span class="hs-identifier hs-var">wormholeRef</span></a><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#mkEvalOpts"><span class="hs-identifier hs-var">mkEvalOpts</span></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.Message</span><span>
</span><a name="line-54"></a><span class="hs-cpp">#if defined(GHCI)
</span><span class="hs-keyword">import</span><span> </span><a href="GHCi.Run.html"><span class="hs-identifier">GHCi.Run</span></a><span>
</span><a name="line-56"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.ResolvedBCO.html"><span class="hs-identifier">GHCi.ResolvedBCO</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.BreakArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">BreakArray</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Hooks</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary.Put</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LB</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts.Heap</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Stack.CCS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CostCentre</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CostCentreStack</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Exit</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.Handle.Types</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handle</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.C</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.Handle.FD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdToHandle</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Posix</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Posix</span><span>
</span><a name="line-92"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Process</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Conc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getNumProcessors</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pseq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">par</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">{- Note [Remote GHCi]

When the flag -fexternal-interpreter is given to GHC, interpreted code
is run in a separate process called iserv, and we communicate with the
external process over a pipe using Binary-encoded messages.

Motivation
~~~~~~~~~~

When the interpreted code is running in a separate process, it can
use a different &quot;way&quot;, e.g. profiled or dynamic.  This means

- compiling Template Haskell code with -prof does not require
  building the code without -prof first

- when GHC itself is profiled, it can interpret unprofiled code,
  and the same applies to dynamic linking.

- An unprofiled GHCi can load and run profiled code, which means it
  can use the stack-trace functionality provided by profiling without
  taking the performance hit on the compiler that profiling would
  entail.

For other reasons see RemoteGHCi on the wiki.

Implementation Overview
~~~~~~~~~~~~~~~~~~~~~~~

The main pieces are:

- libraries/ghci, containing:
  - types for talking about remote values (GHCi.RemoteTypes)
  - the message protocol (GHCi.Message),
  - implementation of the messages (GHCi.Run)
  - implementation of Template Haskell (GHCi.TH)
  - a few other things needed to run interpreted code

- top-level iserv directory, containing the codefor the external
  server.  This is a fairly simple wrapper, most of the functionality
  is provided by modules in libraries/ghci.

- This module (GHCi) which provides the interface to the server used
  by the rest of GHC.

GHC works with and without -fexternal-interpreter.  With the flag, all
interpreted code is run by the iserv binary.  Without the flag,
interpreted code is run in the same process as GHC.

Things that do not work with -fexternal-interpreter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

dynCompileExpr cannot work, because we have no way to run code of an
unknown type in the remote process.  This API fails with an error
message if it is used with -fexternal-interpreter.

Other Notes on Remote GHCi
~~~~~~~~~~~~~~~~~~~~~~~~~~
  * This wiki page has an implementation overview:
    https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/ExternalInterpreter
  * Note [External GHCi pointers] in compiler/ghci/GHCi.hs
  * Note [Remote Template Haskell] in libraries/ghci/GHCi/TH.hs
-}</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-cpp">#if !defined(GHCI)
</span><span class="hs-identifier">needExtInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">a</span><span>
</span><a name="line-162"></a><span class="hs-identifier">needExtInt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throwIO</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier">InstallationError</span><span> </span><span class="hs-string">&quot;this operation requires -fexternal-interpreter&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- | Run a command in the interpreter's context.  With</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- @-fexternal-interpreter@, the command is serialized and sent to an</span><span>
</span><a name="line-168"></a><span class="hs-comment">-- external iserv process, and the response is deserialized (hence the</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- @Binary@ constraint).  With @-fno-external-interpreter@ we execute</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- the command directly here.</span><span>
</span><a name="line-171"></a><span class="hs-identifier">iservCmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621679591526"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Message</span><span> </span><a href="#local-6989586621679591526"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591526"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-172"></a><a name="iservCmd"><a href="GHCi.html#iservCmd"><span class="hs-identifier">iservCmd</span></a></a><span> </span><a name="local-6989586621679591527"><a href="#local-6989586621679591527"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591538"><a href="#local-6989586621679591538"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-173"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621679591528"><span class="hs-identifier hs-var">hsc_dflags</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-174"></a><span>     </span><a href="GHCi.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a><span> </span><a href="#local-6989586621679591527"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591539"><a href="#local-6989586621679591539"><span class="hs-identifier">iserv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-175"></a><span>       </span><span class="hs-identifier hs-var">uninterruptibleMask_</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Note [uninterruptibleMask_]</span><span>
</span><a name="line-176"></a><span>         </span><a href="GHCi.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a><span> </span><a href="#local-6989586621679591539"><span class="hs-identifier hs-var">iserv</span></a><span> </span><a href="#local-6989586621679591538"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-177"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Just run it directly</span><span>
</span><a name="line-178"></a><span class="hs-cpp">#if defined(GHCI)
</span><span>   </span><a href="GHCi.Run.html#run"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679591538"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-180"></a><span class="hs-cpp">#else
</span><span>   </span><span class="hs-identifier">needExtInt</span><span>
</span><a name="line-182"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- Note [uninterruptibleMask_ and iservCmd]</span><span>
</span><a name="line-185"></a><span class="hs-comment">--</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- If we receive an async exception, such as ^C, while communicating</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- with the iserv process then we will be out-of-sync and not be able</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- to recoever.  Thus we use uninterruptibleMask_ during</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- communication.  A ^C will be delivered to the iserv process (because</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- signals get sent to the whole process group) which will interrupt</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- the running computation and return an EvalException result.</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- | Grab a lock on the 'IServ' and do something with it.</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- Overloaded because this is used from TcM as well as IO.</span><span>
</span><a name="line-195"></a><span class="hs-identifier">withIServ</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679591524"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ExceptionMonad</span><span> </span><a href="#local-6989586621679591524"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679591524"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679591525"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679591524"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679591525"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-198"></a><a name="withIServ"><a href="GHCi.html#withIServ"><span class="hs-identifier">withIServ</span></a></a><span> </span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591550"><a href="#local-6989586621679591550"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-199"></a><span>  </span><span class="hs-identifier hs-var">gmask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591551"><a href="#local-6989586621679591551"><span class="hs-identifier">restore</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-200"></a><span>    </span><a name="local-6989586621679591552"><a href="#local-6989586621679591552"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeMVar</span><span> </span><a href="#local-6989586621679591549"><span class="hs-identifier hs-var">hsc_iserv</span></a><span>
</span><a name="line-201"></a><span>      </span><span class="hs-comment">-- start the iserv process if we haven't done so yet</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621679591553"><a href="#local-6989586621679591553"><span class="hs-identifier">iserv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#startIServ"><span class="hs-identifier hs-var">startIServ</span></a><span> </span><a href="#local-6989586621679591540"><span class="hs-identifier hs-var">hsc_dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679591552"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-203"></a><span>               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">gonException</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679591549"><span class="hs-identifier hs-var">hsc_iserv</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>      </span><span class="hs-comment">-- free any ForeignHValues that have been garbage collected.</span><span>
</span><a name="line-205"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679591554"><a href="#local-6989586621679591554"><span class="hs-identifier">iserv'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591553"><span class="hs-identifier hs-var">iserv</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">iservPendingFrees</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-6989586621679591555"><a href="#local-6989586621679591555"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-207"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iservPendingFrees</span><span> </span><a href="#local-6989586621679591553"><span class="hs-identifier hs-var">iserv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-208"></a><span>        </span><a href="GHCi.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a><span> </span><a href="#local-6989586621679591553"><span class="hs-identifier hs-var">iserv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FreeHValueRefs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iservPendingFrees</span><span> </span><a href="#local-6989586621679591553"><span class="hs-identifier hs-var">iserv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-comment">-- run the inner action</span><span>
</span><a name="line-210"></a><span>      </span><a href="#local-6989586621679591551"><span class="hs-identifier hs-var">restore</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679591550"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621679591553"><span class="hs-identifier hs-var">iserv</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">gonException</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679591549"><span class="hs-identifier hs-var">hsc_iserv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679591554"><span class="hs-identifier hs-var">iserv'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679591549"><span class="hs-identifier hs-var">hsc_iserv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679591554"><span class="hs-identifier hs-var">iserv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679591555"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- Wrappers around messages</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-comment">-- | Execute an action of type @IO [a]@, returning 'ForeignHValue's for</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- each of the results.</span><span>
</span><a name="line-221"></a><span class="hs-identifier">evalStmt</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvalExpr</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvalStatus_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><a name="evalStmt"><a href="GHCi.html#evalStmt"><span class="hs-identifier">evalStmt</span></a></a><span> </span><a name="local-6989586621679591556"><a href="#local-6989586621679591556"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591557"><a href="#local-6989586621679591557"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621679591558"><a href="#local-6989586621679591558"><span class="hs-identifier">foreign_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-225"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679591569"><a href="#local-6989586621679591569"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621679591556"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-226"></a><span>  </span><a name="local-6989586621679591571"><a href="#local-6989586621679591571"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679591559"><span class="hs-identifier hs-var">withExpr</span></a><span> </span><a href="#local-6989586621679591558"><span class="hs-identifier hs-var">foreign_expr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591570"><a href="#local-6989586621679591570"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-227"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591556"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalStmt</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#mkEvalOpts"><span class="hs-identifier hs-var">mkEvalOpts</span></a><span> </span><a href="#local-6989586621679591569"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679591557"><span class="hs-identifier hs-var">step</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591570"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>  </span><a href="GHCi.html#handleEvalStatus"><span class="hs-identifier hs-var">handleEvalStatus</span></a><span> </span><a href="#local-6989586621679591556"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679591571"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-229"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-identifier">withExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvalExpr</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvalExpr</span><span> </span><span class="hs-identifier hs-type">HValueRef</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591560"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591560"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-231"></a><span>  </span><a name="local-6989586621679591559"><a href="#local-6989586621679591559"><span class="hs-identifier">withExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalThis</span><span> </span><a name="local-6989586621679591561"><a href="#local-6989586621679591561"><span class="hs-identifier">fhv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679591562"><a href="#local-6989586621679591562"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-232"></a><span>    </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591561"><span class="hs-identifier hs-var">fhv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591563"><a href="#local-6989586621679591563"><span class="hs-identifier">hvref</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679591562"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalThis</span><span> </span><a href="#local-6989586621679591563"><span class="hs-identifier hs-var">hvref</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>  </span><span class="hs-identifier">withExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalApp</span><span> </span><a name="local-6989586621679591564"><a href="#local-6989586621679591564"><span class="hs-identifier">fl</span></a></a><span> </span><a name="local-6989586621679591565"><a href="#local-6989586621679591565"><span class="hs-identifier">fr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679591566"><a href="#local-6989586621679591566"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-234"></a><span>    </span><a href="#local-6989586621679591559"><span class="hs-identifier hs-var">withExpr</span></a><span> </span><a href="#local-6989586621679591564"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591567"><a href="#local-6989586621679591567"><span class="hs-identifier">fl'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-235"></a><span>    </span><a href="#local-6989586621679591559"><span class="hs-identifier hs-var">withExpr</span></a><span> </span><a href="#local-6989586621679591565"><span class="hs-identifier hs-var">fr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591568"><a href="#local-6989586621679591568"><span class="hs-identifier">fr'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-236"></a><span>    </span><a href="#local-6989586621679591566"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalApp</span><span> </span><a href="#local-6989586621679591567"><span class="hs-identifier hs-var">fl'</span></a><span> </span><a href="#local-6989586621679591568"><span class="hs-identifier hs-var">fr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-identifier">resumeStmt</span><span>
</span><a name="line-239"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ResumeContext</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvalStatus_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><a name="resumeStmt"><a href="GHCi.html#resumeStmt"><span class="hs-identifier">resumeStmt</span></a></a><span> </span><a name="local-6989586621679591572"><a href="#local-6989586621679591572"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591573"><a href="#local-6989586621679591573"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621679591574"><a href="#local-6989586621679591574"><span class="hs-identifier">resume_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-242"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679591575"><a href="#local-6989586621679591575"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621679591572"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-243"></a><span>  </span><a name="local-6989586621679591577"><a href="#local-6989586621679591577"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591574"><span class="hs-identifier hs-var">resume_ctxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591576"><a href="#local-6989586621679591576"><span class="hs-identifier">rhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-244"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591572"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ResumeStmt</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#mkEvalOpts"><span class="hs-identifier hs-var">mkEvalOpts</span></a><span> </span><a href="#local-6989586621679591575"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679591573"><span class="hs-identifier hs-var">step</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591576"><span class="hs-identifier hs-var">rhv</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>  </span><a href="GHCi.html#handleEvalStatus"><span class="hs-identifier hs-var">handleEvalStatus</span></a><span> </span><a href="#local-6989586621679591572"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679591577"><span class="hs-identifier hs-var">status</span></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-identifier">abandonStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ResumeContext</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><a name="abandonStmt"><a href="GHCi.html#abandonStmt"><span class="hs-identifier">abandonStmt</span></a></a><span> </span><a name="local-6989586621679591578"><a href="#local-6989586621679591578"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591579"><a href="#local-6989586621679591579"><span class="hs-identifier">resume_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-249"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591579"><span class="hs-identifier hs-var">resume_ctxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591580"><a href="#local-6989586621679591580"><span class="hs-identifier">rhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-250"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591578"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AbandonStmt</span><span> </span><a href="#local-6989586621679591580"><span class="hs-identifier hs-var">rhv</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-identifier">handleEvalStatus</span><span>
</span><a name="line-253"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvalStatus</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvalStatus_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><a name="handleEvalStatus"><a href="GHCi.html#handleEvalStatus"><span class="hs-identifier">handleEvalStatus</span></a></a><span> </span><a name="local-6989586621679591581"><a href="#local-6989586621679591581"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591582"><a href="#local-6989586621679591582"><span class="hs-identifier">status</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-256"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679591582"><span class="hs-identifier hs-var">status</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-identifier hs-var">EvalBreak</span><span> </span><a name="local-6989586621679591586"><a href="#local-6989586621679591586"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679591587"><a href="#local-6989586621679591587"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679591588"><a href="#local-6989586621679591588"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679591589"><a href="#local-6989586621679591589"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679591590"><a href="#local-6989586621679591590"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621679591591"><a href="#local-6989586621679591591"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalBreak</span><span> </span><a href="#local-6989586621679591586"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679591587"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679591588"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679591589"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621679591590"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679591591"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-identifier hs-var">EvalComplete</span><span> </span><a name="local-6989586621679591592"><a href="#local-6989586621679591592"><span class="hs-identifier">alloc</span></a></a><span> </span><a name="local-6989586621679591593"><a href="#local-6989586621679591593"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-259"></a><span>      </span><span class="hs-identifier hs-var">EvalComplete</span><span> </span><a href="#local-6989586621679591592"><span class="hs-identifier hs-var">alloc</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679591583"><span class="hs-identifier hs-var">addFinalizer</span></a><span> </span><a href="#local-6989586621679591593"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-260"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>  </span><a name="local-6989586621679591583"><a href="#local-6989586621679591583"><span class="hs-identifier">addFinalizer</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalException</span><span> </span><a name="local-6989586621679591584"><a href="#local-6989586621679591584"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalException</span><span> </span><a href="#local-6989586621679591584"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>  </span><span class="hs-identifier">addFinalizer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalSuccess</span><span> </span><a name="local-6989586621679591585"><a href="#local-6989586621679591585"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-263"></a><span>    </span><span class="hs-identifier hs-var">EvalSuccess</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621679591581"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591585"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-comment">-- | Execute an action of type @IO ()@</span><span>
</span><a name="line-266"></a><span class="hs-identifier">evalIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><a name="evalIO"><a href="GHCi.html#evalIO"><span class="hs-identifier">evalIO</span></a></a><span> </span><a name="local-6989586621679591594"><a href="#local-6989586621679591594"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591595"><a href="#local-6989586621679591595"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591595"><span class="hs-identifier hs-var">fhv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591596"><a href="#local-6989586621679591596"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-269"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591594"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalIO</span><span> </span><a href="#local-6989586621679591596"><span class="hs-identifier hs-var">fhv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="GHCi.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-comment">-- | Execute an action of type @IO String@</span><span>
</span><a name="line-272"></a><span class="hs-identifier">evalString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-273"></a><a name="evalString"><a href="GHCi.html#evalString"><span class="hs-identifier">evalString</span></a></a><span> </span><a name="local-6989586621679591597"><a href="#local-6989586621679591597"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591598"><a href="#local-6989586621679591598"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-274"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591598"><span class="hs-identifier hs-var">fhv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591599"><a href="#local-6989586621679591599"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-275"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591597"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalString</span><span> </span><a href="#local-6989586621679591599"><span class="hs-identifier hs-var">fhv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="GHCi.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">-- | Execute an action of type @String -&gt; IO String@</span><span>
</span><a name="line-278"></a><span class="hs-identifier">evalStringToIOString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-279"></a><a name="evalStringToIOString"><a href="GHCi.html#evalStringToIOString"><span class="hs-identifier">evalStringToIOString</span></a></a><span> </span><a name="local-6989586621679591600"><a href="#local-6989586621679591600"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591601"><a href="#local-6989586621679591601"><span class="hs-identifier">fhv</span></a></a><span> </span><a name="local-6989586621679591602"><a href="#local-6989586621679591602"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591601"><span class="hs-identifier hs-var">fhv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591603"><a href="#local-6989586621679591603"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-281"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591600"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalStringToString</span><span> </span><a href="#local-6989586621679591603"><span class="hs-identifier hs-var">fhv</span></a><span> </span><a href="#local-6989586621679591602"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="GHCi.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-comment">-- | Allocate and store the given bytes in memory, returning a pointer</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- to the memory in the remote process.</span><span>
</span><a name="line-286"></a><span class="hs-identifier">mallocData</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><a name="mallocData"><a href="GHCi.html#mallocData"><span class="hs-identifier">mallocData</span></a></a><span> </span><a name="local-6989586621679591604"><a href="#local-6989586621679591604"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591605"><a href="#local-6989586621679591605"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591604"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MallocData</span><span> </span><a href="#local-6989586621679591605"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">mkCostCentres</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span class="hs-special">]</span><span>
</span><a name="line-291"></a><a name="mkCostCentres"><a href="GHCi.html#mkCostCentres"><span class="hs-identifier">mkCostCentres</span></a></a><span> </span><a name="local-6989586621679591606"><a href="#local-6989586621679591606"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591607"><a href="#local-6989586621679591607"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621679591608"><a href="#local-6989586621679591608"><span class="hs-identifier">ccs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-292"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591606"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MkCostCentres</span><span> </span><a href="#local-6989586621679591607"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621679591608"><span class="hs-identifier hs-var">ccs</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- | Create a set of BCOs that may be mutually recursive.</span><span>
</span><a name="line-295"></a><span class="hs-identifier">createBCOs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="GHCi.ResolvedBCO.html#ResolvedBCO"><span class="hs-identifier hs-type">ResolvedBCO</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span>
</span><a name="line-296"></a><a name="createBCOs"><a href="GHCi.html#createBCOs"><span class="hs-identifier">createBCOs</span></a></a><span> </span><a name="local-6989586621679591609"><a href="#local-6989586621679591609"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591610"><a href="#local-6989586621679591610"><span class="hs-identifier">rbcos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-297"></a><span>  </span><a name="local-6989586621679591622"><a href="#local-6989586621679591622"><span class="hs-identifier">n_jobs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">parMakeCount</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621679591609"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-298"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getNumProcessors</span><span>
</span><a name="line-299"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679591621"><a href="#local-6989586621679591621"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679591621"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-300"></a><span>  </span><span class="hs-comment">-- Serializing ResolvedBCO is expensive, so if we're in parallel mode</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-comment">-- (-j&lt;n&gt;) parallelise the serialization.</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679591622"><span class="hs-identifier hs-var">n_jobs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>    </span><span class="hs-keyword">then</span><span>
</span><a name="line-304"></a><span>      </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591609"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CreateBCOs</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span> </span><a href="#local-6989586621679591610"><span class="hs-identifier hs-var">rbcos</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-307"></a><span>      </span><a name="local-6989586621679591623"><a href="#local-6989586621679591623"><span class="hs-identifier">old_caps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span>
</span><a name="line-308"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679591623"><span class="hs-identifier hs-var">old_caps</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679591622"><span class="hs-identifier hs-var">n_jobs</span></a><span>
</span><a name="line-309"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span> </span><a href="#local-6989586621679591611"><span class="hs-identifier hs-var">puts</span></a><span>
</span><a name="line-310"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">bracket_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><a href="#local-6989586621679591622"><span class="hs-identifier hs-var">n_jobs</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><a href="#local-6989586621679591623"><span class="hs-identifier hs-var">old_caps</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span> </span><a href="#local-6989586621679591611"><span class="hs-identifier hs-var">puts</span></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>      </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591609"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CreateBCOs</span><span> </span><a href="#local-6989586621679591611"><span class="hs-identifier hs-var">puts</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-315"></a><span>  </span><a name="local-6989586621679591611"><a href="#local-6989586621679591611"><span class="hs-identifier">puts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591613"><span class="hs-identifier hs-var">parMap</span></a><span> </span><a href="#local-6989586621679591612"><span class="hs-identifier hs-var">doChunk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">chunkList</span><span> </span><span class="hs-number">100</span><span> </span><a href="#local-6989586621679591610"><span class="hs-identifier hs-var">rbcos</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>  </span><span class="hs-comment">-- make sure we force the whole lazy ByteString</span><span>
</span><a name="line-318"></a><span>  </span><a name="local-6989586621679591612"><a href="#local-6989586621679591612"><span class="hs-identifier">doChunk</span></a></a><span> </span><a name="local-6989586621679591614"><a href="#local-6989586621679591614"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pseq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LB.length</span><span> </span><a href="#local-6989586621679591615"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591615"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-319"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679591615"><a href="#local-6989586621679591615"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span> </span><a href="#local-6989586621679591614"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>  </span><span class="hs-comment">-- We don't have the parallel package, so roll our own simple parMap</span><span>
</span><a name="line-322"></a><span>  </span><a name="local-6989586621679591613"><a href="#local-6989586621679591613"><span class="hs-identifier">parMap</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-323"></a><span>  </span><span class="hs-identifier">parMap</span><span> </span><a name="local-6989586621679591616"><a href="#local-6989586621679591616"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679591617"><a href="#local-6989586621679591617"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679591618"><a href="#local-6989586621679591618"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591619"><span class="hs-identifier hs-var">fx</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">par</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679591620"><span class="hs-identifier hs-var">fxs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">pseq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679591619"><span class="hs-identifier hs-var">fx</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679591620"><span class="hs-identifier hs-var">fxs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679591619"><a href="#local-6989586621679591619"><span class="hs-identifier">fx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591616"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679591617"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621679591620"><a href="#local-6989586621679591620"><span class="hs-identifier">fxs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591613"><span class="hs-identifier hs-var">parMap</span></a><span> </span><a href="#local-6989586621679591616"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679591618"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-identifier">addSptEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><a name="addSptEntry"><a href="GHCi.html#addSptEntry"><span class="hs-identifier">addSptEntry</span></a></a><span> </span><a name="local-6989586621679591624"><a href="#local-6989586621679591624"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591625"><a href="#local-6989586621679591625"><span class="hs-identifier">fpr</span></a></a><span> </span><a name="local-6989586621679591626"><a href="#local-6989586621679591626"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591626"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591627"><a href="#local-6989586621679591627"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-329"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591624"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddSptEntry</span><span> </span><a href="#local-6989586621679591625"><span class="hs-identifier hs-var">fpr</span></a><span> </span><a href="#local-6989586621679591627"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-identifier">costCentreStackInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RemotePtr</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-332"></a><a name="costCentreStackInfo"><a href="GHCi.html#costCentreStackInfo"><span class="hs-identifier">costCentreStackInfo</span></a></a><span> </span><a name="local-6989586621679591628"><a href="#local-6989586621679591628"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591629"><a href="#local-6989586621679591629"><span class="hs-identifier">ccs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-333"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591628"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CostCentreStackInfo</span><span> </span><a href="#local-6989586621679591629"><span class="hs-identifier hs-var">ccs</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">newBreakArray</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-identifier hs-type">BreakArray</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><a name="newBreakArray"><a href="GHCi.html#newBreakArray"><span class="hs-identifier">newBreakArray</span></a></a><span> </span><a name="local-6989586621679591630"><a href="#local-6989586621679591630"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591631"><a href="#local-6989586621679591631"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-337"></a><span>  </span><a name="local-6989586621679591632"><a href="#local-6989586621679591632"><span class="hs-identifier">breakArray</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591630"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NewBreakArray</span><span> </span><a href="#local-6989586621679591631"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>  </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621679591630"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679591632"><span class="hs-identifier hs-var">breakArray</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-identifier">enableBreakpoint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-identifier hs-type">BreakArray</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><a name="enableBreakpoint"><a href="GHCi.html#enableBreakpoint"><span class="hs-identifier">enableBreakpoint</span></a></a><span> </span><a name="local-6989586621679591633"><a href="#local-6989586621679591633"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591634"><a href="#local-6989586621679591634"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679591635"><a href="#local-6989586621679591635"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621679591636"><a href="#local-6989586621679591636"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591634"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591637"><a href="#local-6989586621679591637"><span class="hs-identifier">breakarray</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-343"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591633"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EnableBreakpoint</span><span> </span><a href="#local-6989586621679591637"><span class="hs-identifier hs-var">breakarray</span></a><span> </span><a href="#local-6989586621679591635"><span class="hs-identifier hs-var">ix</span></a><span> </span><a href="#local-6989586621679591636"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-identifier">breakpointStatus</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-identifier hs-type">BreakArray</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-346"></a><a name="breakpointStatus"><a href="GHCi.html#breakpointStatus"><span class="hs-identifier">breakpointStatus</span></a></a><span> </span><a name="local-6989586621679591638"><a href="#local-6989586621679591638"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591639"><a href="#local-6989586621679591639"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679591640"><a href="#local-6989586621679591640"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-347"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591639"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591641"><a href="#local-6989586621679591641"><span class="hs-identifier">breakarray</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-348"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591638"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BreakpointStatus</span><span> </span><a href="#local-6989586621679591641"><span class="hs-identifier hs-var">breakarray</span></a><span> </span><a href="#local-6989586621679591640"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-identifier">getBreakpointVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><a name="getBreakpointVar"><a href="GHCi.html#getBreakpointVar"><span class="hs-identifier">getBreakpointVar</span></a></a><span> </span><a name="local-6989586621679591642"><a href="#local-6989586621679591642"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591643"><a href="#local-6989586621679591643"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621679591644"><a href="#local-6989586621679591644"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591643"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591645"><a href="#local-6989586621679591645"><span class="hs-identifier">apStack</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-353"></a><span>    </span><a name="local-6989586621679591646"><a href="#local-6989586621679591646"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591642"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GetBreakpointVar</span><span> </span><a href="#local-6989586621679591645"><span class="hs-identifier hs-var">apStack</span></a><span> </span><a href="#local-6989586621679591644"><span class="hs-identifier hs-var">ix</span></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>    </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621679591642"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591646"><span class="hs-identifier hs-var">mb</span></a><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">getClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GenClosure</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><a name="getClosure"><a href="GHCi.html#getClosure"><span class="hs-identifier">getClosure</span></a></a><span> </span><a name="local-6989586621679591647"><a href="#local-6989586621679591647"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591648"><a href="#local-6989586621679591648"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-358"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591648"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591649"><a href="#local-6989586621679591649"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-359"></a><span>    </span><a name="local-6989586621679591650"><a href="#local-6989586621679591650"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591647"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GetClosure</span><span> </span><a href="#local-6989586621679591649"><span class="hs-identifier hs-var">hval</span></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>    </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621679591647"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591650"><span class="hs-identifier hs-var">mb</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">seqHValue</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-363"></a><a name="seqHValue"><a href="GHCi.html#seqHValue"><span class="hs-identifier">seqHValue</span></a></a><span> </span><a name="local-6989586621679591651"><a href="#local-6989586621679591651"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591652"><a href="#local-6989586621679591652"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-364"></a><span>  </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621679591652"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591653"><a href="#local-6989586621679591653"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-365"></a><span>    </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591651"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Seq</span><span> </span><a href="#local-6989586621679591653"><span class="hs-identifier hs-var">hval</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="GHCi.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-368"></a><span class="hs-comment">-- Interface to the object-code linker</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-identifier">initObjLinker</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-371"></a><a name="initObjLinker"><a href="GHCi.html#initObjLinker"><span class="hs-identifier">initObjLinker</span></a></a><span> </span><a name="local-6989586621679591654"><a href="#local-6989586621679591654"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591654"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">InitLinker</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-identifier">lookupSymbol</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-374"></a><a name="lookupSymbol"><a href="GHCi.html#lookupSymbol"><span class="hs-identifier">lookupSymbol</span></a></a><span> </span><a name="local-6989586621679591655"><a href="#local-6989586621679591655"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591666"><a href="#local-6989586621679591666"><span class="hs-identifier">str</span></a></a><span>
</span><a name="line-375"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621679591656"><span class="hs-identifier hs-var">hsc_dflags</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-376"></a><span>     </span><span class="hs-comment">-- Profiling of GHCi showed a lot of time and allocation spent</span><span>
</span><a name="line-377"></a><span>     </span><span class="hs-comment">-- making cross-process LookupSymbol calls, so I added a GHC-side</span><span>
</span><a name="line-378"></a><span>     </span><span class="hs-comment">-- cache which sped things up quite a lot.  We have to be careful</span><span>
</span><a name="line-379"></a><span>     </span><span class="hs-comment">-- to purge this cache when unloading code though.</span><span>
</span><a name="line-380"></a><span>     </span><a href="GHCi.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a><span> </span><a href="#local-6989586621679591655"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591667"><a href="#local-6989586621679591667"><span class="hs-identifier">iserv</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-381"></a><span>       </span><a name="local-6989586621679591673"><a href="#local-6989586621679591673"><span class="hs-identifier">cache</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679591671"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a><span>
</span><a name="line-382"></a><span>       </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621679591673"><span class="hs-identifier hs-var">cache</span></a><span> </span><a href="#local-6989586621679591666"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-383"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679591674"><a href="#local-6989586621679591674"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679591674"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-385"></a><span>           </span><a name="local-6989586621679591675"><a href="#local-6989586621679591675"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">uninterruptibleMask_</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-386"></a><span>                    </span><a href="GHCi.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a><span> </span><a href="#local-6989586621679591667"><span class="hs-identifier hs-var">iserv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LookupSymbol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unpackFS</span><span> </span><a href="#local-6989586621679591666"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679591675"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-388"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-389"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679591676"><a href="#local-6989586621679591676"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-390"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679591677"><a href="#local-6989586621679591677"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromRemotePtr</span><span> </span><a href="#local-6989586621679591676"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-391"></a><span>               </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679591671"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621679591673"><span class="hs-identifier hs-var">cache</span></a><span> </span><a href="#local-6989586621679591666"><span class="hs-identifier hs-var">str</span></a><span> </span><a href="#local-6989586621679591677"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-392"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679591677"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-394"></a><span class="hs-cpp">#if defined(GHCI)
</span><span>   </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromRemotePtr</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="GHCi.Run.html#run"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LookupSymbol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unpackFS</span><span> </span><a href="#local-6989586621679591666"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span class="hs-cpp">#else
</span><span>   </span><span class="hs-identifier">needExtInt</span><span>
</span><a name="line-398"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-400"></a><span class="hs-identifier">lookupClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><a name="lookupClosure"><a href="GHCi.html#lookupClosure"><span class="hs-identifier">lookupClosure</span></a></a><span> </span><a name="local-6989586621679591678"><a href="#local-6989586621679591678"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591679"><a href="#local-6989586621679591679"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-402"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591678"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LookupClosure</span><span> </span><a href="#local-6989586621679591679"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-identifier">purgeLookupSymbolCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><a name="purgeLookupSymbolCache"><a href="GHCi.html#purgeLookupSymbolCache"><span class="hs-identifier">purgeLookupSymbolCache</span></a></a><span> </span><a name="local-6989586621679591680"><a href="#local-6989586621679591680"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-406"></a><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621679591681"><span class="hs-identifier hs-var">hsc_dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-407"></a><span>   </span><a href="GHCi.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a><span> </span><a href="#local-6989586621679591680"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-408"></a><span>     </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679591693"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span class="hs-comment">-- | loadDLL loads a dynamic library using the OS's native linker</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- (i.e. dlopen() on Unix, LoadLibrary() on Windows).  It takes either</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- an absolute pathname to the file, or a relative filename</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- (e.g. &quot;libfoo.so&quot; or &quot;foo.dll&quot;).  In the latter case, loadDLL</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- searches the standard locations for the appropriate library.</span><span>
</span><a name="line-416"></a><span class="hs-comment">--</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- Returns:</span><span>
</span><a name="line-418"></a><span class="hs-comment">--</span><span>
</span><a name="line-419"></a><span class="hs-comment">-- Nothing      =&gt; success</span><span>
</span><a name="line-420"></a><span class="hs-comment">-- Just err_msg =&gt; failure</span><span>
</span><a name="line-421"></a><span class="hs-identifier">loadDLL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-422"></a><a name="loadDLL"><a href="GHCi.html#loadDLL"><span class="hs-identifier">loadDLL</span></a></a><span> </span><a name="local-6989586621679591695"><a href="#local-6989586621679591695"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591696"><a href="#local-6989586621679591696"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591695"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LoadDLL</span><span> </span><a href="#local-6989586621679591696"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-identifier">loadArchive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-425"></a><a name="loadArchive"><a href="GHCi.html#loadArchive"><span class="hs-identifier">loadArchive</span></a></a><span> </span><a name="local-6989586621679591697"><a href="#local-6989586621679591697"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591698"><a href="#local-6989586621679591698"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>  </span><a name="local-6989586621679591699"><a href="#local-6989586621679591699"><span class="hs-identifier">path'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">canonicalizePath</span><span> </span><a href="#local-6989586621679591698"><span class="hs-identifier hs-var">path</span></a><span> </span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><a name="line-427"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591697"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LoadArchive</span><span> </span><a href="#local-6989586621679591699"><span class="hs-identifier hs-var">path'</span></a><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span class="hs-identifier">loadObj</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><a name="loadObj"><a href="GHCi.html#loadObj"><span class="hs-identifier">loadObj</span></a></a><span> </span><a name="local-6989586621679591700"><a href="#local-6989586621679591700"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591701"><a href="#local-6989586621679591701"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-431"></a><span>  </span><a name="local-6989586621679591702"><a href="#local-6989586621679591702"><span class="hs-identifier">path'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">canonicalizePath</span><span> </span><a href="#local-6989586621679591701"><span class="hs-identifier hs-var">path</span></a><span> </span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><a name="line-432"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591700"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LoadObj</span><span> </span><a href="#local-6989586621679591702"><span class="hs-identifier hs-var">path'</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-identifier">unloadObj</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><a name="unloadObj"><a href="GHCi.html#unloadObj"><span class="hs-identifier">unloadObj</span></a></a><span> </span><a name="local-6989586621679591703"><a href="#local-6989586621679591703"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591704"><a href="#local-6989586621679591704"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-436"></a><span>  </span><a name="local-6989586621679591705"><a href="#local-6989586621679591705"><span class="hs-identifier">path'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">canonicalizePath</span><span> </span><a href="#local-6989586621679591704"><span class="hs-identifier hs-var">path</span></a><span> </span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><a name="line-437"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591703"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnloadObj</span><span> </span><a href="#local-6989586621679591705"><span class="hs-identifier hs-var">path'</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- the iserv process might have a different current directory from the</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- GHC process, so we must make paths absolute before sending them</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- over.</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span class="hs-identifier">addLibrarySearchPath</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-445"></a><a name="addLibrarySearchPath"><a href="GHCi.html#addLibrarySearchPath"><span class="hs-identifier">addLibrarySearchPath</span></a></a><span> </span><a name="local-6989586621679591706"><a href="#local-6989586621679591706"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591707"><a href="#local-6989586621679591707"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-446"></a><span>  </span><span class="hs-identifier hs-var">fromRemotePtr</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591706"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddLibrarySearchPath</span><span> </span><a href="#local-6989586621679591707"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">removeLibrarySearchPath</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-449"></a><a name="removeLibrarySearchPath"><a href="GHCi.html#removeLibrarySearchPath"><span class="hs-identifier">removeLibrarySearchPath</span></a></a><span> </span><a name="local-6989586621679591708"><a href="#local-6989586621679591708"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591709"><a href="#local-6989586621679591709"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-450"></a><span>  </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591708"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RemoveLibrarySearchPath</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toRemotePtr</span><span> </span><a href="#local-6989586621679591709"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">resolveObjs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-453"></a><a name="resolveObjs"><a href="GHCi.html#resolveObjs"><span class="hs-identifier">resolveObjs</span></a></a><span> </span><a name="local-6989586621679591710"><a href="#local-6989586621679591710"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">successIf</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591710"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">ResolveObjs</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-identifier">findSystemLibrary</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-456"></a><a name="findSystemLibrary"><a href="GHCi.html#findSystemLibrary"><span class="hs-identifier">findSystemLibrary</span></a></a><span> </span><a name="local-6989586621679591711"><a href="#local-6989586621679591711"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679591712"><a href="#local-6989586621679591712"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679591711"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FindSystemLibrary</span><span> </span><a href="#local-6989586621679591712"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- Raw calls and messages</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-comment">-- | Send a 'Message' and receive the response from the iserv process</span><span>
</span><a name="line-463"></a><span class="hs-identifier">iservCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621679591523"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Message</span><span> </span><a href="#local-6989586621679591523"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591523"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-464"></a><a name="iservCall"><a href="GHCi.html#iservCall"><span class="hs-identifier">iservCall</span></a></a><span> </span><a name="local-6989586621679591713"><a href="#local-6989586621679591713"><span class="hs-identifier">iserv</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591718"><a href="#local-6989586621679591718"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-identifier hs-var">remoteCall</span><span> </span><a href="#local-6989586621679591714"><span class="hs-identifier hs-var">iservPipe</span></a><span> </span><a href="#local-6989586621679591718"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-466"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679591719"><a href="#local-6989586621679591719"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.html#handleIServFailure"><span class="hs-identifier hs-var">handleIServFailure</span></a><span> </span><a href="#local-6989586621679591713"><span class="hs-identifier hs-var">iserv</span></a><span> </span><a href="#local-6989586621679591719"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span class="hs-comment">-- | Read a value from the iserv process</span><span>
</span><a name="line-469"></a><span class="hs-identifier">readIServ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679591522"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591522"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-470"></a><a name="readIServ"><a href="GHCi.html#readIServ"><span class="hs-identifier">readIServ</span></a></a><span> </span><a name="local-6989586621679591720"><a href="#local-6989586621679591720"><span class="hs-identifier">iserv</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591725"><a href="#local-6989586621679591725"><span class="hs-identifier">get</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-identifier hs-var">readPipe</span><span> </span><a href="#local-6989586621679591721"><span class="hs-identifier hs-var">iservPipe</span></a><span> </span><a href="#local-6989586621679591725"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-472"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679591726"><a href="#local-6989586621679591726"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.html#handleIServFailure"><span class="hs-identifier hs-var">handleIServFailure</span></a><span> </span><a href="#local-6989586621679591720"><span class="hs-identifier hs-var">iserv</span></a><span> </span><a href="#local-6989586621679591726"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- | Send a value to the iserv process</span><span>
</span><a name="line-475"></a><span class="hs-identifier">writeIServ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-476"></a><a name="writeIServ"><a href="GHCi.html#writeIServ"><span class="hs-identifier">writeIServ</span></a></a><span> </span><a name="local-6989586621679591727"><a href="#local-6989586621679591727"><span class="hs-identifier">iserv</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591732"><a href="#local-6989586621679591732"><span class="hs-identifier">put</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-477"></a><span>  </span><span class="hs-identifier hs-var">writePipe</span><span> </span><a href="#local-6989586621679591728"><span class="hs-identifier hs-var">iservPipe</span></a><span> </span><a href="#local-6989586621679591732"><span class="hs-identifier hs-var">put</span></a><span>
</span><a name="line-478"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679591733"><a href="#local-6989586621679591733"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.html#handleIServFailure"><span class="hs-identifier hs-var">handleIServFailure</span></a><span> </span><a href="#local-6989586621679591727"><span class="hs-identifier hs-var">iserv</span></a><span> </span><a href="#local-6989586621679591733"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-identifier">handleIServFailure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591521"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-481"></a><a name="handleIServFailure"><a href="GHCi.html#handleIServFailure"><span class="hs-identifier">handleIServFailure</span></a></a><span> </span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679591738"><a href="#local-6989586621679591738"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-482"></a><span>  </span><a name="local-6989586621679591739"><a href="#local-6989586621679591739"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getProcessExitCode</span><span> </span><a href="#local-6989586621679591735"><span class="hs-identifier hs-var">iservProcess</span></a><span>
</span><a name="line-483"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679591739"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-484"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExitFailure</span><span> </span><a name="local-6989586621679591740"><a href="#local-6989586621679591740"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-485"></a><span>      </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstallationError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;ghc-iserv terminated (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679591740"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-487"></a><span>      </span><span class="hs-identifier hs-var">terminateProcess</span><span> </span><a href="#local-6989586621679591735"><span class="hs-identifier hs-var">iservProcess</span></a><span>
</span><a name="line-488"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">waitForProcess</span><span> </span><a href="#local-6989586621679591735"><span class="hs-identifier hs-var">iservProcess</span></a><span>
</span><a name="line-489"></a><span>      </span><span class="hs-identifier hs-var">throw</span><span> </span><a href="#local-6989586621679591738"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- Starting and stopping the iserv process</span><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-identifier">startIServ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">IServ</span><span>
</span><a name="line-495"></a><a name="startIServ"><a href="GHCi.html#startIServ"><span class="hs-identifier">startIServ</span></a></a><span> </span><a name="local-6989586621679591741"><a href="#local-6989586621679591741"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-496"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679591742"><a href="#local-6989586621679591742"><span class="hs-identifier">flavour</span></a></a><span>
</span><a name="line-497"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayProf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621679591741"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;-prof&quot;</span><span>
</span><a name="line-498"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621679591741"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;-dyn&quot;</span><span>
</span><a name="line-499"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-500"></a><span>      </span><a name="local-6989586621679591743"><a href="#local-6989586621679591743"><span class="hs-identifier">prog</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_i</span><span> </span><a href="#local-6989586621679591741"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679591742"><span class="hs-identifier hs-var">flavour</span></a><span>
</span><a name="line-501"></a><span>      </span><a name="local-6989586621679591744"><a href="#local-6989586621679591744"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621679591741"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_i</span><span>
</span><a name="line-502"></a><span>  </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679591741"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Starting &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621679591743"><span class="hs-identifier hs-var">prog</span></a><span>
</span><a name="line-503"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679591745"><a href="#local-6989586621679591745"><span class="hs-identifier">createProc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupHook</span><span> </span><span class="hs-identifier">createIservProcessHook</span><span>
</span><a name="line-504"></a><span>                              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679591746"><a href="#local-6989586621679591746"><span class="hs-identifier">cp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679591747"><a href="#local-6989586621679591747"><span class="hs-identifier">ph</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">createProcess</span><span> </span><a href="#local-6989586621679591746"><span class="hs-identifier hs-var">cp</span></a><span>
</span><a name="line-505"></a><span>                                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679591747"><span class="hs-identifier hs-var">ph</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>                              </span><a href="#local-6989586621679591741"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-507"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679591748"><a href="#local-6989586621679591748"><span class="hs-identifier">ph</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679591749"><a href="#local-6989586621679591749"><span class="hs-identifier">rh</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679591750"><a href="#local-6989586621679591750"><span class="hs-identifier">wh</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GHCi.html#runWithPipes"><span class="hs-identifier hs-var">runWithPipes</span></a><span> </span><a href="#local-6989586621679591745"><span class="hs-identifier hs-var">createProc</span></a><span> </span><a href="#local-6989586621679591743"><span class="hs-identifier hs-var">prog</span></a><span> </span><a href="#local-6989586621679591744"><span class="hs-identifier hs-var">opts</span></a><span>
</span><a name="line-508"></a><span>  </span><a name="local-6989586621679591751"><a href="#local-6989586621679591751"><span class="hs-identifier">lo_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-509"></a><span>  </span><a name="local-6989586621679591752"><a href="#local-6989586621679591752"><span class="hs-identifier">cache_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span>
</span><a name="line-510"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">IServ</span><span>
</span><a name="line-511"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iservPipe</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Pipe</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pipeRead</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591749"><span class="hs-identifier hs-var">rh</span></a><span>
</span><a name="line-512"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pipeWrite</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591750"><span class="hs-identifier hs-var">wh</span></a><span>
</span><a name="line-513"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pipeLeftovers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591751"><span class="hs-identifier hs-var">lo_ref</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iservProcess</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591748"><span class="hs-identifier hs-var">ph</span></a><span>
</span><a name="line-515"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iservLookupSymbolCache</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679591752"><span class="hs-identifier hs-var">cache_ref</span></a><span>
</span><a name="line-516"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iservPendingFrees</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-identifier">stopIServ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-520"></a><a name="stopIServ"><a href="GHCi.html#stopIServ"><span class="hs-identifier">stopIServ</span></a></a><span> </span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-521"></a><span>  </span><span class="hs-identifier hs-var">gmask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679591766"><a href="#local-6989586621679591766"><span class="hs-identifier">_restore</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-522"></a><span>    </span><a name="local-6989586621679591767"><a href="#local-6989586621679591767"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">takeMVar</span><span> </span><a href="#local-6989586621679591762"><span class="hs-identifier hs-var">hsc_iserv</span></a><span>
</span><a name="line-523"></a><span>    </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679591763"><span class="hs-identifier hs-var">stop</span></a><span> </span><a href="#local-6989586621679591767"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-524"></a><span>    </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679591762"><span class="hs-identifier hs-var">hsc_iserv</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-525"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-526"></a><span>  </span><a name="local-6989586621679591763"><a href="#local-6989586621679591763"><span class="hs-identifier">stop</span></a></a><span> </span><a name="local-6989586621679591764"><a href="#local-6989586621679591764"><span class="hs-identifier">iserv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-527"></a><span>    </span><a name="local-6989586621679591765"><a href="#local-6989586621679591765"><span class="hs-identifier">ex</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getProcessExitCode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iservProcess</span><span> </span><a href="#local-6989586621679591764"><span class="hs-identifier hs-var">iserv</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621679591765"><span class="hs-identifier hs-var">ex</span></a><span>
</span><a name="line-529"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>       </span><span class="hs-keyword">else</span><span> </span><a href="GHCi.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a><span> </span><a href="#local-6989586621679591764"><span class="hs-identifier hs-var">iserv</span></a><span> </span><span class="hs-identifier hs-var">Shutdown</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-identifier">runWithPipes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CreateProcess</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ProcessHandle</span><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ProcessHandle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Handle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Handle</span><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-string">&quot;io.h _close&quot;</span><span>
</span><a name="line-536"></a><span>   </span><span class="hs-identifier">c__close</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;io.h _get_osfhandle&quot;</span><span>
</span><a name="line-539"></a><span>   </span><span class="hs-identifier">_get_osfhandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">runWithPipes</span><span> </span><span class="hs-identifier">createProc</span><span> </span><span class="hs-identifier">prog</span><span> </span><span class="hs-identifier">opts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-542"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">rfd1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wfd1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">createPipeFd</span><span> </span><span class="hs-comment">-- we read on rfd1</span><span>
</span><a name="line-543"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">rfd2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wfd2</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">createPipeFd</span><span> </span><span class="hs-comment">-- we write on wfd2</span><span>
</span><a name="line-544"></a><span>    </span><span class="hs-identifier">wh_client</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_get_osfhandle</span><span> </span><span class="hs-identifier">wfd1</span><span>
</span><a name="line-545"></a><span>    </span><span class="hs-identifier">rh_client</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_get_osfhandle</span><span> </span><span class="hs-identifier">rfd2</span><span>
</span><a name="line-546"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">wh_client</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">rh_client</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">opts</span><span>
</span><a name="line-547"></a><span>    </span><span class="hs-identifier">ph</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">createProc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">proc</span><span> </span><span class="hs-identifier">prog</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>    </span><span class="hs-identifier">rh</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-identifier">rfd1</span><span>
</span><a name="line-549"></a><span>    </span><span class="hs-identifier">wh</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-identifier">wfd2</span><span>
</span><a name="line-550"></a><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ph</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rh</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wh</span><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Handle</span><span>
</span><a name="line-552"></a><span>            </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdToHandle</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">onException</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">c__close</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-cpp">#else
</span><a name="runWithPipes"><a href="GHCi.html#runWithPipes"><span class="hs-identifier">runWithPipes</span></a></a><span> </span><a name="local-6989586621679591768"><a href="#local-6989586621679591768"><span class="hs-identifier">createProc</span></a></a><span> </span><a name="local-6989586621679591769"><a href="#local-6989586621679591769"><span class="hs-identifier">prog</span></a></a><span> </span><a name="local-6989586621679591770"><a href="#local-6989586621679591770"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-556"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679592059"><a href="#local-6989586621679592059"><span class="hs-identifier">rfd1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679592060"><a href="#local-6989586621679592060"><span class="hs-identifier">wfd1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Posix.createPipe</span><span> </span><span class="hs-comment">-- we read on rfd1</span><span>
</span><a name="line-557"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679592061"><a href="#local-6989586621679592061"><span class="hs-identifier">rfd2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679592062"><a href="#local-6989586621679592062"><span class="hs-identifier">wfd2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Posix.createPipe</span><span> </span><span class="hs-comment">-- we write on wfd2</span><span>
</span><a name="line-558"></a><span>    </span><span class="hs-identifier hs-var">setFdOption</span><span> </span><a href="#local-6989586621679592059"><span class="hs-identifier hs-var">rfd1</span></a><span> </span><span class="hs-identifier hs-var">CloseOnExec</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-559"></a><span>    </span><span class="hs-identifier hs-var">setFdOption</span><span> </span><a href="#local-6989586621679592062"><span class="hs-identifier hs-var">wfd2</span></a><span> </span><span class="hs-identifier hs-var">CloseOnExec</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-560"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679592063"><a href="#local-6989586621679592063"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679592060"><span class="hs-identifier hs-var">wfd1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679592061"><span class="hs-identifier hs-var">rfd2</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679591770"><span class="hs-identifier hs-var">opts</span></a><span>
</span><a name="line-561"></a><span>    </span><a name="local-6989586621679592064"><a href="#local-6989586621679592064"><span class="hs-identifier">ph</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679591768"><span class="hs-identifier hs-var">createProc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">proc</span><span> </span><a href="#local-6989586621679591769"><span class="hs-identifier hs-var">prog</span></a><span> </span><a href="#local-6989586621679592063"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>    </span><span class="hs-identifier hs-var">closeFd</span><span> </span><a href="#local-6989586621679592060"><span class="hs-identifier hs-var">wfd1</span></a><span>
</span><a name="line-563"></a><span>    </span><span class="hs-identifier hs-var">closeFd</span><span> </span><a href="#local-6989586621679592061"><span class="hs-identifier hs-var">rfd2</span></a><span>
</span><a name="line-564"></a><span>    </span><a name="local-6989586621679592065"><a href="#local-6989586621679592065"><span class="hs-identifier">rh</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fdToHandle</span><span> </span><a href="#local-6989586621679592059"><span class="hs-identifier hs-var">rfd1</span></a><span>
</span><a name="line-565"></a><span>    </span><a name="local-6989586621679592066"><a href="#local-6989586621679592066"><span class="hs-identifier">wh</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fdToHandle</span><span> </span><a href="#local-6989586621679592062"><span class="hs-identifier hs-var">wfd2</span></a><span>
</span><a name="line-566"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679592064"><span class="hs-identifier hs-var">ph</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679592065"><span class="hs-identifier hs-var">rh</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679592066"><span class="hs-identifier hs-var">wh</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-570"></a><span class="hs-comment">{- Note [External GHCi pointers]

We have the following ways to reference things in GHCi:

HValue
------

HValue is a direct reference to a value in the local heap.  Obviously
we cannot use this to refer to things in the external process.


RemoteRef
---------

RemoteRef is a StablePtr to a heap-resident value.  When
-fexternal-interpreter is used, this value resides in the external
process's heap.  RemoteRefs are mostly used to send pointers in
messages between GHC and iserv.

A RemoteRef must be explicitly freed when no longer required, using
freeHValueRefs, or by attaching a finalizer with mkForeignHValue.

To get from a RemoteRef to an HValue you can use 'wormholeRef', which
fails with an error message if -fexternal-interpreter is in use.

ForeignRef
----------

A ForeignRef is a RemoteRef with a finalizer that will free the
'RemoteRef' when it is garbage collected.  We mostly use ForeignHValue
on the GHC side.

The finalizer adds the RemoteRef to the iservPendingFrees list in the
IServ record.  The next call to iservCmd will free any RemoteRefs in
the list.  It was done this way rather than calling iservCmd directly,
because I didn't want to have arbitrary threads calling iservCmd.  In
principle it would probably be ok, but it seems less hairy this way.
-}</span><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span class="hs-comment">-- | Creates a 'ForeignRef' that will automatically release the</span><span>
</span><a name="line-610"></a><span class="hs-comment">-- 'RemoteRef' when it is no longer referenced.</span><span>
</span><a name="line-611"></a><span class="hs-identifier">mkFinalizedHValue</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><a href="#local-6989586621679591211"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><a href="#local-6989586621679591211"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-612"></a><a name="mkFinalizedHValue"><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier">mkFinalizedHValue</span></a></a><span> </span><span class="hs-identifier hs-var">HscEnv</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679592077"><a href="#local-6989586621679592077"><span class="hs-identifier">rref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkForeignRef</span><span> </span><a href="#local-6989586621679592077"><span class="hs-identifier hs-var">rref</span></a><span> </span><a href="#local-6989586621679592080"><span class="hs-identifier hs-var">free</span></a><span>
</span><a name="line-613"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-glyph">!</span><a name="local-6989586621679592078"><a href="#local-6989586621679592078"><span class="hs-identifier">external</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621679592067"><span class="hs-identifier hs-var">hsc_dflags</span></a><span>
</span><a name="line-615"></a><span>  </span><a name="local-6989586621679592079"><a href="#local-6989586621679592079"><span class="hs-identifier">hvref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toHValueRef</span><span> </span><a href="#local-6989586621679592077"><span class="hs-identifier hs-var">rref</span></a><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span>  </span><span class="hs-identifier">free</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>  </span><a name="local-6989586621679592080"><a href="#local-6989586621679592080"><span class="hs-identifier">free</span></a></a><span>
</span><a name="line-619"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679592078"><span class="hs-identifier hs-var">external</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">freeRemoteRef</span><span> </span><a href="#local-6989586621679592079"><span class="hs-identifier hs-var">hvref</span></a><span>
</span><a name="line-620"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-621"></a><span>      </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-6989586621679592076"><span class="hs-identifier hs-var">hsc_iserv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679592106"><a href="#local-6989586621679592106"><span class="hs-identifier">mb_iserv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-622"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679592106"><span class="hs-identifier hs-var">mb_iserv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-623"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- already shut down</span><span>
</span><a name="line-624"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679592107"><a href="#local-6989586621679592107"><span class="hs-identifier">iserv</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">IServ</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-625"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679592107"><span class="hs-identifier hs-var">iserv</span></a><span class="hs-special">{</span><span class="hs-identifier">iservPendingFrees</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679592079"><span class="hs-identifier hs-var">hvref</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679592111"><span class="hs-identifier hs-var">iservPendingFrees</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-identifier">freeHValueRefs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HValueRef</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><a name="freeHValueRefs"><a href="GHCi.html#freeHValueRefs"><span class="hs-identifier">freeHValueRefs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span class="hs-identifier">freeHValueRefs</span><span> </span><a name="local-6989586621679592112"><a href="#local-6989586621679592112"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679592113"><a href="#local-6989586621679592113"><span class="hs-identifier">refs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.html#iservCmd"><span class="hs-identifier hs-var">iservCmd</span></a><span> </span><a href="#local-6989586621679592112"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FreeHValueRefs</span><span> </span><a href="#local-6989586621679592113"><span class="hs-identifier hs-var">refs</span></a><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span class="hs-comment">-- | Convert a 'ForeignRef' to the value it references directly.  This</span><span>
</span><a name="line-632"></a><span class="hs-comment">-- only works when the interpreter is running in the same process as</span><span>
</span><a name="line-633"></a><span class="hs-comment">-- the compiler, so it fails when @-fexternal-interpreter@ is on.</span><span>
</span><a name="line-634"></a><span class="hs-identifier">wormhole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><a href="#local-6989586621679591210"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591210"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-635"></a><a name="wormhole"><a href="GHCi.html#wormhole"><span class="hs-identifier">wormhole</span></a></a><span> </span><a name="local-6989586621679592114"><a href="#local-6989586621679592114"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679592115"><a href="#local-6989586621679592115"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.html#wormholeRef"><span class="hs-identifier hs-var">wormholeRef</span></a><span> </span><a href="#local-6989586621679592114"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeForeignRefToRemoteRef</span><span> </span><a href="#local-6989586621679592115"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-comment">-- | Convert an 'RemoteRef' to the value it references directly.  This</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- only works when the interpreter is running in the same process as</span><span>
</span><a name="line-639"></a><span class="hs-comment">-- the compiler, so it fails when @-fexternal-interpreter@ is on.</span><span>
</span><a name="line-640"></a><span class="hs-identifier">wormholeRef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><a href="#local-6989586621679591209"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591209"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-641"></a><a name="wormholeRef"><a href="GHCi.html#wormholeRef"><span class="hs-identifier">wormholeRef</span></a></a><span> </span><a name="local-6989586621679592116"><a href="#local-6989586621679592116"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679592117"><a href="#local-6989586621679592117"><span class="hs-identifier">_r</span></a></a><span>
</span><a name="line-642"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621679592116"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-643"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstallationError</span><span>
</span><a name="line-644"></a><span>      </span><span class="hs-string">&quot;this operation requires -fno-external-interpreter&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span class="hs-cpp">#if defined(GHCI)
</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-647"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">localRef</span><span> </span><a href="#local-6989586621679592117"><span class="hs-identifier hs-var">_r</span></a><span>
</span><a name="line-648"></a><span class="hs-cpp">#else
</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>
</span><a name="line-650"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">InstallationError</span><span>
</span><a name="line-651"></a><span>      </span><span class="hs-string">&quot;can't wormhole a value in a stage1 compiler&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-652"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-654"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-655"></a><span class="hs-comment">-- Misc utils</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-identifier">mkEvalOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvalOpts</span><span>
</span><a name="line-658"></a><a name="mkEvalOpts"><a href="GHCi.html#mkEvalOpts"><span class="hs-identifier">mkEvalOpts</span></a></a><span> </span><a name="local-6989586621679592118"><a href="#local-6989586621679592118"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679592119"><a href="#local-6989586621679592119"><span class="hs-identifier">step</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-659"></a><span>  </span><span class="hs-identifier hs-var">EvalOpts</span><span>
</span><a name="line-660"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">useSandboxThread</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_GhciSandbox</span><span> </span><a href="#local-6989586621679592118"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-661"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">singleStep</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679592119"><span class="hs-identifier hs-var">step</span></a><span>
</span><a name="line-662"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">breakOnException</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_BreakOnException</span><span> </span><a href="#local-6989586621679592118"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-663"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">breakOnError</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_BreakOnError</span><span> </span><a href="#local-6989586621679592118"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span class="hs-identifier">fromEvalResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvalResult</span><span> </span><a href="#local-6989586621679591208"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679591208"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-666"></a><a name="fromEvalResult"><a href="GHCi.html#fromEvalResult"><span class="hs-identifier">fromEvalResult</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalException</span><span> </span><a name="local-6989586621679592120"><a href="#local-6989586621679592120"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromSerializableException</span><span> </span><a href="#local-6989586621679592120"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span class="hs-identifier">fromEvalResult</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvalSuccess</span><span> </span><a name="local-6989586621679592121"><a href="#local-6989586621679592121"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679592121"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-668"></a></pre></body></html>