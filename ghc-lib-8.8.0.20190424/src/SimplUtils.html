<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

\section[SimplUtils]{The simplifier utilities}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SimplUtils</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>        </span><span class="hs-comment">-- Rebuilding</span><span>
</span><a name="line-11"></a><span>        </span><a href="SimplUtils.html#mkLam"><span class="hs-identifier hs-var">mkLam</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkCase"><span class="hs-identifier hs-var">mkCase</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#prepareAlts"><span class="hs-identifier hs-var">prepareAlts</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#tryEtaExpandRhs"><span class="hs-identifier hs-var">tryEtaExpandRhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>        </span><span class="hs-comment">-- Inlining,</span><span>
</span><a name="line-14"></a><span>        </span><a href="SimplUtils.html#preInlineUnconditionally"><span class="hs-identifier hs-var">preInlineUnconditionally</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#postInlineUnconditionally"><span class="hs-identifier hs-var">postInlineUnconditionally</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="SimplUtils.html#activeUnfolding"><span class="hs-identifier hs-var">activeUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#activeRule"><span class="hs-identifier hs-var">activeRule</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="SimplUtils.html#getUnfoldingInRuleMatch"><span class="hs-identifier hs-var">getUnfoldingInRuleMatch</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="SimplUtils.html#simplEnvForGHCi"><span class="hs-identifier hs-var">simplEnvForGHCi</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#updModeForStableUnfoldings"><span class="hs-identifier hs-var">updModeForStableUnfoldings</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#updModeForRules"><span class="hs-identifier hs-var">updModeForRules</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><span class="hs-comment">-- The continuation type</span><span>
</span><a name="line-20"></a><span>        </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="SimplUtils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#contIsStop"><span class="hs-identifier hs-var">contIsStop</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="SimplUtils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="SimplUtils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#contArgs"><span class="hs-identifier hs-var">contArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="SimplUtils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier hs-var">mkBoringStop</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkRhsStop"><span class="hs-identifier hs-var">mkRhsStop</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkLazyArgStop"><span class="hs-identifier hs-var">mkLazyArgStop</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#contIsRhsOrArg"><span class="hs-identifier hs-var">contIsRhsOrArg</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="SimplUtils.html#interestingCallContext"><span class="hs-identifier hs-var">interestingCallContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span>        </span><span class="hs-comment">-- ArgInfo</span><span>
</span><a name="line-29"></a><span>        </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#mkArgInfo"><span class="hs-identifier hs-var">mkArgInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="SimplUtils.html#addValArgTo"><span class="hs-identifier hs-var">addValArgTo</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#addCastTo"><span class="hs-identifier hs-var">addCastTo</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#addTyArgTo"><span class="hs-identifier hs-var">addTyArgTo</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="SimplUtils.html#argInfoExpr"><span class="hs-identifier hs-var">argInfoExpr</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#pushSimplifiedArgs"><span class="hs-identifier hs-var">pushSimplifiedArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span>        </span><a href="SimplUtils.html#abstractFloats"><span class="hs-identifier hs-var">abstractFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>        </span><span class="hs-comment">-- Utilities</span><span>
</span><a name="line-36"></a><span>        </span><a href="SimplUtils.html#isExitJoinId"><span class="hs-identifier hs-var">isExitJoinId</span></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="SimplEnv.html"><span class="hs-identifier">SimplEnv</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMonad</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Tick</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">CoreSubst</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PprCore</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreArity</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUnfold</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Demand</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="SimplMonad.html"><span class="hs-identifier">SimplMonad</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>     </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">substCo</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">dataConWorkId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNullaryRepDataCon</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isNilOL</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Pair</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelRules</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                The SimplCont and DupFlag types
*                                                                      *
************************************************************************

A SimplCont allows the simplifier to traverse the expression in a
zipper-like fashion.  The SimplCont represents the rest of the expression,
&quot;above&quot; the point of interest.

You can also think of a SimplCont as an &quot;evaluation context&quot;, using
that term in the way it is used for operational semantics. This is the
way I usually think of it, For example you'll often see a syntax for
evaluation context looking like
        C ::= []  |  C e   |  case C of alts  |  C `cast` co
That's the kind of thing we are doing here, and I use that syntax in
the comments.


Key points:
  * A SimplCont describes a *strict* context (just like
    evaluation contexts do).  E.g. Just [] is not a SimplCont

  * A SimplCont describes a context that *does not* bind
    any variables.  E.g. \x. [] is not a SimplCont
-}</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-keyword">data</span><span> </span><a name="SimplCont"><a href="SimplUtils.html#SimplCont"><span class="hs-identifier">SimplCont</span></a></a><span>
</span><a name="line-104"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Stop"><a href="SimplUtils.html#Stop"><span class="hs-identifier">Stop</span></a></a><span>                </span><span class="hs-comment">-- Stop[e] = e</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-identifier hs-type">OutType</span><span>         </span><span class="hs-comment">-- Type of the &lt;hole&gt;</span><span>
</span><a name="line-106"></a><span>        </span><span class="hs-identifier hs-type">CallCtxt</span><span>        </span><span class="hs-comment">-- Tells if there is something interesting about</span><span>
</span><a name="line-107"></a><span>                        </span><span class="hs-comment">--          the context, and hence the inliner</span><span>
</span><a name="line-108"></a><span>                        </span><span class="hs-comment">--          should be a bit keener (see interestingCallContext)</span><span>
</span><a name="line-109"></a><span>                        </span><span class="hs-comment">-- Specifically:</span><span>
</span><a name="line-110"></a><span>                        </span><span class="hs-comment">--     This is an argument of a function that has RULES</span><span>
</span><a name="line-111"></a><span>                        </span><span class="hs-comment">--     Inlining the call might allow the rule to fire</span><span>
</span><a name="line-112"></a><span>                        </span><span class="hs-comment">-- Never ValAppCxt (use ApplyToVal instead)</span><span>
</span><a name="line-113"></a><span>                        </span><span class="hs-comment">-- or CaseCtxt (use Select instead)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CastIt"><a href="SimplUtils.html#CastIt"><span class="hs-identifier">CastIt</span></a></a><span>              </span><span class="hs-comment">-- (CastIt co K)[e] = K[ e `cast` co ]</span><span>
</span><a name="line-116"></a><span>        </span><span class="hs-identifier hs-type">OutCoercion</span><span>             </span><span class="hs-comment">-- The coercion simplified</span><span>
</span><a name="line-117"></a><span>                                </span><span class="hs-comment">-- Invariant: never an identity coercion</span><span>
</span><a name="line-118"></a><span>        </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ApplyToVal"><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier">ApplyToVal</span></a></a><span>         </span><span class="hs-comment">-- (ApplyToVal arg K)[e] = K[ e arg ]</span><span>
</span><a name="line-121"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="sc_dup"><a href="SimplUtils.html#sc_dup"><span class="hs-identifier">sc_dup</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span>      </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><a name="line-122"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_arg"><a href="SimplUtils.html#sc_arg"><span class="hs-identifier">sc_arg</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InExpr</span><span>       </span><span class="hs-comment">-- The argument,</span><span>
</span><a name="line-123"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_env"><a href="SimplUtils.html#sc_env"><span class="hs-identifier">sc_env</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span>    </span><span class="hs-comment">-- see Note [StaticEnv invariant]</span><span>
</span><a name="line-124"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_cont"><a href="SimplUtils.html#sc_cont"><span class="hs-identifier">sc_cont</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ApplyToTy"><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier">ApplyToTy</span></a></a><span>          </span><span class="hs-comment">-- (ApplyToTy ty K)[e] = K[ e ty ]</span><span>
</span><a name="line-127"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="sc_arg_ty"><a href="SimplUtils.html#sc_arg_ty"><span class="hs-identifier">sc_arg_ty</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span>     </span><span class="hs-comment">-- Argument type</span><span>
</span><a name="line-128"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_hole_ty"><a href="SimplUtils.html#sc_hole_ty"><span class="hs-identifier">sc_hole_ty</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span>     </span><span class="hs-comment">-- Type of the function, presumably (forall a. blah)</span><span>
</span><a name="line-129"></a><span>                                  </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><a name="line-130"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_cont"><a href="SimplUtils.html#sc_cont"><span class="hs-identifier">sc_cont</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Select"><a href="SimplUtils.html#Select"><span class="hs-identifier">Select</span></a></a><span>             </span><span class="hs-comment">-- (Select alts K)[e] = K[ case e of alts ]</span><span>
</span><a name="line-133"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="sc_dup"><a href="SimplUtils.html#sc_dup"><span class="hs-identifier">sc_dup</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span>        </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><a name="line-134"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_bndr"><a href="SimplUtils.html#sc_bndr"><span class="hs-identifier">sc_bndr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InId</span><span>           </span><span class="hs-comment">-- case binder</span><span>
</span><a name="line-135"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_alts"><a href="SimplUtils.html#sc_alts"><span class="hs-identifier">sc_alts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InAlt</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Alternatives</span><span>
</span><a name="line-136"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_env"><a href="SimplUtils.html#sc_env"><span class="hs-identifier">sc_env</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span>      </span><span class="hs-comment">-- See Note [StaticEnv invariant]</span><span>
</span><a name="line-137"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_cont"><a href="SimplUtils.html#sc_cont"><span class="hs-identifier">sc_cont</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>  </span><span class="hs-comment">-- The two strict forms have no DupFlag, because we never duplicate them</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="StrictBind"><a href="SimplUtils.html#StrictBind"><span class="hs-identifier">StrictBind</span></a></a><span>          </span><span class="hs-comment">-- (StrictBind x xs b K)[e] = let x = e in K[\xs.b]</span><span>
</span><a name="line-141"></a><span>                        </span><span class="hs-comment">--       or, equivalently,  = K[ (\x xs.b) e ]</span><span>
</span><a name="line-142"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="sc_dup"><a href="SimplUtils.html#sc_dup"><span class="hs-identifier">sc_dup</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span>        </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><a name="line-143"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_bndr"><a href="SimplUtils.html#sc_bndr"><span class="hs-identifier">sc_bndr</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InId</span><span>
</span><a name="line-144"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_bndrs"><a href="SimplUtils.html#sc_bndrs"><span class="hs-identifier">sc_bndrs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InBndr</span><span class="hs-special">]</span><span>
</span><a name="line-145"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_body"><a href="SimplUtils.html#sc_body"><span class="hs-identifier">sc_body</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InExpr</span><span>
</span><a name="line-146"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_env"><a href="SimplUtils.html#sc_env"><span class="hs-identifier">sc_env</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span>      </span><span class="hs-comment">-- See Note [StaticEnv invariant]</span><span>
</span><a name="line-147"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_cont"><a href="SimplUtils.html#sc_cont"><span class="hs-identifier">sc_cont</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="StrictArg"><a href="SimplUtils.html#StrictArg"><span class="hs-identifier">StrictArg</span></a></a><span>           </span><span class="hs-comment">-- (StrictArg (f e1 ..en) K)[e] = K[ f e1 .. en e ]</span><span>
</span><a name="line-150"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="sc_dup"><a href="SimplUtils.html#sc_dup"><span class="hs-identifier">sc_dup</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span>     </span><span class="hs-comment">-- Always Simplified or OkToDup</span><span>
</span><a name="line-151"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_fun"><a href="SimplUtils.html#sc_fun"><span class="hs-identifier">sc_fun</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span>     </span><span class="hs-comment">-- Specifies f, e1..en, Whether f has rules, etc</span><span>
</span><a name="line-152"></a><span>                               </span><span class="hs-comment">--     plus strictness flags for *further* args</span><span>
</span><a name="line-153"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_cci"><a href="SimplUtils.html#sc_cci"><span class="hs-identifier">sc_cci</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CallCtxt</span><span>    </span><span class="hs-comment">-- Whether *this* argument position is interesting</span><span>
</span><a name="line-154"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sc_cont"><a href="SimplUtils.html#sc_cont"><span class="hs-identifier">sc_cont</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TickIt"><a href="SimplUtils.html#TickIt"><span class="hs-identifier">TickIt</span></a></a><span>              </span><span class="hs-comment">-- (TickIt t K)[e] = K[ tick t e ]</span><span>
</span><a name="line-157"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Tick tickish &lt;hole&gt;</span><span>
</span><a name="line-158"></a><span>        </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-keyword">type</span><span> </span><a name="StaticEnv"><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier">StaticEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>       </span><span class="hs-comment">-- Just the static part is relevant</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-keyword">data</span><span> </span><a name="DupFlag"><a href="SimplUtils.html#DupFlag"><span class="hs-identifier">DupFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NoDup"><a href="SimplUtils.html#NoDup"><span class="hs-identifier">NoDup</span></a></a><span>       </span><span class="hs-comment">-- Unsimplified, might be big</span><span>
</span><a name="line-163"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a name="Simplified"><a href="SimplUtils.html#Simplified"><span class="hs-identifier">Simplified</span></a></a><span>  </span><span class="hs-comment">-- Simplified</span><span>
</span><a name="line-164"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a name="OkToDup"><a href="SimplUtils.html#OkToDup"><span class="hs-identifier">OkToDup</span></a></a><span>     </span><span class="hs-comment">-- Simplified and small</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">isSimplified</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-167"></a><a name="isSimplified"><a href="SimplUtils.html#isSimplified"><span class="hs-identifier">isSimplified</span></a></a><span> </span><a href="SimplUtils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-168"></a><span class="hs-identifier">isSimplified</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- Invariant: the subst-env is empty</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">perhapsSubstTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-171"></a><a name="perhapsSubstTy"><a href="SimplUtils.html#perhapsSubstTy"><span class="hs-identifier">perhapsSubstTy</span></a></a><span> </span><a name="local-6989586621680440084"><a href="#local-6989586621680440084"><span class="hs-identifier">dup</span></a></a><span> </span><a name="local-6989586621680440085"><a href="#local-6989586621680440085"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440086"><a href="#local-6989586621680440086"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-172"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#isSimplified"><span class="hs-identifier hs-var">isSimplified</span></a><span> </span><a href="#local-6989586621680440084"><span class="hs-identifier hs-var">dup</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440086"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621680440085"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440086"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">{- Note [StaticEnv invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pair up an InExpr or InAlts with a StaticEnv, which establishes the
lexical scope for that InExpr.  When we simplify that InExpr/InAlts, we
use
  - Its captured StaticEnv
  - Overriding its InScopeSet with the larger one at the
    simplification point.

Why override the InScopeSet?  Example:
      (let y = ey in f) ex
By the time we simplify ex, 'y' will be in scope.

However the InScopeSet in the StaticEnv is not irrelevant: it should
include all the free vars of applying the substitution to the InExpr.
Reason: contHoleType uses perhapsSubstTy to apply the substitution to
the expression, and that (rightly) gives ASSERT failures if the InScopeSet
isn't big enough.

Note [DupFlag invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~
In both (ApplyToVal dup _ env k)
   and  (Select dup _ _ env k)
the following invariants hold

  (a) if dup = OkToDup, then continuation k is also ok-to-dup
  (b) if dup = OkToDup or Simplified, the subst-env is empty
      (and and hence no need to re-simplify)
-}</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplUtils.html#DupFlag"><span class="hs-identifier hs-type">DupFlag</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-206"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="SimplUtils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ok&quot;</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="SimplUtils.html#NoDup"><span class="hs-identifier hs-var">NoDup</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;nodup&quot;</span><span>
</span><a name="line-208"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="SimplUtils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;simpl&quot;</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-211"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621680440064"><a href="#local-6989586621680440064"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680440065"><a href="#local-6989586621680440065"><span class="hs-identifier">interesting</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Stop&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440065"><span class="hs-identifier hs-var">interesting</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440064"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621680440066"><a href="#local-6989586621680440066"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621680440067"><a href="#local-6989586621680440067"><span class="hs-identifier">cont</span></a></a><span>  </span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CastIt&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprOptCo</span><span> </span><a href="#local-6989586621680440066"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440067"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-213"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><a name="local-6989586621680440068"><a href="#local-6989586621680440068"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680440069"><a href="#local-6989586621680440069"><span class="hs-identifier">cont</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;TickIt&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440068"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440069"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440070"><a href="#local-6989586621680440070"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440071"><a href="#local-6989586621680440071"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ApplyToTy&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprParendType</span><span> </span><a href="#local-6989586621680440070"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440071"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-216"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440072"><a href="#local-6989586621680440072"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440073"><a href="#local-6989586621680440073"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440074"><a href="#local-6989586621680440074"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ApplyToVal&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440073"><span class="hs-identifier hs-var">dup</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprParendExpr</span><span> </span><a href="#local-6989586621680440072"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>                                        </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440074"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440075"><a href="#local-6989586621680440075"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440076"><a href="#local-6989586621680440076"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StrictBind&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440075"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440076"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440077"><a href="#local-6989586621680440077"><span class="hs-identifier">ai</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440078"><a href="#local-6989586621680440078"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StrictArg&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ai_fun</span><span> </span><a href="#local-6989586621680440077"><span class="hs-identifier hs-var">ai</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440078"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440079"><a href="#local-6989586621680440079"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440080"><a href="#local-6989586621680440080"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440081"><a href="#local-6989586621680440081"><span class="hs-identifier">alts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440082"><a href="#local-6989586621680440082"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440083"><a href="#local-6989586621680440083"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Select&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440079"><span class="hs-identifier hs-var">dup</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440080"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-225"></a><span>       </span><span class="hs-identifier hs-var">whenPprDebug</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seTvSubst</span><span> </span><a href="#local-6989586621680440082"><span class="hs-identifier hs-var">se</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440081"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440083"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">{- Note [The hole type in ApplyToTy]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The sc_hole_ty field of ApplyToTy records the type of the &quot;hole&quot; in the
continuation.  It is absolutely necessary to compute contHoleType, but it is
not used for anything else (and hence may not be evaluated).

Why is it necessary for contHoleType?  Consider the continuation
     ApplyToType Int (Stop Int)
corresponding to
     (&lt;hole&gt; @Int) :: Int
What is the type of &lt;hole&gt;?  It could be (forall a. Int) or (forall a. a),
and there is no way to know which, so we must record it.

In a chain of applications  (f @t1 @t2 @t3) we'll lazily compute exprType
for (f @t1) and (f @t1 @t2), which is potentially non-linear; but it probably
doesn't matter because we'll never compute them all.

************************************************************************
*                                                                      *
                ArgInfo and ArgSpec
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-keyword">data</span><span> </span><a name="ArgInfo"><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier">ArgInfo</span></a></a><span>
</span><a name="line-253"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ArgInfo"><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier">ArgInfo</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-254"></a><span>        </span><a name="ai_fun"><a href="SimplUtils.html#ai_fun"><span class="hs-identifier">ai_fun</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- The function</span><span>
</span><a name="line-255"></a><span>        </span><a name="ai_args"><a href="SimplUtils.html#ai_args"><span class="hs-identifier">ai_args</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- ...applied to these args (which are in *reverse* order)</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>        </span><a name="ai_type"><a href="SimplUtils.html#ai_type"><span class="hs-identifier">ai_type</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Type of (f a1 ... an)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span>        </span><a name="ai_rules"><a href="SimplUtils.html#ai_rules"><span class="hs-identifier">ai_rules</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#FunRules"><span class="hs-identifier hs-type">FunRules</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Rules for this function</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>        </span><a name="ai_encl"><a href="SimplUtils.html#ai_encl"><span class="hs-identifier">ai_encl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Flag saying whether this function</span><span>
</span><a name="line-262"></a><span>                                </span><span class="hs-comment">-- or an enclosing one has rules (recursively)</span><span>
</span><a name="line-263"></a><span>                                </span><span class="hs-comment">--      True =&gt; be keener to inline in all args</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span>        </span><a name="ai_strs"><a href="SimplUtils.html#ai_strs"><span class="hs-identifier">ai_strs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Strictness of remaining arguments</span><span>
</span><a name="line-266"></a><span>                                </span><span class="hs-comment">--   Usually infinite, but if it is finite it guarantees</span><span>
</span><a name="line-267"></a><span>                                </span><span class="hs-comment">--   that the function diverges after being given</span><span>
</span><a name="line-268"></a><span>                                </span><span class="hs-comment">--   that number of args</span><span>
</span><a name="line-269"></a><span>        </span><a name="ai_discs"><a href="SimplUtils.html#ai_discs"><span class="hs-identifier">ai_discs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Discounts for remaining arguments; non-zero =&gt; be keener to inline</span><span>
</span><a name="line-270"></a><span>                                </span><span class="hs-comment">--   Always infinite</span><span>
</span><a name="line-271"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-keyword">data</span><span> </span><a name="ArgSpec"><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier">ArgSpec</span></a></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ValArg"><a href="SimplUtils.html#ValArg"><span class="hs-identifier">ValArg</span></a></a><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>                    </span><span class="hs-comment">-- Apply to this (coercion or value); c.f. ApplyToVal</span><span>
</span><a name="line-275"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TyArg"><a href="SimplUtils.html#TyArg"><span class="hs-identifier">TyArg</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="as_arg_ty"><a href="SimplUtils.html#as_arg_ty"><span class="hs-identifier">as_arg_ty</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span>     </span><span class="hs-comment">-- Apply to this type; c.f. ApplyToTy</span><span>
</span><a name="line-276"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="as_hole_ty"><a href="SimplUtils.html#as_hole_ty"><span class="hs-identifier">as_hole_ty</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-special">}</span><span>   </span><span class="hs-comment">-- Type of the function (presumably forall a. blah)</span><span>
</span><a name="line-277"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CastBy"><a href="SimplUtils.html#CastBy"><span class="hs-identifier">CastBy</span></a></a><span> </span><span class="hs-identifier hs-type">OutCoercion</span><span>                </span><span class="hs-comment">-- Cast by this; c.f. CastIt</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-280"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a name="local-6989586621680440061"><a href="#local-6989586621680440061"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ValArg&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440061"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-281"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440062"><a href="#local-6989586621680440062"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;TyArg&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440062"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastBy"><span class="hs-identifier hs-var">CastBy</span></a><span> </span><a name="local-6989586621680440063"><a href="#local-6989586621680440063"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CastBy&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440063"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">addValArgTo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span>
</span><a name="line-285"></a><a name="addValArgTo"><a href="SimplUtils.html#addValArgTo"><span class="hs-identifier">addValArgTo</span></a></a><span> </span><a name="local-6989586621680440087"><a href="#local-6989586621680440087"><span class="hs-identifier">ai</span></a></a><span> </span><a name="local-6989586621680440088"><a href="#local-6989586621680440088"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440087"><span class="hs-identifier hs-var">ai</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a href="#local-6989586621680440088"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><a href="#local-6989586621680440087"><span class="hs-identifier hs-var">ai</span></a><span>
</span><a name="line-286"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">applyTypeToArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ai_type</span><span> </span><a href="#local-6989586621680440087"><span class="hs-identifier hs-var">ai</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440088"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-287"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#decRules"><span class="hs-identifier hs-var">decRules</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ai_rules</span><span> </span><a href="#local-6989586621680440087"><span class="hs-identifier hs-var">ai</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">addTyArgTo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span>
</span><a name="line-290"></a><a name="addTyArgTo"><a href="SimplUtils.html#addTyArgTo"><span class="hs-identifier">addTyArgTo</span></a></a><span> </span><a name="local-6989586621680440089"><a href="#local-6989586621680440089"><span class="hs-identifier">ai</span></a></a><span> </span><a name="local-6989586621680440090"><a href="#local-6989586621680440090"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440089"><span class="hs-identifier hs-var">ai</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440092"><span class="hs-identifier hs-var">arg_spec</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><a href="#local-6989586621680440089"><span class="hs-identifier hs-var">ai</span></a><span>
</span><a name="line-291"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">piResultTy</span><span> </span><a href="#local-6989586621680440091"><span class="hs-identifier hs-var">poly_fun_ty</span></a><span> </span><a href="#local-6989586621680440090"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-292"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#decRules"><span class="hs-identifier hs-var">decRules</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ai_rules</span><span> </span><a href="#local-6989586621680440089"><span class="hs-identifier hs-var">ai</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-294"></a><span>    </span><a name="local-6989586621680440091"><a href="#local-6989586621680440091"><span class="hs-identifier">poly_fun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><a href="#local-6989586621680440089"><span class="hs-identifier hs-var">ai</span></a><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621680440092"><a href="#local-6989586621680440092"><span class="hs-identifier">arg_spec</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440090"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">as_hole_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440091"><span class="hs-identifier hs-var">poly_fun_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-identifier">addCastTo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutCoercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span>
</span><a name="line-298"></a><a name="addCastTo"><a href="SimplUtils.html#addCastTo"><span class="hs-identifier">addCastTo</span></a></a><span> </span><a name="local-6989586621680440093"><a href="#local-6989586621680440093"><span class="hs-identifier">ai</span></a></a><span> </span><a name="local-6989586621680440094"><a href="#local-6989586621680440094"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440093"><span class="hs-identifier hs-var">ai</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#CastBy"><span class="hs-identifier hs-var">CastBy</span></a><span> </span><a href="#local-6989586621680440094"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><a href="#local-6989586621680440093"><span class="hs-identifier hs-var">ai</span></a><span>
</span><a name="line-299"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coercionKind</span><span> </span><a href="#local-6989586621680440094"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-identifier">argInfoAppArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutExpr</span><span class="hs-special">]</span><span>
</span><a name="line-302"></a><a name="argInfoAppArgs"><a href="SimplUtils.html#argInfoAppArgs"><span class="hs-identifier">argInfoAppArgs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-303"></a><span class="hs-identifier">argInfoAppArgs</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastBy"><span class="hs-identifier hs-var">CastBy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Stop at a cast</span><span>
</span><a name="line-304"></a><span class="hs-identifier">argInfoAppArgs</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a name="local-6989586621680440095"><a href="#local-6989586621680440095"><span class="hs-identifier">e</span></a></a><span>                 </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440095"><span class="hs-identifier hs-var">e</span></a><span>       </span><span class="hs-glyph">:</span><span> </span><a href="SimplUtils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-305"></a><span class="hs-identifier">argInfoAppArgs</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440097"><a href="#local-6989586621680440097"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621680440097"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="SimplUtils.html#argInfoAppArgs"><span class="hs-identifier hs-var">argInfoAppArgs</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">pushSimplifiedArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-308"></a><a name="pushSimplifiedArgs"><a href="SimplUtils.html#pushSimplifiedArgs"><span class="hs-identifier">pushSimplifiedArgs</span></a></a><span> </span><a name="local-6989586621680440099"><a href="#local-6989586621680440099"><span class="hs-identifier">_env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><a name="local-6989586621680440100"><a href="#local-6989586621680440100"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440100"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-309"></a><span class="hs-identifier">pushSimplifiedArgs</span><span> </span><a name="local-6989586621680440101"><a href="#local-6989586621680440101"><span class="hs-identifier">env</span></a></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621680440102"><a href="#local-6989586621680440102"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680440103"><a href="#local-6989586621680440103"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680440104"><a href="#local-6989586621680440104"><span class="hs-identifier">k</span></a></a><span>
</span><a name="line-310"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440102"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-311"></a><span>      </span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440106"><a href="#local-6989586621680440106"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">as_hole_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440107"><a href="#local-6989586621680440107"><span class="hs-identifier">hole_ty</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-312"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440106"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_hole_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440107"><span class="hs-identifier hs-var">hole_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440105"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>      </span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a name="local-6989586621680440108"><a href="#local-6989586621680440108"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440108"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440101"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#Simplified"><span class="hs-identifier hs-var">Simplified</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440105"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-314"></a><span>      </span><a href="SimplUtils.html#CastBy"><span class="hs-identifier hs-var">CastBy</span></a><span> </span><a name="local-6989586621680440109"><a href="#local-6989586621680440109"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a href="#local-6989586621680440109"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621680440105"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-315"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-316"></a><span>    </span><a name="local-6989586621680440105"><a href="#local-6989586621680440105"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#pushSimplifiedArgs"><span class="hs-identifier hs-var">pushSimplifiedArgs</span></a><span> </span><a href="#local-6989586621680440101"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440103"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680440104"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-317"></a><span>           </span><span class="hs-comment">-- The env has an empty SubstEnv</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-identifier">argInfoExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="SimplUtils.html#ArgSpec"><span class="hs-identifier hs-type">ArgSpec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- NB: the [ArgSpec] is reversed so that the first arg</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- in the list is the last one in the application</span><span>
</span><a name="line-322"></a><a name="argInfoExpr"><a href="SimplUtils.html#argInfoExpr"><span class="hs-identifier">argInfoExpr</span></a></a><span> </span><a name="local-6989586621680440110"><a href="#local-6989586621680440110"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621680440111"><a href="#local-6989586621680440111"><span class="hs-identifier">rev_args</span></a></a><span>
</span><a name="line-323"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440112"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440111"><span class="hs-identifier hs-var">rev_args</span></a><span>
</span><a name="line-324"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-325"></a><span>    </span><a name="local-6989586621680440112"><a href="#local-6989586621680440112"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680440110"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-326"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ValArg"><span class="hs-identifier hs-var">ValArg</span></a><span> </span><a name="local-6989586621680440113"><a href="#local-6989586621680440113"><span class="hs-identifier">a</span></a></a><span>                 </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440112"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440113"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-327"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TyArg"><span class="hs-identifier hs-var">TyArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">as_arg_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440115"><a href="#local-6989586621680440115"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440112"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621680440115"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastBy"><span class="hs-identifier hs-var">CastBy</span></a><span> </span><a name="local-6989586621680440117"><a href="#local-6989586621680440117"><span class="hs-identifier">co</span></a></a><span>                </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCast</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440112"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440117"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-keyword">type</span><span> </span><a name="FunRules"><a href="SimplUtils.html#FunRules"><span class="hs-identifier">FunRules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Remaining rules for this function</span><span>
</span><a name="line-332"></a><span>     </span><span class="hs-comment">-- Nothing =&gt; No rules</span><span>
</span><a name="line-333"></a><span>     </span><span class="hs-comment">-- Just (n, rules) =&gt; some rules, requiring at least n more type/value args</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">decRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#FunRules"><span class="hs-identifier hs-type">FunRules</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#FunRules"><span class="hs-identifier hs-type">FunRules</span></a><span>
</span><a name="line-336"></a><a name="decRules"><a href="SimplUtils.html#decRules"><span class="hs-identifier">decRules</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440119"><a href="#local-6989586621680440119"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440120"><a href="#local-6989586621680440120"><span class="hs-identifier">rules</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440119"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440120"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span class="hs-identifier">decRules</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-identifier">mkFunRules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#FunRules"><span class="hs-identifier hs-type">FunRules</span></a><span>
</span><a name="line-340"></a><a name="mkFunRules"><a href="SimplUtils.html#mkFunRules"><span class="hs-identifier">mkFunRules</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-341"></a><span class="hs-identifier">mkFunRules</span><span> </span><a name="local-6989586621680440121"><a href="#local-6989586621680440121"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440122"><span class="hs-identifier hs-var">n_required</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440121"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-343"></a><span>    </span><a name="local-6989586621680440122"><a href="#local-6989586621680440122"><span class="hs-identifier">n_required</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maximum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ruleArity</span><span> </span><a href="#local-6989586621680440121"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Functions on SimplCont
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">mkBoringStop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-354"></a><a name="mkBoringStop"><a href="SimplUtils.html#mkBoringStop"><span class="hs-identifier">mkBoringStop</span></a></a><span> </span><a name="local-6989586621680440123"><a href="#local-6989586621680440123"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621680440123"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">BoringCtxt</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">mkRhsStop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>       </span><span class="hs-comment">-- See Note [RHS of lets] in CoreUnfold</span><span>
</span><a name="line-357"></a><a name="mkRhsStop"><a href="SimplUtils.html#mkRhsStop"><span class="hs-identifier">mkRhsStop</span></a></a><span> </span><a name="local-6989586621680440124"><a href="#local-6989586621680440124"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621680440124"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">RhsCtxt</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-identifier">mkLazyArgStop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CallCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>
</span><a name="line-360"></a><a name="mkLazyArgStop"><a href="SimplUtils.html#mkLazyArgStop"><span class="hs-identifier">mkLazyArgStop</span></a></a><span> </span><a name="local-6989586621680440125"><a href="#local-6989586621680440125"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680440126"><a href="#local-6989586621680440126"><span class="hs-identifier">cci</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621680440125"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680440126"><span class="hs-identifier hs-var">cci</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-363"></a><span class="hs-identifier">contIsRhsOrArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-364"></a><a name="contIsRhsOrArg"><a href="SimplUtils.html#contIsRhsOrArg"><span class="hs-identifier">contIsRhsOrArg</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-365"></a><span class="hs-identifier">contIsRhsOrArg</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-366"></a><span class="hs-identifier">contIsRhsOrArg</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-367"></a><span class="hs-identifier">contIsRhsOrArg</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-identifier">contIsRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-370"></a><a name="contIsRhs"><a href="SimplUtils.html#contIsRhs"><span class="hs-identifier">contIsRhs</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">RhsCtxt</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-371"></a><span class="hs-identifier">contIsRhs</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-374"></a><span class="hs-identifier">contIsStop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-375"></a><a name="contIsStop"><a href="SimplUtils.html#contIsStop"><span class="hs-identifier">contIsStop</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-376"></a><span class="hs-identifier">contIsStop</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-379"></a><a name="contIsDupable"><a href="SimplUtils.html#contIsDupable"><span class="hs-identifier">contIsDupable</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-380"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440127"><a href="#local-6989586621680440127"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a><span> </span><a href="#local-6989586621680440127"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-381"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- See Note [DupFlag invariants]</span><span>
</span><a name="line-382"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- ...ditto...</span><span>
</span><a name="line-383"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#OkToDup"><span class="hs-identifier hs-var">OkToDup</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- ...ditto...</span><span>
</span><a name="line-384"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440128"><a href="#local-6989586621680440128"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contIsDupable"><span class="hs-identifier hs-var">contIsDupable</span></a><span> </span><a href="#local-6989586621680440128"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-385"></a><span class="hs-identifier">contIsDupable</span><span> </span><span class="hs-identifier">_</span><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-388"></a><span class="hs-identifier">contIsTrivial</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-389"></a><a name="contIsTrivial"><a href="SimplUtils.html#contIsTrivial"><span class="hs-identifier">contIsTrivial</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-390"></a><span class="hs-identifier">contIsTrivial</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440129"><a href="#local-6989586621680440129"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>                       </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a><span> </span><a href="#local-6989586621680440129"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-391"></a><span class="hs-identifier">contIsTrivial</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440130"><a href="#local-6989586621680440130"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a><span> </span><a href="#local-6989586621680440130"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-392"></a><span class="hs-identifier">contIsTrivial</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440131"><a href="#local-6989586621680440131"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                                      </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contIsTrivial"><span class="hs-identifier hs-var">contIsTrivial</span></a><span> </span><a href="#local-6989586621680440131"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-393"></a><span class="hs-identifier">contIsTrivial</span><span> </span><span class="hs-identifier">_</span><span>                                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-396"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutType</span><span>
</span><a name="line-397"></a><a name="contResultType"><a href="SimplUtils.html#contResultType"><span class="hs-identifier">contResultType</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621680440132"><a href="#local-6989586621680440132"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440132"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-398"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440133"><a href="#local-6989586621680440133"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440133"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-399"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440134"><a href="#local-6989586621680440134"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440134"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-400"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440135"><a href="#local-6989586621680440135"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440135"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-401"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440136"><a href="#local-6989586621680440136"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440136"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-402"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440137"><a href="#local-6989586621680440137"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440137"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-403"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440138"><a href="#local-6989586621680440138"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440138"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-404"></a><span class="hs-identifier">contResultType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440139"><a href="#local-6989586621680440139"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contResultType"><span class="hs-identifier hs-var">contResultType</span></a><span> </span><a href="#local-6989586621680440139"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutType</span><span>
</span><a name="line-407"></a><a name="contHoleType"><a href="SimplUtils.html#contHoleType"><span class="hs-identifier">contHoleType</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621680440140"><a href="#local-6989586621680440140"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440140"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-408"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440141"><a href="#local-6989586621680440141"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621680440141"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-409"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><a name="local-6989586621680440142"><a href="#local-6989586621680440142"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pFst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coercionKind</span><span> </span><a href="#local-6989586621680440142"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440143"><a href="#local-6989586621680440143"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440144"><a href="#local-6989586621680440144"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440145"><a href="#local-6989586621680440145"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#perhapsSubstTy"><span class="hs-identifier hs-var">perhapsSubstTy</span></a><span> </span><a href="#local-6989586621680440144"><span class="hs-identifier hs-var">dup</span></a><span> </span><a href="#local-6989586621680440145"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440143"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440146"><a href="#local-6989586621680440146"><span class="hs-identifier">ai</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">funArgTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ai_type</span><span> </span><a href="#local-6989586621680440146"><span class="hs-identifier hs-var">ai</span></a><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_hole_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440147"><a href="#local-6989586621680440147"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440147"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- See Note [The hole type in ApplyToTy]</span><span>
</span><a name="line-414"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440148"><a href="#local-6989586621680440148"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440149"><a href="#local-6989586621680440149"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440150"><a href="#local-6989586621680440150"><span class="hs-identifier">dup</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440151"><a href="#local-6989586621680440151"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#perhapsSubstTy"><span class="hs-identifier hs-var">perhapsSubstTy</span></a><span> </span><a href="#local-6989586621680440150"><span class="hs-identifier hs-var">dup</span></a><span> </span><a href="#local-6989586621680440149"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621680440148"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>            </span><span class="hs-special">(</span><a href="SimplUtils.html#contHoleType"><span class="hs-identifier hs-var">contHoleType</span></a><span> </span><a href="#local-6989586621680440151"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span class="hs-identifier">contHoleType</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_dup</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440152"><a href="#local-6989586621680440152"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_bndr</span><span> </span><span class="hs-glyph">=</span><span>  </span><a name="local-6989586621680440153"><a href="#local-6989586621680440153"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440154"><a href="#local-6989586621680440154"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#perhapsSubstTy"><span class="hs-identifier hs-var">perhapsSubstTy</span></a><span> </span><a href="#local-6989586621680440152"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621680440154"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440153"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-421"></a><span class="hs-identifier">countArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- Count all arguments, including types, coercions, and other values</span><span>
</span><a name="line-423"></a><a name="countArgs"><a href="SimplUtils.html#countArgs"><span class="hs-identifier">countArgs</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440155"><a href="#local-6989586621680440155"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="SimplUtils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span> </span><a href="#local-6989586621680440155"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-424"></a><span class="hs-identifier">countArgs</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440156"><a href="#local-6989586621680440156"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="SimplUtils.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a><span> </span><a href="#local-6989586621680440156"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-425"></a><span class="hs-identifier">countArgs</span><span> </span><span class="hs-identifier">_</span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-identifier">contArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ArgSummary</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- Summarises value args, discards type args and coercions</span><span>
</span><a name="line-429"></a><span class="hs-comment">-- The returned continuation of the call is only used to</span><span>
</span><a name="line-430"></a><span class="hs-comment">-- answer questions like &quot;are you interesting?&quot;</span><span>
</span><a name="line-431"></a><a name="contArgs"><a href="SimplUtils.html#contArgs"><span class="hs-identifier">contArgs</span></a></a><span> </span><a name="local-6989586621680440157"><a href="#local-6989586621680440157"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440158"><span class="hs-identifier hs-var">lone</span></a><span> </span><a href="#local-6989586621680440157"><span class="hs-identifier hs-var">cont</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440157"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440159"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680440157"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-434"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-435"></a><span>    </span><a name="local-6989586621680440158"><a href="#local-6989586621680440158"><span class="hs-identifier">lone</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- See Note [Lone variables] in CoreUnfold</span><span>
</span><a name="line-436"></a><span>    </span><span class="hs-identifier">lone</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-437"></a><span>    </span><span class="hs-identifier">lone</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-438"></a><span>    </span><span class="hs-identifier">lone</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span>    </span><a name="local-6989586621680440159"><a href="#local-6989586621680440159"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621680440161"><a href="#local-6989586621680440161"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_arg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440162"><a href="#local-6989586621680440162"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440163"><a href="#local-6989586621680440163"><span class="hs-identifier">se</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440164"><a href="#local-6989586621680440164"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>                                        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440159"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440160"><span class="hs-identifier hs-var">is_interesting</span></a><span> </span><a href="#local-6989586621680440162"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621680440163"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680440161"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440164"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-442"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440165"><a href="#local-6989586621680440165"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440166"><a href="#local-6989586621680440166"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440159"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440165"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680440166"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-443"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440167"><a href="#local-6989586621680440167"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440168"><a href="#local-6989586621680440168"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440159"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440167"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680440168"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-444"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440169"><a href="#local-6989586621680440169"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680440170"><a href="#local-6989586621680440170"><span class="hs-identifier">k</span></a></a><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621680440169"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440170"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span>    </span><a name="local-6989586621680440160"><a href="#local-6989586621680440160"><span class="hs-identifier">is_interesting</span></a></a><span> </span><a name="local-6989586621680440171"><a href="#local-6989586621680440171"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621680440172"><a href="#local-6989586621680440172"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#interestingArg"><span class="hs-identifier hs-var">interestingArg</span></a><span> </span><a href="#local-6989586621680440172"><span class="hs-identifier hs-var">se</span></a><span> </span><a href="#local-6989586621680440171"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-447"></a><span>                   </span><span class="hs-comment">-- Do *not* use short-cutting substitution here</span><span>
</span><a name="line-448"></a><span>                   </span><span class="hs-comment">-- because we want to get as much IdInfo as possible</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-452"></a><span class="hs-identifier">mkArgInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-453"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-454"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Rules for function</span><span>
</span><a name="line-455"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>        </span><span class="hs-comment">-- Number of value args</span><span>
</span><a name="line-456"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span>  </span><span class="hs-comment">-- Context of the call</span><span>
</span><a name="line-457"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><a name="mkArgInfo"><a href="SimplUtils.html#mkArgInfo"><span class="hs-identifier">mkArgInfo</span></a></a><span> </span><a name="local-6989586621680440173"><a href="#local-6989586621680440173"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440174"><a href="#local-6989586621680440174"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621680440175"><a href="#local-6989586621680440175"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621680440176"><a href="#local-6989586621680440176"><span class="hs-identifier">n_val_args</span></a></a><span> </span><a name="local-6989586621680440177"><a href="#local-6989586621680440177"><span class="hs-identifier">call_cont</span></a></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440176"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680440174"><span class="hs-identifier hs-var">fun</span></a><span>            </span><span class="hs-comment">-- Note [Unsaturated functions]</span><span>
</span><a name="line-461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440174"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440178"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-462"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440179"><span class="hs-identifier hs-var">fun_rules</span></a><span>
</span><a name="line-463"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-464"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_strs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440182"><span class="hs-identifier hs-var">vanilla_stricts</span></a><span>
</span><a name="line-465"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_discs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440180"><span class="hs-identifier hs-var">vanilla_discounts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#ArgInfo"><span class="hs-identifier hs-var">ArgInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ai_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440174"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_type</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440178"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-468"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440179"><span class="hs-identifier hs-var">fun_rules</span></a><span>
</span><a name="line-469"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_encl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#interestingArgContext"><span class="hs-identifier hs-var">interestingArgContext</span></a><span> </span><a href="#local-6989586621680440175"><span class="hs-identifier hs-var">rules</span></a><span> </span><a href="#local-6989586621680440177"><span class="hs-identifier hs-var">call_cont</span></a><span>
</span><a name="line-470"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_strs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440183"><span class="hs-identifier hs-var">arg_stricts</span></a><span>
</span><a name="line-471"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ai_discs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440181"><span class="hs-identifier hs-var">arg_discounts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-473"></a><span>    </span><a name="local-6989586621680440178"><a href="#local-6989586621680440178"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440174"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span>    </span><a name="local-6989586621680440179"><a href="#local-6989586621680440179"><span class="hs-identifier">fun_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkFunRules"><span class="hs-identifier hs-var">mkFunRules</span></a><span> </span><a href="#local-6989586621680440175"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span>    </span><span class="hs-identifier">vanilla_discounts</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">arg_discounts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span>
</span><a name="line-478"></a><span>    </span><a name="local-6989586621680440180"><a href="#local-6989586621680440180"><span class="hs-identifier">vanilla_discounts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-479"></a><span>    </span><a name="local-6989586621680440181"><a href="#local-6989586621680440181"><span class="hs-identifier">arg_discounts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680440174"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-480"></a><span>                        </span><span class="hs-identifier hs-var">CoreUnfolding</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">uf_guidance</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">UnfIfGoodArgs</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">ug_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440185"><a href="#local-6989586621680440185"><span class="hs-identifier">discounts</span></a></a><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-481"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680440185"><span class="hs-identifier hs-var">discounts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680440180"><span class="hs-identifier hs-var">vanilla_discounts</span></a><span>
</span><a name="line-482"></a><span>                        </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680440180"><span class="hs-identifier hs-var">vanilla_discounts</span></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>    </span><span class="hs-identifier">vanilla_stricts</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">arg_stricts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-485"></a><span>    </span><a name="local-6989586621680440182"><a href="#local-6989586621680440182"><span class="hs-identifier">vanilla_stricts</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span>    </span><a name="local-6989586621680440183"><a href="#local-6989586621680440183"><span class="hs-identifier">arg_stricts</span></a></a><span>
</span><a name="line-488"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_inline</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seMode</span><span> </span><a href="#local-6989586621680440173"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440182"><span class="hs-identifier hs-var">vanilla_stricts</span></a><span> </span><span class="hs-comment">-- See Note [Do not expose strictness if sm_inline=False]</span><span>
</span><a name="line-490"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-491"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440184"><span class="hs-identifier hs-var">add_type_str</span></a><span> </span><a href="#local-6989586621680440178"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-492"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitStrictSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621680440174"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-493"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621680440186"><a href="#local-6989586621680440186"><span class="hs-identifier">demands</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440187"><a href="#local-6989586621680440187"><span class="hs-identifier">result_info</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440186"><span class="hs-identifier hs-var">demands</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440176"><span class="hs-identifier hs-var">n_val_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>                </span><span class="hs-glyph">-&gt;</span><span>      </span><span class="hs-comment">-- Enough args, use the strictness given.</span><span>
</span><a name="line-496"></a><span>                        </span><span class="hs-comment">-- For bottoming functions we used to pretend that the arg</span><span>
</span><a name="line-497"></a><span>                        </span><span class="hs-comment">-- is lazy, so that we don't treat the arg as an</span><span>
</span><a name="line-498"></a><span>                        </span><span class="hs-comment">-- interesting context.  This avoids substituting</span><span>
</span><a name="line-499"></a><span>                        </span><span class="hs-comment">-- top-level bindings for (say) strings into</span><span>
</span><a name="line-500"></a><span>                        </span><span class="hs-comment">-- calls to error.  But now we are more careful about</span><span>
</span><a name="line-501"></a><span>                        </span><span class="hs-comment">-- inlining lone variables, so its ok (see SimplUtils.analyseCont)</span><span>
</span><a name="line-502"></a><span>                   </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isBotRes</span><span> </span><a href="#local-6989586621680440187"><span class="hs-identifier hs-var">result_info</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-503"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><a href="#local-6989586621680440186"><span class="hs-identifier hs-var">demands</span></a><span>         </span><span class="hs-comment">-- Finite =&gt; result is bottom</span><span>
</span><a name="line-504"></a><span>                   </span><span class="hs-keyword">else</span><span>
</span><a name="line-505"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><a href="#local-6989586621680440186"><span class="hs-identifier hs-var">demands</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680440182"><span class="hs-identifier hs-var">vanilla_stricts</span></a><span>
</span><a name="line-506"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-507"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;More demands than arity&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">fun</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">idArity</span><span> </span><span class="hs-identifier">fun</span><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>                                </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">n_val_args</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">demands</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>                   </span><a href="#local-6989586621680440182"><span class="hs-identifier hs-var">vanilla_stricts</span></a><span>      </span><span class="hs-comment">-- Not enough args, or no strictness</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span>    </span><span class="hs-identifier">add_type_str</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-512"></a><span>    </span><span class="hs-comment">-- If the function arg types are strict, record that in the 'strictness bits'</span><span>
</span><a name="line-513"></a><span>    </span><span class="hs-comment">-- No need to instantiate because unboxed types (which dominate the strict</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-comment">--   types) can't instantiate type variables.</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-comment">-- add_type_str is done repeatedly (for each call);</span><span>
</span><a name="line-516"></a><span>    </span><span class="hs-comment">--   might be better once-for-all in the function</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-comment">-- But beware primops/datacons with no strictness</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621680440184"><a href="#local-6989586621680440184"><span class="hs-identifier">add_type_str</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-520"></a><span>    </span><span class="hs-identifier">add_type_str</span><span> </span><a name="local-6989586621680440188"><a href="#local-6989586621680440188"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621680440189"><a href="#local-6989586621680440189"><span class="hs-identifier">all_strs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621680440190"><a href="#local-6989586621680440190"><span class="hs-identifier">str</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680440191"><a href="#local-6989586621680440191"><span class="hs-identifier">strs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440192"><a href="#local-6989586621680440192"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440193"><a href="#local-6989586621680440193"><span class="hs-identifier">fun_ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621680440188"><span class="hs-identifier hs-var">fun_ty</span></a><span>        </span><span class="hs-comment">-- Add strict-type info</span><span>
</span><a name="line-522"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440190"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">isLiftedType_maybe</span><span> </span><a href="#local-6989586621680440192"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>        </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680440184"><span class="hs-identifier hs-var">add_type_str</span></a><span> </span><a href="#local-6989586621680440193"><span class="hs-identifier hs-var">fun_ty'</span></a><span> </span><a href="#local-6989586621680440191"><span class="hs-identifier hs-var">strs</span></a><span>
</span><a name="line-524"></a><span>          </span><span class="hs-comment">-- If the type is levity-polymorphic, we can't know whether it's</span><span>
</span><a name="line-525"></a><span>          </span><span class="hs-comment">-- strict. isLiftedType_maybe will return Just False only when</span><span>
</span><a name="line-526"></a><span>          </span><span class="hs-comment">-- we're sure the type is unlifted.</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680440194"><a href="#local-6989586621680440194"><span class="hs-identifier">fun_ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitForAllTy_maybe</span><span> </span><a href="#local-6989586621680440188"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-529"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440184"><span class="hs-identifier hs-var">add_type_str</span></a><span> </span><a href="#local-6989586621680440194"><span class="hs-identifier hs-var">fun_ty'</span></a><span> </span><a href="#local-6989586621680440189"><span class="hs-identifier hs-var">all_strs</span></a><span>     </span><span class="hs-comment">-- Look through foralls</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-532"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440189"><span class="hs-identifier hs-var">all_strs</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-comment">{- Note [Unsaturated functions]
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (test eyeball/inline4)
        x = a:as
        y = f x
where f has arity 2.  Then we do not want to inline 'x', because
it'll just be floated out again.  Even if f has lots of discounts
on its first argument -- it must be saturated for these to kick in

Note [Do not expose strictness if sm_inline=False]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Trac #15163 showed a case in which we had

  {-# INLINE [1] zip #-}
  zip = undefined

  {-# RULES &quot;foo&quot; forall as bs. stream (zip as bs) = ..blah... #-}

If we expose zip's bottoming nature when simplifing the LHS of the
RULE we get
  {-# RULES &quot;foo&quot; forall as bs.
                   stream (case zip of {}) = ..blah... #-}
discarding the arguments to zip.  Usually this is fine, but on the
LHS of a rule it's not, because 'as' and 'bs' are now not bound on
the LHS.

This is a pretty pathalogical example, so I'm not losing sleep over
it, but the simplest solution was to check sm_inline; if it is False,
which it is on the LHS of a rule (see updModeForRules), then don't
make use of the strictness info for the function.
-}</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Interesting arguments
*                                                                      *
************************************************************************

Note [Interesting call context]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to avoid inlining an expression where there can't possibly be
any gain, such as in an argument position.  Hence, if the continuation
is interesting (eg. a case scrutinee, application etc.) then we
inline, otherwise we don't.

Previously some_benefit used to return True only if the variable was
applied to some value arguments.  This didn't work:

        let x = _coerce_ (T Int) Int (I# 3) in
        case _coerce_ Int (T Int) x of
                I# y -&gt; ....

we want to inline x, but can't see that it's a constructor in a case
scrutinee position, and some_benefit is False.

Another example:

dMonadST = _/\_ t -&gt; :Monad (g1 _@_ t, g2 _@_ t, g3 _@_ t)

....  case dMonadST _@_ x0 of (a,b,c) -&gt; ....

we'd really like to inline dMonadST here, but we *don't* want to
inline if the case expression is just

        case x of y { DEFAULT -&gt; ... }

since we can just eliminate this case instead (x is in WHNF).  Similar
applies when x is bound to a lambda expression.  Hence
contIsInteresting looks for case expressions with just a single
default case.

Note [No case of case is boring]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see
   case f x of &lt;alts&gt;

we'd usually treat the context as interesting, to encourage 'f' to
inline.  But if case-of-case is off, it's really not so interesting
after all, because we are unlikely to be able to push the case
expression into the branches of any case in f's unfolding.  So, to
reduce unnecessary code expansion, we just make the context look boring.
This made a small compile-time perf improvement in perf/compiler/T6048,
and it looks plausible to me.
-}</span><span>
</span><a name="line-620"></a><span>
</span><a name="line-621"></a><span class="hs-identifier">interestingCallContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CallCtxt</span><span>
</span><a name="line-622"></a><span class="hs-comment">-- See Note [Interesting call context]</span><span>
</span><a name="line-623"></a><a name="interestingCallContext"><a href="SimplUtils.html#interestingCallContext"><span class="hs-identifier">interestingCallContext</span></a></a><span> </span><a name="local-6989586621680440195"><a href="#local-6989586621680440195"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440196"><a href="#local-6989586621680440196"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-624"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440197"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680440196"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-625"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-626"></a><span>    </span><a name="local-6989586621680440197"><a href="#local-6989586621680440197"><span class="hs-identifier">interesting</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">sm_case_case</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621680440195"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CaseCtxt</span><span>
</span><a name="line-628"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BoringCtxt</span><span>
</span><a name="line-629"></a><span>       </span><span class="hs-comment">-- See Note [No case of case is boring]</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValAppCtxt</span><span>
</span><a name="line-632"></a><span>        </span><span class="hs-comment">-- Can happen if we have (f Int |&gt; co) y</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-comment">-- If f has an INLINE prag we need to give it some</span><span>
</span><a name="line-634"></a><span>        </span><span class="hs-comment">-- motivation to inline. See Note [Cast then apply]</span><span>
</span><a name="line-635"></a><span>        </span><span class="hs-comment">-- in CoreUnfold</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cci</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440198"><a href="#local-6989586621680440198"><span class="hs-identifier">cci</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440198"><span class="hs-identifier hs-var">cci</span></a><span>
</span><a name="line-638"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BoringCtxt</span><span>
</span><a name="line-639"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440199"><a href="#local-6989586621680440199"><span class="hs-identifier">cci</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440199"><span class="hs-identifier hs-var">cci</span></a><span>
</span><a name="line-640"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440200"><a href="#local-6989586621680440200"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440197"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680440200"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-641"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440201"><a href="#local-6989586621680440201"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440197"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680440201"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-642"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440202"><a href="#local-6989586621680440202"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440197"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680440202"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-643"></a><span>        </span><span class="hs-comment">-- If this call is the arg of a strict function, the context</span><span>
</span><a name="line-644"></a><span>        </span><span class="hs-comment">-- is a bit interesting.  If we inline here, we may get useful</span><span>
</span><a name="line-645"></a><span>        </span><span class="hs-comment">-- evaluation information to avoid repeated evals: e.g.</span><span>
</span><a name="line-646"></a><span>        </span><span class="hs-comment">--      x + (y * z)</span><span>
</span><a name="line-647"></a><span>        </span><span class="hs-comment">-- Here the contIsInteresting makes the '*' keener to inline,</span><span>
</span><a name="line-648"></a><span>        </span><span class="hs-comment">-- which in turn exposes a constructor which makes the '+' inline.</span><span>
</span><a name="line-649"></a><span>        </span><span class="hs-comment">-- Assuming that +,* aren't small enough to inline regardless.</span><span>
</span><a name="line-650"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-651"></a><span>        </span><span class="hs-comment">-- It's also very important to inline in a strict context for things</span><span>
</span><a name="line-652"></a><span>        </span><span class="hs-comment">-- like</span><span>
</span><a name="line-653"></a><span>        </span><span class="hs-comment">--              foldr k z (f x)</span><span>
</span><a name="line-654"></a><span>        </span><span class="hs-comment">-- Here, the context of (f x) is strict, and if f's unfolding is</span><span>
</span><a name="line-655"></a><span>        </span><span class="hs-comment">-- a build it's *great* to inline it here.  So we must ensure that</span><span>
</span><a name="line-656"></a><span>        </span><span class="hs-comment">-- the context for (f x) is not totally uninteresting.</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-identifier">interestingArgContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-659"></a><span class="hs-comment">-- If the argument has form (f x y), where x,y are boring,</span><span>
</span><a name="line-660"></a><span class="hs-comment">-- and f is marked INLINE, then we don't want to inline f.</span><span>
</span><a name="line-661"></a><span class="hs-comment">-- But if the context of the argument is</span><span>
</span><a name="line-662"></a><span class="hs-comment">--      g (f x y)</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- where g has rules, then we *do* want to inline f, in case it</span><span>
</span><a name="line-664"></a><span class="hs-comment">-- exposes a rule that might fire.  Similarly, if the context is</span><span>
</span><a name="line-665"></a><span class="hs-comment">--      h (g (f x x))</span><span>
</span><a name="line-666"></a><span class="hs-comment">-- where h has rules, then we do want to inline f; hence the</span><span>
</span><a name="line-667"></a><span class="hs-comment">-- call_cont argument to interestingArgContext</span><span>
</span><a name="line-668"></a><span class="hs-comment">--</span><span>
</span><a name="line-669"></a><span class="hs-comment">-- The ai-rules flag makes this happen; if it's</span><span>
</span><a name="line-670"></a><span class="hs-comment">-- set, the inliner gets just enough keener to inline f</span><span>
</span><a name="line-671"></a><span class="hs-comment">-- regardless of how boring f's arguments are, if it's marked INLINE</span><span>
</span><a name="line-672"></a><span class="hs-comment">--</span><span>
</span><a name="line-673"></a><span class="hs-comment">-- The alternative would be to *always* inline an INLINE function,</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- regardless of how boring its context is; but that seems overkill</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- For example, it'd mean that wrapper functions were always inlined</span><span>
</span><a name="line-676"></a><span class="hs-comment">--</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- The call_cont passed to interestingArgContext is the context of</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- the call itself, e.g. g &lt;hole&gt; in the example above</span><span>
</span><a name="line-679"></a><a name="interestingArgContext"><a href="SimplUtils.html#interestingArgContext"><span class="hs-identifier">interestingArgContext</span></a></a><span> </span><a name="local-6989586621680440203"><a href="#local-6989586621680440203"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621680440204"><a href="#local-6989586621680440204"><span class="hs-identifier">call_cont</span></a></a><span>
</span><a name="line-680"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621680440203"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680440205"><span class="hs-identifier hs-var">enclosing_fn_has_rules</span></a><span>
</span><a name="line-681"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-682"></a><span>    </span><a name="local-6989586621680440205"><a href="#local-6989586621680440205"><span class="hs-identifier">enclosing_fn_has_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440204"><span class="hs-identifier hs-var">call_cont</span></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>    </span><a name="local-6989586621680440206"><a href="#local-6989586621680440206"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Select"><span class="hs-identifier hs-var">Select</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-685"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToVal"><span class="hs-identifier hs-var">ApplyToVal</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- Shouldn't really happen</span><span>
</span><a name="line-686"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#ApplyToTy"><span class="hs-identifier hs-var">ApplyToTy</span></a><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- Ditto</span><span>
</span><a name="line-687"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictArg"><span class="hs-identifier hs-var">StrictArg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sc_cci</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440208"><a href="#local-6989586621680440208"><span class="hs-identifier">cci</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440207"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680440208"><span class="hs-identifier hs-var">cci</span></a><span>
</span><a name="line-688"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#StrictBind"><span class="hs-identifier hs-var">StrictBind</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>      </span><span class="hs-comment">-- ??</span><span>
</span><a name="line-689"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#CastIt"><span class="hs-identifier hs-var">CastIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440209"><a href="#local-6989586621680440209"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440209"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-690"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440210"><a href="#local-6989586621680440210"><span class="hs-identifier">cci</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440207"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680440210"><span class="hs-identifier hs-var">cci</span></a><span>
</span><a name="line-691"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#TickIt"><span class="hs-identifier hs-var">TickIt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440211"><a href="#local-6989586621680440211"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440211"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span>    </span><a name="local-6989586621680440207"><a href="#local-6989586621680440207"><span class="hs-identifier">interesting</span></a></a><span> </span><span class="hs-identifier hs-var">RuleArgCtxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-694"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">{- Note [Interesting arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An argument is interesting if it deserves a discount for unfoldings
with a discount in that argument position.  The idea is to avoid
unfolding a function that is applied only to variables that have no
unfolding (i.e. they are probably lambda bound): f x y z There is
little point in inlining f here.

Generally, *values* (like (C a b) and (\x.e)) deserve discounts.  But
we must look through lets, eg (let x = e in C a b), because the let will
float, exposing the value, if we inline.  That makes it different to
exprIsHNF.

Before 2009 we said it was interesting if the argument had *any* structure
at all; i.e. (hasSomeUnfolding v).  But does too much inlining; see Trac #3016.

But we don't regard (f x y) as interesting, unless f is unsaturated.
If it's saturated and f hasn't inlined, then it's probably not going
to now!

Note [Conlike is interesting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        f d = ...((*) d x y)...
        ... f (df d')...
where df is con-like. Then we'd really like to inline 'f' so that the
rule for (*) (df d) can fire.  To do this
  a) we give a discount for being an argument of a class-op (eg (*) d)
  b) we say that a con-like argument (eg (df d)) is interesting
-}</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-identifier">interestingArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ArgSummary</span><span>
</span><a name="line-729"></a><span class="hs-comment">-- See Note [Interesting arguments]</span><span>
</span><a name="line-730"></a><a name="interestingArg"><a href="SimplUtils.html#interestingArg"><span class="hs-identifier">interestingArg</span></a></a><span> </span><a name="local-6989586621680440212"><a href="#local-6989586621680440212"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440213"><a href="#local-6989586621680440213"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440212"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680440213"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-731"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-732"></a><span>    </span><span class="hs-comment">-- n is # value args to which the expression is applied</span><span>
</span><a name="line-733"></a><span>    </span><a name="local-6989586621680440214"><a href="#local-6989586621680440214"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621680440216"><a href="#local-6989586621680440216"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440217"><a href="#local-6989586621680440217"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680440218"><a href="#local-6989586621680440218"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="SimplEnv.html#substId"><span class="hs-identifier hs-var">substId</span></a><span> </span><a href="#local-6989586621680440216"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440218"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-735"></a><span>           </span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621680440219"><a href="#local-6989586621680440219"><span class="hs-identifier">v'</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680440215"><span class="hs-identifier hs-var">go_var</span></a><span> </span><a href="#local-6989586621680440217"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440219"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-736"></a><span>           </span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a name="local-6989586621680440220"><a href="#local-6989586621680440220"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621680440216"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>             </span><a href="#local-6989586621680440217"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440220"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-737"></a><span>           </span><a href="SimplEnv.html#ContEx"><span class="hs-identifier hs-var">ContEx</span></a><span> </span><a name="local-6989586621680440221"><a href="#local-6989586621680440221"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680440222"><a href="#local-6989586621680440222"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621680440223"><a href="#local-6989586621680440223"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621680440224"><a href="#local-6989586621680440224"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a><span> </span><a href="#local-6989586621680440216"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440221"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680440222"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621680440223"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440217"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440224"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValueArg</span><span>
</span><a name="line-740"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TrivArg</span><span>
</span><a name="line-741"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TrivArg</span><span>
</span><a name="line-742"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440225"><a href="#local-6989586621680440225"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440226"><a href="#local-6989586621680440226"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621680440227"><a href="#local-6989586621680440227"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440225"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440226"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440227"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-743"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440228"><a href="#local-6989586621680440228"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440229"><a href="#local-6989586621680440229"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621680440230"><a href="#local-6989586621680440230"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440228"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440229"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440230"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-744"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440231"><a href="#local-6989586621680440231"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440232"><a href="#local-6989586621680440232"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440233"><a href="#local-6989586621680440233"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440231"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440232"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440233"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-745"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440234"><a href="#local-6989586621680440234"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440235"><a href="#local-6989586621680440235"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621680440236"><a href="#local-6989586621680440236"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440234"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440235"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440236"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-746"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440237"><a href="#local-6989586621680440237"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440238"><a href="#local-6989586621680440238"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621680440239"><a href="#local-6989586621680440239"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621680440240"><a href="#local-6989586621680440240"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621680440239"><span class="hs-identifier hs-var">v</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440237"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440238"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440240"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-748"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440238"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">&gt;</span><span class="hs-number">0</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonTrivArg</span><span>     </span><span class="hs-comment">-- (\x.b) e   is NonTriv</span><span>
</span><a name="line-749"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValueArg</span><span>
</span><a name="line-750"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonTrivArg</span><span>
</span><a name="line-751"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680440241"><a href="#local-6989586621680440241"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440242"><a href="#local-6989586621680440242"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a name="local-6989586621680440243"><a href="#local-6989586621680440243"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680440244"><a href="#local-6989586621680440244"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440214"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680440245"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621680440242"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680440244"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-752"></a><span>                                   </span><span class="hs-identifier hs-var">ValueArg</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ValueArg</span><span>
</span><a name="line-753"></a><span>                                   </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NonTrivArg</span><span>
</span><a name="line-754"></a><span>                               </span><span class="hs-keyword">where</span><span>
</span><a name="line-755"></a><span>                                 </span><a name="local-6989586621680440245"><a href="#local-6989586621680440245"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440241"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addNewInScopeIds"><span class="hs-identifier hs-var">addNewInScopeIds</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">bindersOf</span><span> </span><a href="#local-6989586621680440243"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-756"></a><span>
</span><a name="line-757"></a><span>    </span><a name="local-6989586621680440215"><a href="#local-6989586621680440215"><span class="hs-identifier">go_var</span></a></a><span> </span><a name="local-6989586621680440246"><a href="#local-6989586621680440246"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680440247"><a href="#local-6989586621680440247"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-758"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isConLikeId</span><span> </span><a href="#local-6989586621680440247"><span class="hs-identifier hs-var">v</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValueArg</span><span>   </span><span class="hs-comment">-- Experimenting with 'conlike' rather that</span><span>
</span><a name="line-759"></a><span>                                        </span><span class="hs-comment">--    data constructors here</span><span>
</span><a name="line-760"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680440247"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621680440246"><span class="hs-identifier hs-var">n</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValueArg</span><span>   </span><span class="hs-comment">-- Catches (eg) primops with arity but no unfolding</span><span>
</span><a name="line-761"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440246"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonTrivArg</span><span> </span><span class="hs-comment">-- Saturated or unknown call</span><span>
</span><a name="line-762"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440248"><span class="hs-identifier hs-var">conlike_unfolding</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValueArg</span><span>   </span><span class="hs-comment">-- n==0; look for an interesting unfolding</span><span>
</span><a name="line-763"></a><span>                                        </span><span class="hs-comment">-- See Note [Conlike is interesting]</span><span>
</span><a name="line-764"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TrivArg</span><span>    </span><span class="hs-comment">-- n==0, no useful unfolding</span><span>
</span><a name="line-765"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-766"></a><span>         </span><a name="local-6989586621680440248"><a href="#local-6989586621680440248"><span class="hs-identifier">conlike_unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isConLikeUnfolding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680440247"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>
</span><a name="line-768"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                  SimplMode
*                                                                      *
************************************************************************

The SimplMode controls several switches; see its definition in
CoreMonad
        sm_rules      :: Bool     -- Whether RULES are enabled
        sm_inline     :: Bool     -- Whether inlining is enabled
        sm_case_case  :: Bool     -- Whether case-of-case is enabled
        sm_eta_expand :: Bool     -- Whether eta-expansion is enabled
-}</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span class="hs-identifier">simplEnvForGHCi</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-784"></a><a name="simplEnvForGHCi"><a href="SimplUtils.html#simplEnvForGHCi"><span class="hs-identifier">simplEnvForGHCi</span></a></a><span> </span><a name="local-6989586621680440249"><a href="#local-6989586621680440249"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-785"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#mkSimplEnv"><span class="hs-identifier hs-var">mkSimplEnv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SimplMode</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_names</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;GHCi&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-786"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_phase</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InitialPhase</span><span>
</span><a name="line-787"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440249"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-788"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_rules</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440250"><span class="hs-identifier hs-var">rules_on</span></a><span>
</span><a name="line-789"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-790"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_eta_expand</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440251"><span class="hs-identifier hs-var">eta_expand_on</span></a><span>
</span><a name="line-791"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_case_case</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-792"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-793"></a><span>    </span><a name="local-6989586621680440250"><a href="#local-6989586621680440250"><span class="hs-identifier">rules_on</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EnableRewriteRules</span><span>   </span><a href="#local-6989586621680440249"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-794"></a><span>    </span><a name="local-6989586621680440251"><a href="#local-6989586621680440251"><span class="hs-identifier">eta_expand_on</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DoLambdaEtaExpansion</span><span> </span><a href="#local-6989586621680440249"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-795"></a><span>   </span><span class="hs-comment">-- Do not do any inlining, in case we expose some unboxed</span><span>
</span><a name="line-796"></a><span>   </span><span class="hs-comment">-- tuple stuff that confuses the bytecode interpreter</span><span>
</span><a name="line-797"></a><span>
</span><a name="line-798"></a><span class="hs-identifier">updModeForStableUnfoldings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Activation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span>
</span><a name="line-799"></a><span class="hs-comment">-- See Note [Simplifying inside stable unfoldings]</span><span>
</span><a name="line-800"></a><a name="updModeForStableUnfoldings"><a href="SimplUtils.html#updModeForStableUnfoldings"><span class="hs-identifier">updModeForStableUnfoldings</span></a></a><span> </span><a name="local-6989586621680440252"><a href="#local-6989586621680440252"><span class="hs-identifier">inline_rule_act</span></a></a><span> </span><a name="local-6989586621680440253"><a href="#local-6989586621680440253"><span class="hs-identifier">current_mode</span></a></a><span>
</span><a name="line-801"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440253"><span class="hs-identifier hs-var">current_mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_phase</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440254"><span class="hs-identifier hs-var">phaseFromActivation</span></a><span> </span><a href="#local-6989586621680440252"><span class="hs-identifier hs-var">inline_rule_act</span></a><span>
</span><a name="line-802"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_inline</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-803"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_eta_expand</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-804"></a><span>                     </span><span class="hs-comment">-- sm_eta_expand: see Note [No eta expansion in stable unfoldings]</span><span>
</span><a name="line-805"></a><span>       </span><span class="hs-comment">-- For sm_rules, just inherit; sm_rules might be &quot;off&quot;</span><span>
</span><a name="line-806"></a><span>       </span><span class="hs-comment">-- because of -fno-enable-rewrite-rules</span><span>
</span><a name="line-807"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-808"></a><span>    </span><a name="local-6989586621680440254"><a href="#local-6989586621680440254"><span class="hs-identifier">phaseFromActivation</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ActiveAfter</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440255"><a href="#local-6989586621680440255"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Phase</span><span> </span><a href="#local-6989586621680440255"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-809"></a><span>    </span><span class="hs-identifier">phaseFromActivation</span><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InitialPhase</span><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-identifier">updModeForRules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span>
</span><a name="line-812"></a><span class="hs-comment">-- See Note [Simplifying rules]</span><span>
</span><a name="line-813"></a><a name="updModeForRules"><a href="SimplUtils.html#updModeForRules"><span class="hs-identifier">updModeForRules</span></a></a><span> </span><a name="local-6989586621680440256"><a href="#local-6989586621680440256"><span class="hs-identifier">current_mode</span></a></a><span>
</span><a name="line-814"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440256"><span class="hs-identifier hs-var">current_mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_phase</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InitialPhase</span><span>
</span><a name="line-815"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_inline</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- See Note [Do not expose strictness if sm_inline=False]</span><span>
</span><a name="line-816"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_rules</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-817"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_eta_expand</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-comment">{- Note [Simplifying rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When simplifying a rule LHS, refrain from /any/ inlining or applying
of other RULES.

Doing anything to the LHS is plain confusing, because it means that what the
rule matches is not what the user wrote. c.f. Trac #10595, and #10528.
Moreover, inlining (or applying rules) on rule LHSs risks introducing
Ticks into the LHS, which makes matching trickier. Trac #10665, #10745.

Doing this to either side confounds tools like HERMIT, which seek to reason
about and apply the RULES as originally written. See Trac #10829.

Note [No eta expansion in stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have a stable unfolding

  f :: Ord a =&gt; a -&gt; IO ()
  -- Unfolding template
  --    = /\a \(d:Ord a) (x:a). bla

we do not want to eta-expand to

  f :: Ord a =&gt; a -&gt; IO ()
  -- Unfolding template
  --    = (/\a \(d:Ord a) (x:a) (eta:State#). bla eta) |&gt; co

because not specialisation of the overloading doesn't work properly
(see Note [Specialisation shape] in Specialise), Trac #9509.

So we disable eta-expansion in stable unfoldings.

Note [Inlining in gentle mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Something is inlined if
   (i)   the sm_inline flag is on, AND
   (ii)  the thing has an INLINE pragma, AND
   (iii) the thing is inlinable in the earliest phase.

Example of why (iii) is important:
  {-# INLINE [~1] g #-}
  g = ...

  {-# INLINE f #-}
  f x = g (g x)

If we were to inline g into f's inlining, then an importing module would
never be able to do
        f e --&gt; g (g e) ---&gt; RULE fires
because the stable unfolding for f has had g inlined into it.

On the other hand, it is bad not to do ANY inlining into an
stable unfolding, because then recursive knots in instance declarations
don't get unravelled.

However, *sometimes* SimplGently must do no call-site inlining at all
(hence sm_inline = False).  Before full laziness we must be careful
not to inline wrappers, because doing so inhibits floating
    e.g. ...(case f x of ...)...
    ==&gt; ...(case (case x of I# x# -&gt; fw x#) of ...)...
    ==&gt; ...(case x of I# x# -&gt; case fw x# of ...)...
and now the redex (f x) isn't floatable any more.

The no-inlining thing is also important for Template Haskell.  You might be
compiling in one-shot mode with -O2; but when TH compiles a splice before
running it, we don't want to use -O2.  Indeed, we don't want to inline
anything, because the byte-code interpreter might get confused about
unboxed tuples and suchlike.

Note [Simplifying inside stable unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must take care with simplification inside stable unfoldings (which come from
INLINE pragmas).

First, consider the following example
        let f = \pq -&gt; BIG
        in
        let g = \y -&gt; f y y
            {-# INLINE g #-}
        in ...g...g...g...g...g...
Now, if that's the ONLY occurrence of f, it might be inlined inside g,
and thence copied multiple times when g is inlined. HENCE we treat
any occurrence in a stable unfolding as a multiple occurrence, not a single
one; see OccurAnal.addRuleUsage.

Second, we do want *do* to some modest rules/inlining stuff in stable
unfoldings, partly to eliminate senseless crap, and partly to break
the recursive knots generated by instance declarations.

However, suppose we have
        {-# INLINE &lt;act&gt; f #-}
        f = &lt;rhs&gt;
meaning &quot;inline f in phases p where activation &lt;act&gt;(p) holds&quot;.
Then what inlinings/rules can we apply to the copy of &lt;rhs&gt; captured in
f's stable unfolding?  Our model is that literally &lt;rhs&gt; is substituted for
f when it is inlined.  So our conservative plan (implemented by
updModeForStableUnfoldings) is this:

  -------------------------------------------------------------
  When simplifying the RHS of a stable unfolding, set the phase
  to the phase in which the stable unfolding first becomes active
  -------------------------------------------------------------

That ensures that

  a) Rules/inlinings that *cease* being active before p will
     not apply to the stable unfolding, consistent with it being
     inlined in its *original* form in phase p.

  b) Rules/inlinings that only become active *after* p will
     not apply to the stable unfolding, again to be consistent with
     inlining the *original* rhs in phase p.

For example,
        {-# INLINE f #-}
        f x = ...g...

        {-# NOINLINE [1] g #-}
        g y = ...

        {-# RULE h g = ... #-}
Here we must not inline g into f's RHS, even when we get to phase 0,
because when f is later inlined into some other module we want the
rule for h to fire.

Similarly, consider
        {-# INLINE f #-}
        f x = ...g...

        g y = ...
and suppose that there are auto-generated specialisations and a strictness
wrapper for g.  The specialisations get activation AlwaysActive, and the
strictness wrapper get activation (ActiveAfter 0).  So the strictness
wrepper fails the test and won't be inlined into f's stable unfolding. That
means f can inline, expose the specialised call to g, so the specialisation
rules can fire.

A note about wrappers
~~~~~~~~~~~~~~~~~~~~~
It's also important not to inline a worker back into a wrapper.
A wrapper looks like
        wraper = inline_me (\x -&gt; ...worker... )
Normally, the inline_me prevents the worker getting inlined into
the wrapper (initially, the worker's only call site!).  But,
if the wrapper is sure to be called, the strictness analyser will
mark it 'demanded', so when the RHS is simplified, it'll get an ArgOf
continuation.
-}</span><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span class="hs-identifier">activeUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-969"></a><a name="activeUnfolding"><a href="SimplUtils.html#activeUnfolding"><span class="hs-identifier">activeUnfolding</span></a></a><span> </span><a name="local-6989586621680440257"><a href="#local-6989586621680440257"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621680440258"><a href="#local-6989586621680440258"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-970"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCompulsoryUnfolding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621680440258"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- Even sm_inline can't override compulsory unfoldings</span><span>
</span><a name="line-972"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-973"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isActive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_phase</span><span> </span><a href="#local-6989586621680440257"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlineActivation</span><span> </span><a href="#local-6989586621680440258"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">sm_inline</span><span> </span><a href="#local-6989586621680440257"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-975"></a><span>      </span><span class="hs-comment">-- `or` isStableUnfolding (realIdUnfolding id)</span><span>
</span><a name="line-976"></a><span>      </span><span class="hs-comment">-- Inline things when</span><span>
</span><a name="line-977"></a><span>      </span><span class="hs-comment">--  (a) they are active</span><span>
</span><a name="line-978"></a><span>      </span><span class="hs-comment">--  (b) sm_inline says so, except that for stable unfoldings</span><span>
</span><a name="line-979"></a><span>      </span><span class="hs-comment">--                         (ie pragmas) we inline anyway</span><span>
</span><a name="line-980"></a><span>
</span><a name="line-981"></a><span class="hs-identifier">getUnfoldingInRuleMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InScopeEnv</span><span>
</span><a name="line-982"></a><span class="hs-comment">-- When matching in RULE, we want to &quot;look through&quot; an unfolding</span><span>
</span><a name="line-983"></a><span class="hs-comment">-- (to see a constructor) if *rules* are on, even if *inlinings*</span><span>
</span><a name="line-984"></a><span class="hs-comment">-- are not.  A notable example is DFuns, which really we want to</span><span>
</span><a name="line-985"></a><span class="hs-comment">-- match in rules like (op dfun) in gentle mode. Another example</span><span>
</span><a name="line-986"></a><span class="hs-comment">-- is 'otherwise' which we want exprIsConApp_maybe to be able to</span><span>
</span><a name="line-987"></a><span class="hs-comment">-- see very early on</span><span>
</span><a name="line-988"></a><a name="getUnfoldingInRuleMatch"><a href="SimplUtils.html#getUnfoldingInRuleMatch"><span class="hs-identifier">getUnfoldingInRuleMatch</span></a></a><span> </span><a name="local-6989586621680440259"><a href="#local-6989586621680440259"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-989"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440260"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440262"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-991"></a><span>    </span><a name="local-6989586621680440260"><a href="#local-6989586621680440260"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><a href="#local-6989586621680440259"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-992"></a><span>    </span><a name="local-6989586621680440261"><a href="#local-6989586621680440261"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621680440259"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-993"></a><span>    </span><a name="local-6989586621680440262"><a href="#local-6989586621680440262"><span class="hs-identifier">id_unf</span></a></a><span> </span><a name="local-6989586621680440264"><a href="#local-6989586621680440264"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440263"><span class="hs-identifier hs-var">unf_is_active</span></a><span> </span><a href="#local-6989586621680440264"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680440264"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-994"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoUnfolding</span><span>
</span><a name="line-995"></a><span>    </span><a name="local-6989586621680440263"><a href="#local-6989586621680440263"><span class="hs-identifier">unf_is_active</span></a></a><span> </span><a name="local-6989586621680440265"><a href="#local-6989586621680440265"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-996"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_rules</span><span> </span><a href="#local-6989586621680440261"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- active_unfolding_minimal id</span><span>
</span><a name="line-997"></a><span>                             </span><span class="hs-identifier hs-var">isStableUnfolding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621680440265"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>        </span><span class="hs-comment">-- Do we even need to test this?  I think this InScopeEnv</span><span>
</span><a name="line-999"></a><span>        </span><span class="hs-comment">-- is only consulted if activeRule returns True, which</span><span>
</span><a name="line-1000"></a><span>        </span><span class="hs-comment">-- never happens if sm_rules is False</span><span>
</span><a name="line-1001"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isActive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_phase</span><span> </span><a href="#local-6989586621680440261"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlineActivation</span><span> </span><a href="#local-6989586621680440265"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1004"></a><span class="hs-identifier">activeRule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Activation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1005"></a><span class="hs-comment">-- Nothing =&gt; No rules at all</span><span>
</span><a name="line-1006"></a><a name="activeRule"><a href="SimplUtils.html#activeRule"><span class="hs-identifier">activeRule</span></a></a><span> </span><a name="local-6989586621680440266"><a href="#local-6989586621680440266"><span class="hs-identifier">mode</span></a></a><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_rules</span><span> </span><a href="#local-6989586621680440266"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>     </span><span class="hs-comment">-- Rewriting is off</span><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isActive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_phase</span><span> </span><a href="#local-6989586621680440266"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><span>
</span><a name="line-1010"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                  preInlineUnconditionally
*                                                                      *
************************************************************************

preInlineUnconditionally
~~~~~~~~~~~~~~~~~~~~~~~~
@preInlineUnconditionally@ examines a bndr to see if it is used just
once in a completely safe way, so that it is safe to discard the
binding inline its RHS at the (unique) usage site, REGARDLESS of how
big the RHS might be.  If this is the case we don't simplify the RHS
first, but just inline it un-simplified.

This is much better than first simplifying a perhaps-huge RHS and then
inlining and re-simplifying it.  Indeed, it can be at least quadratically
better.  Consider

        x1 = e1
        x2 = e2[x1]
        x3 = e3[x2]
        ...etc...
        xN = eN[xN-1]

We may end up simplifying e1 N times, e2 N-1 times, e3 N-3 times etc.
This can happen with cascades of functions too:

        f1 = \x1.e1
        f2 = \xs.e2[f1]
        f3 = \xs.e3[f3]
        ...etc...

THE MAIN INVARIANT is this:

        ----  preInlineUnconditionally invariant -----
   IF preInlineUnconditionally chooses to inline x = &lt;rhs&gt;
   THEN doing the inlining should not change the occurrence
        info for the free vars of &lt;rhs&gt;
        ----------------------------------------------

For example, it's tempting to look at trivial binding like
        x = y
and inline it unconditionally.  But suppose x is used many times,
but this is the unique occurrence of y.  Then inlining x would change
y's occurrence info, which breaks the invariant.  It matters: y
might have a BIG rhs, which will now be dup'd at every occurrenc of x.


Even RHSs labelled InlineMe aren't caught here, because there might be
no benefit from inlining at the call site.

[Sept 01] Don't unconditionally inline a top-level thing, because that
can simply make a static thing into something built dynamically.  E.g.
        x = (a,b)
        main = \s -&gt; h x

[Remember that we treat \s as a one-shot lambda.]  No point in
inlining x unless there is something interesting about the call site.

But watch out: if you aren't careful, some useful foldr/build fusion
can be lost (most notably in spectral/hartel/parstof) because the
foldr didn't see the build.  Doing the dynamic allocation isn't a big
deal, in fact, but losing the fusion can be.  But the right thing here
seems to be to do a callSiteInline based on the fact that there is
something interesting about the call site (it's strict).  Hmm.  That
seems a bit fragile.

Conclusion: inline top level things gaily until Phase 0 (the last
phase), at which point don't.

Note [pre/postInlineUnconditionally in gentle mode]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Even in gentle mode we want to do preInlineUnconditionally.  The
reason is that too little clean-up happens if you don't inline
use-once things.  Also a bit of inlining is *good* for full laziness;
it can expose constant sub-expressions.  Example in
spectral/mandel/Mandel.hs, where the mandelset function gets a useful
let-float if you inline windowToViewport

However, as usual for Gentle mode, do not inline things that are
inactive in the initial stages.  See Note [Gentle mode].

Note [Stable unfoldings and preInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Surprisingly, do not pre-inline-unconditionally Ids with INLINE pragmas!
Example

   {-# INLINE f #-}
   f :: Eq a =&gt; a -&gt; a
   f x = ...

   fInt :: Int -&gt; Int
   fInt = f Int dEqInt

   ...fInt...fInt...fInt...

Here f occurs just once, in the RHS of fInt. But if we inline it there
it might make fInt look big, and we'll lose the opportunity to inline f
at each of fInt's call sites.  The INLINE pragma will only inline when
the application is saturated for exactly this reason; and we don't
want PreInlineUnconditionally to second-guess it.  A live example is
Trac #3736.
    c.f. Note [Stable unfoldings and postInlineUnconditionally]

NB: if the pragma is INLINEABLE, then we don't want to behave in
this special way -- an INLINEABLE pragma just says to GHC &quot;inline this
if you like&quot;.  But if there is a unique occurrence, we want to inline
the stable unfolding, not the RHS.

Note [Top-level bottoming Ids]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Don't inline top-level Ids that are bottoming, even if they are used just
once, because FloatOut has gone to some trouble to extract them out.
Inlining them won't make the program run faster!

Note [Do not inline CoVars unconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Coercion variables appear inside coercions, and the RHS of a let-binding
is a term (not a coercion) so we can't necessarily inline the latter in
the former.
-}</span><span>
</span><a name="line-1132"></a><span>
</span><a name="line-1133"></a><span class="hs-identifier">preInlineUnconditionally</span><span>
</span><a name="line-1134"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span>
</span><a name="line-1135"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#StaticEnv"><span class="hs-identifier hs-type">StaticEnv</span></a><span>  </span><span class="hs-comment">-- These two go together</span><span>
</span><a name="line-1136"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>       </span><span class="hs-comment">-- Returned env has extended substitution</span><span>
</span><a name="line-1137"></a><span class="hs-comment">-- Precondition: rhs satisfies the let/app invariant</span><span>
</span><a name="line-1138"></a><span class="hs-comment">-- See Note [CoreSyn let/app invariant] in CoreSyn</span><span>
</span><a name="line-1139"></a><span class="hs-comment">-- Reason: we don't want to inline single uses, or discard dead bindings,</span><span>
</span><a name="line-1140"></a><span class="hs-comment">--         for unlifted, side-effect-ful bindings</span><span>
</span><a name="line-1141"></a><a name="preInlineUnconditionally"><a href="SimplUtils.html#preInlineUnconditionally"><span class="hs-identifier">preInlineUnconditionally</span></a></a><span> </span><a name="local-6989586621680440267"><a href="#local-6989586621680440267"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440268"><a href="#local-6989586621680440268"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621680440269"><a href="#local-6989586621680440269"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440270"><a href="#local-6989586621680440270"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621680440271"><a href="#local-6989586621680440271"><span class="hs-identifier">rhs_env</span></a></a><span>
</span><a name="line-1142"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680440275"><span class="hs-identifier hs-var">pre_inline_unconditionally</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1143"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680440277"><span class="hs-identifier hs-var">active</span></a><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1144"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621680440268"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isBottomingId</span><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- Note [Top-level bottoming Ids]</span><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCoVar</span><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- Note [Do not inline CoVars unconditionally]</span><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SimplUtils.html#isExitJoinId"><span class="hs-identifier hs-var">isExitJoinId</span></a><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- Note [Do not inline exit join points]</span><span>
</span><a name="line-1147"></a><span>                                                       </span><span class="hs-comment">-- in module Exitify</span><span>
</span><a name="line-1148"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440274"><span class="hs-identifier hs-var">one_occ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idOccInfo</span><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1149"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStableUnfolding</span><span> </span><a href="#local-6989586621680440272"><span class="hs-identifier hs-var">unf</span></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440273"><span class="hs-identifier hs-var">extend_subst_with</span></a><span> </span><a href="#local-6989586621680440270"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1150"></a><span>
</span><a name="line-1151"></a><span>  </span><span class="hs-comment">-- Note [Stable unfoldings and preInlineUnconditionally]</span><span>
</span><a name="line-1152"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isInlinablePragma</span><span> </span><a href="#local-6989586621680440278"><span class="hs-identifier hs-var">inline_prag</span></a><span>
</span><a name="line-1153"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680440288"><a href="#local-6989586621680440288"><span class="hs-identifier">inl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span><span> </span><a href="#local-6989586621680440272"><span class="hs-identifier hs-var">unf</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440273"><span class="hs-identifier hs-var">extend_subst_with</span></a><span> </span><a href="#local-6989586621680440288"><span class="hs-identifier hs-var">inl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1156"></a><span>    </span><a name="local-6989586621680440272"><a href="#local-6989586621680440272"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1157"></a><span>    </span><a name="local-6989586621680440273"><a href="#local-6989586621680440273"><span class="hs-identifier">extend_subst_with</span></a></a><span> </span><a name="local-6989586621680440281"><a href="#local-6989586621680440281"><span class="hs-identifier">inl_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><a href="#local-6989586621680440267"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#mkContEx"><span class="hs-identifier hs-var">mkContEx</span></a><span> </span><a href="#local-6989586621680440271"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680440281"><span class="hs-identifier hs-var">inl_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>    </span><a name="local-6989586621680440274"><a href="#local-6989586621680440274"><span class="hs-identifier">one_occ</span></a></a><span> </span><span class="hs-identifier hs-var">IAmDead</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- Happens in ((\x.1) v)</span><span>
</span><a name="line-1160"></a><span>    </span><span class="hs-identifier">one_occ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OneOcc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_br</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>      </span><span class="hs-comment">-- One textual occurrence</span><span>
</span><a name="line-1161"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440282"><a href="#local-6989586621680440282"><span class="hs-identifier">in_lam</span></a></a><span>
</span><a name="line-1162"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_int_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440283"><a href="#local-6989586621680440283"><span class="hs-identifier">int_cxt</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1163"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680440282"><span class="hs-identifier hs-var">in_lam</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isNotTopLevel</span><span> </span><a href="#local-6989586621680440268"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680440280"><span class="hs-identifier hs-var">early_phase</span></a><span>
</span><a name="line-1164"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440283"><span class="hs-identifier hs-var">int_cxt</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440279"><span class="hs-identifier hs-var">canInlineInLam</span></a><span> </span><a href="#local-6989586621680440270"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1165"></a><span>    </span><span class="hs-identifier">one_occ</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span>    </span><a name="local-6989586621680440275"><a href="#local-6989586621680440275"><span class="hs-identifier">pre_inline_unconditionally</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SimplPreInlining</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#seDynFlags"><span class="hs-identifier hs-var">seDynFlags</span></a><span> </span><a href="#local-6989586621680440267"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1168"></a><span>    </span><a name="local-6989586621680440276"><a href="#local-6989586621680440276"><span class="hs-identifier">mode</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621680440267"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1169"></a><span>    </span><a name="local-6989586621680440277"><a href="#local-6989586621680440277"><span class="hs-identifier">active</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isActive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_phase</span><span> </span><a href="#local-6989586621680440276"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">inlinePragmaActivation</span><span> </span><a href="#local-6989586621680440278"><span class="hs-identifier hs-var">inline_prag</span></a><span class="hs-special">)</span><span>
</span><a name="line-1170"></a><span>             </span><span class="hs-comment">-- See Note [pre/postInlineUnconditionally in gentle mode]</span><span>
</span><a name="line-1171"></a><span>    </span><a name="local-6989586621680440278"><a href="#local-6989586621680440278"><span class="hs-identifier">inline_prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621680440269"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1172"></a><span>
</span><a name="line-1173"></a><span class="hs-comment">-- Be very careful before inlining inside a lambda, because (a) we must not</span><span>
</span><a name="line-1174"></a><span class="hs-comment">-- invalidate occurrence information, and (b) we want to avoid pushing a</span><span>
</span><a name="line-1175"></a><span class="hs-comment">-- single allocation (here) into multiple allocations (inside lambda).</span><span>
</span><a name="line-1176"></a><span class="hs-comment">-- Inlining a *function* with a single *saturated* call would be ok, mind you.</span><span>
</span><a name="line-1177"></a><span class="hs-comment">--      || (if is_cheap &amp;&amp; not (canInlineInLam rhs) then pprTrace &quot;preinline&quot; (ppr bndr &lt;+&gt; ppr rhs) ok else ok)</span><span>
</span><a name="line-1178"></a><span class="hs-comment">--      where</span><span>
</span><a name="line-1179"></a><span class="hs-comment">--              is_cheap = exprIsCheap rhs</span><span>
</span><a name="line-1180"></a><span class="hs-comment">--              ok = is_cheap &amp;&amp; int_cxt</span><span>
</span><a name="line-1181"></a><span>
</span><a name="line-1182"></a><span>        </span><span class="hs-comment">--      int_cxt         The context isn't totally boring</span><span>
</span><a name="line-1183"></a><span>        </span><span class="hs-comment">-- E.g. let f = \ab.BIG in \y. map f xs</span><span>
</span><a name="line-1184"></a><span>        </span><span class="hs-comment">--      Don't want to substitute for f, because then we allocate</span><span>
</span><a name="line-1185"></a><span>        </span><span class="hs-comment">--      its closure every time the \y is called</span><span>
</span><a name="line-1186"></a><span>        </span><span class="hs-comment">-- But: let f = \ab.BIG in \y. map (f y) xs</span><span>
</span><a name="line-1187"></a><span>        </span><span class="hs-comment">--      Now we do want to substitute for f, even though it's not</span><span>
</span><a name="line-1188"></a><span>        </span><span class="hs-comment">--      saturated, because we're going to allocate a closure for</span><span>
</span><a name="line-1189"></a><span>        </span><span class="hs-comment">--      (f y) every time round the loop anyhow.</span><span>
</span><a name="line-1190"></a><span>
</span><a name="line-1191"></a><span>        </span><span class="hs-comment">-- canInlineInLam =&gt; free vars of rhs are (Once in_lam) or Many,</span><span>
</span><a name="line-1192"></a><span>        </span><span class="hs-comment">-- so substituting rhs inside a lambda doesn't change the occ info.</span><span>
</span><a name="line-1193"></a><span>        </span><span class="hs-comment">-- Sadly, not quite the same as exprIsHNF.</span><span>
</span><a name="line-1194"></a><span>    </span><a name="local-6989586621680440279"><a href="#local-6989586621680440279"><span class="hs-identifier">canInlineInLam</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1195"></a><span>    </span><span class="hs-identifier">canInlineInLam</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621680440284"><a href="#local-6989586621680440284"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680440285"><a href="#local-6989586621680440285"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isRuntimeVar</span><span> </span><a href="#local-6989586621680440284"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680440279"><span class="hs-identifier hs-var">canInlineInLam</span></a><span> </span><a href="#local-6989586621680440285"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1196"></a><span>    </span><span class="hs-identifier">canInlineInLam</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621680440286"><a href="#local-6989586621680440286"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680440287"><a href="#local-6989586621680440287"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tickishIsCode</span><span> </span><a href="#local-6989586621680440286"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440279"><span class="hs-identifier hs-var">canInlineInLam</span></a><span> </span><a href="#local-6989586621680440287"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1197"></a><span>    </span><span class="hs-identifier">canInlineInLam</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1198"></a><span>      </span><span class="hs-comment">-- not ticks.  Counting ticks cannot be duplicated, and non-counting</span><span>
</span><a name="line-1199"></a><span>      </span><span class="hs-comment">-- ticks around a Lam will disappear anyway.</span><span>
</span><a name="line-1200"></a><span>
</span><a name="line-1201"></a><span>    </span><a name="local-6989586621680440280"><a href="#local-6989586621680440280"><span class="hs-identifier">early_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">sm_phase</span><span> </span><a href="#local-6989586621680440276"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1202"></a><span>                    </span><span class="hs-identifier hs-var">Phase</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1203"></a><span>                    </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1204"></a><span class="hs-comment">-- If we don't have this early_phase test, consider</span><span>
</span><a name="line-1205"></a><span class="hs-comment">--      x = length [1,2,3]</span><span>
</span><a name="line-1206"></a><span class="hs-comment">-- The full laziness pass carefully floats all the cons cells to</span><span>
</span><a name="line-1207"></a><span class="hs-comment">-- top level, and preInlineUnconditionally floats them all back in.</span><span>
</span><a name="line-1208"></a><span class="hs-comment">-- Result is (a) static allocation replaced by dynamic allocation</span><span>
</span><a name="line-1209"></a><span class="hs-comment">--           (b) many simplifier iterations because this tickles</span><span>
</span><a name="line-1210"></a><span class="hs-comment">--               a related problem; only one inlining per pass</span><span>
</span><a name="line-1211"></a><span class="hs-comment">--</span><span>
</span><a name="line-1212"></a><span class="hs-comment">-- On the other hand, I have seen cases where top-level fusion is</span><span>
</span><a name="line-1213"></a><span class="hs-comment">-- lost if we don't inline top level thing (e.g. string constants)</span><span>
</span><a name="line-1214"></a><span class="hs-comment">-- Hence the test for phase zero (which is the phase for all the final</span><span>
</span><a name="line-1215"></a><span class="hs-comment">-- simplifications).  Until phase zero we take no special notice of</span><span>
</span><a name="line-1216"></a><span class="hs-comment">-- top level things, but then we become more leery about inlining</span><span>
</span><a name="line-1217"></a><span class="hs-comment">-- them.</span><span>
</span><a name="line-1218"></a><span>
</span><a name="line-1219"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                  postInlineUnconditionally
*                                                                      *
************************************************************************

postInlineUnconditionally
~~~~~~~~~~~~~~~~~~~~~~~~~
@postInlineUnconditionally@ decides whether to unconditionally inline
a thing based on the form of its RHS; in particular if it has a
trivial RHS.  If so, we can inline and discard the binding altogether.

NB: a loop breaker has must_keep_binding = True and non-loop-breakers
only have *forward* references. Hence, it's safe to discard the binding

NOTE: This isn't our last opportunity to inline.  We're at the binding
site right now, and we'll get another opportunity when we get to the
occurrence(s)

Note that we do this unconditional inlining only for trival RHSs.
Don't inline even WHNFs inside lambdas; doing so may simply increase
allocation when the function is called. This isn't the last chance; see
NOTE above.

NB: Even inline pragmas (e.g. IMustBeINLINEd) are ignored here Why?
Because we don't even want to inline them into the RHS of constructor
arguments. See NOTE above

NB: At one time even NOINLINE was ignored here: if the rhs is trivial
it's best to inline it anyway.  We often get a=E; b=a from desugaring,
with both a and b marked NOINLINE.  But that seems incompatible with
our new view that inlining is like a RULE, so I'm sticking to the 'active'
story for now.
-}</span><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><span class="hs-identifier">postInlineUnconditionally</span><span>
</span><a name="line-1256"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>
</span><a name="line-1257"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>            </span><span class="hs-comment">-- The binder (*not* a CoVar), including its unfolding</span><span>
</span><a name="line-1258"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccInfo</span><span>          </span><span class="hs-comment">-- From the InId</span><span>
</span><a name="line-1259"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-1260"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1261"></a><span class="hs-comment">-- Precondition: rhs satisfies the let/app invariant</span><span>
</span><a name="line-1262"></a><span class="hs-comment">-- See Note [CoreSyn let/app invariant] in CoreSyn</span><span>
</span><a name="line-1263"></a><span class="hs-comment">-- Reason: we don't want to inline single uses, or discard dead bindings,</span><span>
</span><a name="line-1264"></a><span class="hs-comment">--         for unlifted, side-effect-ful bindings</span><span>
</span><a name="line-1265"></a><a name="postInlineUnconditionally"><a href="SimplUtils.html#postInlineUnconditionally"><span class="hs-identifier">postInlineUnconditionally</span></a></a><span> </span><a name="local-6989586621680440289"><a href="#local-6989586621680440289"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440290"><a href="#local-6989586621680440290"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621680440291"><a href="#local-6989586621680440291"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440292"><a href="#local-6989586621680440292"><span class="hs-identifier">occ_info</span></a></a><span> </span><a name="local-6989586621680440293"><a href="#local-6989586621680440293"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1266"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680440296"><span class="hs-identifier hs-var">active</span></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1267"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWeakLoopBreaker</span><span> </span><a href="#local-6989586621680440292"><span class="hs-identifier hs-var">occ_info</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- If it's a loop-breaker of any kind, don't inline</span><span>
</span><a name="line-1268"></a><span>                                        </span><span class="hs-comment">-- because it might be referred to &quot;earlier&quot;</span><span>
</span><a name="line-1269"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isStableUnfolding</span><span> </span><a href="#local-6989586621680440294"><span class="hs-identifier hs-var">unfolding</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- Note [Stable unfoldings and postInlineUnconditionally]</span><span>
</span><a name="line-1270"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621680440290"><span class="hs-identifier hs-var">top_lvl</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- Note [Top level and postInlineUnconditionally]</span><span>
</span><a name="line-1271"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span> </span><a href="#local-6989586621680440293"><span class="hs-identifier hs-var">rhs</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1272"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1273"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440292"><span class="hs-identifier hs-var">occ_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1274"></a><span>        </span><span class="hs-comment">-- The point of examining occ_info here is that for *non-values*</span><span>
</span><a name="line-1275"></a><span>        </span><span class="hs-comment">-- that occur outside a lambda, the call-site inliner won't have</span><span>
</span><a name="line-1276"></a><span>        </span><span class="hs-comment">-- a chance (because it doesn't know that the thing</span><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-comment">-- only occurs once).   The pre-inliner won't have gotten</span><span>
</span><a name="line-1278"></a><span>        </span><span class="hs-comment">-- it either, if the thing occurs in more than one branch</span><span>
</span><a name="line-1279"></a><span>        </span><span class="hs-comment">-- So the main target is things like</span><span>
</span><a name="line-1280"></a><span>        </span><span class="hs-comment">--      let x = f y in</span><span>
</span><a name="line-1281"></a><span>        </span><span class="hs-comment">--      case v of</span><span>
</span><a name="line-1282"></a><span>        </span><span class="hs-comment">--         True  -&gt; case x of ...</span><span>
</span><a name="line-1283"></a><span>        </span><span class="hs-comment">--         False -&gt; case x of ...</span><span>
</span><a name="line-1284"></a><span>        </span><span class="hs-comment">-- This is very important in practice; e.g. wheel-seive1 doubles</span><span>
</span><a name="line-1285"></a><span>        </span><span class="hs-comment">-- in allocation if you miss this out</span><span>
</span><a name="line-1286"></a><span>      </span><span class="hs-identifier hs-var">OneOcc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440297"><a href="#local-6989586621680440297"><span class="hs-identifier">in_lam</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_int_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680440298"><a href="#local-6989586621680440298"><span class="hs-identifier">int_cxt</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1287"></a><span>               </span><span class="hs-comment">-- OneOcc =&gt; no code-duplication issue</span><span>
</span><a name="line-1288"></a><span>        </span><span class="hs-glyph">-&gt;</span><span>     </span><span class="hs-identifier hs-var">smallEnoughToInline</span><span> </span><a href="#local-6989586621680440295"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440294"><span class="hs-identifier hs-var">unfolding</span></a><span>     </span><span class="hs-comment">-- Small enough to dup</span><span>
</span><a name="line-1289"></a><span>                        </span><span class="hs-comment">-- ToDo: consider discount on smallEnoughToInline if int_cxt is true</span><span>
</span><a name="line-1290"></a><span>                        </span><span class="hs-comment">--</span><span>
</span><a name="line-1291"></a><span>                        </span><span class="hs-comment">-- NB: Do NOT inline arbitrarily big things, even if one_br is True</span><span>
</span><a name="line-1292"></a><span>                        </span><span class="hs-comment">-- Reason: doing so risks exponential behaviour.  We simplify a big</span><span>
</span><a name="line-1293"></a><span>                        </span><span class="hs-comment">--         expression, inline it, and simplify it again.  But if the</span><span>
</span><a name="line-1294"></a><span>                        </span><span class="hs-comment">--         very same thing happens in the big expression, we get</span><span>
</span><a name="line-1295"></a><span>                        </span><span class="hs-comment">--         exponential cost!</span><span>
</span><a name="line-1296"></a><span>                        </span><span class="hs-comment">-- PRINCIPLE: when we've already simplified an expression once,</span><span>
</span><a name="line-1297"></a><span>                        </span><span class="hs-comment">-- make sure that we only inline it if it's reasonably small.</span><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span>           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680440297"><span class="hs-identifier hs-var">in_lam</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1300"></a><span>                        </span><span class="hs-comment">-- Outside a lambda, we want to be reasonably aggressive</span><span>
</span><a name="line-1301"></a><span>                        </span><span class="hs-comment">-- about inlining into multiple branches of case</span><span>
</span><a name="line-1302"></a><span>                        </span><span class="hs-comment">-- e.g. let x = &lt;non-value&gt;</span><span>
</span><a name="line-1303"></a><span>                        </span><span class="hs-comment">--      in case y of { C1 -&gt; ..x..; C2 -&gt; ..x..; C3 -&gt; ... }</span><span>
</span><a name="line-1304"></a><span>                        </span><span class="hs-comment">-- Inlining can be a big win if C3 is the hot-spot, even if</span><span>
</span><a name="line-1305"></a><span>                        </span><span class="hs-comment">-- the uses in C1, C2 are not 'interesting'</span><span>
</span><a name="line-1306"></a><span>                        </span><span class="hs-comment">-- An example that gets worse if you add int_cxt here is 'clausify'</span><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCheapUnfolding</span><span> </span><a href="#local-6989586621680440294"><span class="hs-identifier hs-var">unfolding</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440298"><span class="hs-identifier hs-var">int_cxt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1309"></a><span>                        </span><span class="hs-comment">-- isCheap =&gt; acceptable work duplication; in_lam may be true</span><span>
</span><a name="line-1310"></a><span>                        </span><span class="hs-comment">-- int_cxt to prevent us inlining inside a lambda without some</span><span>
</span><a name="line-1311"></a><span>                        </span><span class="hs-comment">-- good reason.  See the notes on int_cxt in preInlineUnconditionally</span><span>
</span><a name="line-1312"></a><span>
</span><a name="line-1313"></a><span>      </span><span class="hs-identifier hs-var">IAmDead</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- This happens; for example, the case_bndr during case of</span><span>
</span><a name="line-1314"></a><span>                        </span><span class="hs-comment">-- known constructor:  case (a,b) of x { (p,q) -&gt; ... }</span><span>
</span><a name="line-1315"></a><span>                        </span><span class="hs-comment">-- Here x isn't mentioned in the RHS, so we don't want to</span><span>
</span><a name="line-1316"></a><span>                        </span><span class="hs-comment">-- create the (dead) let-binding  let x = (a,b) in ...</span><span>
</span><a name="line-1317"></a><span>
</span><a name="line-1318"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1319"></a><span>
</span><a name="line-1320"></a><span class="hs-comment">-- Here's an example that we don't handle well:</span><span>
</span><a name="line-1321"></a><span class="hs-comment">--      let f = if b then Left (\x.BIG) else Right (\y.BIG)</span><span>
</span><a name="line-1322"></a><span class="hs-comment">--      in \y. ....case f of {...} ....</span><span>
</span><a name="line-1323"></a><span class="hs-comment">-- Here f is used just once, and duplicating the case work is fine (exprIsCheap).</span><span>
</span><a name="line-1324"></a><span class="hs-comment">-- But</span><span>
</span><a name="line-1325"></a><span class="hs-comment">--  - We can't preInlineUnconditionally because that woud invalidate</span><span>
</span><a name="line-1326"></a><span class="hs-comment">--    the occ info for b.</span><span>
</span><a name="line-1327"></a><span class="hs-comment">--  - We can't postInlineUnconditionally because the RHS is big, and</span><span>
</span><a name="line-1328"></a><span class="hs-comment">--    that risks exponential behaviour</span><span>
</span><a name="line-1329"></a><span class="hs-comment">--  - We can't call-site inline, because the rhs is big</span><span>
</span><a name="line-1330"></a><span class="hs-comment">-- Alas!</span><span>
</span><a name="line-1331"></a><span>
</span><a name="line-1332"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1333"></a><span>    </span><a name="local-6989586621680440294"><a href="#local-6989586621680440294"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680440291"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1334"></a><span>    </span><a name="local-6989586621680440295"><a href="#local-6989586621680440295"><span class="hs-identifier">dflags</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#seDynFlags"><span class="hs-identifier hs-var">seDynFlags</span></a><span> </span><a href="#local-6989586621680440289"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1335"></a><span>    </span><a name="local-6989586621680440296"><a href="#local-6989586621680440296"><span class="hs-identifier">active</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isActive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sm_phase</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621680440289"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlineActivation</span><span> </span><a href="#local-6989586621680440291"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1336"></a><span>        </span><span class="hs-comment">-- See Note [pre/postInlineUnconditionally in gentle mode]</span><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span class="hs-comment">{-
Note [Top level and postInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't do postInlineUnconditionally for top-level things (even for
ones that are trivial):

  * Doing so will inline top-level error expressions that have been
    carefully floated out by FloatOut.  More generally, it might
    replace static allocation with dynamic.

  * Even for trivial expressions there's a problem.  Consider
      {-# RULE &quot;foo&quot; forall (xs::[T]). reverse xs = ruggle xs #-}
      blah xs = reverse xs
      ruggle = sort
    In one simplifier pass we might fire the rule, getting
      blah xs = ruggle xs
    but in *that* simplifier pass we must not do postInlineUnconditionally
    on 'ruggle' because then we'll have an unbound occurrence of 'ruggle'

    If the rhs is trivial it'll be inlined by callSiteInline, and then
    the binding will be dead and discarded by the next use of OccurAnal

  * There is less point, because the main goal is to get rid of local
    bindings used in multiple case branches.

  * The inliner should inline trivial things at call sites anyway.

  * The Id might be exported.  We could check for that separately,
    but since we aren't going to postInlineUnconditionally /any/
    top-level bindings, we don't need to test.

Note [Stable unfoldings and postInlineUnconditionally]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Do not do postInlineUnconditionally if the Id has a stable unfolding,
otherwise we lose the unfolding.  Example

     -- f has stable unfolding with rhs (e |&gt; co)
     --   where 'e' is big
     f = e |&gt; co

Then there's a danger we'll optimise to

     f' = e
     f = f' |&gt; co

and now postInlineUnconditionally, losing the stable unfolding on f.  Now f'
won't inline because 'e' is too big.

    c.f. Note [Stable unfoldings and preInlineUnconditionally]


************************************************************************
*                                                                      *
        Rebuilding a lambda
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1395"></a><span>
</span><a name="line-1396"></a><span class="hs-identifier">mkLam</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplUtils.html#SimplCont"><span class="hs-identifier hs-type">SimplCont</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-1397"></a><span class="hs-comment">-- mkLam tries three things</span><span>
</span><a name="line-1398"></a><span class="hs-comment">--      a) eta reduction, if that gives a trivial expression</span><span>
</span><a name="line-1399"></a><span class="hs-comment">--      b) eta expansion [only if there are some value lambdas]</span><span>
</span><a name="line-1400"></a><span>
</span><a name="line-1401"></a><a name="mkLam"><a href="SimplUtils.html#mkLam"><span class="hs-identifier">mkLam</span></a></a><span> </span><a name="local-6989586621680440299"><a href="#local-6989586621680440299"><span class="hs-identifier">_env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621680440300"><a href="#local-6989586621680440300"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621680440301"><a href="#local-6989586621680440301"><span class="hs-identifier">_cont</span></a></a><span>
</span><a name="line-1402"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680440300"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1403"></a><span class="hs-identifier">mkLam</span><span> </span><a name="local-6989586621680440302"><a href="#local-6989586621680440302"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680440303"><a href="#local-6989586621680440303"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621680440304"><a href="#local-6989586621680440304"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621680440305"><a href="#local-6989586621680440305"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-1404"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440330"><a href="#local-6989586621680440330"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1405"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680440306"><span class="hs-identifier hs-var">mkLam'</span></a><span> </span><a href="#local-6989586621680440330"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440303"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440304"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1406"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1407"></a><span>    </span><span class="hs-identifier">mkLam'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-1408"></a><span>    </span><a name="local-6989586621680440306"><a href="#local-6989586621680440306"><span class="hs-identifier">mkLam'</span></a></a><span> </span><a name="local-6989586621680440307"><a href="#local-6989586621680440307"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440308"><a href="#local-6989586621680440308"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621680440309"><a href="#local-6989586621680440309"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621680440310"><a href="#local-6989586621680440310"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1409"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621680440312"><span class="hs-identifier hs-var">bad</span></a><span> </span><a href="#local-6989586621680440308"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1410"></a><span>        </span><span class="hs-comment">-- Note [Casts and lambdas]</span><span>
</span><a name="line-1411"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440314"><a href="#local-6989586621680440314"><span class="hs-identifier">lam</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680440306"><span class="hs-identifier hs-var">mkLam'</span></a><span> </span><a href="#local-6989586621680440307"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440308"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440309"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1412"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCast</span><span> </span><a href="#local-6989586621680440314"><span class="hs-identifier hs-var">lam</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPiCos</span><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><a href="#local-6989586621680440308"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440310"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1413"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1414"></a><span>        </span><a name="local-6989586621680440311"><a href="#local-6989586621680440311"><span class="hs-identifier">co_vars</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfCo</span><span> </span><a href="#local-6989586621680440310"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1415"></a><span>        </span><a name="local-6989586621680440312"><a href="#local-6989586621680440312"><span class="hs-identifier">bad</span></a></a><span> </span><a name="local-6989586621680440313"><a href="#local-6989586621680440313"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isCoVar</span><span> </span><a href="#local-6989586621680440313"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440313"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440311"><span class="hs-identifier hs-var">co_vars</span></a><span>
</span><a name="line-1416"></a><span>
</span><a name="line-1417"></a><span>    </span><span class="hs-identifier">mkLam'</span><span> </span><a name="local-6989586621680440315"><a href="#local-6989586621680440315"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440316"><a href="#local-6989586621680440316"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621680440317"><a href="#local-6989586621680440317"><span class="hs-identifier">body</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1418"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440306"><span class="hs-identifier hs-var">mkLam'</span></a><span> </span><a href="#local-6989586621680440315"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440316"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680440318"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440319"><span class="hs-identifier hs-var">body1</span></a><span>
</span><a name="line-1419"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1420"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680440318"><a href="#local-6989586621680440318"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440319"><a href="#local-6989586621680440319"><span class="hs-identifier">body1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectBinders</span><span> </span><a href="#local-6989586621680440317"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1421"></a><span>
</span><a name="line-1422"></a><span>    </span><span class="hs-identifier">mkLam'</span><span> </span><a name="local-6989586621680440320"><a href="#local-6989586621680440320"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440321"><a href="#local-6989586621680440321"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621680440322"><a href="#local-6989586621680440322"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680440323"><a href="#local-6989586621680440323"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1423"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tickishFloatable</span><span> </span><a href="#local-6989586621680440322"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1424"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621680440322"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621680440306"><span class="hs-identifier hs-var">mkLam'</span></a><span> </span><a href="#local-6989586621680440320"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440321"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440323"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1425"></a><span>
</span><a name="line-1426"></a><span>    </span><span class="hs-identifier">mkLam'</span><span> </span><a name="local-6989586621680440324"><a href="#local-6989586621680440324"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440325"><a href="#local-6989586621680440325"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621680440326"><a href="#local-6989586621680440326"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1427"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DoEtaReduction</span><span> </span><a href="#local-6989586621680440324"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1428"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680440327"><a href="#local-6989586621680440327"><span class="hs-identifier">etad_lam</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryEtaReduce</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440326"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1429"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EtaReduction</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1430"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680440327"><span class="hs-identifier hs-var">etad_lam</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1431"></a><span>
</span><a name="line-1432"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#contIsRhs"><span class="hs-identifier hs-var">contIsRhs</span></a><span> </span><a href="#local-6989586621680440305"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- See Note [Eta-expanding lambdas]</span><span>
</span><a name="line-1433"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_eta_expand</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span> </span><a href="#local-6989586621680440302"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1434"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isRuntimeVar</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1435"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680440328"><a href="#local-6989586621680440328"><span class="hs-identifier">body_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprEtaExpandArity</span><span> </span><a href="#local-6989586621680440324"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440326"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1436"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440328"><span class="hs-identifier hs-var">body_arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1437"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EtaExpansion</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680440329"><a href="#local-6989586621680440329"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">etaExpand</span><span> </span><a href="#local-6989586621680440328"><span class="hs-identifier hs-var">body_arity</span></a><span> </span><a href="#local-6989586621680440326"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-1439"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="SimplMonad.html#traceSmpl"><span class="hs-identifier hs-var">traceSmpl</span></a><span> </span><span class="hs-string">&quot;eta expand&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;before&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440326"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-1440"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;after&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680440329"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1441"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680440329"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1442"></a><span>
</span><a name="line-1443"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1444"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680440325"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680440326"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-1445"></a><span>
</span><a name="line-1446"></a><span class="hs-comment">{-
Note [Eta expanding lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general we *do* want to eta-expand lambdas. Consider
   f (\x -&gt; case x of (a,b) -&gt; \s -&gt; blah)
where 's' is a state token, and hence can be eta expanded.  This
showed up in the code for GHc.IO.Handle.Text.hPutChar, a rather
important function!

The eta-expansion will never happen unless we do it now.  (Well, it's
possible that CorePrep will do it, but CorePrep only has a half-baked
eta-expander that can't deal with casts.  So it's much better to do it
here.)

However, when the lambda is let-bound, as the RHS of a let, we have a
better eta-expander (in the form of tryEtaExpandRhs), so we don't
bother to try expansion in mkLam in that case; hence the contIsRhs
guard.

NB: We check the SimplEnv (sm_eta_expand), not DynFlags.
    See Note [No eta expansion in stable unfoldings]

Note [Casts and lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        (\x. (\y. e) `cast` g1) `cast` g2
There is a danger here that the two lambdas look separated, and the
full laziness pass might float an expression to between the two.

So this equation in mkLam' floats the g1 out, thus:
        (\x. e `cast` g1)  --&gt;  (\x.e) `cast` (tx -&gt; g1)
where x:tx.

In general, this floats casts outside lambdas, where (I hope) they
might meet and cancel with some other cast:
        \x. e `cast` co   ===&gt;   (\x. e) `cast` (tx -&gt; co)
        /\a. e `cast` co  ===&gt;   (/\a. e) `cast` (/\a. co)
        /\g. e `cast` co  ===&gt;   (/\g. e) `cast` (/\g. co)
                          (if not (g `in` co))

Notice that it works regardless of 'e'.  Originally it worked only
if 'e' was itself a lambda, but in some cases that resulted in
fruitless iteration in the simplifier.  A good example was when
compiling Text.ParserCombinators.ReadPrec, where we had a definition
like    (\x. Get `cast` g)
where Get is a constructor with nonzero arity.  Then mkLam eta-expanded
the Get, and the next iteration eta-reduced it, and then eta-expanded
it again.

Note also the side condition for the case of coercion binders.
It does not make sense to transform
        /\g. e `cast` g  ==&gt;  (/\g.e) `cast` (/\g.g)
because the latter is not well-kinded.

************************************************************************
*                                                                      *
              Eta expansion
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span class="hs-identifier">tryEtaExpandRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-1508"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Arity</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1509"></a><span class="hs-comment">-- See Note [Eta-expanding at let bindings]</span><span>
</span><a name="line-1510"></a><span class="hs-comment">-- If tryEtaExpandRhs rhs = (n, is_bot, rhs') then</span><span>
</span><a name="line-1511"></a><span class="hs-comment">--   (a) rhs' has manifest arity</span><span>
</span><a name="line-1512"></a><span class="hs-comment">--   (b) if is_bot is True then rhs' applied to n args is guaranteed bottom</span><span>
</span><a name="line-1513"></a><a name="tryEtaExpandRhs"><a href="SimplUtils.html#tryEtaExpandRhs"><span class="hs-identifier">tryEtaExpandRhs</span></a></a><span> </span><a name="local-6989586621680440331"><a href="#local-6989586621680440331"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621680440332"><a href="#local-6989586621680440332"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440333"><a href="#local-6989586621680440333"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1514"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680440342"><a href="#local-6989586621680440342"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isJoinId_maybe</span><span> </span><a href="#local-6989586621680440332"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440343"><a href="#local-6989586621680440343"><span class="hs-identifier">join_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440344"><a href="#local-6989586621680440344"><span class="hs-identifier">join_body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectNBinders</span><span> </span><a href="#local-6989586621680440342"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1516"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621680440343"><span class="hs-identifier hs-var">join_bndrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprIsBottom</span><span> </span><a href="#local-6989586621680440344"><span class="hs-identifier hs-var">join_body</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1517"></a><span>         </span><span class="hs-comment">-- Note [Do not eta-expand join points]</span><span>
</span><a name="line-1518"></a><span>         </span><span class="hs-comment">-- But do return the correct arity and bottom-ness, because</span><span>
</span><a name="line-1519"></a><span>         </span><span class="hs-comment">-- these are used to set the bndr's IdInfo (Trac #15517)</span><span>
</span><a name="line-1520"></a><span>
</span><a name="line-1521"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1522"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440345"><a href="#local-6989586621680440345"><span class="hs-identifier">new_arity</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440346"><a href="#local-6989586621680440346"><span class="hs-identifier">is_bot</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440347"><a href="#local-6989586621680440347"><span class="hs-identifier">new_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680440334"><span class="hs-identifier hs-var">try_expand</span></a><span>
</span><a name="line-1523"></a><span>
</span><a name="line-1524"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">new_arity</span><span> </span><a href="#local-6989586621680440345"><span class="hs-operator hs-var">&lt;</span></a><span> </span><span class="hs-identifier">old_id_arity</span><span class="hs-special">,</span><span>
</span><a name="line-1525"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Arity decrease:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">old_id_arity</span><span>
</span><a name="line-1526"></a><span>                </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">old_arity</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">new_arity</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">new_rhs</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1527"></a><span>                        </span><span class="hs-comment">-- Note [Arity decrease] in Simplify</span><span>
</span><a name="line-1528"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440345"><span class="hs-identifier hs-var">new_arity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440346"><span class="hs-identifier hs-var">is_bot</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440347"><span class="hs-identifier hs-var">new_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1529"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1530"></a><span>    </span><a name="local-6989586621680440334"><a href="#local-6989586621680440334"><span class="hs-identifier">try_expand</span></a></a><span>
</span><a name="line-1531"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1532"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprArity</span><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1533"></a><span>
</span><a name="line-1534"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">sm_eta_expand</span><span> </span><a href="#local-6989586621680440331"><span class="hs-identifier hs-var">mode</span></a><span>      </span><span class="hs-comment">-- Provided eta-expansion is on</span><span>
</span><a name="line-1535"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440341"><span class="hs-identifier hs-var">new_arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621680440336"><span class="hs-identifier hs-var">old_arity</span></a><span>   </span><span class="hs-comment">-- And the current manifest arity isn't enough</span><span>
</span><a name="line-1536"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EtaExpansion</span><span> </span><a href="#local-6989586621680440332"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1537"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440341"><span class="hs-identifier hs-var">new_arity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440339"><span class="hs-identifier hs-var">is_bot</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">etaExpand</span><span> </span><a href="#local-6989586621680440341"><span class="hs-identifier hs-var">new_arity</span></a><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1538"></a><span>
</span><a name="line-1539"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1540"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440336"><span class="hs-identifier hs-var">old_arity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440339"><span class="hs-identifier hs-var">is_bot</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440341"><span class="hs-identifier hs-var">new_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680440336"><span class="hs-identifier hs-var">old_arity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1541"></a><span>
</span><a name="line-1542"></a><span>    </span><a name="local-6989586621680440335"><a href="#local-6989586621680440335"><span class="hs-identifier">dflags</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sm_dflags</span><span> </span><a href="#local-6989586621680440331"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-1543"></a><span>    </span><a name="local-6989586621680440336"><a href="#local-6989586621680440336"><span class="hs-identifier">old_arity</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprArity</span><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-comment">-- See Note [Do not expand eta-expand PAPs]</span><span>
</span><a name="line-1544"></a><span>    </span><a name="local-6989586621680440337"><a href="#local-6989586621680440337"><span class="hs-identifier">old_id_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680440332"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1545"></a><span>
</span><a name="line-1546"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680440338"><a href="#local-6989586621680440338"><span class="hs-identifier">new_arity1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440339"><a href="#local-6989586621680440339"><span class="hs-identifier">is_bot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findRhsArity</span><span> </span><a href="#local-6989586621680440335"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440332"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680440333"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680440336"><span class="hs-identifier hs-var">old_arity</span></a><span>
</span><a name="line-1547"></a><span>    </span><a name="local-6989586621680440340"><a href="#local-6989586621680440340"><span class="hs-identifier">new_arity2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idCallArity</span><span> </span><a href="#local-6989586621680440332"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1548"></a><span>    </span><a name="local-6989586621680440341"><a href="#local-6989586621680440341"><span class="hs-identifier">new_arity</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-6989586621680440338"><span class="hs-identifier hs-var">new_arity1</span></a><span> </span><a href="#local-6989586621680440340"><span class="hs-identifier hs-var">new_arity2</span></a><span>
</span><a name="line-1549"></a><span>
</span><a name="line-1550"></a><span class="hs-comment">{-
Note [Eta-expanding at let bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We now eta expand at let-bindings, which is where the payoff comes.
The most significant thing is that we can do a simple arity analysis
(in CoreArity.findRhsArity), which we can't do for free-floating lambdas

One useful consequence of not eta-expanding lambdas is this example:
   genMap :: C a =&gt; ...
   {-# INLINE genMap #-}
   genMap f xs = ...

   myMap :: D a =&gt; ...
   {-# INLINE myMap #-}
   myMap = genMap

Notice that 'genMap' should only inline if applied to two arguments.
In the stable unfolding for myMap we'll have the unfolding
    (\d -&gt; genMap Int (..d..))
We do not want to eta-expand to
    (\d f xs -&gt; genMap Int (..d..) f xs)
because then 'genMap' will inline, and it really shouldn't: at least
as far as the programmer is concerned, it's not applied to two
arguments!

Note [Do not eta-expand join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Similarly to CPR (see Note [Don't CPR join points] in WorkWrap), a join point
stands well to gain from its outer binding's eta-expansion, and eta-expanding a
join point is fraught with issues like how to deal with a cast:

    let join $j1 :: IO ()
             $j1 = ...
             $j2 :: Int -&gt; IO ()
             $j2 n = if n &gt; 0 then $j1
                              else ...

    =&gt;

    let join $j1 :: IO ()
             $j1 = (\eta -&gt; ...)
                     `cast` N:IO :: State# RealWorld -&gt; (# State# RealWorld, ())
                                 ~  IO ()
             $j2 :: Int -&gt; IO ()
             $j2 n = (\eta -&gt; if n &gt; 0 then $j1
                                       else ...)
                     `cast` N:IO :: State# RealWorld -&gt; (# State# RealWorld, ())
                                 ~  IO ()

The cast here can't be pushed inside the lambda (since it's not casting to a
function type), so the lambda has to stay, but it can't because it contains a
reference to a join point. In fact, $j2 can't be eta-expanded at all. Rather
than try and detect this situation (and whatever other situations crop up!), we
don't bother; again, any surrounding eta-expansion will improve these join
points anyway, since an outer cast can *always* be pushed inside. By the time
CorePrep comes around, the code is very likely to look more like this:

    let join $j1 :: State# RealWorld -&gt; (# State# RealWorld, ())
             $j1 = (...) eta
             $j2 :: Int -&gt; State# RealWorld -&gt; (# State# RealWorld, ())
             $j2 = if n &gt; 0 then $j1
                            else (...) eta

Note [Do not eta-expand PAPs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to have old_arity = manifestArity rhs, which meant that we
would eta-expand even PAPs.  But this gives no particular advantage,
and can lead to a massive blow-up in code size, exhibited by Trac #9020.
Suppose we have a PAP
    foo :: IO ()
    foo = returnIO ()
Then we can eta-expand do
    foo = (\eta. (returnIO () |&gt; sym g) eta) |&gt; g
where
    g :: IO () ~ State# RealWorld -&gt; (# State# RealWorld, () #)

But there is really no point in doing this, and it generates masses of
coercions and whatnot that eventually disappear again. For T9020, GHC
allocated 6.6G beore, and 0.8G afterwards; and residency dropped from
1.8G to 45M.

But note that this won't eta-expand, say
  f = \g -&gt; map g
Does it matter not eta-expanding such functions?  I'm not sure.  Perhaps
strictness analysis will have less to bite on?


************************************************************************
*                                                                      *
\subsection{Floating lets out of big lambdas}
*                                                                      *
************************************************************************

Note [Floating and type abstraction]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:
        x = /\a. C e1 e2
We'd like to float this to
        y1 = /\a. e1
        y2 = /\a. e2
        x  = /\a. C (y1 a) (y2 a)
for the usual reasons: we want to inline x rather vigorously.

You may think that this kind of thing is rare.  But in some programs it is
common.  For example, if you do closure conversion you might get:

        data a :-&gt; b = forall e. (e -&gt; a -&gt; b) :$ e

        f_cc :: forall a. a :-&gt; a
        f_cc = /\a. (\e. id a) :$ ()

Now we really want to inline that f_cc thing so that the
construction of the closure goes away.

So I have elaborated simplLazyBind to understand right-hand sides that look
like
        /\ a1..an. body

and treat them specially. The real work is done in SimplUtils.abstractFloats,
but there is quite a bit of plumbing in simplLazyBind as well.

The same transformation is good when there are lets in the body:

        /\abc -&gt; let(rec) x = e in b
   ==&gt;
        let(rec) x' = /\abc -&gt; let x = x' a b c in e
        in
        /\abc -&gt; let x = x' a b c in b

This is good because it can turn things like:

        let f = /\a -&gt; letrec g = ... g ... in g
into
        letrec g' = /\a -&gt; ... g' a ...
        in
        let f = /\ a -&gt; g' a

which is better.  In effect, it means that big lambdas don't impede
let-floating.

This optimisation is CRUCIAL in eliminating the junk introduced by
desugaring mutually recursive definitions.  Don't eliminate it lightly!

[May 1999]  If we do this transformation *regardless* then we can
end up with some pretty silly stuff.  For example,

        let
            st = /\ s -&gt; let { x1=r1 ; x2=r2 } in ...
        in ..
becomes
        let y1 = /\s -&gt; r1
            y2 = /\s -&gt; r2
            st = /\s -&gt; ...[y1 s/x1, y2 s/x2]
        in ..

Unless the &quot;...&quot; is a WHNF there is really no point in doing this.
Indeed it can make things worse.  Suppose x1 is used strictly,
and is of the form

        x1* = case f y of { (a,b) -&gt; e }

If we abstract this wrt the tyvar we then can't do the case inline
as we would normally do.

That's why the whole transformation is part of the same process that
floats let-bindings and constructor arguments out of RHSs.  In particular,
it is guarded by the doFloatFromRhs call in simplLazyBind.

Note [Which type variables to abstract over]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Abstract only over the type variables free in the rhs wrt which the
new binding is abstracted.  Note that

  * The naive approach of abstracting wrt the
    tyvars free in the Id's /type/ fails. Consider:
        /\ a b -&gt; let t :: (a,b) = (e1, e2)
                      x :: a     = fst t
                  in ...
    Here, b isn't free in x's type, but we must nevertheless
    abstract wrt b as well, because t's type mentions b.
    Since t is floated too, we'd end up with the bogus:
         poly_t = /\ a b -&gt; (e1, e2)
         poly_x = /\ a   -&gt; fst (poly_t a *b*)

  * We must do closeOverKinds.  Example (Trac #10934):
       f = /\k (f:k-&gt;*) (a:k). let t = AccFailure @ (f a) in ...
    Here we want to float 't', but we must remember to abstract over
    'k' as well, even though it is not explicitly mentioned in the RHS,
    otherwise we get
       t = /\ (f:k-&gt;*) (a:k). AccFailure @ (f a)
    which is obviously bogus.
-}</span><span>
</span><a name="line-1742"></a><span>
</span><a name="line-1743"></a><span class="hs-identifier">abstractFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-1744"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutBind</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1745"></a><a name="abstractFloats"><a href="SimplUtils.html#abstractFloats"><span class="hs-identifier">abstractFloats</span></a></a><span> </span><a name="local-6989586621680440348"><a href="#local-6989586621680440348"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440349"><a href="#local-6989586621680440349"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621680440350"><a href="#local-6989586621680440350"><span class="hs-identifier">main_tvs</span></a></a><span> </span><a name="local-6989586621680440351"><a href="#local-6989586621680440351"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621680440352"><a href="#local-6989586621680440352"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">body_floats</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1747"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNilOL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-identifier">floats</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1748"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440393"><a href="#local-6989586621680440393"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440394"><a href="#local-6989586621680440394"><span class="hs-identifier">float_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="#local-6989586621680440357"><span class="hs-identifier hs-var">abstract</span></a><span> </span><a href="#local-6989586621680440356"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621680440355"><span class="hs-identifier hs-var">body_floats</span></a><span>
</span><a name="line-1749"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440394"><span class="hs-identifier hs-var">float_binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;abstract_floats1&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440393"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680440352"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1750"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1751"></a><span>    </span><a name="local-6989586621680440353"><a href="#local-6989586621680440353"><span class="hs-identifier">is_top_lvl</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621680440349"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-1752"></a><span>    </span><a name="local-6989586621680440354"><a href="#local-6989586621680440354"><span class="hs-identifier">main_tv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621680440350"><span class="hs-identifier hs-var">main_tvs</span></a><span>
</span><a name="line-1753"></a><span>    </span><a name="local-6989586621680440355"><a href="#local-6989586621680440355"><span class="hs-identifier">body_floats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#letFloatBinds"><span class="hs-identifier hs-var">letFloatBinds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sfLetFloats</span><span> </span><a href="#local-6989586621680440351"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1754"></a><span>    </span><a name="local-6989586621680440356"><a href="#local-6989586621680440356"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.mkEmptySubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sfInScope</span><span> </span><a href="#local-6989586621680440351"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1755"></a><span>
</span><a name="line-1756"></a><span>    </span><span class="hs-identifier">abstract</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreSubst.Subst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreSubst.Subst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span class="hs-special">)</span><span>
</span><a name="line-1757"></a><span>    </span><a name="local-6989586621680440357"><a href="#local-6989586621680440357"><span class="hs-identifier">abstract</span></a></a><span> </span><a name="local-6989586621680440360"><a href="#local-6989586621680440360"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680440361"><a href="#local-6989586621680440361"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680440362"><a href="#local-6989586621680440362"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1758"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440365"><a href="#local-6989586621680440365"><span class="hs-identifier">poly_id1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440366"><a href="#local-6989586621680440366"><span class="hs-identifier">poly_app</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680440358"><span class="hs-identifier hs-var">mk_poly1</span></a><span> </span><a href="#local-6989586621680440364"><span class="hs-identifier hs-var">tvs_here</span></a><span> </span><a href="#local-6989586621680440361"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1759"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440367"><a href="#local-6989586621680440367"><span class="hs-identifier">poly_id2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440368"><a href="#local-6989586621680440368"><span class="hs-identifier">poly_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440359"><span class="hs-identifier hs-var">mk_poly2</span></a><span> </span><a href="#local-6989586621680440365"><span class="hs-identifier hs-var">poly_id1</span></a><span> </span><a href="#local-6989586621680440364"><span class="hs-identifier hs-var">tvs_here</span></a><span> </span><a href="#local-6989586621680440363"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-1760"></a><span>                 </span><a name="local-6989586621680440369"><a href="#local-6989586621680440369"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.extendIdSubst</span><span> </span><a href="#local-6989586621680440360"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680440361"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680440366"><span class="hs-identifier hs-var">poly_app</span></a><span>
</span><a name="line-1761"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440369"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680440367"><span class="hs-identifier hs-var">poly_id2</span></a><span> </span><a href="#local-6989586621680440368"><span class="hs-identifier hs-var">poly_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1762"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1763"></a><span>        </span><a name="local-6989586621680440363"><a href="#local-6989586621680440363"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;abstract_floats2&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440360"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680440362"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1764"></a><span>
</span><a name="line-1765"></a><span>        </span><span class="hs-comment">-- tvs_here: see Note [Which type variables to abstract over]</span><span>
</span><a name="line-1766"></a><span>        </span><a name="local-6989586621680440364"><a href="#local-6989586621680440364"><span class="hs-identifier">tvs_here</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1767"></a><span>                   </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440354"><span class="hs-identifier hs-var">main_tv_set</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1768"></a><span>                   </span><span class="hs-identifier hs-var">closeOverKindsList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1769"></a><span>                   </span><span class="hs-identifier hs-var">exprSomeFreeVarsList</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621680440363"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span>    </span><span class="hs-identifier">abstract</span><span> </span><a name="local-6989586621680440370"><a href="#local-6989586621680440370"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621680440371"><a href="#local-6989586621680440371"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1772"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440375"><a href="#local-6989586621680440375"><span class="hs-identifier">poly_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440376"><a href="#local-6989586621680440376"><span class="hs-identifier">poly_apps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440358"><span class="hs-identifier hs-var">mk_poly1</span></a><span> </span><a href="#local-6989586621680440374"><span class="hs-identifier hs-var">tvs_here</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440372"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-1773"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680440377"><a href="#local-6989586621680440377"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.extendSubstList</span><span> </span><a href="#local-6989586621680440370"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440372"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440376"><span class="hs-identifier hs-var">poly_apps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1774"></a><span>                  </span><a name="local-6989586621680440378"><a href="#local-6989586621680440378"><span class="hs-identifier">poly_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680440359"><span class="hs-identifier hs-var">mk_poly2</span></a><span> </span><a href="#local-6989586621680440379"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621680440374"><span class="hs-identifier hs-var">tvs_here</span></a><span> </span><a href="#local-6989586621680440381"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-1775"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440379"><a href="#local-6989586621680440379"><span class="hs-identifier">poly_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440380"><a href="#local-6989586621680440380"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680440375"><span class="hs-identifier hs-var">poly_ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440373"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-1776"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680440381"><a href="#local-6989586621680440381"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;abstract_floats&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1777"></a><span>                                                                </span><a href="#local-6989586621680440377"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621680440380"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1778"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440377"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621680440378"><span class="hs-identifier hs-var">poly_pairs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1779"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-1780"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621680440372"><a href="#local-6989586621680440372"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><a name="local-6989586621680440373"><a href="#local-6989586621680440373"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680440371"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-1781"></a><span>                </span><span class="hs-comment">-- For a recursive group, it's a bit of a pain to work out the minimal</span><span>
</span><a name="line-1782"></a><span>                </span><span class="hs-comment">-- set of tyvars over which to abstract:</span><span>
</span><a name="line-1783"></a><span>                </span><span class="hs-comment">--      /\ a b c.  let x = ...a... in</span><span>
</span><a name="line-1784"></a><span>                </span><span class="hs-comment">--                 letrec { p = ...x...q...</span><span>
</span><a name="line-1785"></a><span>                </span><span class="hs-comment">--                          q = .....p...b... } in</span><span>
</span><a name="line-1786"></a><span>                </span><span class="hs-comment">--                 ...</span><span>
</span><a name="line-1787"></a><span>                </span><span class="hs-comment">-- Since 'x' is abstracted over 'a', the {p,q} group must be abstracted</span><span>
</span><a name="line-1788"></a><span>                </span><span class="hs-comment">-- over 'a' (because x is replaced by (poly_x a)) as well as 'b'.</span><span>
</span><a name="line-1789"></a><span>                </span><span class="hs-comment">-- Since it's a pain, we just use the whole set, which is always safe</span><span>
</span><a name="line-1790"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-1791"></a><span>                </span><span class="hs-comment">-- If you ever want to be more selective, remember this bizarre case too:</span><span>
</span><a name="line-1792"></a><span>                </span><span class="hs-comment">--      x::a = x</span><span>
</span><a name="line-1793"></a><span>                </span><span class="hs-comment">-- Here, we must abstract 'x' over 'a'.</span><span>
</span><a name="line-1794"></a><span>         </span><a name="local-6989586621680440374"><a href="#local-6989586621680440374"><span class="hs-identifier">tvs_here</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span> </span><a href="#local-6989586621680440350"><span class="hs-identifier hs-var">main_tvs</span></a><span>
</span><a name="line-1795"></a><span>
</span><a name="line-1796"></a><span>    </span><span class="hs-identifier">mk_poly1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1797"></a><span>    </span><a name="local-6989586621680440358"><a href="#local-6989586621680440358"><span class="hs-identifier">mk_poly1</span></a></a><span> </span><a name="local-6989586621680440382"><a href="#local-6989586621680440382"><span class="hs-identifier">tvs_here</span></a></a><span> </span><a name="local-6989586621680440383"><a href="#local-6989586621680440383"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-1798"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440384"><a href="#local-6989586621680440384"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-1799"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621680440385"><a href="#local-6989586621680440385"><span class="hs-identifier">poly_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setNameUnique</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680440383"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440384"><span class="hs-identifier hs-var">uniq</span></a><span>           </span><span class="hs-comment">-- Keep same name</span><span>
</span><a name="line-1800"></a><span>                  </span><a name="local-6989586621680440386"><a href="#local-6989586621680440386"><span class="hs-identifier">poly_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621680440382"><span class="hs-identifier hs-var">tvs_here</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440383"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- But new type of course</span><span>
</span><a name="line-1801"></a><span>                  </span><a name="local-6989586621680440387"><a href="#local-6989586621680440387"><span class="hs-identifier">poly_id</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">transferPolyIdInfo</span><span> </span><a href="#local-6989586621680440383"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680440382"><span class="hs-identifier hs-var">tvs_here</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- Note [transferPolyIdInfo] in Id.hs</span><span>
</span><a name="line-1802"></a><span>                              </span><span class="hs-identifier hs-var">mkLocalIdOrCoVar</span><span> </span><a href="#local-6989586621680440385"><span class="hs-identifier hs-var">poly_name</span></a><span> </span><a href="#local-6989586621680440386"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-1803"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440387"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680440387"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621680440382"><span class="hs-identifier hs-var">tvs_here</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1804"></a><span>                </span><span class="hs-comment">-- In the olden days, it was crucial to copy the occInfo of the original var,</span><span>
</span><a name="line-1805"></a><span>                </span><span class="hs-comment">-- because we were looking at occurrence-analysed but as yet unsimplified code!</span><span>
</span><a name="line-1806"></a><span>                </span><span class="hs-comment">-- In particular, we mustn't lose the loop breakers.  BUT NOW we are looking</span><span>
</span><a name="line-1807"></a><span>                </span><span class="hs-comment">-- at already simplified code, so it doesn't matter</span><span>
</span><a name="line-1808"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-1809"></a><span>                </span><span class="hs-comment">-- It's even right to retain single-occurrence or dead-var info:</span><span>
</span><a name="line-1810"></a><span>                </span><span class="hs-comment">-- Suppose we started with  /\a -&gt; let x = E in B</span><span>
</span><a name="line-1811"></a><span>                </span><span class="hs-comment">-- where x occurs once in B. Then we transform to:</span><span>
</span><a name="line-1812"></a><span>                </span><span class="hs-comment">--      let x' = /\a -&gt; E in /\a -&gt; let x* = x' a in B</span><span>
</span><a name="line-1813"></a><span>                </span><span class="hs-comment">-- where x* has an INLINE prag on it.  Now, once x* is inlined,</span><span>
</span><a name="line-1814"></a><span>                </span><span class="hs-comment">-- the occurrences of x' will be just the occurrences originally</span><span>
</span><a name="line-1815"></a><span>                </span><span class="hs-comment">-- pinned on x.</span><span>
</span><a name="line-1816"></a><span>
</span><a name="line-1817"></a><span>    </span><span class="hs-identifier">mk_poly2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1818"></a><span>    </span><a name="local-6989586621680440359"><a href="#local-6989586621680440359"><span class="hs-identifier">mk_poly2</span></a></a><span> </span><a name="local-6989586621680440388"><a href="#local-6989586621680440388"><span class="hs-identifier">poly_id</span></a></a><span> </span><a name="local-6989586621680440389"><a href="#local-6989586621680440389"><span class="hs-identifier">tvs_here</span></a></a><span> </span><a name="local-6989586621680440390"><a href="#local-6989586621680440390"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1819"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440388"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680440392"><span class="hs-identifier hs-var">unf</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440391"><span class="hs-identifier hs-var">poly_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1820"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1821"></a><span>        </span><a name="local-6989586621680440391"><a href="#local-6989586621680440391"><span class="hs-identifier">poly_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680440389"><span class="hs-identifier hs-var">tvs_here</span></a><span> </span><a href="#local-6989586621680440390"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1822"></a><span>        </span><a name="local-6989586621680440392"><a href="#local-6989586621680440392"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUnfolding</span><span> </span><a href="#local-6989586621680440348"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">InlineRhs</span><span> </span><a href="#local-6989586621680440353"><span class="hs-identifier hs-var">is_top_lvl</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680440391"><span class="hs-identifier hs-var">poly_rhs</span></a><span>
</span><a name="line-1823"></a><span>
</span><a name="line-1824"></a><span>        </span><span class="hs-comment">-- We want the unfolding.  Consider</span><span>
</span><a name="line-1825"></a><span>        </span><span class="hs-comment">--      let</span><span>
</span><a name="line-1826"></a><span>        </span><span class="hs-comment">--            x = /\a. let y = ... in Just y</span><span>
</span><a name="line-1827"></a><span>        </span><span class="hs-comment">--      in body</span><span>
</span><a name="line-1828"></a><span>        </span><span class="hs-comment">-- Then we float the y-binding out (via abstractFloats and addPolyBind)</span><span>
</span><a name="line-1829"></a><span>        </span><span class="hs-comment">-- but 'x' may well then be inlined in 'body' in which case we'd like the</span><span>
</span><a name="line-1830"></a><span>        </span><span class="hs-comment">-- opportunity to inline 'y' too.</span><span>
</span><a name="line-1831"></a><span>
</span><a name="line-1832"></a><span class="hs-comment">{-
Note [Abstract over coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a coercion variable (g :: a ~ Int) is free in the RHS, then so is the
type variable a.  Rather than sort this mess out, we simply bale out and abstract
wrt all the type variables if any of them are coercion variables.


Historical note: if you use let-bindings instead of a substitution, beware of this:

                -- Suppose we start with:
                --
                --      x = /\ a -&gt; let g = G in E
                --
                -- Then we'll float to get
                --
                --      x = let poly_g = /\ a -&gt; G
                --          in /\ a -&gt; let g = poly_g a in E
                --
                -- But now the occurrence analyser will see just one occurrence
                -- of poly_g, not inside a lambda, so the simplifier will
                -- PreInlineUnconditionally poly_g back into g!  Badk to square 1!
                -- (I used to think that the &quot;don't inline lone occurrences&quot; stuff
                --  would stop this happening, but since it's the *only* occurrence,
                --  PreInlineUnconditionally kicks in first!)
                --
                -- Solution: put an INLINE note on g's RHS, so that poly_g seems
                --           to appear many times.  (NB: mkInlineMe eliminates
                --           such notes on trivial RHSs, so do it manually.)

************************************************************************
*                                                                      *
                prepareAlts
*                                                                      *
************************************************************************

prepareAlts tries these things:

1.  Eliminate alternatives that cannot match, including the
    DEFAULT alternative.

2.  If the DEFAULT alternative can match only one possible constructor,
    then make that constructor explicit.
    e.g.
        case e of x { DEFAULT -&gt; rhs }
     ===&gt;
        case e of x { (a,b) -&gt; rhs }
    where the type is a single constructor type.  This gives better code
    when rhs also scrutinises x or e.

3. Returns a list of the constructors that cannot holds in the
   DEFAULT alternative (if there is one)

Here &quot;cannot match&quot; includes knowledge from GADTs

It's a good idea to do this stuff before simplifying the alternatives, to
avoid simplifying alternatives we know can't happen, and to come up with
the list of constructors that are handled, to put into the IdInfo of the
case binder, for use when simplifying the alternatives.

Eliminating the default alternative in (1) isn't so obvious, but it can
happen:

data Colour = Red | Green | Blue

f x = case x of
        Red -&gt; ..
        Green -&gt; ..
        DEFAULT -&gt; h x

h y = case y of
        Blue -&gt; ..
        DEFAULT -&gt; [ case y of ... ]

If we inline h into f, the default case of the inlined h can't happen.
If we don't notice this, we may end up filtering out *all* the cases
of the inner case y, which give us nowhere to go!
-}</span><span>
</span><a name="line-1910"></a><span>
</span><a name="line-1911"></a><span class="hs-identifier">prepareAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InAlt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">AltCon</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InAlt</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1912"></a><span class="hs-comment">-- The returned alternatives can be empty, none are possible</span><span>
</span><a name="line-1913"></a><a name="prepareAlts"><a href="SimplUtils.html#prepareAlts"><span class="hs-identifier">prepareAlts</span></a></a><span> </span><a name="local-6989586621680440395"><a href="#local-6989586621680440395"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440396"><a href="#local-6989586621680440396"><span class="hs-identifier">case_bndr'</span></a></a><span> </span><a name="local-6989586621680440397"><a href="#local-6989586621680440397"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-1914"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440400"><a href="#local-6989586621680440400"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440401"><a href="#local-6989586621680440401"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621680440396"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1915"></a><span>           </span><span class="hs-comment">-- Case binder is needed just for its type. Note that as an</span><span>
</span><a name="line-1916"></a><span>           </span><span class="hs-comment">--   OutId, it has maximum information; this is important.</span><span>
</span><a name="line-1917"></a><span>           </span><span class="hs-comment">--   Test simpl013 is an example</span><span>
</span><a name="line-1918"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440402"><a href="#local-6989586621680440402"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniquesM</span><span>
</span><a name="line-1919"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440403"><a href="#local-6989586621680440403"><span class="hs-identifier">idcs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440404"><a href="#local-6989586621680440404"><span class="hs-identifier">alts1</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterAlts</span><span> </span><a href="#local-6989586621680440400"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680440401"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621680440398"><span class="hs-identifier hs-var">imposs_cons</span></a><span> </span><a href="#local-6989586621680440397"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-1920"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621680440405"><a href="#local-6989586621680440405"><span class="hs-identifier">yes2</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621680440406"><a href="#local-6989586621680440406"><span class="hs-identifier">alts2</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">refineDefaultAlt</span><span> </span><a href="#local-6989586621680440402"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621680440400"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621680440401"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621680440403"><span class="hs-identifier hs-var">idcs1</span></a><span> </span><a href="#local-6989586621680440404"><span class="hs-identifier hs-var">alts1</span></a><span>
</span><a name="line-1921"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621680440407"><a href="#local-6989586621680440407"><span class="hs-identifier">yes3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440408"><a href="#local-6989586621680440408"><span class="hs-identifier">idcs3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440409"><a href="#local-6989586621680440409"><span class="hs-identifier">alts3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">combineIdenticalAlts</span><span> </span><a href="#local-6989586621680440403"><span class="hs-identifier hs-var">idcs1</span></a><span> </span><a href="#local-6989586621680440406"><span class="hs-identifier hs-var">alts2</span></a><span>
</span><a name="line-1922"></a><span>             </span><span class="hs-comment">-- &quot;idcs&quot; stands for &quot;impossible default data constructors&quot;</span><span>
</span><a name="line-1923"></a><span>             </span><span class="hs-comment">-- i.e. the constructors that can't match the default case</span><span>
</span><a name="line-1924"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621680440405"><span class="hs-identifier hs-var">yes2</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FillInCaseDefault</span><span> </span><a href="#local-6989586621680440396"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1925"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621680440407"><span class="hs-identifier hs-var">yes3</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AltMerge</span><span> </span><a href="#local-6989586621680440396"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440408"><span class="hs-identifier hs-var">idcs3</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440409"><span class="hs-identifier hs-var">alts3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1927"></a><span>
</span><a name="line-1928"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- Not a data type, so nothing interesting happens</span><span>
</span><a name="line-1929"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440397"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1930"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1931"></a><span>    </span><a name="local-6989586621680440398"><a href="#local-6989586621680440398"><span class="hs-identifier">imposs_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440395"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1932"></a><span>                    </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680440399"><a href="#local-6989586621680440399"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">otherCons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680440399"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1933"></a><span>                    </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1934"></a><span>
</span><a name="line-1935"></a><span>
</span><a name="line-1936"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                mkCase
*                                                                      *
************************************************************************

mkCase tries these things

* Note [Nerge nested cases]
* Note [Eliminate identity case]
* Note [Scrutinee constant folding]

Note [Merge Nested Cases]
~~~~~~~~~~~~~~~~~~~~~~~~~
       case e of b {             ==&gt;   case e of b {
         p1 -&gt; rhs1                      p1 -&gt; rhs1
         ...                             ...
         pm -&gt; rhsm                      pm -&gt; rhsm
         _  -&gt; case b of b' {            pn -&gt; let b'=b in rhsn
                     pn -&gt; rhsn          ...
                     ...                 po -&gt; let b'=b in rhso
                     po -&gt; rhso          _  -&gt; let b'=b in rhsd
                     _  -&gt; rhsd
       }

which merges two cases in one case when -- the default alternative of
the outer case scrutises the same variable as the outer case. This
transformation is called Case Merging.  It avoids that the same
variable is scrutinised multiple times.

Note [Eliminate Identity Case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        case e of               ===&gt; e
                True  -&gt; True;
                False -&gt; False

and similar friends.

Note [Scrutinee Constant Folding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     case x op# k# of _ {  ===&gt; case x of _ {
        a1# -&gt; e1                  (a1# inv_op# k#) -&gt; e1
        a2# -&gt; e2                  (a2# inv_op# k#) -&gt; e2
        ...                        ...
        DEFAULT -&gt; ed              DEFAULT -&gt; ed

     where (x op# k#) inv_op# k# == x

And similarly for commuted arguments and for some unary operations.

The purpose of this transformation is not only to avoid an arithmetic
operation at runtime but to allow other transformations to apply in cascade.

Example with the &quot;Merge Nested Cases&quot; optimization (from #12877):

      main = case t of t0
         0##     -&gt; ...
         DEFAULT -&gt; case t0 `minusWord#` 1## of t1
            0##    -&gt; ...
            DEFAUT -&gt; case t1 `minusWord#` 1## of t2
               0##     -&gt; ...
               DEFAULT -&gt; case t2 `minusWord#` 1## of _
                  0##     -&gt; ...
                  DEFAULT -&gt; ...

  becomes:

      main = case t of _
      0##     -&gt; ...
      1##     -&gt; ...
      2##     -&gt; ...
      3##     -&gt; ...
      DEFAULT -&gt; ...

There are some wrinkles

* Do not apply caseRules if there is just a single DEFAULT alternative
     case e +# 3# of b { DEFAULT -&gt; rhs }
  If we applied the transformation here we would (stupidly) get
     case a of b' { DEFAULT -&gt; let b = e +# 3# in rhs }
  and now the process may repeat, because that let will really
  be a case.

* The type of the scrutinee might change.  E.g.
        case tagToEnum (x :: Int#) of (b::Bool)
          False -&gt; e1
          True -&gt; e2
  ==&gt;
        case x of (b'::Int#)
          DEFAULT -&gt; e1
          1#      -&gt; e2

* The case binder may be used in the right hand sides, so we need
  to make a local binding for it, if it is alive.  e.g.
         case e +# 10# of b
           DEFAULT -&gt; blah...b...
           44#     -&gt; blah2...b...
  ===&gt;
         case e of b'
           DEFAULT -&gt; let b = b' +# 10# in blah...b...
           34#     -&gt; let b = 44# in blah2...b...

  Note that in the non-DEFAULT cases we know what to bind 'b' to,
  whereas in the DEFAULT case we must reconstruct the original value.
  But NB: we use b'; we do not duplicate 'e'.

* In dataToTag we might need to make up some fake binders;
  see Note [caseRules for dataToTag] in PrelRules
-}</span><span>
</span><a name="line-2046"></a><span>
</span><a name="line-2047"></a><span class="hs-identifier">mkCase</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkCase1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkCase2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkCase3</span><span>
</span><a name="line-2048"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-2049"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-2050"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutAlt</span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- Alternatives in standard (increasing) order</span><span>
</span><a name="line-2051"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-2052"></a><span>
</span><a name="line-2053"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2054"></a><span class="hs-comment">--      1. Merge Nested Cases</span><span>
</span><a name="line-2055"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2056"></a><span>
</span><a name="line-2057"></a><a name="mkCase"><a href="SimplUtils.html#mkCase"><span class="hs-identifier">mkCase</span></a></a><span> </span><a name="local-6989586621680440410"><a href="#local-6989586621680440410"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440411"><a href="#local-6989586621680440411"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440412"><a href="#local-6989586621680440412"><span class="hs-identifier">outer_bndr</span></a></a><span> </span><a name="local-6989586621680440413"><a href="#local-6989586621680440413"><span class="hs-identifier">alts_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680440414"><a href="#local-6989586621680440414"><span class="hs-identifier">deflt_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680440415"><a href="#local-6989586621680440415"><span class="hs-identifier">outer_alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2058"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CaseMerge</span><span> </span><a href="#local-6989586621680440410"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2059"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440416"><a href="#local-6989586621680440416"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680440417"><a href="#local-6989586621680440417"><span class="hs-identifier">inner_scrut_var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680440418"><a href="#local-6989586621680440418"><span class="hs-identifier">inner_bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440419"><a href="#local-6989586621680440419"><span class="hs-identifier">inner_alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2060"></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">stripTicksTop</span><span> </span><span class="hs-identifier hs-var">tickishFloatable</span><span> </span><a href="#local-6989586621680440414"><span class="hs-identifier hs-var">deflt_rhs</span></a><span>
</span><a name="line-2061"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440417"><span class="hs-identifier hs-var">inner_scrut_var</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680440412"><span class="hs-identifier hs-var">outer_bndr</span></a><span>
</span><a name="line-2062"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CaseMerge</span><span> </span><a href="#local-6989586621680440412"><span class="hs-identifier hs-var">outer_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2063"></a><span>
</span><a name="line-2064"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680440420"><a href="#local-6989586621680440420"><span class="hs-identifier">wrap_alt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680440424"><a href="#local-6989586621680440424"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440425"><a href="#local-6989586621680440425"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440426"><a href="#local-6989586621680440426"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">outer_bndr</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2065"></a><span>                                          </span><span class="hs-special">(</span><a href="#local-6989586621680440424"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440425"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440421"><span class="hs-identifier hs-var">wrap_rhs</span></a><span> </span><a href="#local-6989586621680440426"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2066"></a><span>                </span><span class="hs-comment">-- Simplifier's no-shadowing invariant should ensure</span><span>
</span><a name="line-2067"></a><span>                </span><span class="hs-comment">-- that outer_bndr is not shadowed by the inner patterns</span><span>
</span><a name="line-2068"></a><span>              </span><a name="local-6989586621680440421"><a href="#local-6989586621680440421"><span class="hs-identifier">wrap_rhs</span></a></a><span> </span><a name="local-6989586621680440427"><a href="#local-6989586621680440427"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680440418"><span class="hs-identifier hs-var">inner_bndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680440412"><span class="hs-identifier hs-var">outer_bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440427"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2069"></a><span>                </span><span class="hs-comment">-- The let is OK even for unboxed binders,</span><span>
</span><a name="line-2070"></a><span>
</span><a name="line-2071"></a><span>              </span><a name="local-6989586621680440422"><a href="#local-6989586621680440422"><span class="hs-identifier">wrapped_alts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDeadBinder</span><span> </span><a href="#local-6989586621680440418"><span class="hs-identifier hs-var">inner_bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440419"><span class="hs-identifier hs-var">inner_alts</span></a><span>
</span><a name="line-2072"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680440420"><span class="hs-identifier hs-var">wrap_alt</span></a><span> </span><a href="#local-6989586621680440419"><span class="hs-identifier hs-var">inner_alts</span></a><span>
</span><a name="line-2073"></a><span>
</span><a name="line-2074"></a><span>              </span><a name="local-6989586621680440423"><a href="#local-6989586621680440423"><span class="hs-identifier">merged_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mergeAlts</span><span> </span><a href="#local-6989586621680440415"><span class="hs-identifier hs-var">outer_alts</span></a><span> </span><a href="#local-6989586621680440422"><span class="hs-identifier hs-var">wrapped_alts</span></a><span>
</span><a name="line-2075"></a><span>                </span><span class="hs-comment">-- NB: mergeAlts gives priority to the left</span><span>
</span><a name="line-2076"></a><span>                </span><span class="hs-comment">--      case x of</span><span>
</span><a name="line-2077"></a><span>                </span><span class="hs-comment">--        A -&gt; e1</span><span>
</span><a name="line-2078"></a><span>                </span><span class="hs-comment">--        DEFAULT -&gt; case x of</span><span>
</span><a name="line-2079"></a><span>                </span><span class="hs-comment">--                      A -&gt; e2</span><span>
</span><a name="line-2080"></a><span>                </span><span class="hs-comment">--                      B -&gt; e3</span><span>
</span><a name="line-2081"></a><span>                </span><span class="hs-comment">-- When we merge, we must ensure that e1 takes</span><span>
</span><a name="line-2082"></a><span>                </span><span class="hs-comment">-- precedence over e2 as the value for A!</span><span>
</span><a name="line-2083"></a><span>
</span><a name="line-2084"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTicks</span><span> </span><a href="#local-6989586621680440416"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2085"></a><span>          </span><a href="SimplUtils.html#mkCase1"><span class="hs-identifier hs-var">mkCase1</span></a><span> </span><a href="#local-6989586621680440410"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440411"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440412"><span class="hs-identifier hs-var">outer_bndr</span></a><span> </span><a href="#local-6989586621680440413"><span class="hs-identifier hs-var">alts_ty</span></a><span> </span><a href="#local-6989586621680440423"><span class="hs-identifier hs-var">merged_alts</span></a><span>
</span><a name="line-2086"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-2087"></a><span>        </span><span class="hs-comment">-- Warning: don't call mkCase recursively!</span><span>
</span><a name="line-2088"></a><span>        </span><span class="hs-comment">-- Firstly, there's no point, because inner alts have already had</span><span>
</span><a name="line-2089"></a><span>        </span><span class="hs-comment">-- mkCase applied to them, so they won't have a case in their default</span><span>
</span><a name="line-2090"></a><span>        </span><span class="hs-comment">-- Secondly, if you do, you get an infinite loop, because the bindCaseBndr</span><span>
</span><a name="line-2091"></a><span>        </span><span class="hs-comment">-- in munge_rhs may put a case into the DEFAULT branch!</span><span>
</span><a name="line-2092"></a><span>
</span><a name="line-2093"></a><span class="hs-identifier">mkCase</span><span> </span><a name="local-6989586621680440428"><a href="#local-6989586621680440428"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440429"><a href="#local-6989586621680440429"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440430"><a href="#local-6989586621680440430"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440431"><a href="#local-6989586621680440431"><span class="hs-identifier">alts_ty</span></a></a><span> </span><a name="local-6989586621680440432"><a href="#local-6989586621680440432"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkCase1"><span class="hs-identifier hs-var">mkCase1</span></a><span> </span><a href="#local-6989586621680440428"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440429"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440430"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680440431"><span class="hs-identifier hs-var">alts_ty</span></a><span> </span><a href="#local-6989586621680440432"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2094"></a><span>
</span><a name="line-2095"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2096"></a><span class="hs-comment">--      2. Eliminate Identity Case</span><span>
</span><a name="line-2097"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2098"></a><span>
</span><a name="line-2099"></a><a name="mkCase1"><a href="SimplUtils.html#mkCase1"><span class="hs-identifier">mkCase1</span></a></a><span> </span><a name="local-6989586621680440433"><a href="#local-6989586621680440433"><span class="hs-identifier">_dflags</span></a></a><span> </span><a name="local-6989586621680440434"><a href="#local-6989586621680440434"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440435"><a href="#local-6989586621680440435"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680440436"><a href="#local-6989586621680440436"><span class="hs-identifier">alts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680440437"><a href="#local-6989586621680440437"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Identity case</span><span>
</span><a name="line-2100"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621680440439"><span class="hs-identifier hs-var">identity_alt</span></a><span> </span><a href="#local-6989586621680440436"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2101"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="SimplMonad.html#tick"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CaseIdentity</span><span> </span><a href="#local-6989586621680440435"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2102"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTicks</span><span> </span><a href="#local-6989586621680440438"><span class="hs-identifier hs-var">ticks</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680440442"><span class="hs-identifier hs-var">re_cast</span></a><span> </span><a href="#local-6989586621680440434"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440437"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2103"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2104"></a><span>    </span><a name="local-6989586621680440438"><a href="#local-6989586621680440438"><span class="hs-identifier">ticks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stripTicksT</span><span> </span><span class="hs-identifier hs-var">tickishFloatable</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">thdOf3</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621680440436"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2105"></a><span>    </span><a name="local-6989586621680440439"><a href="#local-6989586621680440439"><span class="hs-identifier">identity_alt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680440443"><a href="#local-6989586621680440443"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440444"><a href="#local-6989586621680440444"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440445"><a href="#local-6989586621680440445"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440440"><span class="hs-identifier hs-var">check_eq</span></a><span> </span><a href="#local-6989586621680440445"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680440443"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680440444"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2106"></a><span>
</span><a name="line-2107"></a><span>    </span><a name="local-6989586621680440440"><a href="#local-6989586621680440440"><span class="hs-identifier">check_eq</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621680440446"><a href="#local-6989586621680440446"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621680440447"><a href="#local-6989586621680440447"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680440448"><a href="#local-6989586621680440448"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621680440449"><a href="#local-6989586621680440449"><span class="hs-identifier">args</span></a></a><span>        </span><span class="hs-comment">-- See Note [RHS casts]</span><span>
</span><a name="line-2108"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfCo</span><span> </span><a href="#local-6989586621680440447"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440449"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440440"><span class="hs-identifier hs-var">check_eq</span></a><span> </span><a href="#local-6989586621680440446"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680440448"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680440449"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2109"></a><span>    </span><span class="hs-identifier">check_eq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621680440450"><a href="#local-6989586621680440450"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680440451"><a href="#local-6989586621680440451"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680440452"><a href="#local-6989586621680440452"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621680440453"><a href="#local-6989586621680440453"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2110"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tickishFloatable</span><span> </span><a href="#local-6989586621680440450"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680440440"><span class="hs-identifier hs-var">check_eq</span></a><span> </span><a href="#local-6989586621680440451"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680440452"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621680440453"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2111"></a><span>
</span><a name="line-2112"></a><span>    </span><span class="hs-identifier">check_eq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><a name="local-6989586621680440454"><a href="#local-6989586621680440454"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitAlt</span><span> </span><a name="local-6989586621680440455"><a href="#local-6989586621680440455"><span class="hs-identifier">lit'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440454"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680440455"><span class="hs-identifier hs-var">lit'</span></a><span>
</span><a name="line-2113"></a><span>    </span><span class="hs-identifier">check_eq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680440456"><a href="#local-6989586621680440456"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680440456"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680440435"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2114"></a><span>    </span><span class="hs-identifier">check_eq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680440457"><a href="#local-6989586621680440457"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621680440458"><a href="#local-6989586621680440458"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680440459"><a href="#local-6989586621680440459"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2115"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680440441"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680440459"><span class="hs-identifier hs-var">args</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440457"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">dataConWorkId</span><span> </span><a href="#local-6989586621680440458"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2116"></a><span>                                             </span><span class="hs-comment">-- Optimisation only</span><span>
</span><a name="line-2117"></a><span>    </span><span class="hs-identifier">check_eq</span><span> </span><a name="local-6989586621680440460"><a href="#local-6989586621680440460"><span class="hs-identifier">rhs</span></a></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621680440461"><a href="#local-6989586621680440461"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680440462"><a href="#local-6989586621680440462"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cheapEqExpr'</span><span> </span><span class="hs-identifier hs-var">tickishFloatable</span><span> </span><a href="#local-6989586621680440460"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2118"></a><span>                                             </span><span class="hs-identifier hs-var">mkConApp2</span><span> </span><a href="#local-6989586621680440461"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680440441"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621680440462"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2119"></a><span>    </span><span class="hs-identifier">check_eq</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-identifier">_</span><span>             </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2120"></a><span>
</span><a name="line-2121"></a><span>    </span><a name="local-6989586621680440441"><a href="#local-6989586621680440441"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConAppArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440435"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2122"></a><span>
</span><a name="line-2123"></a><span>        </span><span class="hs-comment">-- Note [RHS casts]</span><span>
</span><a name="line-2124"></a><span>        </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-2125"></a><span>        </span><span class="hs-comment">-- We've seen this:</span><span>
</span><a name="line-2126"></a><span>        </span><span class="hs-comment">--      case e of x { _ -&gt; x `cast` c }</span><span>
</span><a name="line-2127"></a><span>        </span><span class="hs-comment">-- And we definitely want to eliminate this case, to give</span><span>
</span><a name="line-2128"></a><span>        </span><span class="hs-comment">--      e `cast` c</span><span>
</span><a name="line-2129"></a><span>        </span><span class="hs-comment">-- So we throw away the cast from the RHS, and reconstruct</span><span>
</span><a name="line-2130"></a><span>        </span><span class="hs-comment">-- it at the other end.  All the RHS casts must be the same</span><span>
</span><a name="line-2131"></a><span>        </span><span class="hs-comment">-- if (all identity_alt alts) holds.</span><span>
</span><a name="line-2132"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-2133"></a><span>        </span><span class="hs-comment">-- Don't worry about nested casts, because the simplifier combines them</span><span>
</span><a name="line-2134"></a><span>
</span><a name="line-2135"></a><span>    </span><a name="local-6989586621680440442"><a href="#local-6989586621680440442"><span class="hs-identifier">re_cast</span></a></a><span> </span><a name="local-6989586621680440463"><a href="#local-6989586621680440463"><span class="hs-identifier">scrut</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621680440464"><a href="#local-6989586621680440464"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621680440465"><a href="#local-6989586621680440465"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Cast</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440442"><span class="hs-identifier hs-var">re_cast</span></a><span> </span><a href="#local-6989586621680440463"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440464"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440465"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2136"></a><span>    </span><span class="hs-identifier">re_cast</span><span> </span><a name="local-6989586621680440466"><a href="#local-6989586621680440466"><span class="hs-identifier">scrut</span></a></a><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440466"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2137"></a><span>
</span><a name="line-2138"></a><span class="hs-identifier">mkCase1</span><span> </span><a name="local-6989586621680440467"><a href="#local-6989586621680440467"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440468"><a href="#local-6989586621680440468"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440469"><a href="#local-6989586621680440469"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440470"><a href="#local-6989586621680440470"><span class="hs-identifier">alts_ty</span></a></a><span> </span><a name="local-6989586621680440471"><a href="#local-6989586621680440471"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkCase2"><span class="hs-identifier hs-var">mkCase2</span></a><span> </span><a href="#local-6989586621680440467"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440468"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440469"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680440470"><span class="hs-identifier hs-var">alts_ty</span></a><span> </span><a href="#local-6989586621680440471"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2139"></a><span>
</span><a name="line-2140"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2141"></a><span class="hs-comment">--      2. Scrutinee Constant Folding</span><span>
</span><a name="line-2142"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2143"></a><span>
</span><a name="line-2144"></a><a name="mkCase2"><a href="SimplUtils.html#mkCase2"><span class="hs-identifier">mkCase2</span></a></a><span> </span><a name="local-6989586621680440472"><a href="#local-6989586621680440472"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680440473"><a href="#local-6989586621680440473"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440474"><a href="#local-6989586621680440474"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440475"><a href="#local-6989586621680440475"><span class="hs-identifier">alts_ty</span></a></a><span> </span><a name="local-6989586621680440476"><a href="#local-6989586621680440476"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-2145"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- See Note [Scrutinee Constant Folding]</span><span>
</span><a name="line-2146"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440476"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Not if there is just a DEFAULT alternative</span><span>
</span><a name="line-2147"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2148"></a><span>      </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2149"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CaseFolding</span><span> </span><a href="#local-6989586621680440472"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2150"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440503"><a href="#local-6989586621680440503"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440504"><a href="#local-6989586621680440504"><span class="hs-identifier">tx_con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440505"><a href="#local-6989586621680440505"><span class="hs-identifier">mk_orig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">caseRules</span><span> </span><a href="#local-6989586621680440472"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440473"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-2151"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440506"><a href="#local-6989586621680440506"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#newId"><span class="hs-identifier hs-var">newId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;lwild&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621680440503"><span class="hs-identifier hs-var">scrut'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2152"></a><span>
</span><a name="line-2153"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680440507"><a href="#local-6989586621680440507"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440477"><span class="hs-identifier hs-var">tx_alt</span></a><span> </span><a href="#local-6989586621680440504"><span class="hs-identifier hs-var">tx_con</span></a><span> </span><a href="#local-6989586621680440505"><span class="hs-identifier hs-var">mk_orig</span></a><span> </span><a href="#local-6989586621680440506"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440476"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2154"></a><span>                  </span><span class="hs-comment">-- mapMaybeM: discard unreachable alternatives</span><span>
</span><a name="line-2155"></a><span>                  </span><span class="hs-comment">-- See Note [Unreachable caseRules alternatives]</span><span>
</span><a name="line-2156"></a><span>                  </span><span class="hs-comment">-- in PrelRules</span><span>
</span><a name="line-2157"></a><span>
</span><a name="line-2158"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="SimplUtils.html#mkCase3"><span class="hs-identifier hs-var">mkCase3</span></a><span> </span><a href="#local-6989586621680440472"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440503"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621680440506"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621680440475"><span class="hs-identifier hs-var">alts_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2159"></a><span>         </span><a href="#local-6989586621680440480"><span class="hs-identifier hs-var">add_default</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440479"><span class="hs-identifier hs-var">re_sort</span></a><span> </span><a href="#local-6989586621680440507"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2160"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-2161"></a><span>
</span><a name="line-2162"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2163"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#mkCase3"><span class="hs-identifier hs-var">mkCase3</span></a><span> </span><a href="#local-6989586621680440472"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680440473"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440474"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680440475"><span class="hs-identifier hs-var">alts_ty</span></a><span> </span><a href="#local-6989586621680440476"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2164"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2165"></a><span>    </span><span class="hs-comment">-- We need to keep the correct association between the scrutinee and its</span><span>
</span><a name="line-2166"></a><span>    </span><span class="hs-comment">-- binder if the latter isn't dead. Hence we wrap rhs of alternatives with</span><span>
</span><a name="line-2167"></a><span>    </span><span class="hs-comment">-- &quot;let bndr = ... in&quot;:</span><span>
</span><a name="line-2168"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2169"></a><span>    </span><span class="hs-comment">--     case v + 10 of y        =====&gt; case v of y</span><span>
</span><a name="line-2170"></a><span>    </span><span class="hs-comment">--        20      -&gt; e1                 10      -&gt; let y = 20     in e1</span><span>
</span><a name="line-2171"></a><span>    </span><span class="hs-comment">--        DEFAULT -&gt; e2                 DEFAULT -&gt; let y = v + 10 in e2</span><span>
</span><a name="line-2172"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2173"></a><span>    </span><span class="hs-comment">-- Other transformations give: =====&gt; case v of y'</span><span>
</span><a name="line-2174"></a><span>    </span><span class="hs-comment">--                                      10      -&gt; let y = 20      in e1</span><span>
</span><a name="line-2175"></a><span>    </span><span class="hs-comment">--                                      DEFAULT -&gt; let y = y' + 10 in e2</span><span>
</span><a name="line-2176"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2177"></a><span>    </span><span class="hs-comment">-- This wrapping is done in tx_alt; we use mk_orig, returned by caseRules,</span><span>
</span><a name="line-2178"></a><span>    </span><span class="hs-comment">-- to construct an expression equivalent to the original one, for use</span><span>
</span><a name="line-2179"></a><span>    </span><span class="hs-comment">-- in the DEFAULT case</span><span>
</span><a name="line-2180"></a><span>
</span><a name="line-2181"></a><span>    </span><span class="hs-identifier">tx_alt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AltCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">AltCon</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-2182"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreAlt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">)</span><span>
</span><a name="line-2183"></a><span>    </span><a name="local-6989586621680440477"><a href="#local-6989586621680440477"><span class="hs-identifier">tx_alt</span></a></a><span> </span><a name="local-6989586621680440481"><a href="#local-6989586621680440481"><span class="hs-identifier">tx_con</span></a></a><span> </span><a name="local-6989586621680440482"><a href="#local-6989586621680440482"><span class="hs-identifier">mk_orig</span></a></a><span> </span><a name="local-6989586621680440483"><a href="#local-6989586621680440483"><span class="hs-identifier">new_bndr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680440484"><a href="#local-6989586621680440484"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440485"><a href="#local-6989586621680440485"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440486"><a href="#local-6989586621680440486"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2184"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440481"><span class="hs-identifier hs-var">tx_con</span></a><span> </span><a href="#local-6989586621680440484"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2185"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2186"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680440491"><a href="#local-6989586621680440491"><span class="hs-identifier">con'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440492"><a href="#local-6989586621680440492"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680440478"><span class="hs-identifier hs-var">mk_new_bndrs</span></a><span> </span><a href="#local-6989586621680440483"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><a href="#local-6989586621680440491"><span class="hs-identifier hs-var">con'</span></a><span>
</span><a name="line-2187"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440491"><span class="hs-identifier hs-var">con'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440492"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440487"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2188"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2189"></a><span>        </span><a name="local-6989586621680440487"><a href="#local-6989586621680440487"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDeadBinder</span><span> </span><a href="#local-6989586621680440474"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440486"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2190"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621680440474"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680440488"><span class="hs-identifier hs-var">orig_val</span></a><span> </span><a href="#local-6989586621680440486"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2191"></a><span>
</span><a name="line-2192"></a><span>        </span><a name="local-6989586621680440488"><a href="#local-6989586621680440488"><span class="hs-identifier">orig_val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680440484"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2193"></a><span>                      </span><span class="hs-identifier hs-var">DEFAULT</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680440482"><span class="hs-identifier hs-var">mk_orig</span></a><span> </span><a href="#local-6989586621680440483"><span class="hs-identifier hs-var">new_bndr</span></a><span>
</span><a name="line-2194"></a><span>                      </span><span class="hs-identifier hs-var">LitAlt</span><span> </span><a name="local-6989586621680440489"><a href="#local-6989586621680440489"><span class="hs-identifier">l</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Lit</span><span> </span><a href="#local-6989586621680440489"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-2195"></a><span>                      </span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621680440490"><a href="#local-6989586621680440490"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkConApp2</span><span> </span><a href="#local-6989586621680440490"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConAppArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440474"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680440485"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-2196"></a><span>
</span><a name="line-2197"></a><span>    </span><a name="local-6989586621680440478"><a href="#local-6989586621680440478"><span class="hs-identifier">mk_new_bndrs</span></a></a><span> </span><a name="local-6989586621680440493"><a href="#local-6989586621680440493"><span class="hs-identifier">new_bndr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621680440494"><a href="#local-6989586621680440494"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2198"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNullaryRepDataCon</span><span> </span><a href="#local-6989586621680440494"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2199"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- For non-nullary data cons we must invent some fake binders</span><span>
</span><a name="line-2200"></a><span>        </span><span class="hs-comment">-- See Note [caseRules for dataToTag] in PrelRules</span><span>
</span><a name="line-2201"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680440495"><a href="#local-6989586621680440495"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniquesM</span><span>
</span><a name="line-2202"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680440496"><a href="#local-6989586621680440496"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440497"><a href="#local-6989586621680440497"><span class="hs-identifier">arg_ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConRepInstPat</span><span> </span><a href="#local-6989586621680440495"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621680440494"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-2203"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConAppArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680440493"><span class="hs-identifier hs-var">new_bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2204"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680440496"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680440497"><span class="hs-identifier hs-var">arg_ids</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2205"></a><span>    </span><span class="hs-identifier">mk_new_bndrs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2206"></a><span>
</span><a name="line-2207"></a><span>    </span><span class="hs-identifier">re_sort</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Re-sort the alternatives to</span><span>
</span><a name="line-2208"></a><span>    </span><a name="local-6989586621680440479"><a href="#local-6989586621680440479"><span class="hs-identifier">re_sort</span></a></a><span> </span><a name="local-6989586621680440498"><a href="#local-6989586621680440498"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">cmpAlt</span><span> </span><a href="#local-6989586621680440498"><span class="hs-identifier hs-var">alts</span></a><span>  </span><span class="hs-comment">-- preserve the #case_invariants#</span><span>
</span><a name="line-2209"></a><span>
</span><a name="line-2210"></a><span>    </span><span class="hs-identifier">add_default</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span>
</span><a name="line-2211"></a><span>    </span><span class="hs-comment">-- See Note [Literal cases]</span><span>
</span><a name="line-2212"></a><span>    </span><a name="local-6989586621680440480"><a href="#local-6989586621680440480"><span class="hs-identifier">add_default</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitAlt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680440499"><a href="#local-6989586621680440499"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680440500"><a href="#local-6989586621680440500"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680440501"><a href="#local-6989586621680440501"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440499"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680440500"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680440501"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2213"></a><span>    </span><span class="hs-identifier">add_default</span><span> </span><a name="local-6989586621680440502"><a href="#local-6989586621680440502"><span class="hs-identifier">alts</span></a></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680440502"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-2214"></a><span>
</span><a name="line-2215"></a><span class="hs-comment">{- Note [Literal cases]
~~~~~~~~~~~~~~~~~~~~~~~
If we have
  case tagToEnum (a &gt;# b) of
     False -&gt; e1
     True  -&gt; e2

then caseRules for TagToEnum will turn it into
  case tagToEnum (a &gt;# b) of
     0# -&gt; e1
     1# -&gt; e2

Since the case is exhaustive (all cases are) we can convert it to
  case tagToEnum (a &gt;# b) of
     DEFAULT -&gt; e1
     1#      -&gt; e2

This may generate sligthtly better code (although it should not, since
all cases are exhaustive) and/or optimise better.  I'm not certain that
it's necessary, but currenty we do make this change.  We do it here,
NOT in the TagToEnum rules (see &quot;Beware&quot; in Note [caseRules for tagToEnum]
in PrelRules)
-}</span><span>
</span><a name="line-2238"></a><span>
</span><a name="line-2239"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2240"></a><span class="hs-comment">--      Catch-all</span><span>
</span><a name="line-2241"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-2242"></a><a name="mkCase3"><a href="SimplUtils.html#mkCase3"><span class="hs-identifier">mkCase3</span></a></a><span> </span><a name="local-6989586621680440508"><a href="#local-6989586621680440508"><span class="hs-identifier">_dflags</span></a></a><span> </span><a name="local-6989586621680440509"><a href="#local-6989586621680440509"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680440510"><a href="#local-6989586621680440510"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680440511"><a href="#local-6989586621680440511"><span class="hs-identifier">alts_ty</span></a></a><span> </span><a name="local-6989586621680440512"><a href="#local-6989586621680440512"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-2243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621680440509"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680440510"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680440511"><span class="hs-identifier hs-var">alts_ty</span></a><span> </span><a href="#local-6989586621680440512"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2244"></a><span>
</span><a name="line-2245"></a><span class="hs-comment">-- See Note [Exitification] and Note [Do not inline exit join points] in Exitify.hs</span><span>
</span><a name="line-2246"></a><span class="hs-comment">-- This lives here (and not in Id) because occurrence info is only valid on</span><span>
</span><a name="line-2247"></a><span class="hs-comment">-- InIds, so it's crucial that isExitJoinId is only called on freshly</span><span>
</span><a name="line-2248"></a><span class="hs-comment">-- occ-analysed code. It's not a generic function you can call anywhere.</span><span>
</span><a name="line-2249"></a><span class="hs-identifier">isExitJoinId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2250"></a><a name="isExitJoinId"><a href="SimplUtils.html#isExitJoinId"><span class="hs-identifier">isExitJoinId</span></a></a><span> </span><a name="local-6989586621680440513"><a href="#local-6989586621680440513"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621680440513"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isOneOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idOccInfo</span><span> </span><a href="#local-6989586621680440513"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idOccInfo</span><span> </span><a href="#local-6989586621680440513"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2251"></a><span>
</span><a name="line-2252"></a><span class="hs-comment">{-
Note [Dead binders]
~~~~~~~~~~~~~~~~~~~~
Note that dead-ness is maintained by the simplifier, so that it is
accurate after simplification as well as before.


Note [Cascading case merge]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Case merging should cascade in one sweep, because it
happens bottom-up

      case e of a {
        DEFAULT -&gt; case a of b
                      DEFAULT -&gt; case b of c {
                                     DEFAULT -&gt; e
                                     A -&gt; ea
                      B -&gt; eb
        C -&gt; ec
==&gt;
      case e of a {
        DEFAULT -&gt; case a of b
                      DEFAULT -&gt; let c = b in e
                      A -&gt; let c = b in ea
                      B -&gt; eb
        C -&gt; ec
==&gt;
      case e of a {
        DEFAULT -&gt; let b = a in let c = b in e
        A -&gt; let b = a in let c = b in ea
        B -&gt; let b = a in eb
        C -&gt; ec


However here's a tricky case that we still don't catch, and I don't
see how to catch it in one pass:

  case x of c1 { I# a1 -&gt;
  case a1 of c2 -&gt;
    0 -&gt; ...
    DEFAULT -&gt; case x of c3 { I# a2 -&gt;
               case a2 of ...

After occurrence analysis (and its binder-swap) we get this

  case x of c1 { I# a1 -&gt;
  let x = c1 in         -- Binder-swap addition
  case a1 of c2 -&gt;
    0 -&gt; ...
    DEFAULT -&gt; case x of c3 { I# a2 -&gt;
               case a2 of ...

When we simplify the inner case x, we'll see that
x=c1=I# a1.  So we'll bind a2 to a1, and get

  case x of c1 { I# a1 -&gt;
  case a1 of c2 -&gt;
    0 -&gt; ...
    DEFAULT -&gt; case a1 of ...

This is corect, but we can't do a case merge in this sweep
because c2 /= a1.  Reason: the binding c1=I# a1 went inwards
without getting changed to c1=I# c2.

I don't think this is worth fixing, even if I knew how. It'll
all come out in the next pass anyway.
-}</span><span>
</span><a name="line-2319"></a></pre></body></html>