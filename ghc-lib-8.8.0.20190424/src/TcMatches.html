<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


TcMatches: Typecheck some @Matches@
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcMatches</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcMatches.html#tcMatchesFun"><span class="hs-identifier hs-var">tcMatchesFun</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcGRHS"><span class="hs-identifier hs-var">tcGRHS</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcGRHSsPat"><span class="hs-identifier hs-var">tcGRHSsPat</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcMatchesCase"><span class="hs-identifier hs-var">tcMatchesCase</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcMatchLambda"><span class="hs-identifier hs-var">tcMatchLambda</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>                   </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcMatches.html#TcStmtChecker"><span class="hs-identifier hs-type">TcStmtChecker</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#TcExprStmtChecker"><span class="hs-identifier hs-type">TcExprStmtChecker</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#TcCmdStmtChecker"><span class="hs-identifier hs-type">TcCmdStmtChecker</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>                   </span><a href="TcMatches.html#tcStmts"><span class="hs-identifier hs-var">tcStmts</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcDoStmts"><span class="hs-identifier hs-var">tcDoStmts</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>                   </span><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier hs-var">tcDoStmt</span></a><span class="hs-special">,</span><span> </span><a href="TcMatches.html#tcGuardStmt"><span class="hs-identifier hs-var">tcGuardStmt</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span class="hs-special">(</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcInferSigmaNC"><span class="hs-identifier hs-var">tcInferSigmaNC</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span>
</span><a name="line-25"></a><span>                              </span><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcCheckId"><span class="hs-identifier hs-var">tcCheckId</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LexicalFixity</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcPat.html"><span class="hs-identifier">TcPat</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcBinds.html"><span class="hs-identifier">TcBinds</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-comment">-- Create chunkified tuple tybes for monad comprehensions</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-54"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{tcMatchesFun, tcMatchesCase}
*                                                                      *
************************************************************************

@tcMatchesFun@ typechecks a @[Match]@ list which occurs in a
@FunMonoBind@.  The second argument is the name of the function, which
is used in error messages.  It checks that all the equations have the
same number of arguments before using @tcMatches@ to do the work.

Note [Polymorphic expected type for tcMatchesFun]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcMatchesFun may be given a *sigma* (polymorphic) type
so it must be prepared to use tcSkolemise to skolemise it.
See Note [sig_tau may be polymorphic] in TcPat.
-}</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">tcMatchesFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-74"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>     </span><span class="hs-comment">-- Expected type of function</span><span>
</span><a name="line-76"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>                                </span><span class="hs-comment">-- Returns type of body</span><span>
</span><a name="line-78"></a><a name="tcMatchesFun"><a href="TcMatches.html#tcMatchesFun"><span class="hs-identifier">tcMatchesFun</span></a></a><span> </span><a name="local-6989586621683532072"><a href="#local-6989586621683532072"><span class="hs-identifier">fn</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532073"><a href="#local-6989586621683532073"><span class="hs-identifier">fun_name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532074"><a href="#local-6989586621683532074"><span class="hs-identifier">matches</span></a></a><span> </span><a name="local-6989586621683532075"><a href="#local-6989586621683532075"><span class="hs-identifier">exp_ty</span></a></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Check that they all have the same no of arguments</span><span>
</span><a name="line-80"></a><span>           </span><span class="hs-comment">-- Location is in the monad, set the caller so that</span><span>
</span><a name="line-81"></a><span>           </span><span class="hs-comment">-- any inter-equation error messages get some vaguely</span><span>
</span><a name="line-82"></a><span>           </span><span class="hs-comment">-- sensible location.        Note: we have to do this odd</span><span>
</span><a name="line-83"></a><span>           </span><span class="hs-comment">-- ann-grabbing, because we don't always have annotations in</span><span>
</span><a name="line-84"></a><span>           </span><span class="hs-comment">-- hand when we call tcMatchesFun...</span><span>
</span><a name="line-85"></a><span>          </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcMatchesFun&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532073"><span class="hs-identifier hs-var">fun_name</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532075"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcMatches.html#checkArgs"><span class="hs-identifier hs-var">checkArgs</span></a><span> </span><a href="#local-6989586621683532073"><span class="hs-identifier hs-var">fun_name</span></a><span> </span><a href="#local-6989586621683532074"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532087"><a href="#local-6989586621683532087"><span class="hs-identifier">wrap_gen</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532088"><a href="#local-6989586621683532088"><span class="hs-identifier">wrap_fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532089"><a href="#local-6989586621683532089"><span class="hs-identifier">group</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSkolemiseET"><span class="hs-identifier hs-var">tcSkolemiseET</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683532073"><span class="hs-identifier hs-var">fun_name</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532075"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532082"><a href="#local-6989586621683532082"><span class="hs-identifier">exp_rho</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-90"></a><span>                  </span><span class="hs-comment">-- Note [Polymorphic expected type for tcMatchesFun]</span><span>
</span><a name="line-91"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532085"><a href="#local-6989586621683532085"><span class="hs-identifier">matches'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532086"><a href="#local-6989586621683532086"><span class="hs-identifier">wrap_fun</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>                       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedFunTys"><span class="hs-identifier hs-var">matchExpectedFunTys</span></a><span> </span><a href="#local-6989586621683532077"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621683532076"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683532082"><span class="hs-identifier hs-var">exp_rho</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-93"></a><span>                          </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532083"><a href="#local-6989586621683532083"><span class="hs-identifier">pat_tys</span></a></a><span> </span><a name="local-6989586621683532084"><a href="#local-6989586621683532084"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-94"></a><span>                          </span><a href="TcMatches.html#tcMatches"><span class="hs-identifier hs-var">tcMatches</span></a><span> </span><a href="#local-6989586621683532079"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683532083"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532084"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621683532074"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-95"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532086"><span class="hs-identifier hs-var">wrap_fun</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532085"><span class="hs-identifier hs-var">matches'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532087"><span class="hs-identifier hs-var">wrap_gen</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683532088"><span class="hs-identifier hs-var">wrap_fun</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532089"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>    </span><a name="local-6989586621683532076"><a href="#local-6989586621683532076"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">matchGroupArity</span><span> </span><a href="#local-6989586621683532074"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-99"></a><span>    </span><a name="local-6989586621683532077"><a href="#local-6989586621683532077"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The equation(s) for&quot;</span><span>
</span><a name="line-100"></a><span>             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532073"><span class="hs-identifier hs-var">fun_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;have&quot;</span><span>
</span><a name="line-101"></a><span>    </span><a name="local-6989586621683532078"><a href="#local-6989586621683532078"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunRhs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532072"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mc_fixity</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Prefix</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mc_strictness</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532080"><span class="hs-identifier hs-var">strictness</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-102"></a><span>    </span><a name="local-6989586621683532079"><a href="#local-6989586621683532079"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#MC"><span class="hs-identifier hs-var">MC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532078"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621683532080"><a href="#local-6989586621683532080"><span class="hs-identifier">strictness</span></a></a><span>
</span><a name="line-104"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532081"><a href="#local-6989586621683532081"><span class="hs-identifier">match</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><a href="#local-6989586621683532074"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-105"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FunRhs</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_strictness</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SrcStrict</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">m_ctxt</span><span> </span><a href="#local-6989586621683532081"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-106"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SrcStrict</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-108"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoSrcStrict</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">{-
@tcMatchesCase@ doesn't do the argument-count check because the
parser guarantees that each equation has exactly one argument.
-}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">tcMatchesCase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532071"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-116"></a><span>                </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span> </span><a href="#local-6989586621683532071"><span class="hs-identifier hs-type">body</span></a><span>                        </span><span class="hs-comment">-- Case context</span><span>
</span><a name="line-117"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>                             </span><span class="hs-comment">-- Type of scrutinee</span><span>
</span><a name="line-118"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532071"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- The case alternatives</span><span>
</span><a name="line-119"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>                    </span><span class="hs-comment">-- Type of whole case expressions</span><span>
</span><a name="line-120"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532071"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>                </span><span class="hs-comment">-- Translated alternatives</span><span>
</span><a name="line-122"></a><span>                </span><span class="hs-comment">-- wrapper goes from MatchGroup's ty to expected ty</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><a name="tcMatchesCase"><a href="TcMatches.html#tcMatchesCase"><span class="hs-identifier">tcMatchesCase</span></a></a><span> </span><a name="local-6989586621683532090"><a href="#local-6989586621683532090"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532091"><a href="#local-6989586621683532091"><span class="hs-identifier">scrut_ty</span></a></a><span> </span><a name="local-6989586621683532092"><a href="#local-6989586621683532092"><span class="hs-identifier">matches</span></a></a><span> </span><a name="local-6989586621683532093"><a href="#local-6989586621683532093"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcMatches"><span class="hs-identifier hs-var">tcMatches</span></a><span> </span><a href="#local-6989586621683532090"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532091"><span class="hs-identifier hs-var">scrut_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532093"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683532092"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-identifier">tcMatchLambda</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-comment">-- see Note [Herald for matchExpectedFunTys] in TcUnify</span><span>
</span><a name="line-128"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span> </span><span class="hs-identifier hs-type">HsExpr</span><span>
</span><a name="line-129"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>   </span><span class="hs-comment">-- deeply skolemised</span><span>
</span><a name="line-131"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><a name="tcMatchLambda"><a href="TcMatches.html#tcMatchLambda"><span class="hs-identifier">tcMatchLambda</span></a></a><span> </span><a name="local-6989586621683532094"><a href="#local-6989586621683532094"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621683532095"><a href="#local-6989586621683532095"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><a name="local-6989586621683532096"><a href="#local-6989586621683532096"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621683532097"><a href="#local-6989586621683532097"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#matchExpectedFunTys"><span class="hs-identifier hs-var">matchExpectedFunTys</span></a><span> </span><a href="#local-6989586621683532094"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621683532098"><span class="hs-identifier hs-var">n_pats</span></a><span> </span><a href="#local-6989586621683532097"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532099"><a href="#local-6989586621683532099"><span class="hs-identifier">pat_tys</span></a></a><span> </span><a name="local-6989586621683532100"><a href="#local-6989586621683532100"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-134"></a><span>    </span><a href="TcMatches.html#tcMatches"><span class="hs-identifier hs-var">tcMatches</span></a><span> </span><a href="#local-6989586621683532095"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683532099"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532100"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621683532096"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-135"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-136"></a><span>    </span><a name="local-6989586621683532098"><a href="#local-6989586621683532098"><span class="hs-identifier">n_pats</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyMatchGroup</span><span> </span><a href="#local-6989586621683532096"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>   </span><span class="hs-comment">-- must be lambda-case</span><span>
</span><a name="line-137"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">matchGroupArity</span><span> </span><a href="#local-6989586621683532096"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- @tcGRHSsPat@ typechecks @[GRHSs]@ that occur in a @PatMonoBind@.</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">tcGRHSsPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRhoType</span><span>
</span><a name="line-142"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- Used for pattern bindings</span><span>
</span><a name="line-144"></a><a name="tcGRHSsPat"><a href="TcMatches.html#tcGRHSsPat"><span class="hs-identifier">tcGRHSsPat</span></a></a><span> </span><a name="local-6989586621683532101"><a href="#local-6989586621683532101"><span class="hs-identifier">grhss</span></a></a><span> </span><a name="local-6989586621683532102"><a href="#local-6989586621683532102"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcGRHSs"><span class="hs-identifier hs-var">tcGRHSs</span></a><span> </span><a href="#local-6989586621683532103"><span class="hs-identifier hs-var">match_ctxt</span></a><span> </span><a href="#local-6989586621683532101"><span class="hs-identifier hs-var">grhss</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532102"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-146"></a><span>    </span><a name="local-6989586621683532103"><a href="#local-6989586621683532103"><span class="hs-identifier">match_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#MC"><span class="hs-identifier hs-var">MC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PatBindRhs</span><span class="hs-special">,</span><span>
</span><a name="line-147"></a><span>                      </span><span class="hs-identifier">mc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcBody"><span class="hs-identifier hs-var">tcBody</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{tcMatch}
*                                                                      *
************************************************************************

Note [Case branches must never infer a non-tau type]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  case ... of
    ... -&gt; \(x :: forall a. a -&gt; a) -&gt; x
    ... -&gt; \y -&gt; y

Should that type-check? The problem is that, if we check the second branch
first, then we'll get a type (b -&gt; b) for the branches, which won't unify
with the polytype in the first branch. If we check the first branch first,
then everything is OK. This order-dependency is terrible. So we want only
proper tau-types in branches (unless a sigma-type is pushed down).
This is what expTypeToType ensures: it replaces an Infer with a fresh
tau-type.

An even trickier case looks like

  f x True  = x undefined
  f x False = x ()

Here, we see that the arguments must also be non-Infer. Thus, we must
use expTypeToType on the output of matchExpectedFunTys, not the input.

But we make a special case for a one-branch case. This is so that

  f = \(x :: forall a. a -&gt; a) -&gt; x

still gets assigned a polytype.
-}</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-comment">-- | When the MatchGroup has multiple RHSs, convert an Infer ExpType in the</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- expected type into TauTvs.</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- See Note [Case branches must never infer a non-tau type]</span><span>
</span><a name="line-190"></a><span class="hs-identifier">tauifyMultipleMatches</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LMatch</span><span> </span><a href="#local-6989586621683532069"><span class="hs-identifier hs-type">id</span></a><span> </span><a href="#local-6989586621683532070"><span class="hs-identifier hs-type">body</span></a><span class="hs-special">]</span><span>
</span><a name="line-191"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpType</span><span class="hs-special">]</span><span>
</span><a name="line-192"></a><a name="tauifyMultipleMatches"><a href="TcMatches.html#tauifyMultipleMatches"><span class="hs-identifier">tauifyMultipleMatches</span></a></a><span> </span><a name="local-6989586621683532104"><a href="#local-6989586621683532104"><span class="hs-identifier">group</span></a></a><span> </span><a name="local-6989586621683532105"><a href="#local-6989586621683532105"><span class="hs-identifier">exp_tys</span></a></a><span>
</span><a name="line-193"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSingletonMatchGroup</span><span> </span><a href="#local-6989586621683532104"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683532105"><span class="hs-identifier hs-var">exp_tys</span></a><span>
</span><a name="line-194"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#tauifyExpType"><span class="hs-identifier hs-var">tauifyExpType</span></a><span> </span><a href="#local-6989586621683532105"><span class="hs-identifier hs-var">exp_tys</span></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-comment">-- NB: In the empty-match case, this ensures we fill in the ExpType</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- | Type-check a MatchGroup.</span><span>
</span><a name="line-198"></a><span class="hs-identifier">tcMatches</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532068"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span> </span><a href="#local-6989586621683532068"><span class="hs-identifier hs-type">body</span></a><span>
</span><a name="line-199"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpSigmaType</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Expected pattern types</span><span>
</span><a name="line-200"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>          </span><span class="hs-comment">-- Expected result-type of the Match.</span><span>
</span><a name="line-201"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532068"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532068"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-keyword">data</span><span> </span><a name="TcMatchCtxt"><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier">TcMatchCtxt</span></a></a><span> </span><a name="local-6989586621683532057"><a href="#local-6989586621683532057"><span class="hs-identifier">body</span></a></a><span>   </span><span class="hs-comment">-- c.f. TcStmtCtxt, also in this module</span><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="MC"><a href="TcMatches.html#MC"><span class="hs-identifier">MC</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="mc_what"><a href="TcMatches.html#mc_what"><span class="hs-identifier">mc_what</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- What kind of thing this is</span><span>
</span><a name="line-206"></a><span>         </span><a name="mc_body"><a href="TcMatches.html#mc_body"><span class="hs-identifier">mc_body</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532057"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Type checker for a body of</span><span>
</span><a name="line-207"></a><span>                                                </span><span class="hs-comment">-- an alternative</span><span>
</span><a name="line-208"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-209"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532057"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><a name="tcMatches"><a href="TcMatches.html#tcMatches"><span class="hs-identifier">tcMatches</span></a></a><span> </span><a name="local-6989586621683532106"><a href="#local-6989586621683532106"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532107"><a href="#local-6989586621683532107"><span class="hs-identifier">pat_tys</span></a></a><span> </span><a name="local-6989586621683532108"><a href="#local-6989586621683532108"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532109"><a href="#local-6989586621683532109"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532110"><a href="#local-6989586621683532110"><span class="hs-identifier">matches</span></a></a><span>
</span><a name="line-212"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532111"><a href="#local-6989586621683532111"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532112"><a href="#local-6989586621683532112"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683532113"><a href="#local-6989586621683532113"><span class="hs-identifier">pat_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tauifyMultipleMatches"><span class="hs-identifier hs-var">tauifyMultipleMatches</span></a><span> </span><a href="#local-6989586621683532110"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532108"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683532107"><span class="hs-identifier hs-var">pat_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>            </span><span class="hs-comment">-- See Note [Case branches must never infer a non-tau type]</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532114"><a href="#local-6989586621683532114"><span class="hs-identifier">matches'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcMatches.html#tcMatch"><span class="hs-identifier hs-var">tcMatch</span></a><span> </span><a href="#local-6989586621683532106"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532113"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532112"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532110"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-217"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532115"><a href="#local-6989586621683532115"><span class="hs-identifier">pat_tys</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683532113"><span class="hs-identifier hs-var">pat_tys</span></a><span>
</span><a name="line-218"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532116"><a href="#local-6989586621683532116"><span class="hs-identifier">rhs_ty</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683532112"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-219"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532109"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532114"><span class="hs-identifier hs-var">matches'</span></a><span>
</span><a name="line-220"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MatchGroupTc</span><span> </span><a href="#local-6989586621683532115"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532116"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-221"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532111"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-222"></a><span class="hs-identifier">tcMatches</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatchGroup</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcMatches&quot;</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-225"></a><span class="hs-identifier">tcMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532067"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span> </span><a href="#local-6989586621683532067"><span class="hs-identifier hs-type">body</span></a><span>
</span><a name="line-226"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpSigmaType</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Expected pattern types</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>            </span><span class="hs-comment">-- Expected result-type of the Match.</span><span>
</span><a name="line-228"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LMatch</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532067"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LMatch</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532067"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><a name="tcMatch"><a href="TcMatches.html#tcMatch"><span class="hs-identifier">tcMatch</span></a></a><span> </span><a name="local-6989586621683532117"><a href="#local-6989586621683532117"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532118"><a href="#local-6989586621683532118"><span class="hs-identifier">pat_tys</span></a></a><span> </span><a name="local-6989586621683532119"><a href="#local-6989586621683532119"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><a name="local-6989586621683532120"><a href="#local-6989586621683532120"><span class="hs-identifier">match</span></a></a><span>
</span><a name="line-232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532121"><span class="hs-identifier hs-var">tc_match</span></a><span> </span><a href="#local-6989586621683532117"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532118"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532119"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532120"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-233"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-234"></a><span>    </span><a name="local-6989586621683532121"><a href="#local-6989586621683532121"><span class="hs-identifier">tc_match</span></a></a><span> </span><a name="local-6989586621683532123"><a href="#local-6989586621683532123"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532124"><a href="#local-6989586621683532124"><span class="hs-identifier">pat_tys</span></a></a><span> </span><a name="local-6989586621683532125"><a href="#local-6989586621683532125"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-235"></a><span>             </span><a name="local-6989586621683532126"><a href="#local-6989586621683532126"><span class="hs-identifier">match</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Match</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">m_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532127"><a href="#local-6989586621683532127"><span class="hs-identifier">pats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">m_grhss</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532128"><a href="#local-6989586621683532128"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532122"><span class="hs-identifier hs-var">add_match_ctxt</span></a><span> </span><a href="#local-6989586621683532126"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532129"><a href="#local-6989586621683532129"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532130"><a href="#local-6989586621683532130"><span class="hs-identifier">grhss'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPats"><span class="hs-identifier hs-var">tcPats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mc_what</span><span> </span><a href="#local-6989586621683532123"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532127"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621683532124"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-238"></a><span>                                </span><a href="TcMatches.html#tcGRHSs"><span class="hs-identifier hs-var">tcGRHSs</span></a><span> </span><a href="#local-6989586621683532123"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532128"><span class="hs-identifier hs-var">grhss</span></a><span> </span><a href="#local-6989586621683532125"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-239"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Match</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">m_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-240"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">m_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><a href="#local-6989586621683532123"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">m_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532129"><span class="hs-identifier hs-var">pats'</span></a><span>
</span><a name="line-241"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">m_grhss</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532130"><span class="hs-identifier hs-var">grhss'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-identifier">tc_match</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatch</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcMatch&quot;</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">-- For (\x -&gt; e), tcExpr has already said &quot;In the expression \x-&gt;e&quot;</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">-- so we don't want to add &quot;In the lambda abstraction \x-&gt;e&quot;</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621683532122"><a href="#local-6989586621683532122"><span class="hs-identifier">add_match_ctxt</span></a></a><span> </span><a name="local-6989586621683532131"><a href="#local-6989586621683532131"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621683532132"><a href="#local-6989586621683532132"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-247"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mc_what</span><span> </span><a href="#local-6989586621683532117"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-248"></a><span>            </span><span class="hs-identifier hs-var">LambdaExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532132"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-249"></a><span>            </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprMatchInCtxt</span><span> </span><a href="#local-6989586621683532131"><span class="hs-identifier hs-var">match</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532132"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-252"></a><span class="hs-identifier">tcGRHSs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span> </span><a href="#local-6989586621683532066"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532066"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GRHSs</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532066"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-comment">-- Notice that we pass in the full res_ty, so that we get</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- good inference from simple things like</span><span>
</span><a name="line-257"></a><span class="hs-comment">--      f = \(x::forall a.a-&gt;a) -&gt; &lt;stuff&gt;</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- We used to force it to be a monotype when there was more than one guard</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- but we don't need to do that any more</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><a name="tcGRHSs"><a href="TcMatches.html#tcGRHSs"><span class="hs-identifier">tcGRHSs</span></a></a><span> </span><a name="local-6989586621683532133"><a href="#local-6989586621683532133"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHSs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532134"><a href="#local-6989586621683532134"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532135"><a href="#local-6989586621683532135"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532136"><a href="#local-6989586621683532136"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532137"><a href="#local-6989586621683532137"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532138"><a href="#local-6989586621683532138"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532139"><a href="#local-6989586621683532139"><span class="hs-identifier">grhss'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcLocalBinds"><span class="hs-identifier hs-var">tcLocalBinds</span></a><span> </span><a href="#local-6989586621683532136"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-264"></a><span>               </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><span class="hs-special">(</span><a href="TcMatches.html#tcGRHS"><span class="hs-identifier hs-var">tcGRHS</span></a><span> </span><a href="#local-6989586621683532133"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532137"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532134"><span class="hs-identifier hs-var">grhss</span></a><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHSs</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683532139"><span class="hs-identifier hs-var">grhss'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532135"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532138"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-267"></a><span class="hs-identifier">tcGRHSs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XGRHSs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcGRHSs&quot;</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-270"></a><span class="hs-identifier">tcGRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcMatches.html#TcMatchCtxt"><span class="hs-identifier hs-type">TcMatchCtxt</span></a><span> </span><a href="#local-6989586621683532065"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GRHS</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532065"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GRHS</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532065"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><a name="tcGRHS"><a href="TcMatches.html#tcGRHS"><span class="hs-identifier">tcGRHS</span></a></a><span> </span><a name="local-6989586621683532140"><a href="#local-6989586621683532140"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532141"><a href="#local-6989586621683532141"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHS</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532142"><a href="#local-6989586621683532142"><span class="hs-identifier">guards</span></a></a><span> </span><a name="local-6989586621683532143"><a href="#local-6989586621683532143"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532145"><a href="#local-6989586621683532145"><span class="hs-identifier">guards'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532146"><a href="#local-6989586621683532146"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532144"><span class="hs-identifier hs-var">stmt_ctxt</span></a><span> </span><a href="TcMatches.html#tcGuardStmt"><span class="hs-identifier hs-var">tcGuardStmt</span></a><span> </span><a href="#local-6989586621683532142"><span class="hs-identifier hs-var">guards</span></a><span> </span><a href="#local-6989586621683532141"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-276"></a><span>               </span><span class="hs-identifier">mc_body</span><span> </span><a href="#local-6989586621683532140"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532143"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-277"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHS</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683532145"><span class="hs-identifier hs-var">guards'</span></a><span> </span><a href="#local-6989586621683532146"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-278"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-279"></a><span>    </span><a name="local-6989586621683532144"><a href="#local-6989586621683532144"><span class="hs-identifier">stmt_ctxt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PatGuard</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mc_what</span><span> </span><a href="#local-6989586621683532140"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span class="hs-identifier">tcGRHS</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XGRHS</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcGRHS&quot;</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{@tcDoStmts@ typechecks a {\em list} of do statements}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-identifier">tcDoStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-291"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-292"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-293"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- Returns a HsDo</span><span>
</span><a name="line-294"></a><a name="tcDoStmts"><a href="TcMatches.html#tcDoStmts"><span class="hs-identifier">tcDoStmts</span></a></a><span> </span><span class="hs-identifier hs-var">ListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532147"><a href="#local-6989586621683532147"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532148"><a href="#local-6989586621683532148"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532149"><a href="#local-6989586621683532149"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532150"><a href="#local-6989586621683532150"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683532149"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-296"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532151"><a href="#local-6989586621683532151"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532152"><a href="#local-6989586621683532152"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span> </span><a href="#local-6989586621683532150"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-297"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532153"><a href="#local-6989586621683532153"><span class="hs-identifier">list_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621683532152"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-298"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532154"><a href="#local-6989586621683532154"><span class="hs-identifier">stmts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmts"><span class="hs-identifier hs-var">tcStmts</span></a><span> </span><span class="hs-identifier hs-var">ListComp</span><span> </span><span class="hs-special">(</span><a href="TcMatches.html#tcLcStmt"><span class="hs-identifier hs-var">tcLcStmt</span></a><span> </span><span class="hs-identifier hs-var">listTyCon</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532148"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-299"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532152"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrapCo</span><span> </span><a href="#local-6989586621683532151"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621683532153"><span class="hs-identifier hs-var">list_ty</span></a><span> </span><span class="hs-identifier hs-var">ListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532147"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532154"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">tcDoStmts</span><span> </span><span class="hs-identifier hs-var">DoExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532155"><a href="#local-6989586621683532155"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532156"><a href="#local-6989586621683532156"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532157"><a href="#local-6989586621683532157"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532158"><a href="#local-6989586621683532158"><span class="hs-identifier">stmts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmts"><span class="hs-identifier hs-var">tcStmts</span></a><span> </span><span class="hs-identifier hs-var">DoExpr</span><span> </span><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier hs-var">tcDoStmt</span></a><span> </span><a href="#local-6989586621683532156"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532157"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-304"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532159"><a href="#local-6989586621683532159"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683532157"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-305"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621683532159"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-identifier hs-var">DoExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532155"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532158"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">tcDoStmts</span><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532160"><a href="#local-6989586621683532160"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532161"><a href="#local-6989586621683532161"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532162"><a href="#local-6989586621683532162"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-308"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532163"><a href="#local-6989586621683532163"><span class="hs-identifier">stmts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmts"><span class="hs-identifier hs-var">tcStmts</span></a><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier hs-var">tcDoStmt</span></a><span> </span><a href="#local-6989586621683532161"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532162"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-309"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532164"><a href="#local-6989586621683532164"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683532162"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-310"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621683532164"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532160"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532163"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-identifier">tcDoStmts</span><span> </span><span class="hs-identifier hs-var">MonadComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532165"><a href="#local-6989586621683532165"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532166"><a href="#local-6989586621683532166"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532167"><a href="#local-6989586621683532167"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-313"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532168"><a href="#local-6989586621683532168"><span class="hs-identifier">stmts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmts"><span class="hs-identifier hs-var">tcStmts</span></a><span> </span><span class="hs-identifier hs-var">MonadComp</span><span> </span><a href="TcMatches.html#tcMcStmt"><span class="hs-identifier hs-var">tcMcStmt</span></a><span> </span><a href="#local-6989586621683532166"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532167"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-314"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532169"><a href="#local-6989586621683532169"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683532167"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-315"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621683532169"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-identifier hs-var">MonadComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532165"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532168"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-identifier">tcDoStmts</span><span> </span><a name="local-6989586621683532170"><a href="#local-6989586621683532170"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcDoStmts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprStmtContext</span><span> </span><a href="#local-6989586621683532170"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-identifier">tcBody</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><a name="tcBody"><a href="TcMatches.html#tcBody"><span class="hs-identifier">tcBody</span></a></a><span> </span><a name="local-6989586621683532171"><a href="#local-6989586621683532171"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621683532172"><a href="#local-6989586621683532172"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-321"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcBody&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532172"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683532171"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621683532172"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-323"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{tcStmts}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-keyword">type</span><span> </span><a name="TcExprStmtChecker"><a href="TcMatches.html#TcExprStmtChecker"><span class="hs-identifier">TcExprStmtChecker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#TcStmtChecker"><span class="hs-identifier hs-type">TcStmtChecker</span></a><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-334"></a><span class="hs-keyword">type</span><span> </span><a name="TcCmdStmtChecker"><a href="TcMatches.html#TcCmdStmtChecker"><span class="hs-identifier">TcCmdStmtChecker</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#TcStmtChecker"><span class="hs-identifier hs-type">TcStmtChecker</span></a><span> </span><span class="hs-identifier hs-type">HsCmd</span><span>  </span><span class="hs-identifier hs-type">TcRhoType</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span class="hs-keyword">type</span><span> </span><a name="TcStmtChecker"><a href="TcMatches.html#TcStmtChecker"><span class="hs-identifier">TcStmtChecker</span></a></a><span> </span><a name="local-6989586621683532054"><a href="#local-6989586621683532054"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621683532055"><a href="#local-6989586621683532055"><span class="hs-identifier">rho_type</span></a></a><span>
</span><a name="line-337"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683532056"><a href="#local-6989586621683532056"><span class="hs-identifier">thing</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-338"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Stmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532054"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532055"><span class="hs-identifier hs-type">rho_type</span></a><span>                 </span><span class="hs-comment">-- Result type for comprehension</span><span>
</span><a name="line-340"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532055"><span class="hs-identifier hs-type">rho_type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683532056"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Checker for what follows the stmt</span><span>
</span><a name="line-341"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Stmt</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532054"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532056"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-identifier">tcStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532063"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMatches.html#TcStmtChecker"><span class="hs-identifier hs-type">TcStmtChecker</span></a><span> </span><a href="#local-6989586621683532063"><span class="hs-identifier hs-type">body</span></a><span> </span><a href="#local-6989586621683532064"><span class="hs-identifier hs-type">rho_type</span></a><span>   </span><span class="hs-comment">-- NB: higher-rank type</span><span>
</span><a name="line-345"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532063"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532064"><span class="hs-identifier hs-type">rho_type</span></a><span>
</span><a name="line-347"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532063"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-348"></a><a name="tcStmts"><a href="TcMatches.html#tcStmts"><span class="hs-identifier">tcStmts</span></a></a><span> </span><a name="local-6989586621683532173"><a href="#local-6989586621683532173"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532174"><a href="#local-6989586621683532174"><span class="hs-identifier">stmt_chk</span></a></a><span> </span><a name="local-6989586621683532175"><a href="#local-6989586621683532175"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621683532176"><a href="#local-6989586621683532176"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532177"><a href="#local-6989586621683532177"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532173"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532174"><span class="hs-identifier hs-var">stmt_chk</span></a><span> </span><a href="#local-6989586621683532175"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532176"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-350"></a><span>                        </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683532177"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-identifier">tcStmtsAndThen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532060"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-354"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMatches.html#TcStmtChecker"><span class="hs-identifier hs-type">TcStmtChecker</span></a><span> </span><a href="#local-6989586621683532060"><span class="hs-identifier hs-type">body</span></a><span> </span><a href="#local-6989586621683532061"><span class="hs-identifier hs-type">rho_type</span></a><span>    </span><span class="hs-comment">-- NB: higher-rank type</span><span>
</span><a name="line-355"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532060"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-356"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532061"><span class="hs-identifier hs-type">rho_type</span></a><span>
</span><a name="line-357"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532061"><span class="hs-identifier hs-type">rho_type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683532062"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LStmt</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532060"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532062"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-comment">-- Note the higher-rank type.  stmt_chk is applied at different</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- types in the equations for tcStmts</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><a name="tcStmtsAndThen"><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier">tcStmtsAndThen</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621683532178"><a href="#local-6989586621683532178"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532179"><a href="#local-6989586621683532179"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-364"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532180"><a href="#local-6989586621683532180"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532179"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532178"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-365"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532180"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">-- LetStmts are handled uniformly, regardless of context</span><span>
</span><a name="line-368"></a><span class="hs-identifier">tcStmtsAndThen</span><span> </span><a name="local-6989586621683532181"><a href="#local-6989586621683532181"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532182"><a href="#local-6989586621683532182"><span class="hs-identifier">stmt_chk</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532183"><a href="#local-6989586621683532183"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><a name="local-6989586621683532184"><a href="#local-6989586621683532184"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532185"><a href="#local-6989586621683532185"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683532186"><a href="#local-6989586621683532186"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683532187"><a href="#local-6989586621683532187"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>                                                             </span><a name="local-6989586621683532188"><a href="#local-6989586621683532188"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532189"><a href="#local-6989586621683532189"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-370"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532190"><a href="#local-6989586621683532190"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532191"><a href="#local-6989586621683532191"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683532192"><a href="#local-6989586621683532192"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcLocalBinds"><span class="hs-identifier hs-var">tcLocalBinds</span></a><span> </span><a href="#local-6989586621683532186"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-371"></a><span>              </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532181"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532182"><span class="hs-identifier hs-var">stmt_chk</span></a><span> </span><a href="#local-6989586621683532187"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532188"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683532189"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-372"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532183"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><a href="#local-6989586621683532184"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532185"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683532190"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683532191"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532192"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-comment">-- Don't set the error context for an ApplicativeStmt.  It ought to be</span><span>
</span><a name="line-375"></a><span class="hs-comment">-- possible to do this with a popErrCtxt in the tcStmt case for</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- ApplicativeStmt, but it did someting strange and broke a test (ado002).</span><span>
</span><a name="line-377"></a><span class="hs-identifier">tcStmtsAndThen</span><span> </span><a name="local-6989586621683532193"><a href="#local-6989586621683532193"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532194"><a href="#local-6989586621683532194"><span class="hs-identifier">stmt_chk</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683532195"><a href="#local-6989586621683532195"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683532196"><a href="#local-6989586621683532196"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683532197"><a href="#local-6989586621683532197"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532198"><a href="#local-6989586621683532198"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532199"><a href="#local-6989586621683532199"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-378"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ApplicativeStmt</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532196"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-379"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532201"><a href="#local-6989586621683532201"><span class="hs-identifier">stmt'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532202"><a href="#local-6989586621683532202"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532203"><a href="#local-6989586621683532203"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-380"></a><span>             </span><a href="#local-6989586621683532194"><span class="hs-identifier hs-var">stmt_chk</span></a><span> </span><a href="#local-6989586621683532193"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532196"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621683532198"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532200"><a href="#local-6989586621683532200"><span class="hs-identifier">res_ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-381"></a><span>               </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532193"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532194"><span class="hs-identifier hs-var">stmt_chk</span></a><span> </span><a href="#local-6989586621683532197"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532200"><span class="hs-identifier hs-var">res_ty'</span></a><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-382"></a><span>                 </span><a href="#local-6989586621683532199"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-383"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532195"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683532201"><span class="hs-identifier hs-var">stmt'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683532202"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532203"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>  </span><span class="hs-comment">-- For the vanilla case, handle the location-setting part</span><span>
</span><a name="line-386"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-387"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532205"><a href="#local-6989586621683532205"><span class="hs-identifier">stmt'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532206"><a href="#local-6989586621683532206"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532207"><a href="#local-6989586621683532207"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-388"></a><span>                </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683532195"><span class="hs-identifier hs-var">loc</span></a><span>                              </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-389"></a><span>                </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprStmtInCtxt</span><span> </span><a href="#local-6989586621683532193"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532196"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>        </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-390"></a><span>                </span><a href="#local-6989586621683532194"><span class="hs-identifier hs-var">stmt_chk</span></a><span> </span><a href="#local-6989586621683532193"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532196"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621683532198"><span class="hs-identifier hs-var">res_ty</span></a><span>                   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532204"><a href="#local-6989586621683532204"><span class="hs-identifier">res_ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-391"></a><span>                </span><a href="TcRnMonad.html#popErrCtxt"><span class="hs-identifier hs-var">popErrCtxt</span></a><span>                                  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-392"></a><span>                </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532193"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532194"><span class="hs-identifier hs-var">stmt_chk</span></a><span> </span><a href="#local-6989586621683532197"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532204"><span class="hs-identifier hs-var">res_ty'</span></a><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-393"></a><span>                </span><a href="#local-6989586621683532199"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-394"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683532195"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683532205"><span class="hs-identifier hs-var">stmt'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683532206"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532207"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-397"></a><span class="hs-comment">--              Pattern guards</span><span>
</span><a name="line-398"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span class="hs-identifier">tcGuardStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcMatches.html#TcExprStmtChecker"><span class="hs-identifier hs-type">TcExprStmtChecker</span></a><span>
</span><a name="line-401"></a><a name="tcGuardStmt"><a href="TcMatches.html#tcGuardStmt"><span class="hs-identifier">tcGuardStmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532208"><a href="#local-6989586621683532208"><span class="hs-identifier">guard</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532209"><a href="#local-6989586621683532209"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532210"><a href="#local-6989586621683532210"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-402"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532211"><a href="#local-6989586621683532211"><span class="hs-identifier">guard'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683532208"><span class="hs-identifier hs-var">guard</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532212"><a href="#local-6989586621683532212"><span class="hs-identifier">thing</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532210"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532209"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-404"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span> </span><a href="#local-6989586621683532211"><span class="hs-identifier hs-var">guard'</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532212"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-identifier">tcGuardStmt</span><span> </span><a name="local-6989586621683532213"><a href="#local-6989586621683532213"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532214"><a href="#local-6989586621683532214"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683532215"><a href="#local-6989586621683532215"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532216"><a href="#local-6989586621683532216"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532217"><a href="#local-6989586621683532217"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-407"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532218"><a href="#local-6989586621683532218"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532219"><a href="#local-6989586621683532219"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferSigmaNC"><span class="hs-identifier hs-var">tcInferSigmaNC</span></a><span> </span><a href="#local-6989586621683532215"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-408"></a><span>                                   </span><span class="hs-comment">-- Stmt has a context already</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532220"><a href="#local-6989586621683532220"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532221"><a href="#local-6989586621683532221"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPat_O"><span class="hs-identifier hs-var">tcPat_O</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621683532213"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683532215"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>                                    </span><a href="#local-6989586621683532214"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532219"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-411"></a><span>                            </span><a href="#local-6989586621683532217"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532216"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-412"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcBindStmt</span><span> </span><a href="#local-6989586621683532220"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532218"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532221"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-identifier">tcGuardStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532222"><a href="#local-6989586621683532222"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcGuardStmt: unexpected Stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532222"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-419"></a><span class="hs-comment">--           List comprehensions</span><span>
</span><a name="line-420"></a><span class="hs-comment">--               (no rebindable syntax)</span><span>
</span><a name="line-421"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-comment">-- Dealt with separately, rather than by tcMcStmt, because</span><span>
</span><a name="line-424"></a><span class="hs-comment">--   a) We have special desugaring rules for list comprehensions,</span><span>
</span><a name="line-425"></a><span class="hs-comment">--      which avoid creating intermediate lists.  They in turn</span><span>
</span><a name="line-426"></a><span class="hs-comment">--      assume that the bind/return operations are the regular</span><span>
</span><a name="line-427"></a><span class="hs-comment">--      polymorphic ones, and in particular don't have any</span><span>
</span><a name="line-428"></a><span class="hs-comment">--      coercion matching stuff in them.  It's hard to avoid the</span><span>
</span><a name="line-429"></a><span class="hs-comment">--      potential for non-trivial coercions in tcMcStmt</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">tcLcStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>       </span><span class="hs-comment">-- The list type constructor ([])</span><span>
</span><a name="line-432"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMatches.html#TcExprStmtChecker"><span class="hs-identifier hs-type">TcExprStmtChecker</span></a><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><a name="tcLcStmt"><a href="TcMatches.html#tcLcStmt"><span class="hs-identifier">tcLcStmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><a name="local-6989586621683532223"><a href="#local-6989586621683532223"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532224"><a href="#local-6989586621683532224"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621683532225"><a href="#local-6989586621683532225"><span class="hs-identifier">noret</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532226"><a href="#local-6989586621683532226"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621683532227"><a href="#local-6989586621683532227"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532228"><a href="#local-6989586621683532228"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532224"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621683532226"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-436"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532229"><a href="#local-6989586621683532229"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532227"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcLcStmt: thing_inside&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><a href="#local-6989586621683532223"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532228"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621683532225"><span class="hs-identifier hs-var">noret</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532229"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-comment">-- A generator, pat &lt;- rhs</span><span>
</span><a name="line-440"></a><span class="hs-identifier">tcLcStmt</span><span> </span><a name="local-6989586621683532230"><a href="#local-6989586621683532230"><span class="hs-identifier">m_tc</span></a></a><span> </span><a name="local-6989586621683532231"><a href="#local-6989586621683532231"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532232"><a href="#local-6989586621683532232"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683532233"><a href="#local-6989586621683532233"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532234"><a href="#local-6989586621683532234"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621683532235"><a href="#local-6989586621683532235"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-441"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532236"><a href="#local-6989586621683532236"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-442"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532237"><a href="#local-6989586621683532237"><span class="hs-identifier">rhs'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683532233"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683532230"><span class="hs-identifier hs-var">m_tc</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683532236"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532238"><a href="#local-6989586621683532238"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532239"><a href="#local-6989586621683532239"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPat"><span class="hs-identifier hs-var">tcPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621683532231"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532232"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532236"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-444"></a><span>                            </span><a href="#local-6989586621683532235"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532234"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-445"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcBindStmt</span><span> </span><a href="#local-6989586621683532238"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532237"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532239"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-comment">-- A boolean guard</span><span>
</span><a name="line-448"></a><span class="hs-identifier">tcLcStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532240"><a href="#local-6989586621683532240"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532241"><a href="#local-6989586621683532241"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621683532242"><a href="#local-6989586621683532242"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-449"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532243"><a href="#local-6989586621683532243"><span class="hs-identifier">rhs'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683532240"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532244"><a href="#local-6989586621683532244"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532242"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532241"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-451"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span> </span><a href="#local-6989586621683532243"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532244"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-comment">-- ParStmt: See notes with tcMcStmt</span><span>
</span><a name="line-454"></a><span class="hs-identifier">tcLcStmt</span><span> </span><a name="local-6989586621683532245"><a href="#local-6989586621683532245"><span class="hs-identifier">m_tc</span></a></a><span> </span><a name="local-6989586621683532246"><a href="#local-6989586621683532246"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532247"><a href="#local-6989586621683532247"><span class="hs-identifier">bndr_stmts_s</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532248"><a href="#local-6989586621683532248"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621683532249"><a href="#local-6989586621683532249"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-455"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532264"><a href="#local-6989586621683532264"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532265"><a href="#local-6989586621683532265"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532250"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621683532247"><span class="hs-identifier hs-var">bndr_stmts_s</span></a><span>
</span><a name="line-456"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span> </span><a href="#local-6989586621683532264"><span class="hs-identifier hs-var">pairs'</span></a><span> </span><span class="hs-identifier hs-var">noExpr</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532265"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-457"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-458"></a><span>    </span><span class="hs-comment">-- loop :: [([LStmt GhcRn], [GhcRn])]</span><span>
</span><a name="line-459"></a><span>    </span><span class="hs-comment">--      -&gt; TcM ([([LStmt GhcTcId], [GhcTcId])], thing)</span><span>
</span><a name="line-460"></a><span>    </span><a name="local-6989586621683532250"><a href="#local-6989586621683532250"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532251"><a href="#local-6989586621683532251"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532249"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532248"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-461"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532251"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>         </span><span class="hs-comment">-- matching in the branches</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><a name="local-6989586621683532252"><a href="#local-6989586621683532252"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532253"><a href="#local-6989586621683532253"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621683532254"><a href="#local-6989586621683532254"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683532255"><a href="#local-6989586621683532255"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532260"><a href="#local-6989586621683532260"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532261"><a href="#local-6989586621683532261"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532262"><a href="#local-6989586621683532262"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532263"><a href="#local-6989586621683532263"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532246"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><a href="TcMatches.html#tcLcStmt"><span class="hs-identifier hs-var">tcLcStmt</span></a><span> </span><a href="#local-6989586621683532245"><span class="hs-identifier hs-var">m_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532253"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532248"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532256"><a href="#local-6989586621683532256"><span class="hs-identifier">_elt_ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-466"></a><span>                   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532257"><a href="#local-6989586621683532257"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier hs-var">tcLookupLocalIds</span></a><span> </span><a href="#local-6989586621683532254"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-467"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532258"><a href="#local-6989586621683532258"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532259"><a href="#local-6989586621683532259"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532250"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621683532255"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-468"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532257"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532258"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532259"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-469"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><a href="#local-6989586621683532252"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532260"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><a href="#local-6989586621683532261"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683532262"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532263"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XParStmtBlock</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcLcStmt&quot;</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-identifier">tcLcStmt</span><span> </span><a name="local-6989586621683532266"><a href="#local-6989586621683532266"><span class="hs-identifier">m_tc</span></a></a><span> </span><a name="local-6989586621683532267"><a href="#local-6989586621683532267"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532268"><a href="#local-6989586621683532268"><span class="hs-identifier">form</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532269"><a href="#local-6989586621683532269"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-473"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span>  </span><a name="local-6989586621683532270"><a href="#local-6989586621683532270"><span class="hs-identifier">bindersMap</span></a></a><span>
</span><a name="line-474"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532271"><a href="#local-6989586621683532271"><span class="hs-identifier">by</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532272"><a href="#local-6989586621683532272"><span class="hs-identifier">using</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532273"><a href="#local-6989586621683532273"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621683532274"><a href="#local-6989586621683532274"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-475"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532275"><a href="#local-6989586621683532275"><span class="hs-identifier">bndr_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532276"><a href="#local-6989586621683532276"><span class="hs-identifier">n_bndr_names</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621683532270"><span class="hs-identifier hs-var">bindersMap</span></a><span>
</span><a name="line-476"></a><span>             </span><a name="local-6989586621683532277"><a href="#local-6989586621683532277"><span class="hs-identifier">unused_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLcStmt: inner ty&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532270"><span class="hs-identifier hs-var">bindersMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>             </span><span class="hs-comment">-- The inner 'stmts' lack a LastStmt, so the element type</span><span>
</span><a name="line-478"></a><span>             </span><span class="hs-comment">--  passed in to tcStmtsAndThen is never looked at</span><span>
</span><a name="line-479"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532280"><a href="#local-6989586621683532280"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532281"><a href="#local-6989586621683532281"><span class="hs-identifier">bndr_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532282"><a href="#local-6989586621683532282"><span class="hs-identifier">by'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmtCtxt</span><span> </span><a href="#local-6989586621683532267"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcMatches.html#tcLcStmt"><span class="hs-identifier hs-var">tcLcStmt</span></a><span> </span><a href="#local-6989586621683532266"><span class="hs-identifier hs-var">m_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532269"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532277"><span class="hs-identifier hs-var">unused_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-481"></a><span>               </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532278"><a href="#local-6989586621683532278"><span class="hs-identifier">by'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><a href="#local-6989586621683532271"><span class="hs-identifier hs-var">by</span></a><span>
</span><a name="line-482"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532279"><a href="#local-6989586621683532279"><span class="hs-identifier">bndr_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier hs-var">tcLookupLocalIds</span></a><span> </span><a href="#local-6989586621683532275"><span class="hs-identifier hs-var">bndr_names</span></a><span>
</span><a name="line-483"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532279"><span class="hs-identifier hs-var">bndr_ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532278"><span class="hs-identifier hs-var">by'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532283"><a href="#local-6989586621683532283"><span class="hs-identifier">m_app</span></a></a><span> </span><a name="local-6989586621683532284"><a href="#local-6989586621683532284"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683532266"><span class="hs-identifier hs-var">m_tc</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683532284"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span>       </span><span class="hs-comment">--------------- Typecheck the 'using' function -------------</span><span>
</span><a name="line-488"></a><span>       </span><span class="hs-comment">-- using :: ((a,b,c)-&gt;t) -&gt; m (a,b,c) -&gt; m (a,b,c)m      (ThenForm)</span><span>
</span><a name="line-489"></a><span>       </span><span class="hs-comment">--       :: ((a,b,c)-&gt;t) -&gt; m (a,b,c) -&gt; m (m (a,b,c)))  (GroupForm)</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>         </span><span class="hs-comment">-- n_app :: Type -&gt; Type   -- Wraps a 'ty' into '[ty]' for GroupForm</span><span>
</span><a name="line-492"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532285"><a href="#local-6989586621683532285"><span class="hs-identifier">n_app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532268"><span class="hs-identifier hs-var">form</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-493"></a><span>                       </span><span class="hs-identifier hs-var">ThenForm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683532291"><a href="#local-6989586621683532291"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532291"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>                       </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532283"><span class="hs-identifier hs-var">m_app</span></a><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span>             </span><span class="hs-identifier">by_arrow</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>     </span><span class="hs-comment">-- Wraps 'ty' to '(a-&gt;t) -&gt; ty' if the By is present</span><span>
</span><a name="line-497"></a><span>             </span><a name="local-6989586621683532286"><a href="#local-6989586621683532286"><span class="hs-identifier">by_arrow</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532282"><span class="hs-identifier hs-var">by'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-498"></a><span>                          </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683532292"><a href="#local-6989586621683532292"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532292"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-499"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683532293"><a href="#local-6989586621683532293"><span class="hs-identifier">e_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683532294"><a href="#local-6989586621683532294"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">alphaTy</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532293"><span class="hs-identifier hs-var">e_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532294"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>             </span><a name="local-6989586621683532287"><a href="#local-6989586621683532287"><span class="hs-identifier">tup_ty</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621683532281"><span class="hs-identifier hs-var">bndr_ids</span></a><span>
</span><a name="line-502"></a><span>             </span><a name="local-6989586621683532288"><a href="#local-6989586621683532288"><span class="hs-identifier">poly_arg_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532283"><span class="hs-identifier hs-var">m_app</span></a><span> </span><span class="hs-identifier hs-var">alphaTy</span><span>
</span><a name="line-503"></a><span>             </span><a name="local-6989586621683532289"><a href="#local-6989586621683532289"><span class="hs-identifier">poly_res_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532283"><span class="hs-identifier hs-var">m_app</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532285"><span class="hs-identifier hs-var">n_app</span></a><span> </span><span class="hs-identifier hs-var">alphaTy</span><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>             </span><a name="local-6989586621683532290"><a href="#local-6989586621683532290"><span class="hs-identifier">using_poly_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTy</span><span> </span><span class="hs-identifier hs-var">alphaTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-505"></a><span>                             </span><a href="#local-6989586621683532286"><span class="hs-identifier hs-var">by_arrow</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-506"></a><span>                             </span><a href="#local-6989586621683532288"><span class="hs-identifier hs-var">poly_arg_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532289"><span class="hs-identifier hs-var">poly_res_ty</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532295"><a href="#local-6989586621683532295"><span class="hs-identifier">using'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683532272"><span class="hs-identifier hs-var">using</span></a><span> </span><a href="#local-6989586621683532290"><span class="hs-identifier hs-var">using_poly_ty</span></a><span>
</span><a name="line-509"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532296"><a href="#local-6989586621683532296"><span class="hs-identifier">final_using</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a href="#local-6989586621683532287"><span class="hs-identifier hs-var">tup_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532295"><span class="hs-identifier hs-var">using'</span></a><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span>             </span><span class="hs-comment">-- 'stmts' returns a result of type (m1_ty tuple_ty),</span><span>
</span><a name="line-512"></a><span>             </span><span class="hs-comment">-- typically something like [(Int,Bool,Int)]</span><span>
</span><a name="line-513"></a><span>             </span><span class="hs-comment">-- We don't know what tuple_ty is yet, so we use a variable</span><span>
</span><a name="line-514"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">mk_n_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-515"></a><span>             </span><a name="local-6989586621683532297"><a href="#local-6989586621683532297"><span class="hs-identifier">mk_n_bndr</span></a></a><span> </span><a name="local-6989586621683532300"><a href="#local-6989586621683532300"><span class="hs-identifier">n_bndr_name</span></a></a><span> </span><a name="local-6989586621683532301"><a href="#local-6989586621683532301"><span class="hs-identifier">bndr_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalIdOrCoVar</span><span> </span><a href="#local-6989586621683532300"><span class="hs-identifier hs-var">n_bndr_name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532285"><span class="hs-identifier hs-var">n_app</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683532301"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span>             </span><span class="hs-comment">-- Ensure that every old binder of type `b` is linked up with its</span><span>
</span><a name="line-518"></a><span>             </span><span class="hs-comment">-- new binder which should have type `n b`</span><span>
</span><a name="line-519"></a><span>             </span><span class="hs-comment">-- See Note [GroupStmt binder map] in HsExpr</span><span>
</span><a name="line-520"></a><span>             </span><a name="local-6989586621683532298"><a href="#local-6989586621683532298"><span class="hs-identifier">n_bndr_ids</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621683532297"><span class="hs-identifier hs-var">mk_n_bndr</span></a><span> </span><a href="#local-6989586621683532276"><span class="hs-identifier hs-var">n_bndr_names</span></a><span> </span><a href="#local-6989586621683532281"><span class="hs-identifier hs-var">bndr_ids</span></a><span>
</span><a name="line-521"></a><span>             </span><a name="local-6989586621683532299"><a href="#local-6989586621683532299"><span class="hs-identifier">bindersMap'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532281"><span class="hs-identifier hs-var">bndr_ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532298"><span class="hs-identifier hs-var">n_bndr_ids</span></a><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>       </span><span class="hs-comment">-- Type check the thing in the environment with</span><span>
</span><a name="line-524"></a><span>       </span><span class="hs-comment">-- these new binders and return the result</span><span>
</span><a name="line-525"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532302"><a href="#local-6989586621683532302"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier hs-var">tcExtendIdEnv</span></a><span> </span><a href="#local-6989586621683532298"><span class="hs-identifier hs-var">n_bndr_ids</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532274"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532273"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532280"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532299"><span class="hs-identifier hs-var">bindersMap'</span></a><span>
</span><a name="line-528"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683532282"><span class="hs-identifier hs-var">by'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532296"><span class="hs-identifier hs-var">final_using</span></a><span>
</span><a name="line-529"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-530"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bind</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-531"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_fmap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExpr</span><span>
</span><a name="line-532"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span>
</span><a name="line-533"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532268"><span class="hs-identifier hs-var">form</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532302"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-identifier">tcLcStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532303"><a href="#local-6989586621683532303"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLcStmt: unexpected Stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532303"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-540"></a><span class="hs-comment">--           Monad comprehensions</span><span>
</span><a name="line-541"></a><span class="hs-comment">--        (supports rebindable syntax)</span><span>
</span><a name="line-542"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-identifier">tcMcStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcMatches.html#TcExprStmtChecker"><span class="hs-identifier hs-type">TcExprStmtChecker</span></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><a name="tcMcStmt"><a href="TcMatches.html#tcMcStmt"><span class="hs-identifier">tcMcStmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><a name="local-6989586621683532304"><a href="#local-6989586621683532304"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532305"><a href="#local-6989586621683532305"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621683532306"><a href="#local-6989586621683532306"><span class="hs-identifier">noret</span></a></a><span> </span><a name="local-6989586621683532307"><a href="#local-6989586621683532307"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532308"><a href="#local-6989586621683532308"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532309"><a href="#local-6989586621683532309"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532311"><a href="#local-6989586621683532311"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532312"><a href="#local-6989586621683532312"><span class="hs-identifier">return_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532307"><span class="hs-identifier hs-var">return_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532308"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-549"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532310"><a href="#local-6989586621683532310"><span class="hs-identifier">a_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-550"></a><span>               </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532305"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532310"><span class="hs-identifier hs-var">a_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532313"><a href="#local-6989586621683532313"><span class="hs-identifier">thing</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532309"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcMcStmt: thing_inside&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><a href="#local-6989586621683532304"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532311"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621683532306"><span class="hs-identifier hs-var">noret</span></a><span> </span><a href="#local-6989586621683532312"><span class="hs-identifier hs-var">return_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532313"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-comment">-- Generators for monad comprehensions ( pat &lt;- rhs )</span><span>
</span><a name="line-555"></a><span class="hs-comment">--</span><span>
</span><a name="line-556"></a><span class="hs-comment">--   [ body | q &lt;- gen ]  -&gt;  gen :: m a</span><span>
</span><a name="line-557"></a><span class="hs-comment">--                            q   ::   a</span><span>
</span><a name="line-558"></a><span class="hs-comment">--</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-identifier">tcMcStmt</span><span> </span><a name="local-6989586621683532314"><a href="#local-6989586621683532314"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532315"><a href="#local-6989586621683532315"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683532316"><a href="#local-6989586621683532316"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621683532317"><a href="#local-6989586621683532317"><span class="hs-identifier">bind_op</span></a></a><span> </span><a name="local-6989586621683532318"><a href="#local-6989586621683532318"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532319"><a href="#local-6989586621683532319"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532320"><a href="#local-6989586621683532320"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-561"></a><span>           </span><span class="hs-comment">-- (&gt;&gt;=) :: rhs_ty -&gt; (pat_ty -&gt; new_res_ty) -&gt; res_ty</span><span>
</span><a name="line-562"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532327"><a href="#local-6989586621683532327"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532328"><a href="#local-6989586621683532328"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532329"><a href="#local-6989586621683532329"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532330"><a href="#local-6989586621683532330"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532331"><a href="#local-6989586621683532331"><span class="hs-identifier">bind_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532317"><span class="hs-identifier hs-var">bind_op</span></a><span>
</span><a name="line-564"></a><span>                          </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynFun</span><span> </span><span class="hs-identifier hs-var">SynAny</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532319"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-565"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532321"><a href="#local-6989586621683532321"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532322"><a href="#local-6989586621683532322"><span class="hs-identifier">pat_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532323"><a href="#local-6989586621683532323"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-566"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532324"><a href="#local-6989586621683532324"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532316"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532321"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532325"><a href="#local-6989586621683532325"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532326"><a href="#local-6989586621683532326"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPat"><span class="hs-identifier hs-var">tcPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621683532314"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532315"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-568"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532322"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-569"></a><span>                                     </span><a href="#local-6989586621683532320"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532323"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-570"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532324"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532325"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532326"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532323"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>        </span><span class="hs-comment">-- If (but only if) the pattern can fail, typecheck the 'fail' operator</span><span>
</span><a name="line-573"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532332"><a href="#local-6989586621683532332"><span class="hs-identifier">fail_op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcMonadFailOp"><span class="hs-identifier hs-var">tcMonadFailOp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MCompPatOrigin</span><span> </span><a href="#local-6989586621683532315"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532328"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532318"><span class="hs-identifier hs-var">fail_op</span></a><span> </span><a href="#local-6989586621683532330"><span class="hs-identifier hs-var">new_res_ty</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a href="#local-6989586621683532330"><span class="hs-identifier hs-var">new_res_ty</span></a><span> </span><a href="#local-6989586621683532328"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532327"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621683532331"><span class="hs-identifier hs-var">bind_op'</span></a><span> </span><a href="#local-6989586621683532332"><span class="hs-identifier hs-var">fail_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532329"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-comment">-- Boolean expressions.</span><span>
</span><a name="line-578"></a><span class="hs-comment">--</span><span>
</span><a name="line-579"></a><span class="hs-comment">--   [ body | stmts, expr ]  -&gt;  expr :: m Bool</span><span>
</span><a name="line-580"></a><span class="hs-comment">--</span><span>
</span><a name="line-581"></a><span class="hs-identifier">tcMcStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532333"><a href="#local-6989586621683532333"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621683532334"><a href="#local-6989586621683532334"><span class="hs-identifier">then_op</span></a></a><span> </span><a name="local-6989586621683532335"><a href="#local-6989586621683532335"><span class="hs-identifier">guard_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532336"><a href="#local-6989586621683532336"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532337"><a href="#local-6989586621683532337"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-582"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Deal with rebindable syntax:</span><span>
</span><a name="line-583"></a><span>          </span><span class="hs-comment">--    guard_op :: test_ty -&gt; rhs_ty</span><span>
</span><a name="line-584"></a><span>          </span><span class="hs-comment">--    then_op  :: rhs_ty -&gt; new_res_ty -&gt; res_ty</span><span>
</span><a name="line-585"></a><span>          </span><span class="hs-comment">-- Where test_ty is, for example, Bool</span><span>
</span><a name="line-586"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532344"><a href="#local-6989586621683532344"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532345"><a href="#local-6989586621683532345"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532346"><a href="#local-6989586621683532346"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532347"><a href="#local-6989586621683532347"><span class="hs-identifier">guard_op'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532348"><a href="#local-6989586621683532348"><span class="hs-identifier">then_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532334"><span class="hs-identifier hs-var">then_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532336"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-588"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532338"><a href="#local-6989586621683532338"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532339"><a href="#local-6989586621683532339"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-589"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532341"><a href="#local-6989586621683532341"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532342"><a href="#local-6989586621683532342"><span class="hs-identifier">guard_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>                      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532335"><span class="hs-identifier hs-var">guard_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynAny</span><span class="hs-special">]</span><span>
</span><a name="line-591"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532338"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-592"></a><span>                         </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532340"><a href="#local-6989586621683532340"><span class="hs-identifier">test_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-593"></a><span>                         </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683532333"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532340"><span class="hs-identifier hs-var">test_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532343"><a href="#local-6989586621683532343"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532337"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532339"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532343"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532341"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532338"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532342"><span class="hs-identifier hs-var">guard_op'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-596"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><a href="#local-6989586621683532346"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621683532345"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621683532348"><span class="hs-identifier hs-var">then_op'</span></a><span> </span><a href="#local-6989586621683532347"><span class="hs-identifier hs-var">guard_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532344"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-comment">-- Grouping statements</span><span>
</span><a name="line-599"></a><span class="hs-comment">--</span><span>
</span><a name="line-600"></a><span class="hs-comment">--   [ body | stmts, then group by e using f ]</span><span>
</span><a name="line-601"></a><span class="hs-comment">--     -&gt;  e :: t</span><span>
</span><a name="line-602"></a><span class="hs-comment">--         f :: forall a. (a -&gt; t) -&gt; m a -&gt; m (m a)</span><span>
</span><a name="line-603"></a><span class="hs-comment">--   [ body | stmts, then group using f ]</span><span>
</span><a name="line-604"></a><span class="hs-comment">--     -&gt;  f :: forall a. m a -&gt; m (m a)</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-comment">-- We type [ body | (stmts, group by e using f), ... ]</span><span>
</span><a name="line-607"></a><span class="hs-comment">--     f &lt;optional by&gt; [ (a,b,c) | stmts ] &gt;&gt;= \(a,b,c) -&gt; ...body....</span><span>
</span><a name="line-608"></a><span class="hs-comment">--</span><span>
</span><a name="line-609"></a><span class="hs-comment">-- We type the functions as follows:</span><span>
</span><a name="line-610"></a><span class="hs-comment">--     f &lt;optional by&gt; :: m1 (a,b,c) -&gt; m2 (a,b,c)              (ThenForm)</span><span>
</span><a name="line-611"></a><span class="hs-comment">--                     :: m1 (a,b,c) -&gt; m2 (n (a,b,c))          (GroupForm)</span><span>
</span><a name="line-612"></a><span class="hs-comment">--     (&gt;&gt;=) :: m2 (a,b,c)     -&gt; ((a,b,c)   -&gt; res) -&gt; res     (ThenForm)</span><span>
</span><a name="line-613"></a><span class="hs-comment">--           :: m2 (n (a,b,c)) -&gt; (n (a,b,c) -&gt; res) -&gt; res     (GroupForm)</span><span>
</span><a name="line-614"></a><span class="hs-comment">--</span><span>
</span><a name="line-615"></a><span class="hs-identifier">tcMcStmt</span><span> </span><a name="local-6989586621683532349"><a href="#local-6989586621683532349"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532350"><a href="#local-6989586621683532350"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532351"><a href="#local-6989586621683532351"><span class="hs-identifier">bindersMap</span></a></a><span>
</span><a name="line-616"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532352"><a href="#local-6989586621683532352"><span class="hs-identifier">by</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532353"><a href="#local-6989586621683532353"><span class="hs-identifier">using</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532354"><a href="#local-6989586621683532354"><span class="hs-identifier">form</span></a></a><span>
</span><a name="line-617"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532355"><a href="#local-6989586621683532355"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bind</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532356"><a href="#local-6989586621683532356"><span class="hs-identifier">bind_op</span></a></a><span>
</span><a name="line-618"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_fmap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532357"><a href="#local-6989586621683532357"><span class="hs-identifier">fmap_op</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532358"><a href="#local-6989586621683532358"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532359"><a href="#local-6989586621683532359"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532360"><a href="#local-6989586621683532360"><span class="hs-identifier">star_star_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-620"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532361"><a href="#local-6989586621683532361"><span class="hs-identifier">m1_ty</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-6989586621683532360"><span class="hs-identifier hs-var">star_star_kind</span></a><span>
</span><a name="line-621"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532362"><a href="#local-6989586621683532362"><span class="hs-identifier">m2_ty</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-6989586621683532360"><span class="hs-identifier hs-var">star_star_kind</span></a><span>
</span><a name="line-622"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532363"><a href="#local-6989586621683532363"><span class="hs-identifier">tup_ty</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-623"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532364"><a href="#local-6989586621683532364"><span class="hs-identifier">by_e_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>  </span><span class="hs-comment">-- The type of the 'by' expression (if any)</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>         </span><span class="hs-comment">-- n_app :: Type -&gt; Type   -- Wraps a 'ty' into '(n ty)' for GroupForm</span><span>
</span><a name="line-626"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532367"><a href="#local-6989586621683532367"><span class="hs-identifier">n_app</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532354"><span class="hs-identifier hs-var">form</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-627"></a><span>                    </span><span class="hs-identifier hs-var">ThenForm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683532365"><a href="#local-6989586621683532365"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532365"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>                    </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532366"><a href="#local-6989586621683532366"><span class="hs-identifier">n_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-6989586621683532360"><span class="hs-identifier hs-var">star_star_kind</span></a><span>
</span><a name="line-629"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532366"><span class="hs-identifier hs-var">n_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-630"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">by_arrow</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-631"></a><span>             </span><span class="hs-comment">-- (by_arrow res) produces ((alpha-&gt;e_ty) -&gt; res)     ('by' present)</span><span>
</span><a name="line-632"></a><span>             </span><span class="hs-comment">--                          or res                    ('by' absent)</span><span>
</span><a name="line-633"></a><span>             </span><a name="local-6989586621683532368"><a href="#local-6989586621683532368"><span class="hs-identifier">by_arrow</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532352"><span class="hs-identifier hs-var">by</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-634"></a><span>                          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683532374"><a href="#local-6989586621683532374"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532374"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-635"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683532375"><a href="#local-6989586621683532375"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">alphaTy</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532364"><span class="hs-identifier hs-var">by_e_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532375"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>             </span><a name="local-6989586621683532369"><a href="#local-6989586621683532369"><span class="hs-identifier">poly_arg_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532361"><span class="hs-identifier hs-var">m1_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">alphaTy</span><span>
</span><a name="line-638"></a><span>             </span><a name="local-6989586621683532370"><a href="#local-6989586621683532370"><span class="hs-identifier">using_arg_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532361"><span class="hs-identifier hs-var">m1_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532363"><span class="hs-identifier hs-var">tup_ty</span></a><span>
</span><a name="line-639"></a><span>             </span><a name="local-6989586621683532371"><a href="#local-6989586621683532371"><span class="hs-identifier">poly_res_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532362"><span class="hs-identifier hs-var">m2_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><span class="hs-identifier hs-var">alphaTy</span><span>
</span><a name="line-640"></a><span>             </span><a name="local-6989586621683532372"><a href="#local-6989586621683532372"><span class="hs-identifier">using_res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532362"><span class="hs-identifier hs-var">m2_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><a href="#local-6989586621683532363"><span class="hs-identifier hs-var">tup_ty</span></a><span>
</span><a name="line-641"></a><span>             </span><a name="local-6989586621683532373"><a href="#local-6989586621683532373"><span class="hs-identifier">using_poly_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTy</span><span> </span><span class="hs-identifier hs-var">alphaTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-642"></a><span>                             </span><a href="#local-6989586621683532368"><span class="hs-identifier hs-var">by_arrow</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-643"></a><span>                             </span><a href="#local-6989586621683532369"><span class="hs-identifier hs-var">poly_arg_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532371"><span class="hs-identifier hs-var">poly_res_ty</span></a><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span>             </span><span class="hs-comment">-- 'stmts' returns a result of type (m1_ty tuple_ty),</span><span>
</span><a name="line-646"></a><span>             </span><span class="hs-comment">-- typically something like [(Int,Bool,Int)]</span><span>
</span><a name="line-647"></a><span>             </span><span class="hs-comment">-- We don't know what tuple_ty is yet, so we use a variable</span><span>
</span><a name="line-648"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532376"><a href="#local-6989586621683532376"><span class="hs-identifier">bndr_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532377"><a href="#local-6989586621683532377"><span class="hs-identifier">n_bndr_names</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621683532351"><span class="hs-identifier hs-var">bindersMap</span></a><span>
</span><a name="line-649"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532384"><a href="#local-6989586621683532384"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532385"><a href="#local-6989586621683532385"><span class="hs-identifier">bndr_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532386"><a href="#local-6989586621683532386"><span class="hs-identifier">by'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532387"><a href="#local-6989586621683532387"><span class="hs-identifier">return_op'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-650"></a><span>            </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmtCtxt</span><span> </span><a href="#local-6989586621683532349"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="TcMatches.html#tcMcStmt"><span class="hs-identifier hs-var">tcMcStmt</span></a><span> </span><a href="#local-6989586621683532350"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-651"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532370"><span class="hs-identifier hs-var">using_arg_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683532378"><a href="#local-6989586621683532378"><span class="hs-identifier">res_ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-652"></a><span>                </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532381"><a href="#local-6989586621683532381"><span class="hs-identifier">by'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532352"><span class="hs-identifier hs-var">by</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-653"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-654"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683532379"><a href="#local-6989586621683532379"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532380"><a href="#local-6989586621683532380"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621683532379"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-655"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532364"><span class="hs-identifier hs-var">by_e_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>                                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683532380"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span>                </span><span class="hs-comment">-- Find the Ids (and hence types) of all old binders</span><span>
</span><a name="line-659"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532382"><a href="#local-6989586621683532382"><span class="hs-identifier">bndr_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier hs-var">tcLookupLocalIds</span></a><span> </span><a href="#local-6989586621683532376"><span class="hs-identifier hs-var">bndr_names</span></a><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span>                </span><span class="hs-comment">-- 'return' is only used for the binders, so we know its type.</span><span>
</span><a name="line-662"></a><span>                </span><span class="hs-comment">--   return :: (a,b,c,..) -&gt; m (a,b,c,..)</span><span>
</span><a name="line-663"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532383"><a href="#local-6989586621683532383"><span class="hs-identifier">return_op'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532355"><span class="hs-identifier hs-var">return_op</span></a><span>
</span><a name="line-664"></a><span>                                       </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621683532382"><span class="hs-identifier hs-var">bndr_ids</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-665"></a><span>                                       </span><a href="#local-6989586621683532378"><span class="hs-identifier hs-var">res_ty'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532382"><span class="hs-identifier hs-var">bndr_ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532381"><span class="hs-identifier hs-var">by'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532383"><span class="hs-identifier hs-var">return_op'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>       </span><span class="hs-comment">--------------- Typecheck the 'bind' function -------------</span><span>
</span><a name="line-670"></a><span>       </span><span class="hs-comment">-- (&gt;&gt;=) :: m2 (n (a,b,c)) -&gt; ( n (a,b,c) -&gt; new_res_ty ) -&gt; res_ty</span><span>
</span><a name="line-671"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532388"><a href="#local-6989586621683532388"><span class="hs-identifier">new_res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-672"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532389"><a href="#local-6989586621683532389"><span class="hs-identifier">bind_op'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532356"><span class="hs-identifier hs-var">bind_op</span></a><span>
</span><a name="line-673"></a><span>                             </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532372"><span class="hs-identifier hs-var">using_res_ty</span></a><span>
</span><a name="line-674"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><a href="#local-6989586621683532363"><span class="hs-identifier hs-var">tup_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532388"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-675"></a><span>                             </span><a href="#local-6989586621683532358"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span>       </span><span class="hs-comment">--------------- Typecheck the 'fmap' function -------------</span><span>
</span><a name="line-678"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532390"><a href="#local-6989586621683532390"><span class="hs-identifier">fmap_op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532354"><span class="hs-identifier hs-var">form</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-679"></a><span>                       </span><span class="hs-identifier hs-var">ThenForm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">noExpr</span><span>
</span><a name="line-680"></a><span>                       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683532357"><span class="hs-identifier hs-var">fmap_op</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-681"></a><span>                            </span><span class="hs-identifier hs-var">mkInvForAllTy</span><span> </span><span class="hs-identifier hs-var">alphaTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-682"></a><span>                            </span><span class="hs-identifier hs-var">mkInvForAllTy</span><span> </span><span class="hs-identifier hs-var">betaTyVar</span><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-683"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">alphaTy</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">betaTy</span><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><span class="hs-identifier hs-var">alphaTy</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><span class="hs-identifier hs-var">betaTy</span><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span>       </span><span class="hs-comment">--------------- Typecheck the 'using' function -------------</span><span>
</span><a name="line-688"></a><span>       </span><span class="hs-comment">-- using :: ((a,b,c)-&gt;t) -&gt; m1 (a,b,c) -&gt; m2 (n (a,b,c))</span><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532391"><a href="#local-6989586621683532391"><span class="hs-identifier">using'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621683532353"><span class="hs-identifier hs-var">using</span></a><span> </span><a href="#local-6989586621683532373"><span class="hs-identifier hs-var">using_poly_ty</span></a><span>
</span><a name="line-691"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532392"><a href="#local-6989586621683532392"><span class="hs-identifier">final_using</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a href="#local-6989586621683532363"><span class="hs-identifier hs-var">tup_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532391"><span class="hs-identifier hs-var">using'</span></a><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span>       </span><span class="hs-comment">--------------- Bulding the bindersMap ----------------</span><span>
</span><a name="line-694"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">mk_n_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-695"></a><span>             </span><a name="local-6989586621683532393"><a href="#local-6989586621683532393"><span class="hs-identifier">mk_n_bndr</span></a></a><span> </span><a name="local-6989586621683532396"><a href="#local-6989586621683532396"><span class="hs-identifier">n_bndr_name</span></a></a><span> </span><a name="local-6989586621683532397"><a href="#local-6989586621683532397"><span class="hs-identifier">bndr_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalIdOrCoVar</span><span> </span><a href="#local-6989586621683532396"><span class="hs-identifier hs-var">n_bndr_name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683532397"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span>             </span><span class="hs-comment">-- Ensure that every old binder of type `b` is linked up with its</span><span>
</span><a name="line-698"></a><span>             </span><span class="hs-comment">-- new binder which should have type `n b`</span><span>
</span><a name="line-699"></a><span>             </span><span class="hs-comment">-- See Note [GroupStmt binder map] in HsExpr</span><span>
</span><a name="line-700"></a><span>             </span><a name="local-6989586621683532394"><a href="#local-6989586621683532394"><span class="hs-identifier">n_bndr_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621683532393"><span class="hs-identifier hs-var">mk_n_bndr</span></a><span> </span><a href="#local-6989586621683532377"><span class="hs-identifier hs-var">n_bndr_names</span></a><span> </span><a href="#local-6989586621683532385"><span class="hs-identifier hs-var">bndr_ids</span></a><span>
</span><a name="line-701"></a><span>             </span><a name="local-6989586621683532395"><a href="#local-6989586621683532395"><span class="hs-identifier">bindersMap'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532385"><span class="hs-identifier hs-var">bndr_ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532394"><span class="hs-identifier hs-var">n_bndr_ids</span></a><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span>       </span><span class="hs-comment">-- Type check the thing in the environment with</span><span>
</span><a name="line-704"></a><span>       </span><span class="hs-comment">-- these new binders and return the result</span><span>
</span><a name="line-705"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532398"><a href="#local-6989586621683532398"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier hs-var">tcExtendIdEnv</span></a><span> </span><a href="#local-6989586621683532394"><span class="hs-identifier hs-var">n_bndr_ids</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-706"></a><span>                  </span><a href="#local-6989586621683532359"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532388"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532384"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532395"><span class="hs-identifier hs-var">bindersMap'</span></a><span>
</span><a name="line-709"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532386"><span class="hs-identifier hs-var">by'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532392"><span class="hs-identifier hs-var">final_using</span></a><span>
</span><a name="line-710"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532387"><span class="hs-identifier hs-var">return_op'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bind</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532389"><span class="hs-identifier hs-var">bind_op'</span></a><span>
</span><a name="line-711"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532367"><span class="hs-identifier hs-var">n_app</span></a><span> </span><a href="#local-6989586621683532363"><span class="hs-identifier hs-var">tup_ty</span></a><span>
</span><a name="line-712"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_fmap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532390"><span class="hs-identifier hs-var">fmap_op'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532354"><span class="hs-identifier hs-var">form</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532398"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span class="hs-comment">-- A parallel set of comprehensions</span><span>
</span><a name="line-715"></a><span class="hs-comment">--      [ (g x, h x) | ... ; let g v = ...</span><span>
</span><a name="line-716"></a><span class="hs-comment">--                   | ... ; let h v = ... ]</span><span>
</span><a name="line-717"></a><span class="hs-comment">--</span><span>
</span><a name="line-718"></a><span class="hs-comment">-- It's possible that g,h are overloaded, so we need to feed the LIE from the</span><span>
</span><a name="line-719"></a><span class="hs-comment">-- (g x, h x) up through both lots of bindings (so we get the bindLocalMethods).</span><span>
</span><a name="line-720"></a><span class="hs-comment">-- Similarly if we had an existential pattern match:</span><span>
</span><a name="line-721"></a><span class="hs-comment">--</span><span>
</span><a name="line-722"></a><span class="hs-comment">--      data T = forall a. Show a =&gt; C a</span><span>
</span><a name="line-723"></a><span class="hs-comment">--</span><span>
</span><a name="line-724"></a><span class="hs-comment">--      [ (show x, show y) | ... ; C x &lt;- ...</span><span>
</span><a name="line-725"></a><span class="hs-comment">--                         | ... ; C y &lt;- ... ]</span><span>
</span><a name="line-726"></a><span class="hs-comment">--</span><span>
</span><a name="line-727"></a><span class="hs-comment">-- Then we need the LIE from (show x, show y) to be simplified against</span><span>
</span><a name="line-728"></a><span class="hs-comment">-- the bindings for x and y.</span><span>
</span><a name="line-729"></a><span class="hs-comment">--</span><span>
</span><a name="line-730"></a><span class="hs-comment">-- It's difficult to do this in parallel, so we rely on the renamer to</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- ensure that g,h and x,y don't duplicate, and simply grow the environment.</span><span>
</span><a name="line-732"></a><span class="hs-comment">-- So the binders of the first parallel group will be in scope in the second</span><span>
</span><a name="line-733"></a><span class="hs-comment">-- group.  But that's fine; there's no shadowing to worry about.</span><span>
</span><a name="line-734"></a><span class="hs-comment">--</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- Note: The `mzip` function will get typechecked via:</span><span>
</span><a name="line-736"></a><span class="hs-comment">--</span><span>
</span><a name="line-737"></a><span class="hs-comment">--   ParStmt [st1::t1, st2::t2, st3::t3]</span><span>
</span><a name="line-738"></a><span class="hs-comment">--</span><span>
</span><a name="line-739"></a><span class="hs-comment">--   mzip :: m st1</span><span>
</span><a name="line-740"></a><span class="hs-comment">--        -&gt; (m st2 -&gt; m st3 -&gt; m (st2, st3))   -- recursive call</span><span>
</span><a name="line-741"></a><span class="hs-comment">--        -&gt; m (st1, (st2, st3))</span><span>
</span><a name="line-742"></a><span class="hs-comment">--</span><span>
</span><a name="line-743"></a><span class="hs-identifier">tcMcStmt</span><span> </span><a name="local-6989586621683532399"><a href="#local-6989586621683532399"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532400"><a href="#local-6989586621683532400"><span class="hs-identifier">bndr_stmts_s</span></a></a><span> </span><a name="local-6989586621683532401"><a href="#local-6989586621683532401"><span class="hs-identifier">mzip_op</span></a></a><span> </span><a name="local-6989586621683532402"><a href="#local-6989586621683532402"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532403"><a href="#local-6989586621683532403"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532404"><a href="#local-6989586621683532404"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-744"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532433"><a href="#local-6989586621683532433"><span class="hs-identifier">star_star_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-745"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532434"><a href="#local-6989586621683532434"><span class="hs-identifier">m_ty</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><a href="#local-6989586621683532433"><span class="hs-identifier hs-var">star_star_kind</span></a><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532435"><a href="#local-6989586621683532435"><span class="hs-identifier">mzip_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">alphaTyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">betaTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-748"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621683532434"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">alphaTy</span><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span>
</span><a name="line-750"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621683532434"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">betaTy</span><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span>
</span><a name="line-752"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621683532434"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkBoxedTupleTy</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">alphaTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">betaTy</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532436"><a href="#local-6989586621683532436"><span class="hs-identifier">mzip_op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683532401"><span class="hs-identifier hs-var">mzip_op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532435"><span class="hs-identifier hs-var">mzip_ty</span></a><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>        </span><span class="hs-comment">-- type dummies since we don't know all binder types yet</span><span>
</span><a name="line-756"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532438"><a href="#local-6989586621683532438"><span class="hs-identifier">id_tys_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapM</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>                       </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683532437"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532437"><a href="#local-6989586621683532437"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532400"><span class="hs-identifier hs-var">bndr_stmts_s</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a><span>       </span><span class="hs-comment">-- Typecheck bind:</span><span>
</span><a name="line-760"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532439"><a href="#local-6989586621683532439"><span class="hs-identifier">tup_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621683532441"><span class="hs-identifier hs-var">id_tys</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683532441"><a href="#local-6989586621683532441"><span class="hs-identifier">id_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532438"><span class="hs-identifier hs-var">id_tys_s</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-761"></a><span>             </span><a name="local-6989586621683532440"><a href="#local-6989586621683532440"><span class="hs-identifier">tuple_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532405"><span class="hs-identifier hs-var">mk_tuple_ty</span></a><span> </span><a href="#local-6989586621683532439"><span class="hs-identifier hs-var">tup_tys</span></a><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532444"><a href="#local-6989586621683532444"><span class="hs-identifier">blocks'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532445"><a href="#local-6989586621683532445"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532446"><a href="#local-6989586621683532446"><span class="hs-identifier">inner_res_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532447"><a href="#local-6989586621683532447"><span class="hs-identifier">bind_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532402"><span class="hs-identifier hs-var">bind_op</span></a><span>
</span><a name="line-765"></a><span>                         </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532434"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532440"><span class="hs-identifier hs-var">tuple_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynFun</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532440"><span class="hs-identifier hs-var">tuple_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span> </span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532403"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-767"></a><span>              </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532442"><a href="#local-6989586621683532442"><span class="hs-identifier">inner_res_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-768"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532443"><a href="#local-6989586621683532443"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532406"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621683532434"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532442"><span class="hs-identifier hs-var">inner_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>                                 </span><a href="#local-6989586621683532439"><span class="hs-identifier hs-var">tup_tys</span></a><span> </span><a href="#local-6989586621683532400"><span class="hs-identifier hs-var">bndr_stmts_s</span></a><span>
</span><a name="line-770"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532443"><span class="hs-identifier hs-var">stuff</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532442"><span class="hs-identifier hs-var">inner_res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><a href="#local-6989586621683532446"><span class="hs-identifier hs-var">inner_res_ty</span></a><span> </span><a href="#local-6989586621683532444"><span class="hs-identifier hs-var">blocks'</span></a><span> </span><a href="#local-6989586621683532436"><span class="hs-identifier hs-var">mzip_op'</span></a><span> </span><a href="#local-6989586621683532447"><span class="hs-identifier hs-var">bind_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532445"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-775"></a><span>    </span><a name="local-6989586621683532405"><a href="#local-6989586621683532405"><span class="hs-identifier">mk_tuple_ty</span></a></a><span> </span><a name="local-6989586621683532407"><a href="#local-6989586621683532407"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683532408"><a href="#local-6989586621683532408"><span class="hs-identifier">tn</span></a></a><span> </span><a name="local-6989586621683532409"><a href="#local-6989586621683532409"><span class="hs-identifier">tm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkBoxedTupleTy</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683532408"><span class="hs-identifier hs-var">tn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532409"><span class="hs-identifier hs-var">tm</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532407"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>       </span><span class="hs-comment">-- loop :: Type                                  -- m_ty</span><span>
</span><a name="line-778"></a><span>       </span><span class="hs-comment">--      -&gt; ExpRhoType                            -- inner_res_ty</span><span>
</span><a name="line-779"></a><span>       </span><span class="hs-comment">--      -&gt; [TcType]                              -- tup_tys</span><span>
</span><a name="line-780"></a><span>       </span><span class="hs-comment">--      -&gt; [ParStmtBlock Name]</span><span>
</span><a name="line-781"></a><span>       </span><span class="hs-comment">--      -&gt; TcM ([([LStmt GhcTcId], [GhcTcId])], thing)</span><span>
</span><a name="line-782"></a><span>    </span><a name="local-6989586621683532406"><a href="#local-6989586621683532406"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532410"><a href="#local-6989586621683532410"><span class="hs-identifier">inner_res_ty</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532411"><a href="#local-6989586621683532411"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532404"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532410"><span class="hs-identifier hs-var">inner_res_ty</span></a><span>
</span><a name="line-783"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532411"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-784"></a><span>                                   </span><span class="hs-comment">-- matching in the branches</span><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><a name="local-6989586621683532412"><a href="#local-6989586621683532412"><span class="hs-identifier">m_ty</span></a></a><span> </span><a name="local-6989586621683532413"><a href="#local-6989586621683532413"><span class="hs-identifier">inner_res_ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683532414"><a href="#local-6989586621683532414"><span class="hs-identifier">tup_ty_in</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683532415"><a href="#local-6989586621683532415"><span class="hs-identifier">tup_tys_in</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><a name="local-6989586621683532416"><a href="#local-6989586621683532416"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532417"><a href="#local-6989586621683532417"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621683532418"><a href="#local-6989586621683532418"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621683532419"><a href="#local-6989586621683532419"><span class="hs-identifier">return_op</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683532420"><a href="#local-6989586621683532420"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532421"><a href="#local-6989586621683532421"><span class="hs-identifier">m_tup_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532412"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532414"><span class="hs-identifier hs-var">tup_ty_in</span></a><span>
</span><a name="line-789"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532428"><a href="#local-6989586621683532428"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532429"><a href="#local-6989586621683532429"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532430"><a href="#local-6989586621683532430"><span class="hs-identifier">return_op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532431"><a href="#local-6989586621683532431"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532432"><a href="#local-6989586621683532432"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-790"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532399"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="TcMatches.html#tcMcStmt"><span class="hs-identifier hs-var">tcMcStmt</span></a><span> </span><a href="#local-6989586621683532417"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532421"><span class="hs-identifier hs-var">m_tup_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-791"></a><span>                   </span><span class="hs-glyph">\</span><a name="local-6989586621683532422"><a href="#local-6989586621683532422"><span class="hs-identifier">m_tup_ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-792"></a><span>                   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532423"><a href="#local-6989586621683532423"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier hs-var">tcLookupLocalIds</span></a><span> </span><a href="#local-6989586621683532418"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-793"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532424"><a href="#local-6989586621683532424"><span class="hs-identifier">tup_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621683532423"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-794"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532425"><a href="#local-6989586621683532425"><span class="hs-identifier">return_op'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-795"></a><span>                          </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">MCompOrigin</span><span> </span><a href="#local-6989586621683532419"><span class="hs-identifier hs-var">return_op</span></a><span>
</span><a name="line-796"></a><span>                                     </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532424"><span class="hs-identifier hs-var">tup_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532422"><span class="hs-identifier hs-var">m_tup_ty'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-797"></a><span>                                     </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532426"><a href="#local-6989586621683532426"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532427"><a href="#local-6989586621683532427"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532406"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621683532412"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><a href="#local-6989586621683532413"><span class="hs-identifier hs-var">inner_res_ty</span></a><span> </span><a href="#local-6989586621683532415"><span class="hs-identifier hs-var">tup_tys_in</span></a><span> </span><a href="#local-6989586621683532420"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-799"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532423"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532425"><span class="hs-identifier hs-var">return_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532426"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532427"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-800"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><a href="#local-6989586621683532416"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532428"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><a href="#local-6989586621683532429"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621683532430"><span class="hs-identifier hs-var">return_op'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683532431"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532432"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-801"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcMcStmt.loop&quot;</span><span>
</span><a name="line-802"></a><span>
</span><a name="line-803"></a><span class="hs-identifier">tcMcStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532448"><a href="#local-6989586621683532448"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-804"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcMcStmt: unexpected Stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532448"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-808"></a><span class="hs-comment">--           Do-notation</span><span>
</span><a name="line-809"></a><span class="hs-comment">--        (supports rebindable syntax)</span><span>
</span><a name="line-810"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span class="hs-identifier">tcDoStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcMatches.html#TcExprStmtChecker"><span class="hs-identifier hs-type">TcExprStmtChecker</span></a><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><a name="tcDoStmt"><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier">tcDoStmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><a name="local-6989586621683532449"><a href="#local-6989586621683532449"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532450"><a href="#local-6989586621683532450"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621683532451"><a href="#local-6989586621683532451"><span class="hs-identifier">noret</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532452"><a href="#local-6989586621683532452"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532453"><a href="#local-6989586621683532453"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-815"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532454"><a href="#local-6989586621683532454"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532450"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621683532452"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-816"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532455"><a href="#local-6989586621683532455"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532453"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcDoStmt: thing_inside&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><a href="#local-6989586621683532449"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532454"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621683532451"><span class="hs-identifier hs-var">noret</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532455"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">tcDoStmt</span><span> </span><a name="local-6989586621683532456"><a href="#local-6989586621683532456"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532457"><a href="#local-6989586621683532457"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683532458"><a href="#local-6989586621683532458"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621683532459"><a href="#local-6989586621683532459"><span class="hs-identifier">bind_op</span></a></a><span> </span><a name="local-6989586621683532460"><a href="#local-6989586621683532460"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532461"><a href="#local-6989586621683532461"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532462"><a href="#local-6989586621683532462"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-820"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Deal with rebindable syntax:</span><span>
</span><a name="line-821"></a><span>                </span><span class="hs-comment">--       (&gt;&gt;=) :: rhs_ty -&gt; (pat_ty -&gt; new_res_ty) -&gt; res_ty</span><span>
</span><a name="line-822"></a><span>                </span><span class="hs-comment">-- This level of generality is needed for using do-notation</span><span>
</span><a name="line-823"></a><span>                </span><span class="hs-comment">-- in full generality; see Trac #1537</span><span>
</span><a name="line-824"></a><span>
</span><a name="line-825"></a><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532469"><a href="#local-6989586621683532469"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532470"><a href="#local-6989586621683532470"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532471"><a href="#local-6989586621683532471"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532472"><a href="#local-6989586621683532472"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532473"><a href="#local-6989586621683532473"><span class="hs-identifier">bind_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532459"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynFun</span><span> </span><span class="hs-identifier hs-var">SynAny</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532461"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-827"></a><span>                </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532463"><a href="#local-6989586621683532463"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532464"><a href="#local-6989586621683532464"><span class="hs-identifier">pat_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532465"><a href="#local-6989586621683532465"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-828"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532466"><a href="#local-6989586621683532466"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532458"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532463"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532467"><a href="#local-6989586621683532467"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532468"><a href="#local-6989586621683532468"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPat"><span class="hs-identifier hs-var">tcPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621683532456"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532457"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-830"></a><span>                                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532464"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-831"></a><span>                                      </span><a href="#local-6989586621683532462"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532465"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532466"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532467"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532465"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532468"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span>        </span><span class="hs-comment">-- If (but only if) the pattern can fail, typecheck the 'fail' operator</span><span>
</span><a name="line-835"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532474"><a href="#local-6989586621683532474"><span class="hs-identifier">fail_op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMatches.html#tcMonadFailOp"><span class="hs-identifier hs-var">tcMonadFailOp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DoPatOrigin</span><span> </span><a href="#local-6989586621683532457"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532470"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532460"><span class="hs-identifier hs-var">fail_op</span></a><span> </span><a href="#local-6989586621683532471"><span class="hs-identifier hs-var">new_res_ty</span></a><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a href="#local-6989586621683532471"><span class="hs-identifier hs-var">new_res_ty</span></a><span> </span><a href="#local-6989586621683532470"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532469"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621683532473"><span class="hs-identifier hs-var">bind_op'</span></a><span> </span><a href="#local-6989586621683532474"><span class="hs-identifier hs-var">fail_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532472"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-identifier">tcDoStmt</span><span> </span><a name="local-6989586621683532475"><a href="#local-6989586621683532475"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532476"><a href="#local-6989586621683532476"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621683532477"><a href="#local-6989586621683532477"><span class="hs-identifier">mb_join</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683532478"><a href="#local-6989586621683532478"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532479"><a href="#local-6989586621683532479"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-840"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532480"><a href="#local-6989586621683532480"><span class="hs-identifier">tc_app_stmts</span></a></a><span> </span><a name="local-6989586621683532481"><a href="#local-6989586621683532481"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcApplicativeStmts"><span class="hs-identifier hs-var">tcApplicativeStmts</span></a><span> </span><a href="#local-6989586621683532475"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683532476"><span class="hs-identifier hs-var">pairs</span></a><span> </span><a href="#local-6989586621683532481"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-841"></a><span>                                </span><a href="#local-6989586621683532479"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkCheckExpType</span><span>
</span><a name="line-842"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532484"><a href="#local-6989586621683532484"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532485"><a href="#local-6989586621683532485"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532486"><a href="#local-6989586621683532486"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532487"><a href="#local-6989586621683532487"><span class="hs-identifier">mb_join'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683532477"><span class="hs-identifier hs-var">mb_join</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-843"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683532480"><span class="hs-identifier hs-var">tc_app_stmts</span></a><span> </span><a href="#local-6989586621683532478"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-844"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683532482"><a href="#local-6989586621683532482"><span class="hs-identifier">join_op</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-845"></a><span>              </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-846"></a><span>              </span><span class="hs-special">(</span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532482"><span class="hs-identifier hs-var">join_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532478"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-847"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532483"><a href="#local-6989586621683532483"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683532480"><span class="hs-identifier hs-var">tc_app_stmts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532483"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>
</span><a name="line-849"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><a href="#local-6989586621683532485"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><a href="#local-6989586621683532484"><span class="hs-identifier hs-var">pairs'</span></a><span> </span><a href="#local-6989586621683532487"><span class="hs-identifier hs-var">mb_join'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532486"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span class="hs-identifier">tcDoStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532488"><a href="#local-6989586621683532488"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621683532489"><a href="#local-6989586621683532489"><span class="hs-identifier">then_op</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683532490"><a href="#local-6989586621683532490"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532491"><a href="#local-6989586621683532491"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Deal with rebindable syntax;</span><span>
</span><a name="line-853"></a><span>                </span><span class="hs-comment">--   (&gt;&gt;) :: rhs_ty -&gt; new_res_ty -&gt; res_ty</span><span>
</span><a name="line-854"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532496"><a href="#local-6989586621683532496"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532497"><a href="#local-6989586621683532497"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532498"><a href="#local-6989586621683532498"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532499"><a href="#local-6989586621683532499"><span class="hs-identifier">then_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-855"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532489"><span class="hs-identifier hs-var">then_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532490"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-856"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532492"><a href="#local-6989586621683532492"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532493"><a href="#local-6989586621683532493"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-857"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532494"><a href="#local-6989586621683532494"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532488"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532492"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532495"><a href="#local-6989586621683532495"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532491"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532493"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-859"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532494"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532492"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532495"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-860"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><a href="#local-6989586621683532497"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621683532496"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621683532499"><span class="hs-identifier hs-var">then_op'</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532498"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span class="hs-identifier">tcDoStmt</span><span> </span><a name="local-6989586621683532500"><a href="#local-6989586621683532500"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532501"><a href="#local-6989586621683532501"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_later_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532502"><a href="#local-6989586621683532502"><span class="hs-identifier">later_names</span></a></a><span>
</span><a name="line-863"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532503"><a href="#local-6989586621683532503"><span class="hs-identifier">rec_names</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ret_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532504"><a href="#local-6989586621683532504"><span class="hs-identifier">ret_op</span></a></a><span>
</span><a name="line-864"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_mfix_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532505"><a href="#local-6989586621683532505"><span class="hs-identifier">mfix_op</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_bind_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532506"><a href="#local-6989586621683532506"><span class="hs-identifier">bind_op</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-865"></a><span>         </span><a name="local-6989586621683532507"><a href="#local-6989586621683532507"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621683532508"><a href="#local-6989586621683532508"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-866"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532509"><a href="#local-6989586621683532509"><span class="hs-identifier">tup_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532503"><span class="hs-identifier hs-var">rec_names</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683532503"><span class="hs-identifier hs-var">rec_names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532502"><span class="hs-identifier hs-var">later_names</span></a><span>
</span><a name="line-867"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532510"><a href="#local-6989586621683532510"><span class="hs-identifier">tup_elt_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTys"><span class="hs-identifier hs-var">newFlexiTyVarTys</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683532509"><span class="hs-identifier hs-var">tup_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-868"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532511"><a href="#local-6989586621683532511"><span class="hs-identifier">tup_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683532509"><span class="hs-identifier hs-var">tup_names</span></a><span> </span><a href="#local-6989586621683532510"><span class="hs-identifier hs-var">tup_elt_tys</span></a><span>
</span><a name="line-869"></a><span>              </span><a name="local-6989586621683532512"><a href="#local-6989586621683532512"><span class="hs-identifier">tup_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621683532510"><span class="hs-identifier hs-var">tup_elt_tys</span></a><span>
</span><a name="line-870"></a><span>
</span><a name="line-871"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier hs-var">tcExtendIdEnv</span></a><span> </span><a href="#local-6989586621683532511"><span class="hs-identifier hs-var">tup_ids</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-872"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532517"><a href="#local-6989586621683532517"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532518"><a href="#local-6989586621683532518"><span class="hs-identifier">ret_op'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532519"><a href="#local-6989586621683532519"><span class="hs-identifier">tup_rets</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532520"><a href="#local-6989586621683532520"><span class="hs-identifier">stmts_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-873"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcInferInst"><span class="hs-identifier hs-var">tcInferInst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532513"><a href="#local-6989586621683532513"><span class="hs-identifier">exp_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-874"></a><span>                   </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532500"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier hs-var">tcDoStmt</span></a><span> </span><a href="#local-6989586621683532501"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621683532513"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532514"><a href="#local-6989586621683532514"><span class="hs-identifier">inner_res_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-875"></a><span>                   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532515"><a href="#local-6989586621683532515"><span class="hs-identifier">tup_rets</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="TcExpr.html#tcCheckId"><span class="hs-identifier hs-var">tcCheckId</span></a><span> </span><a href="#local-6989586621683532509"><span class="hs-identifier hs-var">tup_names</span></a><span>
</span><a name="line-876"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532510"><span class="hs-identifier hs-var">tup_elt_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span>                             </span><span class="hs-comment">-- Unify the types of the &quot;final&quot; Ids (which may</span><span>
</span><a name="line-878"></a><span>                             </span><span class="hs-comment">-- be polymorphic) with those of &quot;knot-tied&quot; Ids</span><span>
</span><a name="line-879"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532516"><a href="#local-6989586621683532516"><span class="hs-identifier">ret_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-880"></a><span>                          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532504"><span class="hs-identifier hs-var">ret_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532512"><span class="hs-identifier hs-var">tup_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-881"></a><span>                                        </span><a href="#local-6989586621683532514"><span class="hs-identifier hs-var">inner_res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-882"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532516"><span class="hs-identifier hs-var">ret_op'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532515"><span class="hs-identifier hs-var">tup_rets</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-883"></a><span>
</span><a name="line-884"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532522"><a href="#local-6989586621683532522"><span class="hs-identifier">mfix_op'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532523"><a href="#local-6989586621683532523"><span class="hs-identifier">mfix_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-885"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcInferInst"><span class="hs-identifier hs-var">tcInferInst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683532521"><a href="#local-6989586621683532521"><span class="hs-identifier">exp_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-886"></a><span>               </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532505"><span class="hs-identifier hs-var">mfix_op</span></a><span>
</span><a name="line-887"></a><span>                          </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683532512"><span class="hs-identifier hs-var">tup_ty</span></a><span> </span><a href="#local-6989586621683532520"><span class="hs-identifier hs-var">stmts_ty</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532521"><span class="hs-identifier hs-var">exp_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-888"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-889"></a><span>
</span><a name="line-890"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532526"><a href="#local-6989586621683532526"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532527"><a href="#local-6989586621683532527"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532528"><a href="#local-6989586621683532528"><span class="hs-identifier">bind_op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-891"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532506"><span class="hs-identifier hs-var">bind_op</span></a><span>
</span><a name="line-892"></a><span>                          </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532523"><span class="hs-identifier hs-var">mfix_res_ty</span></a><span>
</span><a name="line-893"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532512"><span class="hs-identifier hs-var">tup_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">SynFun</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-894"></a><span>                          </span><a href="#local-6989586621683532507"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-895"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683532524"><a href="#local-6989586621683532524"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-896"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532525"><a href="#local-6989586621683532525"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532508"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532524"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532525"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532524"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532529"><a href="#local-6989586621683532529"><span class="hs-identifier">rec_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeList</span><span> </span><a href="#local-6989586621683532503"><span class="hs-identifier hs-var">rec_names</span></a><span> </span><a href="#local-6989586621683532511"><span class="hs-identifier hs-var">tup_ids</span></a><span>
</span><a name="line-900"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532530"><a href="#local-6989586621683532530"><span class="hs-identifier">later_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier hs-var">tcLookupLocalIds</span></a><span> </span><a href="#local-6989586621683532502"><span class="hs-identifier hs-var">later_names</span></a><span>
</span><a name="line-901"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcdo&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532529"><span class="hs-identifier hs-var">rec_ids</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683532529"><span class="hs-identifier hs-var">rec_ids</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-902"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532530"><span class="hs-identifier hs-var">later_ids</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683532530"><span class="hs-identifier hs-var">later_ids</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-903"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532517"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_later_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532530"><span class="hs-identifier hs-var">later_ids</span></a><span>
</span><a name="line-904"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532529"><span class="hs-identifier hs-var">rec_ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ret_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532518"><span class="hs-identifier hs-var">ret_op'</span></a><span>
</span><a name="line-905"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_mfix_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532522"><span class="hs-identifier hs-var">mfix_op'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_bind_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532528"><span class="hs-identifier hs-var">bind_op'</span></a><span>
</span><a name="line-906"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecStmtTc</span><span>
</span><a name="line-907"></a><span>                            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_bind_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532527"><span class="hs-identifier hs-var">new_res_ty</span></a><span>
</span><a name="line-908"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_later_rets</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-909"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_rets</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532519"><span class="hs-identifier hs-var">tup_rets</span></a><span>
</span><a name="line-910"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ret_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532520"><span class="hs-identifier hs-var">stmts_ty</span></a><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532526"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-identifier">tcDoStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532531"><a href="#local-6989586621683532531"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcDoStmt: unexpected Stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532531"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-919"></a><span class="hs-comment">-- MonadFail Proposal warnings</span><span>
</span><a name="line-920"></a><span class="hs-comment">---------------------------------------------------</span><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span class="hs-comment">-- The idea behind issuing MonadFail warnings is that we add them whenever a</span><span>
</span><a name="line-923"></a><span class="hs-comment">-- failable pattern is encountered. However, instead of throwing a type error</span><span>
</span><a name="line-924"></a><span class="hs-comment">-- when the constraint cannot be satisfied, we only issue a warning in</span><span>
</span><a name="line-925"></a><span class="hs-comment">-- TcErrors.hs.</span><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span class="hs-identifier">tcMonadFailOp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-928"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span>
</span><a name="line-929"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>    </span><span class="hs-comment">-- The fail op</span><span>
</span><a name="line-930"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>              </span><span class="hs-comment">-- Type of the whole do-expression</span><span>
</span><a name="line-931"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Typechecked fail op</span><span>
</span><a name="line-932"></a><span class="hs-comment">-- Get a 'fail' operator expression, to use if the pattern</span><span>
</span><a name="line-933"></a><span class="hs-comment">-- match fails. If the pattern is irrefutatable, just return</span><span>
</span><a name="line-934"></a><span class="hs-comment">-- noSyntaxExpr; it won't be used</span><span>
</span><a name="line-935"></a><a name="tcMonadFailOp"><a href="TcMatches.html#tcMonadFailOp"><span class="hs-identifier">tcMonadFailOp</span></a></a><span> </span><a name="local-6989586621683532532"><a href="#local-6989586621683532532"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621683532533"><a href="#local-6989586621683532533"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683532534"><a href="#local-6989586621683532534"><span class="hs-identifier">fail_op</span></a></a><span> </span><a name="local-6989586621683532535"><a href="#local-6989586621683532535"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-936"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isIrrefutableHsPat</span><span> </span><a href="#local-6989586621683532533"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-937"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-938"></a><span>
</span><a name="line-939"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-940"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><a href="#local-6989586621683532532"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683532534"><span class="hs-identifier hs-var">fail_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><span class="hs-identifier hs-var">stringTy</span><span class="hs-special">]</span><span>
</span><a name="line-941"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532535"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span class="hs-comment">{-
Note [Treat rebindable syntax first]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When typechecking
        do { bar; ... } :: IO ()
we want to typecheck 'bar' in the knowledge that it should be an IO thing,
pushing info from the context into the RHS.  To do this, we check the
rebindable syntax first, and push that information into (tcMonoExprNC rhs).
Otherwise the error shows up when checking the rebindable syntax, and
the expected/inferred stuff is back to front (see Trac #3613).

Note [typechecking ApplicativeStmt]

join ((\pat1 ... patn -&gt; body) &lt;$&gt; e1 &lt;*&gt; ... &lt;*&gt; en)

fresh type variables:
   pat_ty_1..pat_ty_n
   exp_ty_1..exp_ty_n
   t_1..t_(n-1)

body  :: body_ty
(\pat1 ... patn -&gt; body) :: pat_ty_1 -&gt; ... -&gt; pat_ty_n -&gt; body_ty
pat_i :: pat_ty_i
e_i   :: exp_ty_i
&lt;$&gt;   :: (pat_ty_1 -&gt; ... -&gt; pat_ty_n -&gt; body_ty) -&gt; exp_ty_1 -&gt; t_1
&lt;*&gt;_i :: t_(i-1) -&gt; exp_ty_i -&gt; t_i
join :: tn -&gt; res_ty
-}</span><span>
</span><a name="line-971"></a><span>
</span><a name="line-972"></a><span class="hs-identifier">tcApplicativeStmts</span><span>
</span><a name="line-973"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsStmtContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-974"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ApplicativeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-975"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>                         </span><span class="hs-comment">-- rhs_ty</span><span>
</span><a name="line-976"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683532059"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>               </span><span class="hs-comment">-- thing_inside</span><span>
</span><a name="line-977"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ApplicativeArg</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532059"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><a name="tcApplicativeStmts"><a href="TcMatches.html#tcApplicativeStmts"><span class="hs-identifier">tcApplicativeStmts</span></a></a><span> </span><a name="local-6989586621683532536"><a href="#local-6989586621683532536"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683532537"><a href="#local-6989586621683532537"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621683532538"><a href="#local-6989586621683532538"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><a name="local-6989586621683532539"><a href="#local-6989586621683532539"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-980"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532573"><a href="#local-6989586621683532573"><span class="hs-identifier">body_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-981"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532574"><a href="#local-6989586621683532574"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683532537"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-982"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532575"><a href="#local-6989586621683532575"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532574"><span class="hs-identifier hs-var">arity</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcMType.html#newInferExpTypeInst"><span class="hs-identifier hs-var">newInferExpTypeInst</span></a><span>
</span><a name="line-983"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532576"><a href="#local-6989586621683532576"><span class="hs-identifier">exp_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621683532574"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-984"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532577"><a href="#local-6989586621683532577"><span class="hs-identifier">pat_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621683532574"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-985"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683532578"><a href="#local-6989586621683532578"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621683532577"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532573"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-986"></a><span>
</span><a name="line-987"></a><span>       </span><span class="hs-comment">-- NB. do the &lt;$&gt;,&lt;*&gt; operators first, we don't want type errors here</span><span>
</span><a name="line-988"></a><span>       </span><span class="hs-comment">--     i.e. goOps before goArgs</span><span>
</span><a name="line-989"></a><span>       </span><span class="hs-comment">-- See Note [Treat rebindable syntax first]</span><span>
</span><a name="line-990"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532579"><a href="#local-6989586621683532579"><span class="hs-identifier">ops</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532580"><a href="#local-6989586621683532580"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621683532537"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-991"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532581"><a href="#local-6989586621683532581"><span class="hs-identifier">ops'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532540"><span class="hs-identifier hs-var">goOps</span></a><span> </span><a href="#local-6989586621683532578"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><a href="#local-6989586621683532579"><span class="hs-identifier hs-var">ops</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532575"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683532538"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532576"><span class="hs-identifier hs-var">exp_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span>      </span><span class="hs-comment">-- Typecheck each ApplicativeArg separately</span><span>
</span><a name="line-994"></a><span>      </span><span class="hs-comment">-- See Note [ApplicativeDo and constraints]</span><span>
</span><a name="line-995"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532582"><a href="#local-6989586621683532582"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683532541"><span class="hs-identifier hs-var">goArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><a href="#local-6989586621683532580"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621683532577"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683532576"><span class="hs-identifier hs-var">exp_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-996"></a><span>
</span><a name="line-997"></a><span>      </span><span class="hs-comment">-- Bring into scope all the things bound by the args,</span><span>
</span><a name="line-998"></a><span>      </span><span class="hs-comment">-- and typecheck the thing_inside</span><span>
</span><a name="line-999"></a><span>      </span><span class="hs-comment">-- See Note [ApplicativeDo and constraints]</span><span>
</span><a name="line-1000"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532583"><a href="#local-6989586621683532583"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier hs-var">tcExtendIdEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621683532542"><span class="hs-identifier hs-var">get_arg_bndrs</span></a><span> </span><a href="#local-6989586621683532582"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1001"></a><span>               </span><a href="#local-6989586621683532539"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683532573"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621683532581"><span class="hs-identifier hs-var">ops'</span></a><span> </span><a href="#local-6989586621683532582"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532573"><span class="hs-identifier hs-var">body_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532583"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1004"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1005"></a><span>    </span><a name="local-6989586621683532540"><a href="#local-6989586621683532540"><span class="hs-identifier">goOps</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1006"></a><span>    </span><span class="hs-identifier">goOps</span><span> </span><a name="local-6989586621683532543"><a href="#local-6989586621683532543"><span class="hs-identifier">t_left</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683532544"><a href="#local-6989586621683532544"><span class="hs-identifier">op</span></a></a><span class="hs-special">,</span><a name="local-6989586621683532545"><a href="#local-6989586621683532545"><span class="hs-identifier">t_i</span></a></a><span class="hs-special">,</span><a name="local-6989586621683532546"><a href="#local-6989586621683532546"><span class="hs-identifier">exp_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683532547"><a href="#local-6989586621683532547"><span class="hs-identifier">ops</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683532548"><a href="#local-6989586621683532548"><span class="hs-identifier">op'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1008"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><span class="hs-identifier hs-var">DoOrigin</span><span> </span><a href="#local-6989586621683532544"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-1009"></a><span>                             </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532543"><span class="hs-identifier hs-var">t_left</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683532546"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683532545"><span class="hs-identifier hs-var">t_i</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1010"></a><span>                   </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1011"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532549"><a href="#local-6989586621683532549"><span class="hs-identifier">t_i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683532545"><span class="hs-identifier hs-var">t_i</span></a><span>
</span><a name="line-1012"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683532550"><a href="#local-6989586621683532550"><span class="hs-identifier">ops'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532540"><span class="hs-identifier hs-var">goOps</span></a><span> </span><a href="#local-6989586621683532549"><span class="hs-identifier hs-var">t_i</span></a><span> </span><a href="#local-6989586621683532547"><span class="hs-identifier hs-var">ops</span></a><span>
</span><a name="line-1013"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532548"><span class="hs-identifier hs-var">op'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683532550"><span class="hs-identifier hs-var">ops'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1014"></a><span>
</span><a name="line-1015"></a><span>    </span><span class="hs-identifier">goArg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ApplicativeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-1016"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ApplicativeArg</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-1017"></a><span>
</span><a name="line-1018"></a><span>    </span><a name="local-6989586621683532541"><a href="#local-6989586621683532541"><span class="hs-identifier">goArg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><a name="local-6989586621683532551"><a href="#local-6989586621683532551"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532552"><a href="#local-6989586621683532552"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683532553"><a href="#local-6989586621683532553"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621683532554"><a href="#local-6989586621683532554"><span class="hs-identifier">isBody</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532555"><a href="#local-6989586621683532555"><span class="hs-identifier">pat_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532556"><a href="#local-6989586621683532556"><span class="hs-identifier">exp_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1019"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">combineSrcSpans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621683532552"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621683532553"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1020"></a><span>        </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprStmtInCtxt</span><span> </span><a href="#local-6989586621683532536"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBindStmt</span><span> </span><a href="#local-6989586621683532552"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683532553"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683532557"><a href="#local-6989586621683532557"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><a href="#local-6989586621683532553"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532556"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1022"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532558"><a href="#local-6989586621683532558"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPat"><span class="hs-identifier hs-var">tcPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621683532536"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532552"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532555"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1023"></a><span>                          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><a href="#local-6989586621683532551"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532558"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683532557"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621683532554"><span class="hs-identifier hs-var">isBody</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span>    </span><span class="hs-identifier">goArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgMany</span><span> </span><a name="local-6989586621683532559"><a href="#local-6989586621683532559"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683532560"><a href="#local-6989586621683532560"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621683532561"><a href="#local-6989586621683532561"><span class="hs-identifier">ret</span></a></a><span> </span><a name="local-6989586621683532562"><a href="#local-6989586621683532562"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532563"><a href="#local-6989586621683532563"><span class="hs-identifier">pat_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683532564"><a href="#local-6989586621683532564"><span class="hs-identifier">exp_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532568"><a href="#local-6989586621683532568"><span class="hs-identifier">stmts'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532569"><a href="#local-6989586621683532569"><span class="hs-identifier">ret'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683532570"><a href="#local-6989586621683532570"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1028"></a><span>                </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><a href="#local-6989586621683532536"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier hs-var">tcDoStmt</span></a><span> </span><a href="#local-6989586621683532560"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532564"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1029"></a><span>                </span><span class="hs-glyph">\</span><a name="local-6989586621683532565"><a href="#local-6989586621683532565"><span class="hs-identifier">res_ty</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1030"></a><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532566"><a href="#local-6989586621683532566"><span class="hs-identifier">ret'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExprNC"><span class="hs-identifier hs-var">tcMonoExprNC</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683532561"><span class="hs-identifier hs-var">ret</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532565"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1031"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532567"><a href="#local-6989586621683532567"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPat"><span class="hs-identifier hs-var">tcPat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><a href="#local-6989586621683532536"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683532562"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683532563"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1032"></a><span>                                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1033"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683532566"><span class="hs-identifier hs-var">ret'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532567"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1034"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-1035"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgMany</span><span> </span><a href="#local-6989586621683532559"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683532568"><span class="hs-identifier hs-var">stmts'</span></a><span> </span><a href="#local-6989586621683532569"><span class="hs-identifier hs-var">ret'</span></a><span> </span><a href="#local-6989586621683532570"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span>    </span><span class="hs-identifier">goArg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XApplicativeArg</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcApplicativeStmts&quot;</span><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-identifier">get_arg_bndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ApplicativeArg</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-1040"></a><span>    </span><a name="local-6989586621683532542"><a href="#local-6989586621683532542"><span class="hs-identifier">get_arg_bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532571"><a href="#local-6989586621683532571"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621683532571"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-1041"></a><span>    </span><span class="hs-identifier">get_arg_bndrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgMany</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683532572"><a href="#local-6989586621683532572"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621683532572"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-1042"></a><span>    </span><span class="hs-identifier">get_arg_bndrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XApplicativeArg</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcApplicativeStmts&quot;</span><span>
</span><a name="line-1043"></a><span>
</span><a name="line-1044"></a><span>
</span><a name="line-1045"></a><span class="hs-comment">{- Note [ApplicativeDo and constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An applicative-do is supposed to take place in parallel, so
constraints bound in one arm can't possibly be available in another
(Trac #13242).  Our current rule is this (more details and discussion
on the ticket). Consider

   ...stmts...
   ApplicativeStmts [arg1, arg2, ... argN]
   ...more stmts...

where argi :: ApplicativeArg. Each 'argi' itself contains one or more Stmts.
Now, we say that:

* Constraints required by the argi can be solved from
  constraint bound by ...stmts...

* Constraints and existentials bound by the argi are not available
  to solve constraints required either by argj (where i /= j),
  or by ...more stmts....

* Within the stmts of each 'argi' individually, however, constraints bound
  by earlier stmts can be used to solve later ones.

To achieve this, we just typecheck each 'argi' separately, bring all
the variables they bind into scope, and typecheck the thing_inside.

************************************************************************
*                                                                      *
\subsection{Errors and contexts}
*                                                                      *
************************************************************************

@sameNoOfArgs@ takes a @[RenamedMatch]@ and decides whether the same
number of args are used in each equation.
-}</span><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span class="hs-identifier">checkArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621683532058"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1083"></a><a name="checkArgs"><a href="TcMatches.html#checkArgs"><span class="hs-identifier">checkArgs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1084"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1085"></a><span class="hs-identifier">checkArgs</span><span> </span><a name="local-6989586621683532584"><a href="#local-6989586621683532584"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683532585"><a href="#local-6989586621683532585"><span class="hs-identifier">match1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683532586"><a href="#local-6989586621683532586"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1086"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683532588"><span class="hs-identifier hs-var">bad_matches</span></a><span>
</span><a name="line-1087"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1088"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1089"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Equations for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683532584"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1090"></a><span>                         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;have different numbers of arguments&quot;</span><span>
</span><a name="line-1091"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621683532585"><span class="hs-identifier hs-var">match1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621683532588"><span class="hs-identifier hs-var">bad_matches</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1093"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1094"></a><span>    </span><a name="local-6989586621683532587"><a href="#local-6989586621683532587"><span class="hs-identifier">n_args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683532589"><span class="hs-identifier hs-var">args_in_match</span></a><span> </span><a href="#local-6989586621683532585"><span class="hs-identifier hs-var">match1</span></a><span>
</span><a name="line-1095"></a><span>    </span><a name="local-6989586621683532588"><a href="#local-6989586621683532588"><span class="hs-identifier">bad_matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683532591"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683532591"><a href="#local-6989586621683532591"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683532586"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683532589"><span class="hs-identifier hs-var">args_in_match</span></a><span> </span><a href="#local-6989586621683532591"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621683532587"><span class="hs-identifier hs-var">n_args1</span></a><span class="hs-special">]</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span>    </span><span class="hs-identifier">args_in_match</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LMatch</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621683532590"><span class="hs-identifier hs-type">body</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1098"></a><span>    </span><a name="local-6989586621683532589"><a href="#local-6989586621683532589"><span class="hs-identifier">args_in_match</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Match</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">m_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683532592"><a href="#local-6989586621683532592"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683532592"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-1099"></a><span>    </span><span class="hs-identifier">args_in_match</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatch</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;checkArgs&quot;</span><span>
</span><a name="line-1100"></a><span class="hs-identifier">checkArgs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatchGroup</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;checkArgs&quot;</span><span>
</span><a name="line-1101"></a></pre></body></html>