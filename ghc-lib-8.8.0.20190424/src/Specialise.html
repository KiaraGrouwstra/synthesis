<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998

\section[Specialise]{Stamping out overloading, and (optionally) polymorphism}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Specialise</span><span> </span><span class="hs-special">(</span><span> </span><a href="Specialise.html#specProgram"><span class="hs-identifier hs-var">specProgram</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">specUnfolding</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>   </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">substTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">extendTvSubstList</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasModule</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMonad</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">CoreSubst</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUnfold</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isLocalVar</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Rules</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreOpt</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">collectBindersPushingCo</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">applyTypeToArgs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkCast</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreArity</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">etaExpandToJoinPointRule</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">voidArgId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">voidPrimId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="State.html"><span class="hs-identifier">State</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqDFM</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MonadFail</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[notes-Specialise]{Implementation notes [SLPJ, Aug 18 1993]}
*                                                                      *
************************************************************************

These notes describe how we implement specialisation to eliminate
overloading.

The specialisation pass works on Core
syntax, complete with all the explicit dictionary application,
abstraction and construction as added by the type checker.  The
existing type checker remains largely as it is.

One important thought: the {\em types} passed to an overloaded
function, and the {\em dictionaries} passed are mutually redundant.
If the same function is applied to the same type(s) then it is sure to
be applied to the same dictionary(s)---or rather to the same {\em
values}.  (The arguments might look different but they will evaluate
to the same value.)

Second important thought: we know that we can make progress by
treating dictionary arguments as static and worth specialising on.  So
we can do without binding-time analysis, and instead specialise on
dictionary arguments and no others.

The basic idea
~~~~~~~~~~~~~~
Suppose we have

        let f = &lt;f_rhs&gt;
        in &lt;body&gt;

and suppose f is overloaded.

STEP 1: CALL-INSTANCE COLLECTION

We traverse &lt;body&gt;, accumulating all applications of f to types and
dictionaries.

(Might there be partial applications, to just some of its types and
dictionaries?  In principle yes, but in practice the type checker only
builds applications of f to all its types and dictionaries, so partial
applications could only arise as a result of transformation, and even
then I think it's unlikely.  In any case, we simply don't accumulate such
partial applications.)


STEP 2: EQUIVALENCES

So now we have a collection of calls to f:
        f t1 t2 d1 d2
        f t3 t4 d3 d4
        ...
Notice that f may take several type arguments.  To avoid ambiguity, we
say that f is called at type t1/t2 and t3/t4.

We take equivalence classes using equality of the *types* (ignoring
the dictionary args, which as mentioned previously are redundant).

STEP 3: SPECIALISATION

For each equivalence class, choose a representative (f t1 t2 d1 d2),
and create a local instance of f, defined thus:

        f@t1/t2 = &lt;f_rhs&gt; t1 t2 d1 d2

f_rhs presumably has some big lambdas and dictionary lambdas, so lots
of simplification will now result.  However we don't actually *do* that
simplification.  Rather, we leave it for the simplifier to do.  If we
*did* do it, though, we'd get more call instances from the specialised
RHS.  We can work out what they are by instantiating the call-instance
set from f's RHS with the types t1, t2.

Add this new id to f's IdInfo, to record that f has a specialised version.

Before doing any of this, check that f's IdInfo doesn't already
tell us about an existing instance of f at the required type/s.
(This might happen if specialisation was applied more than once, or
it might arise from user SPECIALIZE pragmas.)

Recursion
~~~~~~~~~
Wait a minute!  What if f is recursive?  Then we can't just plug in
its right-hand side, can we?

But it's ok.  The type checker *always* creates non-recursive definitions
for overloaded recursive functions.  For example:

        f x = f (x+x)           -- Yes I know its silly

becomes

        f a (d::Num a) = let p = +.sel a d
                         in
                         letrec fl (y::a) = fl (p y y)
                         in
                         fl

We still have recursion for non-overloaded functions which we
specialise, but the recursive call should get specialised to the
same recursive version.


Polymorphism 1
~~~~~~~~~~~~~~

All this is crystal clear when the function is applied to *constant
types*; that is, types which have no type variables inside.  But what if
it is applied to non-constant types?  Suppose we find a call of f at type
t1/t2.  There are two possibilities:

(a) The free type variables of t1, t2 are in scope at the definition point
of f.  In this case there's no problem, we proceed just as before.  A common
example is as follows.  Here's the Haskell:

        g y = let f x = x+x
              in f y + f y

After typechecking we have

        g a (d::Num a) (y::a) = let f b (d'::Num b) (x::b) = +.sel b d' x x
                                in +.sel a d (f a d y) (f a d y)

Notice that the call to f is at type type &quot;a&quot;; a non-constant type.
Both calls to f are at the same type, so we can specialise to give:

        g a (d::Num a) (y::a) = let f@a (x::a) = +.sel a d x x
                                in +.sel a d (f@a y) (f@a y)


(b) The other case is when the type variables in the instance types
are *not* in scope at the definition point of f.  The example we are
working with above is a good case.  There are two instances of (+.sel a d),
but &quot;a&quot; is not in scope at the definition of +.sel.  Can we do anything?
Yes, we can &quot;common them up&quot;, a sort of limited common sub-expression deal.
This would give:

        g a (d::Num a) (y::a) = let +.sel@a = +.sel a d
                                    f@a (x::a) = +.sel@a x x
                                in +.sel@a (f@a y) (f@a y)

This can save work, and can't be spotted by the type checker, because
the two instances of +.sel weren't originally at the same type.

Further notes on (b)

* There are quite a few variations here.  For example, the defn of
  +.sel could be floated ouside the \y, to attempt to gain laziness.
  It certainly mustn't be floated outside the \d because the d has to
  be in scope too.

* We don't want to inline f_rhs in this case, because
that will duplicate code.  Just commoning up the call is the point.

* Nothing gets added to +.sel's IdInfo.

* Don't bother unless the equivalence class has more than one item!

Not clear whether this is all worth it.  It is of course OK to
simply discard call-instances when passing a big lambda.

Polymorphism 2 -- Overloading
~~~~~~~~~~~~~~
Consider a function whose most general type is

        f :: forall a b. Ord a =&gt; [a] -&gt; b -&gt; b

There is really no point in making a version of g at Int/Int and another
at Int/Bool, because it's only instantiating the type variable &quot;a&quot; which
buys us any efficiency. Since g is completely polymorphic in b there
ain't much point in making separate versions of g for the different
b types.

That suggests that we should identify which of g's type variables
are constrained (like &quot;a&quot;) and which are unconstrained (like &quot;b&quot;).
Then when taking equivalence classes in STEP 2, we ignore the type args
corresponding to unconstrained type variable.  In STEP 3 we make
polymorphic versions.  Thus:

        f@t1/ = /\b -&gt; &lt;f_rhs&gt; t1 b d1 d2

We do this.


Dictionary floating
~~~~~~~~~~~~~~~~~~~
Consider this

        f a (d::Num a) = let g = ...
                         in
                         ...(let d1::Ord a = Num.Ord.sel a d in g a d1)...

Here, g is only called at one type, but the dictionary isn't in scope at the
definition point for g.  Usually the type checker would build a
definition for d1 which enclosed g, but the transformation system
might have moved d1's defn inward.  Solution: float dictionary bindings
outwards along with call instances.

Consider

        f x = let g p q = p==q
                  h r s = (r+s, g r s)
              in
              h x x


Before specialisation, leaving out type abstractions we have

        f df x = let g :: Eq a =&gt; a -&gt; a -&gt; Bool
                     g dg p q = == dg p q
                     h :: Num a =&gt; a -&gt; a -&gt; (a, Bool)
                     h dh r s = let deq = eqFromNum dh
                                in (+ dh r s, g deq r s)
              in
              h df x x

After specialising h we get a specialised version of h, like this:

                    h' r s = let deq = eqFromNum df
                             in (+ df r s, g deq r s)

But we can't naively make an instance for g from this, because deq is not in scope
at the defn of g.  Instead, we have to float out the (new) defn of deq
to widen its scope.  Notice that this floating can't be done in advance -- it only
shows up when specialisation is done.

User SPECIALIZE pragmas
~~~~~~~~~~~~~~~~~~~~~~~
Specialisation pragmas can be digested by the type checker, and implemented
by adding extra definitions along with that of f, in the same way as before

        f@t1/t2 = &lt;f_rhs&gt; t1 t2 d1 d2

Indeed the pragmas *have* to be dealt with by the type checker, because
only it knows how to build the dictionaries d1 and d2!  For example

        g :: Ord a =&gt; [a] -&gt; [a]
        {-# SPECIALIZE f :: [Tree Int] -&gt; [Tree Int] #-}

Here, the specialised version of g is an application of g's rhs to the
Ord dictionary for (Tree Int), which only the type checker can conjure
up.  There might not even *be* one, if (Tree Int) is not an instance of
Ord!  (All the other specialision has suitable dictionaries to hand
from actual calls.)

Problem.  The type checker doesn't have to hand a convenient &lt;f_rhs&gt;, because
it is buried in a complex (as-yet-un-desugared) binding group.
Maybe we should say

        f@t1/t2 = f* t1 t2 d1 d2

where f* is the Id f with an IdInfo which says &quot;inline me regardless!&quot;.
Indeed all the specialisation could be done in this way.
That in turn means that the simplifier has to be prepared to inline absolutely
any in-scope let-bound thing.


Again, the pragma should permit polymorphism in unconstrained variables:

        h :: Ord a =&gt; [a] -&gt; b -&gt; b
        {-# SPECIALIZE h :: [Int] -&gt; b -&gt; b #-}

We *insist* that all overloaded type variables are specialised to ground types,
(and hence there can be no context inside a SPECIALIZE pragma).
We *permit* unconstrained type variables to be specialised to
        - a ground type
        - or left as a polymorphic type variable
but nothing in between.  So

        {-# SPECIALIZE h :: [Int] -&gt; [c] -&gt; [c] #-}

is *illegal*.  (It can be handled, but it adds complication, and gains the
programmer nothing.)


SPECIALISING INSTANCE DECLARATIONS
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

        instance Foo a =&gt; Foo [a] where
                ...
        {-# SPECIALIZE instance Foo [Int] #-}

The original instance decl creates a dictionary-function
definition:

        dfun.Foo.List :: forall a. Foo a -&gt; Foo [a]

The SPECIALIZE pragma just makes a specialised copy, just as for
ordinary function definitions:

        dfun.Foo.List@Int :: Foo [Int]
        dfun.Foo.List@Int = dfun.Foo.List Int dFooInt

The information about what instance of the dfun exist gets added to
the dfun's IdInfo in the same way as a user-defined function too.


Automatic instance decl specialisation?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Can instance decls be specialised automatically?  It's tricky.
We could collect call-instance information for each dfun, but
then when we specialised their bodies we'd get new call-instances
for ordinary functions; and when we specialised their bodies, we might get
new call-instances of the dfuns, and so on.  This all arises because of
the unrestricted mutual recursion between instance decls and value decls.

Still, there's no actual problem; it just means that we may not do all
the specialisation we could theoretically do.

Furthermore, instance decls are usually exported and used non-locally,
so we'll want to compile enough to get those specialisations done.

Lastly, there's no such thing as a local instance decl, so we can
survive solely by spitting out *usage* information, and then reading that
back in as a pragma when next compiling the file.  So for now,
we only specialise instance decls in response to pragmas.


SPITTING OUT USAGE INFORMATION
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To spit out usage information we need to traverse the code collecting
call-instance information for all imported (non-prelude?) functions
and data types. Then we equivalence-class it and spit it out.

This is done at the top-level when all the call instances which escape
must be for imported functions and data types.

*** Not currently done ***


Partial specialisation by pragmas
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What about partial specialisation:

        k :: (Ord a, Eq b) =&gt; [a] -&gt; b -&gt; b -&gt; [a]
        {-# SPECIALIZE k :: Eq b =&gt; [Int] -&gt; b -&gt; b -&gt; [a] #-}

or even

        {-# SPECIALIZE k :: Eq b =&gt; [Int] -&gt; [b] -&gt; [b] -&gt; [a] #-}

Seems quite reasonable.  Similar things could be done with instance decls:

        instance (Foo a, Foo b) =&gt; Foo (a,b) where
                ...
        {-# SPECIALIZE instance Foo a =&gt; Foo (a,Int) #-}
        {-# SPECIALIZE instance Foo b =&gt; Foo (Int,b) #-}

Ho hum.  Things are complex enough without this.  I pass.


Requirements for the simplifier
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The simplifier has to be able to take advantage of the specialisation.

* When the simplifier finds an application of a polymorphic f, it looks in
f's IdInfo in case there is a suitable instance to call instead.  This converts

        f t1 t2 d1 d2   ===&gt;   f_t1_t2

Note that the dictionaries get eaten up too!

* Dictionary selection operations on constant dictionaries must be
  short-circuited:

        +.sel Int d     ===&gt;  +Int

The obvious way to do this is in the same way as other specialised
calls: +.sel has inside it some IdInfo which tells that if it's applied
to the type Int then it should eat a dictionary and transform to +Int.

In short, dictionary selectors need IdInfo inside them for constant
methods.

* Exactly the same applies if a superclass dictionary is being
  extracted:

        Eq.sel Int d   ===&gt;   dEqInt

* Something similar applies to dictionary construction too.  Suppose
dfun.Eq.List is the function taking a dictionary for (Eq a) to
one for (Eq [a]).  Then we want

        dfun.Eq.List Int d      ===&gt; dEq.List_Int

Where does the Eq [Int] dictionary come from?  It is built in
response to a SPECIALIZE pragma on the Eq [a] instance decl.

In short, dfun Ids need IdInfo with a specialisation for each
constant instance of their instance declaration.

All this uses a single mechanism: the SpecEnv inside an Id


What does the specialisation IdInfo look like?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The SpecEnv of an Id maps a list of types (the template) to an expression

        [Type]  |-&gt;  Expr

For example, if f has this RuleInfo:

        [Int, a]  -&gt;  \d:Ord Int. f' a

it means that we can replace the call

        f Int t  ===&gt;  (\d. f' t)

This chucks one dictionary away and proceeds with the
specialised version of f, namely f'.


What can't be done this way?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is no way, post-typechecker, to get a dictionary for (say)
Eq a from a dictionary for Eq [a].  So if we find

        ==.sel [t] d

we can't transform to

        eqList (==.sel t d')

where
        eqList :: (a-&gt;a-&gt;Bool) -&gt; [a] -&gt; [a] -&gt; Bool

Of course, we currently have no way to automatically derive
eqList, nor to connect it to the Eq [a] instance decl, but you
can imagine that it might somehow be possible.  Taking advantage
of this is permanently ruled out.

Still, this is no great hardship, because we intend to eliminate
overloading altogether anyway!

A note about non-tyvar dictionaries
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some Ids have types like

        forall a,b,c. Eq a -&gt; Ord [a] -&gt; tau

This seems curious at first, because we usually only have dictionary
args whose types are of the form (C a) where a is a type variable.
But this doesn't hold for the functions arising from instance decls,
which sometimes get arguments with types of form (C (T a)) for some
type constructor T.

Should we specialise wrt this compound-type dictionary?  We used to say
&quot;no&quot;, saying:
        &quot;This is a heuristic judgement, as indeed is the fact that we
        specialise wrt only dictionaries.  We choose *not* to specialise
        wrt compound dictionaries because at the moment the only place
        they show up is in instance decls, where they are simply plugged
        into a returned dictionary.  So nothing is gained by specialising
        wrt them.&quot;

But it is simpler and more uniform to specialise wrt these dicts too;
and in future GHC is likely to support full fledged type signatures
like
        f :: Eq [(a,b)] =&gt; ...


************************************************************************
*                                                                      *
\subsubsection{The new specialiser}
*                                                                      *
************************************************************************

Our basic game plan is this.  For let(rec) bound function
        f :: (C a, D c) =&gt; (a,b,c,d) -&gt; Bool

* Find any specialised calls of f, (f ts ds), where
  ts are the type arguments t1 .. t4, and
  ds are the dictionary arguments d1 .. d2.

* Add a new definition for f1 (say):

        f1 = /\ b d -&gt; (..body of f..) t1 b t3 d d1 d2

  Note that we abstract over the unconstrained type arguments.

* Add the mapping

        [t1,b,t3,d]  |-&gt;  \d1 d2 -&gt; f1 b d

  to the specialisations of f.  This will be used by the
  simplifier to replace calls
                (f t1 t2 t3 t4) da db
  by
                (\d1 d1 -&gt; f1 t2 t4) da db

  All the stuff about how many dictionaries to discard, and what types
  to apply the specialised function to, are handled by the fact that the
  SpecEnv contains a template for the result of the specialisation.

We don't build *partial* specialisations for f.  For example:

  f :: Eq a =&gt; a -&gt; a -&gt; Bool
  {-# SPECIALISE f :: (Eq b, Eq c) =&gt; (b,c) -&gt; (b,c) -&gt; Bool #-}

Here, little is gained by making a specialised copy of f.
There's a distinct danger that the specialised version would
first build a dictionary for (Eq b, Eq c), and then select the (==)
method from it!  Even if it didn't, not a great deal is saved.

We do, however, generate polymorphic, but not overloaded, specialisations:

  f :: Eq a =&gt; [a] -&gt; b -&gt; b -&gt; b
  ... SPECIALISE f :: [Int] -&gt; b -&gt; b -&gt; b ...

Hence, the invariant is this:

        *** no specialised version is overloaded ***


************************************************************************
*                                                                      *
\subsubsection{The exported function}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-comment">-- | Specialise calls to type-class overloaded functions occuring in a program.</span><span>
</span><a name="line-576"></a><span class="hs-identifier">specProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-577"></a><a name="specProgram"><a href="Specialise.html#specProgram"><span class="hs-identifier">specProgram</span></a></a><span> </span><a name="local-6989586621680525200"><a href="#local-6989586621680525200"><span class="hs-identifier">guts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModGuts</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_module</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525201"><a href="#local-6989586621680525201"><span class="hs-identifier">this_mod</span></a></a><span>
</span><a name="line-578"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525202"><a href="#local-6989586621680525202"><span class="hs-identifier">local_rules</span></a></a><span>
</span><a name="line-579"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525203"><a href="#local-6989586621680525203"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680525212"><a href="#local-6989586621680525212"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>             </span><span class="hs-comment">-- Specialise the bindings of this module</span><span>
</span><a name="line-583"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525213"><a href="#local-6989586621680525213"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525214"><a href="#local-6989586621680525214"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#runSpecM"><span class="hs-identifier hs-var">runSpecM</span></a><span> </span><a href="#local-6989586621680525212"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525205"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525203"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span>             </span><span class="hs-comment">-- Specialise imported functions</span><span>
</span><a name="line-586"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525215"><a href="#local-6989586621680525215"><span class="hs-identifier">hpt_rules</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getRuleBase</span><span>
</span><a name="line-587"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525216"><a href="#local-6989586621680525216"><span class="hs-identifier">rule_base</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendRuleBaseList</span><span> </span><a href="#local-6989586621680525215"><span class="hs-identifier hs-var">hpt_rules</span></a><span> </span><a href="#local-6989586621680525202"><span class="hs-identifier hs-var">local_rules</span></a><span>
</span><a name="line-588"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525217"><a href="#local-6989586621680525217"><span class="hs-identifier">new_rules</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525218"><a href="#local-6989586621680525218"><span class="hs-identifier">spec_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specImports"><span class="hs-identifier hs-var">specImports</span></a><span> </span><a href="#local-6989586621680525212"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621680525204"><span class="hs-identifier hs-var">top_env</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-589"></a><span>                                                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680525216"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><a href="#local-6989586621680525214"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525219"><a href="#local-6989586621680525219"><span class="hs-identifier">final_binds</span></a></a><span>
</span><a name="line-592"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525218"><span class="hs-identifier hs-var">spec_binds</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525213"><span class="hs-identifier hs-var">binds'</span></a><span>
</span><a name="line-593"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flattenBinds</span><span> </span><a href="#local-6989586621680525218"><span class="hs-identifier hs-var">spec_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525213"><span class="hs-identifier hs-var">binds'</span></a><span>
</span><a name="line-594"></a><span>                   </span><span class="hs-comment">-- Note [Glom the bindings if imported functions are specialised]</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525200"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525219"><span class="hs-identifier hs-var">final_binds</span></a><span>
</span><a name="line-597"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525217"><span class="hs-identifier hs-var">new_rules</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525202"><span class="hs-identifier hs-var">local_rules</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-598"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-599"></a><span>        </span><span class="hs-comment">-- We need to start with a Subst that knows all the things</span><span>
</span><a name="line-600"></a><span>        </span><span class="hs-comment">-- that are in scope, so that the substitution engine doesn't</span><span>
</span><a name="line-601"></a><span>        </span><span class="hs-comment">-- accidentally re-use a unique that's already in use</span><span>
</span><a name="line-602"></a><span>        </span><span class="hs-comment">-- Easiest thing is to do it all at once, as if all the top-level</span><span>
</span><a name="line-603"></a><span>        </span><span class="hs-comment">-- decls were mutually recursive</span><span>
</span><a name="line-604"></a><span>    </span><a name="local-6989586621680525204"><a href="#local-6989586621680525204"><span class="hs-identifier">top_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SE"><span class="hs-identifier hs-var">SE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.mkEmptySubst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-605"></a><span>                              </span><span class="hs-identifier hs-var">bindersOfBinds</span><span> </span><a href="#local-6989586621680525203"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-606"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span>    </span><a name="local-6989586621680525205"><a href="#local-6989586621680525205"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525206"><a href="#local-6989586621680525206"><span class="hs-identifier">bind</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680525207"><a href="#local-6989586621680525207"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525208"><a href="#local-6989586621680525208"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525209"><a href="#local-6989586621680525209"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525205"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525207"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-610"></a><span>                         </span><span class="hs-special">(</span><a name="local-6989586621680525210"><a href="#local-6989586621680525210"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525211"><a href="#local-6989586621680525211"><span class="hs-identifier">uds'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specBind"><span class="hs-identifier hs-var">specBind</span></a><span> </span><a href="#local-6989586621680525204"><span class="hs-identifier hs-var">top_env</span></a><span> </span><a href="#local-6989586621680525206"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621680525209"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-611"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525210"><span class="hs-identifier hs-var">bind'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525208"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525211"><span class="hs-identifier hs-var">uds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span class="hs-comment">{-
Note [Wrap bindings returned by specImports]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'specImports' returns a set of specialized bindings. However, these are lacking
necessary floated dictionary bindings, which are returned by
UsageDetails(ud_binds). These dictionaries need to be brought into scope with
'wrapDictBinds' before the bindings returned by 'specImports' can be used. See,
for instance, the 'specImports' call in 'specProgram'.


Note [Disabling cross-module specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Since GHC 7.10 we have performed specialisation of INLINABLE bindings living
in modules outside of the current module. This can sometimes uncover user code
which explodes in size when aggressively optimized. The
-fno-cross-module-specialise option was introduced to allow users to being
bitten by such instances to revert to the pre-7.10 behavior.

See Trac #10491
-}</span><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span class="hs-comment">-- | Specialise a set of calls to imported bindings</span><span>
</span><a name="line-635"></a><span class="hs-identifier">specImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-636"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-637"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>          </span><span class="hs-comment">-- Passed in so that all top-level Ids are in scope</span><span>
</span><a name="line-638"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>           </span><span class="hs-comment">-- Don't specialise these ones</span><span>
</span><a name="line-639"></a><span>                                </span><span class="hs-comment">-- See Note [Avoiding recursive specialisation]</span><span>
</span><a name="line-640"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Stack of imported functions being specialised</span><span>
</span><a name="line-641"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RuleBase</span><span>         </span><span class="hs-comment">-- Rules from this module and the home package</span><span>
</span><a name="line-642"></a><span>                                </span><span class="hs-comment">-- (but not external packages, which can change)</span><span>
</span><a name="line-643"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>     </span><span class="hs-comment">-- Calls for imported things, and floating bindings</span><span>
</span><a name="line-644"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- New rules</span><span>
</span><a name="line-645"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Specialised bindings</span><span>
</span><a name="line-646"></a><span>                                    </span><span class="hs-comment">-- See Note [Wrapping bindings returned by specImports]</span><span>
</span><a name="line-647"></a><a name="specImports"><a href="Specialise.html#specImports"><span class="hs-identifier">specImports</span></a></a><span> </span><a name="local-6989586621680525220"><a href="#local-6989586621680525220"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680525221"><a href="#local-6989586621680525221"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621680525222"><a href="#local-6989586621680525222"><span class="hs-identifier">top_env</span></a></a><span> </span><a name="local-6989586621680525223"><a href="#local-6989586621680525223"><span class="hs-identifier">done</span></a></a><span> </span><a name="local-6989586621680525224"><a href="#local-6989586621680525224"><span class="hs-identifier">callers</span></a></a><span> </span><a name="local-6989586621680525225"><a href="#local-6989586621680525225"><span class="hs-identifier">rule_base</span></a></a><span>
</span><a name="line-648"></a><span>            </span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525226"><a href="#local-6989586621680525226"><span class="hs-identifier">dict_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525227"><a href="#local-6989586621680525227"><span class="hs-identifier">calls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>  </span><span class="hs-comment">-- See Note [Disabling cross-module specialisation]</span><span>
</span><a name="line-650"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CrossModuleSpecialise</span><span> </span><a href="#local-6989586621680525220"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-651"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-654"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525238"><a href="#local-6989586621680525238"><span class="hs-identifier">import_calls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dVarEnvElts</span><span> </span><a href="#local-6989586621680525227"><span class="hs-identifier hs-var">calls</span></a><span>
</span><a name="line-655"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525239"><a href="#local-6989586621680525239"><span class="hs-identifier">rules</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525240"><a href="#local-6989586621680525240"><span class="hs-identifier">spec_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525228"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525225"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><a href="#local-6989586621680525238"><span class="hs-identifier hs-var">import_calls</span></a><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span>             </span><span class="hs-comment">-- Don't forget to wrap the specialized bindings with</span><span>
</span><a name="line-658"></a><span>             </span><span class="hs-comment">-- bindings for the needed dictionaries.</span><span>
</span><a name="line-659"></a><span>             </span><span class="hs-comment">-- See Note [Wrap bindings returned by specImports]</span><span>
</span><a name="line-660"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525241"><a href="#local-6989586621680525241"><span class="hs-identifier">spec_binds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#wrapDictBinds"><span class="hs-identifier hs-var">wrapDictBinds</span></a><span> </span><a href="#local-6989586621680525226"><span class="hs-identifier hs-var">dict_binds</span></a><span> </span><a href="#local-6989586621680525240"><span class="hs-identifier hs-var">spec_binds</span></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525239"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525241"><span class="hs-identifier hs-var">spec_binds'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-663"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-664"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RuleBase</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>    </span><a name="local-6989586621680525228"><a href="#local-6989586621680525228"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680525229"><a href="#local-6989586621680525229"><span class="hs-identifier">rb</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525230"><a href="#local-6989586621680525230"><span class="hs-identifier">cis</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a name="local-6989586621680525231"><a href="#local-6989586621680525231"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525232"><a href="#local-6989586621680525232"><span class="hs-identifier">other_calls</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525233"><a href="#local-6989586621680525233"><span class="hs-identifier">ok_calls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#filterCalls"><span class="hs-identifier hs-var">filterCalls</span></a><span> </span><a href="#local-6989586621680525230"><span class="hs-identifier hs-var">cis</span></a><span> </span><a href="#local-6989586621680525226"><span class="hs-identifier hs-var">dict_binds</span></a><span>
</span><a name="line-668"></a><span>                     </span><span class="hs-comment">-- Drop calls that (directly or indirectly) refer to fn</span><span>
</span><a name="line-669"></a><span>                     </span><span class="hs-comment">-- See Note [Avoiding loops]</span><span>
</span><a name="line-670"></a><span class="hs-comment">--           ; debugTraceMsg (text &quot;specImport&quot; &lt;+&gt; vcat [ ppr fn</span><span>
</span><a name="line-671"></a><span class="hs-comment">--                                                       , text &quot;calls&quot; &lt;+&gt; ppr cis</span><span>
</span><a name="line-672"></a><span class="hs-comment">--                                                       , text &quot;ud_binds =&quot; &lt;+&gt; ppr dict_binds</span><span>
</span><a name="line-673"></a><span class="hs-comment">--                                                       , text &quot;dump set =&quot; &lt;+&gt; ppr dump_set</span><span>
</span><a name="line-674"></a><span class="hs-comment">--                                                       , text &quot;filtered calls =&quot; &lt;+&gt; ppr ok_calls ])</span><span>
</span><a name="line-675"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525234"><a href="#local-6989586621680525234"><span class="hs-identifier">rules1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525235"><a href="#local-6989586621680525235"><span class="hs-identifier">spec_binds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specImport"><span class="hs-identifier hs-var">specImport</span></a><span> </span><a href="#local-6989586621680525220"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525221"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621680525222"><span class="hs-identifier hs-var">top_env</span></a><span>
</span><a name="line-676"></a><span>                                                 </span><a href="#local-6989586621680525223"><span class="hs-identifier hs-var">done</span></a><span> </span><a href="#local-6989586621680525224"><span class="hs-identifier hs-var">callers</span></a><span> </span><a href="#local-6989586621680525229"><span class="hs-identifier hs-var">rb</span></a><span> </span><a href="#local-6989586621680525231"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525233"><span class="hs-identifier hs-var">ok_calls</span></a><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525236"><a href="#local-6989586621680525236"><span class="hs-identifier">rules2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525237"><a href="#local-6989586621680525237"><span class="hs-identifier">spec_binds2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525228"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendRuleBaseList</span><span> </span><a href="#local-6989586621680525229"><span class="hs-identifier hs-var">rb</span></a><span> </span><a href="#local-6989586621680525234"><span class="hs-identifier hs-var">rules1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525232"><span class="hs-identifier hs-var">other_calls</span></a><span>
</span><a name="line-679"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525234"><span class="hs-identifier hs-var">rules1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525236"><span class="hs-identifier hs-var">rules2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525235"><span class="hs-identifier hs-var">spec_binds1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525237"><span class="hs-identifier hs-var">spec_binds2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-680"></a><span>
</span><a name="line-681"></a><span class="hs-identifier">specImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-682"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-683"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>               </span><span class="hs-comment">-- Passed in so that all top-level Ids are in scope</span><span>
</span><a name="line-684"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>                </span><span class="hs-comment">-- Don't specialise these</span><span>
</span><a name="line-685"></a><span>                                    </span><span class="hs-comment">-- See Note [Avoiding recursive specialisation]</span><span>
</span><a name="line-686"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- Stack of imported functions being specialised</span><span>
</span><a name="line-687"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RuleBase</span><span>              </span><span class="hs-comment">-- Rules from this module</span><span>
</span><a name="line-688"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Imported function and calls for it</span><span>
</span><a name="line-689"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- New rules</span><span>
</span><a name="line-690"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Specialised bindings</span><span>
</span><a name="line-691"></a><a name="specImport"><a href="Specialise.html#specImport"><span class="hs-identifier">specImport</span></a></a><span> </span><a name="local-6989586621680525242"><a href="#local-6989586621680525242"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680525243"><a href="#local-6989586621680525243"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621680525244"><a href="#local-6989586621680525244"><span class="hs-identifier">top_env</span></a></a><span> </span><a name="local-6989586621680525245"><a href="#local-6989586621680525245"><span class="hs-identifier">done</span></a></a><span> </span><a name="local-6989586621680525246"><a href="#local-6989586621680525246"><span class="hs-identifier">callers</span></a></a><span> </span><a name="local-6989586621680525247"><a href="#local-6989586621680525247"><span class="hs-identifier">rb</span></a></a><span> </span><a name="local-6989586621680525248"><a href="#local-6989586621680525248"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680525249"><a href="#local-6989586621680525249"><span class="hs-identifier">calls_for_fn</span></a></a><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525245"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- No warning.  This actually happens all the time</span><span>
</span><a name="line-694"></a><span>                        </span><span class="hs-comment">-- when specialising a recursive function, because</span><span>
</span><a name="line-695"></a><span>                        </span><span class="hs-comment">-- the RHS of the specialised function contains a recursive</span><span>
</span><a name="line-696"></a><span>                        </span><span class="hs-comment">-- call to the original function</span><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525249"><span class="hs-identifier hs-var">calls_for_fn</span></a><span>   </span><span class="hs-comment">-- We filtered out all the calls in deleteCallsMentioning</span><span>
</span><a name="line-699"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Specialise.html#wantSpecImport"><span class="hs-identifier hs-var">wantSpecImport</span></a><span> </span><a href="#local-6989586621680525242"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525250"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525251"><a href="#local-6989586621680525251"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span><span> </span><a href="#local-6989586621680525250"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-703"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- Get rules from the external package state</span><span>
</span><a name="line-704"></a><span>             </span><span class="hs-comment">-- We keep doing this in case we &quot;page-fault in&quot;</span><span>
</span><a name="line-705"></a><span>             </span><span class="hs-comment">-- more rules as we go along</span><span>
</span><a name="line-706"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525252"><a href="#local-6989586621680525252"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHscEnv</span><span>
</span><a name="line-707"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525253"><a href="#local-6989586621680525253"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hscEPS</span><span> </span><a href="#local-6989586621680525252"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-708"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525254"><a href="#local-6989586621680525254"><span class="hs-identifier">vis_orphs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getVisibleOrphanMods</span><span>
</span><a name="line-709"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525255"><a href="#local-6989586621680525255"><span class="hs-identifier">full_rb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionRuleBase</span><span> </span><a href="#local-6989586621680525247"><span class="hs-identifier hs-var">rb</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_rule_base</span><span> </span><a href="#local-6989586621680525253"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span>             </span><a name="local-6989586621680525256"><a href="#local-6989586621680525256"><span class="hs-identifier">rules_for_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getRules</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleEnv</span><span> </span><a href="#local-6989586621680525255"><span class="hs-identifier hs-var">full_rb</span></a><span> </span><a href="#local-6989586621680525254"><span class="hs-identifier hs-var">vis_orphs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525257"><a href="#local-6989586621680525257"><span class="hs-identifier">rules1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525258"><a href="#local-6989586621680525258"><span class="hs-identifier">spec_pairs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525259"><a href="#local-6989586621680525259"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- pprTrace &quot;specImport1&quot; (vcat [ppr fn, ppr calls_for_fn, ppr rhs]) $</span><span>
</span><a name="line-714"></a><span>                </span><a href="Specialise.html#runSpecM"><span class="hs-identifier hs-var">runSpecM</span></a><span> </span><a href="#local-6989586621680525242"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525243"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-715"></a><span>                </span><a href="Specialise.html#specCalls"><span class="hs-identifier hs-var">specCalls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680525243"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525244"><span class="hs-identifier hs-var">top_env</span></a><span> </span><a href="#local-6989586621680525256"><span class="hs-identifier hs-var">rules_for_fn</span></a><span> </span><a href="#local-6989586621680525249"><span class="hs-identifier hs-var">calls_for_fn</span></a><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525251"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-716"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525260"><a href="#local-6989586621680525260"><span class="hs-identifier">spec_binds1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680525261"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680525262"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525261"><a href="#local-6989586621680525261"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525262"><a href="#local-6989586621680525262"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525258"><span class="hs-identifier hs-var">spec_pairs</span></a><span class="hs-special">]</span><span>
</span><a name="line-717"></a><span>             </span><span class="hs-comment">-- After the rules kick in we may get recursion, but</span><span>
</span><a name="line-718"></a><span>             </span><span class="hs-comment">-- we rely on a global GlomBinds to sort that out later</span><span>
</span><a name="line-719"></a><span>             </span><span class="hs-comment">-- See Note [Glom the bindings if imported functions are specialised]</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span>              </span><span class="hs-comment">-- Now specialise any cascaded calls</span><span>
</span><a name="line-722"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525263"><a href="#local-6989586621680525263"><span class="hs-identifier">rules2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525264"><a href="#local-6989586621680525264"><span class="hs-identifier">spec_binds2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-comment">-- pprTrace &quot;specImport 2&quot; (ppr fn $$ ppr rules1 $$ ppr spec_binds1) $</span><span>
</span><a name="line-723"></a><span>                                  </span><a href="Specialise.html#specImports"><span class="hs-identifier hs-var">specImports</span></a><span> </span><a href="#local-6989586621680525242"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525243"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621680525244"><span class="hs-identifier hs-var">top_env</span></a><span>
</span><a name="line-724"></a><span>                                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendVarSet</span><span> </span><a href="#local-6989586621680525245"><span class="hs-identifier hs-var">done</span></a><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>                                              </span><span class="hs-special">(</span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680525246"><span class="hs-identifier hs-var">callers</span></a><span class="hs-special">)</span><span>
</span><a name="line-726"></a><span>                                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendRuleBaseList</span><span> </span><a href="#local-6989586621680525247"><span class="hs-identifier hs-var">rb</span></a><span> </span><a href="#local-6989586621680525257"><span class="hs-identifier hs-var">rules1</span></a><span class="hs-special">)</span><span>
</span><a name="line-727"></a><span>                                              </span><a href="#local-6989586621680525259"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525265"><a href="#local-6989586621680525265"><span class="hs-identifier">final_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525264"><span class="hs-identifier hs-var">spec_binds2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525260"><span class="hs-identifier hs-var">spec_binds1</span></a><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525263"><span class="hs-identifier hs-var">rules2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525257"><span class="hs-identifier hs-var">rules1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525265"><span class="hs-identifier hs-var">final_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">|</span><span>  </span><a href="Specialise.html#warnMissingSpecs"><span class="hs-identifier hs-var">warnMissingSpecs</span></a><span> </span><a href="#local-6989586621680525242"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525246"><span class="hs-identifier hs-var">callers</span></a><span>
</span><a name="line-734"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">warnMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Could not specialise imported function&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-735"></a><span>                            </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;when specialising&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525266"><span class="hs-identifier hs-var">caller</span></a><span class="hs-special">)</span><span>
</span><a name="line-736"></a><span>                                    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680525266"><a href="#local-6989586621680525266"><span class="hs-identifier">caller</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525246"><span class="hs-identifier hs-var">callers</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">whenPprDebug</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;calls:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#pprCallInfo"><span class="hs-identifier hs-var">pprCallInfo</span></a><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525249"><span class="hs-identifier hs-var">calls_for_fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable fix: add INLINABLE pragma on&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-739"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-740"></a><span>
</span><a name="line-741"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-742"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-744"></a><span>    </span><a name="local-6989586621680525250"><a href="#local-6989586621680525250"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621680525248"><span class="hs-identifier hs-var">fn</span></a><span>   </span><span class="hs-comment">-- We want to see the unfolding even for loop breakers</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-identifier">warnMissingSpecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-747"></a><span class="hs-comment">-- See Note [Warning about missed specialisations]</span><span>
</span><a name="line-748"></a><a name="warnMissingSpecs"><a href="Specialise.html#warnMissingSpecs"><span class="hs-identifier">warnMissingSpecs</span></a></a><span> </span><a name="local-6989586621680525267"><a href="#local-6989586621680525267"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680525268"><a href="#local-6989586621680525268"><span class="hs-identifier">callers</span></a></a><span>
</span><a name="line-749"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnAllMissedSpecs</span><span> </span><a href="#local-6989586621680525267"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-750"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissedSpecs</span><span> </span><a href="#local-6989586621680525267"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-751"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525268"><span class="hs-identifier hs-var">callers</span></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-752"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621680525269"><span class="hs-identifier hs-var">has_inline_prag</span></a><span> </span><a href="#local-6989586621680525268"><span class="hs-identifier hs-var">callers</span></a><span>
</span><a name="line-753"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-754"></a><span>    </span><a name="local-6989586621680525269"><a href="#local-6989586621680525269"><span class="hs-identifier">has_inline_prag</span></a></a><span> </span><a name="local-6989586621680525270"><a href="#local-6989586621680525270"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isAnyInlinePragma</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621680525270"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span class="hs-identifier">wantSpecImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Unfolding</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-757"></a><span class="hs-comment">-- See Note [Specialise imported INLINABLE things]</span><span>
</span><a name="line-758"></a><a name="wantSpecImport"><a href="Specialise.html#wantSpecImport"><span class="hs-identifier">wantSpecImport</span></a></a><span> </span><a name="local-6989586621680525271"><a href="#local-6989586621680525271"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680525272"><a href="#local-6989586621680525272"><span class="hs-identifier">unf</span></a></a><span>
</span><a name="line-759"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680525272"><span class="hs-identifier hs-var">unf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-760"></a><span>     </span><span class="hs-identifier hs-var">NoUnfolding</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-761"></a><span>     </span><span class="hs-identifier hs-var">BootUnfolding</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-762"></a><span>     </span><span class="hs-identifier hs-var">OtherCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-763"></a><span>     </span><span class="hs-identifier hs-var">DFunUnfolding</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-764"></a><span>     </span><span class="hs-identifier hs-var">CoreUnfolding</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525273"><a href="#local-6989586621680525273"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_guidance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525274"><a href="#local-6989586621680525274"><span class="hs-identifier">_guidance</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-765"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SpecialiseAggressively</span><span> </span><a href="#local-6989586621680525271"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-766"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isStableSource</span><span> </span><a href="#local-6989586621680525273"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-767"></a><span>               </span><span class="hs-comment">-- Specialise even INLINE things; it hasn't inlined yet,</span><span>
</span><a name="line-768"></a><span>               </span><span class="hs-comment">-- so perhaps it never will.  Moreover it may have calls</span><span>
</span><a name="line-769"></a><span>               </span><span class="hs-comment">-- inside it that we want to specialise</span><span>
</span><a name="line-770"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>    </span><span class="hs-comment">-- Stable, not INLINE, hence INLINABLE</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span class="hs-comment">{- Note [Warning about missed specialisations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose
 * In module Lib, you carefully mark a function 'foo' INLINABLE
 * Import Lib(foo) into another module M
 * Call 'foo' at some specialised type in M
Then you jolly well expect it to be specialised in M.  But what if
'foo' calls another function 'Lib.bar'.  Then you'd like 'bar' to be
specialised too.  But if 'bar' is not marked INLINABLE it may well
not be specialised.  The warning Opt_WarnMissedSpecs warns about this.

It's more noisy to warning about a missed specialisation opportunity
for /every/ overloaded imported function, but sometimes useful. That
is what Opt_WarnAllMissedSpecs does.

ToDo: warn about missed opportunities for local functions.

Note [Specialise imported INLINABLE things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What imported functions do we specialise?  The basic set is
 * DFuns and things with INLINABLE pragmas.
but with -fspecialise-aggressively we add
 * Anything with an unfolding template

Trac #8874 has a good example of why we want to auto-specialise DFuns.

We have the -fspecialise-aggressively flag (usually off), because we
risk lots of orphan modules from over-vigorous specialisation.
However it's not a big deal: anything non-recursive with an
unfolding-template will probably have been inlined already.

Note [Glom the bindings if imported functions are specialised]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have an imported, *recursive*, INLINABLE function
   f :: Eq a =&gt; a -&gt; a
   f = /\a \d x. ...(f a d)...
In the module being compiled we have
   g x = f (x::Int)
Now we'll make a specialised function
   f_spec :: Int -&gt; Int
   f_spec = \x -&gt; ...(f Int dInt)...
   {-# RULE  f Int _ = f_spec #-}
   g = \x. f Int dInt x
Note that f_spec doesn't look recursive
After rewriting with the RULE, we get
   f_spec = \x -&gt; ...(f_spec)...
BUT since f_spec was non-recursive before it'll *stay* non-recursive.
The occurrence analyser never turns a NonRec into a Rec.  So we must
make sure that f_spec is recursive.  Easiest thing is to make all
the specialisations for imported bindings recursive.


Note [Avoiding recursive specialisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we specialise 'f' we may find new overloaded calls to 'g', 'h' in
'f's RHS.  So we want to specialise g,h.  But we don't want to
specialise f any more!  It's possible that f's RHS might have a
recursive yet-more-specialised call, so we'd diverge in that case.
And if the call is to the same type, one specialisation is enough.
Avoiding this recursive specialisation loop is the reason for the
'done' VarSet passed to specImports and specImport.

************************************************************************
*                                                                      *
\subsubsection{@specExpr@: the main function}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-840"></a><span>
</span><a name="line-841"></a><span class="hs-keyword">data</span><span> </span><a name="SpecEnv"><a href="Specialise.html#SpecEnv"><span class="hs-identifier">SpecEnv</span></a></a><span>
</span><a name="line-842"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SE"><a href="Specialise.html#SE"><span class="hs-identifier">SE</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="se_subst"><a href="Specialise.html#se_subst"><span class="hs-identifier">se_subst</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreSubst.Subst</span><span>
</span><a name="line-843"></a><span>             </span><span class="hs-comment">-- We carry a substitution down:</span><span>
</span><a name="line-844"></a><span>             </span><span class="hs-comment">-- a) we must clone any binding that might float outwards,</span><span>
</span><a name="line-845"></a><span>             </span><span class="hs-comment">--    to avoid name clashes</span><span>
</span><a name="line-846"></a><span>             </span><span class="hs-comment">-- b) we carry a type substitution to use when analysing</span><span>
</span><a name="line-847"></a><span>             </span><span class="hs-comment">--    the RHS of specialised bindings (no type-let!)</span><span>
</span><a name="line-848"></a><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="se_interesting"><a href="Specialise.html#se_interesting"><span class="hs-identifier">se_interesting</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-851"></a><span>             </span><span class="hs-comment">-- Dict Ids that we know something about</span><span>
</span><a name="line-852"></a><span>             </span><span class="hs-comment">-- and hence may be worth specialising against</span><span>
</span><a name="line-853"></a><span>             </span><span class="hs-comment">-- See Note [Interesting dictionary arguments]</span><span>
</span><a name="line-854"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span class="hs-identifier">specVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-857"></a><a name="specVar"><a href="Specialise.html#specVar"><span class="hs-identifier">specVar</span></a></a><span> </span><a name="local-6989586621680525275"><a href="#local-6989586621680525275"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525276"><a href="#local-6989586621680525276"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.lookupIdSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;specVar&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525275"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525276"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span class="hs-identifier">specExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span class="hs-comment">---------------- First the easy cases --------------------</span><span>
</span><a name="line-862"></a><a name="specExpr"><a href="Specialise.html#specExpr"><span class="hs-identifier">specExpr</span></a></a><span> </span><a name="local-6989586621680525277"><a href="#local-6989586621680525277"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621680525278"><a href="#local-6989586621680525278"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span>     </span><span class="hs-special">(</span><a href="Specialise.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621680525277"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525278"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-863"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525279"><a href="#local-6989586621680525279"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><a name="local-6989586621680525280"><a href="#local-6989586621680525280"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-6989586621680525279"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525280"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-864"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525281"><a href="#local-6989586621680525281"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680525282"><a href="#local-6989586621680525282"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#specVar"><span class="hs-identifier hs-var">specVar</span></a><span> </span><a href="#local-6989586621680525281"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525282"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-865"></a><span class="hs-identifier">specExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><a name="local-6989586621680525283"><a href="#local-6989586621680525283"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><a href="#local-6989586621680525283"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">,</span><span>       </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-866"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525284"><a href="#local-6989586621680525284"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621680525285"><a href="#local-6989586621680525285"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680525286"><a href="#local-6989586621680525286"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-867"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525287"><a href="#local-6989586621680525287"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525288"><a href="#local-6989586621680525288"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525284"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525285"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-868"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCast</span><span> </span><a href="#local-6989586621680525287"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-6989586621680525284"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525286"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525288"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-869"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525289"><a href="#local-6989586621680525289"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621680525290"><a href="#local-6989586621680525290"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621680525291"><a href="#local-6989586621680525291"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525292"><a href="#local-6989586621680525292"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525293"><a href="#local-6989586621680525293"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525289"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525291"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-871"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#specTickish"><span class="hs-identifier hs-var">specTickish</span></a><span> </span><a href="#local-6989586621680525289"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525290"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525292"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525293"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span class="hs-comment">---------------- Applications might generate a call instance --------------------</span><span>
</span><a name="line-874"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525294"><a href="#local-6989586621680525294"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525295"><a href="#local-6989586621680525295"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525296"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525295"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-876"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-877"></a><span>    </span><a name="local-6989586621680525296"><a href="#local-6989586621680525296"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621680525297"><a href="#local-6989586621680525297"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621680525298"><a href="#local-6989586621680525298"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680525299"><a href="#local-6989586621680525299"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525300"><a href="#local-6989586621680525300"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525301"><a href="#local-6989586621680525301"><span class="hs-identifier">uds_arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525294"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525298"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-878"></a><span>                               </span><span class="hs-special">(</span><a name="local-6989586621680525302"><a href="#local-6989586621680525302"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525303"><a href="#local-6989586621680525303"><span class="hs-identifier">uds_app</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525296"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525297"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525300"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680525299"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-879"></a><span>                               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621680525302"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621680525300"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525301"><span class="hs-identifier hs-var">uds_arg</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525303"><span class="hs-identifier hs-var">uds_app</span></a><span class="hs-special">)</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680525304"><a href="#local-6989586621680525304"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>       </span><a name="local-6989586621680525305"><a href="#local-6989586621680525305"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Specialise.html#specVar"><span class="hs-identifier hs-var">specVar</span></a><span> </span><a href="#local-6989586621680525294"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525304"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-882"></a><span>                                </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680525306"><a href="#local-6989586621680525306"><span class="hs-identifier">f'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525306"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#mkCallUDs"><span class="hs-identifier hs-var">mkCallUDs</span></a><span> </span><a href="#local-6989586621680525294"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525306"><span class="hs-identifier hs-var">f'</span></a><span> </span><a href="#local-6989586621680525305"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>                                </span><a name="local-6989586621680525307"><a href="#local-6989586621680525307"><span class="hs-identifier">e'</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525307"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- I don't expect this!</span><span>
</span><a name="line-884"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680525308"><a href="#local-6989586621680525308"><span class="hs-identifier">other</span></a></a><span>         </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525294"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525308"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><span class="hs-comment">---------------- Lambda/case require dumping of usage details --------------------</span><span>
</span><a name="line-887"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525309"><a href="#local-6989586621680525309"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525310"><a href="#local-6989586621680525310"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-888"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525315"><a href="#local-6989586621680525315"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525316"><a href="#local-6989586621680525316"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525313"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621680525312"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-889"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525317"><a href="#local-6989586621680525317"><span class="hs-identifier">free_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525318"><a href="#local-6989586621680525318"><span class="hs-identifier">dumped_dbs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a><span> </span><a href="#local-6989586621680525314"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621680525316"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-890"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680525314"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a><span> </span><a href="#local-6989586621680525318"><span class="hs-identifier hs-var">dumped_dbs</span></a><span> </span><a href="#local-6989586621680525315"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525317"><span class="hs-identifier hs-var">free_uds</span></a><span class="hs-special">)</span><span>
</span><a name="line-891"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-892"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525311"><a href="#local-6989586621680525311"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525312"><a href="#local-6989586621680525312"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectBinders</span><span> </span><a href="#local-6989586621680525310"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-893"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525313"><a href="#local-6989586621680525313"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525314"><a href="#local-6989586621680525314"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680525309"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525311"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-894"></a><span>        </span><span class="hs-comment">-- More efficient to collect a group of binders together all at once</span><span>
</span><a name="line-895"></a><span>        </span><span class="hs-comment">-- and we don't want to split a lambda group with dumped bindings</span><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525319"><a href="#local-6989586621680525319"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621680525320"><a href="#local-6989586621680525320"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680525321"><a href="#local-6989586621680525321"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621680525322"><a href="#local-6989586621680525322"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680525323"><a href="#local-6989586621680525323"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525324"><a href="#local-6989586621680525324"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525325"><a href="#local-6989586621680525325"><span class="hs-identifier">scrut_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525319"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525320"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-899"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525326"><a href="#local-6989586621680525326"><span class="hs-identifier">scrut''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525327"><a href="#local-6989586621680525327"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525328"><a href="#local-6989586621680525328"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525329"><a href="#local-6989586621680525329"><span class="hs-identifier">alts_uds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specCase"><span class="hs-identifier hs-var">specCase</span></a><span> </span><a href="#local-6989586621680525319"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525324"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621680525321"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621680525323"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-901"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621680525326"><span class="hs-identifier hs-var">scrut''</span></a><span> </span><a href="#local-6989586621680525327"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621680525319"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525322"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525328"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-902"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525325"><span class="hs-identifier hs-var">scrut_uds</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525329"><span class="hs-identifier hs-var">alts_uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span class="hs-comment">---------------- Finally, let is the interesting case --------------------</span><span>
</span><a name="line-905"></a><span class="hs-identifier">specExpr</span><span> </span><a name="local-6989586621680525330"><a href="#local-6989586621680525330"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a name="local-6989586621680525331"><a href="#local-6989586621680525331"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621680525332"><a href="#local-6989586621680525332"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Clone binders</span><span>
</span><a name="line-907"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621680525333"><a href="#local-6989586621680525333"><span class="hs-identifier">rhs_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525334"><a href="#local-6989586621680525334"><span class="hs-identifier">body_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525335"><a href="#local-6989586621680525335"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#cloneBindSM"><span class="hs-identifier hs-var">cloneBindSM</span></a><span> </span><a href="#local-6989586621680525330"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525331"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><span>         </span><span class="hs-comment">-- Deal with the body</span><span>
</span><a name="line-910"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525336"><a href="#local-6989586621680525336"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525337"><a href="#local-6989586621680525337"><span class="hs-identifier">body_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525334"><span class="hs-identifier hs-var">body_env</span></a><span> </span><a href="#local-6989586621680525332"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-911"></a><span>
</span><a name="line-912"></a><span>        </span><span class="hs-comment">-- Deal with the bindings</span><span>
</span><a name="line-913"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525338"><a href="#local-6989586621680525338"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525339"><a href="#local-6989586621680525339"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specBind"><span class="hs-identifier hs-var">specBind</span></a><span> </span><a href="#local-6989586621680525333"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680525335"><span class="hs-identifier hs-var">bind'</span></a><span> </span><a href="#local-6989586621680525337"><span class="hs-identifier hs-var">body_uds</span></a><span>
</span><a name="line-914"></a><span>
</span><a name="line-915"></a><span>        </span><span class="hs-comment">-- All done</span><span>
</span><a name="line-916"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621680525336"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621680525338"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525339"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-identifier">specTickish</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-919"></a><a name="specTickish"><a href="Specialise.html#specTickish"><span class="hs-identifier">specTickish</span></a></a><span> </span><a name="local-6989586621680525340"><a href="#local-6989586621680525340"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Breakpoint</span><span> </span><a name="local-6989586621680525341"><a href="#local-6989586621680525341"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621680525342"><a href="#local-6989586621680525342"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Breakpoint</span><span> </span><a href="#local-6989586621680525341"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680525344"><span class="hs-identifier hs-var">id'</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680525343"><a href="#local-6989586621680525343"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525342"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680525344"><a href="#local-6989586621680525344"><span class="hs-identifier">id'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#specVar"><span class="hs-identifier hs-var">specVar</span></a><span> </span><a href="#local-6989586621680525340"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525343"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-921"></a><span>  </span><span class="hs-comment">-- drop vars from the list if they have a non-variable substitution.</span><span>
</span><a name="line-922"></a><span>  </span><span class="hs-comment">-- should never happen, but it's harmless to drop them anyway.</span><span>
</span><a name="line-923"></a><span class="hs-identifier">specTickish</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680525345"><a href="#local-6989586621680525345"><span class="hs-identifier">other_tickish</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525345"><span class="hs-identifier hs-var">other_tickish</span></a><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span class="hs-identifier">specCase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>
</span><a name="line-926"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>            </span><span class="hs-comment">-- Scrutinee, already done</span><span>
</span><a name="line-927"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span>
</span><a name="line-928"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>    </span><span class="hs-comment">-- New scrutinee</span><span>
</span><a name="line-929"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-930"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span>
</span><a name="line-931"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span>
</span><a name="line-932"></a><a name="specCase"><a href="Specialise.html#specCase"><span class="hs-identifier">specCase</span></a></a><span> </span><a name="local-6989586621680525346"><a href="#local-6989586621680525346"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525347"><a href="#local-6989586621680525347"><span class="hs-identifier">scrut'</span></a></a><span> </span><a name="local-6989586621680525348"><a href="#local-6989586621680525348"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-6989586621680525349"><a href="#local-6989586621680525349"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525350"><a href="#local-6989586621680525350"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525351"><a href="#local-6989586621680525351"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-933"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDictId</span><span> </span><a href="#local-6989586621680525348"><span class="hs-identifier hs-var">case_bndr</span></a><span>           </span><span class="hs-comment">-- See Note [Floating dictionaries out of cases]</span><span>
</span><a name="line-934"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525346"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525347"><span class="hs-identifier hs-var">scrut'</span></a><span>
</span><a name="line-935"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDeadBinder</span><span> </span><a href="#local-6989586621680525348"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525355"><span class="hs-identifier hs-var">sc_args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525367"><a href="#local-6989586621680525367"><span class="hs-identifier">case_bndr_flt</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525368"><a href="#local-6989586621680525368"><span class="hs-identifier">sc_args_flt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621680525356"><span class="hs-identifier hs-var">clone_me</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525353"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525355"><span class="hs-identifier hs-var">sc_args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-937"></a><span>
</span><a name="line-938"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525369"><a href="#local-6989586621680525369"><span class="hs-identifier">sc_rhss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525367"><span class="hs-identifier hs-var">case_bndr_flt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525353"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680525374"><span class="hs-identifier hs-var">sc_arg'</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>                              </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680525349"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525354"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525374"><span class="hs-identifier hs-var">sc_arg'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-940"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680525374"><a href="#local-6989586621680525374"><span class="hs-identifier">sc_arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525355"><span class="hs-identifier hs-var">sc_args'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>             </span><span class="hs-comment">-- Extend the substitution for RHS to map the *original* binders</span><span>
</span><a name="line-943"></a><span>             </span><span class="hs-comment">-- to their floated versions.</span><span>
</span><a name="line-944"></a><span>             </span><span class="hs-identifier">mb_sc_flts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DictId</span><span class="hs-special">]</span><span>
</span><a name="line-945"></a><span>             </span><a name="local-6989586621680525370"><a href="#local-6989586621680525370"><span class="hs-identifier">mb_sc_flts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621680525371"><span class="hs-identifier hs-var">clone_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525354"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-946"></a><span>             </span><a name="local-6989586621680525371"><a href="#local-6989586621680525371"><span class="hs-identifier">clone_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipVarEnv</span><span> </span><a href="#local-6989586621680525355"><span class="hs-identifier hs-var">sc_args'</span></a><span> </span><a href="#local-6989586621680525368"><span class="hs-identifier hs-var">sc_args_flt</span></a><span>
</span><a name="line-947"></a><span>             </span><a name="local-6989586621680525372"><a href="#local-6989586621680525372"><span class="hs-identifier">subst_prs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525348"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525367"><span class="hs-identifier hs-var">case_bndr_flt</span></a><span class="hs-special">)</span><span>
</span><a name="line-948"></a><span>                        </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525375"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525376"><span class="hs-identifier hs-var">sc_flt</span></a><span class="hs-special">)</span><span>
</span><a name="line-949"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525375"><a href="#local-6989586621680525375"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525376"><a href="#local-6989586621680525376"><span class="hs-identifier">sc_flt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525350"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525370"><span class="hs-identifier hs-var">mb_sc_flts</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-950"></a><span>             </span><a name="local-6989586621680525373"><a href="#local-6989586621680525373"><span class="hs-identifier">env_rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525352"><span class="hs-identifier hs-var">env_rhs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.extendIdSubstList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525352"><span class="hs-identifier hs-var">env_rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525372"><span class="hs-identifier hs-var">subst_prs</span></a><span>
</span><a name="line-951"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><a href="#local-6989586621680525352"><span class="hs-identifier hs-var">env_rhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendVarSetList</span><span class="hs-special">`</span><span>
</span><a name="line-952"></a><span>                                                   </span><span class="hs-special">(</span><a href="#local-6989586621680525367"><span class="hs-identifier hs-var">case_bndr_flt</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525368"><span class="hs-identifier hs-var">sc_args_flt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525377"><a href="#local-6989586621680525377"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525378"><a href="#local-6989586621680525378"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525373"><span class="hs-identifier hs-var">env_rhs'</span></a><span> </span><a href="#local-6989586621680525351"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-955"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525379"><a href="#local-6989586621680525379"><span class="hs-identifier">scrut_bind</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680525367"><span class="hs-identifier hs-var">case_bndr_flt</span></a><span> </span><a href="#local-6989586621680525347"><span class="hs-identifier hs-var">scrut'</span></a><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>             </span><a name="local-6989586621680525380"><a href="#local-6989586621680525380"><span class="hs-identifier">case_bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitVarSet</span><span> </span><a href="#local-6989586621680525367"><span class="hs-identifier hs-var">case_bndr_flt</span></a><span>
</span><a name="line-957"></a><span>             </span><a name="local-6989586621680525381"><a href="#local-6989586621680525381"><span class="hs-identifier">sc_binds</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680525387"><span class="hs-identifier hs-var">sc_arg_flt</span></a><span> </span><a href="#local-6989586621680525388"><span class="hs-identifier hs-var">sc_rhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525380"><span class="hs-identifier hs-var">case_bndr_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-958"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525387"><a href="#local-6989586621680525387"><span class="hs-identifier">sc_arg_flt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525388"><a href="#local-6989586621680525388"><span class="hs-identifier">sc_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525368"><span class="hs-identifier hs-var">sc_args_flt</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525369"><span class="hs-identifier hs-var">sc_rhss</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-959"></a><span>             </span><a name="local-6989586621680525382"><a href="#local-6989586621680525382"><span class="hs-identifier">flt_binds</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525379"><span class="hs-identifier hs-var">scrut_bind</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525381"><span class="hs-identifier hs-var">sc_binds</span></a><span>
</span><a name="line-960"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621680525383"><a href="#local-6989586621680525383"><span class="hs-identifier">free_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525384"><a href="#local-6989586621680525384"><span class="hs-identifier">dumped_dbs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525353"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680525354"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525378"><span class="hs-identifier hs-var">rhs_uds</span></a><span>
</span><a name="line-961"></a><span>             </span><a name="local-6989586621680525385"><a href="#local-6989586621680525385"><span class="hs-identifier">all_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525382"><span class="hs-identifier hs-var">flt_binds</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#addDictBinds"><span class="hs-identifier hs-var">addDictBinds</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525383"><span class="hs-identifier hs-var">free_uds</span></a><span>
</span><a name="line-962"></a><span>             </span><a name="local-6989586621680525386"><a href="#local-6989586621680525386"><span class="hs-identifier">alt'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525349"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525354"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a><span> </span><a href="#local-6989586621680525384"><span class="hs-identifier hs-var">dumped_dbs</span></a><span> </span><a href="#local-6989586621680525377"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525367"><span class="hs-identifier hs-var">case_bndr_flt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525353"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680525386"><span class="hs-identifier hs-var">alt'</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525385"><span class="hs-identifier hs-var">all_uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-964"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-965"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525352"><a href="#local-6989586621680525352"><span class="hs-identifier">env_rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525353"><a href="#local-6989586621680525353"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680525354"><a href="#local-6989586621680525354"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680525346"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525348"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680525350"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-966"></a><span>    </span><a name="local-6989586621680525355"><a href="#local-6989586621680525355"><span class="hs-identifier">sc_args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621680525358"><span class="hs-identifier hs-var">is_flt_sc_arg</span></a><span> </span><a href="#local-6989586621680525354"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span>    </span><a name="local-6989586621680525356"><a href="#local-6989586621680525356"><span class="hs-identifier">clone_me</span></a></a><span> </span><a name="local-6989586621680525359"><a href="#local-6989586621680525359"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680525364"><a href="#local-6989586621680525364"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-969"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUserLocalOrCoVar</span><span> </span><a href="#local-6989586621680525362"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621680525364"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621680525361"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680525363"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-970"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-971"></a><span>         </span><a name="local-6989586621680525360"><a href="#local-6989586621680525360"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680525359"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-972"></a><span>         </span><a name="local-6989586621680525361"><a href="#local-6989586621680525361"><span class="hs-identifier">ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680525359"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-973"></a><span>         </span><a name="local-6989586621680525362"><a href="#local-6989586621680525362"><span class="hs-identifier">occ</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621680525360"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-974"></a><span>         </span><a name="local-6989586621680525363"><a href="#local-6989586621680525363"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621680525360"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-975"></a><span>
</span><a name="line-976"></a><span>    </span><a name="local-6989586621680525357"><a href="#local-6989586621680525357"><span class="hs-identifier">arg_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621680525354"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-977"></a><span>    </span><a name="local-6989586621680525358"><a href="#local-6989586621680525358"><span class="hs-identifier">is_flt_sc_arg</span></a></a><span> </span><a name="local-6989586621680525365"><a href="#local-6989586621680525365"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621680525365"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-978"></a><span>                      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDeadBinder</span><span> </span><a href="#local-6989586621680525365"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span>                      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isDictTy</span><span> </span><a href="#local-6989586621680525366"><span class="hs-identifier hs-var">var_ty</span></a><span>
</span><a name="line-980"></a><span>                      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621680525366"><span class="hs-identifier hs-var">var_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525357"><span class="hs-identifier hs-var">arg_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-982"></a><span>         </span><a name="local-6989586621680525366"><a href="#local-6989586621680525366"><span class="hs-identifier">var_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680525365"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span>
</span><a name="line-985"></a><span class="hs-identifier">specCase</span><span> </span><a name="local-6989586621680525389"><a href="#local-6989586621680525389"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525390"><a href="#local-6989586621680525390"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680525391"><a href="#local-6989586621680525391"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621680525392"><a href="#local-6989586621680525392"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-986"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525405"><a href="#local-6989586621680525405"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525406"><a href="#local-6989586621680525406"><span class="hs-identifier">uds_alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a><span> </span><a href="#local-6989586621680525395"><span class="hs-identifier hs-var">spec_alt</span></a><span> </span><a href="#local-6989586621680525392"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-987"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525390"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525394"><span class="hs-identifier hs-var">case_bndr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525405"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525406"><span class="hs-identifier hs-var">uds_alts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-988"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-989"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525393"><a href="#local-6989586621680525393"><span class="hs-identifier">env_alt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525394"><a href="#local-6989586621680525394"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621680525389"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525391"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-990"></a><span>    </span><a name="local-6989586621680525395"><a href="#local-6989586621680525395"><span class="hs-identifier">spec_alt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525396"><a href="#local-6989586621680525396"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525397"><a href="#local-6989586621680525397"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525398"><a href="#local-6989586621680525398"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-991"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621680525401"><a href="#local-6989586621680525401"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525402"><a href="#local-6989586621680525402"><span class="hs-identifier">uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525399"><span class="hs-identifier hs-var">env_rhs</span></a><span> </span><a href="#local-6989586621680525398"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-992"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525403"><a href="#local-6989586621680525403"><span class="hs-identifier">free_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525404"><a href="#local-6989586621680525404"><span class="hs-identifier">dumped_dbs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#dumpUDs"><span class="hs-identifier hs-var">dumpUDs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525394"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525400"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525402"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-993"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621680525396"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525400"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#wrapDictBindsE"><span class="hs-identifier hs-var">wrapDictBindsE</span></a><span> </span><a href="#local-6989586621680525404"><span class="hs-identifier hs-var">dumped_dbs</span></a><span> </span><a href="#local-6989586621680525401"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525403"><span class="hs-identifier hs-var">free_uds</span></a><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-995"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621680525399"><a href="#local-6989586621680525399"><span class="hs-identifier">env_rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525400"><a href="#local-6989586621680525400"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680525393"><span class="hs-identifier hs-var">env_alt</span></a><span> </span><a href="#local-6989586621680525397"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-996"></a><span>
</span><a name="line-997"></a><span class="hs-comment">{-
Note [Floating dictionaries out of cases]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   g = \d. case d of { MkD sc ... -&gt; ...(f sc)... }
Naively we can't float d2's binding out of the case expression,
because 'sc' is bound by the case, and that in turn means we can't
specialise f, which seems a pity.

So we invert the case, by floating out a binding
for 'sc_flt' thus:
    sc_flt = case d of { MkD sc ... -&gt; sc }
Now we can float the call instance for 'f'.  Indeed this is just
what'll happen if 'sc' was originally bound with a let binding,
but case is more efficient, and necessary with equalities. So it's
good to work with both.

You might think that this won't make any difference, because the
call instance will only get nuked by the \d.  BUT if 'g' itself is
specialised, then transitively we should be able to specialise f.

In general, given
   case e of cb { MkD sc ... -&gt; ...(f sc)... }
we transform to
   let cb_flt = e
       sc_flt = case cb_flt of { MkD sc ... -&gt; sc }
   in
   case cb_flt of bg { MkD sc ... -&gt; ....(f sc_flt)... }

The &quot;_flt&quot; things are the floated binds; we use the current substitution
to substitute sc -&gt; sc_flt in the RHS

************************************************************************
*                                                                      *
                     Dealing with a binding
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-identifier">specBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>                     </span><span class="hs-comment">-- Use this for RHSs</span><span>
</span><a name="line-1037"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span>                    </span><span class="hs-comment">-- Binders are already cloned by cloneBindSM,</span><span>
</span><a name="line-1038"></a><span>                                        </span><span class="hs-comment">-- but RHSs are un-processed</span><span>
</span><a name="line-1039"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>                </span><span class="hs-comment">-- Info on how the scope of the binding</span><span>
</span><a name="line-1040"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- New bindings</span><span>
</span><a name="line-1041"></a><span>                   </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- And info to pass upstream</span><span>
</span><a name="line-1042"></a><span>
</span><a name="line-1043"></a><span class="hs-comment">-- Returned UsageDetails:</span><span>
</span><a name="line-1044"></a><span class="hs-comment">--    No calls for binders of this bind</span><span>
</span><a name="line-1045"></a><a name="specBind"><a href="Specialise.html#specBind"><span class="hs-identifier">specBind</span></a></a><span> </span><a name="local-6989586621680525407"><a href="#local-6989586621680525407"><span class="hs-identifier">rhs_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680525408"><a href="#local-6989586621680525408"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680525409"><a href="#local-6989586621680525409"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680525410"><a href="#local-6989586621680525410"><span class="hs-identifier">body_uds</span></a></a><span>
</span><a name="line-1046"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525411"><a href="#local-6989586621680525411"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525412"><a href="#local-6989586621680525412"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525407"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680525409"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1047"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525413"><a href="#local-6989586621680525413"><span class="hs-identifier">fn'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525414"><a href="#local-6989586621680525414"><span class="hs-identifier">spec_defns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525415"><a href="#local-6989586621680525415"><span class="hs-identifier">body_uds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specDefn"><span class="hs-identifier hs-var">specDefn</span></a><span> </span><a href="#local-6989586621680525407"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680525410"><span class="hs-identifier hs-var">body_uds</span></a><span> </span><a href="#local-6989586621680525408"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525409"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1048"></a><span>
</span><a name="line-1049"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525416"><a href="#local-6989586621680525416"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525414"><span class="hs-identifier hs-var">spec_defns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680525413"><span class="hs-identifier hs-var">fn'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525411"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1050"></a><span>                        </span><span class="hs-comment">-- fn' mentions the spec_defns in its rules,</span><span>
</span><a name="line-1051"></a><span>                        </span><span class="hs-comment">-- so put the latter first</span><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span>             </span><a name="local-6989586621680525417"><a href="#local-6989586621680525417"><span class="hs-identifier">combined_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525415"><span class="hs-identifier hs-var">body_uds1</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525412"><span class="hs-identifier hs-var">rhs_uds</span></a><span>
</span><a name="line-1054"></a><span>
</span><a name="line-1055"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621680525418"><a href="#local-6989586621680525418"><span class="hs-identifier">free_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525419"><a href="#local-6989586621680525419"><span class="hs-identifier">dump_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525420"><a href="#local-6989586621680525420"><span class="hs-identifier">float_all</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#dumpBindUDs"><span class="hs-identifier hs-var">dumpBindUDs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680525408"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621680525417"><span class="hs-identifier hs-var">combined_uds</span></a><span>
</span><a name="line-1056"></a><span>
</span><a name="line-1057"></a><span>             </span><span class="hs-identifier">final_binds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">]</span><span>
</span><a name="line-1058"></a><span>             </span><span class="hs-comment">-- See Note [From non-recursive to recursive]</span><span>
</span><a name="line-1059"></a><span>             </span><a name="local-6989586621680525421"><a href="#local-6989586621680525421"><span class="hs-identifier">final_binds</span></a></a><span>
</span><a name="line-1060"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621680525419"><span class="hs-identifier hs-var">dump_dbs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1061"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525414"><span class="hs-identifier hs-var">spec_defns</span></a><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#recWithDumpedDicts"><span class="hs-identifier hs-var">recWithDumpedDicts</span></a><span> </span><a href="#local-6989586621680525416"><span class="hs-identifier hs-var">pairs</span></a><span> </span><a href="#local-6989586621680525419"><span class="hs-identifier hs-var">dump_dbs</span></a><span class="hs-special">]</span><span>
</span><a name="line-1063"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1064"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680525422"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680525423"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525422"><a href="#local-6989586621680525422"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525423"><a href="#local-6989586621680525423"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525416"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span>
</span><a name="line-1065"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621680525419"><span class="hs-identifier hs-var">dump_dbs</span></a><span>
</span><a name="line-1066"></a><span>
</span><a name="line-1067"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680525420"><span class="hs-identifier hs-var">float_all</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1068"></a><span>             </span><span class="hs-comment">-- Rather than discard the calls mentioning the bound variables</span><span>
</span><a name="line-1069"></a><span>             </span><span class="hs-comment">-- we float this (dictionary) binding along with the others</span><span>
</span><a name="line-1070"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525418"><span class="hs-identifier hs-var">free_uds</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#snocDictBinds"><span class="hs-identifier hs-var">snocDictBinds</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525421"><span class="hs-identifier hs-var">final_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1072"></a><span>             </span><span class="hs-comment">-- No call in final_uds mentions bound variables,</span><span>
</span><a name="line-1073"></a><span>             </span><span class="hs-comment">-- so we can just leave the binding here</span><span>
</span><a name="line-1074"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621680525421"><span class="hs-identifier hs-var">final_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525418"><span class="hs-identifier hs-var">free_uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1075"></a><span>
</span><a name="line-1076"></a><span>
</span><a name="line-1077"></a><span class="hs-identifier">specBind</span><span> </span><a name="local-6989586621680525424"><a href="#local-6989586621680525424"><span class="hs-identifier">rhs_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621680525425"><a href="#local-6989586621680525425"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680525426"><a href="#local-6989586621680525426"><span class="hs-identifier">body_uds</span></a></a><span>
</span><a name="line-1078"></a><span>       </span><span class="hs-comment">-- Note [Specialising a recursive group]</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525427"><a href="#local-6989586621680525427"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525428"><a href="#local-6989586621680525428"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680525425"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1080"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525429"><a href="#local-6989586621680525429"><span class="hs-identifier">rhss'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525430"><a href="#local-6989586621680525430"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525424"><span class="hs-identifier hs-var">rhs_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525428"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-1081"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525431"><a href="#local-6989586621680525431"><span class="hs-identifier">scope_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525426"><span class="hs-identifier hs-var">body_uds</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525430"><span class="hs-identifier hs-var">rhs_uds</span></a><span>
</span><a name="line-1082"></a><span>                       </span><span class="hs-comment">-- Includes binds and calls arising from rhss</span><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525432"><a href="#local-6989586621680525432"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525433"><a href="#local-6989586621680525433"><span class="hs-identifier">spec_defns1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525434"><a href="#local-6989586621680525434"><span class="hs-identifier">uds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a><span> </span><a href="#local-6989586621680525424"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680525431"><span class="hs-identifier hs-var">scope_uds</span></a><span> </span><a href="#local-6989586621680525425"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1085"></a><span>
</span><a name="line-1086"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525438"><a href="#local-6989586621680525438"><span class="hs-identifier">bndrs3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525439"><a href="#local-6989586621680525439"><span class="hs-identifier">spec_defns3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525440"><a href="#local-6989586621680525440"><span class="hs-identifier">uds3</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525433"><span class="hs-identifier hs-var">spec_defns1</span></a><span>  </span><span class="hs-comment">-- Common case: no specialisation</span><span>
</span><a name="line-1088"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525432"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525434"><span class="hs-identifier hs-var">uds1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1089"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>            </span><span class="hs-comment">-- Specialisation occurred; do it again</span><span>
</span><a name="line-1090"></a><span>                          </span><span class="hs-special">(</span><a name="local-6989586621680525435"><a href="#local-6989586621680525435"><span class="hs-identifier">bndrs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525436"><a href="#local-6989586621680525436"><span class="hs-identifier">spec_defns2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525437"><a href="#local-6989586621680525437"><span class="hs-identifier">uds2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1091"></a><span>                              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a><span> </span><a href="#local-6989586621680525424"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680525434"><span class="hs-identifier hs-var">uds1</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525432"><span class="hs-identifier hs-var">bndrs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525428"><span class="hs-identifier hs-var">rhss</span></a><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525435"><span class="hs-identifier hs-var">bndrs2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525436"><span class="hs-identifier hs-var">spec_defns2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525433"><span class="hs-identifier hs-var">spec_defns1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525437"><span class="hs-identifier hs-var">uds2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1093"></a><span>
</span><a name="line-1094"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525441"><a href="#local-6989586621680525441"><span class="hs-identifier">final_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525442"><a href="#local-6989586621680525442"><span class="hs-identifier">dumped_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525443"><a href="#local-6989586621680525443"><span class="hs-identifier">float_all</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#dumpBindUDs"><span class="hs-identifier hs-var">dumpBindUDs</span></a><span> </span><a href="#local-6989586621680525427"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680525440"><span class="hs-identifier hs-var">uds3</span></a><span>
</span><a name="line-1095"></a><span>             </span><a name="local-6989586621680525444"><a href="#local-6989586621680525444"><span class="hs-identifier">final_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#recWithDumpedDicts"><span class="hs-identifier hs-var">recWithDumpedDicts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525439"><span class="hs-identifier hs-var">spec_defns3</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621680525438"><span class="hs-identifier hs-var">bndrs3</span></a><span> </span><a href="#local-6989586621680525429"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1096"></a><span>                                             </span><a href="#local-6989586621680525442"><span class="hs-identifier hs-var">dumped_dbs</span></a><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680525443"><span class="hs-identifier hs-var">float_all</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1099"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525441"><span class="hs-identifier hs-var">final_uds</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#snocDictBind"><span class="hs-identifier hs-var">snocDictBind</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525444"><span class="hs-identifier hs-var">final_bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1101"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621680525444"><span class="hs-identifier hs-var">final_bind</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525441"><span class="hs-identifier hs-var">final_uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1102"></a><span>
</span><a name="line-1103"></a><span>
</span><a name="line-1104"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1105"></a><span class="hs-identifier">specDefns</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>
</span><a name="line-1106"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>               </span><span class="hs-comment">-- Info on how it is used in its scope</span><span>
</span><a name="line-1107"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">,</span><span class="hs-identifier hs-type">InExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- The things being bound and their un-processed RHS</span><span>
</span><a name="line-1108"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">]</span><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- Original Ids with RULES added</span><span>
</span><a name="line-1109"></a><span>                    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">,</span><span class="hs-identifier hs-type">OutExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Extra, specialised bindings</span><span>
</span><a name="line-1110"></a><span>                    </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Stuff to fling upwards from the specialised versions</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span class="hs-comment">-- Specialise a list of bindings (the contents of a Rec), but flowing usages</span><span>
</span><a name="line-1113"></a><span class="hs-comment">-- upwards binding by binding.  Example: { f = ...g ...; g = ...f .... }</span><span>
</span><a name="line-1114"></a><span class="hs-comment">-- Then if the input CallDetails has a specialised call for 'g', whose specialisation</span><span>
</span><a name="line-1115"></a><span class="hs-comment">-- in turn generates a specialised call for 'f', we catch that in this one sweep.</span><span>
</span><a name="line-1116"></a><span class="hs-comment">-- But not vice versa (it's a fixpoint problem).</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><a name="specDefns"><a href="Specialise.html#specDefns"><span class="hs-identifier">specDefns</span></a></a><span> </span><a name="local-6989586621680525445"><a href="#local-6989586621680525445"><span class="hs-identifier">_env</span></a></a><span> </span><a name="local-6989586621680525446"><a href="#local-6989586621680525446"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1119"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525446"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1120"></a><span class="hs-identifier">specDefns</span><span> </span><a name="local-6989586621680525447"><a href="#local-6989586621680525447"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525448"><a href="#local-6989586621680525448"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680525449"><a href="#local-6989586621680525449"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525450"><a href="#local-6989586621680525450"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621680525451"><a href="#local-6989586621680525451"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525452"><a href="#local-6989586621680525452"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525453"><a href="#local-6989586621680525453"><span class="hs-identifier">spec_defns1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525454"><a href="#local-6989586621680525454"><span class="hs-identifier">uds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specDefns"><span class="hs-identifier hs-var">specDefns</span></a><span> </span><a href="#local-6989586621680525447"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525448"><span class="hs-identifier hs-var">uds</span></a><span> </span><a href="#local-6989586621680525451"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-1122"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525455"><a href="#local-6989586621680525455"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525456"><a href="#local-6989586621680525456"><span class="hs-identifier">spec_defns2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525457"><a href="#local-6989586621680525457"><span class="hs-identifier">uds2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specDefn"><span class="hs-identifier hs-var">specDefn</span></a><span> </span><a href="#local-6989586621680525447"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525454"><span class="hs-identifier hs-var">uds1</span></a><span> </span><a href="#local-6989586621680525449"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680525450"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1123"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525455"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525452"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525453"><span class="hs-identifier hs-var">spec_defns1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525456"><span class="hs-identifier hs-var">spec_defns2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525457"><span class="hs-identifier hs-var">uds2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1124"></a><span>
</span><a name="line-1125"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1126"></a><span class="hs-identifier">specDefn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>
</span><a name="line-1127"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>                </span><span class="hs-comment">-- Info on how it is used in its scope</span><span>
</span><a name="line-1128"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InExpr</span><span>             </span><span class="hs-comment">-- The thing being bound and its un-processed RHS</span><span>
</span><a name="line-1129"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span>                  </span><span class="hs-comment">-- Original Id with added RULES</span><span>
</span><a name="line-1130"></a><span>                   </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Extra, specialised bindings</span><span>
</span><a name="line-1131"></a><span>                   </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Stuff to fling upwards from the specialised versions</span><span>
</span><a name="line-1132"></a><span>
</span><a name="line-1133"></a><a name="specDefn"><a href="Specialise.html#specDefn"><span class="hs-identifier">specDefn</span></a></a><span> </span><a name="local-6989586621680525458"><a href="#local-6989586621680525458"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525459"><a href="#local-6989586621680525459"><span class="hs-identifier">body_uds</span></a></a><span> </span><a name="local-6989586621680525460"><a href="#local-6989586621680525460"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680525461"><a href="#local-6989586621680525461"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1134"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525462"><a href="#local-6989586621680525462"><span class="hs-identifier">body_uds_without_me</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525463"><a href="#local-6989586621680525463"><span class="hs-identifier">calls_for_me</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#callsForMe"><span class="hs-identifier hs-var">callsForMe</span></a><span> </span><a href="#local-6989586621680525460"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525459"><span class="hs-identifier hs-var">body_uds</span></a><span>
</span><a name="line-1135"></a><span>             </span><a name="local-6989586621680525464"><a href="#local-6989586621680525464"><span class="hs-identifier">rules_for_me</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idCoreRules</span><span> </span><a href="#local-6989586621680525460"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1136"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525465"><a href="#local-6989586621680525465"><span class="hs-identifier">rules</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525466"><a href="#local-6989586621680525466"><span class="hs-identifier">spec_defns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525467"><a href="#local-6989586621680525467"><span class="hs-identifier">spec_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specCalls"><span class="hs-identifier hs-var">specCalls</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621680525458"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525464"><span class="hs-identifier hs-var">rules_for_me</span></a><span>
</span><a name="line-1137"></a><span>                                                    </span><a href="#local-6989586621680525463"><span class="hs-identifier hs-var">calls_for_me</span></a><span> </span><a href="#local-6989586621680525460"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525461"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1138"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680525460"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addIdSpecialisations</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525465"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-1139"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525466"><span class="hs-identifier hs-var">spec_defns</span></a><span>
</span><a name="line-1140"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525462"><span class="hs-identifier hs-var">body_uds_without_me</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525467"><span class="hs-identifier hs-var">spec_uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1141"></a><span>                </span><span class="hs-comment">-- It's important that the `plusUDs` is this way</span><span>
</span><a name="line-1142"></a><span>                </span><span class="hs-comment">-- round, because body_uds_without_me may bind</span><span>
</span><a name="line-1143"></a><span>                </span><span class="hs-comment">-- dictionaries that are used in calls_for_me passed</span><span>
</span><a name="line-1144"></a><span>                </span><span class="hs-comment">-- to specDefn.  So the dictionary bindings in</span><span>
</span><a name="line-1145"></a><span>                </span><span class="hs-comment">-- spec_uds may mention dictionaries bound in</span><span>
</span><a name="line-1146"></a><span>                </span><span class="hs-comment">-- body_uds_without_me</span><span>
</span><a name="line-1147"></a><span>
</span><a name="line-1148"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1149"></a><span class="hs-identifier">specCalls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Module</span><span>      </span><span class="hs-comment">-- Just this_mod  =&gt;  specialising imported fn</span><span>
</span><a name="line-1150"></a><span>                               </span><span class="hs-comment">-- Nothing        =&gt;  specialising local fn</span><span>
</span><a name="line-1151"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>
</span><a name="line-1152"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Existing RULES for the fn</span><span>
</span><a name="line-1153"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-1154"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InExpr</span><span>
</span><a name="line-1155"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><a href="Specialise.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a><span>    </span><span class="hs-comment">-- New rules, specialised bindings, and usage details</span><span>
</span><a name="line-1156"></a><span>
</span><a name="line-1157"></a><span class="hs-comment">-- This function checks existing rules, and does not create</span><span>
</span><a name="line-1158"></a><span class="hs-comment">-- duplicate ones. So the caller does not need to do this filtering.</span><span>
</span><a name="line-1159"></a><span class="hs-comment">-- See 'already_covered'</span><span>
</span><a name="line-1160"></a><span>
</span><a name="line-1161"></a><span class="hs-keyword">type</span><span> </span><a name="SpecInfo"><a href="Specialise.html#SpecInfo"><span class="hs-identifier">SpecInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Specialisation rules</span><span>
</span><a name="line-1162"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Specialised definition</span><span>
</span><a name="line-1163"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Usage details from specialised RHSs</span><span>
</span><a name="line-1164"></a><span>
</span><a name="line-1165"></a><a name="specCalls"><a href="Specialise.html#specCalls"><span class="hs-identifier">specCalls</span></a></a><span> </span><a name="local-6989586621680525468"><a href="#local-6989586621680525468"><span class="hs-identifier">mb_mod</span></a></a><span> </span><a name="local-6989586621680525469"><a href="#local-6989586621680525469"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525470"><a href="#local-6989586621680525470"><span class="hs-identifier">existing_rules</span></a></a><span> </span><a name="local-6989586621680525471"><a href="#local-6989586621680525471"><span class="hs-identifier">calls_for_me</span></a></a><span> </span><a name="local-6989586621680525472"><a href="#local-6989586621680525472"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680525473"><a href="#local-6989586621680525473"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1166"></a><span>        </span><span class="hs-comment">-- The first case is the interesting one</span><span>
</span><a name="line-1167"></a><span>  </span><span class="hs-glyph">|</span><span>  </span><a href="#local-6989586621680525487"><span class="hs-identifier hs-var">rhs_tyvars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span>      </span><a href="#local-6989586621680525480"><span class="hs-identifier hs-var">n_tyvars</span></a><span> </span><span class="hs-comment">-- Rhs of fn's defn has right number of big lambdas</span><span>
</span><a name="line-1168"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680525488"><span class="hs-identifier hs-var">rhs_bndrs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthAtLeast</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525481"><span class="hs-identifier hs-var">n_dicts</span></a><span> </span><span class="hs-comment">-- and enough dict args</span><span>
</span><a name="line-1169"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621680525471"><span class="hs-identifier hs-var">calls_for_me</span></a><span>               </span><span class="hs-comment">-- And there are some calls to specialise</span><span>
</span><a name="line-1170"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNeverActive</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlineActivation</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1171"></a><span>        </span><span class="hs-comment">-- Don't specialise NOINLINE things</span><span>
</span><a name="line-1172"></a><span>        </span><span class="hs-comment">-- See Note [Auto-specialisation and RULES]</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span class="hs-comment">--   &amp;&amp; not (certainlyWillInline (idUnfolding fn))      -- And it's not small</span><span>
</span><a name="line-1175"></a><span class="hs-comment">--      See Note [Inline specialisation] for why we do not</span><span>
</span><a name="line-1176"></a><span class="hs-comment">--      switch off specialisation for inline functions</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;specDefn: some&quot; (ppr fn $$ ppr calls_for_me $$ ppr existing_rules) $</span><span>
</span><a name="line-1179"></a><span>    </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="#local-6989586621680525495"><span class="hs-identifier hs-var">spec_call</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525471"><span class="hs-identifier hs-var">calls_for_me</span></a><span>
</span><a name="line-1180"></a><span>
</span><a name="line-1181"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- No calls or RHS doesn't fit our preconceptions</span><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">exprIsTrivial</span><span> </span><span class="hs-identifier hs-var">rhs</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">calls_for_me</span><span class="hs-special">,</span><span>
</span><a name="line-1183"></a><span>          </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Missed specialisation opportunity for&quot;</span><span>
</span><a name="line-1184"></a><span>                                 </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">fn</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">_trace_doc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1185"></a><span>          </span><span class="hs-comment">-- Note [Specialisation shape]</span><span>
</span><a name="line-1186"></a><span>    </span><span class="hs-comment">-- pprTrace &quot;specDefn: none&quot; (ppr fn &lt;+&gt; ppr calls_for_me) $</span><span>
</span><a name="line-1187"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1189"></a><span>    </span><a name="local-6989586621680525474"><a href="#local-6989586621680525474"><span class="hs-identifier">_trace_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525487"><span class="hs-identifier hs-var">rhs_tyvars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525480"><span class="hs-identifier hs-var">n_tyvars</span></a><span>
</span><a name="line-1190"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525485"><span class="hs-identifier hs-var">rhs_bndrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525481"><span class="hs-identifier hs-var">n_dicts</span></a><span>
</span><a name="line-1191"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlineActivation</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1192"></a><span>
</span><a name="line-1193"></a><span>    </span><a name="local-6989586621680525475"><a href="#local-6989586621680525475"><span class="hs-identifier">fn_type</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1194"></a><span>    </span><a name="local-6989586621680525476"><a href="#local-6989586621680525476"><span class="hs-identifier">fn_arity</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1195"></a><span>    </span><a name="local-6989586621680525477"><a href="#local-6989586621680525477"><span class="hs-identifier">fn_unf</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span>  </span><span class="hs-comment">-- Ignore loop-breaker-ness here</span><span>
</span><a name="line-1196"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525478"><a href="#local-6989586621680525478"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525479"><a href="#local-6989586621680525479"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621680525475"><span class="hs-identifier hs-var">fn_type</span></a><span>
</span><a name="line-1197"></a><span>    </span><a name="local-6989586621680525480"><a href="#local-6989586621680525480"><span class="hs-identifier">n_tyvars</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525478"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-1198"></a><span>    </span><a name="local-6989586621680525481"><a href="#local-6989586621680525481"><span class="hs-identifier">n_dicts</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525479"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1199"></a><span>    </span><a name="local-6989586621680525482"><a href="#local-6989586621680525482"><span class="hs-identifier">inl_prag</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1200"></a><span>    </span><a name="local-6989586621680525483"><a href="#local-6989586621680525483"><span class="hs-identifier">inl_act</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">inlinePragmaActivation</span><span> </span><a href="#local-6989586621680525482"><span class="hs-identifier hs-var">inl_prag</span></a><span>
</span><a name="line-1201"></a><span>    </span><a name="local-6989586621680525484"><a href="#local-6989586621680525484"><span class="hs-identifier">is_local</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span>        </span><span class="hs-comment">-- Figure out whether the function has an INLINE pragma</span><span>
</span><a name="line-1204"></a><span>        </span><span class="hs-comment">-- See Note [Inline specialisations]</span><span>
</span><a name="line-1205"></a><span>
</span><a name="line-1206"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525485"><a href="#local-6989586621680525485"><span class="hs-identifier">rhs_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525486"><a href="#local-6989586621680525486"><span class="hs-identifier">rhs_body</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectBindersPushingCo</span><span> </span><a href="#local-6989586621680525473"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1207"></a><span>                                 </span><span class="hs-comment">-- See Note [Account for casts in binding]</span><span>
</span><a name="line-1208"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525487"><a href="#local-6989586621680525487"><span class="hs-identifier">rhs_tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525488"><a href="#local-6989586621680525488"><span class="hs-identifier">rhs_bndrs1</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621680525485"><span class="hs-identifier hs-var">rhs_bndrs</span></a><span>
</span><a name="line-1209"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525489"><a href="#local-6989586621680525489"><span class="hs-identifier">rhs_dict_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525490"><a href="#local-6989586621680525490"><span class="hs-identifier">rhs_bndrs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621680525481"><span class="hs-identifier hs-var">n_dicts</span></a><span> </span><a href="#local-6989586621680525488"><span class="hs-identifier hs-var">rhs_bndrs1</span></a><span>
</span><a name="line-1210"></a><span>    </span><a name="local-6989586621680525491"><a href="#local-6989586621680525491"><span class="hs-identifier">body</span></a></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680525490"><span class="hs-identifier hs-var">rhs_bndrs2</span></a><span> </span><a href="#local-6989586621680525486"><span class="hs-identifier hs-var">rhs_body</span></a><span>
</span><a name="line-1211"></a><span>                                 </span><span class="hs-comment">-- Glue back on the non-dict lambdas</span><span>
</span><a name="line-1212"></a><span>
</span><a name="line-1213"></a><span>    </span><a name="local-6989586621680525492"><a href="#local-6989586621680525492"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substInScope</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525469"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1214"></a><span>
</span><a name="line-1215"></a><span>    </span><span class="hs-identifier">already_covered</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1216"></a><span>    </span><a name="local-6989586621680525493"><a href="#local-6989586621680525493"><span class="hs-identifier">already_covered</span></a></a><span> </span><a name="local-6989586621680525496"><a href="#local-6989586621680525496"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680525497"><a href="#local-6989586621680525497"><span class="hs-identifier">new_rules</span></a></a><span> </span><a name="local-6989586621680525498"><a href="#local-6989586621680525498"><span class="hs-identifier">args</span></a></a><span>      </span><span class="hs-comment">-- Note [Specialisations already covered]</span><span>
</span><a name="line-1217"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupRule</span><span> </span><a href="#local-6989586621680525496"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525492"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">realIdUnfolding</span><span class="hs-special">)</span><span>
</span><a name="line-1218"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525498"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1219"></a><span>                            </span><span class="hs-special">(</span><a href="#local-6989586621680525497"><span class="hs-identifier hs-var">new_rules</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525470"><span class="hs-identifier hs-var">existing_rules</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1220"></a><span>         </span><span class="hs-comment">-- NB: we look both in the new_rules (generated by this invocation</span><span>
</span><a name="line-1221"></a><span>         </span><span class="hs-comment">--     of specCalls), and in existing_rules (passed in to specCalls)</span><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span>    </span><span class="hs-identifier">mk_ty_args</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span>
</span><a name="line-1224"></a><span>    </span><a name="local-6989586621680525494"><a href="#local-6989586621680525494"><span class="hs-identifier">mk_ty_args</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621680525499"><a href="#local-6989586621680525499"><span class="hs-identifier">poly_tvs</span></a></a><span>
</span><a name="line-1225"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">poly_tvs</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1226"></a><span>    </span><span class="hs-identifier">mk_ty_args</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525500"><a href="#local-6989586621680525500"><span class="hs-identifier">call_ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525501"><a href="#local-6989586621680525501"><span class="hs-identifier">poly_tv</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525502"><a href="#local-6989586621680525502"><span class="hs-identifier">poly_tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1227"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621680525501"><span class="hs-identifier hs-var">poly_tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525494"><span class="hs-identifier hs-var">mk_ty_args</span></a><span> </span><a href="#local-6989586621680525500"><span class="hs-identifier hs-var">call_ts</span></a><span> </span><a href="#local-6989586621680525502"><span class="hs-identifier hs-var">poly_tvs</span></a><span>
</span><a name="line-1228"></a><span>    </span><span class="hs-identifier">mk_ty_args</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525503"><a href="#local-6989586621680525503"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525504"><a href="#local-6989586621680525504"><span class="hs-identifier">call_ts</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680525505"><a href="#local-6989586621680525505"><span class="hs-identifier">poly_tvs</span></a></a><span>
</span><a name="line-1229"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621680525503"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525494"><span class="hs-identifier hs-var">mk_ty_args</span></a><span> </span><a href="#local-6989586621680525504"><span class="hs-identifier hs-var">call_ts</span></a><span> </span><a href="#local-6989586621680525505"><span class="hs-identifier hs-var">poly_tvs</span></a><span>
</span><a name="line-1230"></a><span>    </span><span class="hs-identifier">mk_ty_args</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mk_ty_args&quot;</span><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span>    </span><span class="hs-comment">----------------------------------------------------------</span><span>
</span><a name="line-1233"></a><span>        </span><span class="hs-comment">-- Specialise to one particular call pattern</span><span>
</span><a name="line-1234"></a><span>    </span><span class="hs-identifier">spec_call</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a><span>                         </span><span class="hs-comment">-- Accumulating parameter</span><span>
</span><a name="line-1235"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span>                         </span><span class="hs-comment">-- Call instance</span><span>
</span><a name="line-1236"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><a href="Specialise.html#SpecInfo"><span class="hs-identifier hs-type">SpecInfo</span></a><span>
</span><a name="line-1237"></a><span>    </span><a name="local-6989586621680525495"><a href="#local-6989586621680525495"><span class="hs-identifier">spec_call</span></a></a><span> </span><a name="local-6989586621680525506"><a href="#local-6989586621680525506"><span class="hs-identifier">spec_acc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621680525507"><a href="#local-6989586621680525507"><span class="hs-identifier">rules_acc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525508"><a href="#local-6989586621680525508"><span class="hs-identifier">pairs_acc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525509"><a href="#local-6989586621680525509"><span class="hs-identifier">uds_acc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1238"></a><span>              </span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_key</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#CallKey"><span class="hs-identifier hs-var">CallKey</span></a><span> </span><a name="local-6989586621680525510"><a href="#local-6989586621680525510"><span class="hs-identifier">call_ts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ci_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525511"><a href="#local-6989586621680525511"><span class="hs-identifier">call_ds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1239"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">call_ts</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">n_tyvars</span><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">call_ds</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">n_dicts</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span>        </span><span class="hs-comment">-- Suppose f's defn is  f = /\ a b c -&gt; \ d1 d2 -&gt; rhs</span><span>
</span><a name="line-1242"></a><span>        </span><span class="hs-comment">-- Suppose the call is for f [Just t1, Nothing, Just t3] [dx1, dx2]</span><span>
</span><a name="line-1243"></a><span>
</span><a name="line-1244"></a><span>        </span><span class="hs-comment">-- Construct the new binding</span><span>
</span><a name="line-1245"></a><span>        </span><span class="hs-comment">--      f1 = SUBST[a-&gt;t1,c-&gt;t3, d1-&gt;d1', d2-&gt;d2'] (/\ b -&gt; rhs)</span><span>
</span><a name="line-1246"></a><span>        </span><span class="hs-comment">-- PLUS the rule</span><span>
</span><a name="line-1247"></a><span>        </span><span class="hs-comment">--      RULE &quot;SPEC f&quot; forall b d1' d2'. f b d1' d2' = f1 b</span><span>
</span><a name="line-1248"></a><span>        </span><span class="hs-comment">--      In the rule, d1' and d2' are just wildcards, not used in the RHS</span><span>
</span><a name="line-1249"></a><span>        </span><span class="hs-comment">-- PLUS the usage-details</span><span>
</span><a name="line-1250"></a><span>        </span><span class="hs-comment">--      { d1' = dx1; d2' = dx2 }</span><span>
</span><a name="line-1251"></a><span>        </span><span class="hs-comment">-- where d1', d2' are cloned versions of d1,d2, with the type substitution</span><span>
</span><a name="line-1252"></a><span>        </span><span class="hs-comment">-- applied.  These auxiliary bindings just avoid duplication of dx1, dx2</span><span>
</span><a name="line-1253"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1254"></a><span>        </span><span class="hs-comment">-- Note that the substitution is applied to the whole thing.</span><span>
</span><a name="line-1255"></a><span>        </span><span class="hs-comment">-- This is convenient, but just slightly fragile.  Notably:</span><span>
</span><a name="line-1256"></a><span>        </span><span class="hs-comment">--      * There had better be no name clashes in a/b/c</span><span>
</span><a name="line-1257"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-1258"></a><span>                </span><span class="hs-comment">-- poly_tyvars = [b] in the example above</span><span>
</span><a name="line-1259"></a><span>                </span><span class="hs-comment">-- spec_tyvars = [a,c]</span><span>
</span><a name="line-1260"></a><span>                </span><span class="hs-comment">-- ty_args     = [t1,b,t3]</span><span>
</span><a name="line-1261"></a><span>                </span><a name="local-6989586621680525512"><a href="#local-6989586621680525512"><span class="hs-identifier">spec_tv_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680525516"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><a href="#local-6989586621680525517"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525516"><a href="#local-6989586621680525516"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525517"><a href="#local-6989586621680525517"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525487"><span class="hs-identifier hs-var">rhs_tyvars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525510"><span class="hs-identifier hs-var">call_ts</span></a><span class="hs-special">]</span><span>
</span><a name="line-1262"></a><span>                </span><a name="local-6989586621680525513"><a href="#local-6989586621680525513"><span class="hs-identifier">env1</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#extendTvSubstList"><span class="hs-identifier hs-var">extendTvSubstList</span></a><span> </span><a href="#local-6989586621680525469"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525512"><span class="hs-identifier hs-var">spec_tv_binds</span></a><span>
</span><a name="line-1263"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621680525514"><a href="#local-6989586621680525514"><span class="hs-identifier">rhs_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525515"><a href="#local-6989586621680525515"><span class="hs-identifier">poly_tyvars</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680525513"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-1264"></a><span>                                            </span><span class="hs-special">[</span><a href="#local-6989586621680525518"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525518"><a href="#local-6989586621680525518"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525487"><span class="hs-identifier hs-var">rhs_tyvars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525510"><span class="hs-identifier hs-var">call_ts</span></a><span class="hs-special">]</span><span>
</span><a name="line-1265"></a><span>
</span><a name="line-1266"></a><span>             </span><span class="hs-comment">-- Clone rhs_dicts, including instantiating their types</span><span>
</span><a name="line-1267"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525519"><a href="#local-6989586621680525519"><span class="hs-identifier">inst_dict_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#newDictBndr"><span class="hs-identifier hs-var">newDictBndr</span></a><span> </span><a href="#local-6989586621680525514"><span class="hs-identifier hs-var">rhs_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525489"><span class="hs-identifier hs-var">rhs_dict_ids</span></a><span>
</span><a name="line-1268"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525520"><a href="#local-6989586621680525520"><span class="hs-identifier">rhs_env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525521"><a href="#local-6989586621680525521"><span class="hs-identifier">dx_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525522"><a href="#local-6989586621680525522"><span class="hs-identifier">spec_dict_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1269"></a><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#bindAuxiliaryDicts"><span class="hs-identifier hs-var">bindAuxiliaryDicts</span></a><span> </span><a href="#local-6989586621680525514"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621680525489"><span class="hs-identifier hs-var">rhs_dict_ids</span></a><span> </span><a href="#local-6989586621680525511"><span class="hs-identifier hs-var">call_ds</span></a><span> </span><a href="#local-6989586621680525519"><span class="hs-identifier hs-var">inst_dict_ids</span></a><span>
</span><a name="line-1270"></a><span>                 </span><a name="local-6989586621680525523"><a href="#local-6989586621680525523"><span class="hs-identifier">ty_args</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525494"><span class="hs-identifier hs-var">mk_ty_args</span></a><span> </span><a href="#local-6989586621680525510"><span class="hs-identifier hs-var">call_ts</span></a><span> </span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span>
</span><a name="line-1271"></a><span>                 </span><a name="local-6989586621680525524"><a href="#local-6989586621680525524"><span class="hs-identifier">ev_args</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">varToCoreExpr</span><span> </span><a href="#local-6989586621680525519"><span class="hs-identifier hs-var">inst_dict_ids</span></a><span>  </span><span class="hs-comment">-- ev_args, ev_bndrs:</span><span>
</span><a name="line-1272"></a><span>                 </span><a name="local-6989586621680525525"><a href="#local-6989586621680525525"><span class="hs-identifier">ev_bndrs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprsFreeIdsList</span><span> </span><a href="#local-6989586621680525524"><span class="hs-identifier hs-var">ev_args</span></a><span>         </span><span class="hs-comment">-- See Note [Evidence foralls]</span><span>
</span><a name="line-1273"></a><span>                 </span><a name="local-6989586621680525526"><a href="#local-6989586621680525526"><span class="hs-identifier">rule_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525523"><span class="hs-identifier hs-var">ty_args</span></a><span>     </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525524"><span class="hs-identifier hs-var">ev_args</span></a><span>
</span><a name="line-1274"></a><span>                 </span><a name="local-6989586621680525527"><a href="#local-6989586621680525527"><span class="hs-identifier">rule_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525525"><span class="hs-identifier hs-var">ev_bndrs</span></a><span>
</span><a name="line-1275"></a><span>
</span><a name="line-1276"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525528"><a href="#local-6989586621680525528"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1277"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680525493"><span class="hs-identifier hs-var">already_covered</span></a><span> </span><a href="#local-6989586621680525528"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525507"><span class="hs-identifier hs-var">rules_acc</span></a><span> </span><a href="#local-6989586621680525526"><span class="hs-identifier hs-var">rule_args</span></a><span>
</span><a name="line-1278"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680525506"><span class="hs-identifier hs-var">spec_acc</span></a><span>
</span><a name="line-1279"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- pprTrace &quot;spec_call&quot; (vcat [ ppr _call_info, ppr fn, ppr rhs_dict_ids</span><span>
</span><a name="line-1280"></a><span>                  </span><span class="hs-comment">--                           , text &quot;rhs_env2&quot; &lt;+&gt; ppr (se_subst rhs_env2)</span><span>
</span><a name="line-1281"></a><span>                  </span><span class="hs-comment">--                           , ppr dx_binds ]) $</span><span>
</span><a name="line-1282"></a><span>                  </span><span class="hs-keyword">do</span><span>
</span><a name="line-1283"></a><span>           </span><span class="hs-special">{</span><span>    </span><span class="hs-comment">-- Figure out the type of the specialised function</span><span>
</span><a name="line-1284"></a><span>             </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525529"><a href="#local-6989586621680525529"><span class="hs-identifier">body_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">applyTypeToArgs</span><span> </span><a href="#local-6989586621680525473"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680525475"><span class="hs-identifier hs-var">fn_type</span></a><span> </span><a href="#local-6989586621680525526"><span class="hs-identifier hs-var">rule_args</span></a><span>
</span><a name="line-1285"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621680525530"><a href="#local-6989586621680525530"><span class="hs-identifier">lam_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525531"><a href="#local-6989586621680525531"><span class="hs-identifier">app_args</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Add a dummy argument if body_ty is unlifted</span><span>
</span><a name="line-1286"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621680525529"><span class="hs-identifier hs-var">body_ty</span></a><span>     </span><span class="hs-comment">-- C.f. WwLib.mkWorkerArgs</span><span>
</span><a name="line-1287"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1288"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">voidArgId</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">voidPrimId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>                 </span><a name="local-6989586621680525532"><a href="#local-6989586621680525532"><span class="hs-identifier">spec_id_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLamTypes</span><span> </span><a href="#local-6989586621680525530"><span class="hs-identifier hs-var">lam_args</span></a><span> </span><a href="#local-6989586621680525529"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-1291"></a><span>                 </span><a name="local-6989586621680525533"><a href="#local-6989586621680525533"><span class="hs-identifier">join_arity_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525531"><span class="hs-identifier hs-var">app_args</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525526"><span class="hs-identifier hs-var">rule_args</span></a><span>
</span><a name="line-1292"></a><span>                 </span><a name="local-6989586621680525534"><a href="#local-6989586621680525534"><span class="hs-identifier">spec_join_arity</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525535"><a href="#local-6989586621680525535"><span class="hs-identifier">orig_join_arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isJoinId_maybe</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1293"></a><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525535"><span class="hs-identifier hs-var">orig_join_arity</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621680525533"><span class="hs-identifier hs-var">join_arity_change</span></a><span class="hs-special">)</span><span>
</span><a name="line-1294"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1295"></a><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1296"></a><span>
</span><a name="line-1297"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525536"><a href="#local-6989586621680525536"><span class="hs-identifier">spec_f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#newSpecIdSM"><span class="hs-identifier hs-var">newSpecIdSM</span></a><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680525532"><span class="hs-identifier hs-var">spec_id_ty</span></a><span> </span><a href="#local-6989586621680525534"><span class="hs-identifier hs-var">spec_join_arity</span></a><span>
</span><a name="line-1298"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525537"><a href="#local-6989586621680525537"><span class="hs-identifier">spec_rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525538"><a href="#local-6989586621680525538"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#specExpr"><span class="hs-identifier hs-var">specExpr</span></a><span> </span><a href="#local-6989586621680525520"><span class="hs-identifier hs-var">rhs_env2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621680525530"><span class="hs-identifier hs-var">lam_args</span></a><span> </span><a href="#local-6989586621680525491"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680525539"><a href="#local-6989586621680525539"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-1300"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-1301"></a><span>                </span><span class="hs-comment">-- The rule to put in the function's specialisation is:</span><span>
</span><a name="line-1302"></a><span>                </span><span class="hs-comment">--      forall b, d1',d2'.  f t1 b t3 d1' d2' = f1 b</span><span>
</span><a name="line-1303"></a><span>                </span><a name="local-6989586621680525540"><a href="#local-6989586621680525540"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680525468"><span class="hs-identifier hs-var">mb_mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1304"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span>        </span><span class="hs-comment">-- Specialising local fn</span><span>
</span><a name="line-1305"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;SPEC&quot;</span><span>
</span><a name="line-1306"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525550"><a href="#local-6989586621680525550"><span class="hs-identifier">this_mod</span></a></a><span>  </span><span class="hs-comment">-- Specialising imported fn</span><span>
</span><a name="line-1307"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;SPEC/&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525550"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-1308"></a><span>
</span><a name="line-1309"></a><span>                </span><a name="local-6989586621680525541"><a href="#local-6989586621680525541"><span class="hs-identifier">rule_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621680525528"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1310"></a><span>                            </span><a href="#local-6989586621680525540"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ftext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1311"></a><span>                                   </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Specialise.html#ppr_call_key_ty"><span class="hs-identifier hs-var">ppr_call_key_ty</span></a><span> </span><a href="#local-6989586621680525510"><span class="hs-identifier hs-var">call_ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1312"></a><span>                            </span><span class="hs-comment">-- This name ends up in interface files, so use occNameString.</span><span>
</span><a name="line-1313"></a><span>                            </span><span class="hs-comment">-- Otherwise uniques end up there, making builds</span><span>
</span><a name="line-1314"></a><span>                            </span><span class="hs-comment">-- less deterministic (See #4012 comment:61 ff)</span><span>
</span><a name="line-1315"></a><span>
</span><a name="line-1316"></a><span>                </span><a name="local-6989586621680525542"><a href="#local-6989586621680525542"><span class="hs-identifier">rule_wout_eta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRule</span><span>
</span><a name="line-1317"></a><span>                                  </span><a href="#local-6989586621680525539"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-1318"></a><span>                                  </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">{- Auto generated -}</span><span>
</span><a name="line-1319"></a><span>                                  </span><a href="#local-6989586621680525484"><span class="hs-identifier hs-var">is_local</span></a><span>
</span><a name="line-1320"></a><span>                                  </span><a href="#local-6989586621680525541"><span class="hs-identifier hs-var">rule_name</span></a><span>
</span><a name="line-1321"></a><span>                                  </span><a href="#local-6989586621680525483"><span class="hs-identifier hs-var">inl_act</span></a><span>       </span><span class="hs-comment">-- Note [Auto-specialisation and RULES]</span><span>
</span><a name="line-1322"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1323"></a><span>                                  </span><a href="#local-6989586621680525527"><span class="hs-identifier hs-var">rule_bndrs</span></a><span>
</span><a name="line-1324"></a><span>                                  </span><a href="#local-6989586621680525526"><span class="hs-identifier hs-var">rule_args</span></a><span>
</span><a name="line-1325"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525536"><span class="hs-identifier hs-var">spec_f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525531"><span class="hs-identifier hs-var">app_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1326"></a><span>
</span><a name="line-1327"></a><span>                </span><a name="local-6989586621680525543"><a href="#local-6989586621680525543"><span class="hs-identifier">spec_rule</span></a></a><span>
</span><a name="line-1328"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">isJoinId_maybe</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1329"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525551"><a href="#local-6989586621680525551"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">etaExpandToJoinPointRule</span><span> </span><a href="#local-6989586621680525551"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-1330"></a><span>                                                                  </span><a href="#local-6989586621680525542"><span class="hs-identifier hs-var">rule_wout_eta</span></a><span>
</span><a name="line-1331"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680525542"><span class="hs-identifier hs-var">rule_wout_eta</span></a><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span>                </span><span class="hs-comment">-- Add the { d1' = dx1; d2' = dx2 } usage stuff</span><span>
</span><a name="line-1334"></a><span>                </span><a name="local-6989586621680525544"><a href="#local-6989586621680525544"><span class="hs-identifier">spec_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="Specialise.html#consDictBind"><span class="hs-identifier hs-var">consDictBind</span></a><span> </span><a href="#local-6989586621680525538"><span class="hs-identifier hs-var">rhs_uds</span></a><span> </span><a href="#local-6989586621680525521"><span class="hs-identifier hs-var">dx_binds</span></a><span>
</span><a name="line-1335"></a><span>
</span><a name="line-1336"></a><span>                </span><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1337"></a><span>                </span><span class="hs-comment">-- Add a suitable unfolding if the spec_inl_prag says so</span><span>
</span><a name="line-1338"></a><span>                </span><span class="hs-comment">-- See Note [Inline specialisations]</span><span>
</span><a name="line-1339"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621680525545"><a href="#local-6989586621680525545"><span class="hs-identifier">spec_inl_prag</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525546"><a href="#local-6989586621680525546"><span class="hs-identifier">spec_unf</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680525484"><span class="hs-identifier hs-var">is_local</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isStrongLoopBreaker</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idOccInfo</span><span> </span><a href="#local-6989586621680525472"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1341"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">neverInlinePragma</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noUnfolding</span><span class="hs-special">)</span><span>
</span><a name="line-1342"></a><span>                        </span><span class="hs-comment">-- See Note [Specialising imported functions] in OccurAnal</span><span>
</span><a name="line-1343"></a><span>
</span><a name="line-1344"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">InlinePragma</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inl_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Inlinable</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525482"><span class="hs-identifier hs-var">inl_prag</span></a><span>
</span><a name="line-1345"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525482"><span class="hs-identifier hs-var">inl_prag</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inl_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoUserInline</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noUnfolding</span><span class="hs-special">)</span><span>
</span><a name="line-1346"></a><span>
</span><a name="line-1347"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1348"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525482"><span class="hs-identifier hs-var">inl_prag</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">specUnfolding</span><span> </span><a href="#local-6989586621680525528"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680525515"><span class="hs-identifier hs-var">poly_tyvars</span></a><span> </span><a href="#local-6989586621680525548"><span class="hs-identifier hs-var">spec_app</span></a><span>
</span><a name="line-1349"></a><span>                                             </span><a href="#local-6989586621680525547"><span class="hs-identifier hs-var">arity_decrease</span></a><span> </span><a href="#local-6989586621680525477"><span class="hs-identifier hs-var">fn_unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><span>                </span><a name="local-6989586621680525547"><a href="#local-6989586621680525547"><span class="hs-identifier">arity_decrease</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525522"><span class="hs-identifier hs-var">spec_dict_args</span></a><span>
</span><a name="line-1352"></a><span>                </span><a name="local-6989586621680525548"><a href="#local-6989586621680525548"><span class="hs-identifier">spec_app</span></a></a><span> </span><a name="local-6989586621680525552"><a href="#local-6989586621680525552"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525552"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkApps</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525523"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkApps</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525522"><span class="hs-identifier hs-var">spec_dict_args</span></a><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>                </span><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1355"></a><span>                </span><span class="hs-comment">-- Adding arity information just propagates it a bit faster</span><span>
</span><a name="line-1356"></a><span>                </span><span class="hs-comment">--      See Note [Arity decrease] in Simplify</span><span>
</span><a name="line-1357"></a><span>                </span><span class="hs-comment">-- Copy InlinePragma information from the parent Id.</span><span>
</span><a name="line-1358"></a><span>                </span><span class="hs-comment">-- So if f has INLINE[1] so does spec_f</span><span>
</span><a name="line-1359"></a><span>                </span><a name="local-6989586621680525549"><a href="#local-6989586621680525549"><span class="hs-identifier">spec_f_w_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525536"><span class="hs-identifier hs-var">spec_f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdArity</span><span class="hs-special">`</span><span>      </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525476"><span class="hs-identifier hs-var">fn_arity</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621680525481"><span class="hs-identifier hs-var">n_dicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1360"></a><span>                                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525545"><span class="hs-identifier hs-var">spec_inl_prag</span></a><span>
</span><a name="line-1361"></a><span>                                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span>  </span><a href="#local-6989586621680525546"><span class="hs-identifier hs-var">spec_unf</span></a><span>
</span><a name="line-1362"></a><span>                                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">asJoinId_maybe</span><span class="hs-special">`</span><span>  </span><a href="#local-6989586621680525534"><span class="hs-identifier hs-var">spec_join_arity</span></a><span>
</span><a name="line-1363"></a><span>
</span><a name="line-1364"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680525543"><span class="hs-identifier hs-var">spec_rule</span></a><span>                  </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525507"><span class="hs-identifier hs-var">rules_acc</span></a><span>
</span><a name="line-1365"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525549"><span class="hs-identifier hs-var">spec_f_w_arity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525537"><span class="hs-identifier hs-var">spec_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525508"><span class="hs-identifier hs-var">pairs_acc</span></a><span>
</span><a name="line-1366"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525544"><span class="hs-identifier hs-var">spec_uds</span></a><span>           </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525509"><span class="hs-identifier hs-var">uds_acc</span></a><span>
</span><a name="line-1367"></a><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1368"></a><span>
</span><a name="line-1369"></a><span class="hs-comment">{- Note [Account for casts in binding]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f :: Eq a =&gt; a -&gt; IO ()
   {-# INLINABLE f
       StableUnf = (/\a \(d:Eq a) (x:a). blah) |&gt; g
     #-}
   f = ...

In f's stable unfolding we have done some modest simplification which
has pushed the cast to the outside.  (I wonder if this is the Right
Thing, but it's what happens now; see SimplUtils Note [Casts and
lambdas].)  Now that stable unfolding must be specialised, so we want
to push the cast back inside. It would be terrible if the cast
defeated specialisation!  Hence the use of collectBindersPushingCo.

Note [Evidence foralls]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose (Trac #12212) that we are specialising
   f :: forall a b. (Num a, F a ~ F b) =&gt; blah
with a=b=Int. Then the RULE will be something like
   RULE forall (d:Num Int) (g :: F Int ~ F Int).
        f Int Int d g = f_spec
But both varToCoreExpr (when constructing the LHS args), and the
simplifier (when simplifying the LHS args), will transform to
   RULE forall (d:Num Int) (g :: F Int ~ F Int).
        f Int Int d &lt;F Int&gt; = f_spec
by replacing g with Refl.  So now 'g' is unbound, which results in a later
crash. So we use Refl right off the bat, and do not forall-quantify 'g':
 * varToCoreExpr generates a Refl
 * exprsFreeIdsList returns the Ids bound by the args,
   which won't include g

You might wonder if this will match as often, but the simplifier replaces
complicated Refl coercions with Refl pretty aggressively.

Note [Orphans and auto-generated rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we specialise an INLINABLE function, or when we have
-fspecialise-aggressively, we auto-generate RULES that are orphans.
We don't want to warn about these, or we'd generate a lot of warnings.
Thus, we only warn about user-specified orphan rules.

Indeed, we don't even treat the module as an orphan module if it has
auto-generated *rule* orphans.  Orphan modules are read every time we
compile, so they are pretty obtrusive and slow down every compilation,
even non-optimised ones.  (Reason: for type class instances it's a
type correctness issue.)  But specialisation rules are strictly for
*optimisation* only so it's fine not to read the interface.

What this means is that a SPEC rules from auto-specialisation in
module M will be used in other modules only if M.hi has been read for
some other reason, which is actually pretty likely.
-}</span><span>
</span><a name="line-1423"></a><span>
</span><a name="line-1424"></a><span class="hs-identifier">bindAuxiliaryDicts</span><span>
</span><a name="line-1425"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>
</span><a name="line-1426"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DictId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Original dict bndrs, and the witnessing expressions</span><span>
</span><a name="line-1427"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DictId</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- A cloned dict-id for each dict arg</span><span>
</span><a name="line-1428"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span class="hs-special">,</span><span>                </span><span class="hs-comment">-- Substitute for all orig_dicts</span><span>
</span><a name="line-1429"></a><span>            </span><span class="hs-special">[</span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>             </span><span class="hs-comment">-- Auxiliary dict bindings</span><span>
</span><a name="line-1430"></a><span>            </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- Witnessing expressions (all trivial)</span><span>
</span><a name="line-1431"></a><span class="hs-comment">-- Bind any dictionary arguments to fresh names, to preserve sharing</span><span>
</span><a name="line-1432"></a><a name="bindAuxiliaryDicts"><a href="Specialise.html#bindAuxiliaryDicts"><span class="hs-identifier">bindAuxiliaryDicts</span></a></a><span> </span><a name="local-6989586621680525553"><a href="#local-6989586621680525553"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Specialise.html#SE"><span class="hs-identifier hs-var">SE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525554"><a href="#local-6989586621680525554"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525555"><a href="#local-6989586621680525555"><span class="hs-identifier">interesting</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1433"></a><span>                   </span><a name="local-6989586621680525556"><a href="#local-6989586621680525556"><span class="hs-identifier">orig_dict_ids</span></a></a><span> </span><a name="local-6989586621680525557"><a href="#local-6989586621680525557"><span class="hs-identifier">call_ds</span></a></a><span> </span><a name="local-6989586621680525558"><a href="#local-6989586621680525558"><span class="hs-identifier">inst_dict_ids</span></a></a><span>
</span><a name="line-1434"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525561"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525559"><span class="hs-identifier hs-var">dx_binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525560"><span class="hs-identifier hs-var">spec_dict_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1435"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1436"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525559"><a href="#local-6989586621680525559"><span class="hs-identifier">dx_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525560"><a href="#local-6989586621680525560"><span class="hs-identifier">spec_dict_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525564"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525557"><span class="hs-identifier hs-var">call_ds</span></a><span> </span><a href="#local-6989586621680525558"><span class="hs-identifier hs-var">inst_dict_ids</span></a><span>
</span><a name="line-1437"></a><span>    </span><a name="local-6989586621680525561"><a href="#local-6989586621680525561"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525553"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525554"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">CoreSubst.extendSubstList</span><span class="hs-special">`</span><span>
</span><a name="line-1438"></a><span>                                     </span><span class="hs-special">(</span><a href="#local-6989586621680525556"><span class="hs-identifier hs-var">orig_dict_ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525560"><span class="hs-identifier hs-var">spec_dict_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1439"></a><span>                                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">CoreSubst.extendInScopeList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525562"><span class="hs-identifier hs-var">dx_ids</span></a><span>
</span><a name="line-1440"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525555"><span class="hs-identifier hs-var">interesting</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525563"><span class="hs-identifier hs-var">interesting_dicts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1441"></a><span>
</span><a name="line-1442"></a><span>    </span><a name="local-6989586621680525562"><a href="#local-6989586621680525562"><span class="hs-identifier">dx_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680525565"><span class="hs-identifier hs-var">dx_id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680525565"><a href="#local-6989586621680525565"><span class="hs-identifier">dx_id</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525559"><span class="hs-identifier hs-var">dx_binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-1443"></a><span>    </span><a name="local-6989586621680525563"><a href="#local-6989586621680525563"><span class="hs-identifier">interesting_dicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680525566"><span class="hs-identifier hs-var">dx_id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680525566"><a href="#local-6989586621680525566"><span class="hs-identifier">dx_id</span></a></a><span> </span><a name="local-6989586621680525567"><a href="#local-6989586621680525567"><span class="hs-identifier">dx</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525559"><span class="hs-identifier hs-var">dx_binds</span></a><span>
</span><a name="line-1444"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525553"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525567"><span class="hs-identifier hs-var">dx</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1445"></a><span>                  </span><span class="hs-comment">-- See Note [Make the new dictionaries interesting]</span><span>
</span><a name="line-1446"></a><span>
</span><a name="line-1447"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1448"></a><span>    </span><a name="local-6989586621680525564"><a href="#local-6989586621680525564"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1449"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525568"><a href="#local-6989586621680525568"><span class="hs-identifier">dx</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680525569"><a href="#local-6989586621680525569"><span class="hs-identifier">dxs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525570"><a href="#local-6989586621680525570"><span class="hs-identifier">dx_id</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680525571"><a href="#local-6989586621680525571"><span class="hs-identifier">dx_ids</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1450"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span> </span><a href="#local-6989586621680525568"><span class="hs-identifier hs-var">dx</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525572"><span class="hs-identifier hs-var">dx_binds</span></a><span class="hs-special">,</span><span>                          </span><a href="#local-6989586621680525568"><span class="hs-identifier hs-var">dx</span></a><span>        </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525573"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1451"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680525570"><span class="hs-identifier hs-var">dx_id</span></a><span> </span><a href="#local-6989586621680525568"><span class="hs-identifier hs-var">dx</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525572"><span class="hs-identifier hs-var">dx_binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621680525570"><span class="hs-identifier hs-var">dx_id</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525573"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1452"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1453"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680525572"><a href="#local-6989586621680525572"><span class="hs-identifier">dx_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525573"><a href="#local-6989586621680525573"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525564"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680525569"><span class="hs-identifier hs-var">dxs</span></a><span> </span><a href="#local-6989586621680525571"><span class="hs-identifier hs-var">dx_ids</span></a><span>
</span><a name="line-1454"></a><span>             </span><span class="hs-comment">-- In the first case extend the substitution but not bindings;</span><span>
</span><a name="line-1455"></a><span>             </span><span class="hs-comment">-- in the latter extend the bindings but not the substitution.</span><span>
</span><a name="line-1456"></a><span>             </span><span class="hs-comment">-- For the former, note that we bind the *original* dict in the substitution,</span><span>
</span><a name="line-1457"></a><span>             </span><span class="hs-comment">-- overriding any d-&gt;dx_id binding put there by substBndrs</span><span>
</span><a name="line-1458"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;bindAuxiliaryDicts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525556"><span class="hs-identifier hs-var">orig_dict_ids</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525557"><span class="hs-identifier hs-var">call_ds</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525558"><span class="hs-identifier hs-var">inst_dict_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1459"></a><span>
</span><a name="line-1460"></a><span class="hs-comment">{-
Note [Make the new dictionaries interesting]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Important!  We're going to substitute dx_id1 for d
and we want it to look &quot;interesting&quot;, else we won't gather *any*
consequential calls. E.g.
    f d = ...g d....
If we specialise f for a call (f (dfun dNumInt)), we'll get
a consequent call (g d') with an auxiliary definition
    d' = df dNumInt
We want that consequent call to look interesting


Note [From non-recursive to recursive]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Even in the non-recursive case, if any dict-binds depend on 'fn' we might
have built a recursive knot

      f a d x = &lt;blah&gt;
      MkUD { ud_binds = NonRec d7  (MkD ..f..)
           , ud_calls = ...(f T d7)... }

The we generate

     Rec { fs x = &lt;blah&gt;[T/a, d7/d]
           f a d x = &lt;blah&gt;
               RULE f T _ = fs
           d7 = ...f... }

Here the recursion is only through the RULE.

However we definitely should /not/ make the Rec in this wildly common
case:
      d = ...
      MkUD { ud_binds = NonRec d7 (...d...)
           , ud_calls = ...(f T d7)... }

Here we want simply to add d to the floats, giving
      MkUD { ud_binds = NonRec d (...)
                        NonRec d7 (...d...)
           , ud_calls = ...(f T d7)... }

In general, we need only make this Rec if
  - there are some specialisations (spec_binds non-empty)
  - there are some dict_binds that depend on f (dump_dbs non-empty)

Note [Avoiding loops]
~~~~~~~~~~~~~~~~~~~~~
When specialising /dictionary functions/ we must be very careful to
avoid building loops. Here is an example that bit us badly: Trac #3591

     class Eq a =&gt; C a
     instance Eq [a] =&gt; C [a]

This translates to
     dfun :: Eq [a] -&gt; C [a]
     dfun a d = MkD a d (meth d)

     d4 :: Eq [T] = &lt;blah&gt;
     d2 ::  C [T] = dfun T d4
     d1 :: Eq [T] = $p1 d2
     d3 ::  C [T] = dfun T d1

None of these definitions is recursive. What happened was that we
generated a specialisation:

     RULE forall d. dfun T d = dT  :: C [T]
     dT = (MkD a d (meth d)) [T/a, d1/d]
        = MkD T d1 (meth d1)

But now we use the RULE on the RHS of d2, to get

    d2 = dT = MkD d1 (meth d1)
    d1 = $p1 d2

and now d1 is bottom!  The problem is that when specialising 'dfun' we
should first dump &quot;below&quot; the binding all floated dictionary bindings
that mention 'dfun' itself.  So d2 and d3 (and hence d1) must be
placed below 'dfun', and thus unavailable to it when specialising
'dfun'.  That in turn means that the call (dfun T d1) must be
discarded.  On the other hand, the call (dfun T d4) is fine, assuming
d4 doesn't mention dfun.

Solution:
  Discard all calls that mention dictionaries that depend
  (directly or indirectly) on the dfun we are specialising.
  This is done by 'filterCalls'

--------------
Here's another example, this time for an imported dfun, so the call
to filterCalls is in specImports (Trac #13429). Suppose we have
  class Monoid v =&gt; C v a where ...

We start with a call
   f @ [Integer] @ Integer $fC[]Integer

Specialising call to 'f' gives dict bindings
   $dMonoid_1 :: Monoid [Integer]
   $dMonoid_1 = M.$p1C @ [Integer] $fC[]Integer

   $dC_1 :: C [Integer] (Node [Integer] Integer)
   $dC_1 = M.$fCvNode @ [Integer] $dMonoid_1

...plus a recursive call to
   f @ [Integer] @ (Node [Integer] Integer) $dC_1

Specialising that call gives
   $dMonoid_2  :: Monoid [Integer]
   $dMonoid_2  = M.$p1C @ [Integer] $dC_1

   $dC_2 :: C [Integer] (Node [Integer] Integer)
   $dC_2 = M.$fCvNode @ [Integer] $dMonoid_2

Now we have two calls to the imported function
  M.$fCvNode :: Monoid v =&gt; C v a
  M.$fCvNode @v @a m = C m some_fun

But we must /not/ use the call (M.$fCvNode @ [Integer] $dMonoid_2)
for specialisation, else we get:

  $dC_1 = M.$fCvNode @ [Integer] $dMonoid_1
  $dMonoid_2 = M.$p1C @ [Integer] $dC_1
  $s$fCvNode = C $dMonoid_2 ...
    RULE M.$fCvNode [Integer] _ _ = $s$fCvNode

Now use the rule to rewrite the call in the RHS of $dC_1
and we get a loop!

--------------
Here's yet another example

  class C a where { foo,bar :: [a] -&gt; [a] }

  instance C Int where
     foo x = r_bar x
     bar xs = reverse xs

  r_bar :: C a =&gt; [a] -&gt; [a]
  r_bar xs = bar (xs ++ xs)

That translates to:

    r_bar a (c::C a) (xs::[a]) = bar a d (xs ++ xs)

    Rec { $fCInt :: C Int = MkC foo_help reverse
          foo_help (xs::[Int]) = r_bar Int $fCInt xs }

The call (r_bar $fCInt) mentions $fCInt,
                        which mentions foo_help,
                        which mentions r_bar
But we DO want to specialise r_bar at Int:

    Rec { $fCInt :: C Int = MkC foo_help reverse
          foo_help (xs::[Int]) = r_bar Int $fCInt xs

          r_bar a (c::C a) (xs::[a]) = bar a d (xs ++ xs)
            RULE r_bar Int _ = r_bar_Int

          r_bar_Int xs = bar Int $fCInt (xs ++ xs)
           }

Note that, because of its RULE, r_bar joins the recursive
group.  (In this case it'll unravel a short moment later.)


Note [Specialising a recursive group]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    let rec { f x = ...g x'...
            ; g y = ...f y'.... }
    in f 'a'
Here we specialise 'f' at Char; but that is very likely to lead to
a specialisation of 'g' at Char.  We must do the latter, else the
whole point of specialisation is lost.

But we do not want to keep iterating to a fixpoint, because in the
presence of polymorphic recursion we might generate an infinite number
of specialisations.

So we use the following heuristic:
  * Arrange the rec block in dependency order, so far as possible
    (the occurrence analyser already does this)

  * Specialise it much like a sequence of lets

  * Then go through the block a second time, feeding call-info from
    the RHSs back in the bottom, as it were

In effect, the ordering maxmimises the effectiveness of each sweep,
and we do just two sweeps.   This should catch almost every case of
monomorphic recursion -- the exception could be a very knotted-up
recursion with multiple cycles tied up together.

This plan is implemented in the Rec case of specBindItself.

Note [Specialisations already covered]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We obviously don't want to generate two specialisations for the same
argument pattern.  There are two wrinkles

1. We do the already-covered test in specDefn, not when we generate
the CallInfo in mkCallUDs.  We used to test in the latter place, but
we now iterate the specialiser somewhat, and the Id at the call site
might therefore not have all the RULES that we can see in specDefn

2. What about two specialisations where the second is an *instance*
of the first?  If the more specific one shows up first, we'll generate
specialisations for both.  If the *less* specific one shows up first,
we *don't* currently generate a specialisation for the more specific
one.  (See the call to lookupRule in already_covered.)  Reasons:
  (a) lookupRule doesn't say which matches are exact (bad reason)
  (b) if the earlier specialisation is user-provided, it's
      far from clear that we should auto-specialise further

Note [Auto-specialisation and RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
   g :: Num a =&gt; a -&gt; a
   g = ...

   f :: (Int -&gt; Int) -&gt; Int
   f w = ...
   {-# RULE f g = 0 #-}

Suppose that auto-specialisation makes a specialised version of
g::Int-&gt;Int That version won't appear in the LHS of the RULE for f.
So if the specialisation rule fires too early, the rule for f may
never fire.

It might be possible to add new rules, to &quot;complete&quot; the rewrite system.
Thus when adding
        RULE forall d. g Int d = g_spec
also add
        RULE f g_spec = 0

But that's a bit complicated.  For now we ask the programmer's help,
by *copying the INLINE activation pragma* to the auto-specialised
rule.  So if g says {-# NOINLINE[2] g #-}, then the auto-spec rule
will also not be active until phase 2.  And that's what programmers
should jolly well do anyway, even aside from specialisation, to ensure
that g doesn't inline too early.

This in turn means that the RULE would never fire for a NOINLINE
thing so not much point in generating a specialisation at all.

Note [Specialisation shape]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only specialise a function if it has visible top-level lambdas
corresponding to its overloading.  E.g. if
        f :: forall a. Eq a =&gt; ....
then its body must look like
        f = /\a. \d. ...

Reason: when specialising the body for a call (f ty dexp), we want to
substitute dexp for d, and pick up specialised calls in the body of f.

This doesn't always work.  One example I came across was this:
        newtype Gen a = MkGen{ unGen :: Int -&gt; a }

        choose :: Eq a =&gt; a -&gt; Gen a
        choose n = MkGen (\r -&gt; n)

        oneof = choose (1::Int)

It's a silly example, but we get
        choose = /\a. g `cast` co
where choose doesn't have any dict arguments.  Thus far I have not
tried to fix this (wait till there's a real example).

Mind you, then 'choose' will be inlined (since RHS is trivial) so
it doesn't matter.  This comes up with single-method classes

   class C a where { op :: a -&gt; a }
   instance C a =&gt; C [a] where ....
==&gt;
   $fCList :: C a =&gt; C [a]
   $fCList = $copList |&gt; (...coercion&gt;...)
   ....(uses of $fCList at particular types)...

So we suppress the WARN if the rhs is trivial.

Note [Inline specialisations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is what we do with the InlinePragma of the original function
  * Activation/RuleMatchInfo: both transferred to the
                              specialised function
  * InlineSpec:
       (a) An INLINE pragma is transferred
       (b) An INLINABLE pragma is *not* transferred

Why (a): transfer INLINE pragmas? The point of INLINE was precisely to
specialise the function at its call site, and arguably that's not so
important for the specialised copies.  BUT *pragma-directed*
specialisation now takes place in the typechecker/desugarer, with
manually specified INLINEs.  The specialisation here is automatic.
It'd be very odd if a function marked INLINE was specialised (because
of some local use), and then forever after (including importing
modules) the specialised version wasn't INLINEd.  After all, the
programmer said INLINE!

You might wonder why we specialise INLINE functions at all.  After
all they should be inlined, right?  Two reasons:

 * Even INLINE functions are sometimes not inlined, when they aren't
   applied to interesting arguments.  But perhaps the type arguments
   alone are enough to specialise (even though the args are too boring
   to trigger inlining), and it's certainly better to call the
   specialised version.

 * The RHS of an INLINE function might call another overloaded function,
   and we'd like to generate a specialised version of that function too.
   This actually happens a lot. Consider
      replicateM_ :: (Monad m) =&gt; Int -&gt; m a -&gt; m ()
      {-# INLINABLE replicateM_ #-}
      replicateM_ d x ma = ...
   The strictness analyser may transform to
      replicateM_ :: (Monad m) =&gt; Int -&gt; m a -&gt; m ()
      {-# INLINE replicateM_ #-}
      replicateM_ d x ma = case x of I# x' -&gt; $wreplicateM_ d x' ma

      $wreplicateM_ :: (Monad m) =&gt; Int# -&gt; m a -&gt; m ()
      {-# INLINABLE $wreplicateM_ #-}
      $wreplicateM_ = ...
   Now an importing module has a specialised call to replicateM_, say
   (replicateM_ dMonadIO).  We certainly want to specialise $wreplicateM_!
   This particular example had a huge effect on the call to replicateM_
   in nofib/shootout/n-body.

Why (b): discard INLINABLE pragmas? See Trac #4874 for persuasive examples.
Suppose we have
    {-# INLINABLE f #-}
    f :: Ord a =&gt; [a] -&gt; Int
    f xs = letrec f' = ...f'... in f'
Then, when f is specialised and optimised we might get
    wgo :: [Int] -&gt; Int#
    wgo = ...wgo...
    f_spec :: [Int] -&gt; Int
    f_spec xs = case wgo xs of { r -&gt; I# r }
and we clearly want to inline f_spec at call sites.  But if we still
have the big, un-optimised of f (albeit specialised) captured in an
INLINABLE pragma for f_spec, we won't get that optimisation.

So we simply drop INLINABLE pragmas when specialising. It's not really
a complete solution; ignoring specialisation for now, INLINABLE functions
don't get properly strictness analysed, for example. But it works well
for examples involving specialisation, which is the dominant use of
INLINABLE.  See Trac #4874.


************************************************************************
*                                                                      *
\subsubsection{UsageDetails and suchlike}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1815"></a><span>
</span><a name="line-1816"></a><span class="hs-keyword">data</span><span> </span><a name="UsageDetails"><a href="Specialise.html#UsageDetails"><span class="hs-identifier">UsageDetails</span></a></a><span>
</span><a name="line-1817"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="MkUD"><a href="Specialise.html#MkUD"><span class="hs-identifier">MkUD</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1818"></a><span>      </span><a name="ud_binds"><a href="Specialise.html#ud_binds"><span class="hs-identifier">ud_binds</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1819"></a><span>               </span><span class="hs-comment">-- See Note [Floated dictionary bindings]</span><span>
</span><a name="line-1820"></a><span>               </span><span class="hs-comment">-- The order is important;</span><span>
</span><a name="line-1821"></a><span>               </span><span class="hs-comment">-- in ds1 `union` ds2, bindings in ds2 can depend on those in ds1</span><span>
</span><a name="line-1822"></a><span>               </span><span class="hs-comment">-- (Remember, Bags preserve order in GHC.)</span><span>
</span><a name="line-1823"></a><span>
</span><a name="line-1824"></a><span>      </span><a name="ud_calls"><a href="Specialise.html#ud_calls"><span class="hs-identifier">ud_calls</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span>
</span><a name="line-1825"></a><span>
</span><a name="line-1826"></a><span>      </span><span class="hs-comment">-- INVARIANT: suppose bs = bindersOf ud_binds</span><span>
</span><a name="line-1827"></a><span>      </span><span class="hs-comment">-- Then 'calls' may *mention* 'bs',</span><span>
</span><a name="line-1828"></a><span>      </span><span class="hs-comment">-- but there should be no calls *for* bs</span><span>
</span><a name="line-1829"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1830"></a><span>
</span><a name="line-1831"></a><span class="hs-comment">-- | A 'DictBind' is a binding along with a cached set containing its free</span><span>
</span><a name="line-1832"></a><span class="hs-comment">-- variables (both type variables and dictionaries)</span><span>
</span><a name="line-1833"></a><span class="hs-keyword">type</span><span> </span><a name="DictBind"><a href="Specialise.html#DictBind"><span class="hs-identifier">DictBind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span class="hs-special">)</span><span>
</span><a name="line-1834"></a><span>
</span><a name="line-1835"></a><span class="hs-comment">{- Note [Floated dictionary bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We float out dictionary bindings for the reasons described under
&quot;Dictionary floating&quot; above.  But not /just/ dictionary bindings.
Consider

   f :: Eq a =&gt; blah
   f a d = rhs

   $c== :: T -&gt; T -&gt; Bool
   $c== x y = ...

   $df :: Eq T
   $df = Eq $c== ...

   gurgle = ...(f @T $df)...

We gather the call info for (f @T $df), and we don't want to drop it
when we come across the binding for $df.  So we add $df to the floats
and continue.  But then we have to add $c== to the floats, and so on.
These all float above the binding for 'f', and and now we can
successfully specialise 'f'.

So the DictBinds in (ud_binds :: Bag DictBind) may contain
non-dictionary bindings too.
-}</span><span>
</span><a name="line-1861"></a><span>
</span><a name="line-1862"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1863"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525195"><a href="#local-6989586621680525195"><span class="hs-identifier">dbs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525196"><a href="#local-6989586621680525196"><span class="hs-identifier">calls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1864"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;MkUD&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span>
</span><a name="line-1865"></a><span>                </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;binds&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">equals</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525195"><span class="hs-identifier hs-var">dbs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1866"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;calls&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">equals</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525196"><span class="hs-identifier hs-var">calls</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1867"></a><span>
</span><a name="line-1868"></a><span class="hs-identifier">emptyUDs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-1869"></a><a name="emptyUDs"><a href="Specialise.html#emptyUDs"><span class="hs-identifier">emptyUDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyDVarEnv</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1870"></a><span>
</span><a name="line-1871"></a><span class="hs-comment">------------------------------------------------------------</span><span>
</span><a name="line-1872"></a><span class="hs-keyword">type</span><span> </span><a name="CallDetails"><a href="Specialise.html#CallDetails"><span class="hs-identifier">CallDetails</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">DIdEnv</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span>
</span><a name="line-1873"></a><span>  </span><span class="hs-comment">-- The order of specialized binds and rules depends on how we linearize</span><span>
</span><a name="line-1874"></a><span>  </span><span class="hs-comment">-- CallDetails, so to get determinism we must use a deterministic set here.</span><span>
</span><a name="line-1875"></a><span>  </span><span class="hs-comment">-- See Note [Deterministic UniqFM] in UniqDFM</span><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span class="hs-keyword">data</span><span> </span><a name="CallInfoSet"><a href="Specialise.html#CallInfoSet"><span class="hs-identifier">CallInfoSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CIS"><a href="Specialise.html#CIS"><span class="hs-identifier">CIS</span></a></a><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-1878"></a><span>  </span><span class="hs-comment">-- The list of types and dictionaries is guaranteed to</span><span>
</span><a name="line-1879"></a><span>  </span><span class="hs-comment">-- match the type of f</span><span>
</span><a name="line-1880"></a><span>  </span><span class="hs-comment">-- The Bag may contain duplicate calls (i.e. f @T and another f @T)</span><span>
</span><a name="line-1881"></a><span>  </span><span class="hs-comment">-- These dups are eliminated by already_covered in specCalls</span><span>
</span><a name="line-1882"></a><span>
</span><a name="line-1883"></a><span class="hs-keyword">data</span><span> </span><a name="CallInfo"><a href="Specialise.html#CallInfo"><span class="hs-identifier">CallInfo</span></a></a><span>
</span><a name="line-1884"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CI"><a href="Specialise.html#CI"><span class="hs-identifier">CI</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ci_key"><a href="Specialise.html#ci_key"><span class="hs-identifier">ci_key</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#CallKey"><span class="hs-identifier hs-type">CallKey</span></a><span>     </span><span class="hs-comment">-- Type arguments</span><span>
</span><a name="line-1885"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ci_args"><a href="Specialise.html#ci_args"><span class="hs-identifier">ci_args</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#DictExpr"><span class="hs-identifier hs-type">DictExpr</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Dictionary arguments</span><span>
</span><a name="line-1886"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ci_fvs"><a href="Specialise.html#ci_fvs"><span class="hs-identifier">ci_fvs</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>      </span><span class="hs-comment">-- Free vars of the ci_key and ci_args</span><span>
</span><a name="line-1887"></a><span>                                </span><span class="hs-comment">-- call (including tyvars)</span><span>
</span><a name="line-1888"></a><span>                                </span><span class="hs-comment">-- [*not* include the main id itself, of course]</span><span>
</span><a name="line-1889"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1890"></a><span>
</span><a name="line-1891"></a><span class="hs-keyword">newtype</span><span> </span><a name="CallKey"><a href="Specialise.html#CallKey"><span class="hs-identifier">CallKey</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="CallKey"><a href="Specialise.html#CallKey"><span class="hs-identifier">CallKey</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-1892"></a><span>  </span><span class="hs-comment">-- Nothing =&gt; unconstrained type argument</span><span>
</span><a name="line-1893"></a><span>
</span><a name="line-1894"></a><span class="hs-keyword">type</span><span> </span><a name="DictExpr"><a href="Specialise.html#DictExpr"><span class="hs-identifier">DictExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1895"></a><span>
</span><a name="line-1896"></a><span class="hs-identifier">ciSetFilter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span>
</span><a name="line-1897"></a><a name="ciSetFilter"><a href="Specialise.html#ciSetFilter"><span class="hs-identifier">ciSetFilter</span></a></a><span> </span><a name="local-6989586621680525574"><a href="#local-6989586621680525574"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a name="local-6989586621680525575"><a href="#local-6989586621680525575"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680525576"><a href="#local-6989586621680525576"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a href="#local-6989586621680525575"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterBag</span><span> </span><a href="#local-6989586621680525574"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621680525576"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1898"></a><span>
</span><a name="line-1899"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1900"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a name="local-6989586621680525193"><a href="#local-6989586621680525193"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680525194"><a href="#local-6989586621680525194"><span class="hs-identifier">map</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CIS&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525193"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1901"></a><span>                        </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525194"><span class="hs-identifier hs-var">map</span></a><span class="hs-special">)</span><span>
</span><a name="line-1902"></a><span>
</span><a name="line-1903"></a><span class="hs-identifier">pprCallInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1904"></a><a name="pprCallInfo"><a href="Specialise.html#pprCallInfo"><span class="hs-identifier">pprCallInfo</span></a></a><span> </span><a name="local-6989586621680525577"><a href="#local-6989586621680525577"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_key</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525578"><a href="#local-6989586621680525578"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1905"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525577"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525578"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-1906"></a><span>
</span><a name="line-1907"></a><span class="hs-identifier">ppr_call_key_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1908"></a><a name="ppr_call_key_ty"><a href="Specialise.html#ppr_call_key_ty"><span class="hs-identifier">ppr_call_key_ty</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'_'</span><span>
</span><a name="line-1909"></a><span class="hs-identifier">ppr_call_key_ty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525579"><a href="#local-6989586621680525579"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'@'</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprParendType</span><span> </span><a href="#local-6989586621680525579"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1910"></a><span>
</span><a name="line-1911"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="Specialise.html#CallKey"><span class="hs-identifier hs-type">CallKey</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1912"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CallKey"><span class="hs-identifier hs-var">CallKey</span></a><span> </span><a name="local-6989586621680525192"><a href="#local-6989586621680525192"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Specialise.html#ppr_call_key_ty"><span class="hs-identifier hs-var">ppr_call_key_ty</span></a><span> </span><a href="#local-6989586621680525192"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1913"></a><span>
</span><a name="line-1914"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1915"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_key</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525189"><a href="#local-6989586621680525189"><span class="hs-identifier">key</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ci_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525190"><a href="#local-6989586621680525190"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ci_fvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525191"><a href="#local-6989586621680525191"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1916"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CI&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525189"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525190"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525191"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1917"></a><span>
</span><a name="line-1918"></a><span class="hs-identifier">unionCalls</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span>
</span><a name="line-1919"></a><a name="unionCalls"><a href="Specialise.html#unionCalls"><span class="hs-identifier">unionCalls</span></a></a><span> </span><a name="local-6989586621680525580"><a href="#local-6989586621680525580"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621680525581"><a href="#local-6989586621680525581"><span class="hs-identifier">c2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusDVarEnv_C</span><span> </span><a href="Specialise.html#unionCallInfoSet"><span class="hs-identifier hs-var">unionCallInfoSet</span></a><span> </span><a href="#local-6989586621680525580"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621680525581"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1920"></a><span>
</span><a name="line-1921"></a><span class="hs-identifier">unionCallInfoSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span>
</span><a name="line-1922"></a><a name="unionCallInfoSet"><a href="Specialise.html#unionCallInfoSet"><span class="hs-identifier">unionCallInfoSet</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a name="local-6989586621680525582"><a href="#local-6989586621680525582"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680525583"><a href="#local-6989586621680525583"><span class="hs-identifier">calls1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680525584"><a href="#local-6989586621680525584"><span class="hs-identifier">calls2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1923"></a><span>  </span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a href="#local-6989586621680525582"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525583"><span class="hs-identifier hs-var">calls1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525584"><span class="hs-identifier hs-var">calls2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1924"></a><span>
</span><a name="line-1925"></a><span class="hs-identifier">callDetailsFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-1926"></a><a name="callDetailsFVs"><a href="Specialise.html#callDetailsFVs"><span class="hs-identifier">callDetailsFVs</span></a></a><span> </span><a name="local-6989586621680525585"><a href="#local-6989586621680525585"><span class="hs-identifier">calls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1927"></a><span>  </span><span class="hs-identifier hs-var">nonDetFoldUDFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unionVarSet</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Specialise.html#callInfoFVs"><span class="hs-identifier hs-var">callInfoFVs</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621680525585"><span class="hs-identifier hs-var">calls</span></a><span>
</span><a name="line-1928"></a><span>  </span><span class="hs-comment">-- It's OK to use nonDetFoldUDFM here because we forget the ordering</span><span>
</span><a name="line-1929"></a><span>  </span><span class="hs-comment">-- immediately by converting to a nondeterministic set.</span><span>
</span><a name="line-1930"></a><span>
</span><a name="line-1931"></a><span class="hs-identifier">callInfoFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-1932"></a><a name="callInfoFVs"><a href="Specialise.html#callInfoFVs"><span class="hs-identifier">callInfoFVs</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680525586"><a href="#local-6989586621680525586"><span class="hs-identifier">call_info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1933"></a><span>  </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_fvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525587"><a href="#local-6989586621680525587"><span class="hs-identifier">fv</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680525588"><a href="#local-6989586621680525588"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">unionVarSet</span><span> </span><a href="#local-6989586621680525587"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621680525588"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621680525586"><span class="hs-identifier hs-var">call_info</span></a><span>
</span><a name="line-1934"></a><span>
</span><a name="line-1935"></a><span class="hs-comment">------------------------------------------------------------</span><span>
</span><a name="line-1936"></a><span class="hs-identifier">singleCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#DictExpr"><span class="hs-identifier hs-type">DictExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-1937"></a><a name="singleCall"><a href="Specialise.html#singleCall"><span class="hs-identifier">singleCall</span></a></a><span> </span><a name="local-6989586621680525589"><a href="#local-6989586621680525589"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680525590"><a href="#local-6989586621680525590"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621680525591"><a href="#local-6989586621680525591"><span class="hs-identifier">dicts</span></a></a><span>
</span><a name="line-1938"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span>
</span><a name="line-1939"></a><span>          </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitDVarEnv</span><span> </span><a href="#local-6989586621680525589"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a href="#local-6989586621680525589"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1940"></a><span>                     </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_key</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#CallKey"><span class="hs-identifier hs-var">CallKey</span></a><span> </span><a href="#local-6989586621680525590"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1941"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ci_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525591"><span class="hs-identifier hs-var">dicts</span></a><span>
</span><a name="line-1942"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ci_fvs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525592"><span class="hs-identifier hs-var">call_fvs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1943"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1944"></a><span>    </span><a name="local-6989586621680525592"><a href="#local-6989586621680525592"><span class="hs-identifier">call_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprsFreeVars</span><span> </span><a href="#local-6989586621680525591"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525593"><span class="hs-identifier hs-var">tys_fvs</span></a><span>
</span><a name="line-1945"></a><span>    </span><a name="local-6989586621680525593"><a href="#local-6989586621680525593"><span class="hs-identifier">tys_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621680525590"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1946"></a><span>        </span><span class="hs-comment">-- The type args (tys) are guaranteed to be part of the dictionary</span><span>
</span><a name="line-1947"></a><span>        </span><span class="hs-comment">-- types, because they are just the constrained types,</span><span>
</span><a name="line-1948"></a><span>        </span><span class="hs-comment">-- and the dictionary is therefore sure to be bound</span><span>
</span><a name="line-1949"></a><span>        </span><span class="hs-comment">-- inside the binding for any type variables free in the type;</span><span>
</span><a name="line-1950"></a><span>        </span><span class="hs-comment">-- hence it's safe to neglect tyvars free in tys when making</span><span>
</span><a name="line-1951"></a><span>        </span><span class="hs-comment">-- the free-var set for this call</span><span>
</span><a name="line-1952"></a><span>        </span><span class="hs-comment">-- BUT I don't trust this reasoning; play safe and include tys_fvs</span><span>
</span><a name="line-1953"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1954"></a><span>        </span><span class="hs-comment">-- We don't include the 'id' itself.</span><span>
</span><a name="line-1955"></a><span>
</span><a name="line-1956"></a><span class="hs-identifier">mkCallUDs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkCallUDs'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-1957"></a><a name="mkCallUDs"><a href="Specialise.html#mkCallUDs"><span class="hs-identifier">mkCallUDs</span></a></a><span> </span><a name="local-6989586621680525594"><a href="#local-6989586621680525594"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525595"><a href="#local-6989586621680525595"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680525596"><a href="#local-6989586621680525596"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1958"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkCallUDs&quot; (vcat [ ppr f, ppr args, ppr res ])</span><span>
</span><a name="line-1959"></a><span>    </span><a href="#local-6989586621680525597"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1960"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1961"></a><span>    </span><a name="local-6989586621680525597"><a href="#local-6989586621680525597"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#mkCallUDs%27"><span class="hs-identifier hs-var">mkCallUDs'</span></a><span> </span><a href="#local-6989586621680525594"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525595"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680525596"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1962"></a><span>
</span><a name="line-1963"></a><a name="mkCallUDs%27"><a href="Specialise.html#mkCallUDs%27"><span class="hs-identifier">mkCallUDs'</span></a></a><span> </span><a name="local-6989586621680525598"><a href="#local-6989586621680525598"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525599"><a href="#local-6989586621680525599"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680525600"><a href="#local-6989586621680525600"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1964"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525611"><span class="hs-identifier hs-var">want_calls_for</span></a><span> </span><a href="#local-6989586621680525599"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Imported from elsewhere</span><span>
</span><a name="line-1965"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525603"><span class="hs-identifier hs-var">theta</span></a><span>             </span><span class="hs-comment">-- Not overloaded</span><span>
</span><a name="line-1966"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span>
</span><a name="line-1967"></a><span>
</span><a name="line-1968"></a><span>  </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621680525612"><span class="hs-identifier hs-var">type_determines_value</span></a><span> </span><a href="#local-6989586621680525603"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1969"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525607"><span class="hs-identifier hs-var">spec_tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525605"><span class="hs-identifier hs-var">n_tyvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1970"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680525608"><span class="hs-identifier hs-var">dicts</span></a><span>   </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525606"><span class="hs-identifier hs-var">n_dicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1971"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525598"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525608"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Note [Interesting dictionary arguments]</span><span>
</span><a name="line-1972"></a><span>  </span><span class="hs-comment">-- See also Note [Specialisations already covered]</span><span>
</span><a name="line-1973"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkCallUDs: discarding&quot; _trace_doc</span><span>
</span><a name="line-1974"></a><span>    </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span>    </span><span class="hs-comment">-- Not overloaded, or no specialisation wanted</span><span>
</span><a name="line-1975"></a><span>
</span><a name="line-1976"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1977"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;mkCallUDs: keeping&quot; _trace_doc</span><span>
</span><a name="line-1978"></a><span>    </span><a href="Specialise.html#singleCall"><span class="hs-identifier hs-var">singleCall</span></a><span> </span><a href="#local-6989586621680525599"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680525607"><span class="hs-identifier hs-var">spec_tys</span></a><span> </span><a href="#local-6989586621680525608"><span class="hs-identifier hs-var">dicts</span></a><span>
</span><a name="line-1979"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1980"></a><span>    </span><a name="local-6989586621680525601"><a href="#local-6989586621680525601"><span class="hs-identifier">_trace_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525599"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525600"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525605"><span class="hs-identifier hs-var">n_tyvars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680525606"><span class="hs-identifier hs-var">n_dicts</span></a><span>
</span><a name="line-1981"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525598"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525608"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1982"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525602"><a href="#local-6989586621680525602"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525603"><a href="#local-6989586621680525603"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680525599"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1983"></a><span>    </span><a name="local-6989586621680525604"><a href="#local-6989586621680525604"><span class="hs-identifier">constrained_tyvars</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621680525603"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1984"></a><span>    </span><a name="local-6989586621680525605"><a href="#local-6989586621680525605"><span class="hs-identifier">n_tyvars</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525602"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-1985"></a><span>    </span><a name="local-6989586621680525606"><a href="#local-6989586621680525606"><span class="hs-identifier">n_dicts</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680525603"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1986"></a><span>
</span><a name="line-1987"></a><span>    </span><a name="local-6989586621680525607"><a href="#local-6989586621680525607"><span class="hs-identifier">spec_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680525610"><span class="hs-identifier hs-var">mk_spec_ty</span></a><span> </span><a href="#local-6989586621680525613"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621680525614"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525613"><a href="#local-6989586621680525613"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525614"><a href="#local-6989586621680525614"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525602"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621680525609"><span class="hs-identifier hs-var">type_zip</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525600"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">]</span><span>
</span><a name="line-1988"></a><span>    </span><a name="local-6989586621680525608"><a href="#local-6989586621680525608"><span class="hs-identifier">dicts</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680525615"><span class="hs-identifier hs-var">dict_expr</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680525615"><a href="#local-6989586621680525615"><span class="hs-identifier">dict_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525603"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621680525605"><span class="hs-identifier hs-var">n_tyvars</span></a><span> </span><a href="#local-6989586621680525600"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1989"></a><span>
</span><a name="line-1990"></a><span>    </span><span class="hs-comment">-- ignores Coercion arguments</span><span>
</span><a name="line-1991"></a><span>    </span><span class="hs-identifier">type_zip</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1992"></a><span>    </span><a name="local-6989586621680525609"><a href="#local-6989586621680525609"><span class="hs-identifier">type_zip</span></a></a><span> </span><a name="local-6989586621680525616"><a href="#local-6989586621680525616"><span class="hs-identifier">tvs</span></a></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525617"><a href="#local-6989586621680525617"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525609"><span class="hs-identifier hs-var">type_zip</span></a><span> </span><a href="#local-6989586621680525616"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680525617"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1993"></a><span>    </span><span class="hs-identifier">type_zip</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525618"><a href="#local-6989586621680525618"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680525619"><a href="#local-6989586621680525619"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621680525620"><a href="#local-6989586621680525620"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680525621"><a href="#local-6989586621680525621"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525618"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525620"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525609"><span class="hs-identifier hs-var">type_zip</span></a><span> </span><a href="#local-6989586621680525619"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680525621"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1994"></a><span>    </span><span class="hs-identifier">type_zip</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1995"></a><span>
</span><a name="line-1996"></a><span>    </span><a name="local-6989586621680525610"><a href="#local-6989586621680525610"><span class="hs-identifier">mk_spec_ty</span></a></a><span> </span><a name="local-6989586621680525622"><a href="#local-6989586621680525622"><span class="hs-identifier">tyvar</span></a></a><span> </span><a name="local-6989586621680525623"><a href="#local-6989586621680525623"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1997"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680525622"><span class="hs-identifier hs-var">tyvar</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525604"><span class="hs-identifier hs-var">constrained_tyvars</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680525623"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1998"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1999"></a><span>
</span><a name="line-2000"></a><span>    </span><a name="local-6989586621680525611"><a href="#local-6989586621680525611"><span class="hs-identifier">want_calls_for</span></a></a><span> </span><a name="local-6989586621680525624"><a href="#local-6989586621680525624"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621680525624"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621680525624"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2001"></a><span>         </span><span class="hs-comment">-- For imported things, we gather call instances if</span><span>
</span><a name="line-2002"></a><span>         </span><span class="hs-comment">-- there is an unfolding that we could in principle specialise</span><span>
</span><a name="line-2003"></a><span>         </span><span class="hs-comment">-- We might still decide not to use it (consulting dflags)</span><span>
</span><a name="line-2004"></a><span>         </span><span class="hs-comment">-- in specImports</span><span>
</span><a name="line-2005"></a><span>         </span><span class="hs-comment">-- Use 'realIdUnfolding' to ignore the loop-breaker flag!</span><span>
</span><a name="line-2006"></a><span>
</span><a name="line-2007"></a><span>    </span><a name="local-6989586621680525612"><a href="#local-6989586621680525612"><span class="hs-identifier">type_determines_value</span></a></a><span> </span><a name="local-6989586621680525625"><a href="#local-6989586621680525625"><span class="hs-identifier">pred</span></a></a><span>    </span><span class="hs-comment">-- See Note [Type determines value]</span><span>
</span><a name="line-2008"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><a href="#local-6989586621680525625"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2009"></a><span>            </span><span class="hs-identifier hs-var">ClassPred</span><span> </span><a name="local-6989586621680525626"><a href="#local-6989586621680525626"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isIPClass</span><span> </span><a href="#local-6989586621680525626"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Superclasses can't be IPs</span><span>
</span><a name="line-2010"></a><span>            </span><span class="hs-identifier hs-var">EqPred</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2011"></a><span>            </span><span class="hs-identifier hs-var">IrredPred</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- Things like (D []) where D is a</span><span>
</span><a name="line-2012"></a><span>                                      </span><span class="hs-comment">-- Constraint-ranged family; Trac #7785</span><span>
</span><a name="line-2013"></a><span>            </span><span class="hs-identifier hs-var">ForAllPred</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2014"></a><span>
</span><a name="line-2015"></a><span class="hs-comment">{-
Note [Type determines value]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Only specialise if all overloading is on non-IP *class* params,
because these are the ones whose *type* determines their *value*.  In
parrticular, with implicit params, the type args *don't* say what the
value of the implicit param is!  See Trac #7101

However, consider
         type family D (v::*-&gt;*) :: Constraint
         type instance D [] = ()
         f :: D v =&gt; v Char -&gt; Int
If we see a call (f &quot;foo&quot;), we'll pass a &quot;dictionary&quot;
  () |&gt; (g :: () ~ D [])
and it's good to specialise f at this dictionary.

So the question is: can an implicit parameter &quot;hide inside&quot; a
type-family constraint like (D a).  Well, no.  We don't allow
        type instance D Maybe = ?x:Int
Hence the IrredPred case in type_determines_value.
See Trac #7785.

Note [Interesting dictionary arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
         \a.\d:Eq a.  let f = ... in ...(f d)...
There really is not much point in specialising f wrt the dictionary d,
because the code for the specialised f is not improved at all, because
d is lambda-bound.  We simply get junk specialisations.

What is &quot;interesting&quot;?  Just that it has *some* structure.  But what about
variables?

 * A variable might be imported, in which case its unfolding
   will tell us whether it has useful structure

 * Local variables are cloned on the way down (to avoid clashes when
   we float dictionaries), and cloning drops the unfolding
   (cloneIdBndr).  Moreover, we make up some new bindings, and it's a
   nuisance to give them unfoldings.  So we keep track of the
   &quot;interesting&quot; dictionaries as a VarSet in SpecEnv.
   We have to take care to put any new interesting dictionary
   bindings in the set.

We accidentally lost accurate tracking of local variables for a long
time, because cloned variables don't have unfoldings. But makes a
massive difference in a few cases, eg Trac #5113. For nofib as a
whole it's only a small win: 2.2% improvement in allocation for ansi,
1.2% for bspt, but mostly 0.0!  Average 0.1% increase in binary size.
-}</span><span>
</span><a name="line-2065"></a><span>
</span><a name="line-2066"></a><span class="hs-identifier">interestingDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2067"></a><span class="hs-comment">-- A dictionary argument is interesting if it has *some* structure</span><span>
</span><a name="line-2068"></a><span class="hs-comment">-- NB: &quot;dictionary&quot; arguments include constraints of all sorts,</span><span>
</span><a name="line-2069"></a><span class="hs-comment">--     including equality constraints; hence the Coercion case</span><span>
</span><a name="line-2070"></a><a name="interestingDict"><a href="Specialise.html#interestingDict"><span class="hs-identifier">interestingDict</span></a></a><span> </span><a name="local-6989586621680525627"><a href="#local-6989586621680525627"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621680525628"><a href="#local-6989586621680525628"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">hasSomeUnfolding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680525628"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-2071"></a><span>                            </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId</span><span> </span><a href="#local-6989586621680525628"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-2072"></a><span>                            </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680525628"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><a href="#local-6989586621680525627"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2073"></a><span class="hs-identifier">interestingDict</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2074"></a><span class="hs-identifier">interestingDict</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2075"></a><span class="hs-identifier">interestingDict</span><span> </span><a name="local-6989586621680525629"><a href="#local-6989586621680525629"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621680525630"><a href="#local-6989586621680525630"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525629"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525630"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-2076"></a><span class="hs-identifier">interestingDict</span><span> </span><a name="local-6989586621680525631"><a href="#local-6989586621680525631"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621680525632"><a href="#local-6989586621680525632"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525631"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525632"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-2077"></a><span class="hs-identifier">interestingDict</span><span> </span><a name="local-6989586621680525633"><a href="#local-6989586621680525633"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680525634"><a href="#local-6989586621680525634"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525633"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525634"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-2078"></a><span class="hs-identifier">interestingDict</span><span> </span><a name="local-6989586621680525635"><a href="#local-6989586621680525635"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621680525636"><a href="#local-6989586621680525636"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525635"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525636"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2079"></a><span class="hs-identifier">interestingDict</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2080"></a><span>
</span><a name="line-2081"></a><span class="hs-identifier">plusUDs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2082"></a><a name="plusUDs"><a href="Specialise.html#plusUDs"><span class="hs-identifier">plusUDs</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525637"><a href="#local-6989586621680525637"><span class="hs-identifier">db1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525638"><a href="#local-6989586621680525638"><span class="hs-identifier">calls1</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2083"></a><span>        </span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525639"><a href="#local-6989586621680525639"><span class="hs-identifier">db2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525640"><a href="#local-6989586621680525640"><span class="hs-identifier">calls2</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2084"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525637"><span class="hs-identifier hs-var">db1</span></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span>   </span><a href="#local-6989586621680525639"><span class="hs-identifier hs-var">db2</span></a><span>
</span><a name="line-2085"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525638"><span class="hs-identifier hs-var">calls1</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#unionCalls"><span class="hs-identifier hs-var">unionCalls</span></a><span class="hs-special">`</span><span>  </span><a href="#local-6989586621680525640"><span class="hs-identifier hs-var">calls2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2086"></a><span>
</span><a name="line-2087"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-2088"></a><span class="hs-identifier">_dictBindBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-2089"></a><a name="_dictBindBndrs"><a href="Specialise.html#_dictBindBndrs"><span class="hs-identifier">_dictBindBndrs</span></a></a><span> </span><a name="local-6989586621680525641"><a href="#local-6989586621680525641"><span class="hs-identifier">dbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">bindersOf</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680525641"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-2090"></a><span>
</span><a name="line-2091"></a><span class="hs-comment">-- | Construct a 'DictBind' from a 'CoreBind'</span><span>
</span><a name="line-2092"></a><span class="hs-identifier">mkDB</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span>
</span><a name="line-2093"></a><a name="mkDB"><a href="Specialise.html#mkDB"><span class="hs-identifier">mkDB</span></a></a><span> </span><a name="local-6989586621680525642"><a href="#local-6989586621680525642"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525642"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#bind_fvs"><span class="hs-identifier hs-var">bind_fvs</span></a><span> </span><a href="#local-6989586621680525642"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-2094"></a><span>
</span><a name="line-2095"></a><span class="hs-comment">-- | Identify the free variables of a 'CoreBind'</span><span>
</span><a name="line-2096"></a><span class="hs-identifier">bind_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-2097"></a><a name="bind_fvs"><a href="Specialise.html#bind_fvs"><span class="hs-identifier">bind_fvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680525643"><a href="#local-6989586621680525643"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680525644"><a href="#local-6989586621680525644"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#pair_fvs"><span class="hs-identifier hs-var">pair_fvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525643"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><a href="#local-6989586621680525644"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2098"></a><span class="hs-identifier">bind_fvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621680525645"><a href="#local-6989586621680525645"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-identifier hs-var">delVarSet</span><span> </span><a href="#local-6989586621680525647"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><a href="#local-6989586621680525646"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2099"></a><span>                           </span><span class="hs-keyword">where</span><span>
</span><a name="line-2100"></a><span>                             </span><a name="local-6989586621680525646"><a href="#local-6989586621680525646"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621680525645"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-2101"></a><span>                             </span><a name="local-6989586621680525647"><a href="#local-6989586621680525647"><span class="hs-identifier">rhs_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionVarSets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Specialise.html#pair_fvs"><span class="hs-identifier hs-var">pair_fvs</span></a><span> </span><a href="#local-6989586621680525645"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2102"></a><span>
</span><a name="line-2103"></a><span class="hs-identifier">pair_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-2104"></a><a name="pair_fvs"><a href="Specialise.html#pair_fvs"><span class="hs-identifier">pair_fvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525648"><a href="#local-6989586621680525648"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525649"><a href="#local-6989586621680525649"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprSomeFreeVars</span><span> </span><a href="#local-6989586621680525650"><span class="hs-identifier hs-var">interesting</span></a><span> </span><a href="#local-6989586621680525649"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2105"></a><span>                       </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">idFreeVars</span><span> </span><a href="#local-6989586621680525648"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2106"></a><span>        </span><span class="hs-comment">-- idFreeVars: don't forget variables mentioned in</span><span>
</span><a name="line-2107"></a><span>        </span><span class="hs-comment">-- the rules of the bndr.  C.f. OccAnal.addRuleUsage</span><span>
</span><a name="line-2108"></a><span>        </span><span class="hs-comment">-- Also tyvars mentioned in its type; they may not appear</span><span>
</span><a name="line-2109"></a><span>        </span><span class="hs-comment">-- in the RHS</span><span>
</span><a name="line-2110"></a><span>        </span><span class="hs-comment">--      type T a = Int</span><span>
</span><a name="line-2111"></a><span>        </span><span class="hs-comment">--      x :: T a = 3</span><span>
</span><a name="line-2112"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2113"></a><span>    </span><span class="hs-identifier">interesting</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InterestingVarFun</span><span>
</span><a name="line-2114"></a><span>    </span><a name="local-6989586621680525650"><a href="#local-6989586621680525650"><span class="hs-identifier">interesting</span></a></a><span> </span><a name="local-6989586621680525651"><a href="#local-6989586621680525651"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isLocalVar</span><span> </span><a href="#local-6989586621680525651"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621680525651"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isDFunId</span><span> </span><a href="#local-6989586621680525651"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-2115"></a><span>        </span><span class="hs-comment">-- Very important: include DFunIds /even/ if it is imported</span><span>
</span><a name="line-2116"></a><span>        </span><span class="hs-comment">-- Reason: See Note [Avoiding loops], the second exmaple</span><span>
</span><a name="line-2117"></a><span>        </span><span class="hs-comment">--         involving an imported dfun.  We must know whether</span><span>
</span><a name="line-2118"></a><span>        </span><span class="hs-comment">--         a dictionary binding depends on an imported dfun,</span><span>
</span><a name="line-2119"></a><span>        </span><span class="hs-comment">--         in case we try to specialise that imported dfun</span><span>
</span><a name="line-2120"></a><span>        </span><span class="hs-comment">--         Trac #13429 illustrates</span><span>
</span><a name="line-2121"></a><span>
</span><a name="line-2122"></a><span class="hs-comment">-- | Flatten a set of &quot;dumped&quot; 'DictBind's, and some other binding</span><span>
</span><a name="line-2123"></a><span class="hs-comment">-- pairs, into a single recursive binding.</span><span>
</span><a name="line-2124"></a><span class="hs-identifier">recWithDumpedDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span>
</span><a name="line-2125"></a><a name="recWithDumpedDicts"><a href="Specialise.html#recWithDumpedDicts"><span class="hs-identifier">recWithDumpedDicts</span></a></a><span> </span><a name="local-6989586621680525652"><a href="#local-6989586621680525652"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621680525653"><a href="#local-6989586621680525653"><span class="hs-identifier">dbs</span></a></a><span>
</span><a name="line-2126"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621680525654"><span class="hs-identifier hs-var">bindings</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525655"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2127"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2128"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525654"><a href="#local-6989586621680525654"><span class="hs-identifier">bindings</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525655"><a href="#local-6989586621680525655"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="#local-6989586621680525656"><span class="hs-identifier hs-var">add</span></a><span>
</span><a name="line-2129"></a><span>                               </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span class="hs-special">)</span><span>
</span><a name="line-2130"></a><span>                               </span><span class="hs-special">(</span><a href="#local-6989586621680525653"><span class="hs-identifier hs-var">dbs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="Specialise.html#mkDB"><span class="hs-identifier hs-var">mkDB</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621680525652"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2131"></a><span>    </span><a name="local-6989586621680525656"><a href="#local-6989586621680525656"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680525657"><a href="#local-6989586621680525657"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680525658"><a href="#local-6989586621680525658"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525659"><a href="#local-6989586621680525659"><span class="hs-identifier">fvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525660"><a href="#local-6989586621680525660"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525661"><a href="#local-6989586621680525661"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2132"></a><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621680525657"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621680525658"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525660"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525661"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525659"><span class="hs-identifier hs-var">fvs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2133"></a><span>    </span><span class="hs-identifier">add</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621680525662"><a href="#local-6989586621680525662"><span class="hs-identifier">prs1</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621680525663"><a href="#local-6989586621680525663"><span class="hs-identifier">fvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525664"><a href="#local-6989586621680525664"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525665"><a href="#local-6989586621680525665"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2134"></a><span>      </span><span class="hs-special">(</span><a href="#local-6989586621680525662"><span class="hs-identifier hs-var">prs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680525664"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525665"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525663"><span class="hs-identifier hs-var">fvs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2135"></a><span>
</span><a name="line-2136"></a><span class="hs-identifier">snocDictBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2137"></a><span class="hs-comment">-- Add ud_binds to the tail end of the bindings in uds</span><span>
</span><a name="line-2138"></a><a name="snocDictBinds"><a href="Specialise.html#snocDictBinds"><span class="hs-identifier">snocDictBinds</span></a></a><span> </span><a name="local-6989586621680525666"><a href="#local-6989586621680525666"><span class="hs-identifier">uds</span></a></a><span> </span><a name="local-6989586621680525667"><a href="#local-6989586621680525667"><span class="hs-identifier">dbs</span></a></a><span>
</span><a name="line-2139"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525666"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><a href="#local-6989586621680525666"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621680525667"><span class="hs-identifier hs-var">dbs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2140"></a><span>
</span><a name="line-2141"></a><span class="hs-identifier">consDictBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2142"></a><a name="consDictBind"><a href="Specialise.html#consDictBind"><span class="hs-identifier">consDictBind</span></a></a><span> </span><a name="local-6989586621680525668"><a href="#local-6989586621680525668"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621680525669"><a href="#local-6989586621680525669"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525669"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525668"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consBag</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><a href="#local-6989586621680525669"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2143"></a><span>
</span><a name="line-2144"></a><span class="hs-identifier">addDictBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2145"></a><a name="addDictBinds"><a href="Specialise.html#addDictBinds"><span class="hs-identifier">addDictBinds</span></a></a><span> </span><a name="local-6989586621680525670"><a href="#local-6989586621680525670"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621680525671"><a href="#local-6989586621680525671"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525671"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621680525670"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><a href="#local-6989586621680525671"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2146"></a><span>
</span><a name="line-2147"></a><span class="hs-identifier">snocDictBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2148"></a><a name="snocDictBind"><a href="Specialise.html#snocDictBind"><span class="hs-identifier">snocDictBind</span></a></a><span> </span><a name="local-6989586621680525672"><a href="#local-6989586621680525672"><span class="hs-identifier">uds</span></a></a><span> </span><a name="local-6989586621680525673"><a href="#local-6989586621680525673"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525672"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><a href="#local-6989586621680525672"><span class="hs-identifier hs-var">uds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525673"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2149"></a><span>
</span><a name="line-2150"></a><span class="hs-identifier">wrapDictBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-2151"></a><a name="wrapDictBinds"><a href="Specialise.html#wrapDictBinds"><span class="hs-identifier">wrapDictBinds</span></a></a><span> </span><a name="local-6989586621680525674"><a href="#local-6989586621680525674"><span class="hs-identifier">dbs</span></a></a><span> </span><a name="local-6989586621680525675"><a href="#local-6989586621680525675"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-2152"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="#local-6989586621680525676"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680525675"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621680525674"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-2153"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2154"></a><span>    </span><a name="local-6989586621680525676"><a href="#local-6989586621680525676"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525677"><a href="#local-6989586621680525677"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680525678"><a href="#local-6989586621680525678"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525677"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680525678"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-2155"></a><span>
</span><a name="line-2156"></a><span class="hs-identifier">wrapDictBindsE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-2157"></a><a name="wrapDictBindsE"><a href="Specialise.html#wrapDictBindsE"><span class="hs-identifier">wrapDictBindsE</span></a></a><span> </span><a name="local-6989586621680525679"><a href="#local-6989586621680525679"><span class="hs-identifier">dbs</span></a></a><span> </span><a name="local-6989586621680525680"><a href="#local-6989586621680525680"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2158"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="#local-6989586621680525681"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680525680"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621680525679"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-2159"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2160"></a><span>    </span><a name="local-6989586621680525681"><a href="#local-6989586621680525681"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525682"><a href="#local-6989586621680525682"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680525683"><a href="#local-6989586621680525683"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621680525682"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621680525683"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-2161"></a><span>
</span><a name="line-2162"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-2163"></a><span class="hs-identifier">dumpUDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-2164"></a><span class="hs-comment">-- Used at a lambda or case binder; just dump anything mentioning the binder</span><span>
</span><a name="line-2165"></a><a name="dumpUDs"><a href="Specialise.html#dumpUDs"><span class="hs-identifier">dumpUDs</span></a></a><span> </span><a name="local-6989586621680525684"><a href="#local-6989586621680525684"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621680525685"><a href="#local-6989586621680525685"><span class="hs-identifier">uds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525686"><a href="#local-6989586621680525686"><span class="hs-identifier">orig_dbs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525687"><a href="#local-6989586621680525687"><span class="hs-identifier">orig_calls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2166"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680525684"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525685"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Common in case alternatives</span><span>
</span><a name="line-2167"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dumpUDs&quot; (ppr bndrs $$ ppr free_uds $$ ppr dump_dbs) $</span><span>
</span><a name="line-2168"></a><span>                 </span><span class="hs-special">(</span><a href="#local-6989586621680525688"><span class="hs-identifier hs-var">free_uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525691"><span class="hs-identifier hs-var">dump_dbs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2169"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2170"></a><span>    </span><a name="local-6989586621680525688"><a href="#local-6989586621680525688"><span class="hs-identifier">free_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525690"><span class="hs-identifier hs-var">free_dbs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525693"><span class="hs-identifier hs-var">free_calls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2171"></a><span>    </span><a name="local-6989586621680525689"><a href="#local-6989586621680525689"><span class="hs-identifier">bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621680525684"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2172"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525690"><a href="#local-6989586621680525690"><span class="hs-identifier">free_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525691"><a href="#local-6989586621680525691"><span class="hs-identifier">dump_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525692"><a href="#local-6989586621680525692"><span class="hs-identifier">dump_set</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#splitDictBinds"><span class="hs-identifier hs-var">splitDictBinds</span></a><span> </span><a href="#local-6989586621680525686"><span class="hs-identifier hs-var">orig_dbs</span></a><span> </span><a href="#local-6989586621680525689"><span class="hs-identifier hs-var">bndr_set</span></a><span>
</span><a name="line-2173"></a><span>    </span><a name="local-6989586621680525693"><a href="#local-6989586621680525693"><span class="hs-identifier">free_calls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#deleteCallsMentioning"><span class="hs-identifier hs-var">deleteCallsMentioning</span></a><span> </span><a href="#local-6989586621680525692"><span class="hs-identifier hs-var">dump_set</span></a><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-comment">-- Drop calls mentioning bndr_set on the floor</span><span>
</span><a name="line-2174"></a><span>                 </span><a href="Specialise.html#deleteCallsFor"><span class="hs-identifier hs-var">deleteCallsFor</span></a><span> </span><a href="#local-6989586621680525684"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680525687"><span class="hs-identifier hs-var">orig_calls</span></a><span>    </span><span class="hs-comment">-- Discard calls for bndr_set; there should be</span><span>
</span><a name="line-2175"></a><span>                                                    </span><span class="hs-comment">-- no calls for any of the dicts in dump_dbs</span><span>
</span><a name="line-2176"></a><span>
</span><a name="line-2177"></a><span class="hs-identifier">dumpBindUDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-2178"></a><span class="hs-comment">-- Used at a let(rec) binding.</span><span>
</span><a name="line-2179"></a><span class="hs-comment">-- We return a boolean indicating whether the binding itself is mentioned,</span><span>
</span><a name="line-2180"></a><span class="hs-comment">-- directly or indirectly, by any of the ud_calls; in that case we want to</span><span>
</span><a name="line-2181"></a><span class="hs-comment">-- float the binding itself;</span><span>
</span><a name="line-2182"></a><span class="hs-comment">-- See Note [Floated dictionary bindings]</span><span>
</span><a name="line-2183"></a><a name="dumpBindUDs"><a href="Specialise.html#dumpBindUDs"><span class="hs-identifier">dumpBindUDs</span></a></a><span> </span><a name="local-6989586621680525694"><a href="#local-6989586621680525694"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525695"><a href="#local-6989586621680525695"><span class="hs-identifier">orig_dbs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525696"><a href="#local-6989586621680525696"><span class="hs-identifier">orig_calls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2184"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dumpBindUDs&quot; (ppr bndrs $$ ppr free_uds $$ ppr dump_dbs) $</span><span>
</span><a name="line-2185"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621680525697"><span class="hs-identifier hs-var">free_uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525700"><span class="hs-identifier hs-var">dump_dbs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525703"><span class="hs-identifier hs-var">float_all</span></a><span class="hs-special">)</span><span>
</span><a name="line-2186"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2187"></a><span>    </span><a name="local-6989586621680525697"><a href="#local-6989586621680525697"><span class="hs-identifier">free_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525699"><span class="hs-identifier hs-var">free_dbs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525702"><span class="hs-identifier hs-var">free_calls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2188"></a><span>    </span><a name="local-6989586621680525698"><a href="#local-6989586621680525698"><span class="hs-identifier">bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621680525694"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2189"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680525699"><a href="#local-6989586621680525699"><span class="hs-identifier">free_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525700"><a href="#local-6989586621680525700"><span class="hs-identifier">dump_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525701"><a href="#local-6989586621680525701"><span class="hs-identifier">dump_set</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#splitDictBinds"><span class="hs-identifier hs-var">splitDictBinds</span></a><span> </span><a href="#local-6989586621680525695"><span class="hs-identifier hs-var">orig_dbs</span></a><span> </span><a href="#local-6989586621680525698"><span class="hs-identifier hs-var">bndr_set</span></a><span>
</span><a name="line-2190"></a><span>    </span><a name="local-6989586621680525702"><a href="#local-6989586621680525702"><span class="hs-identifier">free_calls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#deleteCallsFor"><span class="hs-identifier hs-var">deleteCallsFor</span></a><span> </span><a href="#local-6989586621680525694"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621680525696"><span class="hs-identifier hs-var">orig_calls</span></a><span>
</span><a name="line-2191"></a><span>    </span><a name="local-6989586621680525703"><a href="#local-6989586621680525703"><span class="hs-identifier">float_all</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525701"><span class="hs-identifier hs-var">dump_set</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="Specialise.html#callDetailsFVs"><span class="hs-identifier hs-var">callDetailsFVs</span></a><span> </span><a href="#local-6989586621680525702"><span class="hs-identifier hs-var">free_calls</span></a><span>
</span><a name="line-2192"></a><span>
</span><a name="line-2193"></a><span class="hs-identifier">callsForMe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2194"></a><a name="callsForMe"><a href="Specialise.html#callsForMe"><span class="hs-identifier">callsForMe</span></a></a><span> </span><a name="local-6989586621680525704"><a href="#local-6989586621680525704"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525705"><a href="#local-6989586621680525705"><span class="hs-identifier">orig_dbs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525706"><a href="#local-6989586621680525706"><span class="hs-identifier">orig_calls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace (&quot;callsForMe&quot;)</span><span>
</span><a name="line-2196"></a><span>    </span><span class="hs-comment">--          (vcat [ppr fn,</span><span>
</span><a name="line-2197"></a><span>    </span><span class="hs-comment">--                 text &quot;Orig dbs =&quot;     &lt;+&gt; ppr (_dictBindBndrs orig_dbs),</span><span>
</span><a name="line-2198"></a><span>    </span><span class="hs-comment">--                 text &quot;Orig calls =&quot;   &lt;+&gt; ppr orig_calls,</span><span>
</span><a name="line-2199"></a><span>    </span><span class="hs-comment">--                 text &quot;Dep set =&quot;      &lt;+&gt; ppr dep_set,</span><span>
</span><a name="line-2200"></a><span>    </span><span class="hs-comment">--                 text &quot;Calls for me =&quot; &lt;+&gt; ppr calls_for_me]) $</span><span>
</span><a name="line-2201"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621680525707"><span class="hs-identifier hs-var">uds_without_me</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525708"><span class="hs-identifier hs-var">calls_for_me</span></a><span class="hs-special">)</span><span>
</span><a name="line-2202"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2203"></a><span>    </span><a name="local-6989586621680525707"><a href="#local-6989586621680525707"><span class="hs-identifier">uds_without_me</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#MkUD"><span class="hs-identifier hs-var">MkUD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525705"><span class="hs-identifier hs-var">orig_dbs</span></a><span>
</span><a name="line-2204"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_calls</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delDVarEnv</span><span> </span><a href="#local-6989586621680525706"><span class="hs-identifier hs-var">orig_calls</span></a><span> </span><a href="#local-6989586621680525704"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2205"></a><span>    </span><a name="local-6989586621680525708"><a href="#local-6989586621680525708"><span class="hs-identifier">calls_for_me</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupDVarEnv</span><span> </span><a href="#local-6989586621680525706"><span class="hs-identifier hs-var">orig_calls</span></a><span> </span><a href="#local-6989586621680525704"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2206"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2207"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680525709"><a href="#local-6989586621680525709"><span class="hs-identifier">cis</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#filterCalls"><span class="hs-identifier hs-var">filterCalls</span></a><span> </span><a href="#local-6989586621680525709"><span class="hs-identifier hs-var">cis</span></a><span> </span><a href="#local-6989586621680525705"><span class="hs-identifier hs-var">orig_dbs</span></a><span>
</span><a name="line-2208"></a><span>         </span><span class="hs-comment">-- filterCalls: drop calls that (directly or indirectly)</span><span>
</span><a name="line-2209"></a><span>         </span><span class="hs-comment">-- refer to fn.  See Note [Avoiding loops]</span><span>
</span><a name="line-2210"></a><span>
</span><a name="line-2211"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-2212"></a><span class="hs-identifier">filterCalls</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#CallInfoSet"><span class="hs-identifier hs-type">CallInfoSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Specialise.html#CallInfo"><span class="hs-identifier hs-type">CallInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-2213"></a><span class="hs-comment">-- See Note [Avoiding loops]</span><span>
</span><a name="line-2214"></a><a name="filterCalls"><a href="Specialise.html#filterCalls"><span class="hs-identifier">filterCalls</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CIS"><span class="hs-identifier hs-var">CIS</span></a><span> </span><a name="local-6989586621680525710"><a href="#local-6989586621680525710"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680525711"><a href="#local-6989586621680525711"><span class="hs-identifier">call_bag</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680525712"><a href="#local-6989586621680525712"><span class="hs-identifier">dbs</span></a></a><span>
</span><a name="line-2215"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621680525715"><span class="hs-identifier hs-var">ok_call</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621680525711"><span class="hs-identifier hs-var">call_bag</span></a><span class="hs-special">)</span><span>
</span><a name="line-2216"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2217"></a><span>    </span><a name="local-6989586621680525713"><a href="#local-6989586621680525713"><span class="hs-identifier">dump_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlBag</span><span> </span><a href="#local-6989586621680525714"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitVarSet</span><span> </span><a href="#local-6989586621680525710"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525712"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-2218"></a><span>      </span><span class="hs-comment">-- This dump-set could also be computed by splitDictBinds</span><span>
</span><a name="line-2219"></a><span>      </span><span class="hs-comment">--   (_,_,dump_set) = splitDictBinds dbs {fn}</span><span>
</span><a name="line-2220"></a><span>      </span><span class="hs-comment">-- But this variant is shorter</span><span>
</span><a name="line-2221"></a><span>
</span><a name="line-2222"></a><span>    </span><a name="local-6989586621680525714"><a href="#local-6989586621680525714"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621680525716"><a href="#local-6989586621680525716"><span class="hs-identifier">so_far</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525717"><a href="#local-6989586621680525717"><span class="hs-identifier">db</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525718"><a href="#local-6989586621680525718"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680525718"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525716"><span class="hs-identifier hs-var">so_far</span></a><span>
</span><a name="line-2223"></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarSetList</span><span> </span><a href="#local-6989586621680525716"><span class="hs-identifier hs-var">so_far</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindersOf</span><span> </span><a href="#local-6989586621680525717"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">)</span><span>
</span><a name="line-2224"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525716"><span class="hs-identifier hs-var">so_far</span></a><span>
</span><a name="line-2225"></a><span>
</span><a name="line-2226"></a><span>    </span><a name="local-6989586621680525715"><a href="#local-6989586621680525715"><span class="hs-identifier">ok_call</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_fvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525719"><a href="#local-6989586621680525719"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525719"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525713"><span class="hs-identifier hs-var">dump_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-2227"></a><span>
</span><a name="line-2228"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-2229"></a><span class="hs-identifier">splitDictBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="Specialise.html#DictBind"><span class="hs-identifier hs-type">DictBind</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IdSet</span><span class="hs-special">)</span><span>
</span><a name="line-2230"></a><span class="hs-comment">-- splitDictBinds dbs bndrs returns</span><span>
</span><a name="line-2231"></a><span class="hs-comment">--   (free_dbs, dump_dbs, dump_set)</span><span>
</span><a name="line-2232"></a><span class="hs-comment">-- where</span><span>
</span><a name="line-2233"></a><span class="hs-comment">--   * dump_dbs depends, transitively on bndrs</span><span>
</span><a name="line-2234"></a><span class="hs-comment">--   * free_dbs does not depend on bndrs</span><span>
</span><a name="line-2235"></a><span class="hs-comment">--   * dump_set = bndrs `union` bndrs(dump_dbs)</span><span>
</span><a name="line-2236"></a><a name="splitDictBinds"><a href="Specialise.html#splitDictBinds"><span class="hs-identifier">splitDictBinds</span></a></a><span> </span><a name="local-6989586621680525720"><a href="#local-6989586621680525720"><span class="hs-identifier">dbs</span></a></a><span> </span><a name="local-6989586621680525721"><a href="#local-6989586621680525721"><span class="hs-identifier">bndr_set</span></a></a><span>
</span><a name="line-2237"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlBag</span><span> </span><a href="#local-6989586621680525722"><span class="hs-identifier hs-var">split_db</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525721"><span class="hs-identifier hs-var">bndr_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525720"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-2238"></a><span>                </span><span class="hs-comment">-- Important that it's foldl not foldr;</span><span>
</span><a name="line-2239"></a><span>                </span><span class="hs-comment">-- we're accumulating the set of dumped ids in dump_set</span><span>
</span><a name="line-2240"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-2241"></a><span>    </span><a name="local-6989586621680525722"><a href="#local-6989586621680525722"><span class="hs-identifier">split_db</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525723"><a href="#local-6989586621680525723"><span class="hs-identifier">free_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525724"><a href="#local-6989586621680525724"><span class="hs-identifier">dump_dbs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525725"><a href="#local-6989586621680525725"><span class="hs-identifier">dump_idset</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680525726"><a href="#local-6989586621680525726"><span class="hs-identifier">db</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621680525727"><a href="#local-6989586621680525727"><span class="hs-identifier">bind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525728"><a href="#local-6989586621680525728"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2242"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680525725"><span class="hs-identifier hs-var">dump_idset</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525728"><span class="hs-identifier hs-var">fvs</span></a><span>     </span><span class="hs-comment">-- Dump it</span><span>
</span><a name="line-2243"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525723"><span class="hs-identifier hs-var">free_dbs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525724"><span class="hs-identifier hs-var">dump_dbs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525726"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">,</span><span>
</span><a name="line-2244"></a><span>           </span><span class="hs-identifier hs-var">extendVarSetList</span><span> </span><a href="#local-6989586621680525725"><span class="hs-identifier hs-var">dump_idset</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindersOf</span><span> </span><a href="#local-6989586621680525727"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2245"></a><span>
</span><a name="line-2246"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-comment">-- Don't dump it</span><span>
</span><a name="line-2247"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525723"><span class="hs-identifier hs-var">free_dbs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525726"><span class="hs-identifier hs-var">db</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525724"><span class="hs-identifier hs-var">dump_dbs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525725"><span class="hs-identifier hs-var">dump_idset</span></a><span class="hs-special">)</span><span>
</span><a name="line-2248"></a><span>
</span><a name="line-2249"></a><span>
</span><a name="line-2250"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-2251"></a><span class="hs-identifier">deleteCallsMentioning</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span>
</span><a name="line-2252"></a><span class="hs-comment">-- Remove calls *mentioning* bs in any way</span><span>
</span><a name="line-2253"></a><a name="deleteCallsMentioning"><a href="Specialise.html#deleteCallsMentioning"><span class="hs-identifier">deleteCallsMentioning</span></a></a><span> </span><a name="local-6989586621680525729"><a href="#local-6989586621680525729"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621680525730"><a href="#local-6989586621680525730"><span class="hs-identifier">calls</span></a></a><span>
</span><a name="line-2254"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapDVarEnv</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#ciSetFilter"><span class="hs-identifier hs-var">ciSetFilter</span></a><span> </span><a href="#local-6989586621680525731"><span class="hs-identifier hs-var">keep_call</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525730"><span class="hs-identifier hs-var">calls</span></a><span>
</span><a name="line-2255"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2256"></a><span>    </span><a name="local-6989586621680525731"><a href="#local-6989586621680525731"><span class="hs-identifier">keep_call</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#CI"><span class="hs-identifier hs-var">CI</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ci_fvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525732"><a href="#local-6989586621680525732"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525732"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525729"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2257"></a><span>
</span><a name="line-2258"></a><span class="hs-identifier">deleteCallsFor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#CallDetails"><span class="hs-identifier hs-type">CallDetails</span></a><span>
</span><a name="line-2259"></a><span class="hs-comment">-- Remove calls *for* bs</span><span>
</span><a name="line-2260"></a><a name="deleteCallsFor"><a href="Specialise.html#deleteCallsFor"><span class="hs-identifier">deleteCallsFor</span></a></a><span> </span><a name="local-6989586621680525733"><a href="#local-6989586621680525733"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621680525734"><a href="#local-6989586621680525734"><span class="hs-identifier">calls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delDVarEnvList</span><span> </span><a href="#local-6989586621680525734"><span class="hs-identifier hs-var">calls</span></a><span> </span><a href="#local-6989586621680525733"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-2261"></a><span>
</span><a name="line-2262"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsubsection{Boring helper functions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2269"></a><span>
</span><a name="line-2270"></a><span class="hs-keyword">newtype</span><span> </span><a name="SpecM"><a href="Specialise.html#SpecM"><span class="hs-identifier">SpecM</span></a></a><span> </span><a name="local-6989586621680525176"><a href="#local-6989586621680525176"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SpecM"><a href="Specialise.html#SpecM"><span class="hs-identifier">SpecM</span></a></a><span> </span><span class="hs-special">(</span><a href="State.html#State"><span class="hs-identifier hs-type">State</span></a><span> </span><a href="Specialise.html#SpecState"><span class="hs-identifier hs-type">SpecState</span></a><span> </span><a href="#local-6989586621680525176"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2271"></a><span>
</span><a name="line-2272"></a><span class="hs-keyword">data</span><span> </span><a name="SpecState"><a href="Specialise.html#SpecState"><span class="hs-identifier">SpecState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SpecState"><a href="Specialise.html#SpecState"><span class="hs-identifier">SpecState</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2273"></a><span>                     </span><a name="spec_uniq_supply"><a href="Specialise.html#spec_uniq_supply"><span class="hs-identifier">spec_uniq_supply</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">,</span><span>
</span><a name="line-2274"></a><span>                     </span><a name="spec_module"><a href="Specialise.html#spec_module"><span class="hs-identifier">spec_module</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span>
</span><a name="line-2275"></a><span>                     </span><a name="spec_dflags"><a href="Specialise.html#spec_dflags"><span class="hs-identifier">spec_dflags</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-2276"></a><span>                 </span><span class="hs-special">}</span><span>
</span><a name="line-2277"></a><span>
</span><a name="line-2278"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2279"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-2280"></a><span>
</span><a name="line-2281"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2282"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621680525188"><a href="#local-6989586621680525188"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680525188"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2283"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-2284"></a><span>
</span><a name="line-2285"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2286"></a><span>    </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><a name="local-6989586621680525184"><a href="#local-6989586621680525184"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621680525185"><a href="#local-6989586621680525185"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680525186"><a href="#local-6989586621680525186"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525184"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2287"></a><span>                               </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680525185"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680525186"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2288"></a><span>                                   </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><a name="local-6989586621680525187"><a href="#local-6989586621680525187"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2289"></a><span>                                       </span><a href="#local-6989586621680525187"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-2290"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,13,0)
</span><span>    </span><a name="local-3458764513820541098"><span class="hs-identifier">fail</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MonadFail.fail</span><span>
</span><a name="line-2292"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-2294"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadFail.MonadFail</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2295"></a><span>   </span><a name="local-3458764513820541104"><span class="hs-identifier">fail</span></a><span> </span><a name="local-6989586621680525183"><a href="#local-6989586621680525183"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><a href="#local-6989586621680525183"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-2296"></a><span>
</span><a name="line-2297"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2298"></a><span>    </span><a name="local-8214565720323805401"><span class="hs-identifier">getUniqueSupplyM</span></a><span>
</span><a name="line-2299"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680525177"><a href="#local-6989586621680525177"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="State.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-2300"></a><span>                     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525178"><a href="#local-6989586621680525178"><span class="hs-identifier">us1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525179"><a href="#local-6989586621680525179"><span class="hs-identifier">us2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitUniqSupply</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">spec_uniq_supply</span><span> </span><a href="#local-6989586621680525177"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-2301"></a><span>                     </span><a href="State.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680525177"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">spec_uniq_supply</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525179"><span class="hs-identifier hs-var">us2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2302"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680525178"><span class="hs-identifier hs-var">us1</span></a><span>
</span><a name="line-2303"></a><span>
</span><a name="line-2304"></a><span>    </span><a name="local-8214565720323805400"><span class="hs-identifier">getUniqueM</span></a><span>
</span><a name="line-2305"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680525180"><a href="#local-6989586621680525180"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="State.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-2306"></a><span>                     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525181"><a href="#local-6989586621680525181"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525182"><a href="#local-6989586621680525182"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">spec_uniq_supply</span><span> </span><a href="#local-6989586621680525180"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-2307"></a><span>                     </span><a href="State.html#put"><span class="hs-identifier hs-var">put</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680525180"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">spec_uniq_supply</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525182"><span class="hs-identifier hs-var">us'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2308"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680525181"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-2309"></a><span>
</span><a name="line-2310"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasDynFlags</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2311"></a><span>    </span><a name="local-8214565720323804398"><span class="hs-identifier">getDynFlags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier">spec_dflags</span><span> </span><a href="State.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-2312"></a><span>
</span><a name="line-2313"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasModule</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2314"></a><span>    </span><a name="local-8214565720323805038"><span class="hs-identifier">getModule</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier">spec_module</span><span> </span><a href="State.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-2315"></a><span>
</span><a name="line-2316"></a><span class="hs-identifier">runSpecM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><a href="#local-6989586621680525199"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><a href="#local-6989586621680525199"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2317"></a><a name="runSpecM"><a href="Specialise.html#runSpecM"><span class="hs-identifier">runSpecM</span></a></a><span> </span><a name="local-6989586621680525735"><a href="#local-6989586621680525735"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680525736"><a href="#local-6989586621680525736"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-var">SpecM</span></a><span> </span><a name="local-6989586621680525737"><a href="#local-6989586621680525737"><span class="hs-identifier">spec</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2318"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680525738"><a href="#local-6989586621680525738"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-2319"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525739"><a href="#local-6989586621680525739"><span class="hs-identifier">initialState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#SpecState"><span class="hs-identifier hs-var">SpecState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2320"></a><span>                                </span><span class="hs-identifier">spec_uniq_supply</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525738"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">,</span><span>
</span><a name="line-2321"></a><span>                                </span><span class="hs-identifier">spec_module</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525736"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-2322"></a><span>                                </span><span class="hs-identifier">spec_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525735"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2323"></a><span>                            </span><span class="hs-special">}</span><span>
</span><a name="line-2324"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="State.html#evalState"><span class="hs-identifier hs-var">evalState</span></a><span> </span><a href="#local-6989586621680525737"><span class="hs-identifier hs-var">spec</span></a><span> </span><a href="#local-6989586621680525739"><span class="hs-identifier hs-var">initialState</span></a><span>
</span><a name="line-2325"></a><span>
</span><a name="line-2326"></a><span class="hs-identifier">mapAndCombineSM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525197"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525198"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680525197"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621680525198"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span>
</span><a name="line-2327"></a><a name="mapAndCombineSM"><a href="Specialise.html#mapAndCombineSM"><span class="hs-identifier">mapAndCombineSM</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Specialise.html#emptyUDs"><span class="hs-identifier hs-var">emptyUDs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2328"></a><span class="hs-identifier">mapAndCombineSM</span><span> </span><a name="local-6989586621680525740"><a href="#local-6989586621680525740"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680525741"><a href="#local-6989586621680525741"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680525742"><a href="#local-6989586621680525742"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525743"><a href="#local-6989586621680525743"><span class="hs-identifier">y</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525744"><a href="#local-6989586621680525744"><span class="hs-identifier">uds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525740"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680525741"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2329"></a><span>                              </span><span class="hs-special">(</span><a name="local-6989586621680525745"><a href="#local-6989586621680525745"><span class="hs-identifier">ys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525746"><a href="#local-6989586621680525746"><span class="hs-identifier">uds2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Specialise.html#mapAndCombineSM"><span class="hs-identifier hs-var">mapAndCombineSM</span></a><span> </span><a href="#local-6989586621680525740"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680525742"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-2330"></a><span>                              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525743"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680525745"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525744"><span class="hs-identifier hs-var">uds1</span></a><span> </span><span class="hs-special">`</span><a href="Specialise.html#plusUDs"><span class="hs-identifier hs-var">plusUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525746"><span class="hs-identifier hs-var">uds2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2331"></a><span>
</span><a name="line-2332"></a><span class="hs-identifier">extendTvSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span>
</span><a name="line-2333"></a><a name="extendTvSubstList"><a href="Specialise.html#extendTvSubstList"><span class="hs-identifier">extendTvSubstList</span></a></a><span> </span><a name="local-6989586621680525747"><a href="#local-6989586621680525747"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525748"><a href="#local-6989586621680525748"><span class="hs-identifier">tv_binds</span></a></a><span>
</span><a name="line-2334"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525747"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.extendTvSubstList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525747"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525748"><span class="hs-identifier hs-var">tv_binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2335"></a><span>
</span><a name="line-2336"></a><span class="hs-identifier">substTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-2337"></a><a name="substTy"><a href="Specialise.html#substTy"><span class="hs-identifier">substTy</span></a></a><span> </span><a name="local-6989586621680525749"><a href="#local-6989586621680525749"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525750"><a href="#local-6989586621680525750"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525749"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525750"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2338"></a><span>
</span><a name="line-2339"></a><span class="hs-identifier">substCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-2340"></a><a name="substCo"><a href="Specialise.html#substCo"><span class="hs-identifier">substCo</span></a></a><span> </span><a name="local-6989586621680525751"><a href="#local-6989586621680525751"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525752"><a href="#local-6989586621680525752"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525751"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525752"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2341"></a><span>
</span><a name="line-2342"></a><span class="hs-identifier">substBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">)</span><span>
</span><a name="line-2343"></a><a name="substBndr"><a href="Specialise.html#substBndr"><span class="hs-identifier">substBndr</span></a></a><span> </span><a name="local-6989586621680525753"><a href="#local-6989586621680525753"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525754"><a href="#local-6989586621680525754"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substBndr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525753"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525754"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2344"></a><span>                      </span><span class="hs-special">(</span><a name="local-6989586621680525755"><a href="#local-6989586621680525755"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525756"><a href="#local-6989586621680525756"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525753"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525755"><span class="hs-identifier hs-var">subst'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525756"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2345"></a><span>
</span><a name="line-2346"></a><span class="hs-identifier">substBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2347"></a><a name="substBndrs"><a href="Specialise.html#substBndrs"><span class="hs-identifier">substBndrs</span></a></a><span> </span><a name="local-6989586621680525757"><a href="#local-6989586621680525757"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525758"><a href="#local-6989586621680525758"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">CoreSubst.substBndrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">se_subst</span><span> </span><a href="#local-6989586621680525757"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525758"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2348"></a><span>                      </span><span class="hs-special">(</span><a name="local-6989586621680525759"><a href="#local-6989586621680525759"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525760"><a href="#local-6989586621680525760"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525757"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525759"><span class="hs-identifier hs-var">subst'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525760"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2349"></a><span>
</span><a name="line-2350"></a><span class="hs-identifier">cloneBindSM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-special">(</span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">)</span><span>
</span><a name="line-2351"></a><span class="hs-comment">-- Clone the binders of the bind; return new bind with the cloned binders</span><span>
</span><a name="line-2352"></a><span class="hs-comment">-- Return the substitution to use for RHSs, and the one to use for the body</span><span>
</span><a name="line-2353"></a><a name="cloneBindSM"><a href="Specialise.html#cloneBindSM"><span class="hs-identifier">cloneBindSM</span></a></a><span> </span><a name="local-6989586621680525761"><a href="#local-6989586621680525761"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Specialise.html#SE"><span class="hs-identifier hs-var">SE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525762"><a href="#local-6989586621680525762"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525763"><a href="#local-6989586621680525763"><span class="hs-identifier">interesting</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680525764"><a href="#local-6989586621680525764"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680525765"><a href="#local-6989586621680525765"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680525766"><a href="#local-6989586621680525766"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-2355"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525767"><a href="#local-6989586621680525767"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525768"><a href="#local-6989586621680525768"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.cloneIdBndr</span><span> </span><a href="#local-6989586621680525762"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680525766"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621680525764"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2356"></a><span>             </span><a name="local-6989586621680525769"><a href="#local-6989586621680525769"><span class="hs-identifier">interesting'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525761"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525765"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2357"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525763"><span class="hs-identifier hs-var">interesting</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525768"><span class="hs-identifier hs-var">bndr'</span></a><span>
</span><a name="line-2358"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525763"><span class="hs-identifier hs-var">interesting</span></a><span>
</span><a name="line-2359"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525761"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525761"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525767"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525769"><span class="hs-identifier hs-var">interesting'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2360"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680525768"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621680525765"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2361"></a><span>
</span><a name="line-2362"></a><span class="hs-identifier">cloneBindSM</span><span> </span><a name="local-6989586621680525770"><a href="#local-6989586621680525770"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Specialise.html#SE"><span class="hs-identifier hs-var">SE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525771"><a href="#local-6989586621680525771"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680525772"><a href="#local-6989586621680525772"><span class="hs-identifier">interesting</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621680525773"><a href="#local-6989586621680525773"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2363"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680525774"><a href="#local-6989586621680525774"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-2364"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525775"><a href="#local-6989586621680525775"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680525776"><a href="#local-6989586621680525776"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreSubst.cloneRecIdBndrs</span><span> </span><a href="#local-6989586621680525771"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680525774"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621680525773"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2365"></a><span>             </span><a name="local-6989586621680525777"><a href="#local-6989586621680525777"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525770"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">se_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525775"><span class="hs-identifier hs-var">subst'</span></a><span>
</span><a name="line-2366"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">se_interesting</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680525772"><span class="hs-identifier hs-var">interesting</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendVarSetList</span><span class="hs-special">`</span><span>
</span><a name="line-2367"></a><span>                                           </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680525778"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680525778"><a href="#local-6989586621680525778"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><a name="local-6989586621680525779"><a href="#local-6989586621680525779"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680525773"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">,</span><span> </span><a href="Specialise.html#interestingDict"><span class="hs-identifier hs-var">interestingDict</span></a><span> </span><a href="#local-6989586621680525770"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680525779"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2368"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525777"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680525777"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680525776"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621680525773"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2369"></a><span>
</span><a name="line-2370"></a><span class="hs-identifier">newDictBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Specialise.html#SpecEnv"><span class="hs-identifier hs-type">SpecEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-identifier hs-type">CoreBndr</span><span>
</span><a name="line-2371"></a><span class="hs-comment">-- Make up completely fresh binders for the dictionaries</span><span>
</span><a name="line-2372"></a><span class="hs-comment">-- Their bindings are going to float outwards</span><span>
</span><a name="line-2373"></a><a name="newDictBndr"><a href="Specialise.html#newDictBndr"><span class="hs-identifier">newDictBndr</span></a></a><span> </span><a name="local-6989586621680525780"><a href="#local-6989586621680525780"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680525781"><a href="#local-6989586621680525781"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680525782"><a href="#local-6989586621680525782"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-2374"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525783"><a href="#local-6989586621680525783"><span class="hs-identifier">n</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680525781"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-2375"></a><span>                             </span><a name="local-6989586621680525784"><a href="#local-6989586621680525784"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Specialise.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621680525780"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680525781"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-2376"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUserLocalOrCoVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621680525783"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680525782"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621680525784"><span class="hs-identifier hs-var">ty'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621680525783"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2377"></a><span>
</span><a name="line-2378"></a><span class="hs-identifier">newSpecIdSM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">JoinArity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Specialise.html#SpecM"><span class="hs-identifier hs-type">SpecM</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-2379"></a><span>    </span><span class="hs-comment">-- Give the new Id a similar occurrence name to the old one</span><span>
</span><a name="line-2380"></a><a name="newSpecIdSM"><a href="Specialise.html#newSpecIdSM"><span class="hs-identifier">newSpecIdSM</span></a></a><span> </span><a name="local-6989586621680525785"><a href="#local-6989586621680525785"><span class="hs-identifier">old_id</span></a></a><span> </span><a name="local-6989586621680525786"><a href="#local-6989586621680525786"><span class="hs-identifier">new_ty</span></a></a><span> </span><a name="local-6989586621680525787"><a href="#local-6989586621680525787"><span class="hs-identifier">join_arity_maybe</span></a></a><span>
</span><a name="line-2381"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680525788"><a href="#local-6989586621680525788"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-2382"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680525789"><a href="#local-6989586621680525789"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680525785"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-2383"></a><span>              </span><a name="local-6989586621680525790"><a href="#local-6989586621680525790"><span class="hs-identifier">new_occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621680525789"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2384"></a><span>              </span><a name="local-6989586621680525791"><a href="#local-6989586621680525791"><span class="hs-identifier">new_id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUserLocalOrCoVar</span><span> </span><a href="#local-6989586621680525790"><span class="hs-identifier hs-var">new_occ</span></a><span> </span><a href="#local-6989586621680525788"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621680525786"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621680525789"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2385"></a><span>                          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">asJoinId_maybe</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680525787"><span class="hs-identifier hs-var">join_arity_maybe</span></a><span>
</span><a name="line-2386"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680525791"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2387"></a><span>
</span><a name="line-2388"></a><span class="hs-comment">{-
                Old (but interesting) stuff about unboxed bindings
                ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

What should we do when a value is specialised to a *strict* unboxed value?

        map_*_* f (x:xs) = let h = f x
                               t = map f xs
                           in h:t

Could convert let to case:

        map_*_Int# f (x:xs) = case f x of h# -&gt;
                              let t = map f xs
                              in h#:t

This may be undesirable since it forces evaluation here, but the value
may not be used in all branches of the body. In the general case this
transformation is impossible since the mutual recursion in a letrec
cannot be expressed as a case.

There is also a problem with top-level unboxed values, since our
implementation cannot handle unboxed values at the top level.

Solution: Lift the binding of the unboxed value and extract it when it
is used:

        map_*_Int# f (x:xs) = let h = case (f x) of h# -&gt; _Lift h#
                                  t = map f xs
                              in case h of
                                 _Lift h# -&gt; h#:t

Now give it to the simplifier and the _Lifting will be optimised away.

The benefit is that we have given the specialised &quot;unboxed&quot; values a
very simple lifted semantics and then leave it up to the simplifier to
optimise it --- knowing that the overheads will be removed in nearly
all cases.

In particular, the value will only be evaluated in the branches of the
program which use it, rather than being forced at the point where the
value is bound. For example:

        filtermap_*_* p f (x:xs)
          = let h = f x
                t = ...
            in case p x of
                True  -&gt; h:t
                False -&gt; t
   ==&gt;
        filtermap_*_Int# p f (x:xs)
          = let h = case (f x) of h# -&gt; _Lift h#
                t = ...
            in case p x of
                True  -&gt; case h of _Lift h#
                           -&gt; h#:t
                False -&gt; t

The binding for h can still be inlined in the one branch and the
_Lifting eliminated.


Question: When won't the _Lifting be eliminated?

Answer: When they at the top-level (where it is necessary) or when
inlining would duplicate work (or possibly code depending on
options). However, the _Lifting will still be eliminated if the
strictness analyser deems the lifted binding strict.
-}</span><span>
</span><a name="line-2457"></a></pre></body></html>